CREATE DEFINER=`wms_ftest`@`%` PROCEDURE `CML_SPASN_CLOSE_AF`(
  IN IN_organizationId VARCHAR (20),
  IN IN_Warehouse VARCHAR (20),
  IN IN_ASNNO VARCHAR (100),
  IN IN_ASNSplit VARCHAR (120),
  IN IN_Userid VARCHAR (100),
  OUT OUT_returnCode VARCHAR (1000)
)
END_PROC :
BEGIN
  DECLARE R_NROW INTEGER ;
  DECLARE R_NROW2 INTEGER ;
  DECLARE V_udf02 VARCHAR (100) ;
  DECLARE R_ASNSTATUS VARCHAR (20) ;
  DECLARE R_CURRENTDATE TIMESTAMP ;
  DECLARE R_FMDATE VARCHAR (10) ;
  DECLARE R_TODATE VARCHAR (10) ;
  DECLARE R_FMDATE_D DATE ;
  DECLARE R_TODATE_D DATE ;
  DECLARE R_BILLINGDATE INTEGER ;
  DECLARE R_BILLINGMONTH VARCHAR (10) ;
  DECLARE R_CUSTOMER VARCHAR (30) ;
  DECLARE R_tariffId VARCHAR (10) ;
  DECLARE R_tariffLineNo INTEGER ;
  DECLARE R_docType VARCHAR (15) ;
  DECLARE R_minAmount DECIMAL (24, 8) ;
  DECLARE R_maxAmount DECIMAL (24, 8) ;
  DECLARE R_chargeCategory VARCHAR (20) ;
  DECLARE R_chargeType VARCHAR (20) ;
  
  DECLARE R_tariffClassNo VARCHAR (15) ;
  DECLARE R_classFrom DECIMAL (24, 8) ;
  DECLARE R_classTo DECIMAL (24, 8) ;
  DECLARE R_rate DECIMAL (24, 8) ;
  
  DECLARE R_cusAmount DECIMAL (24, 8) ;
  DECLARE R_BILLINGSUMMARYID VARCHAR (30) ;
  DECLARE R_QTY INTEGER ;
  
  DECLARE done INT DEFAULT FALSE ;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE ;
  DECLARE EXIT HANDLER FOR SQLEXCEPTION 
  BEGIN
    GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
    @p2 = MESSAGE_TEXT,
    @p3 = MYSQL_ERRNO,
    @p4 = TABLE_NAME,
    @p5 = COLUMN_NAME ;
    ROLLBACK ;
    SET OUT_ReturnCode = CONCAT(
      '999#CML_SPASN_CLOSE_AF,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, '')
    ) ;
    SELECT 
      OUT_ReturnCode AS error ;
  END ;
  SET R_CURRENTDATE = CURDATE() ;
  SET R_FMDATE = DATE_FORMAT(
    DATE_ADD(R_CURRENTDATE, INTERVAL - 1 MONTH),
    '%Y-%m-%d'
  ) ;
  SET R_TODATE = DATE_FORMAT(
    DATE_ADD(R_CURRENTDATE, INTERVAL - 1 DAY),
    '%Y-%m-%d'
  ) ;
  SET R_FMDATE_D = DATE_ADD(R_CURRENTDATE, INTERVAL - 1 MONTH) ;
  SET R_TODATE_D = DATE_ADD(R_CURRENTDATE, INTERVAL 1 DAY) ;
  SET R_BILLINGDATE = DAY(R_CURRENTDATE) ;
  SET R_BILLINGMONTH = DATE_FORMAT(R_CURRENTDATE, '%Y-%m') ;
 
    BEGIN
    UPDATE 
      BIL_SUMMARY A 
      LEFT JOIN DOC_ASN_DETAILS A1 
        ON A.`organizationId` = A1.`organizationId` 
        AND A.`warehouseId` = A1.`warehouseId` 
        AND A.docNo = A1.asnNo 
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B 
        ON A.ORGANIZATIONID = B.ORGANIZATIONID 
        AND A.CUSTOMERID = B.CUSTOMERID 
        AND A.WAREHOUSEID = B.WAREHOUSEID 
        AND A.SKU = B.SKU 
      LEFT JOIN BIL_TARIFF_HEADER C 
        ON B.ORGANIZATIONID = C.ORGANIZATIONID 
        AND B.TARIFFMASTERID = C.TARIFFMASTERID 
      LEFT JOIN BIL_TARIFF_DETAILS D 
        ON C.ORGANIZATIONID = D.ORGANIZATIONID 
        AND C.TARIFFID = D.TARIFFID 
        AND D.CHARGECATEGORY = A.`chargeCategory` 
        AND D.`chargeType` = A.`chargeType` SET A.udf01 = D.udf01,
      A.udf02 = D.udf02 ,A.udf04=D.udf06
    WHERE A.`organizationId` = IN_organizationId 
      AND A.`warehouseId` = IN_Warehouse 
      AND A.docNo = IN_ASNNO 
            AND  TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0 
  AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0  ;
      
    SET OUT_returnCode = '000' ;
    COMMIT ;
  END ;
END