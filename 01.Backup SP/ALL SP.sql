--
-- Set character set the client will use to send SQL statements to the server
--
SET NAMES 'utf8';

--
-- Set default database
--
USE wms_cml;

DELIMITER $$

--
-- Create procedure `SPCOM_GetIDSequence`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCOM_GetIDSequence (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_Language varchar(30),
IN IN_Sequence_Name varchar(30),
OUT OUT_ReturnNo varchar(40),
INOUT OUT_Return_Code varchar(1000))
BEGIN
  DECLARE r_ID_Sequence decimal(18, 0);
  DECLARE r_Max_ID_Sequence decimal(18, 0);
  DECLARE R_Length int;
  DECLARE r_Start_i int;
  DECLARE r_PreFix varchar(20);
  DECLARE r_LastDate varchar(8);
  DECLARE r_Date_Format varchar(10);
  DECLARE r_Date_Max varchar(10);
  DECLARE R_Date_Str varchar(8);
  DECLARE r_WarehouseID varchar(100);
  DECLARE r_MLT_WH char(1);
  DECLARE r_NO_Commit char(1);

  SET r_ID_Sequence = -1;
  SET R_Length = 0;
  IF OUT_Return_Code = '*_*'
    OR OUT_Return_Code = 'NO_COMMIT' THEN
    SET r_NO_Commit := 'N';
  ELSE
    SET r_NO_Commit := 'Y';
  END IF;
  IF r_NO_Commit = 'Y' THEN
    START TRANSACTION;
  END IF;
  SET IN_Sequence_Name = CONCAT('SP_', UPPER(IN_Sequence_Name));
  SELECT
    IDSEQUENCE,
    MaxIDSequence,
    LENGTH,
    PreFix,
    DATE_FORMAT(EditTime, '%Y%m%d'),
    DateFormat,
    Datemax,
    WareHouseID
  FROM SYS_IDSEQUENCE
  WHERE IDName = IN_Sequence_Name
  AND organizationId = IN_organizationId
  AND WareHouseID = IN_WarehouseID LIMIT 1 INTO r_ID_Sequence, r_Max_ID_Sequence, R_Length, r_PreFix, r_LastDate
  , r_Date_Format, r_Date_Max, r_WarehouseID;
  IF r_ID_Sequence = -1 THEN
    SELECT
      IDSequence,
      MaxIDSequence,
      LENGTH,
      PreFix,
      DATE_FORMAT(EditTime, '%Y%m%d'),
      DateFormat,
      Datemax,
      WareHouseID INTO r_ID_Sequence, r_Max_ID_Sequence, R_Length, r_PreFix, r_LastDate
    , r_Date_Format, r_Date_Max, r_WarehouseID
    FROM SYS_IDSEQUENCE
    WHERE IDName = IN_Sequence_Name
    AND organizationId = IN_organizationId
    AND WareHouseID = '*' LIMIT 1
    FOR UPDATE;
  END IF;
  IF r_ID_Sequence = -1 THEN
    SET OUT_Return_Code = '100';
    ROLLBACK;

  END IF;
  IF r_Date_Format = 'YYYY'
    OR r_Date_Format = 'YY'
    OR r_Date_Format = 'YYYYMM'
    OR r_Date_Format = 'YYMM'
    OR r_Date_Format = 'YYYYMMDD'
    OR r_Date_Format = 'YYMMDD' THEN
    SET r_Date_Str = DATE_FORMAT(NOW(), '%Y%m%d');
    IF r_Date_Format = 'YYYY' THEN
      SET r_Date_Str = SUBSTRING(r_Date_Str, 1, 4);
    ELSEIF r_Date_Format = 'YY' THEN
      SET r_Date_Str = SUBSTRING(r_Date_Str, 3, 2);
    ELSEIF r_Date_Format = 'YYYYMM' THEN
      SET r_Date_Str = SUBSTRING(r_Date_Str, 1, 6);
    ELSEIF r_Date_Format = 'YYMM' THEN
      SET r_Date_Str = SUBSTRING(r_Date_Str, 3, 4);
    ELSEIF r_Date_Format = 'YYYYMMDD' THEN
      SET r_Date_Str = SUBSTRING(r_Date_Str, 1, 8);
    ELSEIF r_Date_Format = 'YYMMDD' THEN
      SET r_Date_Str = SUBSTRING(r_Date_Str, 3, 6);
    END IF;

    IF r_Date_Str = IFNULL(r_Date_Max, '') THEN
      SET r_ID_Sequence = IFNULL(r_ID_Sequence, 0) + 1;
    ELSE
      SET r_ID_Sequence = 1;
      UPDATE SYS_IDSEQUENCE
      SET Datemax = r_Date_Str
      WHERE IDName = IN_Sequence_Name
      AND organizationId = IN_organizationId
      AND WarehouseID = r_WarehouseID;
    END IF;
  ELSE
    SET r_ID_Sequence = r_ID_Sequence + 1;
    IF r_ID_Sequence > r_Max_ID_Sequence THEN
      SET r_ID_Sequence = 1;
    END IF;
  END IF;
  IF r_PreFix = 'YYMMDD'
    OR r_PreFix = 'YYYYMMDD' THEN
    IF r_PreFix = 'YYMMDD' THEN
      SET r_PreFix = to_CHar(NOW(), 'YYMMDD');
    ELSEIF r_PreFix = 'YYYYMMDD' THEN
      SET r_PreFix = to_CHar(NOW(), 'YYYYMMDD');
    END IF;
    IF NOT (r_PreFix = r_LastDate
      OR substrb(r_PreFix, 3, 6) = r_LastDate) THEN
      SET r_ID_Sequence = 1;
    END IF;
  END IF;
  SET OUT_ReturnNo = TRIM(r_ID_Sequence);
  SET r_Start_i = LENGTH(OUT_ReturnNo) + 1;
  WHILE (r_Start_i <= R_Length) DO

    SET OUT_ReturnNo = CONCAT('0', OUT_ReturnNo);
    SET r_Start_i = r_Start_i + 1;
  END WHILE;
  IF r_Date_Str IS NOT NULL THEN
    SET OUT_ReturnNo = CONCAT(TRIM(r_Date_Str), OUT_ReturnNo);
  END IF;
  IF r_PreFix IS NOT NULL THEN
    SET OUT_ReturnNo = CONCAT(RTRIM(r_PreFix), OUT_ReturnNo);
  END IF;

  UPDATE SYS_IDSEQUENCE
  SET IDSequence = r_ID_Sequence,
      EditTime = NOW(),
      Datemax = r_Date_Str
  WHERE IDName = IN_Sequence_Name
  AND organizationId = IN_organizationId
  AND WarehouseID = r_WarehouseID;
  IF r_NO_Commit = 'Y' THEN
    COMMIT;
  END IF;
  SET OUT_Return_Code = CONCAT('000', RTRIM(OUT_ReturnNo));
END
$$

--
-- Create procedure `SPSO_HardAllocation_Update`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_HardAllocation_Update (IN IN_organizationId varchar(20),
IN IN_WarehouseID varchar(20),
IN IN_Call_Father varchar(20),
IN IN_Match_UOM varchar(20),
IN IN_UOMQty_R varchar(20),
IN IN_WaveNo_R varchar(40),
IN IN_OrderNo_R varchar(40),
IN IN_OrderLineNO_R int,
IN IN_CustomerID_R varchar(20),
IN IN_SKU_R varchar(60),
IN IN_LotNUM_Soft varchar(20),
IN IN_PackID_Soft varchar(20),
IN IN_Actual_Qty_each varchar(10),
IN IN_TraceID_R varchar(40),
IN IN_LocationID_R varchar(30),
IN IN_DropID varchar(20),
IN IN_SoftAllocationDetailsID_C varchar(20),
IN IN_PreDropDownUOM varchar(20),
IN IN_Language varchar(20),
IN IN_UserID varchar(20),
INOUT OUT_Return_Code varchar(2000))
ENDPROC:
  BEGIN

    DECLARE R_AllocationDetailsID varchar(30);
    DECLARE R_CurrentTime date;
    DECLARE R_PKTaskID varchar(30);
    DECLARE R_PkTaskID_Sequence int;
    DECLARE R_LogicalSequence varchar(20);
    DECLARE R_LotAtt01 varchar(100);
    DECLARE R_LotAtt02 varchar(100);
    DECLARE R_LotAtt03 varchar(100);
    DECLARE R_LotAtt04 varchar(100);
    DECLARE R_LotAtt05 varchar(100);
    DECLARE R_LotAtt06 varchar(100);
    DECLARE R_LotAtt07 varchar(100);
    DECLARE R_LotAtt08 varchar(100);
    DECLARE R_LotAtt09 varchar(100);
    DECLARE R_LotAtt10 varchar(100);
    DECLARE R_LotAtt11 varchar(100);
    DECLARE R_LotAtt12 varchar(100);
    DECLARE R_QtyAllocated_Each_Order_OLD decimal(18, 8);
    DECLARE R_QtyAllocated_Each_Order decimal(18, 8);
    DECLARE R_QtyAllocated_Order decimal(18, 8);
    DECLARE R_QtySoftAllocated_Each_Order decimal(18, 8);
    DECLARE R_QtySoftAllocated_Order decimal(18, 8);
    DECLARE R_PackID_Order varchar(40);
    DECLARE r_UOM_Order varchar(10);
    DECLARE R_QTY1_P decimal(18, 8);
    DECLARE R_QTY2_P decimal(18, 8);
    DECLARE R_QTY3_P decimal(18, 8);
    DECLARE R_QTY4_P decimal(18, 8);
    DECLARE R_QTY5_P decimal(18, 8);
    DECLARE R_UOMQTY_Order decimal(18, 8);
    DECLARE R_Cubic decimal(18, 8);
    DECLARE R_GrossWeight decimal(18, 8);
    DECLARE R_NetWeight decimal(18, 8);
    DECLARE R_Price decimal(18, 8);
    DECLARE R_Qty_INV decimal(18, 8);
    DECLARE R_QTY_Soft_T decimal(18, 8);
    DECLARE R_QTY_Allocation_Soft_T decimal(18, 8);
    DECLARE r_PackID_Soft_T varchar(40);
    DECLARE R_UOM_Soft_T varchar(10);
    DECLARE R_UOMQty_Soft_T decimal(18, 8);
    DECLARE r_QTY_Allocation_Soft_T2 decimal(18, 8);
    DECLARE R_PickToTraceID varchar(40);
    DECLARE R_LBL_PCK varchar(1);
    DECLARE R_MaxWeight decimal(18, 8);
    DECLARE R_MaxCubic decimal(18, 8);
    DECLARE R_ActualWeight decimal(18, 8);
    DECLARE R_ActualCubic decimal(18, 8);
    DECLARE R_PickToLocation varchar(40);
    DECLARE R_SRT_LOC varchar(1);
    DECLARE R_CubicCapacity_SS decimal(18, 8);
    DECLARE R_CubicUsed_SS decimal(18, 8);
    DECLARE R_ZoneGroup varchar(40);
    DECLARE R_SorationZone varchar(40);

    DECLARE R_DEL_DOC_SN varchar(1);
    DECLARE R_OrderType varchar(20);
    DECLARE R_UNT_PRI_CTL varchar(1);
    DECLARE R_TotalPrice decimal(18, 8);
    DECLARE r_CarrierID varchar(35);
    DECLARE r_CartonizeUOM varchar(1);
    DECLARE r_PackFlag varchar(1);
    DECLARE r_CartonSeqNo int;
    DECLARE SP_SQL_R varchar(1000);
    DECLARE IN_SoftAllocationDetailsID varchar(20);
    DECLARE r_PickToLoc varchar(20);
    DECLARE r_SortationLocation varchar(40);
    DECLARE r_ConsigneeID varchar(40);

    DECLARE r_NO_COMMIT varchar(1);
    DECLARE r_PrintFlag varchar(1);
    DECLARE r_nRow int;
    DECLARE r_Setp_one varchar(1);
    DECLARE r_Qty_Each_ACT decimal(18, 8);
    DECLARE r_Store_Sql varchar(2000);
    DECLARE r_ParaTemp varchar(100);

    DECLARE r_ONE_STP_ALC varchar(1);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_SRT_TYP char(3);
    DECLARE R_Route varchar(30);
    DECLARE R_Stop varchar(10);
    DECLARE R_RequireDeliveryNo char(1);
    DECLARE R_Priority char(1);
    DECLARE r_OverPreAllocation char(1);
    DECLARE R_QtyOrdered_Each decimal(18, 8);
    DECLARE R_CompatibilityGroup varchar(20);
    DECLARE r_ConsigneeName varchar(200);
    DECLARE r_DeliveryNo varchar(50);
    DECLARE r_CHANNEL varchar(20);
    DECLARE r_CHK_TYP varchar(20);
    DECLARE R_LOT_12_PKG char(1);
    DECLARE r_LotAtt12_I decimal;
    DECLARE r_grouptaskid varchar(20);
    DECLARE r_SoftAllocationrule varchar(20);
    DECLARE r_Allocationrule varchar(20);
    DECLARE r_BreakBulk char(1);
    DECLARE r_wh_prefix varchar(30);
    DECLARE r_Round int;
    DECLARE r_SRT_LOC_CYC varchar(1);
    DECLARE r_OPR_TRN_TIM varchar(20);
    DECLARE r_Edittime datetime;
    DECLARE r_WindowTime varchar(20);
    DECLARE r_WarehouseID1 varchar(20);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN

      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      SET OUT_Return_Code = CONCAT('999#SPSO_HardAllocation_Update', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      ROLLBACK;
    END;

    IF Out_return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_**_*' THEN
      SET r_NO_COMMIT = 'N';
    ELSE
      SET r_NO_COMMIT = 'Y';
    END IF;

    SELECT
      IN_Call_Father,
      IN_Match_UOM,
      IN_UOMQty_R,
      IN_WaveNo_R,
      IN_OrderNo_R,
      IN_OrderLineNO_R,
      IN_CustomerID_R,
      IN_SKU_R,
      IN_LotNUM_Soft,
      IN_PackID_Soft,
      IN_Actual_Qty_each,
      IN_TraceID_R,
      IN_LocationID_R,
      IN_DropID,
      IN_SoftAllocationDetailsID_C,
      IN_PreDropDownUOM,
      IN_Language,
      IN_UserID;


    SET R_SRT_TYP = '';
    SELECT
      SortationType
    FROM DOC_WAVE_HEADER h
    WHERE WaveNo = IN_WaveNo_R
    AND organizationId = IN_organizationId
    AND warehouseid = IN_WarehouseId INTO R_SRT_TYP;
    IF Out_Return_Code = '*_**_*' THEN
      SET r_Setp_one = 'Y';
    ELSE
      SET r_Setp_one = 'N';
    END IF;

    SET IN_SoftAllocationDetailsID = IN_SoftAllocationDetailsID_C;

    IF IN_Actual_Qty_each = 0 THEN
      SET OUT_Return_Code = '000';
      LEAVE ENDPROC;
    END IF;

    SET R_CurrentTime = SYSDATE();
    SET OUT_Return_Code = '000';
    SET R_PickToLocation = IN_LocationID_R;
    SELECT
      OrderType,
      ConsigneeID,
      CarrierID,
      WarehouseID,
      Route,
      stopStation,
      IFNULL(RequireDeliveryNo, 'N'),
      IFNULL(Priority, '3'),
      ConsigneeName,
      DeliveryNo,
      IFNULL(CHANNEL, '')
    FROM DOC_ORDER_HEADER
    WHERE OrderNo = IN_OrderNo_R
    AND organizationId = IN_organizationId
    AND warehouseid = IN_WarehouseId INTO r_OrderType, r_ConsigneeID, r_CarrierID, r_WarehouseID
    , r_Route, R_Stop, r_RequireDeliveryNo, r_Priority
    , r_ConsigneeName, r_DeliveryNo, r_CHANNEL;
    SET r_WarehouseID = IN_WarehouseId;

    SET r_wh_prefix = '';




    SET r_SRT_LOC = getsys_configuration(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'SRT_LOC');
    SET r_SRT_LOC_CYC = getsys_configuration(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'SRT_LOC_CYC');

    SET r_UNT_PRI_CTL = getsys_configuration(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'UNT_PRI_CTL');

    IF R_SRT_TYP IS NULL THEN
      SET R_SRT_TYP = getsys_configuration(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'SRT_TYP', 'ORD');
    END IF;

    SET r_ONE_STP_ALC = getsys_configuration(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'ONE_STP_ALC');




    SET r_LBL_PCK = getsys_configuration(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'LBL_PCK');

    SET r_CHK_TYP = getsys_configuration_D(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'CHK_TYP', 'ORDER');
    IF IFNULL(r_DeliveryNo, '*') <> '*' THEN
      SET r_PickToTraceID = r_DeliveryNo;
    ELSE
      SET R_PickToTraceID = IN_TraceID_R;
    END IF;
    IF r_LBL_PCK = 'Y' THEN
      SET R_DEL_DOC_SN = getsys_configuration(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'DEL_DOC_SN#');
    END IF;

    SET R_LOT_12_PKG = getsys_configuration(IN_organizationId, r_WarehouseID, IN_CustomerID_R, r_OrderType, 'LOT_#12_PKG');




    SELECT
      QtyAllocated_EACH,
      QtyAllocated,
      QtySoftAllocated_EACH,
      QtySoftAllocated,
      PackID,
      packUOM,
      Price,
      QtyAllocated_EACH,
      QtyOrdered_Each,
      softallocationrule,
      allocationrule
    FROM DOC_ORDER_DETAILS
    WHERE OrderNo = IN_OrderNo_R
    AND OrderLineNo = IN_OrderLineNO_R
    AND organizationId = IN_organizationId
    AND warehouseid = IN_WarehouseId
    AND linestatus < '90' INTO r_QtyAllocated_Each_Order, r_QtyAllocated_Order, r_QtySoftAllocated_Each_Order, r_QtysoftAllocated_Order,
    r_PackID_Order, r_UOM_Order, r_TotalPrice, R_QtyAllocated_Each_Order_OLD, R_QtyOrdered_Each,
    r_SoftAllocationrule, r_Allocationrule;
    IF FOUND_ROWS() = 0 THEN
      SET OUT_Return_Code = '411';

      LEAVE ENDPROC;
    END IF;

    SELECT
      BreakBulk
    FROM RUL_ALLOCATION_HEADER a
    WHERE a.AllocationRuleID = r_AllocationRule
    AND organizationId = IN_organizationId INTO r_BreakBulk;
    IF FOUND_ROWS() = 0 THEN
      SET r_BreakBulk = 'Y';
    END IF;
    IF r_BreakBulk = 'Y' THEN

      SELECT
        h.OverPreAllocation
      FROM RUL_SOFTALLOCATION_HEADER h
      WHERE h.SoftAllocationID = r_SoftAllocationrule
      AND organizationId = IN_organizationId INTO r_OverPreAllocation;
      IF FOUND_ROWS() = 0 THEN
        SET r_OverPreAllocation = 'N';
      END IF;
      IF r_OverPreAllocation = 'N'
        AND R_QtyOrdered_Each < r_QtyAllocated_Each_Order + IN_Actual_Qty_each THEN
        SET OUT_Return_Code = '809**??,?????????????';
        LEAVE ENDPROC;
      END IF;
    END IF;


    SET r_Qty_INV = 0;
    SELECT
      Cubic,
      GrossWeight,
      NetWeight,
      Price,
      Qty
    FROM INV_LOT_LOC_ID
    WHERE LotNUM = IN_LotNUM_Soft
    AND LocationID = IN_LocationID_R
    AND TraceID = IN_TraceID_R
    AND organizationId = IN_organizationId
    AND warehouseid = IN_WarehouseId INTO r_Cubic, r_GrossWeight, r_NetWeight, r_Price, r_Qty_INV;
    IF r_Qty_INV = 0 THEN
      SET OUT_Return_Code = '999**Open INV_LOT_LOC_ID';
      LEAVE ENDPROC;
    END IF;
    SET r_Cubic = (IFNULL(r_Cubic, 0) / r_Qty_INV) * IN_Actual_Qty_each;
    SET r_GrossWeight = (IFNULL(r_GrossWeight, 0) / r_Qty_INV) * IN_Actual_Qty_each;
    SET r_NetWeight = (IFNULL(r_NetWeight, 0) / r_Qty_INV) * IN_Actual_Qty_each;
    SET r_Price = (IFNULL(r_Price, 0) / r_Qty_INV) * IN_Actual_Qty_each;

    IF R_UNT_PRI_CTL = 'Y' THEN
      IF R_TOTALPRICE IS NULL
        OR R_TOTALPRICE <= 0 THEN
        SET OUT_RETURN_CODE = '050';
        LEAVE ENDPROC;
      END IF;
    END IF;
    SELECT
      LotAtt01,
      LotAtt02,
      LotAtt03,
      LotAtt04,
      LotAtt05,
      LotAtt06,
      LotAtt07,
      LotAtt08,
      LotAtt09,
      LotAtt10,
      LotAtt11,
      LotAtt12
    FROM INV_LOT_ATT
    WHERE LotNum = IN_LotNUM_Soft
    AND organizationId = IN_organizationId INTO r_LotAtt01, r_LotAtt02, r_LotAtt03, r_LotAtt04, r_LotAtt05, r_LotAtt06
    , r_LotAtt07, r_LotAtt08, r_LotAtt09, r_LotAtt10, r_LotAtt11, r_LotAtt12;

    IF R_LOT_12_PKG = 'Y'
      AND isnumeric(r_LotAtt12) = 1 THEN
      SET r_PackID_Order := r_LotAtt12;
    END IF;
    SELECT
      Qty
    FROM BAS_PACKAGE_DETAILS
    WHERE PackID = r_PackID_Order
    AND packUOM = r_UOM_Order
    AND CustomerID = IN_CustomerID_R
    AND organizationId = IN_organizationId INTO r_UOMQty_Order;

    SET r_QtyAllocated_Each_Order = r_QtyAllocated_Each_Order + IN_Actual_Qty_each;
    SET r_QtyAllocated_Order = r_QtyAllocated_Each_Order / r_UOMQty_Order;
    IF IN_Call_Father = 'SPSO_InsertPicking' THEN
      SET r_QtysoftAllocated_Each_Order = r_QtySoftAllocated_Each_Order + IN_Actual_Qty_each;
      SET r_QtysoftAllocated_Order = r_QtySoftAllocated_Each_Order / r_UOMQty_Order;
    END IF;

    IF r_QtySoftAllocated_Each_Order < r_QtyAllocated_Each_Order THEN
      SET r_QtySoftAllocated_Each_Order = r_QtyAllocated_Each_Order;
    END IF;
    IF r_QtysoftAllocated_Order < r_QtyAllocated_Order THEN
      SET r_QtysoftAllocated_Order = r_QtyAllocated_Order;
    END IF;




    UPDATE INV_LOT_LOC_ID
    SET QtyAllocated = QtyAllocated + IN_Actual_Qty_each,
        editTime = R_CurrentTime,
        editwho = in_UserID
    WHERE LotNUm = IN_LotNUM_Soft
    AND TraceID = IN_TraceID_R
    AND LocationID = IN_LocationID_R
    AND organizationId = IN_organizationId
    AND warehouseid = IN_WarehouseId;
    UPDATE INV_LOT
    SET QtyAllocated = QtyAllocated + IN_Actual_Qty_each,
        QtyPreAllocated = QtyPreAllocated + CASE WHEN IN_Call_Father = 'SPSO_OneStep' THEN in_Actual_Qty_each ELSE 0 END,
        editTime = R_CurrentTime,
        editwho = in_UserID
    WHERE LotNUm = IN_LotNUM_Soft
    AND organizationId = IN_organizationId
    AND warehouseid = IN_WarehouseId;



    UPDATE DOC_ORDER_DETAILS
    SET QtyAllocated = r_QtyAllocated_Order,
        QtyAllocated_Each = r_QtyAllocated_Each_Order,
        QtySoftAllocated = r_QtySoftAllocated_Order,
        QtySoftAllocated_Each = r_QtySoftAllocated_Each_Order,
        editTime = R_CurrentTime,
        editwho = in_UserID
    WHERE OrderNo = IN_OrderNo_R
    AND OrderLineNo = IN_OrderLineNO_R
    AND organizationId = IN_organizationId
    AND warehouseid = IN_WarehouseId

    AND linestatus < '90';







    IF IN_Call_Father = 'SPSO_InsertPicking' THEN

      IF r_Setp_one = 'N'
        AND r_ONE_STP_ALC = 'N' THEN
        IF in_SoftAllocationDetailsID = '*' THEN

          SET OUT_Return_Code = 'NO_COMMIT';
          CALL SPCOM_GetIDSequence(IN_organizationId, IN_WarehouseId, IN_Language, 'SoftAllocationDetailsID', IN_SoftAllocationDetailsID, OUT_Return_Code);
          IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
            LEAVE ENDPROC;
          END IF;
          INSERT INTO ACT_SOFTALLOCATION_DETAILS (organizationId, warehouseId, SoftAllocationDetailsID
          , WaveNo, OrderNo, OrderLineNO, LotNUM, UOM, PackID
          , CustomerID, Sku, Qty, Qty_Each
          , QTY_Allocation, QTY_each_Allocation, Hard_SoftFlag
          , ADDTIME, AddWho, EditTime, EditWho)
            VALUES (IN_organizationId, IN_WarehouseID, IN_SoftAllocationDetailsID, IN_WaveNo_R, IN_OrderNo_R, IN_OrderLineNO_R, IN_LotNUM_Soft, IN_Match_UOM, IN_PackID_Soft, IN_CustomerID_R, IN_SKU_R, IN_Actual_Qty_each / r_UOMQty_Order, IN_Actual_Qty_each, IN_Actual_Qty_each / r_UOMQty_Order, IN_Actual_Qty_each, 'HARD', r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID);
        ELSE
          SELECT
            QTY_each,
            QTY_each_Allocation,
            PackID,
            UOM
          FROM ACT_SOFTALLOCATION_DETAILS
          WHERE SoftAllocationDetailsID = IN_SoftAllocationDetailsID
          AND organizationId = IN_organizationId
          AND warehouseid = IN_WarehouseId INTO r_QTY_Soft_T, r_QTY_Allocation_Soft_T, r_PackID_Soft_T, r_UOM_Soft_T;


          IF r_UOM_Order = r_UOM_Soft_T THEN
            SET r_UOMQty_Soft_T = r_UOMQty_Order;
          ELSE
            SELECT
              Qty
            FROM BAS_PACKAGE_DETAILS
            WHERE PackID = r_PackID_Order
            AND packUOM = r_UOM_Soft_T
            AND organizationId = IN_organizationId INTO r_UOMQty_Soft_T;
          END IF;
          SET r_QTY_Soft_T = (r_QTY_Soft_T + IN_Actual_Qty_each) / r_UOMQty_Soft_T;
          SET r_QTY_Allocation_Soft_T = (r_QTY_Allocation_Soft_T + IN_Actual_Qty_each) / r_UOMQty_Soft_T;

          UPDATE ACT_SOFTALLOCATION_DETAILS
          SET Qty_Each = Qty_Each + IN_Actual_Qty_each,
              QTY = r_QTY_Soft_T,
              QTY_each_Allocation = QTY_each_Allocation + IN_Actual_Qty_each,
              QTY_Allocation = r_QTY_Allocation_Soft_T,
              editTime = R_CurrentTime,
              editwho = in_UserID
          WHERE SoftAllocationDetailsID = IN_SoftAllocationDetailsID
          AND organizationId = IN_organizationId
          AND warehouseid = IN_WarehouseId;
        END IF;
      END IF;
      UPDATE INV_LOT
      SET QtyPreAllocated = QtyPreAllocated + IN_Actual_Qty_each,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE LotNUm = IN_LotNUM_Soft
      AND organizationId = IN_organizationId
      AND warehouseid = IN_WarehouseId;


    ELSEIF IN_Call_Father = 'SPSO_HardAllocation_STD' THEN
      SELECT
        QTY_each,
        QTY_each_Allocation,
        PackID,
        UOM
      FROM ACT_SOFTALLOCATION_DETAILS
      WHERE SoftAllocationDetailsID = IN_SoftAllocationDetailsID
      AND organizationId = IN_organizationId
      AND warehouseid = IN_WarehouseId INTO r_QTY_Soft_T, r_QTY_Allocation_Soft_T, r_PackID_Soft_T, r_UOM_Soft_T;

      SELECT
        Qty
      FROM BAS_PACKAGE_DETAILS
      WHERE PackID = r_PackID_Order
      AND packUOM = r_UOM_Soft_T
      AND organizationId = IN_organizationId INTO r_UOMQty_Soft_T;

      SET R_QTY_Allocation_Soft_T2 = (r_QTY_Allocation_Soft_T + IN_Actual_Qty_each) / r_UOMQty_Soft_T;
      IF r_Qty_Soft_T <= r_Qty_Allocation_Soft_T + IN_Actual_Qty_each THEN
        UPDATE ACT_SOFTALLOCATION_DETAILS
        SET QTY_each_Allocation = QTY_each_Allocation + IN_Actual_Qty_each,
            Qty_Each = QTY_each_Allocation + IN_Actual_Qty_each,
            QTY_Allocation = r_QTY_Allocation_Soft_T2,
            Qty = r_QTY_Allocation_Soft_T2,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE SoftAllocationDetailsID = IN_SoftAllocationDetailsID
        AND organizationId = IN_organizationId
        AND warehouseid = IN_WarehouseId;
        UPDATE INV_LOT
        SET QtyPreAllocated = QtyPreAllocated + (r_Qty_Allocation_Soft_t + IN_Actual_Qty_each - r_Qty_Soft_T),
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE LotNUm = IN_LotNUM_Soft;

      ELSE
        UPDATE ACT_SOFTALLOCATION_DETAILS
        SET QTY_each_Allocation = QTY_each_Allocation + IN_Actual_Qty_each,
            QTY_Allocation = r_QTY_Allocation_Soft_T2,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE SoftAllocationDetailsID = IN_SoftAllocationDetailsID;
      END IF;

    END IF;



    SET OUT_Return_Code = 'NO_COMMIT';
    CALL SPCOM_GetIDSequence(IN_organizationId, IN_WarehouseId, IN_Language, 'AllocationDetailsID', r_AllocationDetailsID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;

    IF IFNULL(r_DeliveryNo, '') = '' THEN
      SET r_PickToTraceID = IN_TraceID_R;
    ELSE
      SET r_PickToTraceID = r_DeliveryNo;
    END IF;




    IF UPPER(IN_Call_Father) = UPPER('SPSO_InsertPicking') THEN
      IF r_LBL_PCK = 'Y'
        AND (IFNULL(r_DeliveryNo, '*') = '*'
        OR r_RequireDeliveryNo <> 'S') THEN
        IF NOT (IFNULL(in_DropID, '') = '') THEN
          SET r_PickToTraceID = IN_DropID;
        ELSEIF IN_Match_UOM <> 'EA' THEN

          IF R_DEL_DOC_SN IN ('Y', 'A')
            AND TRIM(r_CarrierID) IS NOT NULL
            AND r_RequireDeliveryNo IN ('Y', 'S') THEN

            SET r_ParaTemp = CONCAT('DELIVERYNO%', r_CarrierID, '%', IN_CustomerID_R, '%', r_CHANNEL);
          ELSE
            SET r_ParaTemp = 'TraceID';
          END IF;
          SET OUT_Return_Code = 'NO_COMMIT';
          CALL SPCOM_GetIDSequence(IN_organizationId, IN_WarehouseId, IN_Language, r_ParaTemp, r_PickToTraceID, OUT_Return_Code);
          IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
            LEAVE ENDPROC;
          END IF;
        ELSE
          SET r_ActualWeight = 0;
          SET r_ActualCubic = 0;
          SET r_MaxWeight = 999999;
          SET r_MaxCubic = 999999;
          SELECT
            MaxWeight,
            MaxCubic
          FROM Bas_Carton
          WHERE CartonID = 'STANDARD' INTO r_MaxWeight, r_MaxCubic;

          SET r_ZoneGroup = '*';
          SELECT
            ZoneGroup
          FROM BAS_LOCATION a
          WHERE a.LocationID = IN_LocationID_R
          AND organizationId = IN_organizationId
          AND warehouseid = IN_WarehouseId INTO r_ZoneGroup;

          SELECT
            IFNULL(MAX(B.CompatibilityGroup), '0')
          FROM BAS_SKU A
            INNER JOIN BAS_CUSTOMERFREIGHT B
              ON A.FreightClass = B.FreightCode
              AND A.CUSTOMERID = B.CustomerID
              AND A.organizationId = B.organizationId
          WHERE A.SKU = IN_SKU_R
          AND A.CustomerID = IN_CustomerID_R
          AND A.organizationId = IN_organizationId INTO R_CompatibilityGroup;


          SET r_PickToTraceID = '*';
          SELECT
            a.PickToTraceID
          FROM ACT_ALLOCATION_DETAILS a
            INNER JOIN BAS_LOCATION b
              ON a.Location = b.LocationID
              AND a.organizationId = b.organizationId
              AND a.warehouseid = b.Warehouseid
            INNER JOIN TSK_TASKLISTS d
              ON A.AllocationDetailsID = D.AllocationDetailsID
              AND a.organizationId = d.organizationId
              AND a.warehouseid = d.Warehouseid
            INNER JOIN BAS_SKU e
              ON A.SKU = E.SKU
              AND a.CustomerID = e.CustomerID
              AND a.organizationId = e.organizationId
            LEFT JOIN BAS_CUSTOMERFREIGHT f
              ON e.FreightClass = F.FreightCode
              AND e.CUSTOMERID = F.CustomerID
              AND e.organizationId = f.organizationId
          WHERE a.OrderNo = IN_OrderNo_R
          AND a.PickToTraceID <> '*'
          AND b.PickZone = c.Zone
          AND c.ZoneGroup = r_ZoneGroup
          AND a.Location = b.LocationID
          AND a.Status = '40'
          AND UOM = 'EA'
          AND a.organizationId = IN_organizationId
          AND a.warehouseid = IN_WarehouseId
          AND d.TaskProcess = '00'
          AND IFNULL(F.CompatibilityGroup, '0') = R_CompatibilityGroup
          ORDER BY a.PickToTraceID DESC
          LIMIT 1 INTO r_PickToTraceID;

          IF r_PickToTraceID <> '*' THEN
            SELECT
              SUM(GrossWeight),
              SUM(Cubic)
            FROM ACT_ALLOCATION_DETAILS
            WHERE PickToTraceID = r_PickToTraceID
            AND organizationId = IN_organizationId
            AND warehouseid = IN_WarehouseId INTO r_ActualWeight, r_ActualCubic;
          END IF;
          IF r_ActualWeight + r_GrossWeight > r_MaxWeight
            OR r_ActualCubic + r_Cubic > r_MaxCubic
            OR r_PickToTraceID = '*' THEN
            IF R_DEL_DOC_SN IN ('Y', 'A')
              AND TRIM(r_CarrierID) IS NOT NULL
              AND r_RequireDeliveryNo IN ('Y', 'S') THEN
              SET r_ParaTemp = 'DELIVERYNO%' || r_CarrierID || '%' || IN_CustomerID_R || '%' || r_CHANNEL;
            ELSE
              SET r_ParaTemp = 'TraceID';
            END IF;
            CALL SPCOM_GetIDSequence(IN_organizationId, IN_WarehouseId, IN_Language, r_ParaTemp, r_PickToTraceID, OUT_Return_Code);
            IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
              LEAVE ENDPROC;
            END IF;
          END IF;
        END IF;
      END IF;


      IF r_RequireDeliveryNo = 'S'
        AND r_ParaTemp LIKE 'DELIVERYNO%' THEN
        SET r_DeliveryNo = r_PickToTraceID;
        UPDATE DOC_ORDER_HEADER
        SET DeliveryNo = r_DeliveryNo
        WHERE OrderNo = IN_OrderNo_R
        AND organizationId = IN_organizationId
        AND warehouseid = IN_WarehouseId;
      END IF;

    END IF;


    IF r_OrderType = 'KT'
      OR r_OrderType = 'PS' THEN
      SET r_PickToLocation = CONCAT(r_wh_prefix, 'WB_RM_', r_WarehouseID);
      SET r_PickToTraceID = '*';
    ELSEIF r_OrderType = 'ADJ' THEN
      SET r_PickToLocation = CONCAT(r_wh_prefix, 'SORTATION', r_WarehouseID);
      SET r_PickToTraceID = '*';
    ELSE




      IF IN_OrderNo_R LIKE '#%#' THEN
        SET r_PickToLocation = r_wh_prefix || 'BPZ_' || r_WarehouseID;
      ELSE
        IF R_SRT_LOC IN ('Y', 'C') THEN
          SET r_PickToLocation = NULL;


          IF r_SRT_TYP = 'CON' THEN
            SELECT
              a.LocationID,
              SUM(CubicUsed),
              CubicCapacity,
              a.Round
            FROM TSK_SORTATION_STATION a
            WHERE a.consigneename = r_ConsigneeName
            AND a.warehouseid = r_WarehouseID
            AND a.organizationId = IN_organizationId
            GROUP BY a.LocationID,
                     a.CubicCapacity,
                     a.Round
            HAVING SUM(CubicUsed) + r_Cubic <= CubicCapacity
            ORDER BY a.LocationID
            LIMIT 1 INTO R_PickToLocation, R_CubicUsed_SS, r_CubicCapacity_SS, r_Round;

          ELSEIF R_SRT_TYP = 'ROU' THEN
            SELECT
              a.LocationID,
              SUM(CubicUsed),
              CubicCapacity,
              a.Round
            FROM TSK_SORTATION_STATION a
            WHERE a.Route = r_Route
            AND a.warehouseid = r_WarehouseID
            AND a.organizationId = IN_organizationId
            GROUP BY a.LocationID,
                     a.CubicCapacity,
                     a.Round
            HAVING SUM(CubicUsed) + r_Cubic <= CubicCapacity
            ORDER BY a.LocationID
            LIMIT 1 INTO R_PickToLocation, R_CubicUsed_SS, r_CubicCapacity_SS, r_Round;
          ELSEIF R_SRT_TYP = 'STP' THEN
            SELECT
              a.LocationID,
              SUM(CubicUsed),
              CubicCapacity,
              a.Round
            FROM TSK_SORTATION_STATION a
            WHERE IFNULL(a.STOP, '*') = IFNULL(r_STOP, '*')
            AND a.warehouseid = r_WarehouseID
            AND a.organizationId = IN_organizationId
            GROUP BY a.LocationID,
                     a.CubicCapacity,
                     a.Round
            HAVING SUM(CubicUsed) + r_Cubic <= CubicCapacity
            ORDER BY a.LocationID
            LIMIT 1 INTO R_PickToLocation, R_CubicUsed_SS, r_CubicCapacity_SS, r_Round;
          ELSEIF R_SRT_TYP = 'CAR' THEN
            SELECT
              a.LocationID,
              SUM(CubicUsed),
              CubicCapacity,
              a.Round
            FROM TSK_SORTATION_STATION a
              INNER JOIN DOC_ORDER_HEADER b
                ON a.OrderNo = b.OrderNo
                AND a.organizationId = b.organizationId
                AND a.warehouseid = b.Warehouseid
            WHERE b.CarrierID = r_CarrierID
            AND b.warehouseid = r_WarehouseID
            AND b.organizationId = IN_organizationId
            GROUP BY a.LocationID,
                     a.CubicCapacity,
                     a.Round
            HAVING SUM(CubicUsed) + r_Cubic <= CubicCapacity
            ORDER BY a.LocationID
            LIMIT 1 INTO R_PickToLocation, R_CubicUsed_SS, r_CubicCapacity_SS, r_Round;

          ELSE
            SELECT
              LocationID,
              CubicUsed,
              CubicCapacity,
              ROUND
            FROM TSK_SORTATION_STATION
            WHERE OrderNo = IN_OrderNo_R
            AND CubicUsed + R_Cubic <= CubicCapacity
            AND warehouseid = r_WarehouseID
            AND organizationId = IN_organizationId
            LIMIT 1 INTO R_PickToLocation, R_CubicUsed_SS, r_CubicCapacity_SS, r_Round;
          END IF;





          IF IFNULL(r_PickToLocation, '*') = '*' THEN






            SELECT
              sortationzone INTO R_SorationZone
            FROM BAS_ROUTE_SORTATION
            WHERE Route = R_Route
            AND WarehouseID = r_WarehouseID
            AND organizationId = IN_organizationId
            AND rownum = 1;

            IF r_SRT_LOC = 'C' THEN
              SELECT
                c.LocationID,
                c.CubicCapacity,
                c.Round
              FROM BAS_ROUTE_SORTATION b
                INNER JOIN BAS_LOCATION c
                  ON b.sortationzone = c.PutawayZone
                  AND a.organizationId = b.organizationId
                  AND a.warehouseid = b.Warehouseid
              WHERE c.LocationUsage = 'SS'
              AND b.Route = r_Route
              AND b.Warehouseid = r_warehouseid
              AND b.organizationId = IN_organizationId
              ORDER BY IFNULL(c.Round, 0), c.LogicalSequence
              LIMIT 1 INTO r_PickToLocation, r_CubicCapacity_SS, r_Round;

            ELSE
              SELECT
                c.LocationID,
                c.CubicCapacity,
                c.Round
              FROM BAS_ROUTE_SORTATION b
                INNER JOIN BAS_LOCATION c
                  ON b.sortationzone = c.PutawayZone
                  AND a.organizationId = b.organizationId
                  AND a.warehouseid = b.Warehouseid
              WHERE c.LocationUsage = 'SS'
              AND b.Route = r_Route
              AND b.Warehouseid = r_warehouseid
              AND b.organizationId = IN_organizationId
              AND c.LocationID NOT IN (SELECT
                  LocationID
                FROM TSK_SORTATION_STATION)
              ORDER BY IFNULL(c.Round, 0), c.LogicalSequence
              LIMIT 1 INTO r_PickToLocation, r_CubicCapacity_SS, r_Round;

            END IF;
            SET r_Round = IFNULL(r_Round, 0) + 1;

            IF r_PickToLocation = '*' THEN
              ROLLBACK;
              SET OUT_Return_Code = '416';
              LEAVE ENDPROC;
            END IF;

            IF r_SRT_LOC_CYC = 'Y' THEN
              UPDATE BAS_LOCATION
              SET ROUND = IFNULL(ROUND, 0) + 1,
                  UsedTime = SYSDATE()
              WHERE Locationid = r_PickToLocation
              AND WarehouseID = r_WarehouseID
              AND organizationId = IN_organizationId;
            END IF;

            INSERT INTO TSK_SORTATION_STATION (organizationId, LocationID, OrderNo, CubicUsed, CubicCapacity, qty, CONSIGNEENAME, Route, STOP, Warehouseid, ROUND, ADDTIME, addwho)
              VALUES (IN_organizationId, r_PickToLocation, IN_OrderNo_R, r_Cubic, r_CubicCapacity_SS, IN_Actual_Qty_each, r_CONSIGNEENAME, r_Route, r_Stop, r_Warehouseid, r_Round, SYSDATE(), IN_UserID);
          ELSE

            SELECT
              COUNT(*) INTO r_nRow
            FROM TSK_SORTATION_STATION
            WHERE LocationID = r_PickToLocation
            AND OrderNo = IN_OrderNo_R
            AND WarehouseID = r_WarehouseID
            AND organizationId = IN_organizationId;
            IF r_nRow = 0 THEN
              INSERT INTO TSK_SORTATION_STATION (organizationId, LocationID, OrderNo, CubicUsed, CubicCapacity, qty, CONSIGNEENAME, Route, STOP,
              Warehouseid, ROUND, ADDTIME, addwho)
                VALUES (IN_organizationId, r_PickToLocation, IN_OrderNo_R, r_Cubic, r_CubicCapacity_SS, IN_Actual_Qty_each, r_CONSIGNEENAME, r_Route, r_Stop, r_Warehouseid, r_Round, SYSDATE(), IN_UserID);
            ELSE
              UPDATE TSK_SORTATION_STATION
              SET CubicUsed = CubicUsed + r_Cubic,
                  qty = qty + IN_Actual_Qty_each
              WHERE LocationID = r_PickToLocation
              AND orderno = IN_OrderNo_R
              AND organizationId = IN_organizationId
              AND warehouseid = r_WarehouseID;
            END IF;
          END IF;

          IF r_SRT_LOC = 'C' THEN
            SET r_PickToLocation = CONCAT(r_wh_prefix, 'SORTATION', r_WarehouseID);
          END IF;
        ELSE
          SET r_PickToLocation = CONCAT(r_wh_prefix, 'SORTATION', r_WarehouseID);
        END IF;
      END IF;
    END IF;

    SET r_PickToLoc = NULL;
    SET r_PKTaskID_Sequence = 1;

    SET r_PackFlag = 'Y';

    SELECT
      cartonizeFlag
    FROM BAS_PACKAGE_DETAILS
    WHERE Packid = IN_PackID_Soft
    AND Packuom = IN_Match_UOM
    AND CustomerID = IN_CustomerID_R
    AND organizationId = IN_organizationId INTO r_CartonizeUOM;
    IF r_CartonizeUOM = 'Y' THEN
      SET r_PackFlag = 'N';
    ELSE
      SET r_PackFlag = 'Y';
    END IF;

    SET r_CartonSeqNo = 0;
    IF r_PackFlag = 'Y' THEN
      IF r_CHK_TYP = 'ORDER' THEN

        SELECT
          t.CartonSeqNo
        FROM ACT_ALLOCATION_DETAILS t
        WHERE t.OrderNo = IN_OrderNo_R
        AND PackFlag = 'Y'
        AND PickToTraceID = r_PickToTraceID
        AND organizationId = IN_organizationId
        AND warehouseid = r_WarehouseID
        LIMIT 1 INTO r_CartonSeqNo;


        IF r_CartonSeqNo = 0 THEN
          SELECT
            IFNULL(MAX(CartonSeqNo), 0) + 1 INTO r_CartonSeqNo
          FROM ACT_ALLOCATION_DETAILS t
          WHERE t.OrderNo = IN_OrderNo_R
          AND PackFlag = 'Y'
          AND organizationId = IN_organizationId
          AND warehouseid = r_WarehouseID;
        END IF;
      ELSEIF r_CHK_TYP = 'WAVE' THEN

        SELECT
          t.CartonSeqNo
        FROM ACT_ALLOCATION_DETAILS t
        WHERE t.Waveno = IN_WaveNo_R
        AND PackFlag = 'Y'
        AND PickToTraceID = r_PickToTraceID
        AND organizationId = IN_organizationId
        AND warehouseid = r_WarehouseID
        LIMIT 1 INTO r_CartonSeqNo;


        IF r_CartonSeqNo = 0 THEN
          SELECT
            IFNULL(MAX(CartonSeqNo), 0) + 1 INTO r_CartonSeqNo
          FROM ACT_ALLOCATION_DETAILS t
          WHERE t.Waveno = IN_WaveNo_R
          AND PackFlag = 'Y'
          AND organizationId = IN_organizationId
          AND warehouseid = r_WarehouseID;
        END IF;
      END IF;
    END IF;

    INSERT INTO ACT_ALLOCATION_DETAILS (organizationId, warehouseId, AllocationDetailsID, WaveNo, OrderNo, OrderLineNO, SKULINENO
    , CustomerID, Sku, LotNUM, UOM
    , Location, TraceID, Qty, Qty_Each, PackID
    , STATUS, SoftAllocationDetailsID
    , QtyPicked_Each, QtyShipped_Each, PickToLocation, PickToTraceID, PickedTime, PickedWho
    , ShipmentTime, ShipmentWho, ReasonCode, Notes
    , Cubic, GrossWeight, NetWeight, Price
    , ADDTIME, AddWho, EditTime, EditWho, SortationLocation
    , DropID, CartonSeqNo, PackFlag)
      VALUES (IN_organizationId, r_WarehouseID, r_AllocationDetailsID, IN_WaveNo_R, IN_OrderNo_R, IN_OrderLineNO_R, 0, IN_CustomerID_R, IN_SKU_R, IN_LotNUM_Soft, IN_Match_UOM, IN_LocationID_R, IN_TraceID_R, (IN_Actual_Qty_each / IN_UOMQty_R), IN_Actual_Qty_each, IN_PackID_Soft, '40', IN_SoftAllocationDetailsID, 0, 0, r_PickToLocation, r_PickToTraceID, NULL, NULL, NULL, NULL, NULL, NULL, r_Cubic, r_GrossWeight, r_NetWeight, r_Price, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_SortationLocation, r_PickToTraceID, r_CartonSeqNo, r_PackFlag);

    SET r_Qty_Each_ACT = 0;
    SELECT
      IFNULL(QtyAllocated_EACH, 0) INTO r_QtyAllocated_Each_Order
    FROM DOC_ORDER_DETAILS
    WHERE OrderNo = IN_OrderNo_R
    AND OrderLineNo = IN_OrderLineNO_R
    AND organizationId = IN_organizationId
    AND warehouseid = r_WarehouseID;
    SELECT
      SUM(Qty_Each) INTO r_Qty_Each_ACT
    FROM ACT_ALLOCATION_DETAILS
    WHERE OrderNo = IN_OrderNo_R
    AND OrderLineNo = IN_OrderLineNO_R
    AND organizationId = IN_organizationId
    AND warehouseid = r_WarehouseID;
    IF r_QtyAllocated_Each_Order <> r_Qty_Each_ACT THEN
      ROLLBACK;
      INSERT INTO SYS_STOREPROCESS (organizationId, Sp_Name, Seq, Store_Sql, ADDTIME, Addwho)
        VALUES (IN_organizationId, CONCAT('SPSO_HardAllocation_Update', FORMAT(SYSDATE(), '%Y-%m-%d %T')), 1, r_Store_Sql, SYSDATE(), IN_UserID);
      COMMIT;
      SET OUT_Return_Code = '427';
      LEAVE ENDPROC;
    END IF;



    SET OUT_Return_Code = 'NO_COMMIT';
    CALL SPCOM_GetIDSequence(IN_organizationId, IN_WarehouseId, IN_Language, 'TaskID', r_PKTaskID, OUT_Return_Code);
    IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;


    SET r_grouptaskid = '*';

    IF (r_PickToTraceID <> '*') THEN
      SELECT
        t.GROUPTASKID,
        t.PrintFlag
      FROM TSK_TASKLISTS t
      WHERE Tasktype = 'PK'
      AND PlanToID = r_PickToTraceID
      AND organizationId = IN_organizationId
      AND warehouseid = r_WarehouseID
      LIMIT 1 INTO r_grouptaskid, r_PrintFlag;
    END IF;
    INSERT INTO TSK_TASKLISTS (organizationId, TaskID, TaskID_Sequence, TaskType
    , DocType, DocNO, DocLineNO
    , CustomerID, Sku
    , FMLotNum, FMUOM, FMID
    , FMQty, FMQty_Each, FMPackID, FMLocation, LogicalFMSequence
    , PlanToLotNum, PlanToUOM, PlanToID
    , PlanToQty, PlanToQty_Each, PlanToPackID, PlanToLocation, PlanLogicalToSequence
    , TaskProcess, TaskProcessMsg, Priority, ReasonCode
    , OpenTime, OpenWho, HoldTime, HoldWho, CloseTime, CloseWho
    , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
    , Completed_TransactionID, Create_TransactionID, ReleaseTaskID, AllocationDetailsID
    , LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05, LotAtt06
    , PrintFlag
    , WarehouseID
    , LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12
    , GROUPTASKID)
      VALUES (IN_organizationId, r_PKTaskID, r_PKTaskID_Sequence, 'PK', 'SO', IN_OrderNo_R, IN_OrderLineNO_R, IN_CustomerID_R, IN_SKU_R, IN_LotNUM_Soft, IN_Match_UOM, IN_TraceID_R, IN_Actual_Qty_each / IN_UOMQty_R, IN_Actual_Qty_each, IN_PackID_Soft, IN_LocationID_R, r_LogicalSequence, IN_LotNUM_Soft, IN_Match_UOM, r_PickToTraceID, IN_Actual_Qty_each / IN_UOMQty_R, IN_Actual_Qty_each, IN_PackID_Soft, r_PickToLocation, r_LogicalSequence, '00', 'Pick Task', r_Priority, '', r_CurrentTime, IN_UserID, NULL, NULL, NULL, NULL, r_Cubic, r_GrossWeight, r_NetWeight, r_Price, NULL, NULL, NULL, r_AllocationDetailsID, r_LotAtt01, r_LotAtt02, r_LotAtt03, r_LotAtt04, r_LotAtt05, r_LotAtt06, r_PrintFlag, r_WarehouseID, r_LotAtt07, r_LotAtt08, r_LotAtt09, r_LotAtt10, r_LotAtt11, r_LotAtt12, r_grouptaskid);
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = CONCAT('000', r_AllocationDetailsID);

  END
  $$

--
-- Create procedure `SPCUS_KIT_TRN`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_KIT_TRN (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(100),
IN IN_kitNo varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_tariffId varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_lotatt11 varchar(10);
    DECLARE r_udf02 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_sku varchar(100);
    DECLARE r_qtyKit int;
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';
    SELECT DISTINCT
      A.kitNo,
      A.customerId,
      B.orderNo,
      A.kitSku,
      A.qtyKittedEach,
      A.lotAtt11,
      B.udf02 INTO IN_kitNo,
    IN_customerId,
    r_docNo,
    r_sku,
    r_qtyKit,
    r_lotatt11, r_udf02
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER B
        ON A.organizationId = B.organizationId
        AND A.warehouseId = B.warehouseId
        AND A.kitNo = B.kitNo
      LEFT JOIN ACT_TRANSACTION_LOG C
        ON B.organizationId = C.organizationId
        AND B.warehouseId = C.warehouseId
        AND B.kitNo = C.docNo
        AND A.lotNum = C.tolotNum
    WHERE A.organizationId = IN_organizationId
    AND A.warehouseId = IN_warehouseId
    AND A.lotAtt11 IN ('N', NULL)
    AND IFNULL(B.udf02, ' ') = ' '
    AND A.lineStatus >= '40'
    LIMIT 1;



    CALL SPCOM_GetIDSequence(IN_organizationId,
    IN_warehouseId,
    IN_Language,
    'BILLINGSUMMARYID',
    R_BILLINGSUMMARYID,
    OUT_returnCode);

    IF r_lotatt11 IN (' ', 'N') THEN
      SELECT
        COUNT(1) INTO r_RNOW
      FROM DOC_KIT_DETAILS A
        LEFT JOIN DOC_KIT_HEADER A1
          ON A.ORGANIZATIONID = A1.ORGANIZATIONID
          AND A.CUSTOMERID = A1.CUSTOMERID
          AND A.WAREHOUSEID = A1.WAREHOUSEID
          AND A.KITNO = A1.`kitNo`
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
          ON A.ORGANIZATIONID = B.ORGANIZATIONID
          AND A.CUSTOMERID = B.CUSTOMERID
          AND A.WAREHOUSEID = B.WAREHOUSEID
          AND A.KITSKU = B.SKU
        LEFT JOIN BIL_TARIFF_HEADER C
          ON B.ORGANIZATIONID = C.ORGANIZATIONID
          AND B.TARIFFID = C.TARIFFID
        LEFT JOIN BIL_TARIFF_DETAILS D
          ON C.ORGANIZATIONID = D.ORGANIZATIONID
          AND C.TARIFFID = D.TARIFFID
          AND D.CHARGECATEGORY = 'TR'
          AND D.CHARGETYPE = 'TRKT'
          AND D.RATEBASE = 'FLAT'
        LEFT JOIN BIL_TARIFF_RATE E
          ON D.ORGANIZATIONID = E.ORGANIZATIONID
          AND D.TARIFFID = E.TARIFFID
          AND D.TARIFFLINENO = E.TARIFFLINENO
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.KITNO = IN_kitNo
      AND A.lotAtt11 IN ('N', ' ')
      AND D.CHARGETYPE IS NOT NULL;
      IF r_RNOW = 1
        AND r_udf02 <> 'N' THEN
        INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
        WAREHOUSEID,
        BILLINGSUMMARYID,
        BILLINGFROMDATE,
        BILLINGTODATE,
        CUSTOMERID,
        SKU,
        QTY,
        UOM,
        TARIFFID,
        CHARGECATEGORY,
        CHARGETYPE,
        DESCR,
        RATEBASE,
        chargeRate,
        AMOUNT,
        BILLINGAMOUNT,
        ARNO,
        COST,
        DOCTYPE,
        DOCNO,
        BILLTO,
        ADDWHO,
        EDITWHO,
        ADDTIME,
        EDITTIME)
          SELECT
            A.ORGANIZATIONID,
            A.WAREHOUSEID,
            CURDATE(),
            CURDATE(),
            A.CUSTOMERID,
            A.KITSKU,
            A.qtyKittedEach,
            'ORDER',
            B.TARIFFID,
            D.chargeCategory,
            D.ChargeType,
            D.DESCRC,
            D.RATEBASE,
            E.RATE,
            E.rate,
            E.RATE,
            '*',
            0,
            'KIT',
            A.KITNO,
            A.CUSTOMERID,
            'UDFTIMER',
            'UDFTIMER',
            NOW(),
            NOW()
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
              AND D.RATEBASE = 'FLAT'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_kitNo;
      END IF;
    END IF;


    UPDATE DOC_KIT_HEADER A
    SET A.udf02 = 'N'
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.KITNO = IN_kitNo
    AND r_lotatt11 IN (' ', 'N');
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_KIT_FIX`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_KIT_FIX (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(100),
IN IN_kitNo varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_tariffId varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_lotatt11 varchar(10);
    DECLARE r_udf03 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_sku varchar(100);
    DECLARE r_qtyKit int;
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';
    SELECT DISTINCT
      A.kitNo,
      A.customerId,
      B.orderNo,
      A.kitSku,
      A.qtyKittedEach,
      A.lotAtt11,
      B.udf03 INTO IN_kitNo,
    IN_customerId,
    r_docNo,
    r_sku,
    r_qtyKit,
    r_lotatt11, r_udf03
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER B
        ON A.organizationId = B.organizationId
        AND A.warehouseId = B.warehouseId
        AND A.kitNo = B.kitNo
      LEFT JOIN ACT_TRANSACTION_LOG C
        ON B.organizationId = C.organizationId
        AND B.warehouseId = C.warehouseId
        AND B.kitNo = C.docNo
        AND A.lotNum = C.tolotNum
    WHERE A.organizationId = IN_organizationId
    AND A.warehouseId = IN_warehouseId
    AND A.lotAtt11 IN (' ', 'N')
    AND IFNULL(B.udf03, ' ') = ' '
    AND A.lineStatus >= '40'
    LIMIT 1;



    CALL SPCOM_GetIDSequence(IN_organizationId,
    IN_warehouseId,
    IN_Language,
    'BILLINGSUMMARYID',
    R_BILLINGSUMMARYID,
    OUT_returnCode);
    IF r_lotatt11 IN (' ', 'N') THEN
      SELECT
        COUNT(1) INTO r_RNOW
      FROM DOC_KIT_DETAILS A
        LEFT JOIN DOC_KIT_HEADER A1
          ON A.ORGANIZATIONID = A1.ORGANIZATIONID
          AND A.CUSTOMERID = A1.CUSTOMERID
          AND A.WAREHOUSEID = A1.WAREHOUSEID
          AND A.KITNO = A1.`kitNo`
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
          ON A.ORGANIZATIONID = B.ORGANIZATIONID
          AND A.CUSTOMERID = B.CUSTOMERID
          AND A.WAREHOUSEID = B.WAREHOUSEID
          AND A.KITSKU = B.SKU
        LEFT JOIN BIL_TARIFF_HEADER C
          ON B.ORGANIZATIONID = C.ORGANIZATIONID
          AND B.TARIFFID = C.TARIFFID
        LEFT JOIN BIL_TARIFF_DETAILS D
          ON C.ORGANIZATIONID = D.ORGANIZATIONID
          AND C.TARIFFID = D.TARIFFID
          AND D.CHARGECATEGORY = 'VA'
          AND D.CHARGETYPE = 'KT'
          AND D.RATEBASE = 'FLAT'
        LEFT JOIN BIL_TARIFF_RATE E
          ON D.ORGANIZATIONID = E.ORGANIZATIONID
          AND D.TARIFFID = E.TARIFFID
          AND D.TARIFFLINENO = E.TARIFFLINENO
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.KITNO = IN_kitNo
      AND A.lotAtt11 IN (' ', 'N')
      AND D.CHARGETYPE IS NOT NULL;
      IF r_RNOW = 1
        AND r_udf03 <> 'N' THEN
        INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
        WAREHOUSEID,
        BILLINGSUMMARYID,
        BILLINGFROMDATE,
        BILLINGTODATE,
        CUSTOMERID,
        SKU,
        QTY,
        UOM,
        TARIFFID,
        CHARGECATEGORY,
        CHARGETYPE,
        DESCR,
        RATEBASE,
        chargeRate,
        AMOUNT,
        BILLINGAMOUNT,
        ARNO,
        COST,
        DOCTYPE,
        DOCNO,
        BILLTO,
        ADDWHO,
        EDITWHO,
        ADDTIME,
        EDITTIME)
          SELECT
            A.ORGANIZATIONID,
            A.WAREHOUSEID,
            R_BILLINGSUMMARYID,
            CURDATE(),
            CURDATE(),
            A.CUSTOMERID,
            A.KITSKU,
            A.qtyKittedEach,
            'ORDER',
            B.TARIFFID,
            D.chargeCategory,
            D.ChargeType,
            D.DESCRC,
            D.rateBase,
            E.rate,
            E.rate,
            E.rate,
            '*',
            0,
            'KIT',
            A.KITNO,
            A.CUSTOMERID,
            'UDFTIMER',
            'UDFTIMER',
            NOW(),
            NOW()
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'VA'
              AND D.CHARGETYPE = 'KT'
              AND D.RATEBASE = 'FLAT'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_KITNO;
      END IF;
    END IF;


    UPDATE DOC_KIT_HEADER A
    SET A.udf03 = 'N'
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.KITNO = IN_kitNo
    AND r_lotatt11 IN (' ', 'N');

    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_FIX_BIL`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_FIX_BIL (IN IN_warehouseId varchar(20),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_organizationId varchar(100);
    DECLARE r_rateBase varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_Billingdate varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE R_udf05 varchar(10);
    DECLARE R_tariffId varchar(100);
    DECLARE r_chargeType varchar(100);
    DECLARE r_fixedAmount varchar(100);
    DECLARE r_CurrentTime date;
    DECLARE r_IncomeTaxRate decimal(18, 8);
    DECLARE done int DEFAULT FALSE;

    DECLARE CUR_FIX CURSOR FOR
    SELECT DISTINCT
      a.tariffId,
      a.chargeType,
      a.minAmount,
      a.incomeTaxRate,
      a.rateBase,
      b.billingDate,
      a.udf05
    FROM BIL_TARIFF_DETAILS a
      LEFT JOIN BIL_TARIFF_HEADER b
        ON a.organizationId = b.organizationId
        AND a.tariffId = a.tariffId
      LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE c1
        ON c1.organizationId = a.organizationId
        AND c1.tariffId = b.contractNo
    WHERE a.organizationId = IN_organizationId
    AND c1.warehouseId = IN_warehouseId
    AND c1.customerType = 'OW'
    AND a.`chargeCategory` = 'FX';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';
    OPEN CUR_FIX;
  read_loop:
    LOOP
      FETCH CUR_FIX INTO R_tariffId, r_chargeType, r_fixedAmount, r_IncomeTaxRate, r_rateBase, R_Billingdate, R_udf05;
      IF done THEN
        LEAVE read_loop;
      END IF;

      CALL SPCOM_GetIDSequence(IN_organizationId, IN_warehouseId, IN_Language, 'BILLINGSUMMARYID', R_BILLINGSUMMARYID, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;

        IF r_rateBase = 'DAY' THEN
          INSERT INTO BIL_SUMMARY (ORGANIZATIONID, WAREHOUSEID, BILLINGSUMMARYID, BILLINGFROMDATE, BILLINGTODATE,
          CUSTOMERID, TARIFFID, CHARGECATEGORY, CHARGETYPE, DESCR,
          RATEBASE, chargeRate, AMOUNT, BILLINGAMOUNT, ARNO, COST,
          BILLTO, ADDWHO, EDITWHO, ADDTIME, EDITTIME)
            SELECT
              A.ORGANIZATIONID,
              B.WAREHOUSEID,
              R_BILLINGSUMMARYID,
              CURDATE(),
              CURDATE(),
              B.CUSTOMERID,
              B.TARIFFID,
              D.CHARGECATEGORY,
              D.CHARGETYPE,
              D.DESCRC,
              'DAY',
              D.minAmount,
              D.minAmount,
              D.minAmount,
              '*',
              0,
              B.CUSTOMERID,
              'UDFTIMER',
              'UDFTIMER',
              NOW(),
              NOW()
            FROM BIL_TARIFF_HEADER A
              LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                ON A.ORGANIZATIONID = B.ORGANIZATIONID
                AND A.CONTRACTNO = B.TARIFFID
                AND B.CUSTOMERTYPE = 'OW'
              LEFT JOIN BIL_TARIFF_DETAILS D
                ON A.ORGANIZATIONID = D.ORGANIZATIONID
                AND A.TARIFFID = D.TARIFFID
                AND D.CHARGECATEGORY = 'FX'
            WHERE A.ORGANIZATIONID = IN_organizationId
            AND D.rateBase = 'DAY';
        END IF;



        IF DAY(CURDATE()) = 1 THEN
          IF r_rateBase = 'MONTH' THEN

            INSERT INTO BIL_SUMMARY (ORGANIZATIONID, WAREHOUSEID, BILLINGSUMMARYID, BILLINGFROMDATE, BILLINGTODATE,
            CUSTOMERID, TARIFFID, CHARGECATEGORY, CHARGETYPE, DESCR,
            RATEBASE, chargeRate, AMOUNT, BILLINGAMOUNT, ARNO, COST,
            BILLTO, ADDWHO, EDITWHO, ADDTIME, EDITTIME)
              SELECT
                A.ORGANIZATIONID,
                B.WAREHOUSEID,
                R_BILLINGSUMMARYID,
                CURDATE(),
                CURDATE(),
                B.CUSTOMERID,
                B.TARIFFID,
                D.CHARGECATEGORY,
                D.CHARGETYPE,
                D.DESCRC,
                'MONTH',
                D.minAmount,
                D.minAmount,
                D.minAmount,
                '*',
                0,
                B.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                NOW(),
                NOW()
              FROM BIL_TARIFF_HEADER A
                LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CONTRACTNO = B.TARIFFID
                  AND B.CUSTOMERTYPE = 'OW'
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON A.ORGANIZATIONID = D.ORGANIZATIONID
                  AND A.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'FX'
              WHERE A.ORGANIZATIONID = IN_organizationId
              AND D.rateBase = 'MONTH';
          END IF;
        END IF;
      END IF;
    END LOOP;
    CLOSE CUR_FIX;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_BIL_VASKIT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BIL_VASKIT (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(100),
IN IN_kitNo varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE IN_organizationId varchar(100) DEFAULT 'OJV_CML';
  DECLARE r_tariffId varchar(100);
  DECLARE R_vasType varchar(100);
  DECLARE r_docNo varchar(100);
  DECLARE r_docLineNo varchar(100);
  DECLARE r_udf01 varchar(10);
  DECLARE r_RNOW int;
  DECLARE r_sku varchar(100);
  DECLARE r_qtyVas int;
  DECLARE IN_Language varchar(100);
  DECLARE R_BILLINGSUMMARYID varchar(100);
  DECLARE done int DEFAULT FALSE;
  DECLARE CUR_VAS CURSOR FOR
  SELECT
    A.orderNo,
    A.orderLineNo,
    A.`vasType`,
    A.vasQty,
    C.sku,
    A.udf01
  FROM DOC_ORDER_VAS A
    LEFT JOIN DOC_KIT_HEADER AA
      ON AA.ORGANIZATIONID = A.ORGANIZATIONID
      AND AA.WAREHOUSEID = A.WAREHOUSEID
      AND AA.ORDERNO = A.ORDERNO
    LEFT JOIN DOC_ORDER_DETAILS C
      ON A.`organizationId` = C.`organizationId`
      AND A.`warehouseId` = C.`warehouseId`
      AND A.`orderNo` = C.`orderNo`
      AND A.`orderLineNo` = C.`orderLineNo`
    LEFT JOIN BAS_SKU_MULTIWAREHOUSE E
      ON E.`organizationId` = A.organizationId
      AND E.`warehouseId` = A.`warehouseId`
      AND E.`customerId` = AA.`customerId`
      AND E.sku = C.sku
  WHERE A.organizationId = 'OJV_CML'
  AND A.warehouseId = 'CBT01'
  AND IFNULL(A.udf01, ' ') = ' '
  AND AA.kitNo = IN_kitNo
  AND AA.`kitStatus` >= '40';
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
  OPEN CUR_VAS;
read_loop:
  LOOP
    FETCH CUR_VAS INTO r_docNo,
    r_docLineNo,
    R_vasType,
    r_qtyVas,
    r_sku,
    r_udf01;
    IF done THEN
      LEAVE read_loop;
    END IF;

    SET IN_Language = 'en';
    CALL SPCOM_GetIDSequence(IN_organizationId,
    IN_warehouseId,
    IN_Language,
    'BILLINGSUMMARYID',
    R_BILLINGSUMMARYID,
    OUT_returnCode);
    SELECT
      COUNT(1) INTO r_RNOW
    FROM DOC_ORDER_VAS A
      LEFT JOIN DOC_ORDER_DETAILS A1
        ON A.ORGANIZATIONID = A1.ORGANIZATIONID
        AND A.WAREHOUSEID = A1.WAREHOUSEID
        AND A.ORDERNO = A1.ORDERNO
        AND A.ORDERLINENO = A1.ORDERLINENO
      LEFT JOIN DOC_KIT_HEADER H1
        ON H1.ORGANIZATIONID = A1.ORGANIZATIONID
        AND H1.CUSTOMERID = A1.CUSTOMERID
        AND H1.WAREHOUSEID = A1.WAREHOUSEID
        AND H1.ORDERNO = A1.ORDERNO
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
        ON A1.ORGANIZATIONID = B.ORGANIZATIONID
        AND A1.CUSTOMERID = B.CUSTOMERID
        AND A1.WAREHOUSEID = B.WAREHOUSEID
        AND A1.SKU = B.SKU
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFID = C.CONTRACTNO
      LEFT JOIN BIL_TARIFF_DETAILS D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = 'VA'
        AND D.VASTYPE = A.VASTYPE
      LEFT JOIN BIL_TARIFF_RATE E
        ON D.ORGANIZATIONID = E.ORGANIZATIONID
        AND D.TARIFFID = E.TARIFFID
        AND D.TARIFFLINENO = E.TARIFFLINENO
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.ORDERNO = r_docNo
    AND A.ORDERLINENO = r_docLineNo
    AND D.CHARGETYPE IS NOT NULL
    AND A.VASTYPE = R_vasType;

    IF r_RNOW = 1 THEN
      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID,
      OUT_returnCode);
      INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
      WAREHOUSEID,
      BILLINGSUMMARYID,
      BILLINGFROMDATE,
      BILLINGTODATE,
      CUSTOMERID,
      SKU,
      QTY,
      UOM,
      TARIFFID,
      CHARGECATEGORY,
      CHARGETYPE,
      DESCR,
      RATEBASE,
      chargeRate,
      AMOUNT,
      BILLINGAMOUNT,
      ARNO,
      APNO,
      COST,
      DOCTYPE,
      DOCNO,
      BILLTO,
      ADDWHO,
      EDITWHO,
      ADDTIME,
      EDITTIME,
      UDF01,
      UDF02)
        SELECT DISTINCT
          A.ORGANIZATIONID,
          A.WAREHOUSEID,
          R_BILLINGSUMMARYID,
          CURDATE(),
          CURDATE(),
          A2.CUSTOMERID,
          OD.SKU,
          A.VASQTY,
          A.PACKUOM,
          B.TARIFFID,
          D.chargeCategory,
          D.chargeType,
          CM.CODEDESCR,
          D.RATEBASE,
          E.RATE,
          E.RATE * A.VASQTY,
          E.RATE * A.VASQTY,
          '*',
          '*',
          0,
          'KIT',
          A.ORDERNO,
          B.CUSTOMERID,
          'UDFTIMER',
          'UDFTIMER',
          NOW(),
          NOW(),
          D.UDF01,
          D.UDF02
        FROM DOC_ORDER_VAS A
          LEFT JOIN DOC_KIT_HEADER A2
            ON A.ORGANIZATIONID = A2.ORGANIZATIONID
            AND A.WAREHOUSEID = A2.WAREHOUSEID
            AND A.ORDERNO = A2.ORDERNO
          LEFT JOIN DOC_ORDER_DETAILS OD
            ON A.ORGANIZATIONID = OD.ORGANIZATIONID
            AND A.WAREHOUSEID = OD.WAREHOUSEID
            AND A.ORDERNO = OD.ORDERNO
            AND A.ORDERLINENO = OD.ORDERLINENO
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND OD.SKU = B.SKU
          LEFT JOIN BSM_CODE_ML CM
            ON CM.ORGANIZATIONID = A.ORGANIZATIONID
            AND CM.CODETYPE = 'VAS_TYP'
            AND CM.CODEID = A.VASTYPE
            AND CM.LANGUAGEID = 'en'
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFID = C.TARIFFID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'VA'
            AND D.CHARGETYPE = 'KT01'
            AND D.VASTYPE = A.VASTYPE
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
        AND A.WAREHOUSEID = IN_WAREHOUSEID
        AND A.ORDERNO = r_docNo
        AND IFNULL(A.udf01, ' ') = ' '
        AND A.VASTYPE = R_vasType
        AND A.ORDERLINENO = r_docLineNo;
    END IF;

    UPDATE DOC_ORDER_VAS A
    SET A.udf01 = 'Y'
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.warehouseId = IN_WAREHOUSEID
    AND A.orderNo = r_docNo
    AND A.VASTYPE = R_vasType
    AND A.orderLineNo = r_docLineNo;
  END LOOP;
  CLOSE CUR_VAS;
  SET OUT_returnCode := '000';
END
$$

--
-- Create procedure `SPCUS_BIL_NOMKIT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BIL_NOMKIT (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(100),
IN IN_kitNo varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_tariffId varchar(100);
    DECLARE r_lotAtt11 varchar(10);
    DECLARE R_chargeType varchar(100);
    DECLARE R_descrC varchar(100);
    DECLARE R_chargeCategory varchar(100);
    DECLARE R_rate decimal;
    DECLARE R_rateBase varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_udf01 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_sku varchar(100);
    DECLARE r_qtyKit int;
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    SELECT
      A.kitNo,
      A.customerId,
      B.orderNo,
      A.kitSku,
      A.qtyKittedEach,
      A.lotAtt11,
      B.udf01 INTO IN_kitNo,
    IN_customerId,
    r_docNo,
    r_sku,
    r_qtyKit,
    r_lotAtt11,
    r_udf01
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER B
        ON A.organizationId = B.organizationId
        AND A.warehouseId = B.warehouseId
        AND A.kitNo = B.kitNo
      LEFT JOIN ACT_TRANSACTION_LOG C
        ON B.organizationId = C.organizationId
        AND B.warehouseId = C.warehouseId
        AND B.kitNo = C.docNo
        AND A.lotNum = C.tolotNum
    WHERE A.organizationId = IN_organizationId
    AND A.warehouseId = IN_warehouseId
    AND IFNULL(A.udf01, ' ') = ' '
    AND A.lineStatus >= '40';
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';


    SELECT
      A.tariffId INTO r_tariffId
    FROM BIL_TARIFF_HEADER A
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
        ON A.`organizationId` = B.`organizationId`
        AND A.`contractNo` = B.`tariffId`
      LEFT JOIN DOC_KIT_DETAILS C
        ON C.`organizationId` = A.`organizationId`
        AND C.`warehouseId` = B.`warehouseId`
        AND C.customerId = B.`customerId`
        AND C.kitsku = B.sku
    WHERE A.organizationId = IN_organizationId
    AND B.warehouseId = IN_warehouseId
    AND C.kitNo = IN_kitNo
    LIMIT 1;

    SELECT
      B.chargeType,
      B.chargeCategory,
      B.descrC,
      B.rateBase,
      C.rate INTO R_chargeType,
    R_chargeCategory, R_descrC,
    R_rateBase,
    R_rate
    FROM BIL_TARIFF_HEADER A
      LEFT JOIN BIL_TARIFF_DETAILS B
        ON A.organizationId = B.organizationId
        AND A.tariffId = B.tariffId
      LEFT JOIN BIL_TARIFF_RATE C
        ON B.organizationId = C.organizationId
        AND B.tariffId = C.tariffId
        AND B.tariffLineNo = C.tariffLineNo
    WHERE A.organizationId = IN_organizationId
    AND A.tariffId = IN_warehouseId
    AND B.chargeType = 'TRKT'
    AND B.chargeCategory = 'TR'
    AND B.`ratebase` = 'QUANTITY'
    LIMIT 1;
    CALL SPCOM_GetIDSequence(IN_organizationId,
    IN_warehouseId,
    IN_Language,
    'BILLINGSUMMARYID',
    R_BILLINGSUMMARYID,
    OUT_returnCode);
    IF r_lotAtt11 = 'N' THEN
      SELECT
        COUNT(1) INTO r_RNOW
      FROM DOC_KIT_DETAILS A
        LEFT JOIN DOC_KIT_HEADER A1
          ON A.ORGANIZATIONID = A1.ORGANIZATIONID
          AND A.CUSTOMERID = A1.CUSTOMERID
          AND A.WAREHOUSEID = A1.WAREHOUSEID
          AND A.KITNO = A1.`kitNo`
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
          ON A.ORGANIZATIONID = B.ORGANIZATIONID
          AND A.CUSTOMERID = B.CUSTOMERID
          AND A.WAREHOUSEID = B.WAREHOUSEID
          AND A.KITSKU = B.SKU
        LEFT JOIN BIL_TARIFF_HEADER C
          ON B.ORGANIZATIONID = C.ORGANIZATIONID
          AND B.TARIFFID = C.TARIFFID
        LEFT JOIN BIL_TARIFF_DETAILS D
          ON C.ORGANIZATIONID = D.ORGANIZATIONID
          AND C.TARIFFID = D.TARIFFID
          AND D.CHARGECATEGORY = 'TR'
          AND D.CHARGETYPE = 'TRKT'
          AND D.rateBase = 'QUANTITY'
        LEFT JOIN BIL_TARIFF_RATE E
          ON D.ORGANIZATIONID = E.ORGANIZATIONID
          AND D.TARIFFID = E.TARIFFID
          AND D.TARIFFLINENO = E.TARIFFLINENO
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.KITNO = IN_kitNo
      AND D.CHARGETYPE IS NOT NULL;
      IF r_RNOW = 1
        AND r_udf01 <> 'N' THEN
        INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
        WAREHOUSEID,
        BILLINGSUMMARYID,
        BILLINGFROMDATE,
        BILLINGTODATE,
        CUSTOMERID,
        SKU,
        QTY,
        UOM,
        TARIFFID,
        CHARGECATEGORY,
        CHARGETYPE,
        DESCR,
        RATEBASE,
        chargeRate,
        AMOUNT,
        BILLINGAMOUNT,
        ARNO,
        COST,
        DOCTYPE,
        DOCNO,
        BILLTO,
        ADDWHO,
        EDITWHO,
        ADDTIME,
        EDITTIME)
          SELECT
            A.ORGANIZATIONID,
            A.WAREHOUSEID,
            R_BILLINGSUMMARYID,
            CURDATE(),
            CURDATE(),
            A.CUSTOMERID,
            A.KITSKU,
            A.qtyKittedEach,
            D.RATEBASE,
            B.TARIFFID,
            D.chargeCategory,
            D.chargeType,
            D.DESCRC,
            D.RATEBASE,
            E.RATE,
            CASE WHEN D.RATEBASE = 'QUANTITY' THEN A.qtyKittedEach * E.Rate WHEN D.RATEBASE = 'CUBIC' THEN A.qtyKittedEach * S.cube * E.Rate ELSE E.Rate END,
            '*',
            0,
            'KIT',
            A.KITNO,
            A.CUSTOMERID,
            'UDFTIMER',
            'UDFTIMER',
            NOW(),
            NOW()
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BAS_SKU S
              ON B.ORGANIZATIONID = S.ORGANIZATIONID
              AND B.CUSTOMERID = S.CUSTOMERID
              AND B.SKU = S.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
          AND A.WAREHOUSEID = IN_WAREHOUSEID
          AND A.KITNO = IN_KITNO;
      END IF;
    END IF;

    UPDATE DOC_KIT_HEADER A
    SET A.udf01 = 'N'
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.KITNO = IN_kitNo
    AND r_lotAtt11 = 'N';

    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_BIL_KIT_SAMSONITE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BIL_KIT_SAMSONITE (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(100),
IN IN_kitNo varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_tariffId varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_lotatt11 varchar(10);
    DECLARE r_udf01 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_RNOW1 int;
    DECLARE r_sku varchar(100);
    DECLARE r_qtyKit int;
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    SELECT DISTINCT
      A.kitNo,
      A.customerId,
      B.orderNo,
      A.kitSku,
      A.qtyKittedEach,
      A.lotAtt11,
      B.udf01 INTO IN_kitNo,
    IN_customerId,
    r_docNo,
    r_sku,
    r_qtyKit,
    r_lotatt11, r_udf01
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER B
        ON A.organizationId = B.organizationId
        AND A.warehouseId = B.warehouseId
        AND A.kitNo = B.kitNo
      LEFT JOIN ACT_TRANSACTION_LOG C
        ON B.organizationId = C.organizationId
        AND B.warehouseId = C.warehouseId
        AND B.kitNo = C.docNo
        AND A.lotNum = C.tolotNum
    WHERE A.organizationId = IN_organizationId
    AND A.warehouseId = IN_warehouseId
    AND A.lotAtt11 = 'Y'
    AND IFNULL(A.udf01, ' ') = ' '
    AND A.lineStatus >= '40'
    LIMIT 1;
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';




    IF r_lotatt11 = 'Y'
      AND IN_customerId = 'SAMSONITE' THEN
      SELECT
        COUNT(1) INTO r_RNOW
      FROM DOC_KIT_DETAILS A
        LEFT JOIN DOC_KIT_HEADER A1
          ON A.ORGANIZATIONID = A1.ORGANIZATIONID
          AND A.CUSTOMERID = A1.CUSTOMERID
          AND A.WAREHOUSEID = A1.WAREHOUSEID
          AND A.KITNO = A1.`kitNo`
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
          ON A.ORGANIZATIONID = B.ORGANIZATIONID
          AND A.CUSTOMERID = B.CUSTOMERID
          AND A.WAREHOUSEID = B.WAREHOUSEID
          AND A.KITSKU = B.SKU
        LEFT JOIN BIL_TARIFF_HEADER C
          ON B.ORGANIZATIONID = C.ORGANIZATIONID
          AND B.TARIFFID = C.TARIFFID
        LEFT JOIN BIL_TARIFF_DETAILS D
          ON C.ORGANIZATIONID = D.ORGANIZATIONID
          AND C.TARIFFID = D.TARIFFID
          AND D.CHARGECATEGORY = 'TR'
          AND D.CHARGETYPE = 'TRKT'
          AND D.RATEBASE IN ('QUANTITY', 'UOMQUANTITY')
        LEFT JOIN BIL_TARIFF_RATE E
          ON D.ORGANIZATIONID = E.ORGANIZATIONID
          AND D.TARIFFID = E.TARIFFID
          AND D.TARIFFLINENO = E.TARIFFLINENO
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.KITNO = IN_kitNo
      AND A.lotAtt11 = 'Y'
      AND D.CHARGETYPE IS NOT NULL;
      IF r_RNOW = 1
        AND r_udf01 <> 'Y' THEN
        CALL SPCOM_GetIDSequence(IN_organizationId,
        IN_warehouseId,
        IN_Language,
        'BILLINGSUMMARYID',
        R_BILLINGSUMMARYID1,
        OUT_returnCode);
        IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
        INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
        WAREHOUSEID,
        BILLINGSUMMARYID,
        BILLINGFROMDATE,
        BILLINGTODATE,
        CUSTOMERID,
        SKU,
        QTY,
        UOM,
        TARIFFID,
        CHARGECATEGORY,
        CHARGETYPE,
        DESCR,
        RATEBASE,
        chargeRate,
        AMOUNT,
        BILLINGAMOUNT,
        ARNO,
        COST,
        DOCTYPE,
        DOCNO,
        BILLTO,
        ADDWHO,
        EDITWHO,
        ADDTIME,
        EDITTIME)
          SELECT
            A.ORGANIZATIONID,
            A.WAREHOUSEID,
            R_BILLINGSUMMARYID,
            CURDATE(),
            CURDATE(),
            A.CUSTOMERID,
            A.KITSKU,
            A.qtyKittedEach,
            'PIECES',
            B.TARIFFID,
            'Inbund Charges',
            'Samsonite Set Inbound',
            D.DESCRC,
            D.RATEBASE,
            E.RATE,
            A.qtyKittedEach * E.Rate,
            A.qtyKittedEach * E.Rate,
            '*',
            0,
            'KIT',
            A.KITNO,
            A.CUSTOMERID,
            'UDFTIMER',
            'UDFTIMER',
            NOW(),
            NOW()
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
              AND D.RATEBASE = 'CUBIC'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_KITNO;
      END IF;
    END IF;

    SELECT
      COUNT(1) INTO r_RNOW1
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER A1
        ON A.ORGANIZATIONID = A1.ORGANIZATIONID
        AND A.CUSTOMERID = A1.CUSTOMERID
        AND A.WAREHOUSEID = A1.WAREHOUSEID
        AND A.KITNO = A1.`kitNo`
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
        ON A.ORGANIZATIONID = B.ORGANIZATIONID
        AND A.CUSTOMERID = B.CUSTOMERID
        AND A.WAREHOUSEID = B.WAREHOUSEID
        AND A.KITSKU = B.SKU
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFID = C.TARIFFID
      LEFT JOIN BIL_TARIFF_DETAILS D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = 'TR'
        AND D.CHARGETYPE = 'TRKT'
        AND D.RATEBASE IN ('CUBIC')
      LEFT JOIN BIL_TARIFF_RATE E
        ON D.ORGANIZATIONID = E.ORGANIZATIONID
        AND D.TARIFFID = E.TARIFFID
        AND D.TARIFFLINENO = E.TARIFFLINENO
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.KITNO = IN_kitNo
    AND A.lotAtt11 = 'Y'
    AND D.CHARGETYPE IS NOT NULL;
    IF r_RNOW1 = 1
      AND r_udf01 <> 'Y' THEN
      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID1,
      OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
      WAREHOUSEID,
      BILLINGSUMMARYID,
      BILLINGFROMDATE,
      BILLINGTODATE,
      CUSTOMERID,
      SKU,
      QTY,
      UOM,
      TARIFFID,
      CHARGECATEGORY,
      CHARGETYPE,
      DESCR,
      RATEBASE,
      chargeRate,
      AMOUNT,
      BILLINGAMOUNT,
      ARNO,
      COST,
      DOCTYPE,
      DOCNO,
      BILLTO,
      ADDWHO,
      EDITWHO,
      ADDTIME,
      EDITTIME)
        SELECT
          A.ORGANIZATIONID,
          A.WAREHOUSEID,
          R_BILLINGSUMMARYID,
          CURDATE(),
          CURDATE(),
          A.CUSTOMERID,
          A.KITSKU,
          A.qtyKittedEach,
          'CUBIC',
          B.TARIFFID,
          'Inbund Charges',
          'Samsonite Set Inbound',
          D.DESCRC,
          D.RATEBASE,
          E.RATE,
          B1.cube * A.qtyKittedEach * E.Rate,
          B1.cube * A.qtyKittedEach * E.Rate,
          '*',
          0,
          'KIT',
          A.KITNO,
          A.CUSTOMERID,
          'UDFTIMER',
          'UDFTIMER',
          NOW(),
          NOW()
        FROM DOC_KIT_DETAILS A
          LEFT JOIN DOC_KIT_HEADER A1
            ON A.ORGANIZATIONID = A1.ORGANIZATIONID
            AND A.CUSTOMERID = A1.CUSTOMERID
            AND A.WAREHOUSEID = A1.WAREHOUSEID
            AND A.KITNO = A1.`kitNo`
          LEFT JOIN BAS_SKU B1
            ON B1.organizationId = A.organizationId
            AND B1.customerId = A1.customerId
            AND B1.sku = A.sku
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.KITSKU = B.SKU
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFID = C.TARIFFID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'TR'
            AND D.CHARGETYPE = 'TRKT'
            AND D.RATEBASE IN ('CUBIC')
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
        AND A.WAREHOUSEID = IN_warehouseId
        AND A.KITNO = IN_KITNO;
    END IF;

    UPDATE DOC_KIT_HEADER A
    SET A.udf01 = r_lotAtt11
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.KITNO = IN_kitNo
    AND r_lotAtt11 = 'Y';
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_BIL_KIT_NOM_NEW2`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BIL_KIT_NOM_NEW2 (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_KitNolist varchar(20000),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_BillingSummaryId varchar(30);
    DECLARE IN_kitNo varchar(30);
    DECLARE IN_CUSTOMERID varchar(100);
    DECLARE r_tariffId varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_lotatt11 varchar(10);
    DECLARE r_udf01 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_RNOW1 int;
    DECLARE r_RNOW2 int;
    DECLARE r_RNOW3 int;
    DECLARE r_RNOW4 int;
    DECLARE r_sku varchar(100);
    DECLARE r_vasDescr varchar(100);
    DECLARE r_kitsku varchar(100);
    DECLARE r_accessoryFlag varchar(100);
    DECLARE r_packMaterialFlag varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID1 varchar(100);
    DECLARE R_BILLINGSUMMARYID2 varchar(100);
    DECLARE R_BILLINGSUMMARYID3 varchar(100);
    DECLARE R_BILLINGSUMMARYID4 varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE kit_done int DEFAULT FALSE;
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';
    ## Get the Material for kitting
    DROP TEMPORARY TABLE IF EXISTS tmp_kitnolist;
    CREATE TEMPORARY TABLE tmp_kitnolist (
      kitno varchar(30)
    );
    IF (IFNULL(IN_KitNolist, '') != '') THEN
      SET @sql := CONCAT('Insert into tmp_kitnolist select distinct docNo from BIL_SUMMARY WHERE billingSummaryid in (''',
      REPLACE(IN_KitNolist, ',', ''','''),
      ''')');
      PREPARE dynamic_statement FROM @sql;
      EXECUTE dynamic_statement;
      DEALLOCATE PREPARE dynamic_statement;
    END IF;
    BEGIN
      DECLARE CUR_KITNO CURSOR FOR
      SELECT
        KITNO
      FROM tmp_kitnolist;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET kit_done = TRUE;
      OPEN CUR_KITNO;
    read_kitno:
      LOOP
        FETCH CUR_KITNO INTO IN_KITNO;
        IF kit_done THEN
          LEAVE read_kitno;
        END IF;
        IF EXISTS (SELECT
              *
            FROM BIL_SUMMARY
            WHERE DOCNO = IN_KITNO
            AND arNo = '*') THEN
          SET @ROWCOUNT = 0;
          INSERT INTO BIL_SUMMARY_LOG
            SELECT
              `organizationId`,
              `warehouseId`,
              `billingSummaryId`,
              `billingFromDate`,
              `billingToDate`,
              `customerId`,
              `sku`,
              `lotNum`,
              `traceId`,
              `tariffId`,
              `chargeCategory`,
              `chargeType`,
              `descr`,
              `rateBase`,
              `chargePerUnits`,
              `qty`,
              `uom`,
              `cubic`,
              `weight`,
              IFNULL(`chargeRate`, 0),
              IFNULL(`amount`, 0),
              IFNULL(`billingAmount`, 0),
              `cost`,
              `amountPayable`,
              `amountPaid`,
              `confirmTime`,
              `confirmWho`,
              `docType`,
              `docNo`,
              `createTransactionid`,
              `notes`,
              `ediSendTime`,
              `billTo`,
              `settleTime`,
              `settleWho`,
              `followUp`,
              `invoiceType`,
              `paidTo`,
              `costConfirmFlag`,
              `costConfirmTime`,
              `costConfirmWho`,
              `costSettleFlag`,
              `costSettleTime`,
              `costSettleWho`,
              `incomeTaxRate`,
              `costTaxRate`,
              `incomeTax`,
              `cosTax`,
              `incomeWithoutTax`,
              `cosWithoutTax`,
              `costInvoiceType`,
              `noteText`,
              `udf01`,
              `udf02`,
              `udf03`,
              `udf04`,
              `udf05`,
              `currentVersion`,
              `oprSeqFlag`,
              `addWho`,
              `addTime`,
              `editWho`,
              `editTime`,
              `locationCategory`,
              `manual`,
              `docLineNo`,
              `arNo`,
              `arLineNo`,
              `apNo`,
              `apLineNo`,
              `ediSendFlag`,
              `ediErrorCode`,
              `ediErrorMessage`,
              `ediSendTime2`,
              `ediSendFlag2`,
              `ediErrorCode2`,
              `ediErrorMessage2`,
              `billingTranCategory`,
              `orderType`,
              `containerType`,
              `containerSize`
            FROM BIL_SUMMARY
            WHERE DOCNO = IN_KITNO
            AND arNo = '*';
          SET @ROWCOUNT = ROW_COUNT();
          IF (@ROWCOUNT > 0) THEN -- If insert sucessfully and more than or equal to one record 
            DELETE
              FROM BIL_SUMMARY
            WHERE DOCNO = IN_KITNO
              AND arNo = '*';
          END IF;
        ELSE
          SELECT
            IN_KITNO;
        END IF;
        BEGIN
          DECLARE CUR_MAT CURSOR FOR
          SELECT
            A.kitSku,
            A.sku,
            A.`accessoryFlag`,
            B.packMaterialFlag
          FROM BAS_KIT_HEADER B
            LEFT JOIN BAS_KIT_DETAILS A
              ON B.`organizationId` = A.`organizationId`
              AND B.`customerId` = A.`customerId`
              AND B.`kitSku` = A.`kitSku`
              AND B.`versionNo` = A.`versionNo`
          WHERE A.organizationId = 'OJV_CML';
          -- and B.customerId =IN_customerId ;
          DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
          OPEN CUR_MAT;
        read_loop:
          LOOP
            FETCH CUR_MAT INTO r_kitsku,
            r_sku,
            r_accessoryFlag,
            r_packMaterialFlag;
            IF done THEN
              LEAVE read_loop;
            END IF;
            BEGIN
              GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
              @p2 = MESSAGE_TEXT,
              @p3 = MYSQL_ERRNO,
              @p4 = TABLE_NAME,
              @p5 = COLUMN_NAME;
              SELECT
                CONCAT('999#SPCUS_BIL_KIT_NOM_NEW2,',
                IFNULL(@p1, ''),
                ',',
                IFNULL(@p2, ''),
                ',',
                IFNULL(@p3, ''),
                ',',
                IFNULL(@p4, ''),
                ',',
                IFNULL(@p5, '')) AS outcode;
              SELECT
                v_errormessage AS error;
            END;
            SET v_error = 1;
            IF OUT_returnCode = 'NO_COMMIT'
              OR OUT_returnCode = '*_*' THEN
              SET v_NO_COMMIT = 'N';
            ELSE
              SET v_NO_COMMIT = 'Y';
            END IF;
            SELECT
              COUNT(1)
            FROM DOC_KIT_DETAILS A
              LEFT JOIN DOC_KIT_HEADER B
                ON A.organizationId = B.organizationId
                AND A.warehouseId = B.warehouseId
                AND A.kitNo = B.kitNo
              LEFT JOIN ACT_TRANSACTION_LOG C
                ON B.organizationId = C.organizationId
                AND B.warehouseId = C.warehouseId
                AND B.kitNo = C.docNo
                AND A.lotNum = C.tolotNum
            WHERE A.organizationId = IN_organizationId
            AND A.warehouseId = IN_warehouseId -- AND IFNULL(B.udf01, ' ') = ' ' 
            -- AND NOT EXISTS (SELECT * FROM BIL_SUMMARY C WHERE C.docNo = IN_kitNo )
            AND A.lotAtt11 IN (' ', NULL)
            AND A.lineStatus >= '40'
            AND A.KITNO = IN_kitNo INTO r_RNOW;
            SET IN_organizationId := 'OJV_CML';
            SET IN_Language = 'en';
            --  SELECT r_RNOW;
            IF r_RNOW > 0 -- START INSERT IF RECORD FOUND
            THEN
              SELECT
                COUNT(1) INTO r_RNOW4
              FROM DOC_KIT_SUBDETAILS KS
                LEFT JOIN DOC_KIT_DETAILS A
                  ON KS.`organizationId` = A.`organizationId`
                  AND KS.`warehouseId` = A.`warehouseId`
                  AND KS.KITNO = A.`kitNo`
                  AND KS.`kitLineNo` = A.`kitLineNo` --   AND KS.LOTNUM = A.LOTNUM 
                LEFT JOIN DOC_KIT_HEADER A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.CUSTOMERID = A1.CUSTOMERID
                  AND A.WAREHOUSEID = A1.WAREHOUSEID
                  AND A.KITNO = A1.`kitNo`
                LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND A.KITSKU = B.SKU
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFMASTERID = C.TARIFFMASTERID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'PAC_MAT'
                  AND D.CHARGETYPE = r_sku
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE KS.ORGANIZATIONID = 'OJV_CML'
              AND KS.WAREHOUSEID = IN_warehouseId
              AND KS.KITNO = IN_kitNo
              AND KS.SKU = r_sku
              AND r_accessoryFlag = 'Y'
              AND r_packMaterialFlag = 'Y'
              AND E.RATE IS NOT NULL
              AND IFNULL(C.tariffId, '*') <> '*'
              AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
              AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
              ##Insert material inside the billing
              IF r_RNOW4 = 1 THEN
                CALL SPCOM_GetIDSequence(IN_organizationId,
                IN_warehouseId,
                IN_Language,
                'BILLINGSUMMARYID',
                R_BILLINGSUMMARYID4,
                OUT_returnCode);
                IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                  ROLLBACK;
                  LEAVE ENDPROC;
                END IF;
                INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
                WAREHOUSEID,
                BILLINGSUMMARYID,
                BILLINGFROMDATE,
                BILLINGTODATE,
                CUSTOMERID,
                SKU,
                QTY,
                UOM,
                TARIFFID,
                CHARGECATEGORY,
                CHARGETYPE,
                DESCR,
                RATEBASE,
                chargeRate,
                AMOUNT,
                BILLINGAMOUNT,
                ARNO,
                APNO,
                COST,
                DOCTYPE,
                DOCNO,
                BILLTO,
                ADDWHO,
                EDITWHO,
                ADDTIME,
                EDITTIME,
                UDF01,
                UDF02,
                UDF03,
                UDF04)
                  SELECT
                    A.ORGANIZATIONID,
                    A.WAREHOUSEID,
                    R_BILLINGSUMMARYID4,
                    DATE_FORMAT(A.EDITTIME, '%Y-%m-%d'),
                    DATE_FORMAT(A.EDITTIME, '%Y-%m-%d'),
                    A.CUSTOMERID,
                    KS.SKU,
                    KS.qtyKittedEach,
                    'PIECES',
                    C.TARIFFID,
                    D.chargeCategory,
                    D.ChargeType,
                    D.descrC,
                    D.RATEBASE,
                    E.RATE,
                    KS.qtyKittedEach * E.Rate,
                    KS.qtyKittedEach * E.Rate,
                    '*',
                    '*',
                    0,
                    'KIT',
                    A.KITNO,
                    A.CUSTOMERID,
                    'UDFTIMER',
                    'UDFTIMER',
                    A.EDITTIME,
                    NOW(),
                    D.UDF01,
                    D.UDF02,
                    A.KITSKU,
                    D.UDF06
                  FROM DOC_KIT_DETAILS A
                    LEFT JOIN DOC_KIT_SUBDETAILS KS
                      ON A.ORGANIZATIONID = KS.ORGANIZATIONID
                      AND A.CUSTOMERID = KS.CUSTOMERID
                      AND A.WAREHOUSEID = KS.WAREHOUSEID
                      AND A.KITNO = KS.`kitNo`
                      AND A.KITLINENO = KS.KITLINENO
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                      ON A.ORGANIZATIONID = B.ORGANIZATIONID
                      AND A.CUSTOMERID = B.CUSTOMERID
                      AND A.WAREHOUSEID = B.WAREHOUSEID
                      AND A.KITSKU = B.SKU
                    LEFT JOIN BIL_TARIFF_HEADER C
                      ON B.ORGANIZATIONID = C.ORGANIZATIONID
                      AND B.TARIFFMASTERID = C.TARIFFMASTERID
                    LEFT JOIN BIL_TARIFF_DETAILS D
                      ON C.ORGANIZATIONID = D.ORGANIZATIONID
                      AND C.TARIFFID = D.TARIFFID
                      AND D.CHARGECATEGORY = 'PAC_MAT'
                      AND D.CHARGETYPE = r_sku
                    LEFT JOIN BIL_TARIFF_RATE E
                      ON D.ORGANIZATIONID = E.ORGANIZATIONID
                      AND D.TARIFFID = E.TARIFFID
                      AND D.TARIFFLINENO = E.TARIFFLINENO
                  WHERE A.ORGANIZATIONID = IN_organizationId
                  AND A.WAREHOUSEID = IN_warehouseId
                  AND D.CHARGECATEGORY = 'PAC_MAT'
                  AND D.CHARGETYPE = r_sku
                  AND A.KITNO = IN_kitNo
                  AND A.KITSKU = r_kitsku
                  AND KS.SKU = r_sku
                  AND r_accessoryFlag = 'Y'
                  AND r_packMaterialFlag = 'Y'
                  AND E.RATE IS NOT NULL
                  AND IFNULL(C.tariffId, '*') <> '*'
                  AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
                  AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
              END IF;
            ELSE
              SELECT
                'NO KIT DETAILS FOUND' AS MESSAGE;
            END IF;
          END LOOP read_loop;
          CLOSE CUR_MAT;
          ##NORMAL KITTING PROCESS
          SELECT
            COUNT(1) INTO r_RNOW1
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFMASTERID = C.TARIFFMASTERID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
              AND D.RATEBASE = 'QUANTITY'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_kitNo
          AND D.CHARGECATEGORY = 'TR'
          AND D.CHARGETYPE = 'TRKT'
          AND D.RATEBASE = 'QUANTITY'
          AND D.CHARGETYPE IS NOT NULL
          AND IFNULL(C.tariffId, '*') <> '*'
          AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
          AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
          IF r_RNOW1 = 1 THEN
            CALL SPCOM_GetIDSequence(IN_organizationId,
            IN_warehouseId,
            IN_Language,
            'BILLINGSUMMARYID',
            R_BILLINGSUMMARYID1,
            OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              ROLLBACK;
              LEAVE ENDPROC;
            END IF;
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            SKU,
            QTY,
            UOM,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF03,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID1,
                DATE_FORMAT(A.EDITTIME, '%Y-%m-%d'),
                DATE_FORMAT(A.EDITTIME, '%Y-%m-%d'),
                A.CUSTOMERID,
                A.KITSKU,
                A.qtyKittedEach,
                'PIECES',
                B.TARIFFID,
                D.chargeCategory,
                D.ChargeType,
                D.DESCRC,
                D.RATEBASE,
                E.RATE,
                A.qtyKittedEach * E.Rate,
                A.qtyKittedEach * E.Rate,
                '*',
                '*',
                0,
                'KIT',
                A.KITNO,
                A.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                A.EDITTIME,
                NOW(),
                D.UDF01,
                D.UDF02,
                A.KITSKU,
                D.UDF06
              FROM DOC_KIT_DETAILS A
                LEFT JOIN DOC_KIT_HEADER A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.CUSTOMERID = A1.CUSTOMERID
                  AND A.WAREHOUSEID = A1.WAREHOUSEID
                  AND A.KITNO = A1.`kitNo`
                LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND A.KITSKU = B.SKU
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFMASTERID = C.TARIFFMASTERID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'TR'
                  AND D.CHARGETYPE = 'TRKT'
                  AND D.RATEBASE = 'QUANTITY'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
              AND A.WAREHOUSEID = IN_warehouseId
              AND A.KITNO = IN_KITNO
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
              AND D.RATEBASE = 'QUANTITY'
              AND IFNULL(C.tariffId, '*') <> '*'
              AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
              AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
            ;
          END IF;
          SELECT
            COUNT(1) INTO r_RNOW2
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFMASTERID = C.TARIFFMASTERID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'VA'
              AND D.CHARGETYPE = 'KT'
              AND D.RATEBASE = 'FLAT'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_kitNo
          AND D.CHARGECATEGORY = 'VA'
          AND D.CHARGETYPE = 'KT'
          AND D.RATEBASE = 'FLAT'
          AND D.CHARGETYPE IS NOT NULL
          AND IFNULL(C.tariffId, '*') <> '*'
          AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
          AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
          IF r_RNOW2 = 1 THEN
            CALL SPCOM_GetIDSequence(IN_organizationId,
            IN_warehouseId,
            IN_Language,
            'BILLINGSUMMARYID',
            R_BILLINGSUMMARYID2,
            OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              ROLLBACK;
              LEAVE ENDPROC;
            END IF;
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            SKU,
            QTY,
            UOM,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF03,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID2,
                DATE_FORMAT(A.EDITTIME, '%Y-%m-%d'),
                DATE_FORMAT(A.EDITTIME, '%Y-%m-%d'),
                A.CUSTOMERID,
                A.KITSKU,
                A.qtyKittedEach,
                'ORDER',
                B.TARIFFID,
                D.chargeCategory,
                D.ChargeType,
                D.DESCRC,
                D.rateBase,
                E.rate,
                E.rate,
                E.rate,
                '*',
                '*',
                0,
                'KIT',
                A.KITNO,
                A.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                A.EDITTIME,
                NOW(),
                D.UDF01,
                D.UDF02,
                A.KITSKU,
                D.UDF06
              FROM DOC_KIT_DETAILS A
                LEFT JOIN DOC_KIT_HEADER A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.CUSTOMERID = A1.CUSTOMERID
                  AND A.WAREHOUSEID = A1.WAREHOUSEID
                  AND A.KITNO = A1.`kitNo`
                LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND A.KITSKU = B.SKU
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFMASTERID = C.TARIFFMASTERID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'VA'
                  AND D.CHARGETYPE = 'KT'
                  AND D.RATEBASE = 'FLAT'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
              AND A.WAREHOUSEID = IN_warehouseId
              AND D.CHARGECATEGORY = 'VA'
              AND D.CHARGETYPE = 'KT'
              AND D.RATEBASE = 'FLAT'
              AND A.KITNO = IN_KITNO
              AND IFNULL(C.tariffId, '*') <> '*'
              AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
              AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
          END IF;
          SELECT
            COUNT(1) INTO r_RNOW3
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFMASTERID = C.TARIFFMASTERID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
              AND D.RATEBASE = 'FLAT'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_kitNo
          AND D.CHARGECATEGORY = 'TR'
          AND D.CHARGETYPE = 'TRKT'
          AND D.RATEBASE = 'FLAT'
          AND IFNULL(C.tariffId, '*') <> '*'
          AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
          AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
          IF r_RNOW3 = 1 THEN
            CALL SPCOM_GetIDSequence(IN_organizationId,
            IN_warehouseId,
            IN_Language,
            'BILLINGSUMMARYID',
            R_BILLINGSUMMARYID3,
            OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              ROLLBACK;
              LEAVE ENDPROC;
            END IF;
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            SKU,
            QTY,
            UOM,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF03,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID3,
                DATE_FORMAT(A.EDITTIME, '%Y-%m-%d'),
                DATE_FORMAT(A.EDITTIME, '%Y-%m-%d'),
                A.CUSTOMERID,
                A.KITSKU,
                A.qtyKittedEach,
                'ORDER',
                B.TARIFFID,
                D.chargeCategory,
                D.ChargeType,
                D.DESCRC,
                D.RATEBASE,
                E.RATE,
                E.rate,
                E.RATE,
                '*',
                '*',
                0,
                'KIT',
                A.KITNO,
                A.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                A.EDITTIME,
                NOW(),
                D.UDF01,
                D.UDF02,
                A.KITSKU,
                D.UDF06
              FROM DOC_KIT_DETAILS A
                LEFT JOIN DOC_KIT_HEADER A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.CUSTOMERID = A1.CUSTOMERID
                  AND A.WAREHOUSEID = A1.WAREHOUSEID
                  AND A.KITNO = A1.`kitNo`
                LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND A.KITSKU = B.SKU
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFMASTERID = C.TARIFFMASTERID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'TR'
                  AND D.CHARGETYPE = 'TRKT'
                  AND D.RATEBASE = 'FLAT'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_organizationId
              AND A.WAREHOUSEID = IN_warehouseId
              AND A.KITNO = IN_kitNo
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
              AND D.RATEBASE = 'FLAT'
              AND IFNULL(C.tariffId, '*') <> '*'
              AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
              AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
          END IF;
          -- ????
          UPDATE DOC_KIT_HEADER A
          SET A.udf01 = 'N'
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_kitNo;
          UPDATE BIL_SUMMARY A
          LEFT JOIN DOC_KIT_DETAILS A1
            ON A.`organizationId` = A1.`organizationId`
            AND A.`warehouseId` = A1.`warehouseId`
            AND A.docNo = A1.kitNo
            AND A.`docLineNo` = A1.`kitLineNo`
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.SKU = B.SKU
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFMASTERID = C.TARIFFMASTERID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = A.`chargeCategory`
            AND D.`chargeType` = A.`chargeType`
          SET A.udf01 = D.udf01,
              A.`udf02` = D.udf02,
              A.udf04 = D.udf06
          WHERE A.`organizationId` = IN_organizationId
          AND A.`warehouseId` = IN_warehouseId
          AND A.docNo = IN_kitNo
          AND D.chargeCategory = 'VA'
          AND D.chargeType = 'KIT';
        END;
      END LOOP read_kitno;
      CLOSE CUR_KITNO;
    END;
    DROP TEMPORARY TABLE IF EXISTS tmp_kitnolist;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_BIL_KIT_NOM_NEW`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BIL_KIT_NOM_NEW (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(100),
IN IN_kitNo varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_tariffId varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_lotatt11 varchar(10);
    DECLARE r_udf01 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_RNOW1 int;
    DECLARE r_RNOW2 int;
    DECLARE r_RNOW3 int;
    DECLARE r_RNOW4 int;
    DECLARE r_sku varchar(100);
    DECLARE r_vasDescr varchar(100);
    DECLARE r_kitsku varchar(100);
    DECLARE r_accessoryFlag varchar(100);
    DECLARE r_packMaterialFlag varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID1 varchar(100);
    DECLARE R_BILLINGSUMMARYID2 varchar(100);
    DECLARE R_BILLINGSUMMARYID3 varchar(100);
    DECLARE R_BILLINGSUMMARYID4 varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CUR_MAT CURSOR FOR
    SELECT
      A.kitSku,
      A.sku,
      A.`accessoryFlag`,
      B.packMaterialFlag
    FROM BAS_KIT_HEADER B
      LEFT JOIN BAS_KIT_DETAILS A
        ON B.`organizationId` = A.`organizationId`
        AND B.`customerId` = A.`customerId`
        AND B.`kitSku` = A.`kitSku`
        AND B.`versionNo` = A.`versionNo`
    WHERE A.organizationId = 'OJV_CML'
    AND B.customerId = IN_customerId;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    OPEN CUR_MAT;
  read_loop:
    LOOP
      FETCH CUR_MAT INTO r_kitsku,
      r_sku,
      r_accessoryFlag,
      r_packMaterialFlag;
      IF done THEN
        LEAVE read_loop;
      END IF;
      BEGIN
        GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
        @p2 = MESSAGE_TEXT,
        @p3 = MYSQL_ERRNO,
        @p4 = TABLE_NAME,
        @p5 = COLUMN_NAME;
        SELECT
          CONCAT('999#SPCUS_BIL_KIT_NOM_NEW,',
          IFNULL(@p1, ''),
          ',',
          IFNULL(@p2, ''),
          ',',
          IFNULL(@p3, ''),
          ',',
          IFNULL(@p4, ''),
          ',',
          IFNULL(@p5, '')) AS outcode;
        SELECT
          v_errormessage AS error;
      END;
      SET v_error = 1;
      IF OUT_returnCode = 'NO_COMMIT'
        OR OUT_returnCode = '*_*' THEN
        SET v_NO_COMMIT = 'N';
      ELSE
        SET v_NO_COMMIT = 'Y';
      END IF;
      SELECT
        COUNT(1)
      FROM DOC_KIT_DETAILS A
        LEFT JOIN DOC_KIT_HEADER B
          ON A.organizationId = B.organizationId
          AND A.warehouseId = B.warehouseId
          AND A.kitNo = B.kitNo
        LEFT JOIN ACT_TRANSACTION_LOG C
          ON B.organizationId = C.organizationId
          AND B.warehouseId = C.warehouseId
          AND B.kitNo = C.docNo
          AND A.lotNum = C.tolotNum
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId --  AND IFNULL(B.udf01, ' ') = ' ' 
      AND A.lotAtt11 IN (' ', NULL)
      AND A.lineStatus >= '40'
      AND A.KITNO = IN_kitNo INTO r_RNOW;
      SET IN_organizationId := 'OJV_CML';
      SET IN_Language = 'en';
      SELECT
        r_RNOW;
      IF r_RNOW > 0 THEN -- 
        SELECT
          COUNT(1) INTO r_RNOW4
        FROM DOC_KIT_SUBDETAILS KS
          LEFT JOIN DOC_KIT_DETAILS A
            ON KS.`organizationId` = A.`organizationId`
            AND KS.`warehouseId` = A.`warehouseId`
            AND KS.KITNO = A.`kitNo`
            AND KS.`kitLineNo` = A.`kitLineNo` --   AND KS.LOTNUM = A.LOTNUM 
          LEFT JOIN DOC_KIT_HEADER A1
            ON A.ORGANIZATIONID = A1.ORGANIZATIONID
            AND A.CUSTOMERID = A1.CUSTOMERID
            AND A.WAREHOUSEID = A1.WAREHOUSEID
            AND A.KITNO = A1.`kitNo`
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.KITSKU = B.SKU
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFMASTERID = C.TARIFFMASTERID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'PAC_MAT'
            AND D.CHARGETYPE = r_sku
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE KS.ORGANIZATIONID = 'OJV_CML'
        AND KS.WAREHOUSEID = IN_warehouseId
        AND KS.KITNO = IN_kitNo
        AND KS.SKU = r_sku
        AND r_accessoryFlag = 'Y'
        AND r_packMaterialFlag = 'Y'
        AND E.RATE IS NOT NULL
        AND IFNULL(C.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
        IF r_RNOW4 = 1 THEN
          CALL SPCOM_GetIDSequence(IN_organizationId,
          IN_warehouseId,
          IN_Language,
          'BILLINGSUMMARYID',
          R_BILLINGSUMMARYID4,
          OUT_returnCode);
          IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
          INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
          WAREHOUSEID,
          BILLINGSUMMARYID,
          BILLINGFROMDATE,
          BILLINGTODATE,
          CUSTOMERID,
          SKU,
          QTY,
          UOM,
          TARIFFID,
          CHARGECATEGORY,
          CHARGETYPE,
          DESCR,
          RATEBASE,
          chargeRate,
          AMOUNT,
          BILLINGAMOUNT,
          ARNO,
          APNO,
          COST,
          DOCTYPE,
          DOCNO,
          BILLTO,
          ADDWHO,
          EDITWHO,
          ADDTIME,
          EDITTIME,
          UDF01,
          UDF02,
          UDF03,
          UDF04)
            SELECT
              A.ORGANIZATIONID,
              A.WAREHOUSEID,
              R_BILLINGSUMMARYID4,
              CURDATE(),
              CURDATE(),
              A.CUSTOMERID,
              KS.SKU,
              KS.qtyKittedEach,
              'PIECES',
              C.TARIFFID,
              D.chargeCategory,
              D.ChargeType,
              D.descrC,
              D.RATEBASE,
              E.RATE,
              KS.qtyKittedEach * E.Rate,
              KS.qtyKittedEach * E.Rate,
              '*',
              '*',
              0,
              'KIT',
              A.KITNO,
              A.CUSTOMERID,
              'UDFTIMER',
              'UDFTIMER',
              NOW(),
              NOW(),
              D.UDF01,
              D.UDF02,
              A.KITSKU,
              D.UDF06
            FROM DOC_KIT_DETAILS A
              LEFT JOIN DOC_KIT_SUBDETAILS KS
                ON A.ORGANIZATIONID = KS.ORGANIZATIONID
                AND A.CUSTOMERID = KS.CUSTOMERID
                AND A.WAREHOUSEID = KS.WAREHOUSEID
                AND A.KITNO = KS.`kitNo`
                AND A.KITLINENO = KS.KITLINENO
              LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                ON A.ORGANIZATIONID = B.ORGANIZATIONID
                AND A.CUSTOMERID = B.CUSTOMERID
                AND A.WAREHOUSEID = B.WAREHOUSEID
                AND A.KITSKU = B.SKU
              LEFT JOIN BIL_TARIFF_HEADER C
                ON B.ORGANIZATIONID = C.ORGANIZATIONID
                AND B.TARIFFMASTERID = C.TARIFFMASTERID
              LEFT JOIN BIL_TARIFF_DETAILS D
                ON C.ORGANIZATIONID = D.ORGANIZATIONID
                AND C.TARIFFID = D.TARIFFID
                AND D.CHARGECATEGORY = 'PAC_MAT'
                AND D.CHARGETYPE = r_sku
              LEFT JOIN BIL_TARIFF_RATE E
                ON D.ORGANIZATIONID = E.ORGANIZATIONID
                AND D.TARIFFID = E.TARIFFID
                AND D.TARIFFLINENO = E.TARIFFLINENO
            WHERE A.ORGANIZATIONID = IN_organizationId
            AND A.WAREHOUSEID = IN_warehouseId
            AND D.CHARGECATEGORY = 'PAC_MAT'
            AND D.CHARGETYPE = r_sku
            AND A.KITNO = IN_kitNo
            AND A.KITSKU = r_kitsku
            AND KS.SKU = r_sku
            AND r_accessoryFlag = 'Y'
            AND r_packMaterialFlag = 'Y'
            AND E.RATE IS NOT NULL
            AND IFNULL(C.tariffId, '*') <> '*'
            AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
            AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
        END IF;
      END IF;
    END LOOP read_loop;
    CLOSE CUR_MAT;
    SELECT
      COUNT(1) INTO r_RNOW1
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER A1
        ON A.ORGANIZATIONID = A1.ORGANIZATIONID
        AND A.CUSTOMERID = A1.CUSTOMERID
        AND A.WAREHOUSEID = A1.WAREHOUSEID
        AND A.KITNO = A1.`kitNo`
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
        ON A.ORGANIZATIONID = B.ORGANIZATIONID
        AND A.CUSTOMERID = B.CUSTOMERID
        AND A.WAREHOUSEID = B.WAREHOUSEID
        AND A.KITSKU = B.SKU
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFMASTERID = C.TARIFFMASTERID
      LEFT JOIN BIL_TARIFF_DETAILS D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = 'TR'
        AND D.CHARGETYPE = 'TRKT'
        AND D.RATEBASE = 'QUANTITY'
      LEFT JOIN BIL_TARIFF_RATE E
        ON D.ORGANIZATIONID = E.ORGANIZATIONID
        AND D.TARIFFID = E.TARIFFID
        AND D.TARIFFLINENO = E.TARIFFLINENO
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.KITNO = IN_kitNo
    AND D.CHARGECATEGORY = 'TR'
    AND D.CHARGETYPE = 'TRKT'
    AND D.RATEBASE = 'QUANTITY'
    AND D.CHARGETYPE IS NOT NULL
    AND IFNULL(C.tariffId, '*') <> '*'
    AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    IF r_RNOW1 = 1 THEN
      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID1,
      OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
      WAREHOUSEID,
      BILLINGSUMMARYID,
      BILLINGFROMDATE,
      BILLINGTODATE,
      CUSTOMERID,
      SKU,
      QTY,
      UOM,
      TARIFFID,
      CHARGECATEGORY,
      CHARGETYPE,
      DESCR,
      RATEBASE,
      chargeRate,
      AMOUNT,
      BILLINGAMOUNT,
      ARNO,
      APNO,
      COST,
      DOCTYPE,
      DOCNO,
      BILLTO,
      ADDWHO,
      EDITWHO,
      ADDTIME,
      EDITTIME,
      UDF01,
      UDF02,
      UDF03,
      UDF04)
        SELECT
          A.ORGANIZATIONID,
          A.WAREHOUSEID,
          R_BILLINGSUMMARYID1,
          CURDATE(),
          CURDATE(),
          A.CUSTOMERID,
          A.KITSKU,
          A.qtyKittedEach,
          'PIECES',
          C.TARIFFID,
          D.chargeCategory,
          D.ChargeType,
          D.DESCRC,
          D.RATEBASE,
          E.RATE,
          A.qtyKittedEach * E.Rate,
          A.qtyKittedEach * E.Rate,
          '*',
          '*',
          0,
          'KIT',
          A.KITNO,
          A.CUSTOMERID,
          'UDFTIMER',
          'UDFTIMER',
          NOW(),
          NOW(),
          D.UDF01,
          D.UDF02,
          A.KITSKU,
          D.UDF06
        FROM DOC_KIT_DETAILS A
          LEFT JOIN DOC_KIT_HEADER A1
            ON A.ORGANIZATIONID = A1.ORGANIZATIONID
            AND A.CUSTOMERID = A1.CUSTOMERID
            AND A.WAREHOUSEID = A1.WAREHOUSEID
            AND A.KITNO = A1.`kitNo`
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.KITSKU = B.SKU
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFMASTERID = C.TARIFFMASTERID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'TR'
            AND D.CHARGETYPE = 'TRKT'
            AND D.RATEBASE = 'QUANTITY'
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
        AND A.WAREHOUSEID = IN_warehouseId
        AND A.KITNO = IN_KITNO
        AND D.CHARGECATEGORY = 'TR'
        AND D.CHARGETYPE = 'TRKT'
        AND D.RATEBASE = 'QUANTITY'
        AND IFNULL(C.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    END IF;
    SELECT
      COUNT(1) INTO r_RNOW2
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER A1
        ON A.ORGANIZATIONID = A1.ORGANIZATIONID
        AND A.CUSTOMERID = A1.CUSTOMERID
        AND A.WAREHOUSEID = A1.WAREHOUSEID
        AND A.KITNO = A1.`kitNo`
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
        ON A.ORGANIZATIONID = B.ORGANIZATIONID
        AND A.CUSTOMERID = B.CUSTOMERID
        AND A.WAREHOUSEID = B.WAREHOUSEID
        AND A.KITSKU = B.SKU
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFMASTERID = C.TARIFFMASTERID
      LEFT JOIN BIL_TARIFF_DETAILS D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = 'VA'
        AND D.CHARGETYPE = 'KT'
        AND D.RATEBASE = 'FLAT'
      LEFT JOIN BIL_TARIFF_RATE E
        ON D.ORGANIZATIONID = E.ORGANIZATIONID
        AND D.TARIFFID = E.TARIFFID
        AND D.TARIFFLINENO = E.TARIFFLINENO
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.KITNO = IN_kitNo
    AND D.CHARGECATEGORY = 'VA'
    AND D.CHARGETYPE = 'KT'
    AND D.RATEBASE = 'FLAT'
    AND D.CHARGETYPE IS NOT NULL
    AND IFNULL(C.tariffId, '*') <> '*'
    AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    IF r_RNOW2 = 1 THEN
      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID2,
      OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
      WAREHOUSEID,
      BILLINGSUMMARYID,
      BILLINGFROMDATE,
      BILLINGTODATE,
      CUSTOMERID,
      SKU,
      QTY,
      UOM,
      TARIFFID,
      CHARGECATEGORY,
      CHARGETYPE,
      DESCR,
      RATEBASE,
      chargeRate,
      AMOUNT,
      BILLINGAMOUNT,
      ARNO,
      APNO,
      COST,
      DOCTYPE,
      DOCNO,
      BILLTO,
      ADDWHO,
      EDITWHO,
      ADDTIME,
      EDITTIME,
      UDF01,
      UDF02,
      UDF03,
      UDF04)
        SELECT
          A.ORGANIZATIONID,
          A.WAREHOUSEID,
          R_BILLINGSUMMARYID2,
          CURDATE(),
          CURDATE(),
          A.CUSTOMERID,
          A.KITSKU,
          A.qtyKittedEach,
          'ORDER',
          C.TARIFFID,
          D.chargeCategory,
          D.ChargeType,
          D.DESCRC,
          D.rateBase,
          E.rate,
          E.rate,
          E.rate,
          '*',
          '*',
          0,
          'KIT',
          A.KITNO,
          A.CUSTOMERID,
          'UDFTIMER',
          'UDFTIMER',
          NOW(),
          NOW(),
          D.UDF01,
          D.UDF02,
          A.KITSKU,
          D.UDF06
        FROM DOC_KIT_DETAILS A
          LEFT JOIN DOC_KIT_HEADER A1
            ON A.ORGANIZATIONID = A1.ORGANIZATIONID
            AND A.CUSTOMERID = A1.CUSTOMERID
            AND A.WAREHOUSEID = A1.WAREHOUSEID
            AND A.KITNO = A1.`kitNo`
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.KITSKU = B.SKU
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFMASTERID = C.TARIFFMASTERID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'VA'
            AND D.CHARGETYPE = 'KT'
            AND D.RATEBASE = 'FLAT'
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
        AND A.WAREHOUSEID = IN_warehouseId
        AND D.CHARGECATEGORY = 'VA'
        AND D.CHARGETYPE = 'KT'
        AND D.RATEBASE = 'FLAT'
        AND A.KITNO = IN_KITNO
        AND IFNULL(C.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    END IF;
    SELECT
      COUNT(1) INTO r_RNOW3
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER A1
        ON A.ORGANIZATIONID = A1.ORGANIZATIONID
        AND A.CUSTOMERID = A1.CUSTOMERID
        AND A.WAREHOUSEID = A1.WAREHOUSEID
        AND A.KITNO = A1.`kitNo`
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
        ON A.ORGANIZATIONID = B.ORGANIZATIONID
        AND A.CUSTOMERID = B.CUSTOMERID
        AND A.WAREHOUSEID = B.WAREHOUSEID
        AND A.KITSKU = B.SKU
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFMASTERID = C.TARIFFMASTERID
      LEFT JOIN BIL_TARIFF_DETAILS D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = 'TR'
        AND D.CHARGETYPE = 'TRKT'
        AND D.RATEBASE = 'FLAT'
      LEFT JOIN BIL_TARIFF_RATE E
        ON D.ORGANIZATIONID = E.ORGANIZATIONID
        AND D.TARIFFID = E.TARIFFID
        AND D.TARIFFLINENO = E.TARIFFLINENO
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.KITNO = IN_kitNo
    AND D.CHARGECATEGORY = 'TR'
    AND D.CHARGETYPE = 'TRKT'
    AND D.RATEBASE = 'FLAT'
    AND IFNULL(C.tariffId, '*') <> '*'
    AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    IF r_RNOW3 = 1 THEN
      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID3,
      OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
      WAREHOUSEID,
      BILLINGSUMMARYID,
      BILLINGFROMDATE,
      BILLINGTODATE,
      CUSTOMERID,
      SKU,
      QTY,
      UOM,
      TARIFFID,
      CHARGECATEGORY,
      CHARGETYPE,
      DESCR,
      RATEBASE,
      chargeRate,
      AMOUNT,
      BILLINGAMOUNT,
      ARNO,
      APNO,
      COST,
      DOCTYPE,
      DOCNO,
      BILLTO,
      ADDWHO,
      EDITWHO,
      ADDTIME,
      EDITTIME,
      UDF01,
      UDF02,
      UDF03,
      UDF04)
        SELECT
          A.ORGANIZATIONID,
          A.WAREHOUSEID,
          R_BILLINGSUMMARYID3,
          CURDATE(),
          CURDATE(),
          A.CUSTOMERID,
          A.KITSKU,
          A.qtyKittedEach,
          'ORDER',
          C.TARIFFID,
          D.chargeCategory,
          D.ChargeType,
          D.DESCRC,
          D.RATEBASE,
          E.RATE,
          E.rate,
          E.RATE,
          '*',
          '*',
          0,
          'KIT',
          A.KITNO,
          A.CUSTOMERID,
          'UDFTIMER',
          'UDFTIMER',
          NOW(),
          NOW(),
          D.UDF01,
          D.UDF02,
          A.KITSKU,
          D.UDF06
        FROM DOC_KIT_DETAILS A
          LEFT JOIN DOC_KIT_HEADER A1
            ON A.ORGANIZATIONID = A1.ORGANIZATIONID
            AND A.CUSTOMERID = A1.CUSTOMERID
            AND A.WAREHOUSEID = A1.WAREHOUSEID
            AND A.KITNO = A1.`kitNo`
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.KITSKU = B.SKU
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFMASTERID = C.TARIFFMASTERID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'TR'
            AND D.CHARGETYPE = 'TRKT'
            AND D.RATEBASE = 'FLAT'
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_organizationId
        AND A.WAREHOUSEID = IN_warehouseId
        AND A.KITNO = IN_kitNo
        AND D.CHARGECATEGORY = 'TR'
        AND D.CHARGETYPE = 'TRKT'
        AND D.RATEBASE = 'FLAT'
        AND IFNULL(C.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    END IF;
    UPDATE DOC_KIT_HEADER A
    SET A.udf01 = 'N'
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.KITNO = IN_kitNo;
    UPDATE BIL_SUMMARY A
    LEFT JOIN DOC_KIT_DETAILS A1
      ON A.`organizationId` = A1.`organizationId`
      AND A.`warehouseId` = A1.`warehouseId`
      AND A.docNo = A1.kitNo
      AND A.`docLineNo` = A1.`kitLineNo`
    LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
      ON A.ORGANIZATIONID = B.ORGANIZATIONID
      AND A.CUSTOMERID = B.CUSTOMERID
      AND A.WAREHOUSEID = B.WAREHOUSEID
      AND A.SKU = B.SKU
    LEFT JOIN BIL_TARIFF_HEADER C
      ON B.ORGANIZATIONID = C.ORGANIZATIONID
      AND B.TARIFFMASTERID = C.TARIFFMASTERID
    LEFT JOIN BIL_TARIFF_DETAILS D
      ON C.ORGANIZATIONID = D.ORGANIZATIONID
      AND C.TARIFFID = D.TARIFFID
      AND D.CHARGECATEGORY = A.`chargeCategory`
      AND D.`chargeType` = A.`chargeType`
    SET A.udf01 = D.udf01,
        A.`udf02` = D.udf02,
        A.udf04 = D.udf06
    WHERE A.`organizationId` = IN_organizationId
    AND A.`warehouseId` = IN_warehouseId
    AND A.docNo = IN_kitNo
    AND D.chargeCategory = 'VA'
    AND D.chargeType = 'KIT';
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_BIL_KIT_NOM`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BIL_KIT_NOM (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(100),
IN IN_kitNo varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_tariffId varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_lotatt11 varchar(10);
    DECLARE r_udf01 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_sku varchar(100);
    DECLARE r_qtyKit int;
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE done int DEFAULT FALSE;

    DECLARE CUR_KIT CURSOR FOR
    SELECT
      A.kitNo,
      A.customerId,
      B.orderNo,
      A.kitSku,
      A.qtyKittedEach,
      A.lotAtt11,
      B.udf01
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER B
        ON A.organizationId = B.organizationId
        AND A.warehouseId = B.warehouseId
        AND A.kitNo = B.kitNo
      LEFT JOIN ACT_TRANSACTION_LOG C
        ON B.organizationId = C.organizationId
        AND B.warehouseId = C.warehouseId
        AND B.kitNo = C.docNo
        AND A.lotNum = C.tolotNum
    WHERE A.organizationId = IN_organizationId
    AND A.warehouseId = IN_warehouseId
    AND IFNULL(B.udf01, ' ') = ' '
    AND A.lotAtt11 IN (' ', NULL)
    AND A.lineStatus >= '40';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';
    OPEN CUR_KIT;
  read_loop:
    LOOP
      FETCH CUR_KIT INTO IN_kitNo,
      IN_customerId,
      r_docNo,
      r_sku,
      r_qtyKit,
      r_lotatt11, r_udf01;
      IF done THEN
        LEAVE read_loop;
      END IF;


      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID,
      OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      IF r_lotatt11 IN (' ', 'N') THEN
        SELECT
          COUNT(1) INTO r_RNOW
        FROM DOC_KIT_DETAILS A
          LEFT JOIN DOC_KIT_HEADER A1
            ON A.ORGANIZATIONID = A1.ORGANIZATIONID
            AND A.CUSTOMERID = A1.CUSTOMERID
            AND A.WAREHOUSEID = A1.WAREHOUSEID
            AND A.KITNO = A1.`kitNo`
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.KITSKU = B.SKU
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFID = C.TARIFFID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'TR'
            AND D.CHARGETYPE = 'TRKT'
            AND D.RATEBASE = 'QUANTITY'
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_organizationId
        AND A.WAREHOUSEID = IN_warehouseId
        AND A.lotAtt11 IN (' ', NULL)
        AND A.KITNO = IN_kitNo
        AND D.CHARGETYPE IS NOT NULL;
        IF r_RNOW = 1
          AND r_udf01 <> 'N' THEN
          INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
          WAREHOUSEID,
          BILLINGSUMMARYID,
          BILLINGFROMDATE,
          BILLINGTODATE,
          CUSTOMERID,
          SKU,
          QTY,
          UOM,
          TARIFFID,
          CHARGECATEGORY,
          CHARGETYPE,
          DESCR,
          RATEBASE,
          chargeRate,
          AMOUNT,
          BILLINGAMOUNT,
          ARNO,
          COST,
          DOCTYPE,
          DOCNO,
          BILLTO,
          ADDWHO,
          EDITWHO,
          ADDTIME,
          EDITTIME)
            SELECT
              A.ORGANIZATIONID,
              A.WAREHOUSEID,
              R_BILLINGSUMMARYID,
              CURDATE(),
              CURDATE(),
              A.CUSTOMERID,
              A.KITSKU,
              A.qtyKittedEach,
              'PIECES',
              B.TARIFFID,
              D.chargeCategory,
              D.ChargeType,
              D.DESCRC,
              D.RATEBASE,
              E.RATE,
              A.qtyKittedEach * E.Rate,
              A.qtyKittedEach * E.Rate,
              '*',
              0,
              'KIT',
              A.KITNO,
              A.CUSTOMERID,
              'UDFTIMER',
              'UDFTIMER',
              NOW(),
              NOW()
            FROM DOC_KIT_DETAILS A
              LEFT JOIN DOC_KIT_HEADER A1
                ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                AND A.CUSTOMERID = A1.CUSTOMERID
                AND A.WAREHOUSEID = A1.WAREHOUSEID
                AND A.KITNO = A1.`kitNo`
              LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                ON A.ORGANIZATIONID = B.ORGANIZATIONID
                AND A.CUSTOMERID = B.CUSTOMERID
                AND A.WAREHOUSEID = B.WAREHOUSEID
                AND A.KITSKU = B.SKU
              LEFT JOIN BIL_TARIFF_HEADER C
                ON B.ORGANIZATIONID = C.ORGANIZATIONID
                AND B.TARIFFID = C.TARIFFID
              LEFT JOIN BIL_TARIFF_DETAILS D
                ON C.ORGANIZATIONID = D.ORGANIZATIONID
                AND C.TARIFFID = D.TARIFFID
                AND D.CHARGECATEGORY = 'TR'
                AND D.CHARGETYPE = 'TRKT'
                AND D.RATEBASE = 'QUANTITY'
              LEFT JOIN BIL_TARIFF_RATE E
                ON D.ORGANIZATIONID = E.ORGANIZATIONID
                AND D.TARIFFID = E.TARIFFID
                AND D.TARIFFLINENO = E.TARIFFLINENO
            WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
            AND A.WAREHOUSEID = IN_warehouseId
            AND A.KITNO = IN_KITNO;
        END IF;
      END IF;


      UPDATE DOC_KIT_HEADER A
      SET A.udf01 = 'N'
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.KITNO = IN_kitNo
      AND r_lotatt11 IN (' ', 'N');
    END LOOP;
    CLOSE CUR_KIT;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_BIL_KIT_MANUAL`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BIL_KIT_MANUAL (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(100),
IN IN_kitNo varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_tariffId varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_lotatt11 varchar(10);
    DECLARE r_udf01 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_RNOW1 int;
    DECLARE r_RNOW2 int;
    DECLARE r_RNOW3 int;
    DECLARE r_RNOW4 int;
    DECLARE r_sku varchar(100);
    DECLARE r_vasDescr varchar(100);
    DECLARE r_kitsku varchar(100);
    DECLARE r_accessoryFlag varchar(100);
    DECLARE r_packMaterialFlag varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID1 varchar(100);
    DECLARE R_BILLINGSUMMARYID2 varchar(100);
    DECLARE R_BILLINGSUMMARYID3 varchar(100);
    DECLARE R_BILLINGSUMMARYID4 varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CUR_MAT CURSOR FOR
    SELECT
      A.kitSku,
      A.sku,
      A.`accessoryFlag`,
      B.packMaterialFlag
    FROM BAS_KIT_HEADER B
      LEFT JOIN BAS_KIT_DETAILS A
        ON B.`organizationId` = A.`organizationId`
        AND B.`customerId` = A.`customerId`
        AND B.`kitSku` = A.`kitSku`
        AND B.`versionNo` = A.`versionNo`
    WHERE A.organizationId = 'OJV_CML'
    AND B.customerId = IN_customerId;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    -- delete the existing records.
    DELETE
      FROM `BIL_SUMMARY`
    WHERE `organizationid` = 'OJV_CML'
      AND `warehouseid` = 'CBT01'
      AND DOCNO = IN_kitNo;
    OPEN CUR_MAT;
  read_loop:
    LOOP
      FETCH CUR_MAT INTO r_kitsku,
      r_sku,
      r_accessoryFlag,
      r_packMaterialFlag;
      IF done THEN
        LEAVE read_loop;
      END IF;
      BEGIN
        GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
        @p2 = MESSAGE_TEXT,
        @p3 = MYSQL_ERRNO,
        @p4 = TABLE_NAME,
        @p5 = COLUMN_NAME;
        SELECT
          CONCAT('999#SPCUS_BIL_KIT_NOM_NEW,',
          IFNULL(@p1, ''),
          ',',
          IFNULL(@p2, ''),
          ',',
          IFNULL(@p3, ''),
          ',',
          IFNULL(@p4, ''),
          ',',
          IFNULL(@p5, '')) AS outcode;
        SELECT
          v_errormessage AS error;
      END;
      SET v_error = 1;
      IF OUT_returnCode = 'NO_COMMIT'
        OR OUT_returnCode = '*_*' THEN
        SET v_NO_COMMIT = 'N';
      ELSE
        SET v_NO_COMMIT = 'Y';
      END IF;
      -- Recalculate the charges      
      SELECT
        COUNT(1)
      FROM DOC_KIT_DETAILS A
        LEFT JOIN DOC_KIT_HEADER B
          ON A.organizationId = B.organizationId
          AND A.warehouseId = B.warehouseId
          AND A.kitNo = B.kitNo
        LEFT JOIN ACT_TRANSACTION_LOG C
          ON B.organizationId = C.organizationId
          AND B.warehouseId = C.warehouseId
          AND B.kitNo = C.docNo
          AND A.lotNum = C.tolotNum
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.lotAtt11 IN (' ', NULL)
      AND A.lineStatus = '99'
      AND A.KITNO = IN_kitNo INTO r_RNOW;
      SET IN_organizationId := 'OJV_CML';
      SET IN_Language = 'en';
      SELECT
        r_RNOW;
      IF r_RNOW = 1 THEN -- 
        SELECT
          COUNT(1) INTO r_RNOW4
        FROM DOC_KIT_SUBDETAILS KS
          LEFT JOIN DOC_KIT_DETAILS A
            ON KS.`organizationId` = A.`organizationId`
            AND KS.`warehouseId` = A.`warehouseId`
            AND KS.KITNO = A.`kitNo`
            AND KS.`kitLineNo` = A.`kitLineNo`
          LEFT JOIN DOC_KIT_HEADER A1
            ON A.ORGANIZATIONID = A1.ORGANIZATIONID
            AND A.CUSTOMERID = A1.CUSTOMERID
            AND A.WAREHOUSEID = A1.WAREHOUSEID
            AND A.KITNO = A1.`kitNo`
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.KITSKU = B.SKU
        WHERE KS.ORGANIZATIONID = 'OJV_CML'
        AND KS.WAREHOUSEID = IN_warehouseId
        AND KS.KITNO = IN_kitNo
        AND KS.SKU = r_sku
        AND r_accessoryFlag = 'Y'
        AND r_packMaterialFlag = 'Y';
        SELECT
          r_RNOW4;
        IF r_RNOW4 = 1 THEN
          CALL SPCOM_GetIDSequence(IN_organizationId,
          IN_warehouseId,
          IN_Language,
          'BILLINGSUMMARYID',
          R_BILLINGSUMMARYID4,
          OUT_returnCode);
          IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
          INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
          WAREHOUSEID,
          BILLINGSUMMARYID,
          BILLINGFROMDATE,
          BILLINGTODATE,
          CUSTOMERID,
          SKU,
          QTY,
          UOM,
          TARIFFID,
          CHARGECATEGORY,
          CHARGETYPE,
          DESCR,
          RATEBASE,
          chargeRate,
          AMOUNT,
          BILLINGAMOUNT,
          ARNO,
          APNO,
          COST,
          DOCTYPE,
          DOCNO,
          BILLTO,
          ADDWHO,
          EDITWHO,
          ADDTIME,
          EDITTIME,
          UDF01,
          UDF02,
          UDF03,
          UDF04)
            SELECT
              A.ORGANIZATIONID,
              A.WAREHOUSEID,
              R_BILLINGSUMMARYID4,
              CURDATE(),
              CURDATE(),
              A.CUSTOMERID,
              KS.SKU,
              KS.qtyKittedEach,
              'PIECES',
              C.TARIFFID,
              D.chargeCategory,
              D.ChargeType,
              D.descrC,
              D.RATEBASE,
              E.RATE,
              KS.qtyKittedEach * E.Rate,
              KS.qtyKittedEach * E.Rate,
              '*',
              '*',
              0,
              'KIT',
              A.KITNO,
              A.CUSTOMERID,
              'UDFTIMER',
              'UDFTIMER',
              NOW(),
              NOW(),
              D.UDF01,
              D.UDF02,
              A.KITSKU,
              D.UDF06
            FROM DOC_KIT_DETAILS A
              LEFT JOIN DOC_KIT_SUBDETAILS KS
                ON A.ORGANIZATIONID = KS.ORGANIZATIONID
                AND A.CUSTOMERID = KS.CUSTOMERID
                AND A.WAREHOUSEID = KS.WAREHOUSEID
                AND A.KITNO = KS.`kitNo`
                AND A.KITLINENO = KS.KITLINENO
              LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                ON A.ORGANIZATIONID = B.ORGANIZATIONID
                AND A.CUSTOMERID = B.CUSTOMERID
                AND A.WAREHOUSEID = B.WAREHOUSEID
                AND A.KITSKU = B.SKU
              LEFT JOIN BIL_TARIFF_HEADER C
                ON B.ORGANIZATIONID = C.ORGANIZATIONID
                AND B.TARIFFMASTERID = C.TARIFFMASTERID
              LEFT JOIN BIL_TARIFF_DETAILS D
                ON C.ORGANIZATIONID = D.ORGANIZATIONID
                AND C.TARIFFID = D.TARIFFID
                AND D.CHARGECATEGORY = 'PAC_MAT'
                AND D.CHARGETYPE = r_sku
              LEFT JOIN BIL_TARIFF_RATE E
                ON D.ORGANIZATIONID = E.ORGANIZATIONID
                AND D.TARIFFID = E.TARIFFID
                AND D.TARIFFLINENO = E.TARIFFLINENO
            WHERE A.ORGANIZATIONID = IN_organizationId
            AND A.WAREHOUSEID = IN_warehouseId
            AND D.CHARGECATEGORY = 'PAC_MAT'
            AND D.CHARGETYPE = r_sku
            AND A.KITNO = IN_kitNo
            AND A.KITSKU = r_kitsku
            AND KS.SKU = r_sku
            AND r_accessoryFlag = 'Y'
            AND r_packMaterialFlag = 'Y'
            AND E.RATE IS NOT NULL
            AND IFNULL(C.tariffId, '*') <> '*'
            AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
            AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
        END IF;
      END IF;
    END LOOP read_loop;
    CLOSE CUR_MAT;
    SELECT
      COUNT(1) INTO r_RNOW1
    FROM DOC_KIT_DETAILS A
      LEFT JOIN DOC_KIT_HEADER A1
        ON A.ORGANIZATIONID = A1.ORGANIZATIONID
        AND A.CUSTOMERID = A1.CUSTOMERID
        AND A.WAREHOUSEID = A1.WAREHOUSEID
        AND A.KITNO = A1.`kitNo`
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
        ON A.ORGANIZATIONID = B.ORGANIZATIONID
        AND A.CUSTOMERID = B.CUSTOMERID
        AND A.WAREHOUSEID = B.WAREHOUSEID
        AND A.KITSKU = B.SKU
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFMASTERID = C.TARIFFMASTERID
      LEFT JOIN BIL_TARIFF_DETAILS D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = 'TR'
        AND D.CHARGETYPE = 'TRKT'
        AND D.RATEBASE = 'QUANTITY'
      LEFT JOIN BIL_TARIFF_RATE E
        ON D.ORGANIZATIONID = E.ORGANIZATIONID
        AND D.TARIFFID = E.TARIFFID
        AND D.TARIFFLINENO = E.TARIFFLINENO
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.KITNO = IN_kitNo
    AND D.CHARGECATEGORY = 'TR'
    AND D.CHARGETYPE = 'TRKT'
    AND D.RATEBASE = 'QUANTITY'
    AND D.CHARGETYPE IS NOT NULL
    AND IFNULL(C.tariffId, '*') <> '*'
    AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    IF r_RNOW1 = 1 THEN
      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID1,
      OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
      WAREHOUSEID,
      BILLINGSUMMARYID,
      BILLINGFROMDATE,
      BILLINGTODATE,
      CUSTOMERID,
      SKU,
      QTY,
      UOM,
      TARIFFID,
      CHARGECATEGORY,
      CHARGETYPE,
      DESCR,
      RATEBASE,
      chargeRate,
      AMOUNT,
      BILLINGAMOUNT,
      ARNO,
      APNO,
      COST,
      DOCTYPE,
      DOCNO,
      BILLTO,
      ADDWHO,
      EDITWHO,
      ADDTIME,
      EDITTIME,
      UDF01,
      UDF02)
        SELECT
          A.ORGANIZATIONID,
          A.WAREHOUSEID,
          R_BILLINGSUMMARYID1,
          CURDATE(),
          CURDATE(),
          A.CUSTOMERID,
          A.KITSKU,
          A.qtyKittedEach,
          'PIECES',
          C.TARIFFID,
          D.chargeCategory,
          D.ChargeType,
          D.DESCRC,
          D.RATEBASE,
          E.RATE,
          A.qtyKittedEach * E.Rate,
          A.qtyKittedEach * E.Rate,
          '*',
          '*',
          0,
          'KIT',
          A.KITNO,
          A.CUSTOMERID,
          'UDFTIMER',
          'UDFTIMER',
          NOW(),
          NOW(),
          D.UDF01,
          D.UDF02
        FROM DOC_KIT_DETAILS A
          LEFT JOIN DOC_KIT_HEADER A1
            ON A.ORGANIZATIONID = A1.ORGANIZATIONID
            AND A.CUSTOMERID = A1.CUSTOMERID
            AND A.WAREHOUSEID = A1.WAREHOUSEID
            AND A.KITNO = A1.`kitNo`
          LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND A.KITSKU = B.SKU
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFMASTERID = C.TARIFFMASTERID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'TR'
            AND D.CHARGETYPE = 'TRKT'
            AND D.RATEBASE = 'QUANTITY'
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
        AND A.WAREHOUSEID = IN_warehouseId
        AND A.KITNO = IN_KITNO
        AND D.CHARGECATEGORY = 'TR'
        AND D.CHARGETYPE = 'TRKT'
        AND D.RATEBASE = 'QUANTITY'
        AND IFNULL(C.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    END IF;
    UPDATE DOC_KIT_HEADER A
    SET A.udf01 = 'N'
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.KITNO = IN_kitNo;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_BILLING_KITTING`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BILLING_KITTING (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_orderNo varchar(30),
IN IN_user varchar(20),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_qty,
          v_unitprice,
          v_rate,
          v_cubic,
          v_grosswt,
          v_price float;
  DECLARE v_sku,
          v_lot,
          v_trace,
          v_cust,
          v_tariffid,
          v_uom,
          v_vastyp,
          v_billsumaryid varchar(30);
  DECLARE finished integer DEFAULT 0;
  DECLARE bil_tariff_rec CURSOR FOR
  SELECT
    d.tariffid,
    r.rateperUnit * rate,
    r.rate,
    aad.sku,
    aad.lotnum,
    aad.traceid,
    aad.customerId,
    aad.uom,
    aad.qty,
    aad.cubic,
    aad.grossWeight,
    aad.price,
    dov.vastype
  FROM BIL_TARIFF_DETAILS d
    INNER JOIN BIL_TARIFF_RATE r
      ON d.ORGANIZATIONID = r.ORGANIZATIONID
      AND d.WAREHOUSEID = r.warehouseId
      AND d.tariffID = r.tariffid
      AND d.TariffLineNo = r.TariffLineNo
    INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
      ON d.ORGANIZATIONID = bsm.ORGANIZATIONID
      AND d.WAREHOUSEID = bsm.warehouseId
      AND d.tariffId = bsm.tariffId
    INNER JOIN ACT_ALLOCATION_DETAILS aad
      ON aad.ORGANIZATIONID = bsm.ORGANIZATIONID
      AND aad.WAREHOUSEID = bsm.warehouseId
      AND aad.sku = bsm.sku
    INNER JOIN DOC_ORDER_VAS dov
      ON aad.ORGANIZATIONID = dov.ORGANIZATIONID
      AND aad.WAREHOUSEID = dov.warehouseId
      AND aad.orderNo = dov.orderNo
  WHERE d.ORGANIZATIONID = IN_organizationId
  AND d.WAREHOUSEID = IN_warehouseId
  AND dov.orderNo = IN_orderNo
  AND d.chargecategory = 'VA'
  AND d.chargeType = 'KT'
  AND aad.uom = 'EA';
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
  SELECT
    qtyorderedeach INTO v_qty
  FROM DOC_KIT_header h
    JOIN doc_kit_details d
      ON h.kitno = d.kitno
  WHERE h.orderNo = IN_orderno;
  INSERT INTO DOC_ORDER_VAS (organizationId,
  warehouseId,
  orderno,
  orderlineno,
  vastype,
  vasqty,
  ADDTIME,
  addwho,
  editwho,
  edittime)
    VALUES (IN_organizationId, IN_warehouseId, IN_orderNo, 1, 'GLV', v_qty, NOW(), IN_user, IN_user, NOW()),
    (IN_organizationId, IN_warehouseId, IN_orderNo, 2, 'PP', v_qty, NOW(), IN_user, IN_user, NOW());
  OPEN bil_tariff_rec;
get_tariff_data:
  LOOP
    FETCH bil_tariff_rec INTO v_tariffid,
    v_unitprice,
    v_rate,
    v_sku,
    v_lot,
    v_trace,
    v_cust,
    v_uom,
    v_qty,
    v_cubic,
    v_grosswt,
    v_price,
    v_vastyp;
    IF finished = 1 THEN
      LEAVE get_tariff_data;
    ELSE
      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      'BILLINGSUMMARYID',
      v_billsumaryid,
      OUT_returnCode);
      INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
      WAREHOUSEID,
      billingsummaryid,
      billingFromDate,
      billingtoDate,
      customerId,
      sku,
      lotNum,
      traceId,
      tariffId,
      descr,
      chargeCategory,
      chargeType,
      chargePerUnits,
      qty,
      chargeRate,
      docType,
      docNo,
      uom,
      cubic,
      weight,
      addWho,
      addTime,
      editWho,
      editTime,
      udf01)
        VALUES (IN_organizationId, IN_warehouseId, v_billsumaryid, CURDATE(), CURDATE(), v_cust, v_sku, v_lot, v_trace, v_tariffid, v_vastyp, 'VA', 'KT', v_unitprice, v_qty, v_rate, 'SO', IN_orderNo, v_uom, v_cubic, v_grosswt, IN_user, NOW(), IN_user, NOW(), v_vastyp);
    END IF;
  END LOOP get_tariff_data;
  CLOSE bil_tariff_rec;
  SET OUT_returnCode := '000';
END
$$

--
-- Create procedure `recal_kitting`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE recal_kitting ()
BEGIN
  DECLARE IN_organizationId varchar(30);
  DECLARE IN_warehouseId varchar(30);
  DECLARE IN_KitNolist varchar(20000);
  DECLARE IN_userId varchar(20);
  DECLARE OUT_returnCode varchar(1000);
  SET IN_organizationId = 'OJV_CML';
  SET IN_warehouseId = 'CBT01';
  SET IN_KitNolist = 'SP4411599';
  SET OUT_returnCode = '';
ENDPROC:
  BEGIN
    DECLARE IN_kitNo varchar(30);
    DECLARE IN_CUSTOMERID varchar(100);
    DECLARE r_tariffId varchar(100);
    DECLARE r_docNo varchar(100);
    DECLARE r_lotatt11 varchar(10);
    DECLARE r_udf01 varchar(10);
    DECLARE r_RNOW int;
    DECLARE r_RNOW1 int;
    DECLARE r_RNOW2 int;
    DECLARE r_RNOW3 int;
    DECLARE r_RNOW4 int;
    DECLARE r_sku varchar(100);
    DECLARE r_vasDescr varchar(100);
    DECLARE r_kitsku varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID1 varchar(100);
    DECLARE R_BILLINGSUMMARYID2 varchar(100);
    DECLARE R_BILLINGSUMMARYID3 varchar(100);
    DECLARE R_BILLINGSUMMARYID4 varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE kit_done int DEFAULT FALSE;
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';

    DROP TEMPORARY TABLE IF EXISTS tmp_kitnolist;
    CREATE TEMPORARY TABLE tmp_kitnolist (
      kitno varchar(30)
    );
    IF (IFNULL(IN_KitNolist, '') != '') THEN
      SET @sql := CONCAT('Insert into tmp_kitnolist select docNo from BIL_SUMMARY WHERE billingSummaryid in (''', REPLACE(IN_KitNolist, ',', ''','''), ''')');
      PREPARE dynamic_statement FROM @sql;
      EXECUTE dynamic_statement;
      DEALLOCATE PREPARE dynamic_statement;
    END IF;
    BEGIN
      DECLARE CUR_KITNO CURSOR FOR
      SELECT
        KITNO
      FROM tmp_kitnolist;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET kit_done = TRUE;
      OPEN CUR_KITNO;
    read_kitno:
      LOOP
        FETCH CUR_KITNO INTO IN_KITNO;
        IF kit_done THEN
          LEAVE read_kitno;
        END IF;

        BEGIN
          DECLARE CUR_MAT CURSOR FOR
          SELECT
            A.kitSku,
            A.sku
          FROM BAS_KIT_HEADER B
            LEFT JOIN BAS_KIT_DETAILS A
              ON B.`organizationId` = A.`organizationId`
              AND B.`customerId` = A.`customerId`
              AND B.`kitSku` = A.`kitSku`
              AND B.`versionNo` = A.`versionNo`
          WHERE A.organizationId = 'OJV_CML'
          AND A.`accessoryFlag` = 'Y'
          AND B.`packMaterialFlag` = 'Y';
          DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
          OPEN CUR_MAT;
        read_loop:
          LOOP
            FETCH CUR_MAT INTO r_kitsku,
            r_sku;
            IF done THEN
              LEAVE read_loop;
            END IF;
            BEGIN
              GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
              @p2 = MESSAGE_TEXT,
              @p3 = MYSQL_ERRNO,
              @p4 = TABLE_NAME,
              @p5 = COLUMN_NAME;
              SELECT
                CONCAT('999#SPCUS_BIL_KIT_NOM_NEW,',
                IFNULL(@p1, ''),
                ',',
                IFNULL(@p2, ''),
                ',',
                IFNULL(@p3, ''),
                ',',
                IFNULL(@p4, ''),
                ',',
                IFNULL(@p5, '')) AS outcode;
              SELECT
                v_errormessage AS error;
            END;
            SET v_error = 1;
            IF OUT_returnCode = 'NO_COMMIT'
              OR OUT_returnCode = '*_*' THEN
              SET v_NO_COMMIT = 'N';
            ELSE
              SET v_NO_COMMIT = 'Y';
            END IF;
            SELECT
              COUNT(1)
            FROM DOC_KIT_DETAILS A
              LEFT JOIN DOC_KIT_HEADER B
                ON A.organizationId = B.organizationId
                AND A.warehouseId = B.warehouseId
                AND A.kitNo = B.kitNo
              LEFT JOIN ACT_TRANSACTION_LOG C
                ON B.organizationId = C.organizationId
                AND B.warehouseId = C.warehouseId
                AND B.kitNo = C.docNo
                AND A.lotNum = C.tolotNum
            WHERE A.organizationId = IN_organizationId
            AND A.warehouseId = IN_warehouseId
            AND IFNULL(B.udf01, ' ') = ' '
            AND A.lotAtt11 IN (' ', NULL)
            AND A.lineStatus >= '40'
            AND A.KITNO = IN_kitNo INTO r_RNOW;
            SET IN_organizationId := 'OJV_CML';
            SET IN_Language = 'en';
            IF r_RNOW > 0 THEN
              SELECT
                COUNT(1) INTO r_RNOW4
              FROM DOC_KIT_SUBDETAILS KS
                LEFT JOIN DOC_KIT_DETAILS A
                  ON KS.`organizationId` = A.`organizationId`
                  AND KS.`warehouseId` = A.`warehouseId`
                  AND KS.KITNO = A.`kitNo`
                  AND KS.`kitLineNo` = A.`kitLineNo`
                  AND KS.LOTNUM = A.LOTNUM
                LEFT JOIN DOC_KIT_HEADER A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.CUSTOMERID = A1.CUSTOMERID
                  AND A.WAREHOUSEID = A1.WAREHOUSEID
                  AND A.KITNO = A1.`kitNo`
                LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND A.KITSKU = B.SKU
              WHERE KS.ORGANIZATIONID = 'OJV_CML'
              AND KS.WAREHOUSEID = IN_warehouseId
              AND KS.KITNO = IN_kitNo
              AND KS.SKU = r_sku;

              IF r_RNOW4 = 1 THEN
                CALL SPCOM_GetIDSequence(IN_organizationId,
                IN_warehouseId,
                IN_Language,
                'BILLINGSUMMARYID',
                R_BILLINGSUMMARYID4,
                OUT_returnCode);
                IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                  ROLLBACK;
                  LEAVE ENDPROC;
                END IF;

                SELECT
                  A.ORGANIZATIONID,
                  A.WAREHOUSEID,
                  R_BILLINGSUMMARYID4,
                  CURDATE(),
                  CURDATE(),
                  A.CUSTOMERID,
                  KS.SKU,
                  KS.qtyKittedEach,
                  'PIECES',
                  B.TARIFFID,
                  D.chargeCategory,
                  D.ChargeType,
                  D.descrC,
                  D.RATEBASE,
                  E.RATE,
                  KS.qtyKittedEach * E.Rate,
                  KS.qtyKittedEach * E.Rate,
                  '*',
                  '*',
                  0,
                  'KIT',
                  A.KITNO,
                  A.CUSTOMERID,
                  'UDFTIMER',
                  'UDFTIMER',
                  NOW(),
                  NOW(),
                  D.UDF01,
                  D.UDF02,
                  A.KITSKU
                FROM DOC_KIT_DETAILS A
                  LEFT JOIN DOC_KIT_SUBDETAILS KS
                    ON A.ORGANIZATIONID = KS.ORGANIZATIONID
                    AND A.CUSTOMERID = KS.CUSTOMERID
                    AND A.WAREHOUSEID = KS.WAREHOUSEID
                    AND A.KITNO = KS.`kitNo`
                    AND A.KITLINENO = KS.KITLINENO
                  LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                    ON A.ORGANIZATIONID = B.ORGANIZATIONID
                    AND A.CUSTOMERID = B.CUSTOMERID
                    AND A.WAREHOUSEID = B.WAREHOUSEID
                    AND A.KITSKU = B.SKU
                  LEFT JOIN BIL_TARIFF_HEADER C
                    ON B.ORGANIZATIONID = C.ORGANIZATIONID
                    AND B.TARIFFID = C.TARIFFID
                  LEFT JOIN BIL_TARIFF_DETAILS D
                    ON C.ORGANIZATIONID = D.ORGANIZATIONID
                    AND C.TARIFFID = D.TARIFFID
                    AND D.CHARGECATEGORY = 'PAC_MAT'
                    AND D.CHARGETYPE = r_sku
                  LEFT JOIN BIL_TARIFF_RATE E
                    ON D.ORGANIZATIONID = E.ORGANIZATIONID
                    AND D.TARIFFID = E.TARIFFID
                    AND D.TARIFFLINENO = E.TARIFFLINENO
                WHERE A.ORGANIZATIONID = IN_organizationId
                AND A.WAREHOUSEID = IN_warehouseId
                AND D.CHARGECATEGORY = 'PAC_MAT'
                AND D.CHARGETYPE = r_sku
                AND A.KITNO = IN_kitNo
                AND A.KITSKU = r_kitsku
                AND KS.SKU = r_sku
                AND E.RATE IS NOT NULL;
              END IF;
            END IF;
          END LOOP read_loop;
          CLOSE CUR_MAT;

          SELECT
            COUNT(1) INTO r_RNOW1
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
              AND D.RATEBASE = 'QUANTITY'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_kitNo
          AND D.CHARGECATEGORY = 'TR'
          AND D.CHARGETYPE = 'TRKT'
          AND D.RATEBASE = 'QUANTITY'
          AND D.CHARGETYPE IS NOT NULL;
          IF r_RNOW1 = 1 THEN
            CALL SPCOM_GetIDSequence(IN_organizationId,
            IN_warehouseId,
            IN_Language,
            'BILLINGSUMMARYID',
            R_BILLINGSUMMARYID1,
            OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              ROLLBACK;
              LEAVE ENDPROC;
            END IF;

            SELECT
              A.ORGANIZATIONID,
              A.WAREHOUSEID,
              R_BILLINGSUMMARYID1,
              CURDATE(),
              CURDATE(),
              A.CUSTOMERID,
              A.KITSKU,
              A.qtyKittedEach,
              'PIECES',
              B.TARIFFID,
              D.chargeCategory,
              D.ChargeType,
              D.DESCRC,
              D.RATEBASE,
              E.RATE,
              A.qtyKittedEach * E.Rate,
              A.qtyKittedEach * E.Rate,
              '*',
              '*',
              0,
              'KIT',
              A.KITNO,
              A.CUSTOMERID,
              'UDFTIMER',
              'UDFTIMER',
              NOW(),
              NOW(),
              D.UDF01,
              D.UDF02
            FROM DOC_KIT_DETAILS A
              LEFT JOIN DOC_KIT_HEADER A1
                ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                AND A.CUSTOMERID = A1.CUSTOMERID
                AND A.WAREHOUSEID = A1.WAREHOUSEID
                AND A.KITNO = A1.`kitNo`
              LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                ON A.ORGANIZATIONID = B.ORGANIZATIONID
                AND A.CUSTOMERID = B.CUSTOMERID
                AND A.WAREHOUSEID = B.WAREHOUSEID
                AND A.KITSKU = B.SKU
              LEFT JOIN BIL_TARIFF_HEADER C
                ON B.ORGANIZATIONID = C.ORGANIZATIONID
                AND B.TARIFFID = C.TARIFFID
              LEFT JOIN BIL_TARIFF_DETAILS D
                ON C.ORGANIZATIONID = D.ORGANIZATIONID
                AND C.TARIFFID = D.TARIFFID
                AND D.CHARGECATEGORY = 'TR'
                AND D.CHARGETYPE = 'TRKT'
                AND D.RATEBASE = 'QUANTITY'
              LEFT JOIN BIL_TARIFF_RATE E
                ON D.ORGANIZATIONID = E.ORGANIZATIONID
                AND D.TARIFFID = E.TARIFFID
                AND D.TARIFFLINENO = E.TARIFFLINENO
            WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
            AND A.WAREHOUSEID = IN_warehouseId
            AND A.KITNO = IN_KITNO
            AND D.CHARGECATEGORY = 'TR'
            AND D.CHARGETYPE = 'TRKT'
            AND D.RATEBASE = 'QUANTITY';
          END IF;
          SELECT
            COUNT(1) INTO r_RNOW2
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'VA'
              AND D.CHARGETYPE = 'KT'
              AND D.RATEBASE = 'FLAT'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_kitNo
          AND D.CHARGECATEGORY = 'VA'
          AND D.CHARGETYPE = 'KT'
          AND D.RATEBASE = 'FLAT'
          AND D.CHARGETYPE IS NOT NULL;
          IF r_RNOW2 = 1 THEN
            CALL SPCOM_GetIDSequence(IN_organizationId,
            IN_warehouseId,
            IN_Language,
            'BILLINGSUMMARYID',
            R_BILLINGSUMMARYID2,
            OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              ROLLBACK;
              LEAVE ENDPROC;
            END IF;

            SELECT
              A.ORGANIZATIONID,
              A.WAREHOUSEID,
              R_BILLINGSUMMARYID2,
              CURDATE(),
              CURDATE(),
              A.CUSTOMERID,
              A.KITSKU,
              A.qtyKittedEach,
              'ORDER',
              B.TARIFFID,
              D.chargeCategory,
              D.ChargeType,
              D.DESCRC,
              D.rateBase,
              E.rate,
              E.rate,
              E.rate,
              '*',
              '*',
              0,
              'KIT',
              A.KITNO,
              A.CUSTOMERID,
              'UDFTIMER',
              'UDFTIMER',
              NOW(),
              NOW(),
              D.UDF01,
              D.UDF02
            FROM DOC_KIT_DETAILS A
              LEFT JOIN DOC_KIT_HEADER A1
                ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                AND A.CUSTOMERID = A1.CUSTOMERID
                AND A.WAREHOUSEID = A1.WAREHOUSEID
                AND A.KITNO = A1.`kitNo`
              LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                ON A.ORGANIZATIONID = B.ORGANIZATIONID
                AND A.CUSTOMERID = B.CUSTOMERID
                AND A.WAREHOUSEID = B.WAREHOUSEID
                AND A.KITSKU = B.SKU
              LEFT JOIN BIL_TARIFF_HEADER C
                ON B.ORGANIZATIONID = C.ORGANIZATIONID
                AND B.TARIFFID = C.TARIFFID
              LEFT JOIN BIL_TARIFF_DETAILS D
                ON C.ORGANIZATIONID = D.ORGANIZATIONID
                AND C.TARIFFID = D.TARIFFID
                AND D.CHARGECATEGORY = 'VA'
                AND D.CHARGETYPE = 'KT'
                AND D.RATEBASE = 'FLAT'
              LEFT JOIN BIL_TARIFF_RATE E
                ON D.ORGANIZATIONID = E.ORGANIZATIONID
                AND D.TARIFFID = E.TARIFFID
                AND D.TARIFFLINENO = E.TARIFFLINENO
            WHERE A.ORGANIZATIONID = IN_ORGANIZATIONID
            AND A.WAREHOUSEID = IN_warehouseId
            AND D.CHARGECATEGORY = 'VA'
            AND D.CHARGETYPE = 'KT'
            AND D.RATEBASE = 'FLAT'
            AND A.KITNO = IN_KITNO;
          END IF;
          SELECT
            COUNT(1) INTO r_RNOW3
          FROM DOC_KIT_DETAILS A
            LEFT JOIN DOC_KIT_HEADER A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.CUSTOMERID = A1.CUSTOMERID
              AND A.WAREHOUSEID = A1.WAREHOUSEID
              AND A.KITNO = A1.`kitNo`
            LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND A.KITSKU = B.SKU
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'TR'
              AND D.CHARGETYPE = 'TRKT'
              AND D.RATEBASE = 'FLAT'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.KITNO = IN_kitNo
          AND D.CHARGECATEGORY = 'TR'
          AND D.CHARGETYPE = 'TRKT'
          AND D.RATEBASE = 'FLAT';
          IF r_RNOW3 = 1 THEN
            CALL SPCOM_GetIDSequence(IN_organizationId,
            IN_warehouseId,
            IN_Language,
            'BILLINGSUMMARYID',
            R_BILLINGSUMMARYID3,
            OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              ROLLBACK;
              LEAVE ENDPROC;
            END IF;

            SELECT
              A.ORGANIZATIONID,
              A.WAREHOUSEID,
              R_BILLINGSUMMARYID3,
              CURDATE(),
              CURDATE(),
              A.CUSTOMERID,
              A.KITSKU,
              A.qtyKittedEach,
              'ORDER',
              B.TARIFFID,
              D.chargeCategory,
              D.ChargeType,
              D.DESCRC,
              D.RATEBASE,
              E.RATE,
              E.rate,
              E.RATE,
              '*',
              '*',
              0,
              'KIT',
              A.KITNO,
              A.CUSTOMERID,
              'UDFTIMER',
              'UDFTIMER',
              NOW(),
              NOW(),
              D.UDF01,
              D.UDF02
            FROM DOC_KIT_DETAILS A
              LEFT JOIN DOC_KIT_HEADER A1
                ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                AND A.CUSTOMERID = A1.CUSTOMERID
                AND A.WAREHOUSEID = A1.WAREHOUSEID
                AND A.KITNO = A1.`kitNo`
              LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
                ON A.ORGANIZATIONID = B.ORGANIZATIONID
                AND A.CUSTOMERID = B.CUSTOMERID
                AND A.WAREHOUSEID = B.WAREHOUSEID
                AND A.KITSKU = B.SKU
              LEFT JOIN BIL_TARIFF_HEADER C
                ON B.ORGANIZATIONID = C.ORGANIZATIONID
                AND B.TARIFFID = C.TARIFFID
              LEFT JOIN BIL_TARIFF_DETAILS D
                ON C.ORGANIZATIONID = D.ORGANIZATIONID
                AND C.TARIFFID = D.TARIFFID
                AND D.CHARGECATEGORY = 'TR'
                AND D.CHARGETYPE = 'TRKT'
                AND D.RATEBASE = 'FLAT'
              LEFT JOIN BIL_TARIFF_RATE E
                ON D.ORGANIZATIONID = E.ORGANIZATIONID
                AND D.TARIFFID = E.TARIFFID
                AND D.TARIFFLINENO = E.TARIFFLINENO
            WHERE A.ORGANIZATIONID = IN_organizationId
            AND A.WAREHOUSEID = IN_warehouseId
            AND A.KITNO = IN_kitNo
            AND D.CHARGECATEGORY = 'TR'
            AND D.CHARGETYPE = 'TRKT'
            AND D.RATEBASE = 'FLAT';
          END IF;


        END;
      END LOOP read_kitno;
      CLOSE CUR_KITNO;
    END;
    DROP TEMPORARY TABLE IF EXISTS tmp_kitnolist;
    SET OUT_returnCode := '000';

  END;
END
$$

--
-- Create procedure `OJV_CML_SPUDF_Process2`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPUDF_Process2 (IN IN_warehouseId varchar(20),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_organizationId varchar(100);
    DECLARE R_tariffId varchar(10);
    DECLARE R_customerId varchar(100);
    DECLARE r_udf01 varchar(50);
    DECLARE r_mdocNo varchar(100);
    DECLARE r_mdocType varchar(100);
    DECLARE r_RNOW int;
    DECLARE R_orderNum int;
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE CUR_RK CURSOR FOR
    SELECT
      COUNT(BB.mdocNo),
      BB.mdocNo,
      BB.fmcustomerId,
      BB.`mdocType`
    FROM (SELECT DISTINCT
        b.fmcustomerId,
        a.`mdocNo`,
        c.`mdocType`
      FROM DOC_MOVEMENT_DETAILS a
        LEFT JOIN ACT_TRANSACTION_LOG b
          ON a.`organizationId` = b.`organizationId`
          AND a.`warehouseId` = b.`warehouseId`
          AND b.fmsku = a.`sku`
          AND b.`toLotNum` = a.`lotNum`
        LEFT JOIN DOC_MOVEMENT_HEADER c
          ON a.`organizationId` = c.`organizationId`
          AND a.`warehouseId` = c.`warehouseId`
          AND a.`mdocNo` = c.`mdocNo`
      WHERE a.`organizationId` = IN_organizationId
      AND a.WAREHOUSEID = IN_warehouseId
      AND c.`mdocType` = 'RK'
      AND c.`status` = '99'
      AND IFNULL(c.udf01, ' ') = ' '
      GROUP BY b.`docNo`,
               b.fmcustomerId,
               b.fmsku,
               a.`mdocNo`) BB
    GROUP BY BB.mdocNo,
             BB.mdocNo,
             BB.fmcustomerId,
             BB.`mdocType`;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    SET IN_organizationId = 'OJV_CML';
    SET IN_Language = 'en';
    OPEN CUR_RK;
  read_loop:
    LOOP
      FETCH CUR_RK INTO R_orderNum,
      r_mdocNo,
      R_customerId,
      r_mdocType;
      IF done THEN
        LEAVE read_loop;
      END IF;

      SELECT
        IFNULL(b.tariffId, '*') tariffId INTO R_tariffId
      FROM BAS_SKU_MULTIWAREHOUSE a
        LEFT JOIN BIL_TARIFF_HEADER b
          ON a.organizationId = b.organizationId
          AND a.tariffMasterId = b.tariffMasterId
      WHERE IFNULL(b.tariffId, '*') <> '*'
      AND a.organizationId = 'OJV_CML'
      AND a.warehouseId = IN_warehouse
      AND a.customerId = R_customerId
      AND TIMESTAMPDIFF(SECOND, b.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
      AND TIMESTAMPDIFF(SECOND, b.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
      LIMIT 1;

      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID,
      OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      IF r_mdocType = 'RK' THEN
        SELECT
          COUNT(1) INTO r_RNOW
        FROM DOC_MOVEMENT_HEADER A
          LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.CUSTOMERID = B.CUSTOMERID
            AND A.WAREHOUSEID = B.WAREHOUSEID
            AND B.CUSTOMERTYPE = 'OW'
          LEFT JOIN BIL_TARIFF_HEADER C
            ON B.ORGANIZATIONID = C.ORGANIZATIONID
            AND B.TARIFFMASTERID = C.TARIFFMASTERID
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON C.ORGANIZATIONID = D.ORGANIZATIONID
            AND C.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'TR'
            AND D.CHARGETYPE = 'RK'
          LEFT JOIN BIL_TARIFF_RATE E
            ON D.ORGANIZATIONID = E.ORGANIZATIONID
            AND D.TARIFFID = E.TARIFFID
            AND D.TARIFFLINENO = E.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_organizationId
        AND A.WAREHOUSEID = IN_warehouseId
        AND A.mdocNo = r_mdocNo
        AND D.CHARGETYPE IS NOT NULL
        AND D.TARIFFID = R_tariffId;
        IF r_RNOW = 1 THEN
          INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
          WAREHOUSEID,
          BILLINGSUMMARYID,
          BILLINGFROMDATE,
          BILLINGTODATE,
          CUSTOMERID,
          TARIFFID,
          CHARGECATEGORY,
          CHARGETYPE,
          DESCR,
          RATEBASE,
          chargeRate,
          AMOUNT,
          BILLINGAMOUNT,
          ARNO,
          APNO,
          COST,
          DOCTYPE,
          ORDERTYPE,
          DOCNO,
          BILLTO,
          ADDWHO,
          EDITWHO,
          ADDTIME,
          EDITTIME,
          UDF01,
          UDF02)
            SELECT
              A.ORGANIZATIONID,
              A.WAREHOUSEID,
              R_BILLINGSUMMARYID,
              CURDATE(),
              CURDATE(),
              A.CUSTOMERID,
              B.TARIFFID,
              D.CHARGECATEGORY,
              D.CHARGETYPE,
              D.DESCRC,
              'ORDER',
              R_orderNum,
              R_orderNum * E.RATE,
              R_orderNum * E.RATE,
              '*',
              '*',
              0,
              'SO',
              'RK',
              A.MDOCNO,
              A.CUSTOMERID,
              'UDFTIMER',
              'UDFTIMER',
              NOW(),
              NOW(),
              D.UDF01,
              D.UDF02
            FROM DOC_MOVEMENT_HEADER A
              LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                ON A.ORGANIZATIONID = B.ORGANIZATIONID
                AND A.CUSTOMERID = B.CUSTOMERID
                AND A.WAREHOUSEID = B.WAREHOUSEID
                AND B.CUSTOMERTYPE = 'OW'
              LEFT JOIN BIL_TARIFF_HEADER C
                ON B.ORGANIZATIONID = C.ORGANIZATIONID
                AND B.TARIFFmasterID = C.TARIFFMASTERID
              LEFT JOIN BIL_TARIFF_DETAILS D
                ON C.ORGANIZATIONID = D.ORGANIZATIONID
                AND C.TARIFFID = D.TARIFFID
                AND D.CHARGECATEGORY = 'TR'
                AND D.CHARGETYPE = 'RK'
              LEFT JOIN BIL_TARIFF_RATE E
                ON D.ORGANIZATIONID = E.ORGANIZATIONID
                AND D.TARIFFID = E.TARIFFID
                AND D.TARIFFLINENO = E.TARIFFLINENO
            WHERE A.ORGANIZATIONID = IN_organizationId
            AND A.WAREHOUSEID = IN_warehouseId
            AND A.MDOCNO = r_mdocNo
            AND C.TARIFFID = R_tariffId;
        END IF;
      END IF;
      UPDATE DOC_MOVEMENT_HEADER A
      SET A.udf01 = 'Y'
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.mdocNo = r_mdocNo;
    END LOOP;
    CLOSE CUR_RK;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `OJV_CML_SPUDF_Process1_Backup`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPUDF_Process1_Backup (IN IN_warehouseId varchar(20),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_organizationId varchar(100) DEFAULT 'OJV_CML';
    DECLARE r_arriveTime timestamp;
    DECLARE r_cutoff timestamp;
    DECLARE r_RNOW1 int;
    DECLARE r_RNOW2 int;
    DECLARE r_RNOW3 int;
    DECLARE r_tariffId varchar(100);
    DECLARE r_orderType varchar(100);
    DECLARE r_appointmentDate timestamp;
    DECLARE r_docNo varchar(100);
    DECLARE r_ARRIVALNO varchar(100);
    DECLARE r_docType varchar(100);
    DECLARE r_udf01 int;
    DECLARE r_arrivedata int;
    DECLARE r_latehour varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE r_ttlrest int;
    DECLARE CUR_APP CURSOR FOR
    SELECT DISTINCT
      A.entranceTime,
      CAST(
      CONCAT(DATE(C.appointmentDate),
      ' ',
      C.startTime) AS datetime
      ) AS appointmentTime,
      CASE WHEN D.docType = 'LOAD' THEN E.ldlNo WHEN D.docType = 'SO' THEN G.ORDERNO WHEN D.docType = 'ASN' THEN H.ASNNO ELSE D.docNo END AS docNo,
      CASE WHEN D.docType = 'LOAD' THEN F1.orderType WHEN D.docType = 'SO' THEN G.orderType WHEN D.docType = 'ASN' THEN I.asnType ELSE G.orderType END AS orderType,
      D.docType,
      A.ARRIVALNO
    FROM DOC_ARRIVAL_HEADER A
      LEFT JOIN DOC_ARRIVAL_DETAILS B
        ON A.organizationId = B.organizationId
        AND A.arrivalNo = B.arrivalno
      LEFT JOIN DOC_APPOINTMENT_HEADER C
        ON B.organizationId = C.organizationId
        AND B.appointmentno = C.appointmentNo
      LEFT JOIN DOC_APPOINTMENT_DETAILS D
        ON C.organizationId = D.organizationId
        AND C.appointmentNo = D.appointmentNo
      LEFT JOIN DOC_LOADING_HEADER E
        ON E.organizationId = D.organizationId
        AND E.warehouseId = A.warehouseId
        AND E.ldlNo = D.docNo
        AND D.docType = 'LOAD'
      LEFT JOIN DOC_WAVE_DETAILS F
        ON E.organizationId = F.organizationId
        AND E.warehouseId = F.warehouseId
        AND E.WAVENO = F.WAVENO
      LEFT JOIN DOC_WAVE_HEADER F1
        ON E.organizationId = F1.organizationId
        AND E.warehouseId = F1.warehouseId
        AND E.WAVENO = F1.WAVENO
      LEFT JOIN DOC_ORDER_HEADER G
        ON G.organizationId = D.organizationId
        AND G.warehouseId = A.warehouseId
        AND G.ORDERNO = D.docNo
        AND D.docType = 'SO'
      LEFT JOIN DOC_ASN_DETAILS H
        ON H.organizationId = D.organizationId
        AND H.warehouseId = A.warehouseId
        AND H.ASNNO = D.docNo
        AND D.docType = 'ASN'
      LEFT JOIN DOC_ASN_HEADER I
        ON H.organizationId = I.organizationId
        AND H.warehouseid = I.warehouseid
        AND H.asnNO = I.asnNo
        AND D.docType = 'ASN'
    WHERE A.organizationId = 'OJV_CML'
    AND A.warehouseId = IN_warehouseId
    AND A.udf01 <> 'Y'
    AND docNo IS NOT NULL
    AND A.arrivalStatus NOT IN ('00', '90', '99');
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    OPEN CUR_APP;
  read_loop:
    LOOP
      FETCH CUR_APP INTO r_arriveTime,
      r_appointmentDate,
      r_docNo,
      r_orderType,
      r_docType,
      r_ARRIVALNO;
      IF done THEN
        LEAVE read_loop;
      END IF;
      SELECT
        MAX(udf01),
        MAX(tariffId)
      FROM (SELECT
          D.udf01 AS udf01,
          D.tariffId AS tariffId
        FROM DOC_APPOINTMENT_DETAILS A
          LEFT JOIN DOC_ORDER_DETAILS B
            ON A.`organizationId` = B.`organizationId`
            AND A.`warehouseId` = B.`warehouseId`
            AND A.`docNo` = B.`orderNo`
          LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE C
            ON C.`organizationId` = B.`organizationId`
            AND C.`warehouseId` = B.`warehouseId`
            AND C.`customerId` = B.`customerId`
            AND C.`customerType` = 'OW'
          LEFT JOIN BIL_TARIFF_HEADER D
            ON D.`organizationId` = C.`organizationId`
            AND D.tariffMasterId = C.tariffMasterId
        WHERE D.udf01 IS NOT NULL
        AND A.organizationId = IN_organizationId
        AND B.warehouseId = IN_warehouseId
        AND B.ORDERNO = r_docNo
        AND IFNULL(D.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, D.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, D.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
        UNION
        SELECT
          D.udf01 AS udf01,
          D.tariffId AS tariffId
        FROM DOC_APPOINTMENT_DETAILS A
          LEFT JOIN DOC_ASN_DETAILS B
            ON A.organizationId = B.organizationId
            AND A.warehouseId = B.warehouseId
            AND A.docNo = B.asnNo
          LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE C
            ON B.`organizationId` = C.`organizationId`
            AND B.`warehouseId` = C.`warehouseId`
            AND B.customerId = C.`customerId`
            AND C.customerType = 'OW'
          LEFT JOIN BIL_TARIFF_HEADER D
            ON D.`organizationId` = C.`organizationId`
            AND D.tariffMasterId = C.tariffMasterId
        WHERE D.udf01 IS NOT NULL
        AND A.organizationId = IN_organizationId
        AND B.warehouseId = IN_warehouseId
        AND B.asnNo = r_docNo
        AND IFNULL(D.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, D.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, D.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
        UNION
        SELECT
          D.udf01 AS udf01,
          D.tariffId AS tariffId
        FROM DOC_APPOINTMENT_DETAILS A
          LEFT JOIN DOC_LOADING_HEADER E
            ON E.organizationId = A.organizationId
            AND E.warehouseId = A.warehouseId
            AND A.docNo = E.ldlNo
          LEFT JOIN DOC_WAVE_DETAILS F
            ON E.organizationId = F.organizationId
            AND E.warehouseId = F.warehouseId
            AND E.WAVENO = F.WAVENO
          LEFT JOIN DOC_ORDER_DETAILS B
            ON F.`organizationId` = B.`organizationId`
            AND F.`warehouseId` = B.`warehouseId`
            AND F.orderNo = B.orderNo
          LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE C
            ON B.`organizationId` = C.`organizationId`
            AND B.`warehouseId` = C.`warehouseId`
            AND B.customerId = C.customerId
            AND C.`customerType` = 'OW'
          LEFT JOIN BIL_TARIFF_HEADER D
            ON D.`organizationId` = C.`organizationId`
            AND D.tariffMasterId = C.tariffMasterId
        WHERE D.udf01 IS NOT NULL
        AND A.organizationId = IN_organizationId
        AND B.warehouseId = IN_warehouseId
        AND E.ldlNo = r_docNo
        AND IFNULL(D.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, D.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, D.effectiveTo, NOW()) / (60 * 60 * 24) <= 0) BILLTARIFF INTO r_udf01,
      r_tariffId;
      SELECT
        EXTRACT(HOUR_MINUTE FROM r_arriveTime) INTO r_arrivedata;

      -- Update orderType to overtime 
      IF r_arrivedata > r_udf01
        AND r_udf01 <> 0 THEN
        IF r_docType = 'ASN'
          AND r_orderType <> 'CROSS' THEN
          UPDATE DOC_ASN_HEADER A
          SET A.asnType = 'OV'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.asnNo = r_docNo
          AND A.asnType <> 'CROSS';
        END IF;
        IF r_docType = 'LOAD'
          AND IFNULL(r_orderType, '') <> 'CROSS' THEN
          UPDATE DOC_ORDER_HEADER A
          LEFT JOIN DOC_WAVE_DETAILS F
            ON A.organizationId = F.organizationId
            AND A.warehouseId = F.warehouseId
            AND A.WAVENO = F.WAVENO
          LEFT JOIN DOC_LOADING_HEADER E
            ON E.organizationId = F.organizationId
            AND E.warehouseId = F.warehouseId
            AND E.waveNo = F.waveNo
          SET A.orderType = 'OT'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND E.ldlNo = r_docNo
          AND IFNULL(r_orderType, '') <> 'CROSS';
        END IF;
        IF r_docType = 'SO'
          AND r_orderType = 'CROSS' THEN
          UPDATE DOC_ORDER_HEADER A
          SET A.ordertype = 'COT'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.orderno = r_docNo
          AND A.orderType <> 'CROSS';
        END IF;
        IF r_docType = 'SO'
          AND r_orderType <> 'CROSS' THEN
          UPDATE DOC_ORDER_HEADER A
          SET A.ordertype = 'OT'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.orderno = r_docNo
          AND A.orderType <> 'CROSS';
        END IF;
        IF r_docType = 'ASN'
          AND r_orderType = 'CROSS' THEN
          UPDATE DOC_ASN_HEADER A
          SET A.asnType = 'COT'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.asnNo = r_docNo
          AND A.asnType = 'CROSS';
        END IF;
        IF r_docType = 'LOAD'
          AND r_orderType = 'CROSS' THEN
          UPDATE DOC_ORDER_HEADER A
          LEFT JOIN DOC_WAVE_DETAILS F
            ON A.organizationId = F.organizationId
            AND A.warehouseId = F.warehouseId
            AND A.WAVENO = F.WAVENO
          LEFT JOIN DOC_LOADING_HEADER E
            ON E.organizationId = F.organizationId
            AND E.warehouseId = F.warehouseId
            AND E.waveNo = F.waveNo
          SET A.orderType = 'COT'
          WHERE A.organizationId = 'OJV_CML'
          AND A.warehouseId = IN_warehouseid
          AND E.ldlNo = r_docno
          AND A.orderType = 'CROSS';
        END IF;
        SET r_cutoff = CAST(
        CONCAT(CURDATE(),
        ' ',
        TIME_FORMAT(CONCAT(r_udf01, '00'), '%T')) AS datetime
        );
        SET r_ttlrest = 0;
        IF (
          CAST('12:00:00' AS time) BETWEEN TIME_FORMAT(r_cutoff, "%T")
          AND TIME_FORMAT(r_arriveTime, "%T")
          )
          AND (
          CAST('18:00:00' AS time) BETWEEN TIME_FORMAT(r_cutoff, "%T")
          AND TIME_FORMAT(r_arriveTime, "%T")
          ) THEN
          SET r_ttlrest = 2;
        ELSE
          IF (
            CAST('12:00:00' AS time) BETWEEN TIME_FORMAT(r_cutoff, "%T")
            AND TIME_FORMAT(r_arriveTime, "%T")
            )
            OR (
            CAST('18:00:00' AS time) BETWEEN TIME_FORMAT(r_cutoff, "%T")
            AND TIME_FORMAT(r_arriveTime, "%T")
            ) THEN
            SET r_ttlrest = 1;
          ELSE
            SET r_ttlrest = 0;
          END IF;
        END IF;
        SELECT
          TIMESTAMPDIFF(HOUR, r_cutoff, r_arriveTime) + 1 - r_ttlrest INTO r_latehour;
        SET OUT_returnCode = 'NO_COMMIT';
        CALL SPCOM_GetIDSequence(IN_organizationId,
        IN_warehouseId,
        IN_Language,
        'BILLINGSUMMARYID',
        R_BILLINGSUMMARYID,
        OUT_returnCode);
        IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
        IF r_docType = 'ASN' THEN
          SELECT
            COUNT(1) INTO r_RNOW1
          FROM DOC_ASN_HEADER A
            LEFT JOIN DOC_APPOINTMENT_DETAILS A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.asnNo = A1.docNo
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND B.CUSTOMERTYPE = 'OW'
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'SP'
              AND D.CHARGETYPE = 'SF'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.ASNNO = r_docNo
          AND D.CHARGETYPE IS NOT NULL;
          IF r_RNOW1 = 1 THEN
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            qty,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID,
                CURDATE(),
                CURDATE(),
                A.CUSTOMERID,
                B.TARIFFID,
                D.CHARGECATEGORY,
                D.CHARGETYPE,
                D.DESCRC,
                'HOUR',
                r_latehour,
                E.rate,
                r_latehour * E.RATE,
                r_latehour * E.RATE,
                '*',
                '*',
                0,
                'ASN',
                A.ASNNO,
                A.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                NOW(),
                NOW(),
                D.UDF01,
                D.UDF02,
                D.UDF06
              FROM DOC_ASN_HEADER A
                LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND B.CUSTOMERTYPE = 'OW'
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFID = C.TARIFFID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'SP'
                  AND D.CHARGETYPE = 'SF'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_organizationId
              AND A.WAREHOUSEID = IN_warehouseId
              AND A.ASNNO = r_docNo
              LIMIT 1;
          END IF;
        END IF;
        IF r_docType = 'SO' THEN
          SELECT
            COUNT(1) INTO r_RNOW2
          FROM DOC_ORDER_HEADER A
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND B.CUSTOMERTYPE = 'OW'
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'SP'
              AND D.CHARGETYPE = 'SF'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.orderNo = r_docNo
          AND D.CHARGETYPE IS NOT NULL;
          IF r_RNOW2 = 1 THEN
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            qty,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID,
                CURDATE(),
                CURDATE(),
                A.CUSTOMERID,
                B.TARIFFID,
                D.CHARGECATEGORY,
                D.CHARGETYPE,
                D.DESCRC,
                'HOUR',
                r_latehour,
                E.rate,
                r_latehour * E.RATE,
                r_latehour * E.RATE,
                '*',
                '*',
                0,
                'SO',
                A.orderNo,
                A.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                NOW(),
                NOW(),
                D.UDF01,
                D.UDF02,
                D.UDF06
              FROM DOC_ORDER_HEADER A
                LEFT JOIN DOC_APPOINTMENT_DETAILS A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.orderNo = A1.docNo
                LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND B.CUSTOMERTYPE = 'OW'
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFID = C.TARIFFID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'SP'
                  AND D.CHARGETYPE = 'SF'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_organizationId
              AND A.WAREHOUSEID = IN_warehouseId
              AND A.orderNo = r_docNo
              LIMIT 1;
          END IF;
        END IF;
        IF r_docType = 'LOAD' THEN
          SELECT
            COUNT(1) INTO r_RNOW3
          FROM DOC_LOADING_HEADER A
            LEFT JOIN DOC_APPOINTMENT_DETAILS A1
              ON A.organizationId = A1.organizationId
              AND A.ldlNo = A1.`docNo`
            LEFT JOIN DOC_WAVE_DETAILS F
              ON A.organizationId = F.organizationId
              AND A.warehouseId = F.warehouseId
              AND A.WAVENO = F.WAVENO
            LEFT JOIN DOC_ORDER_DETAILS B
              ON B.organizationId = F.organizationId
              AND B.warehouseId = F.warehouseId
              AND B.ORDERNO = F.ORDERNO
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B2
              ON B.`organizationId` = B2.organizationId
              AND B.`warehouseId` = B2.warehouseId
              AND B.customerId = B2.`customerId`
              AND B2.`customerType` = 'OW'
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B2.ORGANIZATIONID = C.ORGANIZATIONID
              AND B2.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'SP'
              AND D.CHARGETYPE = 'SF'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.ldlNo = r_docNo
          AND D.CHARGETYPE IS NOT NULL;
          IF r_RNOW3 >= 1 THEN
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            qty,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID,
                CURDATE(),
                CURDATE(),
                G.CUSTOMERID,
                B.TARIFFID,
                D.CHARGECATEGORY,
                D.CHARGETYPE,
                D.DESCRC,
                'HOUR',
                r_latehour,
                E.rate,
                r_latehour * E.RATE,
                r_latehour * E.RATE,
                '*',
                '*',
                0,
                'SO',
                A.ldlNo,
                G.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                NOW(),
                NOW(),
                D.UDF01,
                D.UDF02,
                D.UDF06
              FROM DOC_LOADING_HEADER A
                LEFT JOIN DOC_APPOINTMENT_DETAILS A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.ldlNo = A1.docNo
                LEFT JOIN DOC_WAVE_DETAILS F
                  ON A.`organizationId` = F.`organizationId`
                  AND A.`warehouseId` = F.`warehouseId`
                  AND A.waveNo = F.waveNo
                LEFT JOIN DOC_ORDER_DETAILS G
                  ON F.`organizationId` = G.`organizationId`
                  AND F.`warehouseId` = G.warehouseId
                  AND F.`orderNo` = G.orderNo
                LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND G.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND B.CUSTOMERTYPE = 'OW'
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFID = C.TARIFFID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'SP'
                  AND D.CHARGETYPE = 'SF'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_organizationId
              AND A.WAREHOUSEID = IN_warehouseId
              AND A.ldlNo = r_docNo
              LIMIT 1;
          END IF;
        END IF;
      END IF;
      UPDATE DOC_ARRIVAL_HEADER A
      SET A.udf01 = 'Y'
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.ARRIVALNO = r_ARRIVALNO
      AND A.arrivalStatus NOT IN ('00', '90', '99');
    END LOOP;
    CLOSE CUR_APP;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `OJV_CML_SPUDF_Process1`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPUDF_Process1 (IN IN_warehouseId varchar(20),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_organizationId varchar(100) DEFAULT 'OJV_CML';
    DECLARE r_arriveTime timestamp;
    DECLARE r_cutoff timestamp;
    DECLARE r_RNOW1 int;
    DECLARE r_RNOW2 int;
    DECLARE r_RNOW3 int;
    DECLARE r_tariffId varchar(100);
    DECLARE r_orderType varchar(100);
    DECLARE r_appointmentDate timestamp;
    DECLARE r_docNo varchar(100);
    DECLARE r_ARRIVALNO varchar(100);
    DECLARE r_docType varchar(100);
    DECLARE r_udf01 int;
    DECLARE r_arrivedata int;
    DECLARE r_latehour varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE r_ttlrest int;
    DECLARE CUR_APP CURSOR FOR
    SELECT DISTINCT
      A.entranceTime,
      CAST(
      CONCAT(DATE(C.appointmentDate),
      ' ',
      C.startTime) AS datetime
      ) AS appointmentTime,
      CASE WHEN D.docType = 'LOAD' THEN E.ldlNo WHEN D.docType = 'SO' THEN G.ORDERNO WHEN D.docType = 'ASN' THEN H.ASNNO ELSE D.docNo END AS docNo,
      CASE WHEN D.docType = 'LOAD' THEN F1.orderType WHEN D.docType = 'SO' THEN G.orderType WHEN D.docType = 'ASN' THEN I.asnType ELSE G.orderType END AS orderType,
      D.docType,
      A.ARRIVALNO
    FROM DOC_ARRIVAL_HEADER A
      LEFT JOIN DOC_ARRIVAL_DETAILS B
        ON A.organizationId = B.organizationId
        AND A.arrivalNo = B.arrivalno
      LEFT JOIN DOC_APPOINTMENT_HEADER C
        ON B.organizationId = C.organizationId
        AND B.appointmentno = C.appointmentNo
      LEFT JOIN DOC_APPOINTMENT_DETAILS D
        ON C.organizationId = D.organizationId
        AND C.appointmentNo = D.appointmentNo
      LEFT JOIN DOC_LOADING_HEADER E
        ON E.organizationId = D.organizationId
        AND E.warehouseId = A.warehouseId
        AND E.ldlNo = D.docNo
        AND D.docType = 'LOAD'
      LEFT JOIN DOC_WAVE_DETAILS F
        ON E.organizationId = F.organizationId
        AND E.warehouseId = F.warehouseId
        AND E.WAVENO = F.WAVENO
      LEFT JOIN DOC_WAVE_HEADER F1
        ON E.organizationId = F1.organizationId
        AND E.warehouseId = F1.warehouseId
        AND E.WAVENO = F1.WAVENO
      LEFT JOIN DOC_ORDER_HEADER G
        ON G.organizationId = D.organizationId
        AND G.warehouseId = A.warehouseId
        AND G.ORDERNO = D.docNo
        AND D.docType = 'SO'
      LEFT JOIN DOC_ASN_DETAILS H
        ON H.organizationId = D.organizationId
        AND H.warehouseId = A.warehouseId
        AND H.ASNNO = D.docNo
        AND D.docType = 'ASN'
      LEFT JOIN DOC_ASN_HEADER I
        ON H.organizationId = I.organizationId
        AND H.warehouseid = I.warehouseid
        AND H.asnNO = I.asnNo
        AND D.docType = 'ASN'
    WHERE A.organizationId = 'OJV_CML'
    AND A.warehouseId = IN_warehouseId
    AND A.udf01 <> 'Y'
    AND docNo IS NOT NULL
    AND A.arrivalStatus NOT IN ('00', '90', '99');
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    OPEN CUR_APP;
  read_loop:
    LOOP
      FETCH CUR_APP INTO r_arriveTime,
      r_appointmentDate,
      r_docNo,
      r_orderType,
      r_docType,
      r_ARRIVALNO;
      IF done THEN
        LEAVE read_loop;
      END IF;
      SELECT
        MAX(udf01),
        MAX(tariffId)
      FROM (SELECT
          D.udf01 AS udf01,
          D.tariffId AS tariffId
        FROM DOC_APPOINTMENT_DETAILS A
          LEFT JOIN DOC_ORDER_DETAILS B
            ON A.`organizationId` = B.`organizationId`
            AND A.`warehouseId` = B.`warehouseId`
            AND A.`docNo` = B.`orderNo`
          LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE C
            ON C.`organizationId` = B.`organizationId`
            AND C.`warehouseId` = B.`warehouseId`
            AND C.`customerId` = B.`customerId`
            AND C.`customerType` = 'OW'
          LEFT JOIN BIL_TARIFF_HEADER D
            ON D.`organizationId` = C.`organizationId`
            AND D.tariffMasterId = C.tariffMasterId
        WHERE D.udf01 IS NOT NULL
        AND A.organizationId = IN_organizationId
        AND B.warehouseId = IN_warehouseId
        AND B.ORDERNO = r_docNo
        AND IFNULL(D.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, D.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, D.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
        UNION
        SELECT
          D.udf01 AS udf01,
          D.tariffId AS tariffId
        FROM DOC_APPOINTMENT_DETAILS A
          LEFT JOIN DOC_ASN_DETAILS B
            ON A.organizationId = B.organizationId
            AND A.warehouseId = B.warehouseId
            AND A.docNo = B.asnNo
          LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE C
            ON B.`organizationId` = C.`organizationId`
            AND B.`warehouseId` = C.`warehouseId`
            AND B.customerId = C.`customerId`
            AND C.customerType = 'OW'
          LEFT JOIN BIL_TARIFF_HEADER D
            ON D.`organizationId` = C.`organizationId`
            AND D.tariffMasterId = C.tariffMasterId
        WHERE D.udf01 IS NOT NULL
        AND A.organizationId = IN_organizationId
        AND B.warehouseId = IN_warehouseId
        AND B.asnNo = r_docNo
        AND IFNULL(D.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, D.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, D.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
        UNION
        SELECT
          D.udf01 AS udf01,
          D.tariffId AS tariffId
        FROM DOC_APPOINTMENT_DETAILS A
          LEFT JOIN DOC_LOADING_HEADER E
            ON E.organizationId = A.organizationId
            AND E.warehouseId = A.warehouseId
            AND A.docNo = E.ldlNo
          LEFT JOIN DOC_WAVE_DETAILS F
            ON E.organizationId = F.organizationId
            AND E.warehouseId = F.warehouseId
            AND E.WAVENO = F.WAVENO
          LEFT JOIN DOC_ORDER_DETAILS B
            ON F.`organizationId` = B.`organizationId`
            AND F.`warehouseId` = B.`warehouseId`
            AND F.orderNo = B.orderNo
          LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE C
            ON B.`organizationId` = C.`organizationId`
            AND B.`warehouseId` = C.`warehouseId`
            AND B.customerId = C.customerId
            AND C.`customerType` = 'OW'
          LEFT JOIN BIL_TARIFF_HEADER D
            ON D.`organizationId` = C.`organizationId`
            AND D.tariffMasterId = C.tariffMasterId
        WHERE D.udf01 IS NOT NULL
        AND A.organizationId = IN_organizationId
        AND B.warehouseId = IN_warehouseId
        AND E.ldlNo = r_docNo
        AND IFNULL(D.tariffId, '*') <> '*'
        AND TIMESTAMPDIFF(SECOND, D.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
        AND TIMESTAMPDIFF(SECOND, D.effectiveTo, NOW()) / (60 * 60 * 24) <= 0) BILLTARIFF INTO r_udf01,
      r_tariffId;
      SELECT
        EXTRACT(HOUR_MINUTE FROM r_arriveTime) INTO r_arrivedata;

      -- Update orderType to overtime 
      IF r_arrivedata > r_udf01
        AND r_udf01 <> 0 THEN
        IF r_docType = 'ASN'
          AND r_orderType <> 'CROSS' THEN
          UPDATE DOC_ASN_HEADER A
          SET A.asnType = 'OV'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.asnNo = r_docNo
          AND A.customerid NOT IN ('PPG', 'GMC', 'GCM', 'GYI', 'MAP', 'PSLOVE', 'YFI', 'MDS',
          'PMLSBY', /*add customerId 20250620*/
          'NLDC', 'ECCOSBY', 'FMI_JKT', 'PANDA', 'MAPCLUB', 'ECMAMAB2C', 'TUMI', 'LTL_SMG')
          AND A.asnType <> 'CROSS';
        END IF;
        IF r_docType = 'LOAD'
          AND IFNULL(r_orderType, '') <> 'CROSS' THEN
          UPDATE DOC_ORDER_HEADER A
          LEFT JOIN DOC_WAVE_DETAILS F
            ON A.organizationId = F.organizationId
            AND A.warehouseId = F.warehouseId
            AND A.WAVENO = F.WAVENO
          LEFT JOIN DOC_LOADING_HEADER E
            ON E.organizationId = F.organizationId
            AND E.warehouseId = F.warehouseId
            AND E.waveNo = F.waveNo
          SET A.orderType = 'OT'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND E.ldlNo = r_docNo
          AND A.carrierId NOT IN ('KEDCA1522', 'LINC_EXP', '5000000027', 'JNE', '0000001794', '0000002529', '0000004182', 'BP', 'LINC-EXP', 'LINC-X', 'ECCOSBY')
          AND E.carrierId NOT IN ('KEDCA1522', 'LINC_EXP', '5000000027', 'JNE', '0000001794', '0000002529', '0000004182', 'BP', 'LINC-EXP', 'LINC-X', 'ECCOSBY')
          AND A.customerid NOT IN ('PPG', 'GMC', 'GCM', 'GYI', 'MAP', 'PSLOVE', 'YFI', 'MDS',
          'PMLSBY', /*add customerId 20250620*/
          'NLDC', 'ECCOSBY', 'FMI_JKT', 'PANDA', 'MAPCLUB', 'ECMAMAB2C', 'TUMI', 'LTL_SMG')
          AND A.warehouseId NOT IN ('SBYKK')
          AND IFNULL(r_orderType, '') <> 'CROSS';
        END IF;
        IF r_docType = 'SO'
          AND r_orderType = 'CROSS' THEN
          UPDATE DOC_ORDER_HEADER A
          SET A.ordertype = 'COT'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.orderno = r_docNo
          AND A.orderType <> 'CROSS';
        END IF;
        IF r_docType = 'SO'
          AND r_orderType <> 'CROSS' THEN
          UPDATE DOC_ORDER_HEADER A
          SET A.ordertype = 'OT'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.orderno = r_docNo
          AND A.orderType <> 'CROSS'
          AND A.customerid NOT IN ('PPG', 'GMC', 'GCM', 'GYI', 'MAP', 'ECCOSBY', 'FMI_JKT', 'PANDA', 'MAPCLUB', 'ECMAMAB2C', 'TUMI')
          AND A.warehouseId NOT IN ('SBYKK')
          AND A.carrierId NOT IN ('KEDCA1522', 'LINC_EXP', '5000000027', 'JNE', '0000001794', '0000002529', '0000004182', 'BP', 'LINC-EXP', 'LINC-X', '', 'ECCOSBY', 'LTL_SMG');
        END IF;
        IF r_docType = 'ASN'
          AND r_orderType = 'CROSS' THEN
          UPDATE DOC_ASN_HEADER A
          SET A.asnType = 'COT'
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.asnNo = r_docNo
          AND A.asnType = 'CROSS';
        END IF;
        IF r_docType = 'LOAD'
          AND r_orderType = 'CROSS' THEN
          UPDATE DOC_ORDER_HEADER A
          LEFT JOIN DOC_WAVE_DETAILS F
            ON A.organizationId = F.organizationId
            AND A.warehouseId = F.warehouseId
            AND A.WAVENO = F.WAVENO
          LEFT JOIN DOC_LOADING_HEADER E
            ON E.organizationId = F.organizationId
            AND E.warehouseId = F.warehouseId
            AND E.waveNo = F.waveNo
          SET A.orderType = 'COT'
          WHERE A.organizationId = 'OJV_CML'
          AND A.warehouseId = IN_warehouseid
          AND E.ldlNo = r_docno
          AND A.orderType = 'CROSS';
        END IF;
        SET r_cutoff = CAST(
        CONCAT(CURDATE(),
        ' ',
        TIME_FORMAT(CONCAT(r_udf01, '00'), '%T')) AS datetime
        );
        SET r_ttlrest = 0;
        IF (
          CAST('12:00:00' AS time) BETWEEN TIME_FORMAT(r_cutoff, "%T")
          AND TIME_FORMAT(r_arriveTime, "%T")
          )
          AND (
          CAST('18:00:00' AS time) BETWEEN TIME_FORMAT(r_cutoff, "%T")
          AND TIME_FORMAT(r_arriveTime, "%T")
          ) THEN
          SET r_ttlrest = 2;
        ELSE
          IF (
            CAST('12:00:00' AS time) BETWEEN TIME_FORMAT(r_cutoff, "%T")
            AND TIME_FORMAT(r_arriveTime, "%T")
            )
            OR (
            CAST('18:00:00' AS time) BETWEEN TIME_FORMAT(r_cutoff, "%T")
            AND TIME_FORMAT(r_arriveTime, "%T")
            ) THEN
            SET r_ttlrest = 1;
          ELSE
            SET r_ttlrest = 0;
          END IF;
        END IF;
        SELECT
          TIMESTAMPDIFF(HOUR, r_cutoff, r_arriveTime) + 1 - r_ttlrest INTO r_latehour;
        SET OUT_returnCode = 'NO_COMMIT';
        CALL SPCOM_GetIDSequence(IN_organizationId,
        IN_warehouseId,
        IN_Language,
        'BILLINGSUMMARYID',
        R_BILLINGSUMMARYID,
        OUT_returnCode);
        IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
        IF r_docType = 'ASN' THEN
          SELECT
            COUNT(1) INTO r_RNOW1
          FROM DOC_ASN_HEADER A
            LEFT JOIN DOC_APPOINTMENT_DETAILS A1
              ON A.ORGANIZATIONID = A1.ORGANIZATIONID
              AND A.asnNo = A1.docNo
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND B.CUSTOMERTYPE = 'OW'
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'SP'
              AND D.CHARGETYPE = 'SF'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.ASNNO = r_docNo
          AND D.CHARGETYPE IS NOT NULL;
          IF r_RNOW1 = 1 THEN
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            qty,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID,
                CURDATE(),
                CURDATE(),
                A.CUSTOMERID,
                B.TARIFFID,
                D.CHARGECATEGORY,
                D.CHARGETYPE,
                D.DESCRC,
                'HOUR',
                r_latehour,
                E.rate,
                r_latehour * E.RATE,
                r_latehour * E.RATE,
                '*',
                '*',
                0,
                'ASN',
                A.ASNNO,
                A.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                NOW(),
                NOW(),
                D.UDF01,
                D.UDF02,
                D.UDF06
              FROM DOC_ASN_HEADER A
                LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND B.CUSTOMERTYPE = 'OW'
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFID = C.TARIFFID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'SP'
                  AND D.CHARGETYPE = 'SF'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_organizationId
              AND A.WAREHOUSEID = IN_warehouseId
              AND A.ASNNO = r_docNo
              LIMIT 1;
          END IF;
        END IF;
        IF r_docType = 'SO' THEN
          SELECT
            COUNT(1) INTO r_RNOW2
          FROM DOC_ORDER_HEADER A
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.CUSTOMERID = B.CUSTOMERID
              AND A.WAREHOUSEID = B.WAREHOUSEID
              AND B.CUSTOMERTYPE = 'OW'
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B.ORGANIZATIONID = C.ORGANIZATIONID
              AND B.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'SP'
              AND D.CHARGETYPE = 'SF'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.orderNo = r_docNo
          AND D.CHARGETYPE IS NOT NULL;
          IF r_RNOW2 = 1 THEN
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            qty,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID,
                CURDATE(),
                CURDATE(),
                A.CUSTOMERID,
                B.TARIFFID,
                D.CHARGECATEGORY,
                D.CHARGETYPE,
                D.DESCRC,
                'HOUR',
                r_latehour,
                E.rate,
                r_latehour * E.RATE,
                r_latehour * E.RATE,
                '*',
                '*',
                0,
                'SO',
                A.orderNo,
                A.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                NOW(),
                NOW(),
                D.UDF01,
                D.UDF02,
                D.UDF06
              FROM DOC_ORDER_HEADER A
                LEFT JOIN DOC_APPOINTMENT_DETAILS A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.orderNo = A1.docNo
                LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND A.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND B.CUSTOMERTYPE = 'OW'
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFID = C.TARIFFID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'SP'
                  AND D.CHARGETYPE = 'SF'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_organizationId
              AND A.WAREHOUSEID = IN_warehouseId
              AND A.orderNo = r_docNo
              LIMIT 1;
          END IF;
        END IF;
        IF r_docType = 'LOAD' THEN
          SELECT
            COUNT(1) INTO r_RNOW3
          FROM DOC_LOADING_HEADER A
            LEFT JOIN DOC_APPOINTMENT_DETAILS A1
              ON A.organizationId = A1.organizationId
              AND A.ldlNo = A1.`docNo`
            LEFT JOIN DOC_WAVE_DETAILS F
              ON A.organizationId = F.organizationId
              AND A.warehouseId = F.warehouseId
              AND A.WAVENO = F.WAVENO
            LEFT JOIN DOC_ORDER_DETAILS B
              ON B.organizationId = F.organizationId
              AND B.warehouseId = F.warehouseId
              AND B.ORDERNO = F.ORDERNO
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B2
              ON B.`organizationId` = B2.organizationId
              AND B.`warehouseId` = B2.warehouseId
              AND B.customerId = B2.`customerId`
              AND B2.`customerType` = 'OW'
            LEFT JOIN BIL_TARIFF_HEADER C
              ON B2.ORGANIZATIONID = C.ORGANIZATIONID
              AND B2.TARIFFID = C.TARIFFID
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON C.ORGANIZATIONID = D.ORGANIZATIONID
              AND C.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'SP'
              AND D.CHARGETYPE = 'SF'
            LEFT JOIN BIL_TARIFF_RATE E
              ON D.ORGANIZATIONID = E.ORGANIZATIONID
              AND D.TARIFFID = E.TARIFFID
              AND D.TARIFFLINENO = E.TARIFFLINENO
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND A.WAREHOUSEID = IN_warehouseId
          AND A.ldlNo = r_docNo
          AND D.CHARGETYPE IS NOT NULL;
          IF r_RNOW3 >= 1 THEN
            INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
            WAREHOUSEID,
            BILLINGSUMMARYID,
            BILLINGFROMDATE,
            BILLINGTODATE,
            CUSTOMERID,
            TARIFFID,
            CHARGECATEGORY,
            CHARGETYPE,
            DESCR,
            RATEBASE,
            qty,
            chargeRate,
            AMOUNT,
            BILLINGAMOUNT,
            ARNO,
            APNO,
            COST,
            DOCTYPE,
            DOCNO,
            BILLTO,
            ADDWHO,
            EDITWHO,
            ADDTIME,
            EDITTIME,
            UDF01,
            UDF02,
            UDF04)
              SELECT
                A.ORGANIZATIONID,
                A.WAREHOUSEID,
                R_BILLINGSUMMARYID,
                CURDATE(),
                CURDATE(),
                G.CUSTOMERID,
                B.TARIFFID,
                D.CHARGECATEGORY,
                D.CHARGETYPE,
                D.DESCRC,
                'HOUR',
                r_latehour,
                E.rate,
                r_latehour * E.RATE,
                r_latehour * E.RATE,
                '*',
                '*',
                0,
                'SO',
                A.ldlNo,
                G.CUSTOMERID,
                'UDFTIMER',
                'UDFTIMER',
                NOW(),
                NOW(),
                D.UDF01,
                D.UDF02,
                D.UDF06
              FROM DOC_LOADING_HEADER A
                LEFT JOIN DOC_APPOINTMENT_DETAILS A1
                  ON A.ORGANIZATIONID = A1.ORGANIZATIONID
                  AND A.ldlNo = A1.docNo
                LEFT JOIN DOC_WAVE_DETAILS F
                  ON A.`organizationId` = F.`organizationId`
                  AND A.`warehouseId` = F.`warehouseId`
                  AND A.waveNo = F.waveNo
                LEFT JOIN DOC_ORDER_DETAILS G
                  ON F.`organizationId` = G.`organizationId`
                  AND F.`warehouseId` = G.warehouseId
                  AND F.`orderNo` = G.orderNo
                LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
                  ON A.ORGANIZATIONID = B.ORGANIZATIONID
                  AND G.CUSTOMERID = B.CUSTOMERID
                  AND A.WAREHOUSEID = B.WAREHOUSEID
                  AND B.CUSTOMERTYPE = 'OW'
                LEFT JOIN BIL_TARIFF_HEADER C
                  ON B.ORGANIZATIONID = C.ORGANIZATIONID
                  AND B.TARIFFID = C.TARIFFID
                LEFT JOIN BIL_TARIFF_DETAILS D
                  ON C.ORGANIZATIONID = D.ORGANIZATIONID
                  AND C.TARIFFID = D.TARIFFID
                  AND D.CHARGECATEGORY = 'SP'
                  AND D.CHARGETYPE = 'SF'
                LEFT JOIN BIL_TARIFF_RATE E
                  ON D.ORGANIZATIONID = E.ORGANIZATIONID
                  AND D.TARIFFID = E.TARIFFID
                  AND D.TARIFFLINENO = E.TARIFFLINENO
              WHERE A.ORGANIZATIONID = IN_organizationId
              AND A.WAREHOUSEID = IN_warehouseId
              AND A.ldlNo = r_docNo
              LIMIT 1;
          END IF;
        END IF;
      END IF;
      UPDATE DOC_ARRIVAL_HEADER A
      SET A.udf01 = 'Y'
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.ARRIVALNO = r_ARRIVALNO
      AND A.arrivalStatus NOT IN ('00', '90', '99');
    END LOOP;
    CLOSE CUR_APP;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `OJV_CML_Invoice`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_Invoice (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_billingNo varchar(50),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_Language varchar(100);
    DECLARE R_InvoiceNo varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#OJV_CML_SPUDF_Process1',
      IFNULL(@p1, ''),
      IFNULL(@p2, ''),
      IFNULL(@p3, ''),
      IFNULL(@p4, ''),
      IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_warehouseId;
    END;
    CALL SPCOM_GetIDSequence(IN_organizationId,
    IN_warehouseId,
    IN_Language,
    'INVOICENO',
    R_INVOICENO,
    OUT_returnCode);
    IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;
    UPDATE BIL_BILLING_HEADER
    SET UDF01 = R_INVOICENO
    WHERE ORGANIZATIONID = IN_organizationId
    AND WAREHOUSEID = IN_warehouseId
    AND BILLINGNO = IN_billingNo;
    UPDATE BIL_SUMMARY A
    LEFT JOIN BIL_BILLING_HEADER B
      ON A.`organizationId` = B.`organizationId`
      AND A.`warehouseId` = B.`warehouseId`
      AND A.arNo = B.`billingNo`
    SET A.UDF05 = R_INVOICENO
    WHERE A.`organizationId` = IN_organizationId
    AND A.`warehouseId` = IN_warehouseId
    AND A.arNo = IN_billingNo;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `CML_VAL_TRACEID`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_VAL_TRACEID (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_asnNo varchar(30),
IN IN_sku varchar(30),
IN IN_traceId varchar(50),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN

    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_VAL_TRACEID,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;

    SET OUT_returnCode := '000';
    START TRANSACTION;

      IF IN_traceId <> ''
        OR IN_traceId <> '*' THEN
        UPDATE TSK_TASKLISTS
        SET fmId = IN_traceId
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseID
        AND docNo = IN_asnNo
        AND sku = IN_sku;

        UPDATE ACT_TRANSACTION_LOG
        SET toId = IN_traceId
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseID
        AND docNo = IN_asnNo
        AND fmsku = IN_sku;

        SET OUT_returnCode := '000';
      ELSEIF IN_traceId = ''
        OR IN_traceId = '*' THEN
        SET OUT_returnCode := '*_*';
        CALL SPCOM_GetIDSequence(IN_organizationId, In_warehouseID, 'TRACEID', IN_traceId, OUT_returnCode);
        IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
          LEAVE ENDPROC;
        END IF;
        SET OUT_returnCode := '000';
      END IF;


    COMMIT;
  END
  $$

--
-- Create procedure `CML_SPUDF_ProcessA`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_SPUDF_ProcessA (IN IN_organizationId varchar(20), IN IN_warehouseId varchar(20), IN IN_Parameter1 varchar(200), IN IN_Parameter2 varchar(200), IN IN_Parameter3 varchar(200), IN IN_Parameter4 varchar(200), IN IN_language varchar(20), IN IN_userId varchar(40), INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE R_TRANSACTIONID varchar(100);
    DECLARE v_NO_COMMIT char(1);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CJ_SPUDF_ProcessA,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;


    IF IN_Parameter1 = 'PRE_PTA' THEN
      CALL SPCOM_GetIDSequence(In_organizationId, IN_warehouseId, IN_Language, 'TRANSACTIONID', R_TRANSACTIONID, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE END_PROC;
      END IF;

      INSERT INTO `ACT_TRANSACTION_LOG` (`organizationid`, `warehouseid`, `transactionid`, `transactiontype`, `doctype`, `docno`, `doclineno`, `status`,
      `fmcustomerid`, `fmsku`, `fmlotnum`, `fmlocation`, `fmid`, `fmpackid`, `fmuom`, `fmqty`, `fmqty_each`,
      `tocustomerid`, `tosku`, `tolotnum`, `tolocation`, `toid`, `topackid`, `touom`, `toqty`, `toqty_each`,
      `totalprice`, `totalnetweight`, `totalgrossweight`, `totalcubic`, `transactiontime`, `paflag`, `pataskid`,
      `pasequence`, `qcflag`, `qctaskid`, `qcsequence`, `reason`, `operator`,
      `edisendflag`, `callmodule`, `callworkstation`, `addwho`, `editwho`,
      `fmmuid`, `tomuid`, `addtime`, `edittime`)
        SELECT
          IN_organizationId,
          IN_warehouseId,
          R_TRANSACTIONID,
          'PP',
          doctype,
          docno,
          doclineno,
          '99',
          customerid,
          sku,
          fmlotnum,
          fmlocation,
          fmid,
          fmpackid,
          fmuom,
          fmqty,
          fmqty_each,
          customerid,
          sku,
          plantolotnum,
          IN_Parameter4,
          plantoid,
          plantopackid,
          plantouom,
          plantoqty,
          plantoqty_each,
          totalprice,
          totalnetweight,
          totalgrossweight,
          totalcubic,
          NOW(),
          'Y',
          '',
          '',
          'N',
          '*',
          '0',
          '',
          IN_Userid,
          'O',
          'PRE_PTA',
          '',
          IN_Userid,
          IN_Userid,
          fmmuid,
          plantomuid,
          NOW(),
          NOW()
        FROM TSK_TASKLISTS
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseId
        AND fmId = IN_Parameter2
        AND taskType = 'PA'
        AND taskProcess < '10';

      UPDATE INV_LOT_LOC_ID A
      SET A.locationId = IN_Parameter4,
          editWho = IN_UserId,
          editTime = NOW()
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.traceId = IN_Parameter2
      AND A.qtyPa = 0;

      UPDATE tsk_tasklists A
      SET A.fmLocation = IN_Parameter4,
          A.udf03 = 'Y'
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.fmId = IN_Parameter2
      AND A.taskType = 'PA'
      AND A.taskProcess < '10';
    END IF;

    SET v_error = 1;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_SPSO_RECALC_AF`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SPSO_RECALC_AF (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_orderNo varchar(100),
IN IN_OrderSplit varchar(120),
IN IN_Userid varchar(100),
OUT OUT_ReturnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE R_STATUS varchar(20);
    DECLARE r_SoStatus varchar(20);
    DECLARE R_NROW integer;
    DECLARE R_NROW2 integer;
    DECLARE V_udf01 varchar(100);
    DECLARE V_udf02 varchar(100);
    DECLARE R_CURRENTDATE timestamp;
    DECLARE R_BILLINGSUMMARYID2 varchar(100);
    DECLARE R_FMDATE varchar(10);
    DECLARE R_TODATE varchar(10);
    DECLARE R_FMDATE_D date;
    DECLARE R_TODATE_D date;
    DECLARE R_BILLINGDATE integer;
    DECLARE R_BILLINGMONTH varchar(10);
    DECLARE R_CUSTOMER varchar(30);
    DECLARE R_tariffId varchar(10);
    DECLARE R_tariffLineNo integer;
    DECLARE R_docType varchar(15);
    DECLARE R_minAmount decimal(24, 8);
    DECLARE R_maxAmount decimal(24, 8);
    DECLARE R_chargeCategory varchar(20);
    DECLARE R_chargeType varchar(20);
    DECLARE IN_language varchar(20) DEFAULT 'en';
    DECLARE R_tariffClassNo varchar(15);
    DECLARE R_classFrom decimal(24, 8);
    DECLARE R_classTo decimal(24, 8);
    DECLARE R_rate decimal(24, 8);
    --
    DECLARE R_cusAmount decimal(24, 8);
    DECLARE R_QTY integer;
    -- ????1 ???????? 
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_SPSO_RECALC_AF,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    -- delete the existing records.
    DELETE
      FROM `BIL_SUMMARY`
    WHERE `organizationid` = 'OJV_CML'
      AND `warehouseid` = IN_warehouse
      AND DOCNO = IN_orderNo
      AND RATEBASE = 'DO';
    CALL SPCOM_GetIDSequence(IN_organizationId,
    IN_warehouse,
    IN_language,
    'BILLINGSUMMARYID',
    R_BILLINGSUMMARYID2,
    OUT_ReturnCode);
    IF SUBSTRING(OUT_ReturnCode, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE END_PROC;
    END IF;
    SELECT
      a.customerId INTO R_customer
    FROM DOC_ORDER_DETAILS a
    WHERE a.organizationId = 'OJV_CML'
    AND a.warehouseId = IN_warehouse
    AND a.orderNo = IN_OrderNo
    LIMIT 1;
    SELECT
      IFNULL(b.tariffId, '*') tariffId INTO R_tariffId
    FROM BAS_CUSTOMER_MULTIWAREHOUSE a
      LEFT JOIN BIL_TARIFF_HEADER b
        ON a.organizationId = b.organizationId
        AND a.tariffMasterId = b.tariffMasterId
    WHERE IFNULL(b.tariffId, '*') <> '*'
    AND a.organizationId = 'OJV_CML'
    AND a.warehouseId = IN_warehouse
    AND a.customerId = R_customer
    AND TIMESTAMPDIFF(SECOND, b.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, b.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
    LIMIT 1;
    INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
    WAREHOUSEID,
    BILLINGSUMMARYID,
    BILLINGFROMDATE,
    BILLINGTODATE,
    CUSTOMERID,
    TARIFFID,
    CHARGECATEGORY,
    CHARGETYPE,
    DESCR,
    DOCNO,
    DOCTYPE,
    ORDERTYPE,
    RATEBASE,
    QTY,
    chargeRate,
    AMOUNT,
    BILLINGAMOUNT,
    ARNO,
    APNO,
    UDF01,
    UDF02,
    UDF04,
    COST,
    BILLTO,
    ADDWHO,
    EDITWHO,
    ADDTIME,
    EDITTIME)
      SELECT
        H1.ORGANIZATIONID,
        H1.WAREHOUSEID,
        R_BILLINGSUMMARYID2,
        DATE_FORMAT(H3.CLOSETIME, '%Y-%m-%d'),
        DATE_FORMAT(H3.CLOSETIME, '%Y-%m-%d'),
        H1.CUSTOMERID,
        R_tariffId,
        D.CHARGECATEGORY,
        D.CHARGETYPE,
        D.DESCRC,
        H1.orderNo,
        'SO',
        H2.ORDERTYPE,
        'DO',
        '1',
        E.RATE,
        1 * E.RATE,
        1 * E.RATE,
        '*',
        '*',
        D.UDF01,
        D.UDF02,
        D.udf06,
        0,
        B.CUSTOMERID,
        'UDFTIMER',
        'UDFTIMER',
        H3.CLOSETIME,
        NOW()
      FROM ACT_ALLOCATION_DETAILS H1
        JOIN DOC_ORDER_HEADER H2
          ON H1.ORGANIZATIONID = H2.ORGANIZATIONID
          AND H1.WAREHOUSEID = H2.WAREHOUSEID
          AND H1.CUSTOMERID = H2.CUSTOMERID
          AND H1.ORDERNO = H2.ORDERNO
        JOIN BAS_SKU_MULTIWAREHOUSE B
          ON H1.ORGANIZATIONID = B.ORGANIZATIONID
          AND H1.WAREHOUSEID = B.WAREHOUSEID
          AND H1.CUSTOMERID = B.CUSTOMERID
          AND H1.SKU = B.SKU
        LEFT JOIN DOC_ORDER_HEADER_UDF H3
          ON H2.ORGANIZATIONID = H3.ORGANIZATIONID
          AND H2.WAREHOUSEID = H3.WAREHOUSEID
          AND H2.ORDERNO = H3.ORDERNO
        LEFT JOIN BIL_TARIFF_DETAILS D
          ON B.ORGANIZATIONID = D.ORGANIZATIONID
          AND D.TARIFFID = R_tariffId
          AND D.CHARGECATEGORY = 'OB'
          AND D.docType = H2.orderType
          AND D.RATEBASE = 'DO'
        LEFT JOIN BIL_TARIFF_RATE E
          ON E.ORGANIZATIONID = D.ORGANIZATIONID
          AND E.TARIFFID = D.TARIFFID
          AND E.TARIFFLINENO = D.TARIFFLINENO
      WHERE H1.ORGANIZATIONID = 'OJV_CML'
      AND H1.warehouseId = IN_Warehouse
      AND H1.orderNo = IN_orderNo
      AND D.rateBase = 'DO'
      AND D.TARIFFID = R_tariffId
      GROUP BY H1.orderNo,
               B.customerId,
               D.chargeType,
               D.descrC,
               E.rate,
               D.udf01,
               D.udf02,
               D.udf06;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_SPSO_CLOSE_AF`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SPSO_CLOSE_AF (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_orderNo varchar(100),
IN IN_OrderSplit varchar(120),
IN IN_Userid varchar(100),
OUT OUT_Return_Code varchar(1000))
END_PROC:
  BEGIN
    DECLARE R_STATUS varchar(20);
    DECLARE r_SoStatus varchar(20);
    DECLARE R_NROW integer;
    DECLARE R_NROW2 integer;
    DECLARE V_udf01 varchar(100);
    DECLARE V_udf02 varchar(100);
    DECLARE R_CURRENTDATE timestamp;
    DECLARE R_BILLINGSUMMARYID2 varchar(100);
    DECLARE R_FMDATE varchar(10);
    DECLARE R_TODATE varchar(10);
    DECLARE r_lotAtt07 varchar(10);
    DECLARE r_lotnum varchar(10);
    DECLARE r_transactionId varchar(100);
    DECLARE R_FMDATE_D date;
    DECLARE R_TODATE_D date;
    DECLARE R_BILLINGDATE integer;
    DECLARE R_BILLINGMONTH varchar(10);
    DECLARE R_CUSTOMER varchar(30);
    DECLARE R_tariffId varchar(10);
    DECLARE R_tariffLineNo integer;
    DECLARE R_docType varchar(15);
    DECLARE R_minAmount decimal(24, 8);
    DECLARE R_maxAmount decimal(24, 8);
    DECLARE R_chargeCategory varchar(20);
    DECLARE R_chargeType varchar(20);
    DECLARE IN_language varchar(20) DEFAULT 'en';
    DECLARE R_tariffClassNo varchar(15);
    DECLARE R_classFrom decimal(24, 8);
    DECLARE R_classTo decimal(24, 8);
    DECLARE R_rate decimal(24, 8);
    --
    DECLARE R_cusAmount decimal(24, 8);
    DECLARE R_QTY integer;
    -- ????1 ???????? 
    DECLARE pallet_done int DEFAULT FALSE;
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#CML_SPSO_CLOSE_AF',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;
    BEGIN
      DECLARE CUR_PALLET CURSOR FOR
      SELECT
        a.tolotnum,
        c.lotAtt07,
        a.transactionid
      FROM ACT_TRANSACTION_LOG a
        INNER JOIN INV_LOT_ATT c
          ON a.organizationId = c.organizationId
          AND a.toLotNum = c.lotnum
          AND a.tocustomerId = c.customerId
          AND a.tosku = c.sku
      WHERE a.organizationId = IN_ORGANIZATIONID
      AND a.warehouseId = IN_Warehouse
      AND a.docNo = IN_ORDERNO
      AND a.transactionType = 'SO'
      AND a.docType = 'SO';


      DECLARE CONTINUE HANDLER FOR NOT FOUND SET pallet_done = TRUE;
      OPEN CUR_PALLET;
    getPALLET:
      LOOP
        FETCH CUR_PALLET INTO r_lotnum,
        r_lotAtt07,
        r_transactionId;
        IF pallet_done = TRUE THEN
          LEAVE getPALLET;
        END IF;

        IF r_lotAtt07 = 'O' THEN
          UPDATE ACT_TRANSACTION_LOG a
          SET a.billingTranCategory = 'OP'
          WHERE a.organizationId = IN_ORGANIZATIONID
          AND a.warehouseId = IN_WAREHOUSE
          AND a.docNo = IN_ORDERNO
          AND a.tolotnum = r_lotnum
          AND a.transactionId = r_transactionId
          AND a.transactionType IN ('SO', 'KT', '99')
          AND a.docType = 'SO'
          AND a.status = '99';
        END IF;
        IF r_lotAtt07 = 'R' THEN
          UPDATE ACT_TRANSACTION_LOG a
          SET a.billingTranCategory = 'RP'
          WHERE a.organizationId = IN_ORGANIZATIONID
          AND a.warehouseId = IN_WAREHOUSE
          AND a.docNo = IN_ORDERNO
          AND a.tolotnum = r_lotnum
          AND a.docType = 'SO'
          AND a.transactionId = r_transactionId
          AND a.transactionType IN ('SO', 'KT', '99')
          AND a.status = '99';
        END IF;
      END LOOP getPALLET;
      CLOSE CUR_PALLET;
      COMMIT;
    END;

    --   DELETE 
    --     FROM
    --       `BIL_SUMMARY` 
    --     WHERE `organizationid` = 'OJV_CML' 
    --       AND `warehouseid` = IN_warehouse 
    --       AND DOCNO = IN_orderNo 
    --       AND rateBase = 'DO'; -- 2023/11/14 

    SELECT
      a.customerId INTO R_customer
    FROM DOC_ORDER_DETAILS a
    WHERE a.organizationId = 'OJV_CML'
    AND a.warehouseId = IN_warehouse
    AND a.orderNo = IN_OrderNo
    LIMIT 1;
    SELECT
      IFNULL(b.tariffId, '*') tariffId INTO R_tariffId
    FROM BAS_CUSTOMER_MULTIWAREHOUSE a
      LEFT JOIN BIL_TARIFF_HEADER b
        ON a.organizationId = b.organizationId
        AND a.tariffMasterId = b.tariffMasterId
    WHERE IFNULL(b.tariffId, '*') <> '*'
    AND a.organizationId = 'OJV_CML'
    AND a.warehouseId = IN_warehouse
    AND a.customerId = R_customer
    AND TIMESTAMPDIFF(SECOND, b.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, b.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
    LIMIT 1;
    CALL SPCOM_GetIDSequence(IN_organizationId,
    IN_warehouse,
    IN_language,
    'BILLINGSUMMARYID',
    R_BILLINGSUMMARYID2,
    OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE END_PROC;
    END IF;

    INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
    WAREHOUSEID,
    BILLINGSUMMARYID,
    BILLINGFROMDATE,
    BILLINGTODATE,
    CUSTOMERID,
    TARIFFID,
    CHARGECATEGORY,
    CHARGETYPE,
    DESCR,
    DOCNO,
    DOCTYPE,
    RATEBASE,
    QTY,
    chargeRate,
    AMOUNT,
    BILLINGAMOUNT,
    ARNO,
    APNO,
    UDF01,
    UDF02,
    UDF04,
    COST,
    BILLTO,
    ADDWHO,
    EDITWHO,
    ADDTIME,
    EDITTIME)
      SELECT
        H1.ORGANIZATIONID,
        H1.WAREHOUSEID,
        R_BILLINGSUMMARYID2,
        CURDATE(),
        CURDATE(),
        H1.CUSTOMERID,
        R_tariffid,
        D.CHARGECATEGORY,
        D.CHARGETYPE,
        D.DESCRC,
        H1.orderNo,
        'SO',
        'DO',
        '1',
        E.RATE,
        1 * E.RATE,
        1 * E.RATE,
        '*',
        '*',
        D.UDF01,
        D.UDF02,
        D.udf06,
        0,
        B.CUSTOMERID,
        'UDFTIMER',
        'UDFTIMER',
        NOW(),
        NOW()
      FROM ACT_ALLOCATION_DETAILS H1
        JOIN DOC_ORDER_HEADER H2
          ON H1.ORGANIZATIONID = H2.ORGANIZATIONID
          AND H1.WAREHOUSEID = H2.WAREHOUSEID
          AND H1.CUSTOMERID = H2.CUSTOMERID
          AND H1.ORDERNO = H2.ORDERNO
        JOIN BAS_SKU_MULTIWAREHOUSE B
          ON H1.ORGANIZATIONID = B.ORGANIZATIONID
          AND H1.WAREHOUSEID = B.WAREHOUSEID
          AND H1.CUSTOMERID = B.CUSTOMERID
          AND H1.SKU = B.SKU
        LEFT JOIN BIL_TARIFF_DETAILS D
          ON B.ORGANIZATIONID = D.ORGANIZATIONID
          AND D.CHARGECATEGORY = 'OB'
          AND D.docType = H2.orderType
          AND D.RATEBASE = 'DO'
        LEFT JOIN BIL_TARIFF_RATE E
          ON E.ORGANIZATIONID = D.ORGANIZATIONID
          AND E.TARIFFID = D.TARIFFID
          AND E.TARIFFLINENO = D.TARIFFLINENO
      WHERE H1.ORGANIZATIONID = 'OJV_CML'
      AND H1.warehouseId = IN_Warehouse
      AND H1.orderNo = IN_orderNo
      AND D.tariffid = R_tariffId
      AND D.rateBase = 'DO'
      GROUP BY H1.warehouseId,
               H1.orderNo,
               B.customerId,
               D.chargeType,
               D.descrC,
               E.rate,
               D.udf01,
               D.udf02,
               D.udf06;
    SET OUT_return_Code = '000';
  END
  $$

--
-- Create procedure `CML_KITTING`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE CML_KITTING (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_orderNo varchar(30),
IN IN_user varchar(20),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_qty,
          v_unitprice,
          v_rate,
          v_cubic,
          v_grosswt,
          v_price float;
  DECLARE v_sku,
          v_lot,
          v_trace,
          v_cust,
          v_tariffid,
          v_uom,
          v_vastyp,
          v_billsumaryid varchar(30);
  DECLARE finished integer DEFAULT 0;
  DECLARE bil_tariff_rec CURSOR FOR
  SELECT
    d.tariffid,
    r.rateperUnit * rate,
    r.rate,
    aad.sku,
    aad.lotnum,
    aad.traceid,
    aad.customerId,
    aad.uom,
    aad.qty,
    aad.cubic,
    aad.grossWeight,
    aad.price,
    dov.vastype
  FROM BIL_TARIFF_DETAILS d
    INNER JOIN BIL_TARIFF_RATE r
      ON d.ORGANIZATIONID = r.ORGANIZATIONID
      AND d.WAREHOUSEID = r.warehouseId
      AND d.tariffID = r.tariffid
      AND d.TariffLineNo = r.TariffLineNo
    INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
      ON d.ORGANIZATIONID = bsm.ORGANIZATIONID
      AND d.WAREHOUSEID = bsm.warehouseId
      AND d.tariffId = bsm.tariffId
    INNER JOIN ACT_ALLOCATION_DETAILS aad
      ON aad.ORGANIZATIONID = bsm.ORGANIZATIONID
      AND aad.WAREHOUSEID = bsm.warehouseId
      AND aad.sku = bsm.sku
    INNER JOIN DOC_ORDER_VAS dov
      ON aad.ORGANIZATIONID = dov.ORGANIZATIONID
      AND aad.WAREHOUSEID = dov.warehouseId
      AND aad.orderNo = dov.orderNo
  WHERE d.ORGANIZATIONID = IN_organizationId
  AND d.WAREHOUSEID = IN_warehouseId
  AND dov.orderNo = IN_orderNo
  AND d.chargecategory = 'VA'
  AND d.chargeType = 'KT'
  AND aad.uom = 'EA';
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
  SELECT
    qtyorderedeach INTO v_qty
  FROM DOC_KIT_HEADER h
    JOIN DOC_KIT_DETAILS d
      ON h.kitno = d.kitno
  WHERE h.orderNo = IN_orderno;
  OPEN bil_tariff_rec;
get_tariff_data:
  LOOP
    FETCH bil_tariff_rec INTO v_tariffid, v_unitprice, v_rate, v_sku, v_lot, v_trace, v_cust, v_uom, v_qty, v_cubic, v_grosswt, v_price, v_vastyp;
    IF finished = 1 THEN
      LEAVE get_tariff_data;
    ELSE
      CALL SPCOM_GetIDSequence(IN_organizationId, IN_warehouseId, 'BILLINGSUMMARYID', v_billsumaryid, OUT_returnCode);

      INSERT INTO BIL_SUMMARY (ORGANIZATIONID, WAREHOUSEID, billingsummaryid, billingFromDate, billingtoDate, customerId, sku, lotNum, traceId, tariffId, descr, chargeCategory, chargeType, chargePerUnits, qty, chargeRate, docType, docNo, uom, cubic, weight, addWho, addTime, editWho, editTime, udf01)
        VALUES (IN_organizationId, IN_warehouseId, v_billsumaryid, CURDATE(), CURDATE(), v_cust, v_sku, v_lot, v_trace, v_tariffid, v_vastyp, 'VA', 'KT', v_unitprice, v_qty, v_rate, 'SO', IN_orderNo, v_uom, v_cubic, v_grosswt, IN_user, NOW(), IN_user, NOW(), v_vastyp);
    END IF;
  END LOOP get_tariff_data;
  CLOSE bil_tariff_rec;
  SET OUT_returnCode := '000';
END
$$

--
-- Create procedure `CML_FIX_CHG`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_FIX_CHG (IN IN_warehouseId varchar(20),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_organizationId varchar(100);
    DECLARE r_rateBase varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_Billingdate varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE R_tariffId varchar(100);

    DECLARE r_chargeType varchar(100);

    DECLARE r_fixedAmount varchar(100);

    DECLARE r_customerId varchar(100);
    DECLARE r_CurrentTime date;
    DECLARE r_IncomeTaxRate decimal(18, 8);
    DECLARE v_errormessage varchar(1000);
    DECLARE r_tariffLineNo varchar(100);
    DECLARE v_NO_COMMIT char(1);
    DECLARE v_error int;

    DECLARE CUR_FIX CURSOR FOR
    SELECT DISTINCT
      IFNULL(b.tariffId, '*'),
      a.chargeType,
      a.minAmount,
      a.incomeTaxRate,
      a.rateBase,
      CASE WHEN b.udf02 = ' ' THEN DAY(b.billingDate) ELSE b.udf02 END,
      a.tariffLineNo
    FROM BAS_SKU_MULTIWAREHOUSE c1
      LEFT JOIN BIL_TARIFF_HEADER b
        ON b.`organizationId` = c1.`organizationId`
        AND b.`tariffMasterId` = c1.`tariffMasterId`
      LEFT JOIN BIL_TARIFF_DETAILS a
        ON a.`organizationId` = b.`organizationId`
        AND a.`tariffId` = b.`tariffId`
    WHERE IFNULL(b.tariffId, '*') <> '*'
    AND c1.organizationId = 'OJV_CML'
    AND c1.warehouseId = In_warehouseId
    AND a.chargeCategory = 'FX'
    AND TIMESTAMPDIFF(SECOND, b.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, b.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      SELECT
        CONCAT('999#CML_FIX_CHG,',
        IFNULL(@p1, ''),
        ',',
        IFNULL(@p2, ''),
        ',',
        IFNULL(@p3, ''),
        ',',
        IFNULL(@p4, ''),
        ',',
        IFNULL(@p5, '')) AS outcode;
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;
    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;
    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';
    OPEN CUR_FIX;
    FETCH CUR_FIX INTO R_tariffId,
    r_chargeType,
    r_fixedAmount,
    r_IncomeTaxRate,
    r_rateBase,
    R_Billingdate,
    r_tariffLineNo;
    WHILE
      v_error <> 0 DO
      SET OUT_returnCode = 'NO_COMMIT';
      CALL SPCOM_GetIDSequence(IN_organizationId,
      IN_warehouseId,
      IN_Language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID,
      OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_rateBase = 'DAY' THEN
        INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
        WAREHOUSEID,
        BILLINGSUMMARYID,
        BILLINGFROMDATE,
        BILLINGTODATE,
        CUSTOMERID,
        TARIFFID,
        CHARGECATEGORY,
        CHARGETYPE,
        DESCR,
        RATEBASE,
        chargeRate,
        AMOUNT,
        BILLINGAMOUNT,
        ARNO,
        APNO,
        UDF01, UDF02, UDF04,
        COST,
        BILLTO,
        ADDWHO,
        EDITWHO,
        ADDTIME,
        EDITTIME)
          SELECT
            A.ORGANIZATIONID,
            B.WAREHOUSEID,
            R_BILLINGSUMMARYID,
            CURDATE(),
            CURDATE(),
            B.CUSTOMERID,
            R_tariffId,
            D.CHARGECATEGORY,
            D.CHARGETYPE,
            D.DESCRC,
            'DAY',
            D.minAmount,
            D.minAmount,
            D.minAmount,
            '*',
            '*',
            D.UDF01,
            D.UDF02,
            D.UDF06,
            0,
            B.CUSTOMERID,
            'UDFTIMER',
            'UDFTIMER',
            NOW(),
            NOW()
          FROM BIL_TARIFF_HEADER A
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.TARIFFMASTERID = B.TARIFFMASTERID
              AND B.customerType = 'OW'
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON A.ORGANIZATIONID = D.ORGANIZATIONID
              AND A.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'FX'
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND B.warehouseId = IN_warehouseId
          AND D.rateBase = 'DAY'
          AND A.TARIFFID = R_tariffId
          AND D.CHARGETYPE = r_chargeType
          AND D.tariffLineNo = r_tariffLineNo;
      END IF;

      IF DAY(CURDATE()) = R_Billingdate
        AND r_rateBase = 'MONTH' THEN
        INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
        WAREHOUSEID,
        BILLINGSUMMARYID,
        BILLINGFROMDATE,
        BILLINGTODATE,
        CUSTOMERID,
        TARIFFID,
        CHARGECATEGORY,
        CHARGETYPE,
        DESCR,
        RATEBASE,
        chargeRate,
        AMOUNT,
        BILLINGAMOUNT,
        ARNO,
        APNO,
        COST,
        BILLTO,
        ADDWHO,
        EDITWHO,
        ADDTIME,
        EDITTIME,
        UDF01,
        UDF02,
        UDF04)
          SELECT
            A.ORGANIZATIONID,
            B.WAREHOUSEID,
            R_BILLINGSUMMARYID,
            CURDATE(),
            CURDATE(),
            B.CUSTOMERID,
            R_tariffId,
            D.CHARGECATEGORY,
            D.CHARGETYPE,
            D.DESCRC,
            'MONTH',
            D.minAmount,
            D.minAmount,
            D.minAmount,
            '*',
            '*',
            0,
            B.CUSTOMERID,
            'UDFTIMER',
            'UDFTIMER',
            NOW(),
            NOW(),
            D.UDF01,
            D.UDF02,
            D.UDF06
          FROM BIL_TARIFF_HEADER A
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.TARIFFMASTERID = B.TARIFFMASTERID
              AND B.customerType = 'OW'
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON A.ORGANIZATIONID = D.ORGANIZATIONID
              AND A.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'FX'
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND B.warehouseId = IN_warehouseId
          AND D.rateBase = 'MONTH'
          AND DAY(CURDATE()) = R_Billingdate
          AND A.TARIFFID = R_tariffId
          AND D.CHARGETYPE = r_chargeType
          AND D.tariffLineNo = r_tariffLineNo;
      END IF;

      IF DAY(CURDATE()) = R_Billingdate
        AND r_rateBase NOT IN ('MONTH', 'DAY') /*AB 25/02/03*/
      THEN
        INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
        WAREHOUSEID,
        BILLINGSUMMARYID,
        BILLINGFROMDATE,
        BILLINGTODATE,
        CUSTOMERID,
        TARIFFID,
        CHARGECATEGORY,
        CHARGETYPE,
        DESCR,
        RATEBASE,
        chargeRate,
        AMOUNT,
        BILLINGAMOUNT,
        ARNO,
        APNO,
        COST,
        BILLTO,
        ADDWHO,
        EDITWHO,
        ADDTIME,
        EDITTIME,
        UDF01,
        UDF02,
        UDF04)
          SELECT
            A.ORGANIZATIONID,
            B.WAREHOUSEID,
            R_BILLINGSUMMARYID,
            CURDATE(),
            CURDATE(),
            B.CUSTOMERID,
            R_tariffId,
            D.CHARGECATEGORY,
            D.CHARGETYPE,
            D.DESCRC,
            r_ratebase,
            D.minAmount,
            D.minAmount,
            D.minAmount,
            '*',
            '*',
            0,
            B.CUSTOMERID,
            'UDFTIMER',
            'UDFTIMER',
            NOW(),
            NOW(),
            D.UDF01,
            D.UDF02,
            D.UDF06
          FROM BIL_TARIFF_HEADER A
            LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
              ON A.ORGANIZATIONID = B.ORGANIZATIONID
              AND A.TARIFFMASTERID = B.TARIFFMASTERID
              AND B.customerType = 'OW'
            LEFT JOIN BIL_TARIFF_DETAILS D
              ON A.ORGANIZATIONID = D.ORGANIZATIONID
              AND A.TARIFFID = D.TARIFFID
              AND D.CHARGECATEGORY = 'FX'
          WHERE A.ORGANIZATIONID = IN_organizationId
          AND B.warehouseId = IN_warehouseId
          AND D.rateBase = r_ratebase
          AND DAY(CURDATE()) = R_Billingdate
          AND A.TARIFFID = R_tariffId
          AND D.CHARGETYPE = r_chargeType
          AND D.tariffLineNo = r_tariffLineNo;
      END IF;
      SET v_error = 1;
      FETCH CUR_FIX INTO R_tariffId,
      r_chargeType,
      r_fixedAmount,
      r_IncomeTaxRate,
      r_rateBase,
      R_Billingdate,
      r_tariffLineNo;
    END WHILE;
    CLOSE CUR_FIX;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `OJV_CML_SPUDF_Process3`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPUDF_Process3 (IN IN_warehouseId varchar(20),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    BEGIN
      DECLARE v_error int;
      DECLARE v_nrow int;
      DECLARE v_errormessage varchar(1000);
      DECLARE v_NO_COMMIT char(1);

      DECLARE IN_organizationId varchar(30);

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
      DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        GET DIAGNOSTICS CONDITION 1
        @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

        SELECT
          CONCAT('999#OJV_CML_SPUDF_Process3,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
        SELECT
          v_errormessage AS error;
      END;

      SET v_error = 1;
      IF OUT_returnCode = 'NO_COMMIT'
        OR OUT_returnCode = '*_*' THEN
        SET v_NO_COMMIT = 'N';
      ELSE
        SET v_NO_COMMIT = 'Y';
      END IF;

      SET OUT_returnCode = 'NO_COMMIT';
      CALL CML_FIX_CHG(IN_warehouseId, IN_userId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE END_PROC;
      END IF;


      SET OUT_returnCode := '000';
    END;

  END
  $$

--
-- Create procedure `CML_DO_CHG`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_DO_CHG (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userid varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE IN_organizationId varchar(100) DEFAULT 'OJV_CML';
    DECLARE R_COUNTDOC varchar(100);
    DECLARE R_DOCTYPE varchar(100);
    DECLARE R_tariffId varchar(10);
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE r_customerId varchar(100);
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SELECT
        CONCAT('999#CML_DO_CHG,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;
    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;



    SET IN_organizationId := 'OJV_CML';
    SET IN_Language = 'en';
    SELECT
      IFNULL(b.tariffId, '*') tariffId INTO R_tariffId
    FROM BAS_CUSTOMER_MULTIWAREHOUSE a
      LEFT JOIN BIL_TARIFF_HEADER b
        ON a.organizationId = b.organizationId
        AND a.tariffMasterId = b.tariffMasterId
    WHERE IFNULL(b.tariffId, '*') <> '*'
    AND a.organizationId = 'OJV_CML'
    AND a.warehouseId = 'CBT01'
    AND a.customerId = 'BCAFIN'
    AND TIMESTAMPDIFF(SECOND, b.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, b.effectiveTo, NOW()) / (60 * 60 * 24) <= 0
    LIMIT 1;
    CALL SPCOM_GetIDSequence(IN_organizationId,
    IN_warehouseId,
    IN_Language,
    'BILLINGSUMMARYID',
    R_BILLINGSUMMARYID,
    OUT_returnCode);
    IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE END_PROC;
    END IF;

    -- COUNT according to order qty
    IF R_DOCTYPE = 'SO' THEN
      INSERT INTO BIL_SUMMARY (ORGANIZATIONID,
      WAREHOUSEID,
      BILLINGSUMMARYID,
      BILLINGFROMDATE,
      BILLINGTODATE,
      CUSTOMERID,
      TARIFFID,
      CHARGECATEGORY,
      CHARGETYPE,
      DESCR,
      RATEBASE,
      QTY,
      chargeRate,
      AMOUNT,
      BILLINGAMOUNT,
      ARNO,
      APNO,
      UDF01,
      UDF02,
      COST,
      BILLTO,
      ADDWHO,
      EDITWHO,
      ADDTIME,
      EDITTIME)
        SELECT
          A.ORGANIZATIONID,
          B.WAREHOUSEID,
          R_BILLINGSUMMARYID,
          CURDATE(),
          CURDATE(),
          B.CUSTOMERID,
          R_tariffId,
          D.CHARGECATEGORY,
          D.CHARGETYPE,
          D.DESCRC,
          'DO',
          '1',
          E.RATE,
          1 * E.RATE,
          1 * E.RATE,
          '*',
          '*',
          D.UDF01,
          D.UDF02,
          0,
          B.CUSTOMERID,
          'UDFTIMER',
          'UDFTIMER',
          NOW(),
          NOW()
        FROM BIL_TARIFF_HEADER A
          LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
            ON A.ORGANIZATIONID = B.ORGANIZATIONID
            AND A.TARIFFMASTERID = B.TARIFFMASTERID
            AND B.CUSTOMERTYPE = 'OW'
          LEFT JOIN BIL_TARIFF_DETAILS D
            ON A.ORGANIZATIONID = D.ORGANIZATIONID
            AND A.TARIFFID = D.TARIFFID
            AND D.CHARGECATEGORY = 'OB'
            AND D.RATEBASE = 'DO'
          LEFT JOIN BIL_TARIFF_RATE E
            ON E.ORGANIZATIONID = D.ORGANIZATIONID
            AND E.TARIFFID = D.TARIFFID
            AND E.TARIFFLINENO = D.TARIFFLINENO
        WHERE A.ORGANIZATIONID = IN_organizationId
        AND B.warehouseId = IN_warehouseId
        AND D.rateBase = 'DO'
        AND B.CUSTOMERID = r_customerId;
    END IF;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `OJV_CML_SPUDF_Process5`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPUDF_Process5 (IN IN_warehouseId varchar(20),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    BEGIN
      DECLARE v_error int;
      DECLARE v_nrow int;
      DECLARE v_errormessage varchar(1000);
      DECLARE v_NO_COMMIT char(1);
      DECLARE IN_organizationId varchar(30);

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
      DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        GET DIAGNOSTICS CONDITION 1
        @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

        SELECT
          CONCAT('999#OJV_CML_SPUDF_Process5,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
        SELECT
          v_errormessage AS error;
      END;

      SET v_error = 1;
      IF OUT_returnCode = 'NO_COMMIT'
        OR OUT_returnCode = '*_*' THEN
        SET v_NO_COMMIT = 'N';
      ELSE
        SET v_NO_COMMIT = 'Y';
      END IF;

      SET OUT_returnCode = 'NO_COMMIT';
      CALL CML_DO_CHG(IN_organizationId, IN_warehouseId, IN_userId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE END_PROC;
      END IF;

      SET OUT_returnCode := '000';
    END;

  END
  $$

--
-- Create procedure `BILL_STORAGE_DETAIL_NEW3`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE BILL_STORAGE_DETAIL_NEW3 (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
INOUT OUT_returnCode varchar(1000))
BEGIN
  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;

  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  ##????
  DECLARE inventory_done int DEFAULT FALSE;
  DECLARE tariff_done int DEFAULT FALSE;
  DECLARE cur_Tariff CURSOR FOR
  SELECT DISTINCT
    bsm.organizationId,
    bsm.warehouseId,
    bsm.CUSTOMERID,
    DAY(bth.billingdate) billingDate,
    btr.tariffId,
    btr.tariffLineNo,
    btr.tariffClassNo,
    btd.chargeCategory,
    btd.chargeType,
    btd.descrC,
    btd.ratebase,
    btr.ratePerUnit,
    btr.rate,
    btd.minAmount,
    btd.maxAmount,
    IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
    btd.UDF01 AS MaterialNo,
    btd.udf02 AS itemChargeCategory,
    btd.udf04 billMode,
    locationCategory,
    btd.UDF05,
    btd.UDF06,
    btd.UDF07,
    btd.UDF08,
    IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
    CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
    IFNULL(classTo, 0),
    bth.contractNo,
    bth.tariffMasterId,
    btr.cost,
    btd.billingParty
  FROM BAS_SKU_MULTIWAREHOUSE bsm
    INNER JOIN BAS_CUSTOMER bc
      ON bc.customerId = bsm.customerId
      AND bc.organizationId = bsm.organizationId
      AND bc.CustomerType = 'OW'
    INNER JOIN BIL_TARIFF_HEADER bth
      ON bth.organizationId = bsm.organizationId
      AND bth.tariffMasterId = bsm.tariffMasterId
    INNER JOIN BIL_TARIFF_DETAILS btd
      ON btd.organizationId = bth.organizationId
      AND btd.tariffId = bth.tariffId
    INNER JOIN BIL_TARIFF_RATE btr
      ON btr.organizationId = btd.organizationId
      AND btr.tariffId = btd.tariffId
      AND btr.tariffLineNo = btd.tariffLineNo
  WHERE bsm.organizationId = IN_organizationId
  AND bsm.warehouseId = IN_warehouseId
  AND bsm.customerId LIKE IN_CustomerId
  AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND btd.chargeCategory = 'IV'
  AND btr.rate > 0
  #AND IFNULL(DAY(bth.billingdate),0)!=0 
  ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;
  ####################################################################
  ##????
  BEGIN
    SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
    #
    OPEN cur_Tariff;
  getTariff:
    LOOP
      FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC,
      R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
      R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY;
      IF tariff_done THEN
        SET tariff_done = FALSE;
        LEAVE getTariff;
      END IF;
      #
      SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
      SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
      #SET R_FMDATE = DATE_FORMAT(R_BILLINGDATE, '%Y-%m-%d');
      #SET R_TODATE =DATE_FORMAT(R_BILLINGDATE, '%Y-%m-%d');

      SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
      SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);

      SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
      SET R_billsummaryId = '';
      #
      IF R_BILLINGPARTY = 'BI' THEN
        SET R_BILLTO = R_CustomerId;
        SELECT
          CUSTOMERID INTO R_BILLTO
        FROM BAS_CUSTOMER
        WHERE refOwner = R_CustomerId
        AND CustomerType = 'BI'
        LIMIT 1;
      ELSE
        SET R_BILLTO = R_CustomerId;
      END IF;
      #
      IF (R_BILLINGDATE = R_CURRENTDATE) THEN
      BEGIN
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFO1;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY_INFO1 (
          organizationId varchar(20),
          warehouseId varchar(20),
          StockDate date DEFAULT NULL,
          customerId varchar(30),
          qtyMuid int(11) DEFAULT 0,
          qtyTrace int(11) DEFAULT 0,
          qtyLoc int(11) DEFAULT 0,
          qtyCube decimal(24, 8) DEFAULT 0
        );
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFO2;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY_INFO2 (
          organizationId varchar(20),
          warehouseId varchar(20),
          customerId varchar(30),
          qtyonHand decimal(24, 8) DEFAULT 0
        );

        #?????????????
        CASE
          WHEN R_billMode IN ('INTRACE', 'INPL', 'INLOC') THEN BEGIN
              INSERT INTO TMP_BIL_SUMMARY_INFO1 (organizationId, warehouseId, StockDate, customerId, qtyLoc, qtyTrace, qtyMuid, qtyCube)
                SELECT
                  a.organizationId,
                  a.warehouseId,
                  R_TODATE,
                  a.customerId,
                  COUNT(DISTINCT a.locationId),
                  COUNT(DISTINCT a.traceId),
                  COUNT(DISTINCT a.muid),
                  SUM(a.totalCube)
                FROM (SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    zib.locationId,
                    zib.traceId,
                    zib.muid,
                    zib.totalCube
                  FROM Z_InventoryBalance_Real zib
                    INNER JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.lotNum = zib.LotNum
                    INNER JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                  #
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.StockDate = R_OPDATE
                  AND zib.customerId = R_CUSTOMERID
                  AND (ila.lotAtt07 = 'R'
                  OR R_CHARGETYPE <> 'PL')
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND (ISNULL(R_UDF08)
                  OR R_UDF08 = ''
                  OR bl.locGroup1 = R_UDF08)
                  ##
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    atl.toLocation AS locationId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    atl.totalCubic
                  FROM ACT_TRANSACTION_LOG atl
                    INNER JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    INNER JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    INNER JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  #
                  WHERE atl.organizationId = R_ORGANIZATIONID
                  AND atl.warehouseId = R_WAREHOUSEID
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND atl.transactionTime >= STR_TO_DATE(R_FMDATE, '%Y-%m-%d')
                  AND ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND (ila.lotAtt07 = 'R'
                  OR R_CHARGETYPE <> 'PL')
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND (ISNULL(R_UDF08)
                  OR R_UDF08 = ''
                  OR bl.locGroup1 = R_UDF08)) a
                GROUP BY a.organizationId,
                         a.warehouseId,
                         a.customerId
              ;
            #
            END;
          ELSE BEGIN
            INSERT INTO TMP_BIL_SUMMARY_INFO1 (organizationId, warehouseId, StockDate, customerId, qtyLoc, qtyTrace, qtyMuid, qtyCube)
              SELECT
                zib.organizationId,
                zib.warehouseId,
                zib.StockDate,
                zib.customerId,
                COUNT(DISTINCT zib.locationId),
                COUNT(DISTINCT zib.traceId),
                COUNT(DISTINCT zib.muid),
                SUM(zib.totalCube)
              FROM Z_InventoryBalance_Real zib
                INNER JOIN INV_LOT_ATT ila
                  ON ila.organizationId = zib.organizationId
                  AND ila.lotNum = zib.LotNum
                INNER JOIN BAS_LOCATION bl
                  ON bl.organizationId = zib.organizationId
                  AND bl.warehouseId = zib.warehouseId
                  AND bl.locationId = zib.locationId
                INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
                  ON bsm.organizationId = zib.organizationId
                  AND bsm.warehouseId = zib.warehouseId
                  AND bsm.customerId = zib.customerId
                  AND bsm.SKU = zib.sku
              #
              WHERE zib.organizationId = R_ORGANIZATIONID
              AND zib.warehouseId = R_WAREHOUSEID
              AND zib.StockDate >= R_FMDATE
              AND zib.StockDate <= R_TODATE
              AND zib.customerId = R_CUSTOMERID
              AND (ila.lotAtt07 = 'R'
              OR R_CHARGETYPE <> 'PL')
              AND bsm.tariffMasterId = R_TARIFFMASTERID
              AND (ISNULL(R_LOCATIONCAT)
              OR R_LOCATIONCAT = ''
              OR bl.locationCategory = R_LOCATIONCAT)
              AND (ISNULL(R_LOCATIONGROUP)
              OR R_LOCATIONGROUP = ''
              OR bl.udf05 = R_LOCATIONGROUP)
              AND (ISNULL(R_UDF08)
              OR R_UDF08 = ''
              OR bl.locGroup1 = R_UDF08)
              GROUP BY zib.organizationId,
                       zib.warehouseId,
                       zib.StockDate,
                       zib.customerId
            ;
          #
          END;
        END CASE;

        #??????????
        IF R_billMode IN ('MAXLOC', 'INLOC') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              MAX(IF(tb.qtyLoc >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyLoc - R_CLASSFROM < R_minQty, R_minQty, tb.qtyLoc - R_CLASSFROM)))
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyLoc > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MAXTRACE', 'INTRACE') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              MAX(IF(tb.qtyTrace >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyTrace - R_CLASSFROM < R_minQty, R_minQty, tb.qtyTrace - R_CLASSFROM)))
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyTrace > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MAXPL', 'INPL') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              MAX(IF(tb.qtyMuid >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyMuid - R_CLASSFROM < R_minQty, R_minQty, tb.qtyMuid - R_CLASSFROM)))
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyMuid > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MONTHLOC') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyLoc >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyLoc - R_CLASSFROM < R_minQty, R_minQty, tb.qtyLoc - R_CLASSFROM))) / IF(R_UDF07 = 'Y', R_Days, 1)
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyLoc > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MONTHTRACE') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyTrace >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyTrace - R_CLASSFROM < R_minQty, R_minQty, tb.qtyTrace - R_CLASSFROM))) / IF(R_UDF07 = 'Y', R_Days, 1)
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyTrace > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MONTHPL') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyMuid >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyMuid - R_CLASSFROM < R_minQty, R_minQty, tb.qtyMuid - R_CLASSFROM))) / IF(R_UDF07 = 'Y', R_Days, 1)
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyMuid > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('AVGCBM') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyCube >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyCube - R_CLASSFROM < R_minQty, R_minQty, tb.qtyCube - R_CLASSFROM))) / R_Days
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyCube > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('DAILYCBM') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyCube >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyCube - R_CLASSFROM < R_minQty, R_minQty, tb.qtyCube - R_CLASSFROM)))
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyCube > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSE
          SELECT
            CONCAT('Bill Mode : ', R_billMode, ' not found.') AS Message;
        END IF;

        #????
        IF EXISTS (SELECT
              1
            FROM TMP_BIL_SUMMARY_INFO2) THEN
          #
          IF EXISTS (SELECT
                1
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*')) THEN
            INSERT INTO BIL_SUMMARY_LOG
              SELECT
                *
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
            DELETE
              FROM BIL_SUMMARY
            WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
          END IF;
          #
          IF (R_billsummaryId = '') THEN
            SET @linenumber = 0;
            SET OUT_returnCode = '*_*';
            CALL SPCOM_GetIDSequence(R_ORGANIZATIONID, R_WAREHOUSEID, IN_Language, 'BILLINGSUMMARYID', R_billsummaryId, OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              SET OUT_returnCode = '999#????????';
              LEAVE getTariff;
            END IF;
          END IF;
          #
          INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
          , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
          , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
          , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
          , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
          , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
          , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
          , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
          , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
          , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
            SELECT
              bil.organizationId,
              bil.warehouseId,
              CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
              R_BILLINGDATE billingFromDate,
              R_BILLINGDATE billingToDate,
              bil.customerId,
              '',
              '',
              '',
              R_TARIFFID,
              R_CHARGECATEGORY,
              R_chargetype,
              R_descrC,
              R_rateBase,
              R_rateperunit,
              qtyonHand,
              'PL' uom,
              IF(R_billMode LIKE '%CBM', qtyonHand, 0) cubic,
              0 weight,
              R_rate,
              qtyonHand * R_rate / R_rateperunit,
              qtyonHand * R_rate / R_rateperunit + qtyonHand * R_rate / R_rateperunit * R_INCOMETAX,
              0,
              R_cost * qtyonHand,
              0,
              NOW() confirmTime,
              '' confirmWho,
              '' docType,
              '' docNo,
              '' createTransactionid,
              '' notes,
              NOW() ediSendTime,
              R_BILLTO billTo,
              NOW() settleTime,
              '' settleWho,
              '' followUp,
              '' invoiceType,
              '' paidTo,
              '' costConfirmFlag,
              NOW() costConfirmTime,
              '' costConfirmWho,
              '' costSettleFlag,
              NOW() costSettleTime,
              '' costSettleWho,
              0 incomeTaxRate,
              0 costTaxRate,
              R_INCOMETAX incomeTax,
              0 cosTax,
              qtyonHand * R_rate / R_rateperunit incomeWithoutTax,
              0 cosWithoutTax,
              '' costInvoiceType,
              '' noteText,
              R_materialNo AS udf01,
              R_itemChargeCategory AS udf02,
              R_UDF08 udf03,
              R_UDF06 udf04,
              R_UDF07 udf05,
              0 currentVersion,
              '2020' oprSeqFlag,
              IN_USERID addWho,
              NOW() ADDTIME,
              IN_USERID editWho,
              NOW() editTime,
              R_LOCATIONCAT locationCategory,
              '' manual,
              0 lineCount,
              '*' arNo,
              0 arLineNo,
              '*' apNo,
              0 apLineNo,
              'N' ediSendFlag,
              '' ediErrorCode,
              '' ediErrorMessage,
              NOW() ediSendTime2,
              'N' ediSendFlag2,
              '' ediErrorCode2,
              '' ediErrorMessage2,
              '' billingTranCategory,
              '' orderType,
              '' containerType,
              '' containerSize
            FROM TMP_BIL_SUMMARY_INFO2 bil
          ;

        END IF;

        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFO1;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFO2;
      END;
      END IF;
    END LOOP getTariff;
    CLOSE cur_Tariff;
    SET OUT_returnCode = '000';
  END;
END
$$

--
-- Create procedure `BILL_STORAGE_DETAIL_NEW`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE BILL_STORAGE_DETAIL_NEW (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
INOUT OUT_returnCode varchar(1000))
BEGIN
  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  ##????
  DECLARE inventory_done int DEFAULT FALSE;
  DECLARE tariff_done int DEFAULT FALSE;
  DECLARE cur_Tariff CURSOR FOR
  SELECT DISTINCT
    bsm.organizationId,
    bsm.warehouseId,
    bsm.CUSTOMERID,
    DAY(bth.billingdate) billingDate,
    btr.tariffId,
    btr.tariffLineNo,
    btr.tariffClassNo,
    btd.chargeCategory,
    btd.chargeType,
    btd.descrC,
    btd.ratebase,
    btr.ratePerUnit,
    btr.rate,
    btd.minAmount,
    btd.maxAmount,
    IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
    btd.UDF01 AS MaterialNo,
    btd.udf02 AS itemChargeCategory,
    btd.udf04 billMode,
    locationCategory,
    btd.UDF05,
    btd.UDF06,
    btd.UDF07,
    btd.UDF08,
    IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
    CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
    IFNULL(classTo, 0),
    bth.contractNo,
    bth.tariffMasterId,
    btr.cost,
    btd.billingParty
  FROM BAS_SKU_MULTIWAREHOUSE bsm
    INNER JOIN BAS_CUSTOMER bc
      ON bc.customerId = bsm.customerId
      AND bc.organizationId = bsm.organizationId
      AND bc.CustomerType = 'OW'
    INNER JOIN BIL_TARIFF_HEADER bth
      ON bth.organizationId = bsm.organizationId
      AND bth.tariffMasterId = bsm.tariffMasterId
    INNER JOIN BIL_TARIFF_DETAILS btd
      ON btd.organizationId = bth.organizationId
      AND btd.tariffId = bth.tariffId
    INNER JOIN BIL_TARIFF_RATE btr
      ON btr.organizationId = btd.organizationId
      AND btr.tariffId = btd.tariffId
      AND btr.tariffLineNo = btd.tariffLineNo
  WHERE bsm.organizationId = IN_organizationId
  AND bsm.warehouseId = IN_warehouseId
  AND bsm.customerId LIKE IN_CustomerId
  AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND btd.chargeCategory = 'IV'
  AND btr.rate > 0
  #AND IFNULL(DAY(bth.billingdate),0)!=0 
  ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;
  ####################################################################
  ##????
  BEGIN
    SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
    #
    OPEN cur_Tariff;
  getTariff:
    LOOP
      FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC,
      R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
      R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY;
      IF tariff_done THEN
        SET tariff_done = FALSE;
        LEAVE getTariff;
      END IF;
      #
      SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
      SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
      #SET R_FMDATE = DATE_FORMAT(R_BILLINGDATE, '%Y-%m-%d');
      #SET R_TODATE =DATE_FORMAT(R_BILLINGDATE, '%Y-%m-%d');

      SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
      SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);

      SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
      SET R_billsummaryId = '';
      #
      IF R_BILLINGPARTY = 'BI' THEN
        SET R_BILLTO = R_CustomerId;
        SELECT
          CUSTOMERID INTO R_BILLTO
        FROM BAS_CUSTOMER
        WHERE refOwner = R_CustomerId
        AND CustomerType = 'BI'
        LIMIT 1;
      ELSE
        SET R_BILLTO = R_CustomerId;
      END IF;
      #
      IF (R_BILLINGDATE = R_CURRENTDATE) THEN
      BEGIN
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFO1;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY_INFO1 (
          organizationId varchar(20),
          warehouseId varchar(20),
          StockDate date DEFAULT NULL,
          customerId varchar(30),
          qtyMuid int(11) DEFAULT 0,
          qtyTrace int(11) DEFAULT 0,
          qtyLoc int(11) DEFAULT 0,
          qtyCube decimal(24, 8) DEFAULT 0
        );
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFO2;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY_INFO2 (
          organizationId varchar(20),
          warehouseId varchar(20),
          customerId varchar(30),
          qtyonHand decimal(24, 8) DEFAULT 0
        );

        #?????????????
        CASE
          WHEN R_billMode IN ('INTRACE', 'INPL', 'INLOC') THEN BEGIN
              INSERT INTO TMP_BIL_SUMMARY_INFO1 (organizationId, warehouseId, StockDate, customerId, qtyLoc, qtyTrace, qtyMuid, qtyCube)
                SELECT
                  a.organizationId,
                  a.warehouseId,
                  R_TODATE,
                  a.customerId,
                  COUNT(DISTINCT a.locationId),
                  COUNT(DISTINCT a.traceId),
                  COUNT(DISTINCT a.muid),
                  SUM(a.totalCube)
                FROM (SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    zib.locationId,
                    zib.traceId,
                    zib.muid,
                    zib.totalCube
                  FROM Z_InventoryBalance_Real zib
                    INNER JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.lotNum = zib.LotNum
                    INNER JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                  #
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.StockDate = R_OPDATE
                  AND zib.customerId = R_CUSTOMERID
                  AND (ila.lotAtt07 = 'R'
                  OR R_CHARGETYPE <> 'PL')
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND (ISNULL(R_UDF08)
                  OR R_UDF08 = ''
                  OR bl.locGroup1 = R_UDF08)
                  ##
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    atl.toLocation AS locationId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    atl.totalCubic
                  FROM ACT_TRANSACTION_LOG atl
                    INNER JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    INNER JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    INNER JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  #
                  WHERE atl.organizationId = R_ORGANIZATIONID
                  AND atl.warehouseId = R_WAREHOUSEID
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND atl.transactionTime >= STR_TO_DATE(R_FMDATE, '%Y-%m-%d')
                  AND ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND (ila.lotAtt07 = 'R'
                  OR R_CHARGETYPE <> 'PL')
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND (ISNULL(R_UDF08)
                  OR R_UDF08 = ''
                  OR bl.locGroup1 = R_UDF08)) a
                GROUP BY a.organizationId,
                         a.warehouseId,
                         a.customerId
              ;
            #
            END;
          ELSE BEGIN
            INSERT INTO TMP_BIL_SUMMARY_INFO1 (organizationId, warehouseId, StockDate, customerId, qtyLoc, qtyTrace, qtyMuid, qtyCube)
              SELECT
                zib.organizationId,
                zib.warehouseId,
                zib.StockDate,
                zib.customerId,
                COUNT(DISTINCT zib.locationId),
                COUNT(DISTINCT zib.traceId),
                COUNT(DISTINCT zib.muid),
                SUM(zib.totalCube)
              FROM Z_InventoryBalance_Real zib
                INNER JOIN INV_LOT_ATT ila
                  ON ila.organizationId = zib.organizationId
                  AND ila.lotNum = zib.LotNum
                INNER JOIN BAS_LOCATION bl
                  ON bl.organizationId = zib.organizationId
                  AND bl.warehouseId = zib.warehouseId
                  AND bl.locationId = zib.locationId
                INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
                  ON bsm.organizationId = zib.organizationId
                  AND bsm.warehouseId = zib.warehouseId
                  AND bsm.customerId = zib.customerId
                  AND bsm.SKU = zib.sku
              #
              WHERE zib.organizationId = R_ORGANIZATIONID
              AND zib.warehouseId = R_WAREHOUSEID
              AND zib.StockDate >= R_FMDATE
              AND zib.StockDate <= R_TODATE
              AND zib.customerId = R_CUSTOMERID
              AND (ila.lotAtt07 = 'R'
              OR R_CHARGETYPE <> 'PL')
              AND bsm.tariffMasterId = R_TARIFFMASTERID
              AND (ISNULL(R_LOCATIONCAT)
              OR R_LOCATIONCAT = ''
              OR bl.locationCategory = R_LOCATIONCAT)
              AND (ISNULL(R_LOCATIONGROUP)
              OR R_LOCATIONGROUP = ''
              OR bl.udf05 = R_LOCATIONGROUP)
              AND (ISNULL(R_UDF08)
              OR R_UDF08 = ''
              OR bl.locGroup1 = R_UDF08)
              GROUP BY zib.organizationId,
                       zib.warehouseId,
                       zib.StockDate,
                       zib.customerId
            ;
          #
          END;
        END CASE;

        #??????????
        IF R_billMode IN ('MAXLOC', 'INLOC') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              MAX(IF(tb.qtyLoc >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyLoc - R_CLASSFROM < R_minQty, R_minQty, tb.qtyLoc - R_CLASSFROM)))
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyLoc > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MAXTRACE', 'INTRACE') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              MAX(IF(tb.qtyTrace >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyTrace - R_CLASSFROM < R_minQty, R_minQty, tb.qtyTrace - R_CLASSFROM)))
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyTrace > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MAXPL', 'INPL') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              MAX(IF(tb.qtyMuid >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyMuid - R_CLASSFROM < R_minQty, R_minQty, tb.qtyMuid - R_CLASSFROM)))
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyMuid > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MONTHLOC') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyLoc >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyLoc - R_CLASSFROM < R_minQty, R_minQty, tb.qtyLoc - R_CLASSFROM))) / IF(R_UDF07 = 'Y', R_Days, 1)
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyLoc > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MONTHTRACE') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyTrace >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyTrace - R_CLASSFROM < R_minQty, R_minQty, tb.qtyTrace - R_CLASSFROM))) / IF(R_UDF07 = 'Y', R_Days, 1)
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyTrace > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('MONTHPL') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyMuid >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyMuid - R_CLASSFROM < R_minQty, R_minQty, tb.qtyMuid - R_CLASSFROM))) / IF(R_UDF07 = 'Y', R_Days, 1)
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyMuid > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('AVGCBM') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyCube >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyCube - R_CLASSFROM < R_minQty, R_minQty, tb.qtyCube - R_CLASSFROM))) / R_Days
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyCube > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSEIF R_billMode IN ('DAILYCBM') THEN
        BEGIN
          INSERT INTO TMP_BIL_SUMMARY_INFO2 (organizationId, warehouseId, customerId, qtyonHand)
            SELECT
              tb.organizationId,
              tb.warehouseId,
              tb.customerId,
              SUM(IF(tb.qtyCube >= R_CLASSTO, R_CLASSTO - R_CLASSFROM, IF(tb.qtyCube - R_CLASSFROM < R_minQty, R_minQty, tb.qtyCube - R_CLASSFROM)))
            FROM TMP_BIL_SUMMARY_INFO1 tb
            WHERE tb.qtyCube > R_CLASSFROM
            GROUP BY tb.organizationId,
                     tb.warehouseId,
                     tb.customerId;
        END;
        ELSE
          SELECT
            CONCAT('Bill Mode : ', R_billMode, ' not found.') AS Message;
        END IF;

        #????
        IF EXISTS (SELECT
              1
            FROM TMP_BIL_SUMMARY_INFO2) THEN
          #
          IF EXISTS (SELECT
                1
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*')) THEN
            INSERT INTO BIL_SUMMARY_LOG
              SELECT
                *
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
            DELETE
              FROM BIL_SUMMARY
            WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
          END IF;
          #
          IF (R_billsummaryId = '') THEN
            SET @linenumber = 0;
            SET OUT_returnCode = '*_*';
            CALL SPCOM_GetIDSequence(R_ORGANIZATIONID, R_WAREHOUSEID, IN_Language, 'BILLINGSUMMARYID', R_billsummaryId, OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              SET OUT_returnCode = '999#????????';
              LEAVE getTariff;
            END IF;
          END IF;
          #
          INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
          , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
          , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
          , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
          , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
          , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
          , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
          , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
          , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
          , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
            SELECT
              bil.organizationId,
              bil.warehouseId,
              CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
              R_TODATE billingFromDate,
              R_TODATE billingToDate,
              bil.customerId,
              '',
              '',
              '',
              R_TARIFFID,
              R_CHARGECATEGORY,
              R_chargetype,
              R_descrC,
              R_rateBase,
              R_rateperunit,
              qtyonHand,
              'PL' uom,
              IF(R_billMode LIKE '%CBM', qtyonHand, 0) cubic,
              0 weight,
              R_rate,
              qtyonHand * R_rate / R_rateperunit,
              qtyonHand * R_rate / R_rateperunit + qtyonHand * R_rate / R_rateperunit * R_INCOMETAX,
              0,
              R_cost * qtyonHand,
              0,
              NOW() confirmTime,
              '' confirmWho,
              '' docType,
              '' docNo,
              '' createTransactionid,
              '' notes,
              NOW() ediSendTime,
              R_BILLTO billTo,
              NOW() settleTime,
              '' settleWho,
              '' followUp,
              '' invoiceType,
              '' paidTo,
              '' costConfirmFlag,
              NOW() costConfirmTime,
              '' costConfirmWho,
              '' costSettleFlag,
              NOW() costSettleTime,
              '' costSettleWho,
              0 incomeTaxRate,
              0 costTaxRate,
              R_INCOMETAX incomeTax,
              0 cosTax,
              qtyonHand * R_rate / R_rateperunit incomeWithoutTax,
              0 cosWithoutTax,
              '' costInvoiceType,
              '' noteText,
              R_materialNo AS udf01,
              R_itemChargeCategory AS udf02,
              R_UDF08 udf03,
              R_UDF06 udf04,
              R_UDF07 udf05,
              0 currentVersion,
              '2020' oprSeqFlag,
              IN_USERID addWho,
              NOW() ADDTIME,
              IN_USERID editWho,
              NOW() editTime,
              R_LOCATIONCAT locationCategory,
              '' manual,
              0 lineCount,
              '*' arNo,
              0 arLineNo,
              '*' apNo,
              0 apLineNo,
              'N' ediSendFlag,
              '' ediErrorCode,
              '' ediErrorMessage,
              NOW() ediSendTime2,
              'N' ediSendFlag2,
              '' ediErrorCode2,
              '' ediErrorMessage2,
              '' billingTranCategory,
              '' orderType,
              '' containerType,
              '' containerSize
            FROM TMP_BIL_SUMMARY_INFO2 bil
          ;

        END IF;

        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFO1;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFO2;
      END;
      END IF;
    END LOOP getTariff;
    CLOSE cur_Tariff;
    SET OUT_returnCode = '000';
  END;
END
$$

--
-- Create procedure `OJV_CML_SPUDF_Process4`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPUDF_Process4 (IN IN_warehouseId varchar(20),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    BEGIN
      DECLARE v_error int;
      DECLARE v_nrow int;
      DECLARE v_errormessage varchar(1000);
      DECLARE v_NO_COMMIT char(1);
      DECLARE IN_organizationId varchar(30);
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
      DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        GET DIAGNOSTICS CONDITION 1
        @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
        SELECT
          CONCAT('999#OJV_CML_SPUDF_Process4,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
        SELECT
          v_errormessage AS error;
      END;
      SET v_error = 1;
      IF OUT_returnCode = 'NO_COMMIT'
        OR OUT_returnCode = '*_*' THEN
        SET v_NO_COMMIT = 'N';
      ELSE
        SET v_NO_COMMIT = 'Y';
      END IF;
      SET OUT_returnCode = 'NO_COMMIT';
      SET @bizorganizationid = 'OJV_CML';
      SET @bizwarehouseId = IN_warehouseId;
      SET @userId = IN_userId;
      SET @language = 'en';
      SET @customerId = '%';
      CALL BILL_STORAGE_DETAIL_NEW(@bizorganizationid, @bizWarehouseId, @userId, @language, @customerId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE END_PROC;
      END IF;
      SET OUT_returnCode := '000';
    END;
  END
  $$

--
-- Create procedure `BILL_STORAGE_DETAIL`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE BILL_STORAGE_DETAIL (IN `IN_organizationId` varchar(30),
IN `IN_warehouseId` varchar(30),
IN `IN_USERID` varchar(30),
IN `IN_Language` varchar(30),
IN `IN_CustomerId` varchar(30),
OUT `OUT_returnCode` varchar(1000))
BEGIN
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(10);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_cube decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCube decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE tariff_done int DEFAULT FALSE;
  DECLARE inventory_done int DEFAULT FALSE;
  DECLARE cur_Tariff CURSOR FOR
  SELECT DISTINCT
    bsm.organizationId,
    bsm.warehouseId,
    bsm.CUSTOMERID,
    DAY(bth.billingdate) billingDate,
    btd.tariffId,
    btd.tariffLineNo,
    btr.tariffClassNo,
    btd.chargeCategory,
    btd.chargeType,
    btd.descrC,
    btd.ratebase,
    btr.ratePerUnit,
    btr.rate,
    btd.minAmount,
    btd.maxAmount,
    IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
    btd.UDF01 AS MaterialNo,
    btd.udf02 AS itemChargeCategory,
    btd.udf04 billMode,
    locationCategory,
    btd.UDF05 R_LOCATIONGROUP,
    btd.UDF06,
    IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
    CASE WHEN chargeType = 'ES' THEN btr.classfrom - 1 ELSE btr.classfrom END,
    classTo,
    bth.contractNo,
    bth.tariffMasterId,
    btr.cost,
    btd.billingParty
  FROM BAS_SKU_MULTIWAREHOUSE bsm
    LEFT JOIN BAS_CUSTOMER bc
      ON bc.customerId = bsm.customerId
      AND bc.organizationId = bsm.organizationId
    LEFT JOIN BIL_TARIFF_HEADER bth
      ON bth.organizationId = bsm.organizationId
      AND bth.tariffMasterId = bsm.tariffMasterId
    LEFT JOIN BIL_TARIFF_DETAILS btd
      ON btd.organizationId = bth.organizationId
      AND btd.tariffId = bth.tariffId
    LEFT JOIN BIL_TARIFF_RATE btr
      ON btr.organizationId = btd.organizationId
      AND btr.tariffId = btd.tariffId
      AND btr.tariffLineNo = btd.tariffLineNo
  WHERE bsm.organizationId = IN_organizationId
  AND bsm.warehouseId = IN_warehouseId
  AND bsm.tariffMasterId != ''
  AND bth.tariffId IS NOT NULL
  AND bc.customerType = 'OW'
  AND btd.chargeCategory = 'IV'
  AND btr.rate IS NOT NULL
  AND bsm.customerId LIKE IN_CustomerId
  AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND IFNULL(DAY(bth.billingdate), 0) != 0
  ORDER BY bsm.organizationId, bsm.customerId, btd.tariffId, btd.tariffId, btd.tariffLineNo, btr.tariffClassNo;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;
  BEGIN
    SET R_CURRENTDATE = CURDATE();
    OPEN cur_Tariff;
  getTariff:
    LOOP
      FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC,
      R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06,
      R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY;
      IF tariff_done THEN
        SET tariff_done = FALSE;
        LEAVE getTariff;
      END IF;
      SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
      SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
      SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
      SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
      SET R_billsummaryId = '';
      IF R_BILLINGPARTY = 'BI' THEN
        SET R_BILLTO = R_CustomerId;
        SELECT
          CUSTOMERID INTO R_BILLTO
        FROM BAS_CUSTOMER
        WHERE refOwner = R_CustomerId
        AND CustomerType = 'BI'
        LIMIT 1;
      ELSE
        SET R_BILLTO = R_CustomerId;
      END IF;
      IF (R_BILLINGDATE = R_CURRENTDATE) THEN
      BEGIN
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFORMATION;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY_INFORMATION (
          organizationId varchar(20),
          warehouseId varchar(20),
          customerId varchar(30),
          billsummaryId varchar(30),
          LineNo int(11) NOT NULL AUTO_INCREMENT,
          tariffId varchar(10),
          tariffLineNo int(11),
          descrC varchar(60),
          chargeCategory varchar(20),
          chargeType varchar(20),
          ratebase varchar(20),
          minQty varchar(500),
          billingMode varchar(500),
          ratePerUnit decimal(24, 8) DEFAULT NULL,
          rate decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          tariffClassNo int(11) NOT NULL,
          classFrom decimal(24, 8) NOT NULL,
          classTo decimal(24, 8) NOT NULL,
          StockDate date DEFAULT NULL,
          locationId varchar(60) binary DEFAULT NULL,
          locationCategory varchar(10) binary NOT NULL,
          zoneId varchar(20) DEFAULT NULL,
          traceId varchar(30) binary NOT NULL,
          muid varchar(30) binary NOT NULL DEFAULT '*',
          lotNum varchar(10) binary NOT NULL,
          sku varchar(255) binary NOT NULL DEFAULT '',
          qtyonHand int(11) DEFAULT NULL,
          packkey varchar(255) binary DEFAULT NULL,
          UOM varchar(255) binary DEFAULT NULL,
          qtyallocated int(11) DEFAULT NULL,
          qtyonHold int(11) DEFAULT NULL,
          qtyavailable int(11) DEFAULT NULL,
          qtyPicked int(11) DEFAULT NULL,
          palletUsed int(11) DEFAULT NULL,
          SKUDesc varchar(550) binary DEFAULT NULL,
          `CUBE` decimal(24, 8) DEFAULT NULL,
          totalCube decimal(24, 8) DEFAULT NULL,
          grossWeight decimal(18, 8) DEFAULT NULL,
          netWeight decimal(18, 8) DEFAULT NULL,
          freightClass varchar(255) binary DEFAULT NULL,
          addWho varchar(255) binary NOT NULL DEFAULT '',
          ADDTIME datetime DEFAULT NULL,
          editWho varchar(255) binary DEFAULT NULL,
          editTime datetime DEFAULT NULL,
          PRIMARY KEY (LineNo)
        );
        SET @linenumber = 0;
        IF (R_CHARGECATEGORY = 'IV'
          AND R_CHARGETYPE = 'PL') THEN
          CASE
            WHEN R_billMode = 'INTRACE' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.lotNum = zib.LotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.traceId NOT IN ('*', ' ')
                  -- AND zib.muid IN ('*','',' ') 
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = atl.organizationId
                      AND ila.customerId = atl.toCustomerId
                      AND ila.sku = atl.toSku
                      AND ila.lotNum = atl.tolotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toId NOT IN ('*', '', ' ')
                  -- AND atl.toMuid IN ('*','',' ') 
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXTRACE', 'DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    zib.StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    '*' muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INPL' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN WITH  MUID
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON i(ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum)
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.muid NOT IN ('*', '', ' ')
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS LocationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.lotNum = zib.LotNumLEFT
                    JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toMuid NOT IN ('*', '', ' ')
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXPL', 'MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    '' traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  AND zib.muid NOT IN ('*', '', ' ')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INLOC' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN WITH LOCATION
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.skuDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS LocationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = atl.organizationId
                      AND ila.customerId = atl.toCustomerId
                      AND ila.sku = atl.toSku
                      AND ila.lotNum = atl.tolotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXLOC', 'MONTHLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    '' traceId,
                    '' muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    'PL' UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'DAILYCBM' THEN -- Daily accumulated CBM
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                  WHERE zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass,
                           bl.locationCategory;
              END;
            ELSE SELECT
                'BILLING METHOD FOR PALLET RENTAL NOT FOUND' AS MESSAGE;
          END CASE;
        ELSE
        ## GET STORAGE FROM INVENTORY
        BEGIN
          CASE
            WHEN R_billMode = 'INTRACE' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    zib.SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID addWho,
                    CURDATE() ADDTIME,
                    IN_USERID editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND TRACEID NOT IN ('*')
                  -- AND MUID IN ('*')                                         
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toId NOT IN ('*')
                  -- AND atl.toMuid IN ('*') 
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXTRACE', 'DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    zib.StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND TRACEID NOT IN ('*')
                  -- AND MUID IN ('*')
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           bsm.tariffMasterId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INPL' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    zib.SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND MUID NOT IN ('*')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toMuid NOT IN ('*')
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXPL', 'MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND MUID NOT IN ('*')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           bsm.tariffMasterId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INLOC' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXLOC', 'MONTHLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'DAILYCBM' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                  WHERE zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            ELSE SELECT
                'BILLING METHOD FOR NORMAL STORAGE NOT FOUND' AS MESSAGE;
          END CASE;
        END;
        END IF;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY (
          organizationId varchar(20),
          warehouseId varchar(20),
          billingSummaryId varchar(30),
          customerId varchar(30),
          sku varchar(50),
          lotNum varchar(10),
          traceId varchar(30),
          tariffId varchar(10),
          chargeCategory varchar(20),
          chargeType varchar(20),
          descr varchar(60),
          rateBase varchar(20),
          chargePerUnits decimal(18, 3),
          qty decimal(18, 8),
          uom varchar(10),
          cubic decimal(24, 8),
          weight decimal(18, 8),
          chargeRate decimal(24, 8),
          locationCategory varchar(10),
          amount decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          billingAmount decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          udf01 varchar(500),
          udf02 varchar(500) binary DEFAULT NULL,
          udf03 varchar(500),
          udf04 varchar(500),
          udf05 varchar(500)
        );
        IF EXISTS (SELECT
              *
            FROM TMP_BIL_SUMMARY_INFORMATION) THEN
          -- SELECT * FROM TMP_BIL_SUMMARY_INFORMATION;
          /* select stockdate,sum(PalletUsed) from (
     		SELECT stockdate,traceId,1 PalletUsed FROM TMP_BIL_SUMMARY_INFORMATION
             group by stockdate,traceId
             )plt group by stockdate;
           */
          SET IN_Language = 'en';
          SET @line_number = 0;
          SET @row_number = 0;
          SET R_billsummaryId = '';
          CASE
            WHEN R_billMode IN ('INTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(DailyTrace.`CUBE`) TotalCube,
                    SUM(DailyTrace.Weight) TotalWeight,
                    R_rate,
                    DailyTrace.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      tb.traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.traceId NOT IN ('*', '', ' ')
                    --  AND tb.muid IN ('*','',' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             traceId) DailyTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('MAXTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    MaxTrace.uom,
                    SUM(MaxTrace.`CUBE`) TotalCube,
                    SUM(MaxTrace.Weight) TotalWeight,
                    R_rate,
                    MaxTrace.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxTrace.UDF03,
                    MaxTrace.UDF04,
                    MaxTrace.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      tb.Stockdate,
                      '' SKU,
                      '' lotNum,
                      tb.traceId traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.traceId NOT IN ('*', ' ')
                    -- AND tb.muid IN ('*',' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             traceId) MaxTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId,
                           MaxTrace.StockDate
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthTrace.`CUBE`) TotalCube,
                    SUM(MonthTrace.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      traceid,
                      1 PalletQty,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        tb.traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        '' locationCategory,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        '' UDF05
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId
                      AND TRACEID NOT IN ('*')
                    -- AND MUID IN ('*')
                    ) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             traceid) MonthTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM;
              END;
            WHEN R_billMode IN ('INPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(InMuid.`CUBE`) TotalCube,
                    SUM(InMuid.Weight) TotalWeight,
                    R_rate,
                    InMuid.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*', '', ' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             Muid) InMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('MAXPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    MaxMuid.lotNum,
                    MaxMuid.traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MaxTrace.`CUBE`) TotalCube,
                    SUM(MaxTrace.Weight) TotalWeight,
                    R_rate,
                    MaxMuid.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxMuid.UDF03,
                    MaxMuid.UDF04,
                    MaxMuid.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             muid) MaxMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthMuid.`CUBE`) TotalCube,
                    SUM(MonthMuid.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      '' traceid,
                      1 PalletQty,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        '' traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        '' locationCategory,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        tb.muid muid
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId
                      AND MUID NOT IN ('*')) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             muid) MonthMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('INLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(InLoc.`CUBE`) TotalCube,
                    SUM(InLoc.Weight) TotalWeight,
                    R_rate,
                    InLoc.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*', '', ' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             tb.locationId) InLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('MAXLOC') THEN  -- Highest location count
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    MaxLoc.lotNum,
                    MaxLoc.traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MaxLoc.`CUBE`) TotalCube,
                    SUM(MaxLoc.Weight) TotalWeight,
                    R_rate,
                    MaxLoc.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxLoc.UDF03,
                    MaxLoc.UDF04,
                    MaxLoc.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate,
                      1 * R_rateperunit * R_rate,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      tb.locationId UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             tb.locationId) MaxLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('MONTHLOC') THEN -- Daily accumulated total location
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthLoc.`CUBE`) TotalCube,
                    SUM(MonthLoc.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      1 PalletQty,
                      '' traceid,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        '' traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        tb.locationId,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        '' UDF05
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             locationId) MonthLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('DAILYCBM') THEN -- Daily accumulated total cbm
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) Qty,
                    'm3' uom,
                    SUM(tb.totalCube) `CUBE`,
                    SUM(netWeight) Weight,
                    R_rate AS chargerate,
                    '' locationCategory,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM TMP_BIL_SUMMARY_INFORMATION tb
                  WHERE organizationId = R_ORGANIZATIONID
                  AND warehouseId = R_WAREHOUSEID
                  AND customerId = R_customerId
                  GROUP BY organizationId,
                           warehouseId,
                           customerId,
                           tariffId,
                           tariffLineNo
                  HAVING SUM(tb.totalCube) >= R_CLASSFROM LIMIT 1;
              END;
            ELSE BEGIN
              SELECT
                CONCAT('Bill Mode : ', R_billMode, ' not found.') AS Message;
            END;
          END CASE;
          IF EXISTS (SELECT
                *
              FROM TMP_BIL_SUMMARY) THEN
            IF EXISTS (SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate >= R_FMDATE
                AND BillingToDate <= R_TODATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate >= R_FMDATE
                AND BillingToDate <= R_TODATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE bsi
                FROM BIL_SUMMARY_INFORMATION bsi
              WHERE billingFromDate >= R_FMDATE
                AND BillingToDate <= R_TODATE
                AND bsi.ChargeCategory = R_CHARGECATEGORY
                AND bsi.chargeType = R_CHARGETYPE
                AND rateBase = R_rateBase
                AND bsi.CustomerID = R_CUSTOMERID;
              DELETE
                FROM BIL_SUMMARY
              WHERE DATE_FORMAT(billingFromDate, '%Y-%m-%d') >= R_FMDATE
                AND DATE_FORMAT(BillingToDate, '%Y-%m-%d') <= R_TODATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND rateBase = R_rateBase
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND arNo IN ('*');
            END IF;
            IF (R_billsummaryId = '') THEN
              CALL SPCOM_GetIDSequence(R_ORGANIZATIONID, R_WAREHOUSEID, IN_Language, 'BILLINGSUMMARYID', R_billsummaryId, OUT_returnCode);
            -- SET  R_billsummaryId = 'TEST';
            END IF;
            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime, billTo, settleTime, settleWho
            , followUp, invoiceType, paidTo, costConfirmFlag, costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime
            , costSettleWho, incomeTaxRate, costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                bil.organizationId,
                bil.warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@row_number := @row_number + 1), 3, '0')),
                DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingFromDate,
                DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingToDate,
                bil.customerId,
                bil.SKU,
                bil.LotNum LotNum,
                bil.traceId traceId,
                bil.tariffId,
                R_CHARGECATEGORY chargeCategory,
                R_chargetype ChargeType,
                R_descrC descr,
                R_rateBase ratebase,
                R_rateperunit AS chargePerUnit,
                SUM(qty) qty,
                bil.uom uom,
                SUM(bil.cubic) cubic,
                SUM(bil.weight) weight,
                R_rate chargeRate,
                R_rateperunit * R_rate * SUM(qty) Amount,
                R_rateperunit * R_rate * SUM(qty) + (R_rateperunit * R_rate * SUM(qty) * R_INCOMETAX) BillingAmount,
                0 cost,
                R_cost * SUM(qty) amountPayable,
                0 amountPaid,
                NOW() confirmTime,
                '' confirmWho,
                '' docType,
                '' docNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_rateperunit * R_rate * SUM(qty) incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                bil.UDF03 udf03,
                R_UDF06 udf04,
                bil.UDF05 udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize
              FROM TMP_BIL_SUMMARY bil
              GROUP BY bil.organizationId,
                       bil.warehouseid,
                       bil.customerId,
                       bil.locationCategory,
                       bil.SKU,
                       bil.LotNum,
                       bil.uom,
                       bil.traceId,
                       bil.tariffId,
                       bil.UDF01,
                       bil.UDF02,
                       bil.UDF03,
                       bil.UDF04,
                       bil.UDF05;
            SET @countRow = ROW_COUNT();
            IF (@countRow > 0) THEN
              SELECT
                CONCAT('BIL SUMMARY INSERTED SUCESSFULLY FOR ', R_CUSTOMERID, ' WITH CHARGES : ', R_CHARGECATEGORY, ',', R_chargetype);
              INSERT INTO BIL_SUMMARY_INFORMATION
                SELECT
                  organizationId,
                  warehouseId,
                  R_billsummaryId,
                  LineNo,
                  R_TODATE,
                  R_TODATE,
                  customerId,
                  tariffId,
                  tariffLineNo,
                  descrC,
                  chargeCategory,
                  chargeType,
                  ratebase,
                  minQty,
                  billingMode,
                  ratePerUnit,
                  rate,
                  tariffClassNo,
                  classFrom,
                  classTo,
                  StockDate,
                  locationId,
                  locationCategory,
                  tbsi.zoneId,
                  traceId,
                  muid,
                  lotNum,
                  sku,
                  qtyonHand,
                  packkey,
                  UOM,
                  qtyallocated,
                  qtyonHold,
                  qtyavailable,
                  qtyPicked,
                  palletUsed,
                  SKUDesc,
                  `CUBE`,
                  totalCube,
                  grossWeight,
                  netWeight,
                  freightClass,
                  IN_USERID addWho,
                  NOW(),
                  IN_USERID editWho,
                  NOW()
                FROM TMP_BIL_SUMMARY_INFORMATION tbsi;
            END IF;
          ELSE
            SELECT
              CONCAT('NO BILING SUMMARY GENERATED FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS MESSAGE,
              R_ORGANIZATIONID,
              R_WAREHOUSEID,
              R_CUSTOMERID,
              R_chargecategory,
              R_CHARGETYPE,
              R_ratebase,
              R_billMode,
              R_minQty,
              R_CLASSFROM,
              R_CLASSTO;
          END IF;
        ELSE
          SELECT
            CONCAT('BIL SUMMARY DETAIL/INFORMATION NOT FOUND FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS Msg;
          IF (R_MinQty > 0) THEN
          BEGIN
            SELECT
              CONCAT('MIN CHARGE APPLIED FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS Msg;
            IF (R_billsummaryId = '') THEN
              CALL SPCOM_GetIDSequence(R_ORGANIZATIONID, R_WAREHOUSEID, IN_Language, 'BILLINGSUMMARYID', R_billsummaryId, OUT_returnCode);
            -- SET  R_billsummaryId = 'TEST';
            END IF;
            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime, billTo, settleTime, settleWho
            , followUp, invoiceType, paidTo, costConfirmFlag, costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime
            , costSettleWho, incomeTaxRate, costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                R_ORGANIZATIONID,
                R_WAREHOUSEID,
                R_billsummaryId,
                DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingFromDate,
                DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingToDate,
                R_CUSTOMERID,
                '' SKU,
                '' lotNum,
                '' traceId,
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_CHARGETYPE,
                R_descrC,
                R_ratebase,
                R_rateperunit,
                R_MinQty BillQty,
                'PL' uom,
                0 `CUBE`,
                0 Weight,
                R_rate chargeRate,
                R_MinQty * R_rateperunit * R_rate Amount,
                R_rateperunit * R_rate * R_MinQty + (R_rateperunit * R_rate * R_MinQty * R_INCOMETAX) BillAmount,
                0 AS COST,
                (R_MinQty * R_Cost) amountPayable,
                0 amountPaid,
                NOW() confirmTime,
                '' confirmWho,
                '' docType,
                '' docNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_rateperunit * R_rate * R_MinQty incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                '' udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;
          END;
          END IF;
        END IF;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFORMATION;
      END;
      END IF;
    END LOOP getTariff;
    CLOSE cur_Tariff;
    SET OUT_returnCode = '000';
  END;
END
$$

--
-- Create procedure `BILL_RECALCULATE_STORAGE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE BILL_RECALCULATE_STORAGE (IN `IN_organizationId` varchar(30),
IN `IN_warehouseId` varchar(30),
IN `IN_USERID` varchar(30),
IN `IN_Language` varchar(30),
IN `IN_CustomerId` varchar(30),
INOUT `OUT_returnCode` varchar(1000))
BEGIN
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(10);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_cube decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCube decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE tariff_done int DEFAULT FALSE;
  DECLARE inventory_done int DEFAULT FALSE;
  DECLARE cur_Tariff CURSOR FOR
  SELECT DISTINCT
    bsm.organizationId,
    bsm.warehouseId,
    bsm.CUSTOMERID,
    DAY(bth.billingdate) billingDate,
    btd.tariffId,
    btd.tariffLineNo,
    btr.tariffClassNo,
    btd.chargeCategory,
    btd.chargeType,
    btd.descrC,
    btd.ratebase,
    btr.ratePerUnit,
    btr.rate,
    btd.minAmount,
    btd.maxAmount,
    IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
    btd.UDF01 AS MaterialNo,
    btd.udf02 AS itemChargeCategory,
    btd.udf04 billMode,
    locationCategory,
    btd.UDF08 R_LOCATIONGROUP,
    btd.UDF06,
    IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
    CASE WHEN chargeType = 'ES' THEN btr.classfrom - 1 ELSE btr.classfrom END,
    classTo,
    bth.contractNo,
    bth.tariffMasterId,
    btr.cost,
    btd.billingParty
  FROM BAS_SKU_MULTIWAREHOUSE bsm
    LEFT JOIN BAS_CUSTOMER bc
      ON bc.customerId = bsm.customerId
      AND bc.organizationId = bsm.organizationId
    LEFT JOIN BIL_TARIFF_HEADER bth
      ON bth.organizationId = bsm.organizationId
      AND bth.tariffMasterId = bsm.tariffMasterId
    LEFT JOIN BIL_TARIFF_DETAILS btd
      ON btd.organizationId = bth.organizationId
      AND btd.tariffId = bth.tariffId
    LEFT JOIN BIL_TARIFF_RATE btr
      ON btr.organizationId = btd.organizationId
      AND btr.tariffId = btd.tariffId
      AND btr.tariffLineNo = btd.tariffLineNo
  WHERE bsm.organizationId = IN_organizationId
  AND bsm.warehouseId = IN_warehouseId
  AND bsm.tariffMasterId != ''
  AND bth.tariffId IS NOT NULL
  AND bc.customerType = 'OW'
  AND btd.chargeCategory = 'IV'
  AND btr.rate IS NOT NULL
  AND bsm.customerId LIKE IN_CustomerId
  AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND IFNULL(DAY(bth.billingdate), 0) != 0
  ORDER BY bsm.organizationId, bsm.customerId, btd.tariffId, btd.tariffId, btd.tariffLineNo, btr.tariffClassNo;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;
  BEGIN
    SET R_CURRENTDATE = CURDATE();
    OPEN cur_Tariff;
  getTariff:
    LOOP
      FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC,
      R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06,
      R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY;
      IF tariff_done THEN
        SET tariff_done = FALSE;
        LEAVE getTariff;
      END IF;
      -- Recalculate for current billing date
      SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
      -- if current/recalculate date same month but earlier than current billing date , get previous month
      IF (R_CURRENTDATE < R_BILLINGDATE
        AND MONTH(R_CURRENTDATE) = MONTH(R_BILLINGDATE)) THEN
        SET R_BILLINGDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
      END IF;
      SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
      SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
      SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
      SET R_billsummaryId = '';
      IF R_BILLINGPARTY = 'BI' THEN
        SET R_BILLTO = R_CustomerId;
        SELECT
          CUSTOMERID INTO R_BILLTO
        FROM BAS_CUSTOMER
        WHERE refOwner = R_CustomerId
        AND CustomerType = 'BI'
        LIMIT 1;
      ELSE
        SET R_BILLTO = R_CustomerId;
      END IF;
      --   IF (R_BILLINGDATE = R_CURRENTDATE) THEN 
      BEGIN
        IF EXISTS (SELECT
              *
            FROM BIL_SUMMARY
            WHERE billingFromDate >= R_FMDATE
            AND BillingToDate <= R_TODATE
            AND ChargeCategory = R_CHARGECATEGORY
            AND chargeType = R_CHARGETYPE
            AND CustomerID = R_CUSTOMERID
            AND billTo = R_BILLTO
            AND rateBase = R_rateBase
            AND arNo IN ('*')) THEN
          INSERT INTO BIL_SUMMARY_LOG
            SELECT
              *
            FROM BIL_SUMMARY
            WHERE billingFromDate >= R_FMDATE
            AND BillingToDate <= R_TODATE
            AND ChargeCategory = R_CHARGECATEGORY
            AND chargeType = R_CHARGETYPE
            AND CustomerID = R_CUSTOMERID
            AND billTo = R_BILLTO
            AND rateBase = R_rateBase
            AND arNo IN ('*');
          DELETE bsi
            FROM BIL_SUMMARY_INFORMATION bsi
          WHERE billingFromDate >= R_FMDATE
            AND BillingToDate <= R_TODATE
            AND bsi.ChargeCategory = R_CHARGECATEGORY
            AND bsi.chargeType = R_CHARGETYPE
            AND rateBase = R_rateBase
            AND bsi.CustomerID = R_CUSTOMERID;
          DELETE
            FROM BIL_SUMMARY
          WHERE DATE_FORMAT(billingFromDate, '%Y-%m-%d') >= R_FMDATE
            AND DATE_FORMAT(BillingToDate, '%Y-%m-%d') <= R_TODATE
            AND ChargeCategory = R_CHARGECATEGORY
            AND chargeType = R_CHARGETYPE
            AND rateBase = R_rateBase
            AND CustomerID = R_CUSTOMERID
            AND billTo = R_BILLTO
            AND arNo IN ('*');
        END IF;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFORMATION;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY_INFORMATION (
          organizationId varchar(20),
          warehouseId varchar(20),
          customerId varchar(30),
          billsummaryId varchar(30),
          LineNo int(11) NOT NULL AUTO_INCREMENT,
          tariffId varchar(10),
          tariffLineNo int(11),
          descrC varchar(60),
          chargeCategory varchar(20),
          chargeType varchar(20),
          ratebase varchar(20),
          minQty varchar(500),
          billingMode varchar(500),
          ratePerUnit decimal(24, 8) DEFAULT NULL,
          rate decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          tariffClassNo int(11) NOT NULL,
          classFrom decimal(24, 8) NOT NULL,
          classTo decimal(24, 8) NOT NULL,
          StockDate date DEFAULT NULL,
          locationId varchar(60) binary DEFAULT NULL,
          locationCategory varchar(10) binary NOT NULL,
          zoneId varchar(20) DEFAULT NULL,
          traceId varchar(30) binary NOT NULL,
          muid varchar(30) binary NOT NULL DEFAULT '*',
          lotNum varchar(10) binary NOT NULL,
          sku varchar(255) binary NOT NULL DEFAULT '',
          qtyonHand int(11) DEFAULT NULL,
          packkey varchar(255) binary DEFAULT NULL,
          UOM varchar(255) binary DEFAULT NULL,
          qtyallocated int(11) DEFAULT NULL,
          qtyonHold int(11) DEFAULT NULL,
          qtyavailable int(11) DEFAULT NULL,
          qtyPicked int(11) DEFAULT NULL,
          palletUsed int(11) DEFAULT NULL,
          SKUDesc varchar(550) binary DEFAULT NULL,
          `CUBE` decimal(24, 8) DEFAULT NULL,
          totalCube decimal(24, 8) DEFAULT NULL,
          grossWeight decimal(18, 8) DEFAULT NULL,
          netWeight decimal(18, 8) DEFAULT NULL,
          freightClass varchar(255) binary DEFAULT NULL,
          addWho varchar(255) binary NOT NULL DEFAULT '',
          ADDTIME datetime DEFAULT NULL,
          editWho varchar(255) binary DEFAULT NULL,
          editTime datetime DEFAULT NULL,
          PRIMARY KEY (LineNo)
        );
        SET @linenumber = 0;
        IF (R_CHARGECATEGORY = 'IV'
          AND R_CHARGETYPE = 'PL') THEN
          CASE
            WHEN R_billMode = 'INTRACE' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.lotNum = zib.LotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.traceId NOT IN ('*', ' ')
                  -- AND zib.muid IN ('*','',' ') 
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = atl.organizationId
                      AND ila.customerId = atl.toCustomerId
                      AND ila.sku = atl.toSku
                      AND ila.lotNum = atl.tolotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toId NOT IN ('*', '', ' ')
                  -- AND atl.toMuid IN ('*','',' ') 
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXTRACE', 'DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    zib.StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    '*' muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INPL' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN WITH  MUID
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON i(ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum)
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.muid NOT IN ('*', '', ' ')
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS LocationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.lotNum = zib.LotNumLEFT
                    JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toMuid NOT IN ('*', '', ' ')
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXPL', 'MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    '' traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  AND zib.muid NOT IN ('*', '', ' ')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INLOC' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN WITH LOCATION
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.skuDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS LocationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = atl.organizationId
                      AND ila.customerId = atl.toCustomerId
                      AND ila.sku = atl.toSku
                      AND ila.lotNum = atl.tolotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXLOC', 'MONTHLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    '' traceId,
                    '' muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    'PL' UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'DAILYCBM' THEN -- Daily accumulated CBM
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                  WHERE zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass,
                           bl.locationCategory;
              END;
            ELSE SELECT
                'BILLING METHOD FOR PALLET RENTAL NOT FOUND' AS MESSAGE;
          END CASE;
        ELSE
        ## GET STORAGE FROM INVENTORY
        BEGIN
          CASE
            WHEN R_billMode = 'INTRACE' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    zib.SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID addWho,
                    CURDATE() ADDTIME,
                    IN_USERID editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND TRACEID NOT IN ('*')
                  -- AND MUID IN ('*')                                         
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.cube),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toId NOT IN ('*')
                  -- AND atl.toMuid IN ('*') 
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXTRACE', 'DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    zib.StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND TRACEID NOT IN ('*')
                  -- AND MUID IN ('*')
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           bsm.tariffMasterId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INPL' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    zib.SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND MUID NOT IN ('*')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.cube),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toMuid NOT IN ('*')
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXPL', 'MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND MUID NOT IN ('*')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           bsm.tariffMasterId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INLOC' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.cube),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXLOC', 'MONTHLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'DAILYCBM' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION (organizationId, warehouseId, customerId, billsummaryId, tariffId, tariffLineNo, descrC, chargeCategory, chargeType, ratebase, minQty, billingMode, ratePerUnit, rate, tariffClassNo, classFrom, classTo, StockDate, locationId, locationCategory, zoneId, traceId, muid, lotNum, sku, qtyonHand, packkey, UOM, qtyallocated, qtyonHold, qtyavailable, qtyPicked, palletUsed, SKUDesc, `CUBE`, totalCube, grossWeight, netWeight, freightClass, addWho, ADDTIME, editWho, editTime)
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    -- (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() ADDTIME,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                  WHERE zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            ELSE SELECT
                'BILLING METHOD FOR NORMAL STORAGE NOT FOUND' AS MESSAGE;
          END CASE;
        END;
        END IF;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY (
          organizationId varchar(20),
          warehouseId varchar(20),
          billingSummaryId varchar(30),
          customerId varchar(30),
          sku varchar(50),
          lotNum varchar(10),
          traceId varchar(30),
          tariffId varchar(10),
          chargeCategory varchar(20),
          chargeType varchar(20),
          descr varchar(60),
          rateBase varchar(20),
          chargePerUnits decimal(18, 3),
          qty decimal(18, 8),
          uom varchar(10),
          cubic decimal(24, 8),
          weight decimal(18, 8),
          chargeRate decimal(24, 8),
          locationCategory varchar(10),
          amount decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          billingAmount decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          udf01 varchar(500),
          udf02 varchar(500) binary DEFAULT NULL,
          udf03 varchar(500),
          udf04 varchar(500),
          udf05 varchar(500)
        );
        IF EXISTS (SELECT
              *
            FROM TMP_BIL_SUMMARY_INFORMATION) THEN
          -- SELECT * FROM TMP_BIL_SUMMARY_INFORMATION;
          /* select stockdate,sum(PalletUsed) from (
     		SELECT stockdate,traceId,1 PalletUsed FROM TMP_BIL_SUMMARY_INFORMATION
             group by stockdate,traceId
             )plt group by stockdate;
           */
          SET IN_Language = 'en';
          SET @line_number = 0;
          SET @row_number = 0;
          SET R_billsummaryId = '';
          CASE
            WHEN R_billMode IN ('INTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(DailyTrace.Cube) TotalCube,
                    SUM(DailyTrace.Weight) TotalWeight,
                    R_rate,
                    DailyTrace.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      tb.traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.traceId NOT IN ('*', '', ' ')
                    --  AND tb.muid IN ('*','',' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             traceId) DailyTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('MAXTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    MaxTrace.uom,
                    SUM(MaxTrace.Cube) TotalCube,
                    SUM(MaxTrace.Weight) TotalWeight,
                    R_rate,
                    MaxTrace.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxTrace.UDF03,
                    MaxTrace.UDF04,
                    MaxTrace.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      tb.Stockdate,
                      '' SKU,
                      '' lotNum,
                      tb.traceId traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.traceId NOT IN ('*', ' ')
                    -- AND tb.muid IN ('*',' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             traceId) MaxTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId,
                           MaxTrace.StockDate
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthTrace.Cube) TotalCube,
                    SUM(MonthTrace.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      traceid,
                      1 PalletQty,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        tb.traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        '' locationCategory,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        '' UDF05
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId
                      AND TRACEID NOT IN ('*')
                    -- AND MUID IN ('*')
                    ) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             traceid) MonthTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM;
              END;
            WHEN R_billMode IN ('INPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(InMuid.Cube) TotalCube,
                    SUM(InMuid.Weight) TotalWeight,
                    R_rate,
                    InMuid.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*', '', ' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             Muid) InMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('MAXPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    MaxMuid.lotNum,
                    MaxMuid.traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MaxTrace.Cube) TotalCube,
                    SUM(MaxTrace.Weight) TotalWeight,
                    R_rate,
                    MaxMuid.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxMuid.UDF03,
                    MaxMuid.UDF04,
                    MaxMuid.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             muid) MaxMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthMuid.Cube) TotalCube,
                    SUM(MonthMuid.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      '' traceid,
                      1 PalletQty,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        '' traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        '' locationCategory,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        tb.muid muid
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId
                      AND MUID NOT IN ('*')) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             muid) MonthMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('INLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(InLoc.Cube) TotalCube,
                    SUM(InLoc.Weight) TotalWeight,
                    R_rate,
                    InLoc.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*', '', ' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             tb.locationId) InLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('MAXLOC') THEN  -- Highest location count
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    MaxLoc.lotNum,
                    MaxLoc.traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MaxLoc.Cube) TotalCube,
                    SUM(MaxLoc.Weight) TotalWeight,
                    R_rate,
                    MaxLoc.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxLoc.UDF03,
                    MaxLoc.UDF04,
                    MaxLoc.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate,
                      1 * R_rateperunit * R_rate,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      tb.locationId UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             tb.locationId) MaxLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('MONTHLOC') THEN -- Daily accumulated total location
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthLoc.Cube) TotalCube,
                    SUM(MonthLoc.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      1 PalletQty,
                      '' traceid,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        '' traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        tb.locationId,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        '' UDF05
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             locationId) MonthLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('DAILYCBM') THEN -- Daily accumulated total cbm
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) Qty,
                    'm3' uom,
                    SUM(tb.totalCube) `CUBE`,
                    SUM(netWeight) Weight,
                    R_rate AS chargerate,
                    '' locationCategory,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM TMP_BIL_SUMMARY_INFORMATION tb
                  WHERE organizationId = R_ORGANIZATIONID
                  AND warehouseId = R_WAREHOUSEID
                  AND customerId = R_customerId
                  GROUP BY organizationId,
                           warehouseId,
                           customerId,
                           tariffId,
                           tariffLineNo
                  HAVING SUM(tb.totalCube) >= R_CLASSFROM LIMIT 1;
              END;
            ELSE BEGIN
              SELECT
                CONCAT('Bill Mode : ', R_billMode, ' not found.') AS Message;
            END;
          END CASE;
          IF EXISTS (SELECT
                *
              FROM TMP_BIL_SUMMARY) THEN
            IF (R_billsummaryId = '') THEN
              CALL SPCOM_GetIDSequence(R_ORGANIZATIONID, R_WAREHOUSEID, IN_Language, 'BILLINGSUMMARYID', R_billsummaryId, OUT_returnCode);
            -- SET  R_billsummaryId = 'TEST';
            END IF;
            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime, billTo, settleTime, settleWho
            , followUp, invoiceType, paidTo, costConfirmFlag, costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime
            , costSettleWho, incomeTaxRate, costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                bil.organizationId,
                bil.warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@row_number := @row_number + 1), 3, '0')),
                DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingFromDate,
                DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingToDate,
                bil.customerId,
                bil.SKU,
                bil.LotNum LotNum,
                bil.traceId traceId,
                bil.tariffId,
                R_CHARGECATEGORY chargeCategory,
                R_chargetype ChargeType,
                R_descrC descr,
                R_rateBase ratebase,
                R_rateperunit AS chargePerUnit,
                SUM(qty) qty,
                bil.uom uom,
                SUM(bil.cubic) cubic,
                SUM(bil.weight) weight,
                R_rate chargeRate,
                R_rateperunit * R_rate * SUM(qty) Amount,
                R_rateperunit * R_rate * SUM(qty) + (R_rateperunit * R_rate * SUM(qty) * R_INCOMETAX) BillingAmount,
                0 cost,
                R_cost * SUM(qty) amountPayable,
                0 amountPaid,
                NOW() confirmTime,
                '' confirmWho,
                '' docType,
                '' docNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_rateperunit * R_rate * SUM(qty) incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                bil.UDF03 udf03,
                R_UDF06 udf04,
                bil.UDF05 udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize
              FROM TMP_BIL_SUMMARY bil
              GROUP BY bil.organizationId,
                       bil.warehouseid,
                       bil.customerId,
                       bil.locationCategory,
                       bil.SKU,
                       bil.LotNum,
                       bil.uom,
                       bil.traceId,
                       bil.tariffId,
                       bil.UDF01,
                       bil.UDF02,
                       bil.UDF03,
                       bil.UDF04,
                       bil.UDF05;
            SET @countRow = ROW_COUNT();
            IF (@countRow > 0) THEN
              SELECT
                CONCAT('BIL SUMMARY INSERTED SUCCESSFULLY FOR ', R_CUSTOMERID, ' WITH CHARGES : ', R_CHARGECATEGORY, ',', R_chargetype);
              INSERT INTO BIL_SUMMARY_INFORMATION
                SELECT
                  organizationId,
                  warehouseId,
                  R_billsummaryId,
                  LineNo,
                  R_TODATE,
                  R_TODATE,
                  customerId,
                  tariffId,
                  tariffLineNo,
                  descrC,
                  chargeCategory,
                  chargeType,
                  ratebase,
                  minQty,
                  billingMode,
                  ratePerUnit,
                  rate,
                  tariffClassNo,
                  classFrom,
                  classTo,
                  StockDate,
                  locationId,
                  locationCategory,
                  tbsi.zoneId,
                  traceId,
                  muid,
                  lotNum,
                  sku,
                  qtyonHand,
                  packkey,
                  UOM,
                  qtyallocated,
                  qtyonHold,
                  qtyavailable,
                  qtyPicked,
                  palletUsed,
                  SKUDesc,
                  `CUBE`,
                  totalCube,
                  grossWeight,
                  netWeight,
                  freightClass,
                  IN_USERID addWho,
                  NOW(),
                  IN_USERID editWho,
                  NOW()
                FROM TMP_BIL_SUMMARY_INFORMATION tbsi;
            END IF;
          ELSE
            SELECT
              CONCAT('NO BILING SUMMARY GENERATED FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS MESSAGE,
              R_ORGANIZATIONID,
              R_WAREHOUSEID,
              R_CUSTOMERID,
              R_chargecategory,
              R_CHARGETYPE,
              R_ratebase,
              R_billMode,
              R_minQty,
              R_CLASSFROM,
              R_CLASSTO;
          END IF;
        ELSE
          SELECT
            CONCAT('BIL SUMMARY DETAIL/INFORMATION NOT FOUND FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS Msg;
          --  triggering min charge if no record found    
          IF (R_MinQty > 0) THEN
          BEGIN
            SELECT
              CONCAT('MIN CHARGE APPLIED FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS Msg;
            IF (R_billsummaryId = '') THEN
              CALL SPCOM_GetIDSequence(R_ORGANIZATIONID, R_WAREHOUSEID, IN_Language, 'BILLINGSUMMARYID', R_billsummaryId, OUT_returnCode);
            -- SET  R_billsummaryId = 'TEST';
            END IF;
            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime, billTo, settleTime, settleWho
            , followUp, invoiceType, paidTo, costConfirmFlag, costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime
            , costSettleWho, incomeTaxRate, costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                R_ORGANIZATIONID,
                R_WAREHOUSEID,
                R_billsummaryId,
                DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingFromDate,
                DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingToDate,
                R_CUSTOMERID,
                '' SKU,
                '' lotNum,
                '' traceId,
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_CHARGETYPE,
                R_descrC,
                R_ratebase,
                R_rateperunit,
                R_MinQty BillQty,
                'PL' uom,
                0 `CUBE`,
                0 Weight,
                R_rate chargeRate,
                R_MinQty * R_rateperunit * R_rate Amount,
                R_rateperunit * R_rate * R_MinQty + (R_rateperunit * R_rate * R_MinQty * R_INCOMETAX) BillAmount,
                0 AS COST,
                (R_MinQty * R_Cost) amountPayable,
                0 amountPaid,
                NOW() confirmTime,
                '' confirmWho,
                '' docType,
                '' docNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_rateperunit * R_rate * R_MinQty incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                '' udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;
          END;
          END IF;
        END IF;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFORMATION;
      END;
    END LOOP getTariff;
    CLOSE cur_Tariff;
    SET OUT_returnCode = '000';
  END;
END
$$

--
-- Create procedure `SPUDF_ProcessA`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPUDF_ProcessA (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_Parameter1 varchar(200),
IN IN_Parameter2 varchar(200),
IN IN_Parameter3 varchar(200),
IN IN_Parameter4 varchar(200),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#SPUDF_ProcessA,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPSO_CloseCancel`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_CloseCancel (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_Process_Action varchar(20),
IN IN_OrderNO varchar(20),
IN IN_OrderSplit varchar(20),
IN IN_Language varchar(20),
IN IN_UserID varchar(20),
INOUT OUT_Return_Code varchar(100))
ENDPROC:
  BEGIN

    DECLARE r_CustomerID varchar(30);
    DECLARE r_nRow int;
    DECLARE r_Status varchar(2);
    DECLARE r_SOStatus varchar(2);
    DECLARE r_CurrentTime timestamp;
    DECLARE r_OpenQty decimal(18, 8);
    DECLARE r_OrderNO_New varchar(30);
    DECLARE r_DEL_HIS_DAT varchar(1);
    DECLARE r_DEL_SO_ALC varchar(1);
    DECLARE r_TransactionID varchar(30);
    DECLARE r_Len int;
    DECLARE r_SO_CLS_CTL varchar(1);
    DECLARE r_SN_SO_CLS varchar(1);

    DECLARE r_SO_CLS_80 varchar(1);

    DECLARE r_PickToTraceID_R varchar(30);
    DECLARE r_SKU_R varchar(50);
    DECLARE r_QTY_Each_R decimal(18, 8);
    DECLARE r_CartonGroup_R varchar(10);
    DECLARE r_CartonGroup_R_OLD varchar(10);
    DECLARE r_PickToTraceID_R_OLD varchar(30);
    DECLARE r_CombinedField varchar(1000);
    DECLARE r_OrderType varchar(20);
    DECLARE r_TRN_CTL char(1);
    DECLARE r_ASNNO varchar(20);
    DECLARE r_TOWarehouseID varchar(35);
    DECLARE r_ReceivingLocation varchar(20);
    DECLARE r_WAREHOUSEID varchar(35);
    DECLARE r_No_Commit varchar(1);
    DECLARE r_SO_CLS_POD char(1);
    DECLARE r_REF_CHK_SO char(1);
    DECLARE r_SOreference1_NEW varchar(30);
    DECLARE r_SOreference1 varchar(30);
    DECLARE r_Lastshipmenttime varchar(20);
    DECLARE r_UDF2 varchar(20);
    DECLARE v_done varchar(2);
    DECLARE r_packingbox varchar(30);
    DECLARE r_packingboxqty decimal(18, 8);
    DECLARE r_packingboxqty2 decimal(18, 8);
    DECLARE v_transactionid varchar(30);
    DECLARE v_docno varchar(30);
    DECLARE v_doclineno varchar(30);
    DECLARE v_tocustomerid varchar(50);
    DECLARE v_lotatt11 varchar(30);
    DECLARE v_toqty_each decimal(18, 8);
    DECLARE v_lotatt12 varchar(30);
    DECLARE v_lotnum varchar(30);
    DECLARE v_locationid varchar(30);
    DECLARE v_traceid varchar(30);
    DECLARE v_qty varchar(30);
    DECLARE r_TRN_TYP varchar(100);

    DECLARE CUR_SO CURSOR FOR
    SELECT
      a.PickToTraceID,
      a.SKU,
      SUM(a.QTY_Each),
      b.CartonGroup
    FROM ACT_ALLOCATION_DETAILS a,
         DOC_ORDER_PACKING_SUMMARY b
    WHERE a.organizationId = IN_organizationId
    AND a.warehouseId = IN_warehouse
    AND a.OrderNo = b.OrderNo
    AND a.PickToTraceID = b.TraceID
    AND a.OrderNo = IN_OrderNo
    AND a.PickToTraceID <> '*'
    AND a.PackFlag = 'Y'
    GROUP BY a.PickToTraceID,
             a.SKU,
             b.CartonGroup
    ORDER BY a.PickToTraceID, a.SKU;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_CloseCancel,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;

    BEGIN
      SET r_CurrentTime := NOW();
      IF OUT_Return_Code = '*_*' THEN
        SET r_No_Commit := 'N';
      ELSE
        SET r_No_Commit := 'Y';
      END IF;
      SET OUT_Return_Code := '000';





      SET OUT_Return_Code := '*_*';
      CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'SO', IN_OrderNo, IN_Process_Action, 'BEFORECLOSE', IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        LEAVE endproc;
      END IF;


      IF IN_OrderNo LIKE '#%#'
        AND UPPER(IN_Process_Action) = UPPER('Close') THEN

        SELECT
          COUNT(*)
        FROM ACT_ALLOCATION_DETAILS A
        WHERE A.organizationId = IN_organizationId
        AND A.warehouseId = IN_warehouse
        AND A.OrderNO = IN_OrderNO
        AND STATUS = '40' INTO r_nRow;
        IF r_nRow = 0 THEN
          UPDATE DOC_ORDER_DETAILS
          SET LineStatus = '99'
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND OrderNo = IN_OrderNo;
          UPDATE DOC_ORDER_HEADER
          SET SOStatus = '99'
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND OrderNo = IN_OrderNo
          AND NOT EXISTS (SELECT
              1
            FROM DOC_ORDER_DETAILS
            WHERE orderno = DOC_order_Header.orderNo
            AND LineStatus <> '99');
        END IF;

        SET OUT_Return_Code := '*_*';
        CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'SO', IN_OrderNo, IN_Process_Action, 'AFTERCLOSE', IN_Language, IN_UserID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE endproc;
        END IF;

        LEAVE endproc;
      END IF;



      SELECT
        COUNT(1)
      FROM DOC_QV_HEADER a
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseId = IN_warehouse
      AND a.sourceno = IN_OrderNO
      AND a.qvtype IN ('QTY', 'WGT')
      AND a.qvstatus < '80' INTO r_nrow;

      IF r_nrow > 0 THEN
        SET OUT_Return_Code := CONCAT('999#?????????????,????', IN_OrderNO);
        LEAVE endproc;
      END IF;


      SELECT
        CustomerID,
        OrderType,
        ConsigneeID,
        WAREHOUSEID,
        SOStatus,
        Lastshipmenttime,
        Soreference1
      FROM DOC_ORDER_HEADER
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouse
      AND OrderNo = IN_OrderNO INTO r_CustomerID, r_OrderType, r_TOWarehouseID, r_WAREHOUSEID, r_SOStatus,
      r_Lastshipmenttime
      , r_Soreference1
      FOR UPDATE;
      SET r_TRN_CTL := getsys_configuration(In_organizationId, r_WAREHOUSEID, r_CustomerID, r_OrderType, 'TRN_CTL');
      SET r_SO_CLS_80 := getsys_configuration(In_organizationId, r_WAREHOUSEID, r_CustomerID, r_OrderType, 'SO_CLS_80');
      SET r_SO_CLS_CTL := getsys_configuration(In_organizationId, r_WAREHOUSEID, r_CustomerID, r_OrderType, 'SO_CLS_CTL');

      IF r_SO_CLS_80 = 'Y'
        AND UPPER(IN_Process_Action) = UPPER('CLose') THEN
        SELECT
          COUNT(*)
        FROM DOC_ORDER_HEADER
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND orderno = IN_OrderNO
        AND SOstatus = '80' INTO r_nROw;
        IF r_nROw <= 0 THEN
          SET OUT_Return_Code := '445';
          LEAVE endproc;
        END IF;
      END IF;


      IF UPPER(IN_Process_Action) = UPPER('Cancel') THEN
        IF r_SOStatus <> '00' THEN
          SET OUT_Return_Code := '401';
          LEAVE endproc;
        END IF;
        SET r_Status := '90';
      ELSE


        SELECT
          COUNT(*)
        FROM DOC_ORDER_DETAILS
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND OrderNo = IN_OrderNO
        AND ((QtyAllocated_Each > QtyShipped_Each)
        OR (QtySoftAllocated_Each > QtyAllocated_Each)) INTO r_nRow;
        IF r_nRow > 0 THEN
          SET OUT_Return_Code := '401-from DOC_Order_Details';
          LEAVE endproc;
        END IF;
        IF r_SOStatus IN ('90', '99')
          OR (r_SOStatus = '00'
          AND r_SO_CLS_CTL = 'N') THEN
          SET OUT_Return_Code := '401';
          LEAVE endproc;
        END IF;
        SET r_Status := '99';
      END IF;


      BEGIN
        SELECT
          TRIM(SN_SO_CLS)
        FROM BAS_CUSTOMER
        WHERE organizationId = IN_organizationId
        AND Customerid = r_CustomerID
        AND CustomerType = 'OW'
        LIMIT 1 INTO r_SN_SO_CLS;
        IF v_done = 0 THEN
          SET r_SN_SO_CLS := 'N';
        END IF;
      END;
      IF r_SN_SO_CLS = 'Y' THEN
        SELECT
          COUNT(*)
        FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND OrderNo = IN_OrderNO INTO r_nRow;
        IF r_nRow < 1 THEN
          SET OUT_Return_Code := '261';
          LEAVE endproc;
        END IF;
      END IF;
      SET OUT_Return_Code := 'NO_COMMIT';
      CALL SPCOM_GetIDSequence(IN_organizationId, IN_Warehouse, IN_Language, 'TransactionID', r_TransactionID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE endproc;
      END IF;

      SELECT
        COUNT(*) INTO r_nrow
      FROM ACT_TRANSACTION_LOG
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouse
      AND DocNo = IN_OrderNO
      AND TransactionType = r_Status
      AND DOCTYPE = 'SO';
      IF r_nrow > 0 THEN

        DELETE
          FROM DOC_POD_HEADER
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND OrderNo = IN_OrderNO;
        DELETE
          FROM DOC_POD_DETAILS
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND OrderNo = IN_OrderNO;
        DELETE
          FROM DOC_ORDER_OUTBOUND
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND OrderNo = IN_OrderNO;
        DELETE
          FROM BIL_SUMMARY
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND DOCNO = IN_OrderNO
          AND DOCType = 'SO';
      END IF;


      SET r_SO_CLS_POD := getsys_configuration(In_organizationId, IN_Warehouse, r_CustomerID, r_OrderType, 'SO_CLS_POD');

      IF UPPER(IN_Process_Action) = UPPER('Close')
        AND IFNULL(r_SO_CLS_POD, 'N') = 'Y' THEN

        INSERT INTO DOC_POD_HEADER (organizationId, warehouseid, orderno, podstatus, podby, podtime, deliverytime,
        CustomerID, ADDTIME, addwho, edittime, editwho)
          VALUES (IN_organizationId, r_WAREHOUSEID, IN_OrderNO, '00', NULL, NULL, r_Lastshipmenttime, r_CustomerID, NOW(), 'SYSTEM', NOW(), 'SYSTEM');
        SET @rn = 0;
        INSERT INTO DOC_POD_DETAILS (organizationId, warehouseid, orderno, podlineno, orderlineno, linestatus, customerid, sku, lotnum,
        qtyorderedeach, qtyshippedeach, qtyrejectedeach,
        ADDTIME, addwho, edittime, editwho)

          SELECT
            IN_organizationId,
            in_Warehouse,
            OrderNo,
            @rn := @rn + 1,
            Orderlineno,
            '00',
            Customerid,
            SKU,
            FMLotNum,
            QtyOrdered_EACH,
            qtyshipped_each,
            0,
            NOW(),
            'SYSTEM',
            NOW(),
            'SYSTEM'
          FROM (SELECT
              a.OrderNo,
              a.orderLineNo,
              A.Customerid,
              a.SKU,
              b.FMLotNum,
              a.QtyOrdered_EACH,
              SUM(b.FMQty_Each) AS qtyshipped_each
            FROM DOC_ORDER_DETAILS a
              INNER JOIN ACT_TRANSACTION_LOG b
                ON b.DocNo = a.OrderNo
                AND b.DocLineNo = a.OrderLineNo
            WHERE a.organizationId = IN_organizationId
            AND a.warehouseId = IN_warehouse
            AND a.OrderNo = IN_OrderNO
            AND b.TransactionType = 'SO'
            AND b.Status = '99'
            GROUP BY a.OrderNo,
                     a.orderLineNo,
                     A.Customerid,
                     a.SKU,
                     a.QtyOrdered_EACH,
                     b.fmLotNum) AA;

      END IF;

      UPDATE DOC_ORDER_HEADER
      SET SoStatus = r_Status,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouse
      AND OrderNo = IN_OrderNO;
      UPDATE Doc_Order_Details
      SET LineStatus = r_Status,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouse
      AND OrderNo = IN_OrderNO
      AND LineStatus < '90';

      IF r_Status = '90' THEN
        SELECT
          COUNT(*)
        FROM DOC_ORDER_DETAILS A
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND OrderNo = IN_OrderNO
        AND A.Qtyallocated_Each > 0 INTO r_nRow;
        IF r_nRow > 0 THEN
          ROLLBACK;
          SET OUT_Return_Code := '401';
          LEAVE endproc;
        END IF;
      END IF;

      SET r_TRN_TYP = getsys_configuration(IN_organizationId, IN_Warehouse, r_CustomerID, '*', 'TRN_TYP');
      IF INSTR(r_TRN_TYP, r_Status) > 0 THEN
        SET r_UDF2 = 'N';
      ELSE
        SET r_UDF2 = 'O';
      END IF;


      INSERT INTO ACT_TRANSACTION_LOG (organizationId, TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
      , TransactionType
      , DocNo, DocLineNo, DocType
      , FMCustomerID, FMSKU
      , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
      , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
      , STATUS
      , WAREHOUSEID
      , TOCustomerID, TOSku
      , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
      , ADDTIME, AddWho, EditTime, EditWho
      , Operator, TransactionTime
      , Edisendflag)
        VALUES (IN_organizationId, r_TransactionID, NULL, NULL, NULL, NULL, NULL, NULL, r_Status, IN_OrderNO, 0, 'SO', r_CustomerID, '*', '*', '*', '*', '*', '*', 0, 0, '*', '*', '*', '*', '*', 0, 0, '99', r_WAREHOUSEID, r_CustomerID, '*', 0, 0, 0, 0, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, IN_UserID, r_CurrentTime, r_UDF2);


      SELECT
        COUNT(*)
      FROM DOC_ORDER_OUTBOUND
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouse
      AND OrderNo = IN_OrderNO INTO r_nrow;
      IF r_nrow = 0 THEN
        INSERT INTO DOC_ORDER_Outbound (organizationId, warehouseid, OutboundDate, OrderNO, TotalQty, TotalCube, TotalGrossWeight, TotalNetWeight, TotalPrice, ADDTIME, Addwho, EditTime, EditWho
        , OutboundSEQNo)
          SELECT
            IN_organizationId,
            IN_WareHouse,
            DATE_FORMAT(b.transactiontime, '%Y-%m-%d'),
            a.OrderNo,
            SUM(b.TOQty_EACH),
            SUM(b.TotalCubic),
            SUM(b.TotalGrossWeight),
            SUM(b.TotalNetWeight),
            SUM(b.TotalPrice),
            r_CurrentTime,
            IN_UserID,
            r_CurrentTime,
            IN_UserID,
            UUID()
          FROM DOC_ORDER_DETAILS a
            LEFT JOIN ACT_TRANSACTION_LOG b
              ON b.DocNo = a.ORDERNo
              AND b.DocLineNo = a.ORDERLineNo
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouse
          AND a.ORDERNo = IN_OrderNO
          AND b.TransactionType = 'SO'
          AND b.Status = '99'
          GROUP BY DATE_FORMAT(b.transactiontime, '%Y-%m-%d'),
                   a.OrderNo;
      END IF;

      IF IN_Process_Action = 'Close'
        AND IN_OrderSplit = 'Y' THEN
        SELECT
          SUM(QtyOrdered_Each) - SUM(QtyShipped_Each)
        FROM DOC_ORDER_DETAILS
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND OrderNo = IN_OrderNO
        AND LineStatus <> '90' INTO r_OpenQty;
        IF r_OpenQty <> 0 THEN


          SET r_REF_CHK_SO := getsys_configuration(In_organizationId, IN_Warehouse, R_CustomerID, r_OrderType, 'REF_CHK_SO');

          IF r_REF_CHK_SO = 'Y'
            AND TRIM(r_SOreference1) IS NOT NULL THEN

            SET r_Len := INSTR(r_SOreference1, '*') - 1;
            IF r_Len <= 0 THEN
              SET r_Len := LENGTH(r_SOreference1);
            END IF;
            SELECT
              COUNT(1)
            FROM DOC_ORDER_Header
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouse
            AND SUBSTRING(SOreference1, 1, r_Len) = SUBSTRING(r_SOreference1, 1, r_Len) INTO r_nRow;
            IF r_nRow < 10 THEN
              SET r_SOreference1_NEW := CONCAT(SUBSTRING(r_SOreference1, 1, r_Len), '*0', r_nrow);
            ELSE
              SET r_SOreference1_NEW := CONCAT(SUBSTRING(r_SOreference1, 1, r_Len), '*', r_nrow);
            END IF;
          ELSE
            SET r_SOreference1_NEW := r_SOreference1;
          END IF;


          SET r_Len := INSTR(IN_OrderNO, '*') - 1;
          IF r_Len <= 0 THEN
            SET r_Len := LENGTH(IN_OrderNO);
          END IF;
          SELECT
            COUNT(*)
          FROM DOC_ORDER_HEADER
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND SUBSTRING(OrderNo, 1, r_len) = SUBSTRING(IN_OrderNO, 1, r_len) INTO r_nrow;
          IF r_nrow < 10 THEN
            SET r_OrderNO_New := CONCAT(SUBSTRING(IN_OrderNO, 1, r_Len), '*0', r_nrow);
          ELSE
            SET r_OrderNO_New := CONCAT(SUBSTRING(IN_OrderNO, 1, r_Len), '*', r_nrow);
          END IF;
          INSERT INTO DOC_ORDER_HEADER (organizationId, OrderNo, OrderType, SOStatus, OrderTime, ExpectedShipmentTime1, ExpectedShipmentTime2, RequiredDeliveryTime, CustomerID, SOReference1,
          SOReference2, SOReference3, SOReference4, SOReference5, ReleaseStatus, Priority,
          ConsigneeID, ConsigneeName, C_Address1, C_Address2, C_Address3, C_Address4, C_City, C_Province, C_Country, C_ZIP,
          BillingID, BillingName, B_Address1, B_Address2, B_Address3, B_Address4, B_City, B_Province, B_Country, B_ZIP,
          CarrierID, CarrierName, CarrierAddress1, CarrierAddress2, CarrierAddress3, CarrierAddress4, CarrierCity, CarrierProvince, CarrierCountry, CarrierZIP,
          DeliveryTerms, DeliveryTermsDescr, PaymentTerms, PaymentTermsDescr, Transportation, Door, STOP,
          PlaceOfDischarge, PlaceOfDelivery, UserDefine1, UserDefine2, UserDefine3, UserDefine4, UserDefine5, Notes,
          ADDTIME, AddWho, EditTime, EditWho,
          CreateSource,
          C_CONTACT, C_FAX, C_MAIL, C_TEL1, C_TEL2,
          H_EDI_01, H_EDI_02, H_EDI_03, H_EDI_04, H_EDI_05, H_EDI_06, H_EDI_07, H_EDI_08, H_EDI_09, H_EDI_10, Userdefine6, WarehouseID,
          UserDefineA, UserDefineB)
            SELECT
              IN_organizationId,
              r_OrderNO_New,
              OrderType,
              '00',
              OrderTime,
              ExpectedShipmentTime1,
              ExpectedShipmentTime2,
              RequiredDeliveryTime,
              CustomerID,
              r_SOreference1_NEW,
              --V432C SOReference2,
              SOReference3,
              SOReference4,
              SOReference5,
              ReleaseStatus,
              Priority,
              ConsigneeID,
              ConsigneeName,
              C_Address1,
              C_Address2,
              C_Address3,
              C_Address4,
              C_City,
              C_Province,
              C_Country,
              C_ZIP,
              BillingID,
              BillingName,
              B_Address1,
              B_Address2,
              B_Address3,
              B_Address4,
              B_City,
              B_Province,
              B_Country,
              B_ZIP,
              CarrierID,
              CarrierName,
              CarrierAddress1,
              CarrierAddress2,
              CarrierAddress3,
              CarrierAddress4,
              CarrierCity,
              CarrierProvince,
              CarrierCountry,
              CarrierZIP,
              DeliveryTerms,
              DeliveryTermsDescr,
              PaymentTerms,
              PaymentTermsDescr,
              Transportation,
              Door,
              STOP,
              PlaceOfDischarge,
              PlaceOfDelivery,
              UserDefine1,
              UserDefine2,
              UserDefine3,
              UserDefine4,
              UserDefine5,
              Notes,
              r_CurrentTime,
              IN_UserID,
              r_CurrentTime,
              IN_UserID,
              'SPLIT',
              C_COUNTRY,
              C_FAX,
              C_MAIL,
              C_TEL1,
              C_TEL2,
              H_EDI_01,
              H_EDI_02,
              H_EDI_03,
              H_EDI_04,
              H_EDI_05,
              H_EDI_06,
              H_EDI_07,
              H_EDI_08,
              H_EDI_09,
              H_EDI_10,
              Userdefine6,
              WarehouseID,
              UserDefineA,
              UserDefineB
            FROM DOC_ORDER_HEADER
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouse
            AND OrderNo = IN_OrderNO;
          INSERT INTO DOC_ORDER_DETAILS (OrderNo, OrderLineNo, CustomerID, SKU, LineStatus, LotNum,
          LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05, LotAtt06, LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12,
          PickZone, Location, TraceID, QtyOrdered, QtySoftAllocated, QtyAllocated, QtyPicked, QtyShipped, UOM, PackID, QtyOrdered_Each,
          QtySoftAllocated_Each, QtyAllocated_Each, QtyPicked_each, QtyShipped_Each, RotationID, SoftAllocationRule,
          AllocationRule, UserDefine1, UserDefine2, UserDefine3, UserDefine4, UserDefine5, Notes, GrossWeight, NetWeight, Cubic, Price,
          ADDTIME, AddWho, EditTime, EditWho,
          D_EDI_01, D_EDI_02, D_EDI_03, D_EDI_04, D_EDI_05, D_EDI_06, D_EDI_07, D_EDI_08, D_EDI_09, D_EDI_10)
            SELECT
              r_OrderNO_New,
              orderLineNo,
              CustomerID,
              SKU,
              '00',
              LotNum,
              LotAtt01,
              LotAtt02,
              LotAtt03,
              LotAtt04,
              LotAtt05,
              LotAtt06,
              LotAtt07,
              LotAtt08,
              LotAtt09,
              LotAtt10,
              LotAtt11,
              LotAtt12,
              PickZone,
              Location,
              TraceID,
              QtyOrdered - QtyShipped,
              0,
              0,
              0,
              0,
              UOM,
              PackID,
              QtyOrdered_Each - QtyShipped_Each,
              0,
              0,
              0,
              0,
              RotationID,
              SoftAllocationRule,
              AllocationRule,
              UserDefine1,
              UserDefine2,
              UserDefine3,
              UserDefine4,
              UserDefine5,
              Notes,
              ((QtyOrdered_Each - QtyShipped_Each) / QtyOrdered_Each) * GrossWeight,
              ((QtyOrdered_Each - QtyShipped_Each) / QtyOrdered_Each) * NetWeight,
              ((QtyOrdered_Each - QtyShipped_Each) / QtyOrdered_Each) * Cubic,
              ((QtyOrdered_Each - QtyShipped_Each) / QtyOrdered_Each) * Price,
              r_CurrentTime,
              IN_UserID,
              r_Currenttime,
              IN_UserID,
              D_EDI_01,
              D_EDI_02,
              D_EDI_03,
              D_EDI_04,
              D_EDI_05,
              D_EDI_06,
              D_EDI_07,
              D_EDI_08,
              D_EDI_09,
              D_EDI_10
            FROM DOC_ORDER_DETAILS
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouse
            AND OrderNo = IN_OrderNO
            AND QtyOrdered_Each > QtyShipped_Each
            AND LineStatus <> '90';

        END IF;
      END IF;


      IF r_OrderType = 'TT'
        AND r_TRN_CTL = 'Y' THEN
        SELECT
          A.LocationID
        FROM BAS_LOCATION A
        WHERE A.organizationId = IN_organizationId
        AND A.warehouseId = IN_warehouse
        AND A.LocationID = B.LocationID
        AND A.LocationUsage = 'ST'
        AND A.WAREHOUSEID = r_TOWarehouseID
        LIMIT 1 INTO r_ReceivingLocation;

        SET r_ASNNO = CONCAT(IN_OrderNO, '*');
        INSERT INTO DOC_ASN_HEADER (organizationId, ASNNO, CustomerID, ASNType, ASNCreationTime, ASNStatus, WarehouseID, Priority, CreateSource,
        ASNReference1, ASNReference2, ASNReference3, ASNReference4, ASNReference5, Reserve_Flag, ByTrace_Flag, ASN_Print_Flag,
        ADDTIME, AddWho, EditTime, EditWho)
          SELECT
            IN_organizationId,
            r_ASNNO,
            r_CustomerID,
            'TT',
            r_CurrentTime,
            '00',
            r_TOWarehouseID,
            '3',
            'SO',
            SOReference1,
            SOReference2,
            SOReference3,
            SOReference4,
            SOReference5,
            'N',
            'N',
            'N',
            r_CurrentTime,
            IN_UserID,
            r_CurrentTime,
            IN_UserID
          FROM DOC_ORDER_HEADER
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND OrderNo = IN_OrderNo;
        INSERT INTO DOC_ASN_DETAILS (organizationId, warehouseID, ASNNO, ASNLineNo, CustomerID, SKU, SKUDescrC, SKUDescrE, LineStatus, ExpectedQty, ExpectedQty_Each,
        ReceivedQty, ReceivedQty_Each, UOM, PackID, HoldRejectCode, ReceivingLocation,
        LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05, LotAtt06, LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12,
        TotalCubic, TotalGrossweight, TotalNetweight, TotalPrice,
        ADDTIME, AddWho, EditTIme, EditWho, CreateSource, Reserve_Flag)
          SELECT
            IN_organizationId,
            IN_Warehouse,
            r_ASNNO,
            A.doclineno,
            A.FMCustomerID,
            A.FMSKU,
            B.Descr_C,
            B.Descr_E,
            '00',
            SUM(A.ToQty_Each),
            SUM(A.ToQty_Each),
            0,
            0,
            'EA',
            A.TOPackID,
            'OK',
            r_ReceivingLocation,
            C.Lotatt01,
            C.Lotatt02,
            C.Lotatt03,
            C.Lotatt04,
            C.Lotatt05,
            C.Lotatt06,
            C.Lotatt07,
            C.Lotatt08,
            C.Lotatt09,
            C.Lotatt10,
            C.Lotatt11,
            C.Lotatt12,
            SUM(A.TotalCubic),
            SUM(A.TotalGrossWeight),
            SUM(A.TotalNetweight),
            SUM(A.TotalPrice),
            r_CurrentTime,
            IN_UserID,
            r_CurrentTime,
            IN_UserID,
            In_OrderNo,
            'N'
          FROM ACT_TRANSACTION_LOG A,
               BAS_SKU B,
               INV_LOT_ATT C
          WHERE A.TransactionType = 'SO'
          AND A.DOCNo = IN_OrderNO
          AND A.Status = '99'
          AND A.FMCustomerID = B.CustomerID
          AND A.FMSKU = B.SKU
          AND A.TOLotnum = C.LotNum
          GROUP BY A.doclineno,
                   A.FMCustomerID,
                   A.FMSKU,
                   B.Descr_C,
                   B.Descr_E,
                   A.TOPackID,
                   C.Lotatt01,
                   C.Lotatt02,
                   C.Lotatt03,
                   C.Lotatt04,
                   C.Lotatt05,
                   C.Lotatt06,
                   C.Lotatt07,
                   C.Lotatt08,
                   C.Lotatt09,
                   C.Lotatt10,
                   C.Lotatt11,
                   C.Lotatt12;
      END IF;








































      IF UPPER(IN_Process_Action) = UPPER('Cancel') THEN
        DELETE
          FROM TMP_ORDERCHECK_BUFFER
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND OrderNo = IN_OrderNO;
      END IF;

      DELETE
        FROM DOC_ORDER_PACKING
      WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND OrderNo = IN_OrderNO;

      INSERT INTO IDX_PICKTOLIGHT_BAK (WAVENO, DOCNO, CARTNO, TerminalNo,
      FMLocation, PickToLocation, SortLocation, WMSTraceID, OffLineTraceID,
      OnlineTraceID, CustomerID, SKU, skuDescr1, LotAtt04, FMQty_Each,
      ToQty_Each, UOMFLAG, TaskProcess, TaskType, Notes, ReleaseFlag,
      EditTime, EditWho, CloseTime, CloseWho,
      FMID, PlanToID, PTLTaskID, WCSFlag, Priority, LockWho, LockTime, ReasonCode,
      Userdefine1, Userdefine2, WAREHOUSEID, ErrorMessage, fmtraceidscan)
        SELECT
          WAVENO,
          DOCNO,
          CARTNO,
          TerminalNo,
          FMLocation,
          PickToLocation,
          SortLocation,
          WMSTraceID,
          OffLineTraceID,
          OnlineTraceID,
          CustomerID,
          SKU,
          skuDescr1,
          LotAtt04,
          FMQty_Each,
          ToQty_Each,
          UOMFLAG,
          TaskProcess,
          TaskType,
          Notes,
          ReleaseFlag,
          EditTime,
          EditWho,
          CloseTime,
          CloseWho,
          FMID,
          PlanToID,
          PTLTaskID,
          WCSFlag,
          Priority,
          LockWho,
          LockTime,
          ReasonCode,
          udf01,
          udf02,
          WAREHOUSEID,
          ErrorMessage,
          fmtraceidscan
        FROM IDX_PICKTOLIGHT
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND docno = IN_OrderNO;


      DELETE
        FROM IDX_PICKTOLIGHT
      WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND docno = IN_OrderNO;


      IF r_OrderType = 'TT'
        AND r_TRN_CTL = 'Y' THEN
        CALL SPCOM_GetIDSequence(IN_organizationId, IN_Warehouse, IN_Language, 'ASNNO', r_ASNNO, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          LEAVE ENDPROC;
        END IF;
        UPDATE DOC_ASN_HEADER H
        SET H.asnno = r_ASNNO
        WHERE H.organizationId = IN_organizationId
        AND H.warehouseId = IN_warehouse
        AND H.asnno = CONCAT(IN_OrderNO, '*');

        UPDATE DOC_ASN_DETAILS H
        SET H.asnno = r_ASNNO
        WHERE H.organizationId = IN_organizationId
        AND H.warehouseId = IN_warehouse
        AND H.asnno = CONCAT(IN_OrderNO, '*');
      END IF;

      IF r_No_Commit = 'Y' THEN
        COMMIT;
      END IF;
      SET OUT_Return_Code = '000';

    END;
  END
  $$

--
-- Create procedure `SPSO_Shipment_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_Shipment_Process (IN In_organizationId varchar(20),
IN In_Warehouse varchar(20),
IN IN_Action varchar(20),
IN IN_ProcessBy varchar(20),







IN IN_WaveNO varchar(20),
IN IN_OrderNO varchar(20),
IN IN_OrderLineNO varchar(10),
IN IN_AllocationDetailsID varchar(20),
IN IN_OutboundTime_CC varchar(20),
IN IN_Language varchar(10),
IN IN_UserID varchar(30),
INOUT OUT_Return_Code varchar(1000))
ENDPROC:
  BEGIN

    DECLARE r_Qtyallocated_Each decimal(18, 8);
    DECLARE r_Status varchar(2);
    DECLARE r_TransactionID varchar(30);
    DECLARE r_QtyOrdered_Each_O decimal(18, 8);
    DECLARE r_QtyShipped_Each_O decimal(18, 8);
    DECLARE r_QtyShipped_O decimal(18, 8);
    DECLARE r_LineStatus varchar(2);
    DECLARE r_PackFlag char(1);
    DECLARE r_QTY1_P decimal(18, 8);
    DECLARE r_QTY2_P decimal(18, 8);
    DECLARE r_QTY3_P decimal(18, 8);
    DECLARE r_QTY4_P decimal(18, 8);
    DECLARE r_QTY5_P decimal(18, 8);
    DECLARE r_nRow int;
    DECLARE r_CurrentTime timestamp;
    DECLARE r_UOMQty decimal(18, 8);
    DECLARE r_UOM_O varchar(10);
    DECLARE r_PACKID_O varchar(40);
    DECLARE r_ReleaseStatus char(1);
    DECLARE r_AllocationDetailsID_R varchar(30);
    DECLARE v_orderNo_R varchar(30);
    DECLARE r_OrderLineNO_R int;
    DECLARE r_CustomerID_R varchar(30);
    DECLARE r_Sku_R varchar(50);
    DECLARE r_LotNUM_R varchar(10);
    DECLARE r_Location_R varchar(60);
    DECLARE r_TraceID_R varchar(30);
    DECLARE r_Qty_R decimal(18, 8);
    DECLARE r_Qty_Each_R decimal(18, 8);
    DECLARE r_PackID_R varchar(40);
    DECLARE r_UOM_R varchar(10);
    DECLARE r_WaveNO_R varchar(20);
    DECLARE r_Status_R varchar(2);
    DECLARE r_QtyPicked_Each_R decimal(18, 8);
    DECLARE r_QtyShipped_Each_R decimal(18, 8);
    DECLARE r_PickToLocation_R varchar(60);
    DECLARE r_PickToTraceID_R varchar(30);
    DECLARE r_PickedTime_R timestamp;
    DECLARE r_PickedWho_R varchar(35);
    DECLARE r_ShipmentTime_R timestamp;
    DECLARE r_ShipmentWho_R varchar(35);
    DECLARE r_ReasonCode_R varchar(100);
    DECLARE r_Notes_R varchar(100);
    DECLARE r_Cubic_R decimal(18, 8);
    DECLARE r_GrossWeight_R decimal(18, 8);
    DECLARE r_NetWeight_R decimal(18, 8);
    DECLARE r_Price_R decimal(18, 8);
    DECLARE r_OutboundTime timestamp;
    DECLARE r_CTL_Status varchar(2);
    DECLARE r_SHP_CTL char(1);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_Wavestatus varchar(2);
    DECLARE r_PickToTraceID varchar(30);
    DECLARE r_OrderType varchar(10);
    DECLARE r_BillNo varchar(40);
    DECLARE r_HoldCheck char(1);
    DECLARE r_DEL_NO_CHK char(1);
    DECLARE r_LDLNo varchar(15);
    DECLARE r_OVR_ALC char(1);
    DECLARE v_orderNo varchar(30);
    DECLARE r_CancelOrderNO varchar(3000);
    DECLARE r_NO_COMMIT char(1);
    DECLARE r_SN_CTL char(1);
    DECLARE r_SALESORDERNO varchar(30);
    DECLARE r_SALESORDERLINENO int;
    DECLARE v_strsql varchar(3000);
    DECLARE r_erpcancelflag char(1);
    DECLARE r_DoubleConfirmBy varchar(40);
    DECLARE r_CheckTime timestamp;
    DECLARE r_LOADING_LIST_MODE char(1);
    DECLARE r_Return_LotNum varchar(10);
    DECLARE r_ShippmentCount int;
    DECLARE r_UDF2 varchar(100);
    DECLARE v_orderNoes varchar(2000);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE cCUR_ACT CURSOR FOR
    SELECT
      A.AllocationDetailsID,
      A.OrderNo,
      A.OrderLineNo,
      A.WaveNo,
      A.CustomerID,
      A.SKU,
      A.Lotnum,
      A.UOM,
      A.Location,
      A.TraceID,
      A.Qty,
      A.Qty_Each,
      A.PackID,
      A.Status,
      PickToLocation,
      A.PickTOTraceID,
      A.QtyPicked_Each,
      A.PickedTime,
      A.PickedWho,
      A.QtyShipped_Each,
      A.ShipmentTime,
      A.ShipmentWho,
      A.ReasonCode,
      A.Notes,
      A.Cubic,
      A.Grossweight,
      A.Netweight,
      A.Price,
      A.PackFlag,
      B.SALESORDERNO,
      B.SALESORDERLINENO,
      B.erpcancelflag,
      A.DoubleConfirmBy,
      A.CHECKTIME
    FROM TMP_SHIPMENT_LIST A
      INNER JOIN DOC_ORDER_DETAILS B
        ON A.ORDERNO = B.ORDERNO
        AND A.ORDERLINENO = B.ORDERLINENO
    WHERE A.Userid = IN_UserID
    ORDER BY A.ORDERNO, A.ORDERLINENO;
    DECLARE C_ODR CURSOR FOR
    SELECT
      h.orderno
    FROM DOC_ORDER_HEADER h
    WHERE h.organizationId = In_organizationId
    AND h.warehouseId = In_warehouse
    AND EXISTS (SELECT
        1
      FROM TMP_SHIPMENT_LIST t
      WHERE t.orderno = h.orderno
      AND t.Userid = IN_UserID)
    AND h.sostatus = '80'
    AND h.warehouseid = IN_Warehouse;
    DECLARE CUR_FULLCarton CURSOR FOR
    SELECT DISTINCT
      PicktoTraceID,
      PickToLocation
    FROM ACT_ALLOCATION_DETAILS
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND OrderNo = IN_OrderNo;
    DECLARE CUv_orderNos CURSOR FOR
    SELECT
      h.OrderNo
    FROM DOC_ORDER_HEADER h
    WHERE h.organizationId = In_organizationId
    AND h.warehouseId = In_warehouse
    AND EXISTS (SELECT
        t.orderno
      FROM TMP_SHIPMENT_LIST t
      WHERE t.OrderNo = h.OrderNo
      AND t.userid = IN_UserID)
    AND h.allowShipment = 'N';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_Shipment_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;
    SET v_error = 1;
    IF Out_return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET Out_Return_Code = '000';
    SET r_ShippmentCount = 0;
    SET r_CurrentTime = NOW();



    SET OUT_Return_Code = '000';
    SET v_orderNo = IN_OrderNO;
    SET r_LDLNo = '*';
    SET r_OutboundTime = DATE_FORMAT(IN_OutboundTime_CC, '%Y-%m-%d %H:%i:%s');
    IF NOT (UPPER(IN_Action) IN ('SHIP', 'TRANSFORM')) THEN
      SET OUT_Return_Code = '887';
      LEAVE ENDPROC;
    END IF;

    IF UPPER(IN_ProcessBy) = 'WAVENO'
      OR UPPER(IN_ProcessBy) = 'LOADLIST' THEN
      SET R_BillNo = IN_WaveNO;
    ELSEIF UPPER(IN_ProcessBy) = 'ORDERNO'
      OR UPPER(IN_ProcessBy) = 'ORDERNO + ORDERLINENO' THEN
      SET R_BillNo = IN_OrderNo;
    ELSEIF UPPER(IN_ProcessBy) = 'ALLOCATIONDETAILSID'
      OR UPPER(IN_ProcessBy) = 'DROPID'
      OR UPPER(IN_ProcessBy) = 'PICKTOTRACEID' THEN
      SET R_BillNo = IN_AllocationDetailsID;
    END IF;
    SET Out_Return_Code = '*_*';
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'SHIP_BEFORE', R_BillNo, IN_ProcessBy, IN_OrderLineNO, IN_Language, IN_UserID, Out_Return_Code);
    IF SUBSTRING(Out_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;
    SET r_HoldCheck = 'N';
    SET v_error = 1;
    IF UPPER(IN_ProcessBy) = 'WAVENO' THEN
      SELECT
        a.WarehouseID,
        a.OrderType,
        a.CustomerID,
        c.ReleaseStatus,
        a.orderno
      FROM DOC_ORDER_HEADER a
        INNER JOIN DOC_WAVE_DETAILS b
          ON a.OrderNo = b.OrderNo
          AND a.organizationId = b.organizationId
          AND a.warehouseId = b.warehouseId
        INNER JOIN DOC_Wave_header c
          ON b.WaveNo = c.WaveNo
          AND b.organizationId = c.organizationId
          AND b.warehouseId = c.warehouseId
      WHERE b.WaveNo = IN_WaveNO
      LIMIT 1 INTO R_WarehouseID, R_OrderType, R_CustomerID_R, R_ReleaseStatus, v_orderNo;
      SELECT
        COUNT(1),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          a.OrderNO
        FROM DOC_ORDER_HEADER a
          INNER JOIN DOC_WAVE_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNo = b.OrderNo
        WHERE b.organizationId = In_organizationId
        AND b.warehouseId = In_warehouse
        AND b.WaveNo = IN_WaveNO
        AND (a.ReleaseStatus IN ('N', 'H')
        OR a.ERPCancelFlag = 'Y')
        GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;
      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;
    ELSEIF UPPER(IN_ProcessBy) = 'LOADLIST' THEN

      SET r_LOADING_LIST_MODE = getsys_configuration(In_organizationId, IN_Warehouse, '*', '*', 'LOADING_LIST_MODE', 'N');
      IF r_LOADING_LIST_MODE = 'BYORDER' THEN
        SELECT
          a.WarehouseID,
          a.OrderType,
          a.CustomerID,
          a.ReleaseStatus,
          a.orderno
        FROM DOC_ORDER_HEADER a
          INNER JOIN DOC_LOADING_DETAILS c
            ON a.OrderNo = c.OrderNo
            AND a.organizationId = c.organizationId
            AND a.warehouseId = c.warehouseId
        WHERE c.LDLNo = IN_WaveNo
        LIMIT 1 INTO R_WarehouseID, R_OrderType, R_CustomerID_R, R_ReleaseStatus,
        v_orderNo;
        SELECT
          COUNT(1),
          GROUP_CONCAT(orderNO)
        FROM (SELECT
            a.OrderNO
          FROM DOC_ORDER_HEADER a
            INNER JOIN DOC_LOADING_DETAILS c
              ON a.OrderNo = c.OrderNo
              AND a.organizationId = c.organizationId
              AND a.warehouseId = c.warehouseId
          WHERE c.organizationId = In_organizationId
          AND c.warehouseId = In_warehouse
          AND c.LDLNo = IN_WaveNo
          AND (a.ReleaseStatus IN ('N', 'H')
          OR a.ERPCancelFlag = 'Y')
          GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;
      ELSE

        SELECT
          a.WarehouseID,
          a.OrderType,
          a.CustomerID,
          a.ReleaseStatus,
          a.orderno
        FROM DOC_ORDER_HEADER a
          INNER JOIN ACT_ALLOCATION_DETAILS b
            ON a.OrderNo = b.OrderNo
            AND a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
          INNER JOIN DOC_LOADING_DETAILS c
            ON b.AllocationDetailsid = c.AllocationDetailsID
            AND b.organizationId = c.organizationId
            AND b.warehouseId = c.warehouseId
        WHERE c.organizationId = b.organizationId
        AND c.warehouseId = In_warehouse
        AND c.LDLNo = IN_WaveNo
        LIMIT 1 INTO R_WarehouseID, R_OrderType, R_CustomerID_R, R_ReleaseStatus, v_orderNo;
        SELECT
          COUNT(1),
          GROUP_CONCAT(orderno)
        FROM (SELECT
            a.OrderNO
          FROM DOC_ORDER_HEADER a
            INNER JOIN ACT_ALLOCATION_DETAILS b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.orderNo = b.orderNo
            INNER JOIN DOC_LOADING_DETAILS c
              ON b.organizationId = c.organizationId
              AND b.warehouseId = c.warehouseId
              AND b.AllocationDetailsid = c.AllocationDetailsID
          WHERE c.organizationId = In_organizationId
          AND c.warehouseId = In_warehouse
          AND c.LDLNo = IN_WaveNo
          AND (a.ReleaseStatus IN ('N', 'H')
          OR a.ERPCancelFlag = 'Y')
          GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;
      END IF;
      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;
    ELSEIF UPPER(IN_ProcessBy) = 'PICKTOTRACEID' THEN
      SELECT
        a.WarehouseID,
        a.OrderType,
        a.CustomerID,
        a.ReleaseStatus,
        a.orderno
      FROM DOC_ORDER_HEADER a
        INNER JOIN ACT_ALLOCATION_DETAILS b
          ON a.OrderNo = b.OrderNo
          AND a.warehouseId = b.warehouseId
          AND a.organizationId = b.organizationId
      WHERE b.organizationId = In_organizationId
      AND b.warehouseId = In_warehouse
      AND b.PickToTraceID = IN_AllocationDetailsID
      LIMIT 1 INTO R_WarehouseID, R_OrderType, R_CustomerID_R, R_ReleaseStatus, v_orderNo;
      SELECT
        COUNT(1),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          a.OrderNO
        FROM DOC_ORDER_HEADER a
          INNER JOIN ACT_ALLOCATION_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNo = b.OrderNo
        WHERE b.organizationId = In_organizationId
        AND b.warehouseId = In_warehouse
        AND b.PickToTraceID = IN_AllocationDetailsID
        AND (a.ReleaseStatus IN ('N', 'H')
        OR ERPCancelFlag = 'Y')
        GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;
      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;
    ELSEIF UPPER(IN_ProcessBy) = 'ALLOCATIONDETAILSID' THEN
      SELECT
        a.WarehouseID,
        a.OrderType,
        a.CustomerID,
        a.ReleaseStatus,
        a.orderno
      FROM DOC_ORDER_HEADER a
        INNER JOIN ACT_ALLOCATION_DETAILS b
          ON a.OrderNo = b.OrderNo
          AND a.warehouseId = b.warehouseId
          AND a.organizationId = b.organizationId
      WHERE b.organizationId = In_organizationId
      AND b.warehouseId = In_warehouse
      AND b.AllocationDetailsID = IN_AllocationDetailsID
      LIMIT 1 INTO R_WarehouseID, R_OrderType, R_CustomerID_R, R_ReleaseStatus, v_orderNo;
      SELECT
        COUNT(1),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          a.OrderNO
        FROM DOC_ORDER_HEADER a
          INNER JOIN ACT_ALLOCATION_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNo = b.OrderNo
        WHERE b.organizationId = In_organizationId
        AND b.warehouseId = In_warehouse
        AND b.AllocationDetailsID = IN_AllocationDetailsID
        AND (a.ReleaseStatus IN ('N', 'H')
        OR ERPCancelFlag = 'Y')
        GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;
      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;
    ELSEIF UPPER(IN_ProcessBy) = 'DROPID' THEN
      SELECT
        a.WarehouseID,
        a.OrderType,
        a.CustomerID,
        a.ReleaseStatus,
        a.orderno
      FROM DOC_ORDER_HEADER a
        INNER JOIN ACT_ALLOCATION_DETAILS b
          ON a.OrderNo = b.OrderNo
          AND a.organizationId = b.organizationId
          AND a.warehouseId = b.warehouseId
      WHERE b.organizationId = In_organizationId
      AND b.warehouseId = In_warehouse
      AND b.dropID = IN_AllocationDetailsID
      LIMIT 1 INTO R_WarehouseID, R_OrderType, R_CustomerID_R, R_ReleaseStatus, v_orderNo;
      SELECT
        COUNT(1),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          a.OrderNO
        FROM DOC_ORDER_HEADER a
          INNER JOIN ACT_ALLOCATION_DETAILS b
            ON a.OrderNo = b.OrderNo
            AND a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
        WHERE b.organizationId = In_organizationId
        AND b.warehouseId = In_warehouse
        AND b.DropID = IN_AllocationDetailsID
        AND (a.ReleaseStatus IN ('N', 'H')
        OR ERPCancelFlag = 'Y')
        GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;
      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;
    ELSE
      SELECT
        WarehouseID,
        OrderType,
        CustomerID,
        ReleaseStatus,
        orderno
      FROM DOC_ORDER_HEADER
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNo = IN_OrderNO
      LIMIT 1 INTO R_WarehouseID, R_OrderType, R_CustomerID_R, R_ReleaseStatus, v_orderNo;
      SELECT
        COUNT(1),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          OrderNO
        FROM DOC_ORDER_HEADER
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND OrderNo = IN_OrderNo
        AND (ReleaseStatus IN ('N', 'H')
        OR ERPCancelFlag = 'Y')
        GROUP BY Orderno) AA INTO r_nRow, r_CancelOrderNO;
      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;
    END IF;
    IF v_error = 0 THEN
      SET OUT_Return_Code = '402';
      LEAVE ENDPROC;
    END IF;
    IF r_HoldCheck = 'Y' THEN
      SET OUT_Return_Code = '432';
      LEAVE ENDPROC;
    END IF;

    SET r_SHP_CTL = getsys_configuration_D(In_organizationId, IN_Warehouse, r_CustomerID_R, r_OrderType, 'SHP_CTL', 'N');


    SET r_DEL_NO_CHK = getsys_configuration_D(In_organizationId, IN_Warehouse, r_CustomerID_R, r_OrderType, 'DEL_NO_CHK', 'N');
    IF r_DEL_NO_CHK = 'Y' THEN
      SELECT
        COUNT(1)
      FROM DOC_ORDER_PACKING_SUMMARY
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNo = v_orderNo
      AND DeliveryNo IS NULL INTO r_nRow;
      IF r_nRow > 0 THEN
        SET OUT_Return_Code = '447';
        SET OUT_Return_Code = '473';
        LEAVE ENDPROC;
      END IF;
    END IF;

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_SHIPMENT_LIST (
      allocationdetailsId varchar(20),
      orderno varchar(20),
      orderlineno int,
      waveno varchar(30),
      customerid varchar(30),
      sku varchar(50),
      lotnum varchar(10),
      uom varchar(10),
      location varchar(30),
      traceid varchar(30),
      qty decimal(18, 8),
      qty_each decimal(18, 8),
      packid varchar(40),
      STATUS char(2),
      picktolocation varchar(30),
      picktotraceid varchar(30),
      qtypicked_each decimal(18, 8),
      pickedtime timestamp,
      pickedwho varchar(30),
      qtyshipped_each decimal(18, 8),
      shipmenttime timestamp,
      shipmentwho varchar(30),
      reasoncode char(2),
      notes varchar(100),
      cubic decimal(18, 8),
      grossweight decimal(18, 8),
      netweight decimal(18, 8),
      price decimal(18, 8),
      packflag char(1),
      userid varchar(30),
      doubleconfirmby varchar(30),
      checktime timestamp
    );
    DELETE
      FROM TMP_SHIPMENT_LIST
    WHERE userId = IN_UserID;
    IF IN_ProcessBy = 'WaveNo' THEN

      INSERT INTO TMP_SHIPMENT_LIST (AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          a.doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS a
        WHERE b.organizationId = In_organizationId
        AND b.warehouseId = In_warehouse
        AND b.WaveNo = IN_WaveNO
        AND STATUS < '80';

    ELSEIF UPPER(IN_ProcessBy) = UPPER('OrderNo') THEN
      INSERT INTO TMP_SHIPMENT_LIST (AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND OrderNO = IN_OrderNO
        AND STATUS < '80';

    ELSEIF UPPER(IN_ProcessBy) = UPPER('OrderNo + OrderLineNo') THEN
      INSERT INTO TMP_SHIPMENT_LIST (AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND OrderNO = IN_OrderNO
        AND OrderLineNo = IN_OrderLineNo
        AND STATUS < '80';

    ELSEIF UPPER(IN_ProcessBy) = UPPER('AllocationDetailsID') THEN
      INSERT INTO TMP_SHIPMENT_LIST (AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND AllocationDetailsID = IN_AllocationDetailsID
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('PickToTraceID') THEN
      INSERT INTO TMP_SHIPMENT_LIST (AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND PickToTraceID = IN_AllocationDetailsID
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('DropID') THEN
      INSERT INTO TMP_SHIPMENT_LIST (AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND DropID = IN_AllocationDetailsID
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('LoadList') THEN

      IF r_LOADING_LIST_MODE = 'BYORDER' THEN
        INSERT INTO TMP_SHIPMENT_LIST (AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
        , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
        , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
        , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
        , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
          SELECT
            a.AllocationDetailsID,
            a.OrderNo,
            a.OrderLineNO,
            a.WaveNo,
            a.CustomerID,
            a.SKU,
            LotNUM,
            a.UOM,
            a.Location,
            a.TraceID,
            a.Qty,
            a.Qty_Each,
            a.PackID,
            a.Status,
            a.PickToLocation,
            a.PickToTraceID,
            a.QtyPicked_Each,
            a.PickedTime,
            a.PickedWho,
            a.QtyShipped_Each,
            ShipmentTime,
            ShipmentWho,
            a.ReasonCode,
            a.Notes,
            a.Cubic,
            a.GrossWeight,
            a.NetWeight,
            a.Price,
            a.PackFlag,
            IN_UserID,
            doublecheckby,
            CHECKTIME
          FROM ACT_ALLOCATION_DETAILS a
            INNER JOIN DOC_LOADING_DETAILS b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.OrderNo = b.OrderNo
          WHERE b.organizationId = In_organizationId
          AND b.warehouseId = In_warehouse
          AND b.LDLNo = IN_WaveNO
          AND a.Status < '80';
      ELSE

        INSERT INTO TMP_SHIPMENT_LIST (AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
        , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
        , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
        , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
        , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
          SELECT
            a.AllocationDetailsID,
            a.OrderNo,
            a.OrderLineNO,
            a.WaveNo,
            a.CustomerID,
            a.SKU,
            LotNUM,
            a.UOM,
            a.Location,
            a.TraceID,
            a.Qty,
            a.Qty_Each,
            a.PackID,
            a.Status,
            a.PickToLocation,
            a.PickToTraceID,
            a.QtyPicked_Each,
            a.PickedTime,
            a.PickedWho,
            a.QtyShipped_Each,
            ShipmentTime,
            ShipmentWho,
            a.ReasonCode,
            a.Notes,
            a.Cubic,
            a.GrossWeight,
            a.NetWeight,
            a.Price,
            a.PackFlag,
            IN_UserID,
            doublecheckby,
            CHECKTIME
          FROM ACT_ALLOCATION_DETAILS a
            LEFT JOIN DOC_LOADING_DETAILS b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.AllocationDetailsID = b.AllocationDetailsID
          WHERE b.organizationId = In_organizationId
          AND b.warehouseId = In_warehouse
          AND b.LDLNo = IN_WaveNO
          AND a.Status < '80';
      END IF;
    END IF;
    SELECT
      COUNT(1)
    FROM TMP_SHIPMENT_LIST
    WHERE userid = IN_UserID INTO r_nRow;
    IF r_nRow = 0 THEN
      SET OUT_Return_Code = '413';
      LEAVE ENDPROC;
    END IF;

    SELECT
      GROUP_CONCAT(h.OrderNo)
    FROM DOC_ORDER_HEADER h
    WHERE h.organizationId = In_organizationId
    AND h.warehouseId = In_warehouse
    AND EXISTS (SELECT
        t.orderno
      FROM TMP_SHIPMENT_LIST t
      WHERE t.OrderNo = h.OrderNo
      AND t.userid = IN_UserID)
    AND h.allowPartialShip = 'N'
    AND EXISTS (SELECT
        1
      FROM DOC_ORDER_DETAILS
      WHERE h.orderno = orderno
      AND h.organizationId = IN_organizationId
      AND h.warehouseId = In_warehouse
      AND qtyallocated_each < qtyordered_each) INTO v_orderNoes;
    IF v_orderNoes IS NOT NULL THEN
      SET OUT_Return_Code = CONCAT('999#??', v_orderNoes, '?????????');
      LEAVE ENDPROC;
    END IF;



    SET v_errormessage = 'OPen';
    OPEN cCUR_ACT;
    SET v_error = 1;
    FETCH cCUR_ACT
    INTO r_AllocationDetailsID_R, v_orderNo_R, r_OrderLineNO_R, r_WaveNO_R
    , r_CustomerID_R, r_Sku_R, r_LotNUM_R, r_UOM_R
    , r_Location_R, r_TraceID_R, r_Qty_R, r_Qty_Each_R, r_PackID_R
    , r_Status_R
    , r_PickToLocation_R, r_PickToTraceID_R
    , r_QtyPicked_Each_R, r_PickedTime_R, r_PickedWho_R
    , r_QtyShipped_Each_R, r_ShipmentTime_R, r_ShipmentWho_R, r_ReasonCode_R, r_Notes_R
    , r_Cubic_R, r_GrossWeight_R, r_NetWeight_R, r_Price_R
    , r_PackFlag
    , r_SALESORDERNO, r_SALESORDERLINENO
    , r_erpcancelflag
    , r_DoubleConfirmBy
    , r_CheckTime;
  LOOP1:
    WHILE v_error <> 0 DO


      IF r_erpcancelflag = 'Y' THEN
        CLOSE cCUR_ACT;
        SET OUT_Return_Code = CONCAT('476', v_orderNo_R, ',', r_OrderLineNO_R);
        IF r_NO_COMMIT = 'Y' THEN
          ROLLBACK;
        END IF;
        LEAVE ENDPROC;
      END IF;




      SET OUT_Return_Code = '*_*';
      CALL SPCOM_GetIDSequence(In_organizationId, IN_Warehouse, IN_Language, 'TransactionID', r_TransactionID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        CLOSE cCUR_ACT;
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_ShipmentTime_R IS NULL THEN
        SET r_ShipmentTime_R = r_CurrentTime;
      END IF;
      IF r_ShipmentWho_R IS NULL THEN
        SET r_ShipmentWho_R = IN_UserID;
      END IF;


      IF r_Status_R = '60' THEN
        SET r_Location_R = r_PickToLocation_R;
        SET r_TraceID_R = r_PickToTraceID_R;
      END IF;

      SELECT
        COUNT(1)
      FROM INV_LOT_LOC_ID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND TraceID = r_TraceID_R
      AND LotNUM = r_LotNUM_R
      AND LocationID = r_Location_R
      AND Qty >= r_Qty_Each_R
      AND QtyAllocated >= r_Qty_Each_R INTO r_nRow;
      IF r_nrow <= 0 THEN
        SET OUT_Return_Code = CONCAT('315', r_LotNUM_r, '/', r_Location_R, '/', r_TraceID_R);
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      UPDATE INV_LOT_LOC_ID
      SET Cubic = Cubic - r_Cubic_R,
          GrossWeight = GrossWeight - r_GrossWeight_R,
          NetWeight = NetWeight - r_NetWeight_R,
          Price = Price - r_Price_R,
          Qty = Qty - r_Qty_Each_R,
          QtyAllocated = QtyAllocated - r_Qty_Each_R,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND TraceID = r_TraceID_R
      AND LotNUM = r_LotNUM_R
      AND LocationID = r_Location_R;

      UPDATE INV_LOT
      SET Cubic = Cubic - r_Cubic_R,
          GrossWeight = GrossWeight - r_GrossWeight_R,
          NetWeight = NetWeight - r_NetWeight_R,
          Price = Price - r_Price_R,
          Qty = Qty - r_Qty_Each_R,
          QtyAllocated = QtyAllocated - r_Qty_Each_R,
          QtyPreAllocated = QtyPreAllocated - r_Qty_Each_R,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND LotNum = r_LotNUM_R;

      UPDATE ACT_ALLOCATION_DETAILS
      SET QtyShipped_Each = r_Qty_Each_R,
          ShipmentTime = r_ShipmentTime_R,
          ShipmentWho = r_ShipmentWho_R,
          STATUS = '80',
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND AllocationDetailsID = r_AllocationDetailsID_R
      AND STATUS < '80';
      IF ROW_COUNT() = 0 THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET r_LineStatus = NULL;
      SELECT
        QtyOrdered_Each,
        QtyShipped_Each,
        PackID,
        packUOM,
        Qtyallocated_Each
      FROM DOC_ORDER_DETAILS
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNO = v_orderNo_R
      AND OrderLineNO = r_OrderLineNO_R INTO r_QtyOrdered_Each_O, r_QtyShipped_Each_O, r_PackID_O, r_UOM_O, r_Qtyallocated_Each;
      SET v_error = 1;
      SELECT
        MAX(CASE WHEN packUom = 'EA' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'CS' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'PL' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'OT' THEN qty ELSE NULL END)
      FROM BAS_PACKAGE_DETAILS
      WHERE organizationId = In_organizationId
      AND customerId = r_CustomerID_R
      AND PackID = R_PackID_O INTO R_QTY1_P, R_QTY2_P, R_QTY3_P, R_QTY4_P, R_QTY5_P;
      IF v_error = 0 THEN
        CLOSE cCUR_ACT;
        SET OUT_Return_Code = CONCAT('103', RTRIM(r_PackID_R));
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      IF r_UOM_O = 'EA' THEN
        SET r_UOMQty = r_QTY1_P;
      ELSEIF r_UOM_O = 'IP' THEN
        SET r_UOMQty = r_QTY2_P;
      ELSEIF r_UOM_O = 'CS' THEN
        SET r_UOMQty = r_QTY3_P;
      ELSEIF r_UOM_O = 'PL' THEN
        SET r_UOMQty = r_QTY4_P;
      ELSEIF r_UOM_O = 'OT' THEN
        SET r_UOMQty = r_QTY5_P;
      END IF;
      IF r_UOMQty <= 0 THEN
        ROLLBACK;
        CLOSE cCUR_ACT;
        SET OUT_Return_Code = CONCAT('103', RTRIM(r_PackID_R));
        LEAVE ENDPROC;
      END IF;
      SET r_QtyShipped_O = (r_QtyShipped_Each_O + r_Qty_Each_R) / r_UOMQty;
      IF r_Qtyallocated_Each > 0 THEN
        IF r_Qtyallocated_Each - r_QtyShipped_Each_O - r_Qty_Each_R < 0 THEN
          ROLLBACK;
          CLOSE cCUR_ACT;
          SET OUT_Return_Code = '424??????????';
          LEAVE ENDPROC;
        END IF;
      ELSE
        SET v_error = 1;
        SELECT
          OverPreAllocation
        FROM DOC_ORDER_DETAILS a
          INNER JOIN RUL_SOFTALLOCATION_HEADER b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.SoftAllocationRule = b.SoftAllocationID
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseId = IN_warehouse
        AND a.OrderNo = v_orderNo_R
        AND a.OrderLineNO = r_OrderLineNO_R INTO r_OVR_ALC;
        SET r_OVR_ALC = 'Y';
        IF r_OVR_ALC = 'N' THEN
          IF r_QtyOrdered_Each_O - r_QtyShipped_Each_O - r_Qty_Each_R < 0 THEN
            ROLLBACK;
            CLOSE cCUR_ACT;
            SET OUT_Return_Code = '424??????????';
            LEAVE ENDPROC;
          END IF;
        END IF;
      END IF;
      IF r_QtyOrdered_Each_O - r_QtyShipped_Each_O - r_Qty_Each_R <= 0 THEN
        SET r_LineStatus = '80';
      ELSE
        SET r_LineStatus = '70';
      END IF;
      UPDATE DOC_ORDER_DETAILS
      SET QtyShipped_Each = QtyShipped_Each + r_Qty_Each_R,
          QtyShipped = r_QtyShipped_O,
          LineStatus = r_LineStatus,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNO = v_orderNo_R
      AND OrderLineNO = r_OrderLineNO_R;

      IF IFNULL(r_SALESORDERNO, '*') <> '*' THEN
        SELECT
          SUM(b.QTYSHIPPED),
          SUM(b.QTYSHIPPED_EACH)
        FROM DOC_ORDER_DETAILS b
        WHERE b.SALESORDERNO = r_SALESORDERNO
        AND b.SALESORDERLINENO = r_SALESORDERLINENO INTO r_QtyShipped_O, r_QtyShipped_Each_O;
        UPDATE DOC_SALESORDER_DETAILS a
        SET a.QTYSHIPPED = r_QtyShipped_O,
            a.QTYSHIPPED_EACH = r_QtyShipped_Each_O,
            a.EDITTIME = R_CurrentTime,
            a.EDITWHO = in_UserID,
            a.LINESTATUS = CASE WHEN IFNULL(a.QTYSHIPPED_EACH, 0) = 0 THEN a.LINESTATUS WHEN a.QTYORDERED_EACH > r_QtyShipped_Each_O THEN '70' ELSE '80' END
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND a.SALESORDERNO = r_SALESORDERNO
        AND a.SALESORDERLINENO = r_SALESORDERLINENO;
        SELECT
          CASE MIN(d.LINESTATUS) WHEN '80' THEN '80' ELSE '70' END
        FROM DOC_SALESORDER_DETAILS d
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND d.SALESORDERNO = r_SALESORDERNO INTO r_LineStatus;
        SELECT
          ORDERSTATUS
        FROM DOC_SALESORDER_HEADER
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND SALESORDERNO = r_SALESORDERNO INTO r_Status;
        IF r_LineStatus <> r_Status THEN
          UPDATE DOC_SALESORDER_HEADER a
          SET a.ORDERSTATUS = r_Status_R
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND SALESORDERNO = r_SALESORDERNO;
        END IF;
      END IF;


      UPDATE TSK_SORTATION_STATION
      SET CubicUsed = CubicUsed - r_Cubic_R,
          qty = qty - r_Qty_Each_R
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND LocationID = r_PickToLocation_R
      AND OrderNo = v_orderNo_R;
      DELETE
        FROM TSK_SORTATION_STATION
      WHERE qty = 0;


      IF r_UOM_R = 'EA' THEN
        SET r_UOMQty = r_QTY1_P;
      ELSEIF r_UOM_R = 'IP' THEN
        SET r_UOMQty = r_QTY2_P;
      ELSEIF r_UOM_R = 'CS' THEN
        SET r_UOMQty = r_QTY3_P;
      ELSEIF r_UOM_R = 'PL' THEN
        SET r_UOMQty = r_QTY4_P;
      ELSEIF r_UOM_R = 'OT' THEN
        SET r_UOMQty = r_QTY5_P;
      END IF;
      IF r_UOMQty <= 0 THEN
        ROLLBACK;
        CLOSE cCUR_ACT;
        SET OUT_Return_Code = CONCAT('103', RTRIM(r_PackID_R));
        LEAVE ENDPROC;
      END IF;

      SELECT
        WarehouseID,
        OrderType,
        CustomerID
      FROM DOC_ORDER_HEADER
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNo = v_orderNo_R INTO r_WarehouseID, R_OrderType, R_CustomerID_R;
      INSERT INTO ACT_TRANSACTION_LOG (organizationId, TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
      , TransactionType
      , DocNo, DocLineNo, DocType
      , FMCustomerID, FMSKU
      , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
      , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
      , STATUS
      , TOCustomerID, TOSku
      , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
      , WarehouseID
      , ADDTIME, AddWho, EditTime, EditWho, TransactionTime
      , Edisendflag
      , Operator)
        VALUES (In_organizationId, r_TransactionID, r_AllocationDetailsID_R, 0, 'N', NULL, 0, 'N', 'SO', v_orderNo_R, r_OrderLineNO_R, 'SO', r_CustomerID_R, r_Sku_R, r_LotNum_R, r_Location_R, r_TraceID_R, r_PackID_R, r_UOM_R, r_Qty_Each_R / r_UOMQty, r_Qty_Each_R, r_LotNum_R, r_Location_R, r_TraceID_R, r_PackID_R, r_UOM_R, r_Qty_Each_R / r_UOMQty, r_Qty_Each_R, '99', r_CustomerID_R, r_Sku_R, r_Cubic_R, r_GrossWeight_R, r_NetWeight_R, r_Price_R, r_WarehouseID, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_ShipmentTime_R, 'N', IN_UserID);

      IF r_Status_R = '40' THEN
        UPDATE TSK_TASKLISTS
        SET TaskProcess = '99',
            Completed_TransactionID = r_TransactionID,
            CloseTime = r_ShipmentTime_R,
            CloseWho = r_ShipmentWho_R,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND AllocationDetailsID = r_AllocationDetailsID_R;
      END IF;


      SELECT
        COUNT(1)
      FROM DOC_ORDER_DETAILS
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNo = v_orderNo_R
      AND LineStatus < '80' INTO R_nROw;
      IF R_nROw > 0 THEN
        SET r_status = '70';
      ELSE
        SET r_status = '80';
      END IF;
      UPDATE DOC_ORDER_HEADER
      SET SOStatus = r_status,
          LastShipmentTime = r_ShipmentTime_R,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNo = v_orderNo_R;
      UPDATE DOC_WAVE_DETAILS
      SET Linestatus = r_status,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNo = v_orderNo_R;
      IF r_NO_COMMIT = 'Y' THEN
        COMMIT;
      END IF;
      SET r_ShippmentCount = r_ShippmentCount + 1;
      SET v_error = 1;
      FETCH cCUR_ACT
      INTO r_AllocationDetailsID_R, v_orderNo_R, r_OrderLineNO_R, r_WaveNO_R
      , r_CustomerID_R, r_Sku_R, r_LotNUM_R, r_UOM_R
      , r_Location_R, r_TraceID_R, r_Qty_R, r_Qty_Each_R, r_PackID_R
      , r_Status_R
      , r_PickToLocation_R, r_PickToTraceID_R
      , r_QtyPicked_Each_R, r_PickedTime_R, r_PickedWho_R
      , r_QtyShipped_Each_R, r_ShipmentTime_R, r_ShipmentWho_R, r_ReasonCode_R, r_Notes_R
      , r_Cubic_R, r_GrossWeight_R, r_NetWeight_R, r_Price_R
      , r_PackFlag
      , r_SALESORDERNO, r_SALESORDERLINENO
      , r_erpcancelflag
      , r_DoubleConfirmBy
      , r_CheckTime;
    END WHILE;
    CLOSE cCUR_ACT;

    SET r_SN_CTL = getsys_configuration_D(In_organizationId, IN_Warehouse, r_CustomerID_R, r_OrderType, 'SN#_CTL', '0');
    IF r_SN_CTL = '1' THEN
      UPDATE DOC_ASN_SERIALNO T
      SET StockFlag = 'N'
      WHERE T.organizationId = In_organizationId
      AND T.warehouseId = In_warehouse
      AND EXISTS (SELECT
          1
        FROM DOC_ORDER_SERIALNO A
          INNER JOIN TMP_SHIPMENT_LIST B
            ON B.picktotraceid = A.TRACEID
            AND B.OrderNo = A.ORDERNO
        WHERE B.userid = IN_UserID
        AND A.organizationId = In_organizationId
        AND A.warehouseId = In_warehouse
        AND T.SerialNo = A.SerialNo
        AND T.customerid = A.customerid)
      AND StockFlag = 'Y';
    ELSEIF r_SN_CTL = '2' THEN

      UPDATE DOC_ASN_SUBSERIALNO T
      SET StockFlag = 'N'
      WHERE SerialNo IN (SELECT
          SerialNo
        FROM DOC_ORDER_SERIALNO A
        WHERE EXISTS (SELECT
            1
          FROM TMP_SHIPMENT_LIST
          WHERE picktotraceid = A.SerialNO
          AND OrderNo = A.ORDERNO
          AND userid = IN_UserID)
        AND NOT EXISTS (SELECT
            1
          FROM DOC_ORDER_SUBSERIALNO B
          WHERE a.ORDERNO = b.ORDERNO
          AND a.SerialNO = b.SerialNO))
      AND EXISTS (SELECT
          1
        FROM bas_SKU
        WHERE CUSTOMERID = T.CUSTOMERID
        AND SKU = T.SKU
        AND SerialNoCatch = 'Y')
      AND StockFlag = 'Y';

      UPDATE DOC_ASN_SUBSERIALNO T
      SET StockFlag = 'N'
      WHERE SubSerialNo IN (SELECT
          SubSerialNo
        FROM DOC_ORDER_SUBSERIALNO A
        WHERE EXISTS (SELECT
            1
          FROM TMP_SHIPMENT_LIST
          WHERE picktotraceid = A.SerialNO
          AND OrderNo = A.ORDERNO
          AND userid = IN_UserID))
      AND EXISTS (SELECT
          1
        FROM bas_SKU
        WHERE CUSTOMERID = T.CUSTOMERID
        AND SKU = T.SKU
        AND SerialNoCatch = 'Y')
      AND StockFlag = 'Y';


      UPDATE DOC_ASN_SERIALNO a
      SET a.StockFlag = 'N'
      WHERE EXISTS (SELECT
          1
        FROM DOC_ASN_SUBSERIALNO b
        WHERE (a.sku = b.sku)
        AND a.SerialNO = b.SerialNO
        AND SubSerialNo IN (SELECT
            SubSerialNo
          FROM DOC_ORDER_SUBSERIALNO A
          WHERE EXISTS (SELECT
              1
            FROM TMP_SHIPMENT_LIST
            WHERE picktotraceid = A.SerialNO
            AND OrderNo = A.ORDERNO
            AND userid = IN_UserID)))
      AND NOT EXISTS (SELECT
          1
        FROM DOC_ASN_SUBSERIALNO b
        WHERE (a.sku = b.sku)
        AND a.SerialNO = b.SerialNO
        AND B.StockFlag = 'Y')
      AND a.StockFlag = 'Y';
      UPDATE DOC_ASN_SERIALNO a
      SET a.StockFlag = 'N'
      WHERE EXISTS (SELECT
          1
        FROM DOC_ASN_SUBSERIALNO b
        WHERE (a.Sku = 'MIXSKU')
        AND a.SerialNO = b.SerialNO
        AND SubSerialNo IN (SELECT
            SubSerialNo
          FROM DOC_ORDER_SUBSERIALNO A
          WHERE EXISTS (SELECT
              1
            FROM TMP_SHIPMENT_LIST
            WHERE picktotraceid = A.SerialNO
            AND OrderNo = A.ORDERNO
            AND userid = IN_UserID)))
      AND NOT EXISTS (SELECT
          1
        FROM DOC_ASN_SUBSERIALNO b
        WHERE (a.Sku = 'MIXSKU')
        AND a.SerialNO = b.SerialNO
        AND B.StockFlag = 'Y')
      AND a.StockFlag = 'Y';

    END IF;



    IF r_SHP_CTL = 'Y' THEN
      OPEN C_ODR;
      SET v_error = 1;
      FETCH C_ODR INTO v_orderNo;
      WHILE v_error <> 0 DO
        SELECT
          COUNT(1)
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND OrderNo = v_orderNo
        AND STATUS < 80 INTO r_nRow;
        IF r_nRow = 0 THEN
          SET OUT_Return_Code = '*_*';
          CALL SPSO_CloseCancel(In_organizationId, IN_Warehouse, 'CLOSE', v_orderNo, 'N', IN_Language, IN_UserID, OUT_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
        END IF;
        SET v_error = 1;
        FETCH C_ODR INTO v_orderNo;
      END WHILE;
      CLOSE C_ODR;
      IF r_NO_COMMIT = 'Y' THEN
        COMMIT;
      END IF;
    END IF;

    IF IN_ProcessBy = 'DropID' THEN
      DELETE
        FROM DOC_ORDER_PACKING
      WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND TraceID = r_PickToTraceID_R;
    ELSEIF IN_ProcessBy = 'OrderNo' THEN
      DELETE
        FROM DOC_ORDER_PACKING
      WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND OrderNo = v_orderNo_R;
    END IF;

    IF IN_Action IN ('TRANSFORM') THEN
      SET v_error = 1;
      SELECT
        LotNum
      FROM INV_LOT_ATT
      WHERE organizationId = In_organizationId
      AND CustomerID = r_CustomerID_R
      AND SKU = 'FULLCARTON'
      AND LotAtt01 IS NULL
      AND LotAtt02 IS NULL
      AND LotAtt03 IS NULL
      AND LotAtt04 = IN_OrderNO
      AND LotAtt05 IS NULL
      AND LotAtt06 IS NULL
      AND LotAtt07 IS NULL
      AND LotAtt08 IS NULL
      AND LotAtt09 IS NULL
      AND LotAtt10 IS NULL
      AND LotAtt11 IS NULL
      AND LotAtt12 IS NULL
      LIMIT 1 INTO r_Return_LotNum;
      IF v_error = 0 THEN
        SET OUT_Return_Code = 'NO_COMMIT';
        CALL SPCOM_GetIDSequence(In_organizationId, IN_Warehouse, in_Language, 'LOTNumber', r_Return_LotNum, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
        END IF;
        INSERT INTO INV_LOT_ATT (organizationId, warehouseId, CustomerID, SKU, LotNum
        , LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05, LotAtt06
        , LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12
        , ADDTIME, AddWho, EditTime, EditWho, ReceivingTime)
          VALUES (In_organizationId, In_warehouse, r_CustomerID_R, 'FULLCARTON', r_Return_LotNum, '', '', '', v_orderNo_R, '', '', '', '', '', '', '', '', r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_CurrentTime);
      END IF;
      OPEN CUR_FULLCarton;
      SET v_error = 1;
      FETCH CUR_FULLCarton INTO r_PickToTraceID_R, r_PickToLocation_R;
      WHILE v_error <> 0 DO

        SET r_nRow = 0;
        SELECT
          1
        FROM INV_LOT
        WHERE LotNum = r_Return_LotNum INTO r_nRow FOR UPDATE;
        IF r_nRow <= 0 THEN
          INSERT INTO INV_LOT (organizationId, warehouseId, LotNum, CustomerID, SKU, Qty, Cubic, GrossWeight, NetWeight, Price, QtyPreAllocated, QtyAllocated, QtyOnHold, ADDTIME, AddWho, EditTime, EditWho)
            VALUES (In_organizationId, In_warehouse, r_Return_LotNum, r_CustomerID_R, 'FULLCARTON', 1, 0, 0, 0, 0, 0, 0, 0, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID);
        ELSE
          UPDATE INV_LOT
          SET Qty = Qty + 1,
              EditTime = r_CurrentTime,
              EditWho = IN_UserID
          WHERE organizationId = In_organizationId
          AND LotNum = r_Return_LotNum;
        END IF;

        SET r_nRow = 0;
        SELECT
          1
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND LotNum = r_Return_LotNum
        AND LocationID = r_PickToLocation_R
        AND TraceID = r_PickToTraceID_R INTO r_nRow FOR UPDATE;
        IF r_nRow <= 0 THEN
          INSERT INTO INV_LOT_LOC_ID (organizationId, warehouseId, LotNum, LocationID, TraceID, CustomerID, SKU, Qty, QtyAllocated, QtyRPOut, QtyMVOut, QtyRPIn, QtyMVIn, QtyOnHold, Cubic, GrossWeight, NetWeight, Price, ADDTIME, AddWho, EditTime, EditWho)
            VALUES (In_organizationId, In_warehouse, r_Return_LotNum, r_PickToLocation_R, r_PickToTraceID_R, r_CustomerID_R, 'FULLCARTON', 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID);
        ELSE
          UPDATE INV_LOT_LOC_ID
          SET Qty = Qty + 1,
              EditTime = r_CurrentTime,
              EditWho = IN_UserID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND LotNum = r_Return_LotNum
          AND LocationID = r_PickToLocation_R
          AND TraceID = r_PickToTraceID_R;
        END IF;
        SET v_error = 1;
        FETCH CUR_FULLCarton INTO r_PickToTraceID_R, r_PickToLocation_R;
      END WHILE;
      CLOSE CUR_FULLCarton;
      IF r_NO_COMMIT = 'Y' THEN
        COMMIT;
      END IF;
    END IF;
    IF r_ShippmentCount < 1 THEN
      SET OUT_Return_Code = '413';
      LEAVE ENDPROC;
    END IF;

    IF UPPER(IN_ProcessBy) = 'ALLOCATIONDETAILSID' THEN
      UPDATE DOC_LOADING_DETAILS
      SET lineStatus = '80'
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND AllocationDetailsID = IN_AllocationDetailsID;
      SELECT
        LDLNo
      FROM DOC_LOADING_DETAILS
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND AllocationDetailsID = IN_AllocationDetailsID INTO r_LDLNo;
    END IF;
    IF UPPER(IN_ProcessBy) = 'DROPID'
      OR UPPER(IN_ProcessBy) = 'PICKTOTRACEID' THEN
      UPDATE DOC_LOADING_DETAILS
      SET lineStatus = '80'
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND TraceID = IN_AllocationDetailsID;
      SELECT
        LDLNo
      FROM DOC_LOADING_DETAILS
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND TraceID = IN_AllocationDetailsID
      LIMIT 1 INTO r_LDLNo;
    END IF;
    IF UPPER(IN_ProcessBy) = 'LOADLIST' THEN
      UPDATE DOC_LOADING_DETAILS
      SET lineStatus = '80'
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND LDLNO = IN_WAVNO;
      SET r_LDLNo = IN_WaveNo;
    END IF;
    IF IFNULL(r_LDLNO, '*') <> '*' THEN
      IF r_LOADING_LIST_MODE = 'BYORDER' THEN
        SELECT
          COUNT(1)
        FROM DOC_LOADING_DETAILS a
          INNER JOIN DOC_ORDER_HEADER b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNO = b.OrderNO
        WHERE a.oganizationId = In_oganizationId
        AND a.warehouseId = In_warehouse
        AND a.LDLNo = r_LDLNO
        AND b.SOStatus < '80' INTO r_nRow;
      ELSE
        SELECT
          COUNT(1)
        FROM DOC_LOADING_DETAILS a
          INNER JOIN ACT_ALLOCATION_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.AllocationDetailsID = b.AllocationDetailsID
        WHERE a.oganizationId = In_oganizationId
        AND a.warehouseId = In_warehouse
        AND a.LDLNo = r_LDLNO
        AND b.Status < '80' INTO r_nRow;
      END IF;
      IF r_nRow = 0 THEN
        UPDATE DOC_LOADING_HEADER
        SET STATUS = '80'
        WHERE LDLNO = r_LDLNO;
      END IF;
    END IF;




    SET OUT_Return_Code = '*_*';
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'SHIP_AFTER', R_BillNo, IN_ProcessBy, IN_OrderLineNO, IN_Language, IN_UserID, Out_Return_Code);
    IF SUBSTRING(Out_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;

    DELETE
      FROM TMP_SHIPMENT_LIST
    WHERE userid = IN_UserID;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `SPINV_Hold_Update`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPINV_Hold_Update (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_CustomerID varchar(20),
IN IN_SKU varchar(20),
IN IN_LotNUM varchar(20),
IN IN_Location varchar(20),
IN IN_TraceID varchar(30),
IN IN_Language varchar(20),
IN IN_UserID varchar(20),
INOUT OUT_Return_Code varchar(500))
ENDPROC:
  BEGIN

    DECLARE SP_sql_r varchar(2000);
    DECLARE r_QtyOnHold decimal(18, 8);
    DECLARE r_QtyOnHold_Before decimal(18, 8);
    DECLARE r_WarehouseID varchar(35);
    DECLARE r_TransactionID varchar(30);

    DECLARE r_CurrentTime timestamp;
    DECLARE r_NO_COMMIT varchar(1);
    DECLARE r_ONHoldCount int;
    DECLARE r_OnHoldLocker int;
    DECLARE r_HoldRelease char(2);
    DECLARE r_UDF2 varchar(20);
    DECLARE r_QtyOnHold_Beforefor varchar(100);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPINV_Hold_Update', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code;
    END;

    IF (Out_return_Code = 'NO_COMMIT')
      OR (Out_return_Code = '*_*') THEN
      SET r_NO_COMMIT = 'N';
    ELSE
      SET r_NO_COMMIT = 'Y';
    END IF;
    SET r_CurrentTime = NOW();
    SELECT
      IN_CustomerID,
      IN_SKU,
      IN_LotNUM,
      IN_Location,
      IN_TraceID,
      IN_Language,
      IN_UserID;









    SELECT
      COUNT(*)
    FROM ACT_INVENTORYHOLD
    WHERE organizationId = IN_organizationId
    AND HoldFlag = 'Y'
    AND ((HoldBy = '1'
    AND LotNum = IN_LotNum)
    OR (HoldBy = '2'
    AND LocationID = IN_Location)
    OR (HoldBy = '3'
    AND TraceID = IN_TraceID)
    OR (HoldBy = '5'
    AND LocationID = IN_Location
    AND LotNUM = IN_LotNum
    AND TraceID = IN_TraceID)
    OR (HoldBy = '6'
    AND CustomerID = IN_CustomerID)
    OR (HoldBy = '7'
    AND CustomerID = IN_CustomerID
    AND SKU = IN_SKU))
    AND warehouseid = IN_Warehouse INTO r_ONHoldCount;


    SELECT
      OnHoldLocker,
      QtyOnHold
    FROM INV_LOT_LOC_ID
    WHERE organizationId = IN_organizationId
    AND warehouseid = IN_Warehouse
    AND LotNum = IN_LotNUM
    AND LocationID = IN_Location
    AND TraceID = IN_TraceID INTO r_OnHoldLocker, R_QtyOnHold;

    IF r_OnHoldLocker <> R_ONHoldCount
      OR R_ONHoldCount > 0
      OR R_QtyOnHold > 0 THEN


      SELECT
        QtyOnHold
      FROM INV_LOT_LOC_ID
      WHERE organizationId = IN_organizationId
      AND warehouseid = IN_Warehouse
      AND LotNum = IN_LotNum
      AND Locationid = IN_Location
      AND TraceID = IN_TraceId
      FOR UPDATE;

      UPDATE INV_LOT_LOC_ID
      SET QtyOnHold = CASE WHEN (R_ONHoldCount > 0) THEN Qty ELSE 0 END,
          OnHoldLocker = R_ONHoldCount,
          editWho = IN_UserID,
          editTime = r_CurrentTime
      WHERE organizationId = IN_organizationId
      AND warehouseid = IN_Warehouse
      AND LotNum = IN_LotNum
      AND Locationid = IN_Location
      AND TraceID = IN_TraceId;


      UPDATE INV_LOT
      SET QtyOnHold = (SELECT
          IFNULL(SUM(X.QtyOnHold), 0)
        FROM INV_LOT_LOC_ID X
        WHERE INV_LOT.organizationId = X.organizationId
        AND INV_LOT.warehouseid = X.Warehouseid
        AND INV_LOT.LotNum = X.LotNum)
      WHERE organizationId = IN_organizationId
      AND warehouseid = IN_Warehouse
      AND LotNum = IN_LotNum;

      SELECT
        (CASE WHEN OnHoldLocker = 0 THEN 0 ELSE QtyOnHold END)
      FROM INV_LOT_LOC_ID
      WHERE organizationId = IN_organizationId
      AND warehouseid = IN_Warehouse
      AND LotNum = IN_LotNum
      AND Locationid = IN_Location
      AND TraceID = IN_TraceId INTO r_QtyOnHold;
      IF r_QtyOnHold_Before <> r_QtyOnHold THEN
        SELECT
          WarehouseID
        FROM BAS_LOCATION
        WHERE organizationId = IN_organizationId
        AND warehouseid = IN_Warehouse
        AND LocationID = IN_Location INTO r_WarehouseID;
        SET Out_Return_Code = '*_*';
        CALL SPCOM_GetIDSequence(IN_Warehouse, IN_Language, 'TransactionID', r_TransactionID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          LEAVE endPROC;
        END IF;






        SELECT
          IFNULL(UD0F2, 'N')
        FROM BSM_CODE
        WHERE codeid = 'TRN_TYP'
        AND CODEtype = r_HoldRelease INTO r_UDF2;

        INSERT INTO ACT_TRANSACTION_LOG (organizationId, TransactionID, QC_TaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
        , TransactionType, DocNo, DocLineNo, DocType
        , FMCustomerID, FMSku
        , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
        , ToCustomerID, ToSku
        , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
        , STATUS
        , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
        , ReasonCode, Reason
        , WarehouseID
        , ADDTIME, AddWho, EditTime, EditWho, TransactionTime
        , Edisendflag
        , Operator)
          VALUES (IN_organizationId, r_TransactionID, '*', 0, 'N', '*', '0', 'N', r_HoldRelease, '', 5, '*', IN_CustomerID, IN_SKU, IN_LotNum, IN_Location, IN_TraceID, '*', 'EA', ABS(R_QtyOnHold - R_QtyOnHold_Before), ABS(R_QtyOnHold - R_QtyOnHold_Before), IN_CustomerID, IN_Sku, IN_LotNum, IN_Location, IN_TraceID, '*', 'EA', ABS(R_QtyOnHold - R_QtyOnHold_Before), ABS(R_QtyOnHold - R_QtyOnHold_Before), '99', 0, 0, 0, 0, NULL, NULL, R_WarehouseID, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID, R_CurrentTime, r_UDF2, IN_UserID);
      END IF;
    END IF;
    SET OUT_Return_Code = '*_*';
    CALL SPUDF_PROCESSA(IN_organizationId, IN_Warehouse, 'HOLD_UPDATE_AFTER', r_HoldRelease, 5, r_TransactionID, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `SPINV_Adjustment_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPINV_Adjustment_Process (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_ADJNO varchar(20),
IN IN_ADJLineNo varchar(10),
IN IN_CustomerID varchar(35),
IN IN_SKU varchar(60),
IN IN_LotNUM varchar(20),
IN IN_Location varchar(40),
IN IN_TraceID varchar(40),
IN IN_FMQty_C varchar(20),
IN IN_ToQty varchar(20),
IN IN_ReasonCode varchar(40),
IN IN_Reason varchar(40),
IN IN_AdjustmentTime varchar(20),
IN IN_ToTotalGrossWeight varchar(40),
IN IN_ToTotalNetWeight varchar(40),
IN IN_ToTotalCubic varchar(40),
IN IN_ToTotalPrice varchar(40),
IN IN_Language varchar(10),
IN IN_UserID varchar(40),
INOUT OUT_Return_Code varchar(400))
ENDPROC:
  BEGIN

    DECLARE v_NO_COMMIT varchar(1);
    DECLARE r_TotalPrice decimal(18, 8);
    DECLARE r_TotalCubic decimal(18, 8);
    DECLARE r_TotalGrossWeight decimal(18, 8);
    DECLARE r_TotalNetWeight decimal(18, 8);
    DECLARE r_QtyRPOUT decimal(18, 8);
    DECLARE r_QtyMVOUT decimal(18, 8);
    DECLARE r_QtyMVIN decimal(18, 8);
    DECLARE r_QtyOnHold decimal(18, 8);
    DECLARE r_QtyRPIN decimal(18, 8);
    DECLARE r_QtyPA decimal(18, 8);
    DECLARE r_QtyPK decimal(18, 8);
    DECLARE r_TransactionID varchar(30);
    DECLARE r_CurrentTime date;
    DECLARE r_Qty decimal(18, 8);
    DECLARE r_QtyAllow decimal(18, 8);
    DECLARE r_QtyAllocated decimal(18, 8);
    DECLARE r_AdjustmentTime_C date;
    DECLARE SP_SQL_r varchar(2000);
    DECLARE r_FMINVQty decimal(18, 8);
    DECLARE r_QtyHoldChange decimal(18, 8);
    DECLARE IN_FMQty decimal(18, 8);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_nRow int;
    DECLARE r_para2 varchar(200);
    DECLARE r_para3 varchar(200);
    DECLARE r_Para4 varchar(200);
    DECLARE r_UDF2 varchar(10);
    DECLARE r_CustomerID varchar(35);
    DECLARE r_SKU varchar(60);
    DECLARE r_New_TraceID varchar(200);
    DECLARE r_Return_LotNum varchar(200);
    DECLARE r_Return_Toloc varchar(200);
    DECLARE r_Mix_Flag varchar(1);
    DECLARE r_SKUCount decimal(18, 8);
    DECLARE r_ADJ_HLD_INV varchar(10);
    DECLARE r_PackID varchar(40);
    DECLARE v_error varchar(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPINV_Adjustment_Process', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code;
    END;

    SET autocommit = 0;
    SET v_error = 1;
    IF OUT_return_Code = 'NO_COMMIT'
      OR OUT_return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET R_CurrentTime = NOW();
    SET Out_Return_Code = '000';
    SET r_AdjustmentTime_C := STR_TO_DATE(IN_AdjustmentTime, 'yyyy-mm-dd HH24:mi:ss');
    IF TRIM(IN_SKU) IS NULL THEN
      SET Out_Return_Code := '337';
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;

    SET OUT_Return_Code := '*_*';
    SET R_Para2 := CONCAT(TRIM(IN_ADJNO), '%', IN_ADJLineNo, '%', TRIM(IN_CustomerID)
    , '%', TRIM(IN_SKU), '%', TRIM(IN_LotNum), '%', TRIM(IN_TraceID)
    , '%', TRIM(IN_FMQty_C));
    SET r_Para3 := CONCAT(TRIM(IN_ToQty), '%',
    TRIM(IN_ToTotalGrossWeight), '%',
    TRIM(IN_ToTotalNetWeight), '%',
    TRIM(IN_ToTotalCubic), '%',
    TRIM(IN_ToTotalPrice));
    SET r_Para4 := CONCAT(TRIM(IN_ReasonCode), '%', TRIM(IN_Reason), '%', TRIM(IN_AdjustmentTime));
    CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'ADJ_BEFORE', r_Para2, r_Para3, r_para4, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;

    SET IN_FMQty := IN_FMQty_C;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    IF IN_FMQty = 0 THEN
      SELECT
        Mix_Flag,
        SKUCount INTO r_Mix_Flag, r_SKUCount
      FROM BAS_Location
      WHERE LocationID = IN_Location
      AND organizationId = IN_organizationId
      AND Warehouseid = IN_Warehouse;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code := CONCAT('101', IN_Location);
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF (r_Mix_Flag = 'N'
        OR r_SKUCount > 0) THEN
        SELECT
          COUNT(DISTINCT SKU) INTO r_nRow
        FROM inv_lot_LOC_ID
        WHERE LocationID = IN_Location
        AND organizationId = IN_organizationId
        AND Warehouseid = IN_Warehouse
        AND SKU <> IN_SKU
        AND (Qty > 0
        OR QTYPA > 0
        OR QTYRPIN > 0
        OR QTYMVIN > 0);
        IF r_Mix_Flag = 'N'
          AND r_nRow >= 1 THEN
          SET OUT_Return_Code := CONCAT('205', IN_Location);
          ROLLBACK;
          LEAVE ENDPROC;
        ELSEIF r_Mix_Flag = 'Y'
          AND r_SKUCount > 0
          AND r_nRow >= r_SKUCount THEN
          SET OUT_Return_Code := CONCAT('367', r_SKUCount);
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
      END IF;


      SET OUT_Return_Code := '*_*';
      CALL SPASN_Receiving_Process(IN_organizationId, IN_Warehouse, '2'
      , IN_ADJNO
      , IN_ADJLineNo
      , IN_TraceID
      , IN_TraceID
      , '00'
      , NULL
      , 'OK'
      , NULL
      , '*'
      , IN_CustomerID
      , IN_SKU
      , IN_ToQty
      , 0, 'EA', NULL, IN_LotNUM, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL
      , IN_ToTotalCubic, IN_ToTotalGrossWeight, IN_ToTotalNetWeight, IN_ToTotalPrice, NULL, NULL, NULL, NULL, NULL
      , IN_Location, IN_Location, 'OK', NULL, IN_AdjustmentTime, '*', IN_UserID
      , 'ADJREC', ''
      , IN_Language, IN_UserID, r_New_TraceID, r_Return_LotNum, r_Return_Toloc, OUT_Return_Code);

      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      SET OUT_Return_Code := '000';
      LEAVE ENDPROC;
    END IF;




    SELECT
      IFNULL(a.Price, 0),
      IFNULL(a.Cubic, 0),
      IFNULL(a.GrossWeight, 0),
      IFNULL(a.NetWeight, 0),
      IFNULL(a.QtyAllocated, 0),
      IFNULL(a.QtyRPOUT, 0),
      IFNULL(a.QtyMVOUT, 0),
      IFNULL(a.QtyRPIN, 0),
      IFNULL(a.QtyMVIN, 0),
      IFNULL(QtyOnHold, 0),
      a.Qty,
      a.WarehouseID,
      a.customerid,
      a.sku INTO r_TotalPrice, r_TotalCubic, r_TotalGrossWeight, r_TotalNetWeight
    , r_QtyAllocated, r_QtyRPOUT, r_QtyMVOUT, r_QtyRPIN, r_QtyMVIN, r_QtyOnHold
    , r_FMINVQty
    , r_WarehouseID
    , r_CustomerID, r_SKU
    FROM INV_LOT_LOC_ID a
    WHERE a.LotNum = IN_LotNUM
    AND a.Locationid = IN_Location
    AND a.TraceId = IN_TraceID
    AND a.organizationId = IN_organizationId
    AND a.Warehouseid = IN_Warehouse FOR UPDATE;
    IF FOUND_ROWS() = 0 THEN
      SET OUT_Return_Code := '353';
      LEAVE ENDPROC;
    END IF;

    IF r_Customerid <> IN_CustomerID
      OR r_SKU <> IN_SKU THEN
      ROLLBACK;
      SET OUT_Return_Code := '111';
      LEAVE ENDPROC;
    END IF;

    SELECT
      COUNT(*) INTO r_nRow
    FROM TSK_TaskLists A
    WHERE a.FMLotNum = IN_LotNum
    AND a.FMLocation = IN_Location
    AND a.FMId = IN_TraceID
    AND a.organizationId = IN_organizationId
    AND a.Warehouseid = IN_Warehouse
    AND TaskType = 'PA'
    AND TaskProcess = '00';
    IF r_nRow > 0 THEN
      SET out_Return_Code := '326';
      LEAVE ENDPROC;
    END IF;




    IF r_QtyOnHold > 0 THEN
      SET r_ADJ_HLD_INV := getsys_configuration(IN_organizationId, IN_Warehouse, r_CustomerID, '*', 'ADJ_HLD_INV');
    END IF;

    IF r_QtyOnHold = r_FMINVQty
      AND r_ADJ_HLD_INV = 'Y' THEN
      SET r_QtyAllow := r_FMINVQty;
      SET r_QtyHoldChange := IN_FMQty - IN_TOQty;
    ELSE
      SET r_QtyAllow := r_FMINVQty - r_QtyAllocated - r_QtyRPOUT - r_QtyMVOut - r_QtyOnHold;
      SET r_QtyHoldChange := 0;
    END IF;


    SELECT
      r_QtyAllow - IFNULL(SUM(B.ToQty), 0) INTO r_QtyAllow
    FROM DOC_TRANSFER_DETAILS B
    WHERE B.Fmlocation = IN_Location
    AND B.fmLotnum = IN_LotNUM
    AND B.FMID = IN_TraceID
    AND B.organizationId = IN_organizationId
    AND B.Warehouseid = IN_Warehouse
    AND B.TDOCLINESTATUS < '10';


    SELECT
      r_QtyAllow - IFNULL(SUM(B.Qty - B.ToQty), 0) INTO r_QtyAllow
    FROM DOC_ADJ_Details B
    WHERE B.LocationID = IN_Location
    AND B.Lotnum = IN_LotNUM
    AND B.TraceID = IN_TraceID
    AND B.organizationId = IN_organizationId
    AND B.Warehouseid = IN_Warehouse
    AND B.adjLineStatus < '10'
    AND B.Qty > B.ToQty
    AND B.ADJNO <> IN_ADJNO
    AND B.ADJLineNo <> IN_ADJLineNo;




    IF r_QtyAllow < IN_FMqty - IN_ToQTY THEN
      SET OUT_Return_Code := '312';
      LEAVE ENDPROC;
    END IF;



    SET OUT_Return_Code := '*_*';
    CALL SPCOM_GetIDSequence(IN_organizationId, IN_Warehouse, IN_Language, 'TransactionID', r_TransactionID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;



    SELECT
      QTy INTO r_Qty
    FROM INV_LOT
    WHERE LotNUM = IN_LotNUM
    AND organizationId = IN_organizationId
    AND Warehouseid = IN_Warehouse FOR UPDATE;
    IF r_Qty = IN_FMQty - IN_ToQty THEN
      DELETE
        FROM INV_LOT
      WHERE LotNUM = IN_LotNUM
        AND organizationId = IN_organizationId
        AND Warehouseid = IN_Warehouse;
    ELSE
      UPDATE INV_LOT
      SET Qty = QTy - (IN_FMQty - IN_ToQty),
          QtyOnHold = QtyOnHold - r_QtyHoldChange,
          Cubic = Cubic + IN_ToTotalCubic - r_TotalCubic,
          GrossWeight = GrossWeight + IN_ToTotalGrossWeight - r_TotalGrossWeight,
          NetWeight = NetWeight + IN_ToTotalNetWeight - r_TotalNetWeight,
          Price = Price + IN_ToTotalPrice - r_TotalPrice,
          editWho = IN_UserID,
          editTime = r_CurrentTime
      WHERE LotNUM = IN_LotNUM
      AND organizationId = IN_organizationId
      AND Warehouseid = IN_Warehouse;
    END IF;



    SELECT
      QTY,
      QtyRPIN,
      QtyMVIN INTO r_Qty, r_QtyRPIN, r_QtyMVIN
    FROM INV_LOT_LOC_ID
    WHERE TraceID = IN_TraceID
    AND LotNUM = IN_LotNUM
    AND LocationID = IN_Location
    AND organizationId = IN_organizationId
    AND Warehouseid = IN_Warehouse FOR UPDATE;
    IF FOUND_ROWS() = 0 THEN
      SET OUT_Return_Code := CONCAT('104', IN_Location);
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;
    IF r_Qty = IN_FMqty - IN_ToQTY
      AND r_QtyRPIN = 0
      AND r_QtyMVIN = 0 THEN
      DELETE
        FROM INV_LOT_LOC_ID
      WHERE TraceID = IN_TraceID
        AND LotNUM = IN_LotNUM
        AND LocationID = IN_Location
        AND organizationId = IN_organizationId
        AND Warehouseid = IN_Warehouse;
    ELSEIF r_Qty >= IN_FMqty - IN_ToQTY THEN
      UPDATE INV_LOT_LOC_ID
      SET Qty = qty - (IN_FMqty - IN_ToQty),
          QtyOnHold = QtyOnHold - r_QtyHoldChange,
          Cubic = IN_ToTotalCubic,
          GrossWeight = IN_ToTotalGrossWeight,
          NetWeight = IN_ToTotalNetWeight,
          Price = IN_ToTotalPrice,
          editWho = IN_UserID,
          editTime = r_CurrentTime
      WHERE TraceID = IN_TraceID
      AND LotNUM = IN_LotNUM
      AND LocationID = IN_Location
      AND organizationId = IN_organizationId
      AND Warehouseid = IN_Warehouse;
    ELSE
      SET OUT_Return_Code := '334';
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;





    SET r_UDF2 = 'N';

    SET r_PackID := '*';
    SELECT
      a.packid INTO r_PackID
    FROM bas_sku a
    WHERE a.customerid = In_CustomerID
    AND a.sku = In_SKU
    AND a.organizationId = IN_organizationId;


    INSERT INTO ACT_Transaction_Log (organizationId, TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
    , TransactionType, DocNo, DocLineNo, DocType
    , FMCustomerID, FMSku
    , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
    , ToCustomerID, ToSku
    , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
    , Status
    , WarehouseID
    , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
    , ReasonCode, Reason
    , AddTime, AddWho, EditTime, EditWho, TransactionTime, Operator
    , Edisendflag)
      VALUES (IN_organizationId, r_TransactionID, '*', 0, 'N', '*', '0', 'N', 'AD', IN_ADJNO, IN_ADJLineNo, 'AJ', IN_CustomerID, IN_SKU, IN_LotNUM, IN_Location, IN_TraceID, r_PackID, 'EA', IN_FMQty, IN_FMQty, IN_CustomerID, IN_SKU, IN_LotNUM, IN_Location, IN_TraceID, r_PackID, 'EA', IN_ToQty, IN_ToQty, '99', r_WarehouseID, r_TotalCubic - IN_ToTotalCubic, r_TotalGrossWeight - IN_ToTotalGrossWeight, r_TotalNetWeight - IN_ToTotalNetWeight, r_TotalPrice - IN_ToTotalPrice, IN_ReasonCode, IN_Reason, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_AdjustmentTime_C, IN_UserID, r_UDF2);

    IF IFNULL(IN_ADJNO, '*') <> '*' THEN
      UPDATE doc_adj_header
      SET ADJTime = r_CurrentTime,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE ADJNO = IN_ADJNO
      AND organizationId = IN_organizationId
      AND Warehouseid = IN_Warehouse;
    END IF;


    CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'ADJ_AFTER', r_Para2, r_Para3, r_para4, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code := CONCAT('000', r_TransactionID);
  END
  $$

--
-- Create procedure `SPINV_Transfer_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPINV_Transfer_Process (IN In_organizationId varchar(20),
IN In_Warehouse varchar(20),
IN In_TransferDocNo varchar(20),
IN In_TransferDocLineNo varchar(20),
IN In_FMCustomerID varchar(20),
IN In_FMSKU varchar(20),
IN In_FMLotNUM varchar(20),
IN In_FMLocation varchar(20),
IN In_FMTraceID varchar(20),
IN In_FMQty_C varchar(20),
IN In_ToCustomerID varchar(20),
IN In_ToSKU varchar(20),
IN In_ToLotNUM_C varchar(20),
IN In_ToLocation_C varchar(20),
IN In_ToTraceID_C varchar(20),
IN In_ToQty varchar(20),
IN In_GainLoss decimal(18, 8),
IN In_ToLotAtt01_C varchar(20),
IN In_ToLotAtt02_C varchar(20),
IN In_ToLotAtt03_C varchar(20),
IN In_ToLotAtt04 varchar(20),
IN In_ToLotAtt05 varchar(20),
IN In_ToLotAtt06 varchar(20),
IN In_ToLotAtt07 varchar(20),
IN In_ToLotAtt08 varchar(20),
IN In_ToLotAtt09 varchar(20),
IN In_ToLotAtt10 varchar(20),
IN In_ToLotAtt11 varchar(20),
IN In_ToLotAtt12 varchar(20),
IN In_ReasonCode varchar(20),
IN In_Reason varchar(20),
IN In_TransferTime varchar(20),
IN In_TotalGrossWeight varchar(20),
IN In_ToTotalNetWeight varchar(20),
IN In_TotalCubic varchar(20),
IN In_ToTotalPrice varchar(20),
IN In_Language varchar(20),
IN In_UserID varchar(20),
INOUT OUT_Return_Code varchar(1000))
ENDPROC:
  BEGIN

    DECLARE r_QtyAllocated decimal(18, 8);
    DECLARE r_QtyRPOUT decimal(18, 8);
    DECLARE r_QtyMVOUT decimal(18, 8);
    DECLARE r_QtyMVIN decimal(18, 8);
    DECLARE r_QtyOnHold decimal(18, 8);
    DECLARE r_QtyRPIN decimal(18, 8);
    DECLARE r_QtyADJ decimal(18, 8);
    DECLARE r_TotalPrice decimal(18, 8);
    DECLARE r_TotalCubic decimal(18, 8);
    DECLARE r_TotalGrossWeight decimal(18, 8);
    DECLARE r_TotalNetWeight decimal(18, 8);
    DECLARE r_Return_VarC varchar(100);
    DECLARE r_TransactionID varchar(30);
    DECLARE r_CurrentTime timestamp;
    DECLARE r_AllowQty decimal(18, 8);
    DECLARE r_TransferTime_C timestamp;
    DECLARE r_LotAtt01_Flag varchar(1);
    DECLARE r_LotAtt02_Flag varchar(1);
    DECLARE r_LotAtt03_Flag varchar(1);
    DECLARE r_LotAtt04_Flag varchar(1);
    DECLARE r_LotAtt05_Flag varchar(1);
    DECLARE r_LotAtt06_Flag varchar(1);
    DECLARE r_LotAtt07_Flag varchar(1);
    DECLARE r_LotAtt08_Flag varchar(1);
    DECLARE r_LotAtt09_Flag varchar(1);
    DECLARE r_LotAtt10_Flag varchar(1);
    DECLARE r_LotAtt11_Flag varchar(1);
    DECLARE r_LotAtt12_Flag varchar(1);
    DECLARE IN_ToLotAtt01 varchar(100);
    DECLARE IN_ToLotAtt02 varchar(100);
    DECLARE IN_ToLotAtt03 varchar(100);
    DECLARE IN_ToLotNUM varchar(10);
    DECLARE IN_ToTraceID varchar(20);
    DECLARE IN_ToLocation varchar(60);
    DECLARE sp_SQL_r varchar(1000);
    DECLARE r_TOLPN varchar(30);
    DECLARE r_FMINVQty decimal(18, 8);
    DECLARE IN_FMQty decimal(18, 8);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_para2 varchar(500);
    DECLARE r_para3 varchar(500);
    DECLARE r_Para4 varchar(500);
    DECLARE r_LoseID_Flag char(1);
    DECLARE r_LOTKEY01 char(1);
    DECLARE r_LOTKEY02 char(1);
    DECLARE r_LOTKEY03 char(1);
    DECLARE r_LOTKEY04 char(1);
    DECLARE r_LOTKEY05 char(1);
    DECLARE r_LOTKEY06 char(1);
    DECLARE r_LOTKEY07 char(1);
    DECLARE r_LOTKEY08 char(1);
    DECLARE r_LOTKEY09 char(1);
    DECLARE r_LOTKEY10 char(1);
    DECLARE r_LOTKEY11 char(1);
    DECLARE r_LOTKEY12 char(1);
    DECLARE r_Mix_Flag char(1);
    DECLARE r_Mix_LotFlag char(1);
    DECLARE r_SKUCount int;
    DECLARE r_AdjustmentToQty decimal(18, 8);
    DECLARE r_SN_CTL varchar(10);
    DECLARE r_UDF2 varchar(100);
    DECLARE r_QTYAVAILED decimal(18, 8);
    DECLARE r_FMINVCustomerID varchar(35);
    DECLARE r_FMINVSKU varchar(50);
    DECLARE r_qty decimal(18, 8);
    DECLARE r_lpn varchar(30);
    DECLARE r_FMInLocTime timestamp;
    DECLARE r_serialnocatch varchar(1);
    DECLARE r_TOPackID varchar(40);
    DECLARE r_FMPackID varchar(40);
    DECLARE R_SKU_LOTID varchar(10);
    DECLARE v_lotAttId varchar(20);
    DECLARE V_lotAttFlag char(1);
    DECLARE V_lotKey char(1);
    DECLARE V_lotAttValue varchar(100);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE C_LOTID CURSOR FOR
    SELECT
      `lotAttId`,
      `lotAttFlag`,
      `lotKey`
    FROM `BAS_LOTID_DETAILS` p
    WHERE p.`organizationId` = In_organizationId
    AND p.`lotId` = r_SKU_LOTID;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SET OUT_Return_Code = CONCAT('999#SPINV_Transfer_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;
    SET v_error = 1;
    IF Out_return_Code = 'NO_COMMIT'
      OR Out_return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET R_CurrentTime = NOW();
    SET Out_Return_Code = '000';
    SET r_TransferTime_C = DATE_FORMAT(IN_TransferTime, '%Y/%m/%d %H:%i:%s');
    SET IN_FMQty = IN_FMQty_C;
    SET IN_ToLotNUM = IN_ToLotNUM_C;
    SET IN_ToLotAtt01 = IN_ToLotAtt01_C;
    SET IN_ToLotAtt02 = IN_ToLotAtt02_C;
    SET IN_ToLotAtt03 = IN_ToLotAtt03_C;
    SET IN_ToLocation = IN_ToLocation_C;
    SET IN_ToTraceID = IN_ToTraceID_C;

    CALL SPCOM_CheckTraceID(In_organizationId, IN_Warehouse
    , IN_FMLotNum, IN_FMTraceID, IN_FMLocation
    , IN_ToTraceID, IN_ToLocation, IN_ToQty
    , IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(out_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;

    SET OUT_Return_Code = '*_*';
    SET r_Para2 = CONCAT(TRIM(IN_TransferDocNo), '%', TRIM(IN_TransferDocLineNo), '%', TRIM(IN_FMCustomerID)
    , '%', TRIM(IN_FMSKU), '%', TRIM(IN_FMLotNUM), '%', TRIM(IN_FMLocation), '%', TRIM(IN_FMTraceID), '%', TRIM(IN_FMQty));
    SET r_Para3 = CONCAT(TRIM(IN_ToCustomerID)
    , '%', TRIM(IN_ToSKU), '%', TRIM(IN_ToLotNUM), '%', TRIM(IN_ToLocation), '%', TRIM(IN_ToTraceID), '%', TRIM(IN_ToQty)
    , '%', TRIM(IN_ToLotAtt01), '%', TRIM(IN_ToLotAtt02), '%', TRIM(IN_ToLotAtt03), '%', TRIM(IN_ToLotAtt04), '%', TRIM(IN_ToLotAtt05), '%', TRIM(IN_ToLotAtt06)
    , '%', TRIM(IN_ToLotAtt07), '%', TRIM(IN_ToLotAtt08), '%', TRIM(IN_TOLotAtt09), '%', TRIM(IN_TOLotAtt10), '%', TRIM(IN_TOLotAtt11), '%', TRIM(IN_TOLotAtt12)
    , '%', IN_GainLoss);
    SET r_Para4 = CONCAT(TRIM(IN_ReasonCode), '%', TRIM(IN_Reason), '%', TRIM(IN_TransferTime));
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'TR_BEFORE', r_Para2, r_Para3, r_para4, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;

    SELECT
      COUNT(1)
    FROM BAS_LOCATION
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND locationId = IN_ToLocation INTO v_nRow;
    IF v_nRow = 0 THEN
      SET OUT_Return_Code = CONCAT('101', IN_ToLocation);
      LEAVE ENDPROC;
    END IF;

    SET v_error = 1;
    SELECT
      a.qty,
      a.lpn,
      a.InLocTime
    FROM INV_LOT_LOC_ID a
    WHERE a.organizationId = In_organizationId
    AND a.warehouseId = In_warehouse
    AND a.lotnum = IN_FMLotNUM
    AND a.locationid = IN_FMLocation
    AND a.traceid = IN_FMTraceID INTO r_qty, r_lpn, r_FMInLocTime;
    SET r_TOLPN = r_lpn;
    IF r_qty <> IN_ToQty
      AND IFNULL(r_lpn, '*') <> '*'
      AND IN_FMLocation <> IN_ToLocation_C THEN
      SET OUT_Return_Code = '316';
      LEAVE ENDPROC;
    END IF;




    SET r_LOTKEY01 = 'N';
    SET r_LOTKEY02 = 'N';
    SET r_LOTKEY03 = 'N';
    SET r_LOTKEY04 = 'N';
    SET r_LOTKEY05 = 'N';
    SET r_LOTKEY06 = 'N';
    SET r_LOTKEY07 = 'N';
    SET r_LOTKEY08 = 'N';
    SET r_LOTKEY09 = 'N';
    SET r_LOTKEY10 = 'N';
    SET r_LOTKEY11 = 'N';
    SET r_LOTKEY12 = 'N';

    SELECT
      b.LotID,
      IFNULL(b.serialnocatch, 'N')
    FROM BAS_SKU b
    WHERE b.organizationId = In_organizationId
    AND b.CustomerID = IN_ToCustomerID
    AND b.SKU = IN_ToSKU INTO r_SKU_LOTID, r_serialnocatch;

    OPEN C_LOTID;
  EndLotID:
    LOOP
      FETCH C_LOTID INTO v_lotAttId, v_lotAttFlag, v_lotKey;
      IF v_error = 0 THEN
        LEAVE EndLotID;
      END IF;
      IF v_lotAttId = 'lotAtt01' THEN
        SET r_LotAtt01_Flag = v_lotAttFlag;
        SET r_LOTKEY01 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt02' THEN
        SET r_LotAtt02_Flag = v_lotAttFlag;
        SET r_LOTKEY02 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt03' THEN
        SET r_LotAtt03_Flag = v_lotAttFlag;
        SET r_LOTKEY03 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt04' THEN
        SET r_LotAtt04_Flag = v_lotAttFlag;
        SET r_LOTKEY04 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt05' THEN
        SET r_LotAtt05_Flag = v_lotAttFlag;
        SET r_LOTKEY05 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt06' THEN
        SET r_LotAtt06_Flag = v_lotAttFlag;
        SET r_LOTKEY06 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt07' THEN
        SET r_LotAtt07_Flag = v_lotAttFlag;
        SET r_LOTKEY07 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt08' THEN
        SET r_LotAtt08_Flag = v_lotAttFlag;
        SET r_LOTKEY08 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt09' THEN
        SET r_LotAtt09_Flag = v_lotAttFlag;
        SET r_LOTKEY09 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt10' THEN
        SET r_LotAtt10_Flag = v_lotAttFlag;
        SET r_LOTKEY10 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt11' THEN
        SET r_LotAtt11_Flag = v_lotAttFlag;
        SET r_LOTKEY11 = v_lotKey;

      ELSEIF v_lotAttId = 'lotAtt12' THEN
        SET r_LotAtt12_Flag = v_lotAttFlag;
        SET r_LOTKEY12 = v_lotKey;

      END IF;
    END LOOP;
    CLOSE C_Lotid;

    SET IN_Tolocation = UPPER(IN_ToLocation);

    SET v_error = 1;
    SELECT
      IFNULL(LoseID_Flag, 'N'),
      IFNULL(Mix_Flag, 'Y'),
      IFNULL(Mix_LotFlag, 'Y'),
      SKUCount
    FROM BAS_LOCATION
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND LocationID = IN_TOLocation INTO r_LoseID_Flag, r_Mix_Flag, r_Mix_LotFlag, r_SKUCount;
    IF v_error = 0 THEN
      SET OUT_Return_Code = CONCAT('101', IN_TOLocation);
      LEAVE ENDPROC;
    END IF;

    SELECT
      COUNT(1) INTO v_nRow
    FROM INV_LOT_LOC_ID
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND LocationID = IN_ToLocation
    AND SKU IN (SELECT
        ConflictSKU
      FROM BAS_SKU_CONFLICT
      WHERE organizationId = In_organizationId
      AND CustomerID = IN_TOCustomerID
      AND SKU = IN_TOSKU);
    IF v_nRow <> 0 THEN
      SET OUT_Return_Code = '235';
      LEAVE ENDPROC;
    END IF;

    IF r_LoseID_Flag = 'Y'
      AND IN_ToTraceID <> '*' THEN
      SET IN_ToTraceID = '*';
    END IF;
    IF r_Mix_Flag = 'N'
      OR r_SKUCount > 0 THEN
      IF IN_ToLocation <> IN_FMLocation THEN
        SELECT
          COUNT(DISTINCT SKU)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND LocationID = IN_ToLocation
        AND SKU <> IN_ToSKU
        AND (Qty > 0
        OR QTYPA > 0
        OR QTYRPIN > 0
        OR QTYMVIN > 0) INTO v_nRow;

      ELSE
        SELECT
          COUNT(DISTINCT SKU)
        FROM INV_LOT_LOC_ID a
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND LocationID = IN_ToLocation
        AND SKU <> IN_ToSKU
        AND (Qty > 0
        OR QTYPA > 0
        OR QTYRPIN > 0
        OR QTYMVIN > 0)
        AND NOT (a.lotnum = IN_FMLotNUM
        AND a.locationid = IN_FMLocation
        AND a.traceid = IN_FMTraceID
        AND a.qty = IN_ToQty) INTO v_nRow;
      END IF;

      IF r_Mix_Flag = 'N'
        AND v_nRow >= 1 THEN
        SET OUT_Return_Code = CONCAT('205', IN_TOLocation);
        LEAVE ENDPROC;
      ELSEIF r_Mix_Flag = 'Y'
        AND r_SKUCount > 0
        AND v_nRow >= r_SKUCount THEN
        SET OUT_Return_Code = CONCAT('367', r_SKUCount);
        LEAVE ENDPROC;
      END IF;
    END IF;
    IF R_Mix_LotFlag = 'N' THEN
      IF IN_ToLocation <> IN_FMLocation THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.warehouseId = In_warehouse
        AND a.LocationID = IN_ToLocation
        AND (a.Qty > 0
        OR a.QTYPA > 0
        OR a.QTYRPIN > 0
        OR a.QTYMVIN > 0)
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '*') <> IFNULL(IN_ToLotatt01, '*') AND
            r_LOTKEY01 = 'Y') OR
            (IFNULL(c.lotatt02, '*') <> IFNULL(IN_ToLotatt02, '*') AND
            r_LOTKEY02 = 'Y') OR
            (IFNULL(c.lotatt03, '*') <> IFNULL(IN_ToLotatt03, '*') AND
            r_LOTKEY03 = 'Y') OR
            (IFNULL(c.lotatt04, '*') <> IFNULL(IN_ToLotatt04, '*') AND
            r_LOTKEY04 = 'Y') OR
            (IFNULL(c.lotatt05, '*') <> IFNULL(IN_ToLotatt05, '*') AND
            r_LOTKEY05 = 'Y') OR
            (IFNULL(c.lotatt06, '*') <> IFNULL(IN_ToLotatt06, '*') AND
            r_LOTKEY06 = 'Y') OR
            (IFNULL(c.lotatt07, '*') <> IFNULL(IN_ToLotatt07, '*') AND
            r_LOTKEY07 = 'Y') OR
            (IFNULL(c.lotatt08, '*') <> IFNULL(IN_ToLotatt08, '*') AND
            r_LOTKEY08 = 'Y') OR
            (IFNULL(c.lotatt09, '*') <> IFNULL(IN_ToLotatt09, '*') AND
            r_LOTKEY09 = 'Y') OR
            (IFNULL(c.lotatt10, '*') <> IFNULL(IN_ToLotatt10, '*') AND
            r_LOTKEY10 = 'Y') OR
            (IFNULL(c.lotatt11, '*') <> IFNULL(IN_ToLotatt11, '*') AND
            r_LOTKEY11 = 'Y') OR
            (IFNULL(c.lotatt12, '*') <> IFNULL(IN_ToLotatt12, '*') AND
            r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;

      ELSE
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.warehouseId = In_warehouse
        AND a.LocationID = IN_ToLocation
        AND (a.Qty > 0
        OR a.QTYPA > 0
        OR a.QTYRPIN > 0
        OR a.QTYMVIN > 0)
        AND NOT (a.lotnum = IN_FMLotNUM
        AND a.locationid = IN_FMLocation
        AND a.traceid = IN_FMTraceID
        AND a.qty = IN_ToQty)
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '*') <> IFNULL(IN_ToLotatt01, '*') AND
            r_LOTKEY01 = 'Y') OR
            (IFNULL(c.lotatt02, '*') <> IFNULL(IN_ToLotatt02, '*') AND
            r_LOTKEY02 = 'Y') OR
            (IFNULL(c.lotatt03, '*') <> IFNULL(IN_ToLotatt03, '*') AND
            r_LOTKEY03 = 'Y') OR
            (IFNULL(c.lotatt04, '*') <> IFNULL(IN_ToLotatt04, '*') AND
            r_LOTKEY04 = 'Y') OR
            (IFNULL(c.lotatt05, '*') <> IFNULL(IN_ToLotatt05, '*') AND
            r_LOTKEY05 = 'Y') OR
            (IFNULL(c.lotatt06, '*') <> IFNULL(IN_ToLotatt06, '*') AND
            r_LOTKEY06 = 'Y') OR
            (IFNULL(c.lotatt07, '*') <> IFNULL(IN_ToLotatt07, '*') AND
            r_LOTKEY07 = 'Y') OR
            (IFNULL(c.lotatt08, '*') <> IFNULL(IN_ToLotatt08, '*') AND
            r_LOTKEY08 = 'Y') OR
            (IFNULL(c.lotatt09, '*') <> IFNULL(IN_ToLotatt09, '*') AND
            r_LOTKEY09 = 'Y') OR
            (IFNULL(c.lotatt10, '*') <> IFNULL(IN_ToLotatt10, '*') AND
            r_LOTKEY10 = 'Y') OR
            (IFNULL(c.lotatt11, '*') <> IFNULL(IN_ToLotatt11, '*') AND
            r_LOTKEY11 = 'Y') OR
            (IFNULL(c.lotatt12, '*') <> IFNULL(IN_ToLotatt12, '*') AND
            r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;

      END IF;

      IF v_nRow >= 1 THEN
        SET OUT_Return_Code = CONCAT('206', IN_TOLocation);
        LEAVE ENDPROC;
      END IF;
    END IF;




    IF IN_ToLotAtt01 = 'YYYY-MM-DD' THEN
      SET IN_ToLotAtt01 = NULL;
    END IF;
    IF IN_ToLotAtt02 = 'YYYY-MM-DD' THEN
      SET IN_ToLotAtt02 = NULL;
    END IF;
    IF IN_ToLotAtt03 = 'YYYY-MM-DD' THEN
      SET IN_ToLotAtt03 = NULL;
    END IF;

    IF (R_LotAtt01_Flag = '3'
      AND IN_ToLotAtt01 IS NULL)
      OR (R_LotAtt02_Flag = '3'
      AND IN_ToLotAtt02 IS NULL)
      OR (R_LotAtt03_Flag = '3'
      AND IN_ToLotAtt03 IS NULL)
      OR (R_LotAtt04_Flag = '3'
      AND IN_ToLotAtt04 IS NULL)
      OR (R_LotAtt05_Flag = '3'
      AND IN_ToLotAtt05 IS NULL)
      OR (R_LotAtt06_Flag = '3'
      AND IN_ToLotAtt06 IS NULL)
      OR (R_LotAtt07_Flag = '3'
      AND IN_ToLotAtt07 IS NULL)
      OR (R_LotAtt08_Flag = '3'
      AND IN_ToLotAtt08 IS NULL)
      OR (R_LotAtt09_Flag = '3'
      AND IN_ToLotAtt09 IS NULL)
      OR (R_LotAtt10_Flag = '3'
      AND IN_ToLotAtt10 IS NULL)
      OR (R_LotAtt11_Flag = '3'
      AND IN_ToLotAtt11 IS NULL)
      OR (R_LotAtt12_Flag = '3'
      AND IN_ToLotAtt12 IS NULL) THEN
      SET OUT_Return_Code = '219????????';
      LEAVE ENDPROC;
    END IF;



    SET v_error = 1;
    SELECT
      IFNULL(a.Price, 0),
      IFNULL(a.Cubic, 0),
      IFNULL(a.GrossWeight, 0),
      IFNULL(a.NetWeight, 0),
      a.Qty,
      a.WarehouseID,
      a.Customerid,
      a.Sku,
      QtyAllocated,
      QtyRPOUT,
      QtyMVOUT,
      QtyRPIN,
      QtyMVIN,
      QtyOnHold,
      Qty - QtyAllocated - QtyOnHold - QTYRPOUT - QtyMVOut AS QTYAVAILED
    FROM INV_LOT_LOC_ID a
    WHERE a.organizationId = In_organizationId
    AND a.warehouseId = In_warehouse
    AND a.LotNum = IN_FMLotNUM
    AND a.Locationid = IN_FMLocation
    AND a.TraceId = IN_FMTraceID INTO r_TotalPrice, r_TotalCubic, r_TotalGrossWeight, r_TotalNetWeight, r_FMINVQTY
    , r_WarehouseID, r_FMINVCustomerid, r_FMINVSku
    , r_QtyAllocated, r_QtyRPOUT, r_QtyMVOUT, r_QtyRPIN, r_QtyMVIN, r_QtyOnHold
    , r_QTYAVAILED
    FOR UPDATE;
    IF v_error = 0 THEN
      SET OUT_Return_Code = '210';
      SET r_Return_VarC = CONCAT('Lotnum = ', IN_FMLotNUM, 'Locationid = ', IN_FMLocation, 'TraceId = ', IN_FMTraceID);
      SET OUT_Return_Code = CONCAT(OUT_Return_Code, r_Return_VarC);
      LEAVE ENDPROC;
    END IF;

    SELECT
      b.tocubic,
      b.togrossweight
    FROM DOC_TRANSFER_DETAILS b
    WHERE b.organizationId = In_organizationId
    AND b.warehouseId = In_warehouse
    AND b.tdocno = IN_TransferDocNo
    AND b.tdoclineno = IN_TransferDocLineNo INTO r_TotalCubic, r_TotalGrossWeight;

    IF r_FMINVCustomerid <> IN_FMCustomerID
      OR r_FMINVSKU <> IN_FMSKU THEN
      ROLLBACK;
      SET OUT_Return_Code = '111';
      LEAVE ENDPROC;
    END IF;
    SET IN_FMQty = r_FMINVQty;




    IF r_QTYAVAILED < IN_ToQty THEN
      SET OUT_Return_Code = CONCAT('368', r_QTYAVAILED, ',', IN_ToQty);
      LEAVE ENDPROC;
    END IF;


    SELECT
      IFNULL(SUM(QTY - TOQty), 0)
    FROM DOC_ADJ_DETAILS
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND adjLineStatus < '10'
    AND QTY > TOQTY
    AND TraceID = IN_FMTraceID
    AND LocationID = IN_FMLocation
    AND LotNUM = IN_FMLOTNUM INTO r_QtyADJ;

    SET R_AllowQty = IN_FMQty - R_QtyAllocated - R_QtyRPOUT - R_QtyMVOut - R_QtyOnHold - r_QtyADJ;


    SELECT
      R_AllowQty - IFNULL(SUM(B.ToQty), 0)
    FROM DOC_TRANSFER_DETAILS B
    WHERE B.organizationId = In_organizationId
    AND B.warehouseId = In_warehouse
    AND B.Fmlocation = IN_FMLocation
    AND B.fmLotnum = IN_FMLOTNUM
    AND B.FMID = IN_FMTraceID
    AND B.TDOCLINESTATUS < '10'
    AND b.tdocno <> IN_TransferDocNo
    AND b.tdoclineno <> IN_TransferDocLineNo INTO R_AllowQty;

    IF r_AllowQty < IN_ToQty THEN
      SET OUT_Return_Code = '312';
      LEAVE ENDPROC;
    END IF;
    SET v_error = 1;
    SELECT
      LotNum
    FROM INV_LOT_ATT
    WHERE organizationId = In_organizationId
    AND customerId = IN_toCustomerId
    AND SKU = IN_ToSKU
    AND IFNULL(LotAtt01, '*') = IFNULL(RTRIM(IN_ToLotAtt01), '*')
    AND IFNULL(LotAtt02, '*') = IFNULL(RTRIM(IN_ToLotAtt02), '*')
    AND IFNULL(LotAtt03, '*') = IFNULL(RTRIM(IN_ToLotAtt03), '*')
    AND IFNULL(LotAtt04, '*') = IFNULL(RTRIM(IN_ToLotAtt04), '*')
    AND IFNULL(LotAtt05, '*') = IFNULL(RTRIM(IN_ToLotAtt05), '*')
    AND IFNULL(LotAtt06, '*') = IFNULL(RTRIM(IN_ToLotAtt06), '*')
    AND IFNULL(LotAtt07, '*') = IFNULL(RTRIM(IN_ToLotAtt07), '*')
    AND IFNULL(LotAtt08, '*') = IFNULL(RTRIM(IN_ToLotAtt08), '*')
    AND IFNULL(LotAtt09, '*') = IFNULL(RTRIM(IN_TOLotAtt09), '*')
    AND IFNULL(LotAtt10, '*') = IFNULL(RTRIM(IN_TOLotAtt10), '*')
    AND IFNULL(LotAtt11, '*') = IFNULL(RTRIM(IN_TOLotAtt11), '*')
    AND IFNULL(LotAtt12, '*') = IFNULL(RTRIM(IN_TOLotAtt12), '*') LIMIT 1 INTO IN_ToLotNUM;
    IF v_error = 0 THEN
      SET IN_ToLotNUM = '***';
    END IF;
    IF IN_ToLotNUM = '***' THEN
      SET OUT_Return_Code = 'NO_COMMIT';
      CALL SPCOM_GetIDSequence(In_organizationId, IN_Warehouse, IN_Language, 'LOTNumber', IN_ToLotNUM, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      INSERT INTO INV_LOT_ATT (organizationId, CustomerID, SKU, LotNum
      , LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05, LotAtt06
      , LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12
      , ADDTIME, AddWho, EditTime, EditWho)
        VALUES (In_organizationId, IN_ToCustomerID, IN_ToSKU, IN_ToLotNUM, RTRIM(IN_ToLotAtt01), RTRIM(IN_ToLotAtt02), RTRIM(IN_ToLotAtt03), RTRIM(IN_ToLotAtt04), RTRIM(IN_ToLotAtt05), RTRIM(IN_ToLotAtt06), RTRIM(IN_ToLotAtt07), RTRIM(IN_ToLotAtt08), RTRIM(IN_ToLotAtt09), RTRIM(IN_ToLotAtt10), RTRIM(IN_ToLotAtt11), RTRIM(IN_ToLotAtt12), R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID);
    END IF;







    IF IN_FMLotNUM <> IN_ToLotNUM THEN
      UPDATE INV_LOT
      SET Qty = QTy - IN_ToQty,
          Cubic = CASE WHEN (Cubic - r_TotalCubic) > 0 THEN (Cubic - r_TotalCubic) ELSE 0 END,
          GrossWeight = CASE WHEN (GrossWeight - r_TotalGrossWeight) > 0 THEN (GrossWeight - r_TotalGrossWeight) ELSE 0 END,
          NetWeight = NetWeight - IN_ToTotalNetWeight,
          Price = Price - IN_ToTotalPrice,
          EditTime = R_CurrentTime,
          EditWho = IN_UserID
      WHERE organizationId = In_organizationId
      AND LotNUM = IN_FMLotNUM;
      IF ROW_COUNT() = 0 THEN
        ROLLBACK;
        SET OUT_Return_Code = '353';
        LEAVE ENDPROC;
      END IF;
      SET v_nRow = 0;
      SELECT
        1
      FROM INV_LOT
      WHERE organizationId = In_organizationId
      AND LotNUM = IN_ToLotNUM INTO v_nRow
      FOR UPDATE;
      IF FOUND_ROWS() <= 0
        OR v_nRow = 0 THEN
        INSERT INTO INV_LOT (organizationId, warehouseId, LotNum, CustomerID, SKU, Qty
        , Cubic, GrossWeight, NetWeight, Price
        , QtyPreAllocated, QtyAllocated, QtyOnHold
        , ADDTIME, AddWho, EditTime, EditWho)
          VALUES (In_organizationId, In_warehouse, IN_ToLotNUM, IN_ToCustomerID, IN_ToSKU, IN_ToQty, r_TotalCubic, r_TotalGrossWeight, IN_ToTotalNetWeight, IN_ToTotalPrice, 0, 0, 0, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID);
      ELSE
        UPDATE INV_LOT
        SET Qty = QTy + IN_ToQty,
            Cubic = Cubic + r_TotalCubic,
            GrossWeight = GrossWeight + r_TotalGrossWeight,
            NetWeight = NetWeight + IN_ToTotalNetWeight,
            Price = Price + IN_ToTotalPrice
        WHERE organizationId = In_organizationId
        AND LotNUM = IN_ToLotNUM;
        IF ROW_COUNT() = 0 THEN
          ROLLBACK;
          SET OUT_Return_Code = '353';
          LEAVE ENDPROC;
        END IF;
      END IF;
    END IF;



    IF IN_FMLotNUM <> IN_ToLotNUM
      OR IN_FMLocation <> IN_ToLocation
      OR IN_FMTraceID <> IN_ToTraceID THEN

      SET r_SN_CTL = getsys_configuration_D(In_organizationId, IN_Warehouse, IN_ToCustomerID, '*', 'SN#_CTL', '0');
      IF r_SN_CTL = '1' THEN

        SELECT
          SUM(qty)
        FROM DOC_ASN_SERIALNO
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND lotnum = IN_FMLotNUM
        AND locationid = IN_FMLocation
        AND traceid = IN_FMTraceID
        AND StockFlag = 'Y' INTO v_nRow;
        IF v_nRow > 0 THEN
          IF v_nRow <> IN_ToQty
            AND r_serialnocatch = 'Y' THEN
            SET OUT_Return_Code = '324';
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
          UPDATE DOC_ASN_SERIALNO
          SET Lotnum = IN_ToLotNUM,
              locationid = IN_ToLocation,
              traceid = IN_ToTraceID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND lotnum = IN_FMLotNUM
          AND locationid = IN_FMLocation
          AND traceid = IN_FMTraceID
          AND StockFlag = 'Y';
        END IF;
      ELSEIF r_SN_CTL = '2' THEN
        SELECT
          SUM(qty)
        FROM DOC_ASN_SUBSERIALNO
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND lotnum = IN_FMLotNUM
        AND locationid = IN_FMLocation
        AND traceid = IN_FMTraceID
        AND StockFlag = 'Y' INTO v_nRow;
        IF v_nRow > 0 THEN
          IF v_nRow <> IN_ToQty
            AND r_serialnocatch = 'Y' THEN
            SET OUT_Return_Code = '324';
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
          UPDATE DOC_ASN_SERIALNO
          SET Lotnum = IN_ToLotNUM,
              locationid = IN_ToLocation,
              traceid = IN_ToTraceID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND lotnum = IN_FMLotNUM
          AND locationid = IN_FMLocation
          AND traceid = IN_FMTraceID
          AND StockFlag = 'Y';
          UPDATE DOC_ASN_SUBSERIALNO
          SET Lotnum = IN_ToLotNUM,
              locationid = IN_ToLocation,
              traceid = IN_ToTraceID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND lotnum = IN_FMLotNUM
          AND locationid = IN_FMLocation
          AND traceid = IN_FMTraceID
          AND StockFlag = 'Y';

          UPDATE DOC_ASN_SERIALNO a
          SET locationid = IN_ToLocation,
              traceid = IN_ToTraceID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND SKU = 'MIXSKU'
          AND EXISTS (SELECT
              1
            FROM DOC_ASN_SUBSERIALNO b
            WHERE a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.serialno = b.serialno
            AND b.lotnum = IN_FMLotNUM
            AND b.locationid = IN_FMLocation
            AND b.traceid = IN_FMTraceID
            AND b.StockFlag = 'Y'
            AND b.organizationId = In_organizationId
            AND b.warehouseId = In_warehouse)
          AND a.StockFlag = 'Y';
        END IF;
      END IF;

      UPDATE INV_LOT_LOC_ID
      SET Qty = Qty - IN_ToQty,
          GrossWeight = CASE WHEN (GrossWeight - r_TotalGrossWeight) > 0 THEN (GrossWeight - r_TotalGrossWeight) ELSE 0 END,
          NetWeight = NetWeight - IN_ToTotalNetWeight,
          Cubic = CASE WHEN (Cubic - r_TotalCubic) > 0 THEN (Cubic - r_TotalCubic) ELSE 0 END,
          Price = Price - IN_ToTotalPrice,
          EditTime = R_CurrentTime,
          EditWho = IN_UserID
      WHERE TraceID = IN_FMTraceID
      AND LotNUM = IN_FMLotNUM
      AND LocationID = IN_FMLocation
      AND Qty >= IN_ToQty;
      IF ROW_COUNT() = 0 THEN
        ROLLBACK;
        SET OUT_Return_Code = '353';
        LEAVE ENDPROC;
      END IF;
      SET v_nRow = 0;
      SELECT
        1
      FROM INV_LOT_LOC_ID
      WHERE TraceID = IN_ToTraceID
      AND LotNUM = IN_ToLotNUM
      AND LocationID = IN_ToLocation INTO v_nRow FOR UPDATE;
      IF FOUND_ROWS() <= 0
        OR v_nRow = 0 THEN
        INSERT INTO INV_LOT_LOC_ID (organizationId, warehouseId, LocationID, LotNum, TraceID, CustomerID, SKU, QTy
        , QtyAllocated, QtyRPOUT, QtyMVOUT, QtyRPIN, QtyMVIN, QtyOnHold
        , Grossweight, NetWeight, Cubic, Price, LPN
        , ADDTIME, AddWho, EditTime, EditWho
        , InLocTime)
          VALUES (In_organizationId, In_warehouse, IN_ToLocation, IN_ToLotNUM, IN_ToTraceID, IN_ToCustomerID, IN_ToSKU, IN_ToQty, 0, 0, 0, 0, 0, 0, r_TotalGrossWeight, IN_ToTotalNetWeight, r_TotalCubic, IN_ToTotalPrice, R_TOLPN, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID, (CASE WHEN IN_FMLocation = IN_ToLocation THEN r_FMInLocTime ELSE R_CurrentTime END));
      ELSE
        UPDATE INV_LOT_LOC_ID
        SET Qty = Qty + IN_ToQty,
            GrossWeight = GrossWeight + r_TotalGrossWeight,
            NetWeight = NetWeight + IN_ToTotalNetWeight,
            Cubic = Cubic + r_TotalCubic,
            Price = Price + IN_ToTotalPrice,
            LPN = r_TOLPN,
            EditTime = R_CurrentTime,
            EditWho = IN_UserID,
            InLocTime = (CASE WHEN Qty = 0 AND
                IN_FMLocation = IN_ToLocation THEN R_CurrentTime ELSE InLocTime END)
        WHERE TraceID = IN_ToTraceID
        AND LotNUM = IN_ToLotNUM
        AND LocationID = IN_ToLocation;
        IF ROW_COUNT() = 0 THEN
          ROLLBACK;
          SET OUT_Return_Code = '353';
          LEAVE ENDPROC;
        END IF;
      END IF;
    END IF;



    SET OUT_Return_Code = 'NO_COMMIT';
    CALL SPCOM_GetIDSequence(In_organizationId, IN_Warehouse, IN_Language, 'TransactionID', R_TransactionID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;

    SELECT
      IFNULL(UDF02, 'N')
    FROM BSM_CODE
    WHERE codeType = 'TRN_TYP'
    AND codeId = 'TR' INTO r_UDF2;


    SET v_error = 1;
    SELECT
      a.packid
    FROM BAS_SKU a
    WHERE a.organizationId = In_organizationId
    AND a.customerid = IN_FMCustomerID
    AND a.sku = IN_FMSKU INTO r_FMPackID;
    IF IN_TOCustomerID <> IN_FMCustomerID
      OR IN_FMSKU <> IN_TOSKU THEN
      SELECT
        a.packid INTO r_TOPackID
      FROM BAS_SKU a
      WHERE a.customerid = IN_TOCustomerID
      AND a.sku = IN_TOSKU;
    ELSE
      SET r_TOPackID = r_FMPackID;
    END IF;

    INSERT INTO ACT_TRANSACTION_LOG (organizationId, TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
    , TransactionType, DocNo, DocLineNo, DocType
    , FMCustomerID, FMSku
    , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
    , ToCustomerID, ToSku
    , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
    , STATUS
    , WarehouseID
    , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
    , ReasonCode, Reason
    , ADDTIME, AddWho, EditTime, EditWho, TransactionTime
    , Edisendflag
    , Operator)
      VALUES (In_organizationId, R_TransactionID, '*', 0, 'N', '*', '0', 'N', 'TR', IN_TransferDocNo, IN_TransferDocLineNo, 'TR', IN_FMCustomerID, IN_FMSKU, IN_FMLotNUM, IN_FMLocation, IN_FMTraceID, r_FMPackID, 'EA', IN_FMQty, IN_FMQty, IN_ToCustomerID, IN_ToSKU, IN_ToLotNUM, IN_ToLocation, IN_ToTraceID, r_FMPackID, 'EA', IN_ToQty, IN_ToQty, '99', r_WarehouseID, r_TotalCubic, r_TotalGrossWeight, IN_ToTotalNetWeight, IN_ToTotalPrice, IN_ReasonCode, IN_Reason, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID, r_TransferTime_C, r_UDF2, IN_UserID);

    IF IFNULL(IN_TransferDocNo, '*') <> '*' THEN
      UPDATE DOC_TRANSFER_DETAILS d
      SET d.TDOCLineStatus = '10'
      WHERE d.organizationId = In_organizationId
      AND d.warehouseId = In_warehouse
      AND d.Tdocno = IN_TransferDocNo
      AND d.Tdoclineno = IN_TransferDocLineNo
      AND TDOCLineStatus < '10';
      IF ROW_COUNT() = 0 THEN
        ROLLBACK;
        SET OUT_Return_Code = '350';
        LEAVE ENDPROC;
      END IF;
      SELECT
        COUNT(1) INTO v_nRow
      FROM DOC_TRANSFER_DETAILS d
      WHERE d.organizationId = In_organizationId
      AND d.warehouseId = In_warehouse
      AND d.Tdocno = IN_TransferDocNo
      AND d.TDOCLineStatus <> '10';
      IF v_nRow > 0 THEN
        UPDATE DOC_TRANSFER_HEADER
        SET STATUS = '05',
            TransferTime = R_CurrentTime
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND Tdocno = IN_TransferDocNo;
      ELSE
        UPDATE DOC_TRANSFER_HEADER
        SET STATUS = '10',
            TransferTime = R_CurrentTime
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND Tdocno = IN_TransferDocNo;
      END IF;
    END IF;


    SET OUT_Return_Code = '*_*';
    CALL SPINV_Hold_Update(In_organizationId, IN_Warehouse, IN_TOCustomerID, IN_TOSKU, IN_ToLotNUM
    , IN_ToLocation, IN_ToTraceID
    , IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;

    SET r_para4 = CONCAT(r_para4, '%', TRIM(R_TransactionID));
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'TR_AFTER'
    , r_Para2, r_Para3, r_para4
    , IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;


    IF IN_GainLoss <> 0 THEN
      SET r_AdjustmentToQty = IN_ToQty + IFNULL(IN_GainLoss, 0);
      SET OUT_Return_Code = '*_*';
      CALL SPINV_Adjustment_Process(In_organizationId, IN_Warehouse, '*', 0
      , IN_ToCustomerID, IN_ToSKU, IN_ToLotNum
      , IN_ToLocation, IN_ToTraceID, IN_ToQty, r_AdjustmentToQty
      , IN_ReasonCode, IN_Reason, IN_TransferTime
      , r_TotalGrossWeight, IN_ToTotalNetWeight, r_TotalCubic
      , IN_ToTotalPrice, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF IFNULL(IN_TransferDocNo, '*') <> '*' THEN
        UPDATE ACT_TRANSACTION_LOG
        SET doctype = 'TR',
            docno = IN_TransferDocNo
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND transactionID = SUBSTRING(OUT_Return_Code, 4);
      END IF;

    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = CONCAT('000', IN_ToLotNUM);
  END
  $$

--
-- Create procedure `SPASN_Close_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPASN_Close_Process (IN IN_organizationId varchar(20),
IN IN_warehouseID varchar(20),
IN IN_ASNNo varchar(20),
IN IN_Close_CancelFlag varchar(10),
IN IN_ASNSplit varchar(1),
IN In_Language varchar(10),
IN In_UserID varchar(35),
INOUT OUT_Return_Code varchar(500))
ENDPROC:
  BEGIN

    DECLARE R_Status varchar(2);
    DECLARE R_CustomerID_R varchar(30);
    DECLARE R_IDLength int;
    DECLARE R_ASN_CLS_CTL char(1);
    DECLARE R_SN_ASN_CLS char(1);
    DECLARE R_OpenQty decimal(18, 8);
    DECLARE IN_ASNNo_New varchar(20);
    DECLARE R_CurrentTime timestamp;
    DECLARE R_3PL_BIL char(1);

    DECLARE R_TransactionID varchar(30);
    DECLARE SP_SQL_R varchar(3000);
    DECLARE r_PTA_CLS_CHK char(1);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_NO_COMMIT char(1);
    DECLARE r_ASN_SPL_SEQ char(1);
    DECLARE R_ASN_RLS_CTL char(1);
    DECLARE R_ReleaseStatus char(1);
    DECLARE r_ASNType varchar(10);
    DECLARE r_UDF2 varchar(20);
    DECLARE r_ASN_SPL_REJ char(1);
    DECLARE r_REF_CHK_ASN char(1);
    DECLARE r_ASNreference1_NEW varchar(200);
    DECLARE r_ASNreference1 varchar(200);
    DECLARE r_asngroupno varchar(20);
    DECLARE r_minasnstatus varchar(10);
    DECLARE r_maxasnstatus varchar(10);
    DECLARE r_qtyreleased_PO decimal(18, 8);
    DECLARE r_qtyreleased decimal(18, 8);
    DECLARE r_pono varchar(20);
    DECLARE V_S varchar(100);
    DECLARE r_poLineNo int;
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE c_pono1 CURSOR FOR
    SELECT DISTINCT
      poNo,
      poLineNo
    FROM DOC_ASN_DETAILS
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseID
    AND ASNNo = IN_ASNNo
    AND pono IS NOT NULL;
    DECLARE c_pono2 CURSOR FOR
    SELECT DISTINCT
      pono
    FROM DOC_ASN_DETAILS
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseID
    AND ASNNo = IN_ASNNo
    AND pono IS NOT NULL;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_RETURN_CODE = CONCAT('999#SPASN_Close_Process', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_RETURN_CODE AS error;
    END;
    SET v_error = 1;
    IF OUT_Return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET R_CurrentTime = NOW();
    SET Out_Return_Code = '000';
    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;



    SET OUT_Return_Code = '*_*';
    CALL SPUDF_ProcessA(IN_organizationId, IN_warehouseID, 'ASNCLOSE_BEFORE', IN_ASNNo, IN_Close_CancelFlag, '', IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;
    SET v_error = 1;
    SELECT
      ASNStatus,
      CustomerID,
      WarehouseID,
      ASNType,
      ASNreference1
    FROM DOC_ASN_HEADER
    WHERE organizationId = In_organizationId
    AND warehouseId = IN_warehouseID
    AND ASNNO = IN_ASNNo INTO R_Status, R_CustomerID_R, r_WarehouseID, r_ASNType, r_ASNreference1;
    IF v_error = 0 THEN
      SET OUT_Return_Code = CONCAT('203 ', IN_ASNNo);
      LEAVE ENDPROC;
    END IF;

    SELECT
      COUNT(1)
    FROM DOC_QV_HEADER a
    WHERE a.organizationId = IN_organizationId
    AND a.warehouseId = IN_warehouseID
    AND a.sourceno = IN_ASNNo
    AND a.qvtype IN ('QTY', 'WGT')
    AND a.qvstatus < '80' INTO v_nrow;
    IF v_nrow > 0 THEN
      SET OUT_Return_Code = CONCAT('999#?????????????,????', IN_ASNNo);
      LEAVE ENDPROC;
    END IF;


    SET R_PTA_CLS_CHK = getsys_configuration(IN_organizationId, IN_warehouseID, R_CustomerID_R, r_ASNType, 'PTA_CLS_CHK');

    SET R_ASN_CLS_CTL = getsys_configuration(IN_organizationId, IN_warehouseID, R_CustomerID_R, r_ASNType, 'ASN_CLS_CTL');

    SET r_ASN_SPL_SEQ = getsys_configuration_D(IN_organizationId, IN_warehouseID, R_CustomerID_R, r_ASNType, 'ASN_SPL_SEQ', 'Y');

    SET r_ASN_RLS_CTL = getsys_configuration_D(IN_organizationId, IN_warehouseID, R_CustomerID_R, r_ASNType, 'ASN_RLS_CTL', '');
    IF (R_Status = '99'
      OR R_Status = '90'
      OR (R_Status = '00'
      AND R_ASN_CLS_CTL = 'N')
      OR R_Status = '10')
      AND IN_Close_CancelFlag = '99' THEN
      SET OUT_Return_Code = '201';
      LEAVE ENDPROC;
    END IF;
    IF (R_Status <> '00')
      AND IN_Close_CancelFlag = '90' THEN
      SET OUT_Return_Code = '216';
      LEAVE ENDPROC;
    END IF;


    IF r_PTA_CLS_CHK = 'Y' THEN
      SELECT
        COUNT(*)
      FROM TSK_TASKLISTS
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouseID
      AND DocNo = IN_ASNNO
      AND TaskProcess <= '10'
      AND TaskType = 'PA' INTO v_nrow;
      IF v_nrow > 0 THEN
        SET Out_Return_Code = '212';
        LEAVE ENDPROC;
      END IF;
    END IF;


    SELECT
      SN_ASN_CLS
    FROM BAS_CUSTOMER
    WHERE organizationId = IN_organizationId
    AND Customerid = R_CustomerID_R
    AND customertype = 'OW'
    LIMIT 1 INTO R_SN_ASN_CLS;
    IF R_SN_ASN_CLS = 'Y' THEN
      SELECT
        COUNT(*)
      FROM DOC_ASN_SerialNO
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouseID
      AND ASNNO = IN_ASNNo INTO v_nrow;
      IF v_nrow < 1 THEN
        SET OUT_Return_Code = '261';
        LEAVE ENDPROC;
      END IF;
    END IF;





    SELECT
      COUNT(*)
    FROM ACT_TRANSACTION_LOG
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseID
    AND DocNo = IN_ASNNo
    AND TransactionType = '99'
    AND DOCTYPE = 'ASN' INTO v_nrow;
    IF v_nrow > 0 THEN
      DELETE
        FROM DOC_ASN_INBOUND
      WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseID
        AND ASNNo = IN_ASNNo;
      DELETE
        FROM BIL_SUMMARY
      WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseID
        AND DOCNO = IN_ASNNo
        AND DOCType = 'ASN';
    END IF;



    SELECT
      COUNT(*)
    FROM DOC_ASN_INBOUND
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseID
    AND ASNNo = IN_ASNNo INTO v_nrow;
    IF v_nrow <= 0 THEN
      INSERT INTO DOC_ASN_INBOUND (organizationId, warehouseId, InboundDate, ASNNO, TotalQty, TotalCube, TotalGrossWeight, TotalNetWeight, TotalPrice, ADDTIME, Addwho, EditTime, EditWho
      , INBoundSEQNo)
        SELECT
          IN_organizationId,
          IN_warehouseID,
          CASE WHEN TRIM(c.lotatt03) IS NULL THEN DATE_FORMAT(b.TransactionTime, '%Y-%m-%d') ELSE DATE_FORMAT(c.LotAtt03, '%Y-%m-%d') END,
          a.ASNNo,
          SUM(b.TOQty_EACH),
          SUM(b.TotalCubic),
          SUM(b.TotalGrossWeight),
          SUM(b.TotalNetWeight),
          SUM(b.TotalPrice),
          R_CurrentTime,
          IN_UserID,
          R_CurrentTime,
          IN_UserID,
          UUID()
        FROM DOC_ASN_DETAILS a
          LEFT JOIN ACT_TRANSACTION_LOG b
            ON b.TransactionType = 'IN'
            AND b.Status = '99'
            AND a.ASNNo = b.DocNo
            AND a.ASNLineNo = b.DocLineNo
          LEFT JOIN INV_LOT_ATT c
            ON b.FMLOTNUM = c.LotNum
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseId = IN_warehouseID
        AND a.ASNNo = IN_ASNNo
        GROUP BY CASE WHEN TRIM(c.lotatt03) IS NULL THEN DATE_FORMAT(b.TransactionTime, '%Y-%m-%d') ELSE DATE_FORMAT(c.LotAtt03, '%Y-%m-%d') END,
                 a.ASNNo;
    END IF;

    IF IN_Close_CancelFlag = '99'
      AND IN_ASNSplit = 'Y' THEN
      SET R_OpenQty = 0;
      SET r_ASN_SPL_REJ = getsys_configuration(IN_organizationId, IN_warehouseID, R_CustomerID_R, r_ASNType, 'ASN_SPL_REJ');
      SELECT
        SUM(ExpectedQty_Each) - SUM(ReceivedQty_Each) - (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(SUM(rejectedqty_each), 0) ELSE 0 END)
      FROM DOC_ASN_DETAILS
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouseID
      AND ASNNo = IN_ASNNo
      AND ExpectedQty_Each > ReceivedQty_Each + (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(rejectedqty_each, 0) ELSE 0 END) INTO R_OpenQty;
      IF R_OpenQty > 0 THEN

        SET r_REF_CHK_ASN = getsys_configuration(IN_organizationId, IN_warehouseID, R_CustomerID_R, r_ASNType, 'REF_CHK_ASN');
        IF r_REF_CHK_ASN = 'Y' THEN
          SET r_IDLength = INSTR(r_ASNreference1, '*') - 1;
          IF r_IDLength <= 0 THEN
            SET r_IDLength = LENGTH(r_ASNreference1);
          END IF;
          SELECT
            COUNT(1)
          FROM DOC_ASN_HEADER
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseID
          AND ASNreference1 LIKE CONCAT(SUBSTRING(r_ASNreference1, 1, r_IDLength), '%') INTO v_nrow;
          IF v_nrow < 10 THEN
            SET r_ASNreference1_NEW = CONCAT(SUBSTRING(r_ASNreference1, 1, r_IDLength), '*0', v_nrow);
          ELSE
            SET r_ASNreference1_NEW = CONCAT(SUBSTRING(r_ASNreference1, 1, r_IDLength), '*', v_nrow);
          END IF;
        ELSE
          SET r_ASNreference1_NEW = r_ASNreference1;
        END IF;

        SET v_nrow = 0;


        IF r_ASN_SPL_SEQ = 'Y' THEN
          SET R_IDLength = INSTR(IN_ASNNo, '*') - 1;
          IF R_IDLength <= 0 THEN
            SET R_IDLength = LENGTH(IN_ASNNo);
            SET v_nrow = 1;
          END IF;
          SELECT
            SUBSTRING(MAX(ASNNO), R_IDLength + 2, 2) + 1
          FROM DOC_ASN_HEADER
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseID
          AND ASNNo LIKE CONCAT(SUBSTRING(IN_ASNNo, 1, R_IDLength), '%') INTO v_nrow;
          IF v_nrow < 10 THEN
            SET IN_ASNNo_New = CONCAT(SUBSTRING(IN_ASNNo, 1, R_IDLength), '*0', v_nrow);
          ELSE
            SET IN_ASNNo_New = CONCAT(SUBSTRING(IN_ASNNo, 1, R_IDLength), '*', v_nrow);
          END IF;
        ELSE
          SET IN_ASNNo_New = CONCAT(IN_ASNNo, '*');
        END IF;
        INSERT INTO DOC_ASN_HEADER (organizationId, warehouseId, ASNNo, ASNStatus, ASNType, ASNCreationTime, CustomerID, ASNReference1, ASNReference2, ASNReference3, ASNReference4, ASNReference5,
        CarrierID, CarrierName, CarrierAddress1, CarrierAddress2, CarrierAddress3, CarrierAddress4,
        CarrierCity, CarrierProvince, CarrierCountry, CarrierZIP,
        ExpectedArriveTime1, ExpectedArriveTime2,
        SupplierID, Supplier_Name, Supplier_Address1, Supplier_Address2, Supplier_Address3, Supplier_Address4,
        Supplier_City, Supplier_Province, Supplier_Country, Supplier_ZIP,
        CountryOfOrigin, CountryOfDestination, PlaceOfLoading, PlaceOfDischarge, PlaceOfDelivery,
        DeliveryVehicleNo, Driver, DeliveryTerms, DeliveryTermsDescr, PaymentTerms, PaymentTermsDescr,
        Door, UserDefine1, UserDefine2, UserDefine3, UserDefine4, UserDefine5, Notes, ADDTIME, AddWho, EditTime, EditWho,
        PONO,
        ReleaseStatus,
        UserDefineA, UserDefineB,

        H_EDI_01, H_EDI_02, H_EDI_03, H_EDI_04, H_EDI_05, H_EDI_06, H_EDI_07, H_EDI_08, H_EDI_09, H_EDI_10, Userdefine6
        , QCStatus)
          SELECT
            IN_oraganizationId,
            IN_warehouseID,
            IN_ASNNo_New,
            '00',
            ASNType,
            ASNCreationTime,
            CustomerID,
            r_ASNreference1_NEW,
            ASNReference2,
            ASNReference3,
            ASNReference4,
            ASNReference5,
            CarrierID,
            CarrierName,
            CarrierAddress1,
            CarrierAddress2,
            CarrierAddress3,
            CarrierAddress4,
            CarrierCity,
            CarrierProvince,
            CarrierCountry,
            CarrierZIP,
            ExpectedArriveTime1,
            ExpectedArriveTime2,
            SupplierID,
            Supplier_Name,
            Supplier_Address1,
            Supplier_Address2,
            Supplier_Address3,
            Supplier_Address4,
            Supplier_City,
            Supplier_Province,
            Supplier_Country,
            Supplier_ZIP,
            CountryOfOrigin,
            CountryOfDestination,
            PlaceOfLoading,
            PlaceOfDischarge,
            PlaceOfDelivery,
            DeliveryVehicleNo,
            Driver,
            DeliveryTerms,
            DeliveryTermsDescr,
            PaymentTerms,
            PaymentTermsDescr,
            Door,
            UserDefine1,
            UserDefine2,
            UserDefine3,
            UserDefine4,
            UserDefine5,
            Notes,
            R_CurrentTime,
            IN_UserID,
            R_Currenttime,
            IN_UserID,
            PONO,
            ifnulll(r_ASN_RLS_CTL, r_ReleaseStatus),
            UserDefineA,
            UserDefineB,

            H_EDI_01,
            H_EDI_02,
            H_EDI_03,
            H_EDI_04,
            H_EDI_05,
            H_EDI_06,
            H_EDI_07,
            H_EDI_08,
            H_EDI_09,
            H_EDI_10,
            Userdefine6,
            QCStatus
          FROM DOC_ASN_HEADER
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseID
          AND ASNNo = IN_ASNNo;
        INSERT INTO DOC_ASN_DETAILS (organizationId, warehouseId, ASNNo, ASNLineNo, CustomerID, SKU, SKUDescrC, SKUDescrE, PONO, LineStatus,
        ExpectedQty, ExpectedQty_Each, RejectedQty, RejectedQty_Each, ReceivedQty, ReceivedQty_Each, UOM,
        PackID, HoldRejectCode, HoldRejectReason, ReceivingLocation, LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05,
        LotAtt06, LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12, ProductStatus, ProductStatus_Descr,
        TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice, UserDefine1, UserDefine2, UserDefine3, UserDefine4, UserDefine5, Notes,
        ADDTIME, AddWho, EditTime, EditWho, Reserve_Flag,
        POLineNo,
        D_EDI_01, D_EDI_02, D_EDI_03, D_EDI_04, D_EDI_05, D_EDI_06, D_EDI_07, D_EDI_08, D_EDI_09, D_EDI_10
        , D_EDI_11, D_EDI_12, D_EDI_13, D_EDI_14, D_EDI_15, D_EDI_16, D_EDI_17, D_EDI_18, D_EDI_19, D_EDI_20
        , PalletizeQTY_Each
        , qcstatus)
          SELECT
            IN_oraganizationId,
            IN_warehouseID,
            IN_ASNNo_New,
            ASNLineNo,
            CustomerID,
            SKU,
            SKUDescrC,
            SKUDescrE,
            PONO,
            '00',
            ExpectedQty - ReceivedQty - (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(rejectedqty, 0) ELSE 0 END),
            ExpectedQty_Each - ReceivedQty_Each - (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(rejectedqty_each, 0) ELSE 0 END),
            0,
            0,
            0,
            0,
            UOM,
            PackID,
            HoldRejectCode,
            HoldRejectReason,
            ReceivingLocation,
            LotAtt01,
            LotAtt02,
            LotAtt03,
            LotAtt04,
            LotAtt05,
            LotAtt06,
            LotAtt07,
            LotAtt08,
            LotAtt09,
            LotAtt10,
            LotAtt11,
            LotAtt12,
            ProductStatus,
            ProductStatus_Descr,
            ((ExpectedQty_Each - ifnulll(ReceivedQty_Each, 0) - (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(rejectedqty_each, 0) ELSE 0 END)) / ExpectedQty_Each) * TotalCubic,
            ((ExpectedQty_Each - ifnulll(ReceivedQty_Each, 0) - (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(rejectedqty_each, 0) ELSE 0 END)) / ExpectedQty_Each) * TotalGrossWeight,
            ((ExpectedQty_Each - ifnulll(ReceivedQty_Each, 0) - (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(rejectedqty_each, 0) ELSE 0 END)) / ExpectedQty_Each) * TotalNetWeight,
            ((ExpectedQty_Each - ifnulll(ReceivedQty_Each, 0) - (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(rejectedqty_each, 0) ELSE 0 END)) / ExpectedQty_Each) * TotalPrice,
            UserDefine1,
            UserDefine2,
            UserDefine3,
            UserDefine4,
            UserDefine5,
            Notes,
            R_CurrentTime,
            IN_UserID,
            R_Currenttime,
            IN_UserID,
            'N',
            POLineNo,
            D_EDI_01,
            D_EDI_02,
            D_EDI_03,
            D_EDI_04,
            D_EDI_05,
            D_EDI_06,
            D_EDI_07,
            D_EDI_08,
            D_EDI_09,
            D_EDI_10,
            D_EDI_11,
            D_EDI_12,
            D_EDI_13,
            D_EDI_14,
            D_EDI_15,
            D_EDI_16,
            D_EDI_17,
            D_EDI_18,
            D_EDI_19,
            D_EDI_20,
            0
          FROM DOC_ASN_DETAILS
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseID
          AND ASNNo = IN_ASNNo
          AND ExpectedQty_Each > ReceivedQty_Each + (CASE WHEN r_ASN_SPL_REJ = 'Y' THEN ifnulll(rejectedqty_each, 0) ELSE 0 END)
          AND LineStatus < '90';
        UPDATE DOC_ASN_HEADER
        SET CreateSource = 'SPLIT',
            EditTime = R_CurrentTime,
            EditWho = IN_UserID
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseID
        AND ASNNO = IN_ASNNo;
      END IF;
    END IF;

    IF IN_Close_CancelFlag = '99' THEN





      SET OUT_Return_Code = 'NO_COMMIT';

    END IF;

    SET OUT_Return_Code = 'NO_COMMIT';
    CALL SPCOM_GetIDSequence(IN_organizationId, IN_warehouseID, IN_Language, 'TransactionID', R_TransactionID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;



    SET V_S = GETSYS_configuration(IN_OrganizationId, IN_WarehouseID, R_CustomerID_R, '', 'TRN_TYP');
    IF INSTR(V_S, '99') > 0 THEN
      SET r_UDF2 = 'N';
    ELSE
      SET r_UDF2 = 'O';
    END IF;



    INSERT INTO ACT_TRANSACTION_LOG (OrganizationId, TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
    , TransactionType
    , DocNo, DocLineNo, DocType
    , FMCustomerID, FMSKU
    , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
    , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
    , STATUS, WarehouseID
    , TOCustomerID, TOSku
    , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
    , ADDTIME, AddWho, EditTime, EditWho
    , Operator, TransactionTime
    , Edisendflag)
      VALUES (IN_OrganizationId, R_TransactionID, NULL, NULL, NULL, NULL, NULL, NULL, IN_Close_CancelFlag, IN_ASNNo, 0, 'ASN', R_CustomerID_R, '*', '*', '*', '*', '*', '*', 0, 0, '*', '*', '*', '*', '*', 0, 0, '99', r_WarehouseID, R_CustomerID_R, '*', 0, 0, 0, 0, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID, IN_UserID, R_CurrentTime, r_UDF2);

    UPDATE DOC_ASN_DETAILS
    SET LineStatus = IN_Close_CancelFlag,
        EditTime = R_CurrentTime,
        EditWho = IN_UserID
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseID
    AND ASNNO = IN_ASNNo;
    UPDATE DOC_ASN_HEADER
    SET ASNStatus = IN_Close_CancelFlag,
        EditTime = R_CurrentTime,
        EditWho = IN_UserID
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseID
    AND ASNNO = IN_ASNNo;


    OPEN c_pono1;
    SET v_error = 1;
    FETCH c_pono1 INTO r_pono, r_polineno;
    WHILE v_error <> 0 DO
      SELECT
        SUM((CASE Linestatus WHEN '90' THEN 0 WHEN '99' THEN a.receivedqty_each ELSE a.expectedqty_each END))
      FROM DOC_ASN_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseId = IN_warehouseID
      AND a.pono = r_pono
      AND a.polineno = r_polineno INTO R_qtyreleased;

      SELECT
        qtyreleased
      FROM DOC_PO_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseId = IN_warehouseID
      AND a.pono = r_pono
      AND a.polineno = r_polineno INTO r_qtyreleased_PO;
      IF r_qtyreleased_PO <> r_qtyreleased THEN
        UPDATE DOC_PO_DETAILS a
        SET a.qtyreleased = r_qtyreleased
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseId = IN_warehouseID
        AND a.pono = r_pono
        AND a.polineno = r_polineno;
      END IF;
      SET v_error = 1;
      FETCH c_pono1 INTO r_pono, r_polineno;
    END WHILE;
    CLOSE c_pono1;

    OPEN c_pono2;
    SET v_error = 1;
    FETCH c_pono2 INTO r_pono;
    WHILE v_error <> 0 DO
      SELECT
        poStatus
      FROM DOC_PO_HEADER h
      WHERE h.organizationId = IN_organizationId
      AND h.warehouseId = IN_warehouseID
      AND h.pono = r_pono INTO R_Status;

      IF IN_Close_CancelFlag = '99'
        AND R_Status = '40' THEN

        SELECT
          COUNT(*)
        FROM DOC_ASN_DETAILS d
        WHERE d.organizationId = IN_organizationId
        AND d.warehouseId = IN_warehouseID
        AND d.PONo = r_pono
        AND d.lineStatus < '90' INTO v_nrow;
        IF v_nrow = 0 THEN
          UPDATE DOC_PO_DETAILS d
          SET d.polinestatus = '99'
          WHERE d.organizationId = IN_organizationId
          AND d.warehouseId = IN_warehouseID
          AND d.pono = r_pono;

          UPDATE DOC_PO_HEADER h
          SET h.postatus = '99'
          WHERE h.organizationId = IN_organizationId
          AND h.warehouseId = IN_warehouseID
          AND h.pono = r_pono;
        END IF;
      ELSEIF IN_Close_CancelFlag = '90' THEN

        UPDATE DOC_PO_DETAILS d
        SET d.polinestatus = CASE WHEN d.receivedqty_each > 0 THEN '30' ELSE '00' END
        WHERE d.organizationId = IN_organizationId
        AND d.warehouseId = IN_warehouseID
        AND d.pono = r_pono;
        SELECT
          MAX(polinestatus)
        FROM DOC_PO_DETAILS d
        WHERE d.organizationId = IN_organizationId
        AND d.warehouseId = IN_warehouseID
        AND d.pono = r_pono INTO R_Status;
        UPDATE DOC_PO_HEADER h
        SET h.postatus = R_Status
        WHERE h.organizationId = IN_organizationId
        AND h.warehouseId = IN_warehouseID
        AND h.PONo = x.PONo;
      END IF;
      SET v_error = 1;
      FETCH c_pono2 INTO r_pono;
    END WHILE;
    CLOSE c_pono2;


    SET v_error = 1;
    SELECT
      d.asngroupno
    FROM DOC_ASNGROUP_DETAILS d
    WHERE d.organizationId = IN_organizationId
    AND d.warehouseId = IN_warehouseID
    AND d.asnno = IN_ASNNo INTO r_asngroupno;
    IF v_error = 0 THEN
      SET r_asngroupno = '*';
    END IF;
    IF r_asngroupno <> '*' THEN
      SELECT
        ifnulll(MIN(h.asnstatus), '00'),
        ifnulll(MAX(h.asnstatus), '00')
      FROM DOC_ASN_HEADER h
        INNER JOIN DOC_ASNGROUP_DETAILS d
          ON d.asnno = h.asnno
      WHERE d.organizationId = IN_organizationId
      AND d.warehouseId = IN_warehouseID
      AND d.asngroupno = r_asngroupno INTO r_minasnstatus, r_maxasnstatus;
      IF r_maxasnstatus = '99'
        AND r_minasnstatus >= '90' THEN
        UPDATE DOC_ASNGROUP_HEADER h
        SET h.asngroupstatus = '99'
        WHERE h.organizationId = IN_organizationId
        AND h.warehouseId = IN_warehouseID
        AND h.asngroupno = r_asngroupno;
      ELSEIF r_maxasnstatus = '90'
        AND r_minasnstatus = '90' THEN
        UPDATE DOC_ASNGROUP_HEADER h
        SET h.asngroupstatus = '90'
        WHERE h.organizationId = IN_organizationId
        AND h.warehouseId = IN_warehouseID
        AND h.asngroupno = r_asngroupno;
      END IF;
    END IF;

    IF R_OpenQty > 0
      AND r_ASN_SPL_SEQ <> 'Y' THEN
      CALL SPCOM_GetIDSequence(IN_organizationId, IN_warehouseID, in_Language, 'ASNNO', IN_ASNNo_New, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      UPDATE DOC_ASN_DETAILS d
      SET d.asnno = IN_ASNNo_New
      WHERE d.organizationId = IN_organizationId
      AND d.warehouseId = IN_warehouseID
      AND d.asnno = CONCAT(IN_ASNNo, '*');
      UPDATE DOC_ASN_HEADER d
      SET d.asnno = IN_ASNNo_New
      WHERE d.organizationId = IN_organizationId
      AND d.warehouseId = IN_warehouseID
      AND d.asnno = CONCAT(IN_ASNNo, '*');
    END IF;
    SET OUT_Return_Code = 'NO_COMMIT';
    CALL SPUDF_ProcessA(IN_organizationId, IN_warehouseID, 'ASNCLOSE_AFTER', IN_ASNNo, IN_Close_CancelFlag, IN_ASNNo_New, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      IF r_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `SPASN_Cancel_Receiving`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPASN_Cancel_Receiving (IN IN_organizationId varchar(30),
IN IN_Warehouse varchar(30),
IN IN_TransactionID varchar(30),
IN IN_ReasonCode varchar(30),
IN IN_Reason varchar(30),
IN IN_Language varchar(30),
IN IN_UserID varchar(30),
INOUT OUT_Return_Code varchar(2000))
ENDPROC:
  BEGIN
    DECLARE r_PA_TaskID_log varchar(30);
    DECLARE r_PA_Sequence_Log int;
    DECLARE r_PA_Flag_Log varchar(1);

    DECLARE r_TransactionType_Log varchar(2);
    DECLARE r_DocNo_Log varchar(20);
    DECLARE r_DocLineNo_Log int;
    DECLARE r_DocType_Log varchar(10);
    DECLARE r_Status_Log varchar(2);

    DECLARE r_FMCustomerID_Log varchar(30);
    DECLARE r_FMSku_Log varchar(50);
    DECLARE r_FMLotNum_Log varchar(30);
    DECLARE r_FMLocation_Log varchar(30);
    DECLARE r_FMID_Log varchar(30);
    DECLARE r_FMQty_Log decimal(18, 8);
    DECLARE r_FMQty_Each_Log decimal(18, 8);
    DECLARE r_FMPackID_Log varchar(40);
    DECLARE r_FMUOM_Log varchar(10);

    DECLARE r_ToCustomerID_Log varchar(30);
    DECLARE r_ToSku_Log varchar(50);
    DECLARE r_ToLotNum_Log varchar(30);
    DECLARE r_ToLocation_Log varchar(30);
    DECLARE r_ToID_Log varchar(30);
    DECLARE r_ToQty_Log decimal(18, 8);
    DECLARE r_ToQty_Each_Log decimal(18, 8);
    DECLARE r_ToUOM_Log varchar(10);
    DECLARE r_ToPackID_Log varchar(40);

    DECLARE r_ToTotalCubic_Log decimal(18, 8);
    DECLARE r_ToTotalGrossWeight_Log decimal(18, 8);
    DECLARE r_ToTotalNetWeight_Log decimal(18, 8);
    DECLARE r_ToTotalPrice_Log decimal(18, 8);

    DECLARE r_QC_TaskID_Log varchar(10);
    DECLARE r_QC_Sequence_Log varchar(4);
    DECLARE r_QC_Flag_Log varchar(1);
    DECLARE r_cancelledQty_Log decimal(18, 8);
    DECLARE r_ReceivedTime_Log timestamp;

    DECLARE r_GROUPTASKID varchar(30);
    DECLARE r_ToQty_Each decimal(18, 8);
    DECLARE r_PlanToLoc varchar(30);

    DECLARE r_ASNNO varchar(30);
    DECLARE r_ASNLineNO int;
    DECLARE r_ASNType varchar(30);
    DECLARE r_ASNStatus varchar(30);
    DECLARE r_PONO varchar(30);
    DECLARE r_POLineNO int;
    DECLARE r_QCNO varchar(30);
    DECLARE r_QCLineNO int;
    DECLARE r_inventoryholdid varchar(30);
    DECLARE r_SN_CTL varchar(10);
    DECLARE r_RCV_CCL_CHK varchar(10);

    DECLARE r_QtyInv decimal(18, 8);
    DECLARE r_QtyMVOut decimal(18, 8);
    DECLARE r_SKU varchar(30);

    DECLARE r_ExpectedQty_Each_ASN decimal(18, 8);
    DECLARE r_ReceivedQty_each_ASN decimal(18, 8);
    DECLARE r_LineStatus varchar(10);
    DECLARE r_MaxLineStatus varchar(10);
    DECLARE r_MinLineStatus varchar(10);
    DECLARE r_UOM varchar(30);
    DECLARE r_PackID varchar(30);
    DECLARE r_QTY1_P decimal(18, 8);
    DECLARE r_QTY2_P decimal(18, 8);
    DECLARE r_QTY3_P decimal(18, 8);
    DECLARE r_QTY4_P decimal(18, 8);
    DECLARE r_QTY5_P decimal(18, 8);
    DECLARE r_UOMQty decimal(18, 8);

    DECLARE r_CurrentTime timestamp;
    DECLARE r_Tran_CTL char(1) DEFAULT 'Y';
    DECLARE r_nrow int;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_RETURN_CODE = CONCAT('999#SPASN_Cancel_Receiving', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_RETURN_CODE AS error;
    END;

    IF OUT_Return_Code = '*_*' THEN
      SET r_Tran_Ctl = 'N';
    END IF;
    SET OUT_Return_Code = '000';
    SET r_CurrentTime = NOW();
    IF r_Tran_Ctl = 'Y' THEN
      START TRANSACTION;
    END IF;


    SET Out_Return_Code = '*_*';
    CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'CRC_BEFORE', IN_TransactionID, NULL, NULL, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;


    SET r_TransactionType_Log = '*';
    SELECT
      t.`transactionType`,
      t.`docNo`,
      t.`docLineNo`,
      t.`docType`,
      t.`status`,
      t.`fmCustomerId`,
      t.`fmSku`,
      t.`fmLotNum`,
      t.`fmLocation`,
      t.`fmId`,
      t.`fmQty`,
      t.`fmQty_Each`,
      t.`fmUom`,
      t.`fmPackId`,
      t.`toCustomerId`,
      t.`toSku`,
      t.`toLotNum`,
      t.`toLocation`,
      t.`toId`,
      t.`toQty`,
      t.`toQty_Each`,
      t.`toUom`,
      t.`toPackId`,
      t.`totalCubic`,
      t.`totalGrossWeight`,
      t.`totalNetWeight`,
      t.`totalPrice`,
      t.`qcTaskId`,
      t.`qcSequence`,
      t.`qcFlag`,
      t.PATaskID,
      t.paSequence,
      t.`qcFlag`,
      t.`transactionTime`,
      t.`cancelledQty`
    FROM ACT_TRANSACTION_LOG t
    WHERE t.organizationId = IN_organizationId
    AND t.warehouseId = IN_Warehouse
    AND t.transactionId = IN_TransactionID INTO r_TransactionType_Log, r_DocNo_Log, r_DocLineNo_Log, r_DocType_Log, r_Status_Log
    , r_FMCustomerID_Log, r_FMSku_Log, r_FMLotNum_Log, r_FMLocation_Log, r_FMID_Log, r_FMQty_Log, r_FMQty_Each_Log, r_FMUOM_Log, r_FMPackID_Log
    , r_ToCustomerID_Log, r_ToSku_Log, r_ToLotNum_Log, r_ToLocation_Log, r_ToID_Log, r_ToQty_Log, r_ToQty_Each_Log, r_ToUOM_Log, r_ToPackID_Log
    , r_ToTotalCubic_Log, r_ToTotalGrossWeight_Log, r_ToTotalNetWeight_Log, r_ToTotalPrice_Log
    , r_QC_TaskID_Log, r_QC_Sequence_Log, r_QC_Flag_Log
    , r_PA_TaskID_Log, r_PA_Flag_Log, r_PA_Sequence_Log, r_ReceivedTime_Log, r_cancelledQty_Log
    FOR UPDATE
    ;
    IF r_TransactionType_Log <> 'IN' THEN
      SET OUT_Return_Code = '099';
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;
    IF r_Status_Log = '90' THEN
      SET OUT_Return_Code = '351';
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;


    IF IFNULL(r_PA_TaskID_Log, '*') = '*' THEN
      SELECT
        t.taskid,
        t.taskid_sequence INTO r_PA_TaskID_log, r_PA_Sequence_Log
      FROM TSK_TASKLISTS t
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND t.tasktype = 'PA'
      AND t.fmlotnum = r_FMLotNum_Log
      AND t.fmlocation = r_FMLocation_Log
      AND t.fmid = r_FMID_Log;
    END IF;


    IF IFNULL(r_PA_TaskID_Log, '*') <> '*' THEN
      SET r_PlanToLoc = '*';
      SELECT
        GROUPTASKID,
        plantolocation,
        CASE WHEN taskprocess = '99' THEN plantoqty_each ELSE 0 END INTO r_GROUPTASKID, r_PlanToLoc, r_ToQty_Each
      FROM TSK_TASKLISTS
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND TaskId = r_PA_TaskID_log
      AND TaskID_Sequence = r_PA_Sequence_Log FOR UPDATE;
      IF r_PlanToLoc = '*' THEN
        SET OUT_Return_Code = '099';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF IFNULL(r_GROUPTASKID, '*') <> '*' THEN
        SET OUT_Return_Code = '277';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET r_ToQty_Each = r_ToQty_Each_Log - r_cancelledQty_Log - r_ToQty_Each;
      SET r_ToTotalCubic_Log = r_ToTotalCubic_Log * (r_ToQty_Each / r_ToQty_Each_Log);
      SET r_ToTotalGrossWeight_Log = r_ToTotalGrossWeight_Log * (r_ToQty_Each / r_ToQty_Each_Log);
      SET r_ToTotalNetWeight_Log = r_ToTotalNetWeight_Log * (r_ToQty_Each / r_ToQty_Each_Log);
      SET r_ToTotalPrice_Log = r_ToTotalPrice_Log * (r_ToQty_Each / r_ToQty_Each_Log);
      SET r_ToQty_Each_Log = r_ToQty_Each;

      IF r_ToQty_Each_Log <= 0 THEN
        SET OUT_Return_Code = '213';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    ELSE
      SET r_ToQty_Each_Log = r_ToQty_Each_Log - r_cancelledQty_Log;
    END IF;

    IF r_DocType_Log = 'ASN' THEN
      SET r_ASNNO = r_DocNo_Log;
      SET r_ASNLineNO = r_DocLineNo_Log;
      SET r_PONO = '*';
      SET r_POLineNO = 0;
      SELECT
        ASNType,
        ASNStatus INTO r_ASNType, r_ASNStatus
      FROM DOC_ASN_HEADER
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND ASNNO = r_ASNNO;
    ELSEIF r_DocType_Log = 'PO' THEN
      SET r_ASNNO = '*';
      SET r_ASNLineNO = 0;
      SET r_PONO := r_DocNo_Log;
      SET r_POLineNO := r_DocLineNo_Log;
      SELECT
        poType,
        poStatus INTO r_ASNType, r_ASNStatus
      FROM DOC_PO_HEADER
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND PONO = r_PONO;
    END IF;


    SET r_SN_CTL = getsys_configuration(IN_organizationId, IN_Warehouse, r_TOCustomerID_Log, r_ASNType, 'SN#_CTL');

    SET r_RCV_CCL_CHK = getsys_configuration(IN_organizationId, IN_Warehouse, r_TOCustomerID_Log, r_ASNType, 'RCV_CCL_CHK');
    IF r_RCV_CCL_CHK = 'N'
      AND r_ASNStatus >= '90' THEN
      SET OUT_Return_Code = '201';
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;

    BEGIN
      SELECT
        COUNT(1),
        MAX(t.inventoryholdid) INTO r_nrow, r_inventoryholdid
      FROM ACT_INVENTORYHOLD t
      WHERE t.`organizationId` = IN_organizationId
      AND t.`warehouseId` = IN_Warehouse
      AND t.`lotNum` = r_ToLotNum_Log
      AND t.`locationId` = r_ToLocation_Log
      AND t.`traceId` = r_ToID_Log
      AND t.`holdBy` = '5'
      AND t.`holdFlag` = 'Y';
      IF r_nrow <> 0 THEN
        SET OUT_Return_Code = '*_*';
        CALL SPINV_Hold_Release(IN_organizationId, IN_Warehouse, 'CancelHold', '5', '*', 0, r_inventoryholdid
        , r_ToLotNum_Log, r_TOSku_Log, r_ToCustomerID_Log, r_FMID_Log, r_FMLocation_Log, '', '', '', 0, '', 0
        , IN_Language, IN_UserID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
      END IF;
    END;

    BEGIN

      IF IFNULL(r_PA_TaskID_Log, '*') <> '*'
        AND IFNULL(r_PlanToLoc, '*') <> '*' THEN
        UPDATE INV_LOT_LOC_ID
        SET QTYPA = QTYPA - r_ToQty_Each_Log
        WHERE `organizationId` = IN_organizationId
        AND `warehouseId` = IN_Warehouse
        AND LotNum = r_ToLotNum_Log
        AND LocationID = r_PlanToLoc
        AND TraceID = r_ToID_Log;
        IF ROW_COUNT() <> 1 THEN
          SET OUT_Return_Code = '214';
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
      END IF;


      SET r_QtyInv = 0;
      SELECT
        a.`qty` INTO r_QtyInv
      FROM INV_LOT a
      WHERE a.`organizationId` = IN_organizationId
      AND a.`warehouseId` = IN_Warehouse
      AND a.`lotNum` = r_ToLotNum_Log FOR UPDATE;
      IF r_QtyInv < r_ToQty_Each_Log THEN
        SET OUT_Return_Code = '214';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      UPDATE INV_LOT a
      SET a.Qty = Qty - r_ToQty_Each_Log,
          Cubic = Cubic - r_ToTotalCubic_Log,
          GrossWeight = GrossWeight - r_ToTotalGrossWeight_Log,
          NetWeight = NetWeight - r_ToTotalNetWeight_Log,
          Price = Price - r_ToTotalPrice_Log,
          EditTime = r_CurrentTime,
          EditWho = IN_UserID
      WHERE a.`organizationId` = IN_organizationId
      AND a.`warehouseId` = IN_Warehouse
      AND a.`lotNum` = r_ToLotNum_Log;

      SET r_QtyInv = 0;
      SET r_QtyMVOut = 0;
      SELECT
        a.`qty` - a.`qtyAllocated` - a.`qtyRpOut`,
        a.`qtyMvOut` INTO r_QtyInv, r_QtyMVOut
      FROM INV_LOT_LOC_ID a
      WHERE a.`organizationId` = IN_organizationId
      AND a.`warehouseId` = IN_Warehouse
      AND a.`lotNum` = r_ToLotNum_Log
      AND a.`locationId` = r_ToLocation_Log
      AND a.`traceId` = r_ToID_Log FOR UPDATE;
      IF r_QtyInv < r_ToQty_Each_Log THEN
        SET OUT_Return_Code = '214';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF IFNULL(r_PA_TaskID_Log, '*') <> '*' THEN
        IF r_QtyMVOut < r_ToQty_Each_Log THEN
          SET OUT_Return_Code = '214';
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
        SET r_QtyMVOut = r_ToQty_Each_Log;
      ELSE
        SET r_QtyMVOut = 0;
      END IF;

      UPDATE INV_LOT_LOC_ID a
      SET a.Qty = Qty - r_ToQty_Each_Log,
          Cubic = Cubic - r_ToTotalCubic_Log,
          GrossWeight = GrossWeight - r_ToTotalGrossWeight_Log,
          NetWeight = NetWeight - r_ToTotalNetWeight_Log,
          Price = Price - r_ToTotalPrice_Log,
          EditTime = r_CurrentTime,
          EditWho = IN_UserID,
          Qtymvout = Qtymvout - r_QtyMVOut
      WHERE a.`organizationId` = IN_organizationId
      AND a.`warehouseId` = IN_Warehouse
      AND a.`lotNum` = r_ToLotNum_Log
      AND a.`locationId` = r_ToLocation_Log
      AND a.`traceId` = r_ToID_Log;
    END;

    IF IFNULL(r_PA_TaskID_Log, '*') <> '*' THEN
    BEGIN
      DELETE
        FROM TSK_TASKLISTS
      WHERE `organizationId` = IN_organizationId
        AND `warehouseId` = IN_Warehouse
        AND TaskId = r_PA_TaskID_log
        AND TaskID_Sequence = r_PA_Sequence_Log
        AND taskprocess = '00';
      IF FOUND_ROWS() <> 1 THEN
        SET OUT_Return_Code = '099';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;
    END IF;

    BEGIN
      UPDATE ACT_TRANSACTION_LOG
      SET STATUS = CASE WHEN fmQty_Each = CancelledQty + r_ToQty_Each_Log THEN '90' ELSE '99' END,
          CancelledQty = CancelledQty + r_ToQty_Each_Log,
          reasoncode = IN_ReasonCode,
          reason = IN_Reason,
          EditTime = r_CurrentTime,
          EditWho = IN_UserID
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND TransactionID = IN_TransactionID;
    END;

    IF r_SN_CTL IN ('1', '2') THEN
    BEGIN
      UPDATE DOC_ASN_SERIALNO
      SET StockFlag = 'N',
          Lotnum = NULL,
          TransactionID = NULL
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND `asnNo` = r_ASNNO
      AND TransactionID = IN_TransactionID;
      IF r_SN_CTL = '2' THEN
        UPDATE DOC_ASN_SUBSERIALNO
        SET StockFlag = 'N',
            Lotnum = NULL,
            TransactionID = NULL
        WHERE `organizationId` = IN_organizationId
        AND `warehouseId` = IN_Warehouse
        AND `asnNo` = r_ASNNO
        AND TransactionID = IN_TransactionID;
        UPDATE DOC_ASN_SERIALNO
        SET StockFlag = 'N',
            Lotnum = NULL,
            TransactionID = NULL
        WHERE Sku = 'MIXSKU'
        AND EXISTS (SELECT
            1
          FROM DOC_ASN_SUBSERIALNO
          WHERE SerialNO = DOC_ASN_SERIALNO.SerialNO
          AND TransactionID = IN_TransactionID)
        AND NOT EXISTS (SELECT
            1
          FROM DOC_ASN_SUBSERIALNO b
          WHERE DOC_ASN_SerialNo.serialno = b.serialno
          AND StockFlag = 'Y');
      ELSE
        SELECT
          SKU INTO r_SKU
        FROM DOC_ASN_SERIALNO
        WHERE SerialNo = r_ToID_Log
        AND ASNNo = r_DocNo_Log
        AND stockFlag = 'Y';

        IF r_SKU = 'MIXSKU' THEN
          SELECT
            COUNT(*) INTO r_nRow
          FROM ACT_TRANSACTION_LOG
          WHERE DOCNO = r_DocNo_Log
          AND toID = r_ToID_Log
          AND STATUS = '99'
          AND Transactiontype = 'IN';
          IF r_nRow = 0 THEN
            UPDATE DOC_ASN_SERIALNO
            SET StockFlag = 'N'
            WHERE SerialNo = r_ToID_Log
            AND ASNNo = r_DocNo_Log
            AND stockFlag = 'Y';
          END IF;
        END IF;
      END IF;
    END;
    END IF;

    IF r_FMID_Log <> '*' THEN
    BEGIN
      SET r_ReceivedQty_each_ASN = 0;
      SET r_UOM = '*';
      SET r_PackID = '*';
      SELECT
        ReceivedQty_each,
        packUOM,
        PackID INTO r_ReceivedQty_each_ASN, r_UOM, r_PackID
      FROM DOC_TRACE_DETAILS
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND ASNNO = r_ASNNO
      AND ASNLineNO = r_ASNLineNO
      AND TraceID = r_FMID_Log FOR UPDATE;
      IF r_ReceivedQty_each_ASN = 0
        OR r_UOM = '*' THEN
        SET oUT_Return_Code = '888DOC_Trace_Details,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_ReceivedQty_each_ASN < r_ToQty_Each_Log THEN
        SET OUT_Return_Code = '214';
        ROLLBACK;
        LEAVE ENDPROC;
      ELSEIF r_ReceivedQty_each_ASN = r_ToQty_Each_Log THEN
        SET r_LineStatus = '10';
      ELSE
        SET r_LineStatus = '30';
      END IF;

      SET r_UOMQty = 0;
      SELECT
        a.qty INTO r_UOMQty
      FROM BAS_PACKAGE_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.customerId = r_TOCustomerID_Log
      AND a.PackID = r_PackID
      AND packUom = r_UOM;

      IF r_UOMQty <= 0 THEN
        SET OUT_Return_Code = '114';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET r_ToQty_Log = r_ToQty_Each_Log / r_UOMQty;

      UPDATE DOC_TRACE_DETAILS
      SET Linestatus = r_LineStatus,
          ReceivedQty_Each = ReceivedQty_Each - r_ToQty_Each_Log,
          ReceivedQty = ReceivedQty - r_ToQty_Log,
          RejectedQty_Each = 0,
          RejectedQty = 0,
          Reserve_Flag = 'N',
          ReceivedTime = NULL,
          EditTime = r_CurrentTime,
          EditWho = IN_UserID
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND ASNNO = r_ASNNO
      AND ASNLineNO = r_ASNLineNO
      AND TraceID = r_FMID_Log;
    END;
    END IF;

    IF r_ASNNO <> '*'
      AND r_ASNLineNO > 0 THEN
    BEGIN
      SET r_ExpectedQty_Each_ASN = 0;
      SET r_ReceivedQty_Each_ASN = 0;
      SET r_UOM = '*';
      SET r_PackID = '*';

      SELECT
        PackID,
        packUOM,
        ExpectedQty_Each,
        ReceivedQty_Each,
        PONo,
        POLineNo INTO r_PackID, r_UOM
      , r_ExpectedQty_Each_ASN, r_ReceivedQty_Each_ASN
      , r_PONO, r_POLineNO
      FROM DOC_ASN_DETAILS
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND ASNNO = r_ASNNO
      AND ASNLineNO = r_ASNLineNO FOR UPDATE;
      IF r_ReceivedQty_each_ASN = 0
        OR r_UOM = '*' THEN
        SET oUT_Return_Code = '888DOC_ASN_Details,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;


      IF r_ReceivedQty_each_ASN < r_ToQty_Each_Log THEN
        SET OUT_Return_Code = '214';
        ROLLBACK;
        LEAVE ENDPROC;
      ELSEIF r_ExpectedQty_Each_ASN <= r_ReceivedQty_Each_ASN - r_ToQty_Each_Log THEN
        SET r_LineStatus = '40';
      ELSEIF r_ReceivedQty_each_ASN = r_ToQty_Each_Log THEN
        IF r_FMID_Log <> '*' THEN
          SET r_LineStatus = '10';
        ELSE
          SET r_LineStatus = '00';
        END IF;
      ELSE
        SET r_LineStatus = '30';
      END IF;

      SET r_UOMQty = 0;
      SELECT
        a.qty INTO r_UOMQty
      FROM BAS_PACKAGE_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.customerId = r_TOCustomerID_Log
      AND a.PackID = r_PackID
      AND packUom = r_UOM;

      IF r_UOMQty <= 0 THEN
        SET OUT_Return_Code = '114';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      SET r_ToQty_Log = r_ToQty_Each_Log / r_UOMQty;

      UPDATE DOC_ASN_DETAILS
      SET ReceivedQty = ReceivedQty - r_ToQty_Log,
          ReceivedQty_Each = ReceivedQty_Each - r_ToQty_Each_Log,
          LineStatus = r_LineStatus,
          ReceivedTime = CASE WHEN r_LineStatus <= '20' THEN NULL ELSE ReceivedTime END,
          Reserve_Flag = 'N',
          EditTime = r_CurrentTime,
          EditWho = IN_UserID
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND ASNNO = r_ASNNO
      AND ASNLineNO = r_ASNLineNO;

      SELECT
        MAX(a.LineStatus),
        MIN(a.LineStatus) INTO r_MaxLineStatus, r_MinLineStatus
      FROM DOC_ASN_DETAILS a
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND ASNNO = r_ASNNO
      AND LineStatus <> '90';
      IF r_MaxLineStatus = r_MinLineStatus THEN
        SET r_ASNStatus = r_MinLineStatus;
      ELSEIF r_MaxLineStatus >= '30' THEN
        SET r_ASNStatus = '30';
      ELSEIF r_MaxLineStatus >= '10' THEN
        SET r_ASNStatus = '10';
      END IF;

      UPDATE DOC_ASN_HEADER
      SET ASNStatus = r_ASNStatus,
          Reserve_Flag = 'N',
          EditTime = r_CurrentTime,
          EditWho = IN_UserID
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND ASNNO = r_ASNNO;
    END;
    END IF;

    IF r_PONO <> '*'
      AND r_POLineNO > 0 THEN
    BEGIN
      SET r_ExpectedQty_Each_ASN = 0;
      SET r_ReceivedQty_Each_ASN = 0;
      SET r_UOM = '*';
      SET r_PackID = '*';

      SELECT
        PackID,
        packUOM,
        OrderedQty_Each,
        ReceivedQty_Each INTO r_PackID, r_UOM
      , r_ExpectedQty_Each_ASN, r_ReceivedQty_Each_ASN
      FROM DOC_PO_DETAILS
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND PONO = r_PONO
      AND POLineNO = r_POLineNO FOR UPDATE;
      IF r_ReceivedQty_each_ASN = 0
        OR r_UOM = '*' THEN
        SET oUT_Return_Code = '888DOC_PO_Details,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_ReceivedQty_each_ASN < r_ToQty_Each_Log
        OR r_ExpectedQty_Each_ASN < r_ToQty_Each_Log THEN
        SET OUT_Return_Code = '214';
        ROLLBACK;
        LEAVE ENDPROC;
      ELSEIF r_ReceivedQty_each_ASN = r_ToQty_Each_Log THEN
        IF r_FMID_Log <> '*' THEN
          SET r_LineStatus = '10';
        ELSE
          SET r_LineStatus = '00';
        END IF;
      ELSE
        SET r_LineStatus = '30';
      END IF;

      SET r_UOMQty = 0;
      SELECT
        a.qty INTO r_UOMQty
      FROM BAS_PACKAGE_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.customerId = r_TOCustomerID_Log
      AND a.PackID = r_PackID
      AND packUom = r_UOM;

      IF r_UOMQty <= 0 THEN
        SET OUT_Return_Code = '114';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      SET r_ToQty_Log = r_ToQty_Each_Log / r_UOMQty;

      UPDATE DOC_PO_DETAILS
      SET ReceivedQty = ReceivedQty - r_ToQty_Log,
          ReceivedQty_Each = ReceivedQty_Each - r_ToQty_Each_Log,
          poLineStatus = r_LineStatus,
          ReceivedTime = CASE WHEN r_LineStatus <= '20' THEN NULL ELSE ReceivedTime END,
          EditTime = r_CurrentTime,
          EditWho = IN_UserID
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND PONO = r_PONO
      AND POLineNO = r_POLineNO;

      SELECT
        MAX(a.poLineStatus),
        MIN(a.poLineStatus) INTO r_MaxLineStatus, r_MinLineStatus
      FROM DOC_PO_DETAILS a
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND PONO = r_PONO
      AND poLineStatus <> '90';
      IF r_MaxLineStatus = r_MinLineStatus THEN
        SET r_ASNStatus = r_MinLineStatus;
      ELSEIF r_MaxLineStatus >= '30' THEN
        SET r_ASNStatus = '30';
      ELSEIF r_MaxLineStatus >= '10' THEN
        SET r_ASNStatus = '10';
      END IF;

      UPDATE DOC_PO_HEADER
      SET poStatus = r_ASNStatus,
          EditTime = r_CurrentTime,
          EditWho = IN_UserID
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND PONO = r_PONO;
    END;
    END IF;

    BEGIN
      SET r_qcno = '*';
      SET r_qclineno = 0;
      SET r_ReceivedQty_each_ASN = 0;
      SELECT
        qcno,
        qclineno,
        Asnqty_Expected,
        linestatus INTO r_qcno, r_qclineno, r_ReceivedQty_each_ASN, r_linestatus
      FROM DOC_QC_DETAILS
      WHERE `organizationId` = IN_organizationId
      AND `warehouseId` = IN_Warehouse
      AND TRANSACTIONID = IN_TransactionID;
      IF r_qcno <> '*' THEN
        IF r_ReceivedQty_each_ASN < r_ToQty_Each_Log THEN
          SET OUT_Return_Code = '214';
          ROLLBACK;
          LEAVE ENDPROC;
        ELSEIF r_ReceivedQty_each_ASN = r_ToQty_Each_Log THEN
          SET r_linestatus = '00';
        END IF;
        UPDATE DOC_QC_DETAILS
        SET linestatus = r_linestatus,
            Asnqty_Expected = Asnqty_Expected - r_ToQty_Each_Log
        WHERE `organizationId` = IN_organizationId
        AND `warehouseId` = IN_Warehouse
        AND `qcNo` = r_qcno
        AND `qcLineNo` = r_qclineno;

        IF r_linestatus = '00' THEN
          SELECT
            IFNULL(MAX(b.linestatus), '00'),
            IFNULL(MIN(b.linestatus), '00') INTO r_MaxLineStatus, r_MinLineStatus
          FROM DOC_QC_DETAILS b
          WHERE `organizationId` = IN_organizationId
          AND `warehouseId` = IN_Warehouse
          AND `qcNo` = r_qcno
          AND `lineStatus` <> '90';

          IF r_MinLineStatus = r_MaxLineStatus THEN
            SET r_ASNStatus = r_MaxLineStatus;
          ELSEIF r_MinLineStatus < '20' THEN
            SET r_ASNStatus = '10';
          ELSE
            SET r_ASNStatus = '20';
          END IF;

          UPDATE DOC_QC_HEADER
          SET QCStatus = r_ASNStatus
          WHERE `organizationId` = IN_organizationId
          AND `warehouseId` = IN_Warehouse
          AND `qcNo` = r_qcno;


          DELETE
            FROM ACT_QC_TRANSACTION
          WHERE `organizationId` = IN_organizationId
            AND `warehouseId` = IN_Warehouse
            AND `qcNo` = r_qcno
            AND `qcLineNo` = r_qclineno;
        END IF;
      END IF;

      IF r_QC_Flag_Log = 'D' THEN
        DELETE
          FROM ACT_QC_TRANSACTION
        WHERE `organizationId` = IN_organizationId
          AND `warehouseId` = IN_Warehouse
          AND `qcTransactionId` = IN_TransactionID;
      END IF;
    END;


    SET Out_Return_Code = '*_*';
    CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'CRC_AFTER', IN_TransactionID, NULL, NULL, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;

    SET OUT_Return_Code = '000';
    IF r_Tran_Ctl = 'Y' THEN
      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `SPSO_ModifyLineStatus`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_ModifyLineStatus (IN IN_organizationId varchar(20),
IN IN_WarehouseID varchar(20),
IN IN_Process_Action_C varchar(30),
IN IN_Process_By_C varchar(30),
IN IN_WaveNO varchar(20),
IN IN_OrderNO_C varchar(20),
IN IN_OrderLineNO_C varchar(20),
IN IN_SoftAllocationDetailsID varchar(20),
IN IN_Language varchar(2),
IN IN_UserID varchar(35),
INOUT OUT_Return_Code varchar(200))
ENDPROC:
  BEGIN

    DECLARE r_OrderNO_A varchar(40);
    DECLARE r_OrderLineNO_A int;
    DECLARE r_QtyOrdered_Each_A decimal(18, 8);
    DECLARE r_QtySoftAllocated_Each_A decimal(18, 8);
    DECLARE r_QtyAllocated_Each_A decimal(18, 8);
    DECLARE r_QtyPicked_Each_A decimal(18, 8);
    DECLARE r_QtyShipped_Each_A decimal(18, 8);
    DECLARE r_PackID_A varchar(40);
    DECLARE r_UOM_A varchar(10);
    DECLARE r_LineStatus_A varchar(2);
    DECLARE r_MaxLineStatus varchar(2);
    DECLARE r_MinLineStatus varchar(2);
    DECLARE r_WaveStatus varchar(2);
    DECLARE r_NO_COMMIT varchar(1);
    DECLARE r_nRow int;
    DECLARE done int DEFAULT FALSE;
    DECLARE c_DOC_ORDER_DETAILS CURSOR FOR
    SELECT
      a.OrderNo,
      a.OrderLineNO,
      a.PackID,
      a.packUOM,
      a.QtyOrdered_Each,
      a.QtySoftAllocated_Each,
      a.QtyAllocated_Each,
      a.QtyPicked_Each,
      a.QtyShipped_Each,
      a.LINESTATUS
    FROM DOC_ORDER_DETAILS a
      LEFT JOIN DOC_WAVE_DETAILS b
        ON a.organizationId = b.organizationId
        AND a.Warehouseid = b.Warehouseid
        AND a.OrderNo = b.OrderNo
    WHERE a.organizationId = IN_organizationId
    AND a.Warehouseid = IN_WarehouseID
    AND a.Linestatus < '90'
    AND UPPER(IN_Process_By_C) = UPPER('By WaveNO')
    AND b.waveNo = IFNULL(IN_WaveNO, '*')
    UNION
    SELECT
      a.OrderNo,
      a.OrderLineNO,
      a.PackID,
      a.packUOM,
      a.QtyOrdered_Each,
      a.QtySoftAllocated_Each,
      a.QtyAllocated_Each,
      a.QtyPicked_Each,
      a.QtyShipped_Each,
      a.LINESTATUS
    FROM DOC_ORDER_DETAILS a
    WHERE a.organizationId = IN_organizationId
    AND a.Warehouseid = IN_WarehouseID
    AND a.Linestatus < '90'
    AND UPPER(IN_Process_By_C) = UPPER('By OrderNO')
    AND a.OrderNo = IN_OrderNO_C
    UNION
    SELECT
      a.OrderNo,
      a.OrderLineNO,
      a.PackID,
      a.packUOM,
      a.QtyOrdered_Each,
      a.QtySoftAllocated_Each,
      a.QtyAllocated_Each,
      a.QtyPicked_Each,
      a.QtyShipped_Each,
      a.LINESTATUS
    FROM DOC_ORDER_DETAILS a
    WHERE a.organizationId = IN_organizationId
    AND a.Warehouseid = IN_WarehouseID
    AND a.Linestatus < '90'
    AND UPPER(IN_Process_By_C) = UPPER('By OrderNO + OrderLineNO')
    AND a.OrderNo = IN_OrderNO_C
    AND a.OrderLineNo = IN_OrderLineNO_C;

    DECLARE c_DOC_ORDER CURSOR FOR
    SELECT
      a.OrderNo,
      MAX(a.LineStatus) AS MaxLineStatus,
      MIN(a.LineStatus) AS MinLineStatus
    FROM DOC_ORDER_DETAILS a
      LEFT JOIN DOC_WAVE_DETAILS b
        ON a.organizationId = b.organizationId
        AND a.Warehouseid = b.Warehouseid
        AND a.OrderNo = b.OrderNo
    WHERE a.organizationId = IN_organizationId
    AND a.Warehouseid = IN_WarehouseID
    AND a.Linestatus < '90'
    AND UPPER(IN_Process_By_C) = UPPER('By WaveNO')
    AND b.waveNo = IN_WaveNO
    GROUP BY a.OrderNo
    UNION ALL
    SELECT
      a.OrderNo,
      MAX(a.LineStatus) AS MaxLineStatus,
      MIN(a.LineStatus) AS MinLineStatus
    FROM DOC_ORDER_DETAILS a
    WHERE a.organizationId = IN_organizationId
    AND a.Warehouseid = IN_WarehouseID
    AND a.Linestatus < '90'
    AND UPPER(IN_Process_By_C) = UPPER('By OrderNO')
    AND a.OrderNo = IN_OrderNO_C
    GROUP BY a.OrderNo
    UNION
    SELECT
      a.OrderNo,
      MAX(a.LineStatus) AS MaxLineStatus,
      MIN(a.LineStatus) AS MinLineStatus
    FROM DOC_ORDER_DETAILS a
    WHERE a.organizationId = IN_organizationId
    AND a.Warehouseid = IN_WarehouseID
    AND a.Linestatus < '90'
    AND UPPER(IN_Process_By_C) = UPPER('By OrderNO + OrderLineNO')
    AND a.OrderNo = IN_OrderNO_C

    GROUP BY a.OrderNo;


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_ModifyLineStatus,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;

    IF Out_return_Code = 'NO_COMMIT'
      OR Out_return_Code = '*_*'
      OR Out_Return_Code = '*_**_*' THEN
      SET r_NO_COMMIT := 'N';
    ELSE
      SET r_NO_COMMIT := 'Y';
    END IF;
    IF UPPER(IN_Process_By_C) = UPPER('By AllocationDetailsID') THEN
      SET IN_Process_By_C := 'By OrderNO + OrderLineNO';
    END IF;
    IF UPPER(IN_Process_By_C) = UPPER('By SoftAllocationDetailsID') THEN
      SET IN_Process_By_C := 'By OrderNO + OrderLineNO';
    END IF;
    IF UPPER(IN_Process_By_C) <> UPPER('By WaveNO')
      AND UPPER(IN_Process_By_C) <> UPPER('By OrderNO')
      AND UPPER(IN_Process_By_C) <> UPPER('By OrderNO + OrderLineNO') THEN
      SET OUT_Return_Code := '887SPSO_ModifyLineStatus';
      LEAVE endProc;
    END IF;
    OPEN c_DOC_ORDER_DETAILS;
  Loop_t:
    LOOP
      FETCH c_DOC_ORDER_DETAILS INTO r_OrderNO_A, r_OrderLineNO_A, r_PackID_A, r_UOM_A, r_QtyOrdered_Each_A,
      r_QtySoftAllocated_Each_A, r_QtyAllocated_Each_A, r_QtyPicked_Each_A, r_QtyShipped_Each_A, r_LineStatus_A;
      IF done THEN
        LEAVE Loop_t;
      END IF;
      IF r_QtyShipped_Each_A > 0
        AND r_QtyShipped_Each_A >= r_QtyOrdered_Each_A THEN
        SET r_LineStatus_A := '80';
      ELSEIF r_QtyShipped_Each_A > 0
        AND r_QtyShipped_Each_A < r_QtyOrdered_Each_A THEN
        SET r_LineStatus_A := '70';
      ELSEIF r_QtyPicked_Each_A > 0
        AND r_QtyPicked_Each_A >= r_QtyOrdered_Each_A THEN
        SET r_LineStatus_A := '60';
      ELSEIF r_QtyPicked_Each_A > 0
        AND r_QtyPicked_Each_A < r_QtyOrdered_Each_A THEN
        SET r_LineStatus_A := '50';
      ELSEIF r_QtyAllocated_Each_A > 0
        AND r_QtyAllocated_Each_A >= r_QtyOrdered_Each_A THEN
        SET r_LineStatus_A := '40';
      ELSEIF r_QtyAllocated_Each_A > 0
        AND r_QtyAllocated_Each_A < r_QtyOrdered_Each_A THEN
        SET r_LineStatus_A := '30';
      ELSEIF r_QtySoftAllocated_Each_A > 0
        AND r_QtySoftAllocated_Each_A >= r_QtyOrdered_Each_A THEN
        SET r_LineStatus_A := '20';
      ELSEIF r_QtySoftAllocated_Each_A > 0
        AND r_QtySoftAllocated_Each_A < r_QtyOrdered_Each_A THEN
        SET r_LineStatus_A := '10';
      ELSE
        SET r_LineStatus_A := '00';
      END IF;

      UPDATE DOC_ORDER_DETAILS
      SET LineStatus = r_LineStatus_A
      WHERE organizationId = IN_organizationId
      AND Warehouseid = IN_WarehouseID
      AND OrderNO = r_OrderNO_A
      AND OrderLineNO = r_OrderLineNO_A;

    END LOOP;
    CLOSE c_DOC_ORDER_DETAILS;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;

    SET done = FALSE;
    OPEN c_DOC_ORDER;
  Loop_DOC_ORDER:
    LOOP
      FETCH c_DOC_ORDER INTO r_OrderNO_A, r_MaxLineStatus, r_MinLineStatus;
      SET r_LineStatus_A := '00';
      IF done THEN
        LEAVE Loop_DOC_ORDER;
      END IF;
      IF r_MaxLineStatus = r_MinLineStatus THEN
        SET r_LineStatus_A := r_MaxLineStatus;
      ELSEIF r_MaxLineStatus >= '70' THEN
        SET r_LineStatus_A := '70';
      ELSEIF r_MaxLineStatus >= '50' THEN
        SET r_LineStatus_A := '50';
      ELSEIF r_MaxLineStatus >= '30' THEN
        SET r_LineStatus_A := '30';
      ELSEIF r_MaxLineStatus >= '10' THEN
        SET r_LineStatus_A := '10';
      END IF;

      IF r_MaxLineStatus < '70'
        AND r_MaxLineStatus >= '30' THEN
        SELECT
          COUNT(*)
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_organizationId
        AND Warehouseid = IN_WarehouseID
        AND OrderNO = r_OrderNO_A
        AND IFNULL(Checkwho, '') = '' INTO r_nRow;

        SELECT
          COUNT(*) + r_nRow
        FROM DOC_ORDER_DETAILS
        WHERE organizationId = IN_organizationId
        AND Warehouseid = IN_WarehouseID
        AND OrderNO = r_OrderNO_A
        AND qtyordered_each > qtyallocated_each INTO r_nRow;

        IF r_nRow = 0 THEN
          SET r_LineStatus_A := '63';
        ELSE
          SELECT
            COUNT(*)
          FROM ACT_ALLOCATION_DETAILS
          WHERE organizationId = IN_organizationId
          AND Warehouseid = IN_WarehouseID
          AND OrderNO = r_OrderNO_A
          AND (IFNULL(Checkwho, '') <> ''
          OR packflag = 'Y'
          AND status >= '60') INTO r_nRow;

          IF r_nRow <> 0 THEN
            SET r_LineStatus_A := '62';
          END IF;
        END IF;
      END IF;
      UPDATE DOC_ORDER_HEADER
      SET SoStatus = r_LineStatus_A,
          EditTime = NOW(),
          EditWho = IN_UserID
      WHERE organizationId = IN_organizationId
      AND Warehouseid = IN_WarehouseID
      AND OrderNO = r_OrderNO_A
      AND SoStatus < '90';
      IF r_LineStatus_A > '40' THEN
        SET OUT_Return_Code := '*_*';

      END IF;
    END LOOP;
    CLOSE c_DOC_ORDER;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code := '000';
  END
  $$

--
-- Create procedure `SPSO_Unpicking_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_Unpicking_Process (IN IN_organizationId varchar(30),
IN IN_Warehouse varchar(30),
IN IN_AllocationDetailsID varchar(30),
IN IN_Language varchar(30),
IN IN_UserID varchar(30),
INOUT OUT_Return_Code varchar(2000))
ENDPROC:
  BEGIN

    DECLARE r_CurrentTime date;
    DECLARE r_nRow int;
    DECLARE r_Tran_Ctl char(1) DEFAULT 'Y';
    DECLARE r_CHK_UPK_CTL char(1);


    DECLARE r_Taskid varchar(30);
    DECLARE r_TaskId_Sequence int;
    DECLARE r_OrderNo varchar(30);
    DECLARE r_OrderLineNO varchar(30);
    DECLARE r_CustomerID varchar(30);
    DECLARE r_SKU varchar(30);
    DECLARE r_LotNUM varchar(30);
    DECLARE r_Location varchar(30);
    DECLARE r_TraceID varchar(30);
    DECLARE r_PickToLocation varchar(30);
    DECLARE r_PickToTraceID varchar(30);
    DECLARE r_Qtypicked_Each decimal(18, 8);
    DECLARE r_Cubic decimal(18, 8);
    DECLARE r_GrossWeight decimal(18, 8);
    DECLARE r_NetWeight decimal(18, 8);
    DECLARE r_Price decimal(18, 8);
    DECLARE r_PackID varchar(30);
    DECLARE r_UOM varchar(30);
    DECLARE r_Status varchar(30);
    DECLARE r_PACKFLAG varchar(30);
    DECLARE r_TransactionID varchar(30);

    DECLARE r_QtyOrdered_Each_Order decimal(18, 8);
    DECLARE r_QtyPicked_Order decimal(18, 8);
    DECLARE r_QtyPicked_Each_Order decimal(18, 8);
    DECLARE r_LineStatus varchar(30);
    DECLARE r_UOM_Order varchar(30);
    DECLARE r_PackID_Order varchar(30);

    DECLARE r_UOMQty_Order decimal(18, 8);
    DECLARE r_QTY1_P decimal(18, 8);
    DECLARE r_QTY2_P decimal(18, 8);
    DECLARE r_QTY3_P decimal(18, 8);
    DECLARE r_QTY4_P decimal(18, 8);
    DECLARE r_QTY5_P decimal(18, 8);
    DECLARE r_CartonizeUOM char(1);

    DECLARE r_Qty_Inv decimal(18, 8);
    DECLARE r_Qtyallocated_Inv decimal(18, 8);
    DECLARE r_LPN varchar(30);
    DECLARE r_InLocTime date;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_Unpicking_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;

    BEGIN
      IF Out_Return_Code = '*_*' THEN
        SET r_Tran_Ctl = 'N';
      END IF;
      SET Out_Return_Code = '000';
      SET r_CurrentTime = SYSDATE();

      IF r_Tran_Ctl = 'Y' THEN
        START TRANSACTION;
      END IF;
    END;

    BEGIN
      SET OUT_Return_Code = '*_*';
      CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'UNPICK_BEFORE', IN_AllocationDetailsID, NULL, NULL, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      SELECT
        a.Orderno,
        a.Orderlineno,
        a.Status,
        a.Customerid,
        a.Sku,
        a.Qtypicked_Each,
        a.Lotnum,
        a.Location,
        a.Traceid,
        IFNULL(a.Picktolocation, 'STAGE'),
        IFNULL(a.picktotraceid, '*'),
        a.Packflag,
        a.Packid,
        a.Uom,
        a.Netweight,
        a.Grossweight,
        a.Cubic,
        a.Price,
        a.PickingTransactionID
      FROM ACT_ALLOCATION_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseId = IN_Warehouse
      AND a.allocationdetailsid = IN_AllocationDetailsID INTO r_OrderNo, r_OrderLineNo, r_Status
      , r_CustomerID, r_SKU, r_QtyPicked_Each
      , r_LotNUM, r_Location, r_TraceID, r_PickToLocation, r_PickToTraceID
      , r_PACKFLAG, r_PackID, r_UOM
      , r_NetWeight, r_GrossWeight, r_Cubic, r_Price
      , r_TransactionID
      FOR UPDATE;

      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = CONCAT('406', IN_AllocationDetailsID);
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_OrderNo LIKE '#%#' THEN
        SET OUT_Return_Code = CONCAT('437', r_PickToLocation, r_Location);
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      IF IFNULL(r_QtyPicked_Each, 0) = 0
        OR r_Status <> '60' THEN
        SET OUT_Return_Code = '415';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_PACKFLAG = 'Y' THEN

        SET r_CHK_UPK_CTL = getsys_configuration(IN_organizationId, IN_Warehouse, r_CustomerID, '*', 'CHK_UPK_CTL');

        SET r_CartonizeUOM = 'N';
        SELECT
          a.cartonizeFlag INTO r_CartonizeUOM
        FROM BAS_PACKAGE_DETAILS a
        WHERE a.organizationId = IN_organizationId
        AND a.customerId = r_CustomerID
        AND a.PackID = r_PackID
        AND packUom = r_UOM;

        IF r_CHK_UPK_CTL = 'N' THEN
          IF r_CartonizeUOM = 'N' THEN
            SET OUT_Return_Code = '419';
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
        ELSE
          IF r_CartonizeUOM = 'N' THEN
            SET r_PACKFLAG = 'N';
          END IF;
        END IF;
      END IF;
    END;

    BEGIN
      UPDATE ACT_ALLOCATION_DETAILS
      SET QtyPicked_Each = 0,
          STATUS = '40',
          PickedWho = NULL,
          PickedTime = NULL,
          CheckWho = NULL,
          checkTime = NULL,
          PackFlag = r_PackFlag,
          editTime = r_CurrentTime,
          editwho = IN_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND AllocationDetailsID = IN_AllocationDetailsID;
      IF ROW_COUNT() <> 1 THEN
        SET OUT_Return_Code = '888ACT_Allocation_Details,Update';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      SELECT
        QtyOrdered_Each,
        QtyPicked,
        QtyPicked_Each,
        LineStatus,
        packUOM,
        PackID INTO r_QtyOrdered_Each_Order, r_QtyPicked_Order, r_QtyPicked_Each_Order, r_LineStatus, r_UOM_Order, r_PackID_Order
      FROM DOC_ORDER_DETAILS
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND OrderNO = r_OrderNo
      AND OrderLineNO = r_OrderLineNo FOR UPDATE;
      IF FOUND_ROWS() <> 1 THEN
        SET OUT_Return_Code = '888DOC_Order_Details,Open';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_LineStatus >= '80' THEN
        SET OUT_Return_Code = '401';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET r_QtyPicked_Each_Order = r_QtyPicked_Each_Order - r_Qtypicked_Each;
      IF r_QtyPicked_Each_Order < 0 THEN
        SET OUT_Return_Code = '448';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET r_UOMQty_Order = 0;
      SELECT
        a.qty INTO r_UOMQty_Order
      FROM BAS_PACKAGE_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.customerId = r_CustomerID
      AND a.PackID = r_PackID_Order
      AND packUom = r_UOM_Order;

      IF r_UOMQty_Order <= 0 THEN
        SET OUT_Return_Code = '110';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      UPDATE DOC_ORDER_DETAILS
      SET QtyPicked_Each = r_QtyPicked_Each_Order,
          QtyPicked = r_QtyPicked_Each_Order / r_UOMQty_Order,
          editTime = r_CurrentTime,
          editwho = IN_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND OrderNO = r_OrderNo
      AND OrderLineNO = r_OrderLineNo;
      IF ROW_COUNT() = 0 THEN
        SET OUT_Return_Code = '888DOC_Order_Details,Update';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET OUT_Return_Code = '*_*';
      CALL SPSO_ModifyLineStatus(IN_organizationId, IN_Warehouse, 'CREATELST', 'By OrderNO + OrderLineNO', NULL, r_OrderNo, r_OrderLineNo, NULL, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      UPDATE ACT_TRANSACTION_LOG
      SET STATUS = '90',
          editTime = r_CurrentTime,
          editwho = IN_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND TransactionID = r_TransactionID;
      IF ROW_COUNT() = 0 THEN
        SET OUT_Return_Code = '888ACT_Transaction_Log,Update';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      SELECT
        taskid,
        taskid_sequence INTO r_TaskId, r_TaskId_Sequence
      FROM TSK_TASKLISTS
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND AllocationDetailsID = IN_AllocationDetailsID FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '099';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      UPDATE TSK_TASKLISTS
      SET TaskProcess = '00',
          Completed_TransactionID = NULL,
          CloseTime = NULL,
          CloseWho = NULL,
          editTime = r_CurrentTime,
          editwho = IN_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND taskid = r_TaskId
      AND taskId_Sequence = r_TaskId_Sequence;
      IF ROW_COUNT() = 0 THEN
        SET OUT_Return_Code = '888Tsk_TaskLists,Update';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      IF (r_TraceID <> r_PickToTraceID)
        OR (r_Location <> r_PickToLocation) THEN

        SELECT
          a.qty,
          a.qtyallocated INTO r_Qty_Inv, r_Qtyallocated_Inv
        FROM INV_LOT_LOC_ID a
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseId = IN_Warehouse
        AND a.LocationID = r_PickToLocation
        AND a.LotNUM = r_LotNUM
        AND a.TraceID = r_PickToTraceID FOR UPDATE;
        IF FOUND_ROWS() = 0 THEN
          SET r_Qty_Inv = 0;
          SET r_Qtyallocated_Inv = 0;
        END IF;

        IF r_Qtypicked_Each > r_Qty_Inv
          OR r_Qtypicked_Each > r_Qtyallocated_Inv THEN
          SET OUT_Return_Code = '888INV_LOT_LOC_ID,Update';
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;

        UPDATE INV_LOT_LOC_ID
        SET Qty = Qty - r_Qtypicked_Each,
            QtyAllocated = QtyAllocated - r_Qtypicked_Each,
            NetWeight = Netweight - r_NetWeight,
            GrossWeight = Grossweight - r_GrossWeight,
            Cubic = Cubic - r_Cubic,
            Price = Price - r_Price,
            editTime = r_CurrentTime,
            editwho = IN_UserID
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_Warehouse
        AND LotNUM = r_LotNUM
        AND LocationID = r_PickToLocation
        AND TraceID = r_PickToTraceID;


        SET r_nRow = 0;
        SELECT
          1 INTO r_nRow
        FROM INV_LOT_LOC_ID a
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseId = IN_Warehouse
        AND a.LocationID = r_Location
        AND a.LotNUM = r_LotNUM
        AND a.TraceID = r_TraceID FOR UPDATE;

        IF r_nRow <= 0 THEN
          INSERT INTO INV_LOT_LOC_ID (LocationID, LotNum, TraceID, CustomerID, SKU, Qty, QtyAllocated
          , QtyRPIN, QtyRPOUT, QTYMVIN, QtyMVOUT, QtyOnHold
          , NetWeight, GrossWeight, Cubic, Price
          , `organizationId`, `warehouseId`
          , ADDTIME, AddWho, EditTime, EditWho)
            VALUES (r_Location, r_LotNUM, r_TraceID, r_CustomerID, r_SKU, r_Qtypicked_Each, r_Qtypicked_Each, 0, 0, 0, 0, 0, r_NetWeight, r_GrossWeight, r_Cubic, r_Price, IN_organizationId, IN_Warehouse, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID);

        ELSE
          UPDATE INV_LOT_LOC_ID
          SET Qty = QTy + r_Qtypicked_Each,
              QtyAllocated = QtyAllocated + r_Qtypicked_Each,
              NetWeight = Netweight + r_NetWeight,
              GrossWeight = Grossweight + r_GrossWeight,
              Cubic = Cubic + r_Cubic,
              Price = Price + r_Price,
              EditTime = r_CurrentTime,
              EditWho = IN_UserID
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_Warehouse
          AND LotNUM = r_LotNUM
          AND LocationID = r_Location
          AND TraceID = r_TraceID;
        END IF;
      END IF;
    END;

    BEGIN
      SET OUT_Return_Code = '*_*';
      CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'UNPICK_AFTER', IN_AllocationDetailsID, NULL, NULL, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      SET OUT_Return_Code = '000';
      IF r_Tran_Ctl = 'Y' THEN
        COMMIT;
      END IF;
    END;
  END
  $$

--
-- Create procedure `SPSO_Picking_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_Picking_Process (IN IN_organizationId varchar(30),
IN IN_Warehouse varchar(30),
IN IN_Action varchar(30),
IN IN_AllocationDetailsID varchar(30),
IN In_ModuleID varchar(30),
IN In_WorkStation varchar(30),
IN IN_Language varchar(30),
IN IN_UserID varchar(30),
INOUT OUT_Return_Code varchar(2000))
ENDPROC:
  BEGIN
    DECLARE r_Tran_Ctl char(1) DEFAULT 'Y';
    DECLARE r_CurrentTime date;
    DECLARE r_nRow int;
    DECLARE r_IDX_CVY char(1);
    DECLARE r_CHK_CAS_PAS char(1);
    DECLARE r_MIX_PCK_TID char(1);
    DECLARE r_TransactionID varchar(30);
    DECLARE r_Status varchar(30);
    DECLARE r_OrderNo varchar(30);
    DECLARE r_OrderLineNo int;
    DECLARE r_Taskid varchar(30);
    DECLARE r_TaskId_Sequence int;
    DECLARE r_CustomerID varchar(30);
    DECLARE r_SKU varchar(30);
    DECLARE r_Qty_Each decimal(18, 8);
    DECLARE r_Qty decimal(18, 8);
    DECLARE r_Qtypicked_Each decimal(18, 8);
    DECLARE r_Uom varchar(30);
    DECLARE r_Packid varchar(30);
    DECLARE r_Location varchar(30);
    DECLARE r_LotNUM varchar(30);
    DECLARE r_TraceID varchar(30);
    DECLARE r_PickToLocation varchar(30);
    DECLARE r_PickToTraceID varchar(30);
    DECLARE r_PickedTime timestamp;
    DECLARE r_pickedWho varchar(30);
    DECLARE r_CheckWho varchar(30);
    DECLARE r_CheckTime timestamp;
    DECLARE r_Cubic decimal(18, 8);
    DECLARE r_GrossWeight decimal(18, 8);
    DECLARE r_Netweight decimal(18, 8);
    DECLARE r_Price decimal(18, 8);
    DECLARE r_LPN varchar(30);
    DECLARE r_QtyOrdered_Each_Order decimal(18, 8);
    DECLARE r_QtyPicked_Order decimal(18, 8);
    DECLARE r_QtyPicked_Each_Order decimal(18, 8);
    DECLARE r_LineStatus varchar(30);
    DECLARE r_UOM_Order varchar(30);
    DECLARE r_PackID_Order varchar(30);
    DECLARE r_UOMQty_Order decimal(18, 8);
    DECLARE r_QTY1_P decimal(18, 8);
    DECLARE r_QTY2_P decimal(18, 8);
    DECLARE r_QTY3_P decimal(18, 8);
    DECLARE r_QTY4_P decimal(18, 8);
    DECLARE r_QTY5_P decimal(18, 8);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_Erpcancelflag varchar(30);
    DECLARE r_ReleaseStatus varchar(30);
    DECLARE r_LocationAttribute varchar(30);
    DECLARE r_Qty_Inv decimal(18, 8);
    DECLARE r_Qtyallocated_Inv decimal(18, 8);
    DECLARE r_Action varchar(30);
    DECLARE r_TRN_TYP varchar(100);
    DECLARE r_Edisendflag char(1);

    DECLARE done int DEFAULT FALSE;


    DECLARE cur CURSOR FOR
    SELECT
      d.OrderNo,
      d.OrderLineNo
    FROM DOC_ORDER_DETAILS d
      INNER JOIN DOC_WAVE_DETAILS w
        ON w.organizationId = d.organizationId
        AND w.warehouseId = d.warehouseId
        AND w.orderno = d.orderno
    WHERE w.organizationId = IN_organizationId
    AND w.warehouseId = IN_Warehouse
    AND w.WaveNo = REPLACE(r_OrderNo, '#', '')
    AND d.CustomerID = r_CustomerID
    AND d.SKU = r_SKU;


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_Picking_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;
    BEGIN
      IF OUT_Return_Code = 'NO_COMMIT'
        OR OUT_Return_Code = '*_*' THEN
        SET r_Tran_Ctl = 'N';
      END IF;
      SET OUT_Return_Code = '000';
      SET r_CurrentTime = NOW();
      IF IN_Action = 'WAVE' THEN
        SET r_Action = 'PK';
      ELSE
        SET r_Action = IN_Action;
      END IF;

      IF r_Tran_Ctl = 'Y' THEN
        START TRANSACTION;
      END IF;
    END;
    BEGIN
      SET Out_Return_Code = '*_*';
      CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'PICK_BEFORE', r_Action, IN_AllocationDetailsID, NULL, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;
    BEGIN
      SELECT
        a.Orderno,
        a.Orderlineno,
        a.Status,
        a.Customerid,
        a.Sku,
        a.Qty_Each,
        a.Qty,
        IFNULL(a.Qtypicked_Each, 0),
        a.Lotnum,
        a.Location,
        a.Traceid,
        IFNULL(a.Picktolocation, 'STAGE'),
        IFNULL(a.picktotraceid, '*'),
        IFNULL(a.Pickedtime, r_CurrentTime),
        IFNULL(a.Pickedwho, IN_UserID),
        a.Checkwho,
        a.Checktime,
        UOM
      FROM ACT_ALLOCATION_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseId = IN_Warehouse
      AND a.allocationdetailsid = IN_AllocationDetailsID INTO r_OrderNo, r_OrderLineNo, r_Status
      , r_CustomerID, r_SKU, r_Qty_Each, r_Qty, r_Qtypicked_Each
      , r_LotNUM, r_Location, r_TraceID, r_PickToLocation, r_PickToTraceID
      , r_PickedTime, r_PickedWho, r_CheckWho, r_CheckTime, r_UOM
      FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '888ACT_Allocation_Details,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;


      IF r_Status <> '40'
        AND r_Action = 'PK'
        OR r_Status = '80' THEN
        SET OUT_Return_Code = '435';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;



      SELECT
        h.ReleaseStatus,
        h.WarehouseID,
        h.erpcancelflag INTO r_ReleaseStatus, r_WarehouseID, r_Erpcancelflag
      FROM DOC_ORDER_HEADER h
      WHERE h.organizationId = IN_organizationId
      AND h.warehouseId = IN_Warehouse
      AND h.orderno = r_OrderNo;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '888DOC_Order_Header,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_Erpcancelflag = 'Y'
        AND IN_Action <> 'WAVE'
        AND In_ModuleID NOT LIKE '%_PUTTOLIGHT'
        AND In_ModuleID <> 'TIMER_PICKTOLIGHT'
        AND In_ModuleID <> 'REVERSEPICK' THEN
        SET OUT_Return_Code = '432';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      IF r_ReleaseStatus = 'H' THEN
        SET OUT_Return_Code = '407';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SELECT
        LocationAttribute INTO r_LocationAttribute
      FROM BAS_LOCATION
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND LocationID = r_Location;

      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '888BAS_Location,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_LocationAttribute = 'HD' THEN
        SET OUT_Return_Code = CONCAT('441', r_Location);
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;



      SET r_MIX_PCK_TID = getsys_configuration(IN_organizationId, IN_Warehouse, r_CustomerID, '*', 'MIX_PCK_TID');

      IF r_MIX_PCK_TID = 'N'
        AND r_PickToTraceID <> '*' THEN
        SELECT
          COUNT(*) INTO r_nRow
        FROM ACT_ALLOCATION_DETAILS a
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseId = IN_Warehouse
        AND a.PicktoTraceID = r_PickToTraceID
        AND a.OrderNo <> r_OrderNo
        AND a.Status <= '60';
        IF r_nRow > 0 THEN
          SET OUT_Return_Code = '423';
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
      END IF;

      SELECT
        a.qtyallocated,
        a.qty,
        a.lpn,
        a.NetWeight * r_Qty_Each / a.Qty,
        a.GrossWeight * r_Qty_Each / a.Qty,
        a.Cubic * r_Qty_Each / a.Qty,
        a.Price * r_Qty_Each / a.Qty INTO r_Qtyallocated_Inv, r_Qty_Inv, r_LPN
      , r_NetWeight, r_GrossWeight, r_Cubic, r_Price
      FROM INV_LOT_LOC_ID a
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseId = IN_Warehouse
      AND a.LocationID = r_Location
      AND a.LotNUM = r_LotNUM
      AND a.TraceID = r_TraceID FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET r_Qtyallocated_Inv = 0;
        SET r_Qty_Inv = 0;
      END IF;

      IF r_Qtyallocated_Inv < r_Qty_Each
        OR r_Qty_Inv < r_Qty_Each THEN
        SET OUT_Return_Code = CONCAT('315', r_LotNUM, '/', r_Location, '/', r_TraceID);
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;
    IF (r_TraceID <> r_PickToTraceID)
      OR (r_Location <> r_PickToLocation) THEN
    BEGIN
      UPDATE INV_LOT_LOC_ID
      SET Qty = Qty - r_Qty_Each,
          QtyAllocated = QtyAllocated - r_Qty_Each,
          NetWeight = Netweight - r_NetWeight,
          GrossWeight = Grossweight - r_GrossWeight,
          Cubic = Cubic - r_Cubic,
          Price = Price - r_Price,
          editTime = r_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND LocationID = r_Location
      AND LotNUM = r_LotNUM
      AND TraceID = r_TraceID;

      SET r_nRow = 0;
      SELECT
        1 INTO r_nRow
      FROM INV_LOT_LOC_ID a
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseId = IN_Warehouse
      AND a.LocationID = r_PickToLocation
      AND a.LotNUM = r_LotNUM
      AND a.TraceID = r_PickToTraceID FOR UPDATE;
      IF r_nRow <= 0 THEN
        INSERT INTO INV_LOT_LOC_ID (LocationID, LotNum, TraceID, CustomerID, SKU, Qty, QtyAllocated
        , QtyRPIN, QtyRPOUT, QTYMVIN, QtyMVOUT, QtyOnHold
        , NetWeight, GrossWeight, Cubic, Price
        , `organizationId`, `warehouseId`
        , ADDTIME, AddWho, EditTime, EditWho, lpn)
          VALUES (r_PickToLocation, r_LotNUM, r_PickToTraceID, r_CustomerID, r_SKU, r_Qty_Each, r_Qty_Each, 0, 0, 0, 0, 0, r_NetWeight, r_GrossWeight, r_Cubic, r_Price, IN_organizationId, IN_Warehouse, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_LPN);
      ELSE
        UPDATE INV_LOT_LOC_ID
        SET Qty = QTy + r_Qty_Each,
            QtyAllocated = QtyAllocated + r_Qty_Each,
            NetWeight = Netweight + r_NetWeight,
            GrossWeight = Grossweight + r_GrossWeight,
            Cubic = Cubic + r_Cubic,
            Price = Price + r_Price,
            EditTime = r_CurrentTime,
            EditWho = IN_UserID
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_Warehouse
        AND LocationID = r_PickToLocation
        AND LotNUM = r_LotNUM
        AND TraceID = r_PickToTraceID;
      END IF;
    END;
    END IF;
    BEGIN
      SET OUT_Return_Code = '*_*';
      CALL SPCOM_GetIDSequence(IN_organizationId, IN_Warehouse, IN_Language, 'TransactionID', r_TransactionID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET r_TRN_TYP = getsys_configuration(IN_organizationId, IN_Warehouse, r_CustomerID, '*', 'TRN_TYP');
      IF INSTR(r_TRN_TYP, r_Action) > 0 THEN
        SET r_Edisendflag = 'N';
      ELSE
        SET r_Edisendflag = 'O';
      END IF;
      INSERT INTO ACT_TRANSACTION_LOG (TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
      , organizationId
      , TransactionType
      , DocNo, DocLineNo, DocType
      , FMCustomerID, FMSKU
      , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
      , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
      , STATUS
      , WarehouseID
      , fmlpn, tolpn
      , TOCustomerID, TOSku
      , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
      , ADDTIME, AddWho, EditTime, EditWho
      , TransactionTime
      , Edisendflag
      , Operator)
        VALUES (r_TransactionID, NULL, NULL, NULL, NULL, NULL, NULL, IN_organizationId, r_Action, r_OrderNo, r_OrderLineNo, 'SO', r_CustomerID, r_Sku, r_LotNum, r_Location, r_TraceID, r_PackID, r_UOM, r_Qty, r_Qty_Each, r_LotNum, r_PickToLocation, r_PickToTraceID, r_PackID, r_UOM, r_Qty, r_Qty_Each, '99', r_WarehouseID, r_LPN, r_LPN, r_CustomerID, r_Sku, r_Cubic, r_GrossWeight, r_NetWeight, r_Price, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_PickedTime, r_Edisendflag, IN_UserID);
    END;
    BEGIN
      SELECT
        taskid,
        taskid_sequence INTO r_TaskId, r_TaskId_Sequence
      FROM TSK_TASKLISTS
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND AllocationDetailsID = IN_AllocationDetailsID FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '099';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      UPDATE TSK_TASKLISTS
      SET TaskProcess = '99',
          Completed_TransactionID = r_TransactionID,
          CloseTime = r_CurrentTime,
          CloseWho = IN_UserID,
          editTime = r_CurrentTime,
          editwho = IN_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND taskid = r_TaskId
      AND taskId_Sequence = r_TaskId_Sequence;
    END;
    BEGIN

      SET r_CHK_CAS_PAS = getsys_configuration(IN_organizationId, IN_Warehouse, '*', '*', 'CHK_CAS_PAS');
      IF r_CHK_CAS_PAS = 'Y'
        AND r_UOM IN ('CS', 'PL') THEN
        SET r_CheckWho = IN_UserID;
        SET r_CheckTime = r_CurrentTime;
      END IF;

      UPDATE ACT_ALLOCATION_DETAILS
      SET QtyPicked_Each = r_Qty_Each,
          STATUS = '60',
          PickToTraceID = r_PickToTraceID,
          PickToLocation = r_PickToLocation,
          PickedTime = r_PickedTime,
          PickedWho = r_pickedWho,
          ReasonCode = reasonCode,
          CheckTime = r_CheckTime,
          CheckWho = r_CheckWho,
          PickingTransactionID = r_TransactionID,
          editTime = r_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND AllocationDetailsID = IN_AllocationDetailsID;
    END;
    BEGIN
      SELECT
        QtyOrdered_Each,
        QtyPicked,
        QtyPicked_Each,
        LineStatus,
        packUOM,
        PackID INTO r_QtyOrdered_Each_Order, r_QtyPicked_Order, r_QtyPicked_Each_Order, r_LineStatus, r_UOM_Order, r_PackID_Order
      FROM DOC_ORDER_DETAILS
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND OrderNO = r_OrderNo
      AND OrderLineNO = r_OrderLineNo FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '888DOC_ORDER_DETAILS,Open';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_LineStatus >= '80' THEN
        SET OUT_Return_Code = '411';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF r_Status = '40' THEN
        SET r_QtyPicked_Each_Order = r_QtyPicked_Each_Order + r_Qty_Each;
      END IF;

      IF r_QtyPicked_Each_Order > r_QtyOrdered_Each_Order THEN
        SET OUT_Return_Code = CONCAT('440', r_QtyPicked_Each_Order, r_QtyOrdered_Each_Order, r_Qty_Each);
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET r_UOMQty_Order = 0;
      SELECT
        a.qty INTO r_UOMQty_Order
      FROM BAS_PACKAGE_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.customerId = r_CustomerID
      AND a.PackID = r_PackID_Order
      AND packUom = r_UOM_Order;

      IF r_UOMQty_Order <= 0 THEN
        SET OUT_Return_Code = '110';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;


      UPDATE DOC_ORDER_DETAILS
      SET LineStatus = r_LineStatus,
          QtyPicked_Each = r_QtyPicked_Each_Order,
          QtyPicked = r_QtyPicked_Each_Order / r_UOMQty_Order,
          editTime = r_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND OrderNO = r_OrderNo
      AND OrderLineNO = r_OrderLineNo;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '888DOC_ORDER_DETAILS,Update';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;


      SET OUT_Return_Code = '*_*';
      CALL SPSO_ModifyLineStatus(IN_organizationId, IN_Warehouse, 'CREATELST', 'By OrderNO + OrderLineNO', NULL, r_OrderNo, r_OrderLineNo, NULL, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;
    BEGIN
      SET r_IDX_CVY = getsys_configuration(IN_organizationId, IN_Warehouse, '*', '*', 'IDX_CVY');
      IF r_Uom = 'CS'
        AND r_IDX_CVY = 'Y' THEN
        DELETE
          FROM IDX_CONVEYOR
        WHERE TraceID = r_PickToTraceID;
        INSERT INTO IDX_CONVEYOR (TraceID, DropLOC, Opentime, CloseTime)
          SELECT
            r_PickToTraceID,
            PickZone,
            r_CurrentTime,
            NULL
          FROM BAS_LOCATION
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_Warehouse
          AND LocationID = r_PickToLocation;
      END IF;
    END;
    IF r_OrderNo LIKE '#%#'
      AND r_PickToLocation LIKE 'BPZ_%' THEN
    BEGIN
      UPDATE INV_LOT
      SET QtyAllocated = QtyAllocated - R_Qty_Each,
          QtyPreAllocated = QtyPreAllocated - R_Qty_Each
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND LotNUM = r_LotNUM;
      UPDATE INV_LOT_LOC_ID
      SET QtyAllocated = QtyAllocated - r_Qty_Each
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND LocationID = r_PickToLocation
      AND LotNUM = r_LotNUM
      AND TraceID = r_PickToTraceID;
      UPDATE DOC_ORDER_DETAILS
      SET LineStatus = '99'
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND OrderNo = r_OrderNo
      AND OrderLineNo = r_OrderLineNo
      AND LineStatus = '60';

      SELECT
        COUNT(1) INTO r_nrow
      FROM DOC_ORDER_DETAILS
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND orderno = r_OrderNo
      AND LineStatus <> '99';
      IF r_nrow = 0 THEN
        UPDATE DOC_ORDER_HEADER T
        SET SOStatus = '99'
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_Warehouse
        AND OrderNo = r_OrderNo;
      END IF;

      UPDATE ACT_ALLOCATION_DETAILS
      SET STATUS = '99'
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND AllocationDetailsID = IN_AllocationDetailsID;




      OPEN cur;

    my_loop:
      LOOP

        FETCH cur INTO r_OrderNo, r_OrderLineno;

        IF done THEN
          LEAVE my_loop;
        END IF;

        SET OUT_Return_Code = '*_*';
        CALL SPSO_HardAllocation_Process(IN_organizationId, IN_Warehouse, 'Allocation', 'By OrderNO + OrderLineNO', '*', r_OrderNo, r_OrderLineno, IN_Language, IN_UserID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
          CLOSE cur;
          LEAVE ENDPROC;
        END IF;
      END LOOP;

      CLOSE cur;
    END;
    END IF;
    BEGIN
      SET OUT_Return_Code = '*_*';
      CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'PICK_AFTER', r_Action, IN_AllocationDetailsID, NULL, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;
    SET OUT_Return_Code = '000';
    IF r_Tran_Ctl = 'Y' THEN
      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `SPSO_InsertPicking`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_InsertPicking (IN IN_organizationId varchar(20),
IN IN_WarehouseID varchar(20),
IN IN_WaveNo_C varchar(30),
IN IN_OrderNo_C varchar(30),
IN IN_OrderLineNo_C varchar(20),
IN IN_CustomerID_C varchar(20),
IN IN_SKU_C varchar(60),
IN IN_LotNUM_C varchar(20),
IN IN_LocationID_C varchar(60),
IN IN_TraceID_C varchar(40),
IN IN_Qty_C varchar(40),
IN IN_UOM_C varchar(40),
IN IN_PackID_C varchar(40),
IN IN_TOLocationID_C varchar(40),
IN IN_TOTraceID_C varchar(40),
IN IN_PickTime_C varchar(40),
IN IN_PickWho_C varchar(40),
IN IN_ShipTime_C varchar(40),
IN IN_ShipWho_C varchar(40),
IN IN_Notes varchar(40),
IN IN_Language varchar(2),
IN IN_UserID varchar(35),
INOUT Out_AllocationDetailsID varchar(20),
INOUT OUT_Return_Code varchar(1000))
ENDPROC:
  BEGIN

    DECLARE R_SoftAllocationDetailsID_R varchar(30);
    DECLARE R_Qty_Each_R decimal(18, 8);
    DECLARE R_QTY1_P decimal(18, 8);
    DECLARE R_QTY2_P decimal(18, 8);
    DECLARE R_QTY3_P decimal(18, 8);
    DECLARE R_QTY4_P decimal(18, 8);
    DECLARE R_QTY5_P decimal(18, 8);
    DECLARE R_UOMQty_Read decimal(18, 8);
    DECLARE R_UOMQty_R decimal(18, 8);
    DECLARE R_QtyAllocated_Each_Order decimal(18, 8);
    DECLARE R_Status_Order varchar(2);
    DECLARE R_QtyOrdered_Each_Order decimal(18, 8);
    DECLARE R_QtySoftAllocated_Each_Order decimal(18, 8);
    DECLARE R_QTY decimal(18, 8);
    DECLARE R_QtyAllocated decimal(18, 8);
    DECLARE R_QtyRPOUT decimal(18, 8);
    DECLARE R_QtyMVOUT decimal(18, 8);
    DECLARE R_QtyRPIN decimal(18, 8);
    DECLARE r_QtyOnHold decimal(18, 8);
    DECLARE R_WaveNO varchar(30);
    DECLARE R_nRow int;
    DECLARE R_OVR_ALC varchar(1);
    DECLARE SP_SQL_r varchar(4000);
    DECLARE r_ALC_AND_PCK char(1);
    DECLARE r_OneStepAllocation char(1);
    DECLARE r_Return_Code_TMP varchar(200);
    DECLARE r_NO_COMMIT varchar(1);
    DECLARE r_AllowShipment char(1) DEFAULT 'Y';
    DECLARE r_overallocation char(1) DEFAULT 'N';
    DECLARE r_allocationrule varchar(30);
    DECLARE v_error int;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN

      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      SET OUT_Return_Code = CONCAT('999#SPSO_InsertPicking', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      ROLLBACK;
    END;
    SET r_Return_Code_TMP := Out_Return_Code;
    IF Out_return_Code = 'NO_COMMIT'
      OR Out_return_Code = '*_*'
      OR Out_Return_Code = '*_**_*' THEN
      SET r_NO_COMMIT := 'N';
    ELSE
      SET r_NO_COMMIT := 'Y';
    END IF;



    SET OUT_Return_Code := '*_*';
    CALL SPUDF_ProcessA(IN_organizationId, IN_WarehouseID, 'INSERTPICKING_BEFORE',
    IN_WaveNo_C, IN_OrderNO_C, IN_OrderLineNO_C, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE endProc;
    END IF;
    SELECT
      COUNT(*) INTO R_nRow
    FROM DOC_ORDER_HEADER
    WHERE OrderNO = IN_OrderNO_C
    AND Warehouseid = IN_WareHouseID
    AND organizationId = IN_organizationId
    AND (SOStatus = '90'
    OR SOStatus = '99');
    IF R_nRow > 0 THEN
      SET OUT_Return_Code := '403';
      LEAVE endProc;
    END IF;

    IF IN_Qty_C < 0 THEN
      SET OUT_Return_Code := '475';
      LEAVE endProc;
    END IF;

    SELECT
      COUNT(*) INTO R_nRow
    FROM DOC_ORDER_DETAILS
    WHERE OrderNO = IN_OrderNO_C
    AND OrderLineNO = IN_OrderLineNO_C
    AND Warehouseid = IN_WareHouseID
    AND organizationId = IN_organizationId
    AND (LineStatus = '90'
    OR LineStatus = '99');
    IF R_nRow > 0 THEN
      SET OUT_Return_Code := '403';
      LEAVE endProc;
    END IF;


    SET r_AllowShipment := 'Y';
    SELECT
      s.AllowShipment INTO r_AllowShipment
    FROM BAS_SKU s
    WHERE s.CustomerID = IN_CustomerID_C
    AND s.SKU = IN_SKU_C
    AND organizationId = IN_organizationId;
    IF r_AllowShipment = 'N' THEN
      SET OUT_Return_Code := CONCAT('116', IN_SKU_C);
      ROLLBACK;
      LEAVE endProc;
    END IF;

    SET v_error = 1;
    SELECT
      QTY INTO R_UOMQty_Read
    FROM BAS_PACKAGE_DETAILS
    WHERE PackID = IN_PackID_C
    AND packuom = IN_UOM_C
    AND CustomerID = IN_CustomerID_C
    AND organizationId = IN_organizationId;
    IF v_error = 0 THEN
      SET OUT_Return_Code := '888BAS_PACKAGE_DETAILS,OPEN';
      LEAVE endProc;
    END IF;
    SET R_Qty_Each_R = IN_Qty_C * R_UOMQty_Read;
    SET R_UOMQty_R = R_UOMQty_Read;



    SELECT
      Qty,
      QtyAllocated,
      QtyRPOUT,
      QtyMVOUT,
      QtyRPIN,
      QtyOnHold INTO R_QTY, R_QtyAllocated, R_QtyRPOUT, R_QtyMVOUT, R_QtyRPIN, R_QtyOnHold
    FROM INV_LOT_LOC_ID
    WHERE LotNum = IN_LotNUM_C
    AND TraceID = IN_TraceID_C
    AND LocationID = IN_LocationID_C
    AND Warehouseid = IN_WareHouseID
    AND organizationId = IN_organizationId;
    IF FOUND_ROWS() = 0 THEN
      SET OUT_Return_Code := CONCAT('348', IN_LotNUM_C, '/', IN_LocationID_C, '/', IN_TraceID_C);
      LEAVE endProc;
    END IF;
    SET r_overallocation = 'N';
    SELECT
      IFNULL(r.overallocation, 'N') INTO r_overallocation
    FROM rul_allocation_header r
      INNER JOIN DOC_ORDER_DETAILS d
        ON d.allocationrule = r.allocationRuleId
    WHERE d.OrderNO = IN_OrderNO_C
    AND d.OrderLineNO = IN_OrderLineNO_C
    AND d.Warehouseid = IN_WareHouseID
    AND d.organizationId = IN_organizationId;
    IF r_overallocation = 'Y' THEN
      SET R_QtyRPIN = R_QtyRPIN;
    ELSE
      SET R_QtyRPIN = 0;
    END IF;
    IF R_QTY - R_QtyRPOUT - R_QtyMVOUT - R_QtyAllocated - R_QtyOnHold
      + R_QtyRPIN < R_Qty_Each_R THEN
      SET R_QTY := R_QTY - R_QtyRPOUT - R_QtyMVOUT - R_QtyAllocated;
      SET OUT_Return_Code := '312';
      LEAVE endProc;
    END IF;
    SELECT
      QtyAllocated_Each,
      QtyOrdered_Each,
      QtySoftAllocated_Each,
      LineStatus,
      OneStepAllocation INTO R_QtyAllocated_Each_Order, R_QtyOrdered_Each_Order
    , R_QtySoftAllocated_Each_Order, R_Status_Order
    , r_OneStepAllocation
    FROM DOC_ORDER_DETAILS
    WHERE OrderNo = IN_OrderNO_C
    AND OrderLineNO = IN_OrderLineNO_C
    AND Warehouseid = IN_WareHouseID
    AND organizationId = IN_organizationId;

    IF FOUND_ROWS() = 0 THEN
      SELECT
        IN_OrderNO_C,
        IN_OrderLineNO_C,
        IN_WareHouseID,
        IN_organizationId;
      SET OUT_Return_Code := '888DOC_ORDER_DETAILS,OPEN';
      LEAVE endProc;
    END IF;
    IF R_QtySoftAllocated_Each_Order > r_QtyAllocated_Each_Order THEN
      SET out_Return_Code := '446';
      LEAVE endProc;
    END IF;




    SET R_OVR_ALC := 'N';
    SELECT
      OverPreAllocation INTO R_OVR_ALC
    FROM DOC_ORDER_DETAILS a,
         RUL_SoftAllocation_Header b
    WHERE a.SoftAllocationRule = b.SoftAllocationID
    AND a.OrderNo = IN_OrderNO_C
    AND a.OrderLineNO = IN_OrderLineNO_C
    AND a.organizationId = b.organizationId
    AND a.Warehouseid = IN_WareHouseID
    AND a.organizationId = IN_organizationId;
    IF R_QtyAllocated_Each_Order + R_Qty_Each_R > R_QtyOrdered_Each_Order
      AND R_OVR_ALC = 'N' THEN
      SET OUT_Return_Code := '410';
      LEAVE endProc;
    END IF;
    IF r_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;



    SET R_SoftAllocationDetailsID_R := '*';

    SET r_WaveNO := IN_WaveNo_C;
    SELECT DISTINCT
      WaveNO INTO r_WaveNO
    FROM DOC_Wave_Details
    WHERE OrderNO = IN_OrderNO_C
    AND Warehouseid = IN_WareHouseID
    AND organizationId = IN_organizationId;

    IF r_OneStepAllocation = 'Y' THEN
      SET OUT_Return_Code := '*_**_*';
    ELSE
      SET OUT_Return_Code := 'NO_COMMIT';
    END IF;
    CALL SPSO_HardAllocation_Update(IN_organizationId, IN_WarehouseID, 'SPSO_InsertPicking'
    , IN_UOM_C, R_UOMQty_R, r_WaveNO, IN_OrderNO_C, IN_OrderLineNO_C, IN_CustomerID_C, IN_SKU_C
    , IN_LotNUM_C, IN_PackID_C, R_Qty_Each_R, IN_TraceID_C, IN_LocationID_C
    , IN_TOTraceID_C
    , R_SoftAllocationDetailsID_R, IN_UOM_C
    , IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE endProc;
    ELSE
      SET Out_AllocationDetailsID := SUBSTR(OUT_Return_Code, 4, 10);
      IF Out_AllocationDetailsID IS NULL THEN
        SET Out_AllocationDetailsID := ' ';
      END IF;
    END IF;




    SET R_WaveNO := '*';
    SELECT DISTINCT
      IFNULL(TRIM(WaveNO), '*') INTO R_WaveNO
    FROM DOC_Wave_Details
    WHERE OrderNO = IN_OrderNO_C
    AND Warehouseid = IN_WareHouseID
    AND organizationId = IN_organizationId;

    SET r_ALC_AND_PCK = getsys_configuration(IN_organizationId, IN_WarehouseID, IN_CustomerID_C, '', 'ALC_AND_PCK');


    IF r_ALC_AND_PCK = 'Y' THEN
      SET OUT_Return_Code := '*_*';
      CALL SPSO_Picking_Process(IN_organizationId, IN_WarehouseID, 'PK', Out_AllocationDetailsID,
      '', '', IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE endProc;
      END IF;
    ELSE
      SET OUT_Return_Code := 'NO_COMMIT';
      CALL SPSO_ModifyLineStatus(IN_organizationId, IN_WarehouseID, 'Allocation', 'By OrderNO + OrderLineNO', R_WaveNO,
      IN_OrderNO_C, IN_OrderLineNO_C, '', IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE endProc;
      END IF;
    END IF;





    SET OUT_Return_Code := '*_*';
    CALL SPUDF_ProcessA(IN_organizationId, IN_WarehouseID, 'INSERTPICKING_AFTER',
    IN_WaveNo_C, IN_OrderNO_C, IN_OrderLineNO_C, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTR(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE endProc;
    END IF;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;

    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `OJV_CML_SPBCD_Sku20200709`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPBCD_Sku20200709 (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_customerId varchar(30),
IN IN_supplierId varchar(30),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_SKU varchar(50),
OUT OUT_TRACEID varchar(50),
OUT OUT_QTY varchar(50),
OUT OUT_serialNo varchar(50),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE r_location varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE r_AllocationDetailsID char(20);
    DECLARE r_PickToTraceID varchar(30);
    DECLARE r_PickToLocation varchar(60);
    DECLARE r_CurrentTime timestamp;

    DECLARE Cur_Allocation CURSOR FOR
    SELECT
      AllocationDetailsID,
      PickToTraceID,
      PickToLocation
    FROM ACT_ALLOCATION_DETAILS
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND dropid = IN_barcode
    AND STATUS = '60';

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;

      SELECT
        A.SKU INTO OUT_sku
      FROM BAS_SKU A
      WHERE A.organizationId = IN_organizationId
      AND A.CUSTOMERID = IN_customerId
      AND (A.ALTERNATE_SKU1 = IN_barcode
      OR A.SKU = IN_barcode)
      LIMIT 1;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_Sku,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;

    SET R_CurrentTime = NOW();
    SET OUT_SKU = IN_barcode;



    IF IN_operation = 'DROPID_MOVE_DROPID' THEN

      SELECT
        COUNT(1) INTO v_nrow
      FROM ACT_ALLOCATION_DETAILS A
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.dropId = IN_barcode;
      IF v_nrow = 0 THEN
        SET OUT_returnCode = 'Invalid DropID';
        LEAVE END_PROC;
      END IF;


      SELECT
        COUNT(1) INTO v_nrow
      FROM ACT_ALLOCATION_DETAILS A
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.dropId = IN_barcode
      AND A.status <> '60';
      IF v_nrow > 0 THEN
        SET OUT_returnCode = 'State error';
        LEAVE END_PROC;
      END IF;


      BEGIN
        SELECT
          A.location INTO OUT_TRACEID
        FROM ACT_ALLOCATION_DETAILS A
          LEFT JOIN BAS_LOCATION B
            ON A.organizationId = B.organizationId
            AND A.warehouseId = B.warehouseId
            AND A.location = B.locationId
        WHERE A.organizationId = IN_organizationId
        AND A.warehouseId = IN_warehouseId
        AND B.zoneId = 'DOCK'
        AND B.locationUsage = 'SS'
        AND (A.waveNo = (SELECT
            T.waveNo
          FROM ACT_ALLOCATION_DETAILS T
          WHERE T.organizationId = IN_organizationId
          AND T.warehouseId = IN_warehouseId
          AND T.dropId = IN_barcode
          AND T.STATUS < '80'
          LIMIT 0, 1)
        OR A.waveNo = '*')
        LIMIT 0, 1;


        IF v_error = 0 THEN
        BEGIN

          SET v_error = 1;
          SELECT
            A.locationId INTO OUT_TRACEID
          FROM BAS_LOCATION A
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.zoneId = 'DOCK'
          AND A.locationUsage = 'SS'
          AND NOT EXISTS (SELECT
              1
            FROM ACT_ALLOCATION_DETAILS T
            WHERE T.organizationId = IN_organizationId
            AND T.warehouseId = IN_warehouseId
            AND A.locationId = T.location
            AND T.STATUS < '80')
          ORDER BY A.pickLogicalSequence
          LIMIT 0, 1;


          IF v_error = 0 THEN
            SET OUT_returnCode := 'No available location';
            LEAVE END_PROC;
          END IF;

        END;
        END IF;
      END;
    END IF;


    IF IN_operation = 'DROPID_MOVE_CONFIRM' THEN
      OPEN Cur_Allocation;
      SET v_error = 1;
      FETCH Cur_Allocation INTO r_AllocationDetailsID, r_PickToTraceID, r_PickToLocation;
      WHILE v_error <> 0 DO
        UPDATE ACT_ALLOCATION_DETAILS
        SET TraceID = r_PickToTraceID,
            Location = r_PickToLocation,
            PickToLocation = IN_para1,
            PickedWho = IN_UserID,
            PickedTime = R_CurrentTime,
            editWho = IN_UserID,
            editTime = R_CurrentTime
        WHERE organizationId = In_organizationId
        AND Warehouseid = IN_warehouseId
        AND AllocationDetailsID = r_AllocationDetailsID;

        SET OUT_returnCode = 'NO_COMMIT';

        CALL SPSO_Picking_Process(In_organizationId, IN_warehouseId, 'MV', r_AllocationDetailsID, '', ''
        , IN_Language, IN_UserID, OUT_returnCode);
        IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
          ROLLBACK;
          CLOSE Cur_Allocation;
          LEAVE END_PROC;
        END IF;
        IF v_NO_COMMIT = 'Y' THEN
          COMMIT;
        END IF;
        SET v_error = 1;
        FETCH Cur_Allocation INTO r_AllocationDetailsID, r_PickToTraceID, r_PickToLocation;
      END WHILE;
      CLOSE Cur_Allocation;
    END IF;


    IF IN_operation = 'SERIAL_PCK' THEN
    BEGIN
      SET OUT_QTY = 1;

      SELECT
        A.sku,
        A.subSerialNo INTO OUT_SKU, OUT_serialNo
      FROM DOC_ORDER_SUBSERIALNO A
      WHERE A.organizationId = In_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.allocationDetailsId = IN_para1
      AND A.subSerialNo = IN_barcode;


      IF v_error = 0 THEN
        SET OUT_returnCode := 'Wrong SerialNo';
        LEAVE END_PROC;
      END IF;
    END;
    END IF;

    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';



  END
  $$

--
-- Create procedure `SPSO_DESoftAllocation_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_DESoftAllocation_Process (IN In_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_Process_Action_C varchar(20),

IN IN_Process_By_C varchar(20),




IN IN_WaveNO_C varchar(20),
IN IN_OrderNO_C varchar(20),
IN IN_OrderLineNO_C varchar(20),
IN IN_SoftAllocationDetailsID_C varchar(10),
IN IN_Language varchar(10),
IN IN_UserID varchar(40),
INOUT OUT_Return_Code varchar(1000))
END_PROC:
  BEGIN

    DECLARE IN_WaveNO varchar(30);
    DECLARE IN_OrderNO varchar(30);
    DECLARE IN_OrderLineNO int;
    DECLARE IN_SoftAllocationDetailsID varchar(30);
    DECLARE r_SoftAllocationDetailsID_R varchar(30);
    DECLARE r_OrderNO_R varchar(20);
    DECLARE r_OrderLineNO_R int;
    DECLARE r_CustomerID_R varchar(30);
    DECLARE r_Sku_R varchar(50);
    DECLARE r_LotNUM_R varchar(10);
    DECLARE r_Qty_R decimal(18, 8);
    DECLARE r_UOM_R varchar(10);
    DECLARE r_Qty_Each_R decimal(18, 8);
    DECLARE r_PackID_R varchar(50);
    DECLARE r_WaveNO_R varchar(20);
    DECLARE r_QTY_each_Allocation_R decimal(18, 8);
    DECLARE r_QTY_Allocation_R decimal(18, 8);
    DECLARE r_UOMQty_R decimal(18, 8);
    DECLARE r_QTY1_P decimal(18, 8);
    DECLARE r_QTY2_P decimal(18, 8);
    DECLARE r_QTY3_P decimal(18, 8);
    DECLARE r_QTY4_P decimal(18, 8);
    DECLARE r_QTY5_P decimal(18, 8);
    DECLARE r_QtySoftAllocated_Order decimal(18, 8);
    DECLARE r_QtySoftAllocated_Each_Order decimal(18, 8);
    DECLARE r_DeSoftAllocation_SKU varchar(3);
    DECLARE r_Hard_SoftFlag varchar(4);
    DECLARE v_strsql varchar(3000);
    DECLARE r_CurrentTime timestamp;
    DECLARE r_NO_COMMIT char(1);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_currentTime timestamp;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE cur_softAct CURSOR FOR
    SELECT
      SoftAllocationDetailsID,
      OrderNo,
      OrderLineNO,
      CustomerID,
      Sku,
      LotNUM,
      Qty,
      UOM,
      Qty_Each,
      PackID,
      WaveNo,
      QTY_each_Allocation,
      QTY_Allocation
    FROM TMP_DESOFTALLOCATE_DETAILS
    ORDER BY OrderNo, OrderLineNO;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_DESoftAllocation_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;
    IF OUT_Return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;
    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_currentTime = NOW();
    SET v_error = 1;
    SET IN_WaveNO = IFNULL(IN_WaveNO_C, '*');
    SET IN_OrderNO = IFNULL(IN_OrderNO_C, '*');
    SET IN_OrderLineNO = IFNULL(IN_OrderLineNO_C, 0);
    SET IN_SoftAllocationDetailsID = IFNULL(IN_SoftAllocationDetailsID_C, '*');
    IF OUT_Return_Code = '******'
      OR OUT_Return_Code = '*******' THEN
      SET R_DeSoftAllocation_SKU = 'Yes';
    ELSE
      SET R_DeSoftAllocation_SKU = 'No';
    END IF;
    IF OUT_Return_Code = '*-*' THEN
      SET R_Hard_SoftFlag = 'HARD';
    ELSE
      SET R_Hard_SoftFlag = 'SOFT';
    END IF;
    SET OUT_Return_Code = '000';
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_DESOFTALLOCATE_DETAILS (
      SoftAllocationDetailsID varchar(20),
      OrderNo varchar(20),
      OrderLineNO int(11),
      CustomerID varchar(30),
      Sku varchar(50),
      LotNUM varchar(10),
      Qty decimal(18, 8),
      UOM varchar(10),
      Qty_Each decimal(18, 8),
      PackID varchar(50),
      WaveNo varchar(20),
      QTY_each_Allocation decimal(18, 8),
      QTY_Allocation decimal(18, 8)
    );
    DELETE
      FROM TMP_DESOFTALLOCATE_DETAILS;
    IF UPPER(IN_Process_By_C) = UPPER('By WaveNO') THEN
      SET v_strsql =
      ' INSERT INTO TMP_DESOFTALLOCATE_DETAILS
      (SoftAllocationDetailsID,OrderNo,OrderLineNO
       ,CustomerID,Sku,LotNUM,Qty,UOM,Qty_Each
       ,PackID,WaveNo,QTY_each_Allocation,QTY_Allocation
      )
      Select a.SoftAllocationDetailsID,a.OrderNo,a.OrderLineNO,a.CustomerID,a.Sku,a.LotNUM,a.Qty,a.UOM,a.Qty_Each,a.PackID,a.WaveNo,a.QTY_each_Allocation,a.QTY_Allocation
        from ACT_SOFTALLOCATION_DETAILS a
       inner join DOC_ORDER_DETAILS b
          on a.organizationId = b.organizationId
         and a.warehouseId = b.warehouseId
         and a.orderNo = b.orderNo
         and a.orderLineNo = b.orderLineNo
       where a.organizationId = ?
         and a.warehouseId = ?
         and a.waveNo = ?
         and a.Qty_Each > a.QTY_each_Allocation
         and b.LineStatus<''90'' ';
      IF r_Hard_SoftFlag = 'HARD' THEN
        SET v_strsql = CONCAT(v_strsql, ' and a.Hard_SoftFlag = ''HARD'' ');
      ELSEIF r_DeSoftAllocation_SKU = 'Yes' THEN
        SET v_strsql = CONCAT(v_strsql, ' and a.LotNUM = ''*'' ');
      END IF;
    ELSEIF UPPER(IN_Process_By_C) = UPPER('By OrderNO') THEN
      SET v_strsql =
      'INSERT INTO TMP_DESOFTALLOCATE_DETAILS
      (SoftAllocationDetailsID,OrderNo,OrderLineNO
       ,CustomerID,Sku,LotNUM,Qty,UOM,Qty_Each
       ,PackID,WaveNo,QTY_each_Allocation,QTY_Allocation
      )
      Select a.SoftAllocationDetailsID,a.OrderNo,a.OrderLineNO,a.CustomerID,a.Sku,a.LotNUM,a.Qty,a.UOM,a.Qty_Each,a.PackID,a.WaveNo,a.QTY_each_Allocation,a.QTY_Allocation
        from ACT_SOFTALLOCATION_DETAILS a
       inner join DOC_ORDER_DETAILS b
          on a.organizationId = b.organizationId
         and a.warehouseId = b.warehouseId
         and a.orderNo = b.orderNo
         and a.orderLineNo = b.orderLineNo
       where a.organizationId = ?
         and a.warehouseId = ?
         and a.orderNo = ?
         and a.Qty_Each > a.QTY_each_Allocation
         and b.LineStatus<''90'' ';
      IF r_Hard_SoftFlag = 'HARD' THEN
        SET v_strsql = CONCAT(v_strsql, ' and a.Hard_SoftFlag = ''HARD'' ');
      ELSEIF r_DeSoftAllocation_SKU = 'Yes' THEN
        SET v_strsql = CONCAT(v_strsql, ' and a.LotNUM = ''*'' ');
      END IF;
    ELSEIF UPPER(IN_Process_By_C) = UPPER('By OrderNO + OrderLineNO') THEN
      SET v_strsql =
      'INSERT INTO TMP_DESOFTALLOCATE_DETAILS
      (SoftAllocationDetailsID,OrderNo,OrderLineNO
       ,CustomerID,Sku,LotNUM,Qty,UOM,Qty_Each
       ,PackID,WaveNo,QTY_each_Allocation,QTY_Allocation
      )
      Select a.SoftAllocationDetailsID,a.OrderNo,a.OrderLineNO,a.CustomerID,a.Sku,a.LotNUM,a.Qty,a.UOM,a.Qty_Each,a.PackID,a.WaveNo,a.QTY_each_Allocation,a.QTY_Allocation
        from ACT_SOFTALLOCATION_DETAILS a
       inner join DOC_ORDER_DETAILS b
          on a.organizationId = b.organizationId
         and a.warehouseId = b.warehouseId
         and a.orderNo = b.orderNo
         and a.orderLineNo = b.orderLineNo
       where a.organizationId = ?
         and a.warehouseId = ?
         and a.orderNo = ?
         and a.orderLineNo = ?
         and a.Qty_Each > a.QTY_each_Allocation
         and b.LineStatus<''90'' ';
      IF r_Hard_SoftFlag = 'HARD' THEN
        SET v_strsql = CONCAT(v_strsql, ' and a.Hard_SoftFlag = ''HARD'' ');
      ELSEIF r_DeSoftAllocation_SKU = 'Yes' THEN
        SET v_strsql = CONCAT(v_strsql, ' and a.LotNUM = ''*'' ');
      END IF;
    ELSEIF UPPER(in_Process_By_C) = UPPER('By SoftAllocationDetailsID') THEN
      SET v_strsql =
      'INSERT INTO TMP_DESOFTALLOCATE_DETAILS
      (SoftAllocationDetailsID,OrderNo,OrderLineNO
       ,CustomerID,Sku,LotNUM,Qty,UOM,Qty_Each
       ,PackID,WaveNo,QTY_each_Allocation,QTY_Allocation
      )
      Select a.SoftAllocationDetailsID,a.OrderNo,a.OrderLineNO,a.CustomerID,a.Sku,a.LotNUM,a.Qty,a.UOM,a.Qty_Each,a.PackID,a.WaveNo,a.QTY_each_Allocation,a.QTY_Allocation
        from ACT_SOFTALLOCATION_DETAILS a
       inner join DOC_ORDER_DETAILS b
          on a.organizationId = b.organizationId
         and a.warehouseId = b.warehouseId
         and a.orderNo = b.orderNo
         and a.orderLineNo = b.orderLineNo
       where a.organizationId = ?
         and a.warehouseId = ?
         and a.SoftAllocationDetailsID = ?
         and a.Qty_Each > a.QTY_each_Allocation
         and b.LineStatus < ''90'' ';
      IF r_Hard_SoftFlag = 'HARD' THEN
        SET v_strsql = CONCAT(v_strsql, ' and a.Hard_SoftFlag = ''HARD'' ');
      ELSEIF r_DeSoftAllocation_SKU = 'Yes' THEN
        SET v_strsql = CONCAT(v_strsql, ' and a.LotNUM = ''*'' ');
      END IF;
    ELSE
      SET OUT_Return_Code = '887';
      LEAVE END_PROC;
    END IF;
    SET @SQL = v_strsql;
    SET v_errormessage = @SQL;
    SET @organizationId = In_organizationId;
    SET @In_warehouse = In_warehouse;
    PREPARE STMT FROM @SQL;
    IF UPPER(IN_Process_By_C) = UPPER('By WaveNO') THEN
      SET @IN_WaveNO = IN_WaveNO;
      EXECUTE STMT USING @organizationId, @In_warehouse, @IN_WaveNO;
    ELSEIF UPPER(IN_Process_By_C) = UPPER('By OrderNO') THEN
      SET @IN_OrderNO = IN_OrderNO_C;
      EXECUTE STMT USING @organizationId, @In_warehouse, @IN_OrderNO;
    ELSEIF UPPER(IN_Process_By_C) = UPPER('By OrderNO + OrderLineNO') THEN
      SET @IN_OrderNO = IN_OrderNO_C;
      SET @IN_OrderLineNO = IN_OrderNO_C;
      EXECUTE STMT USING @organizationId, @In_warehouse, @IN_OrderNO, @IN_OrderLineNO;
    ELSEIF UPPER(in_Process_By_C) = UPPER('By SoftAllocationDetailsID') THEN
      SET @IN_SoftAllocationDetailsID = IN_SoftAllocationDetailsID_C;
      EXECUTE STMT USING @organizationId, @In_warehouse, @IN_SoftAllocationDetailsID;
    END IF;
    DEALLOCATE PREPARE STMT;

    SET v_errormessage = 'fetch cur_softAct into';
    OPEN cur_softAct;
    SET v_error = 1;
    FETCH cur_softAct
    INTO R_SoftAllocationDetailsID_R
    , R_OrderNo_R, R_OrderLineNO_R, R_CustomerID_R, R_Sku_R
    , R_LotNUM_R, R_Qty_R, R_UOM_R, R_Qty_Each_R, R_PackID_R, R_WaveNo_R
    , R_QTY_each_Allocation_R, R_QTY_Allocation_R;
    WHILE v_error <> 1 DO
      SET v_errormessage = 'from DOC_ORDER_DETAILS';
      SELECT
        QtySoftAllocated,
        QtySoftAllocated_Each,
        PackID,
        UOM
      FROM DOC_ORDER_DETAILS
      WHERE organizatioId = In_organizatioId
      AND warehouseId = In_warehouse
      AND OrderNO = r_OrderNO_R
      AND OrderLineNO = r_OrderLineNO_R INTO R_QtySoftAllocated_Order, R_QtySoftAllocated_Each_Order, R_PackID_R, R_UOM_R
      FOR UPDATE;
      SET v_errormessage = 'End from DOC_ORDER_DETAILS';
      SET v_error = 1;
      SELECT
        MAX(CASE WHEN packUom = 'EA' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'CS' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'OT' THEN qty ELSE NULL END)
      FROM BAS_PACKAGE_DETAILS
      WHERE organizationId = In_organizationId
      AND customerId = R_CustomerID_R
      AND PackID = R_PackID_r INTO R_QTY1_P, R_QTY2_P, R_QTY3_P, R_QTY4_P, R_QTY5_P;
      IF v_error = 0 THEN
        CLOSE cur_softAct;
        SET OUT_Return_Code = CONCAT('888', TRIM(R_PackID_r), 'System Package Error!');
        ROLLBACK;
        LEAVE END_PROC;
      END IF;
      IF R_UOM_r = 'EA' THEN
        SET R_UOMQty_r = R_QTY1_P;
      ELSEIF R_UOM_r = 'IP' THEN
        SET R_UOMQty_r = R_QTY2_P;
      ELSEIF R_UOM_r = 'CS' THEN
        SET R_UOMQty_r = R_QTY3_P;
      ELSEIF R_UOM_r = 'PL' THEN
        SET R_UOMQty_r = R_QTY4_P;
      ELSEIF R_UOM_r = 'OT' THEN
        SET R_UOMQty_r = R_QTY5_P;
      END IF;
      IF R_QTY_each_Allocation_R > R_Qty_Each_R THEN
        SET R_Qty_Each_R = 0;
      ELSE
        SET R_Qty_Each_R = R_Qty_Each_R - R_QTY_each_Allocation_R;
      END IF;
      SET R_QtySoftAllocated_Each_Order = (R_QtySoftAllocated_Each_Order - R_Qty_Each_R);
      IF R_QtySoftAllocated_Each_Order < 0 THEN
        SET R_QtySoftAllocated_Each_Order = 0;
      END IF;
      UPDATE DOC_ORDER_DETAILS
      SET QtySoftAllocated = (R_QtySoftAllocated_Each_Order / R_UOMQty_R),
          QtySoftAllocated_Each = R_QtySoftAllocated_Each_Order,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizatioId = In_organizatioId
      AND warehouseId = In_warehouse
      AND OrderNO = r_OrderNO_R
      AND OrderLineNO = r_OrderLineNO_R;
      IF R_LotNUM_R <> '*' THEN
        UPDATE INV_LOT
        SET QtyPreAllocated = QtyPreAllocated - R_Qty_Each_R,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizatioId = In_organizatioId
        AND LotNUm = R_LotNUM_R;
      END IF;
      IF R_QTY_each_Allocation_R <= 0 THEN
        DELETE
          FROM ACT_SOFTALLOCATION_DETAILS
        WHERE organizatioId = In_organizatioId
          AND warehouseId = In_warehouse
          AND SoftAllocationDetailsID = r_SoftAllocationDetailsID_R
          AND OrderNO = r_OrderNO_R
          AND OrderLineNO = r_OrderLineNO_R;
      ELSE
        UPDATE ACT_SOFTALLOCATION_DETAILS
        SET Qty_Each = QTY_each_Allocation,
            QTY = QTY_Allocation,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizatioId = In_organizatioId
        AND warehouseId = In_warehouse
        AND SoftAllocationDetailsID = r_SoftAllocationDetailsID_R
        AND OrderNO = r_OrderNO_R
        AND OrderLineNO = r_OrderLineNO_R;
      END IF;
      IF ROW_COUNT() = 0 THEN
        CLOSE cur_softAct;
        ROLLBACK;
        LEAVE END_PROC;
      END IF;
      SET v_error = 1;
      FETCH cur_softAct
      INTO R_SoftAllocationDetailsID_R
      , R_OrderNo_R, R_OrderLineNO_R, R_CustomerID_R, R_Sku_R
      , R_LotNUM_R, R_Qty_R, R_UOM_R, R_Qty_Each_R, R_PackID_R, R_WaveNo_R
      , R_QTY_each_Allocation_R, R_QTY_Allocation_R;
    END WHILE;
    CLOSE cur_softAct;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    IF UPPER(IN_Process_By_C) = UPPER('By SoftAllocationDetailsID') THEN
      SET IN_OrderNO = r_OrderNO_R;
      SET IN_OrderLineNO = r_OrderLineNO_R;
    END IF;
    SET OUT_Return_Code = 'NO_COMMIT';
    CALL SPSO_ModifyLineStatus(IN_Warehouse, IN_Process_Action_C, IN_Process_By_C
    , IN_WaveNO, IN_OrderNO, IN_OrderLineNO
    , IN_SoftAllocationDetailsID
    , IN_Language, IN_UserID, OUT_Return_Cod);
    IF Substrb(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE END_PROC;
    END IF;
    IF v_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `SPSO_DEAllocation_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_DEAllocation_Process (IN In_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_Process_Action_C varchar(20),

IN IN_Process_By_C varchar(30),




IN IN_WaveNO_C varchar(20),
IN IN_OrderNO_C varchar(20),
IN IN_OrderLineNO_C varchar(20),
IN IN_AllocationDetailsID varchar(20),
IN IN_Language varchar(10),
IN IN_UserID varchar(50),
INOUT OUT_Return_Code varchar(1000))
END_PROC:
  BEGIN

    DECLARE IN_WaveNO varchar(30);
    DECLARE IN_OrderNO varchar(30);
    DECLARE IN_OrderLineNO int;
    DECLARE r_AllocationDetailsID_A varchar(30);
    DECLARE r_OrderNO_A varchar(30);
    DECLARE r_OrderLineNO_A int;
    DECLARE r_CustomerID_A varchar(30);
    DECLARE r_Sku_A varchar(50);
    DECLARE r_LotNUM_A varchar(10);
    DECLARE r_UOM_A varchar(10);
    DECLARE r_Location_A varchar(60);
    DECLARE r_TraceID_A varchar(30);
    DECLARE r_Qty_A decimal(18, 8);
    DECLARE r_Qty_Each_A decimal(18, 8);
    DECLARE r_PackID_A varchar(40);
    DECLARE r_WaveNO_A varchar(30);
    DECLARE r_Status_A varchar(2);
    DECLARE r_Notes_A varchar(100);
    DECLARE r_QtyPicked_Each_A decimal(18, 8);
    DECLARE r_QtyShipped_Each_A decimal(18, 8);
    DECLARE r_SoftAllocationDetailsID_A varchar(30);
    DECLARE r_QtyDeAllocation_Each decimal(18, 8);
    DECLARE r_UOM_Soft varchar(10);
    DECLARE r_PackID_Soft varchar(40);
    DECLARE r_UOMQty_SOft decimal(18, 8);
    DECLARE r_QTY_each_Allocation_SOft decimal(18, 8);
    DECLARE r_QTY_Allocation_SOft decimal(18, 8);
    DECLARE r_UOMQty_Hard decimal(18, 8);
    DECLARE r_QTY_each_Allocation_Hard decimal(18, 8);
    DECLARE r_QTY_Allocation_Hard decimal(18, 8);
    DECLARE r_picktotraceid_A varchar(30);
    DECLARE r_picktotraceid_Tmp varchar(30);
    DECLARE r_UOMQty_Read decimal(18, 8);
    DECLARE r_QTY1_P decimal(18, 8);
    DECLARE r_QTY2_P decimal(18, 8);
    DECLARE r_QTY3_P decimal(18, 8);
    DECLARE r_QTY4_P decimal(18, 8);
    DECLARE r_QTY5_P decimal(18, 8);
    DECLARE r_QtyAllocated_Order decimal(18, 8);
    DECLARE r_QtyAllocated_Each_Order decimal(18, 8);
    DECLARE r_PackID_R varchar(40);
    DECLARE r_UOM_R varchar(10);
    DECLARE r_PickToLocation_A varchar(60);
    DECLARE r_Cubic_A decimal(18, 8);
    DECLARE r_QTYDeSoft decimal(18, 8);
    DECLARE r_QTYDeSoft_each decimal(18, 8);
    DECLARE r_Parameter2 varchar(200);
    DECLARE r_Parameter4 varchar(200);
    DECLARE r_SQL varchar(3000);
    DECLARE r_RequiredeliveryNo varchar(30);
    DECLARE r_CustomerID varchar(30);
    DECLARE r_OrderType varchar(20);
    DECLARE r_erpcancelflag char(1);
    DECLARE r_CarrierID varchar(30);
    DECLARE r_DEL_DOC_SN varchar(30);
    DECLARE r_LineStatus varchar(30);
    DECLARE r_CCL_ALC_LOG char(1);
    DECLARE r_qtysoftallocated decimal(18, 8);
    DECLARE r_qtysoftallocated_each decimal(18, 8);
    DECLARE r_Trans_Control char(1);
    DECLARE r_CurrentTime timestamp;
    DECLARE r_CustomerID_tmp varchar(30);
    DECLARE r_OrderType_tmp varchar(20);
    DECLARE r_CarrierID_tmp varchar(30);
    DECLARE r_OrderNO_tmp varchar(30);
    DECLARE v_nRow1 int;
    DECLARE r_taskids varchar(3000);
    DECLARE r_SRT_LOC char(1);
    DECLARE r_keepDeliveryNo char(1);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_currentTime timestamp;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE IN_Process_By varchar(40);
    DECLARE cCur_Act CURSOR FOR
    SELECT
      AllocationDetailsID,
      OrderNo,
      OrderLineNO,
      CustomerID,
      Sku,
      LotNUM,
      UOM,
      Location,
      TraceID,
      Qty,
      Qty_Each,
      PackID,
      WaveNo,
      STATUS,
      Notes,
      QtyPicked_Each,
      QtyShipped_Each,
      SoftAllocationDetailsID,
      PickToLocation,
      Cubic,
      picktotraceid,
      RequiredeliveryNo,
      CustomerID2,
      OrderType,
      erpcancelflag,
      CarrierID
    FROM TMP_DEALLOCATE_DETAILS
    ORDER BY OrderNo, OrderLineNO;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_DEAllocation_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;
    IF OUT_Return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;
    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_currentTime = NOW();
    SET v_error = 1;
    SET IN_Process_By = IN_Process_By_C;

    SET r_SRT_LOC = getsys_configuration(In_organizationId, IN_Warehouse, '*', '*', 'SRT_LOC');
    SET IN_WaveNO = IN_WaveNO_C;
    SET IN_OrderNO = IN_OrderNO_C;
    SET IN_OrderLineNO = IN_OrderLineNO_C;

    SET r_Parameter2 = CASE UPPER(IN_Process_By_C) WHEN UPPER('By WaveNO') THEN IN_WaveNO_C WHEN UPPER('By OrderNO') THEN IN_OrderNO_C ELSE '' END;
    SET r_Parameter4 = CONCAT(IN_Process_By_C, '%', IN_WaveNO, '%', IN_OrderNo, '%', IN_OrderLineNo, '%', IN_AllocationDetailsID);




    SET OUT_Return_Code = '*_*';
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'DEALLOCATION_BEFORE', r_Parameter2, '', r_Parameter4, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE END_PROC;
    END IF;

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_DEALLOCATE_DETAILS (
      AllocationDetailsID varchar(20),
      OrderNo varchar(20),
      OrderLineNO int(11),
      CustomerID varchar(30),
      Sku varchar(50),
      LotNUM varchar(10),
      UOM varchar(10),
      Location varchar(60),
      TraceID varchar(30),
      Qty decimal(18, 8),
      Qty_Each decimal(18, 8),
      PackID varchar(50),
      WaveNo varchar(20),
      STATUS char(2),
      Notes varchar(100),
      QtyPicked_Each decimal(18, 8),
      QtyShipped_Each decimal(18, 8),
      SoftAllocationDetailsID varchar(20),
      PickToLocation varchar(60),
      Cubic decimal(18, 8),
      picktotraceid varchar(30),
      RequiredeliveryNo char(1),
      CustomerID2 varchar(30),
      OrderType varchar(20),
      erpcancelflag char(1),
      CarrierID varchar(30)
    );
    DELETE
      FROM TMP_DEALLOCATE_DETAILS;
    SET r_CCL_ALC_LOG = getsys_configuration(In_organizationId, IN_Warehouse, '*', '*', 'CCL_ALC_LOG');
    SET r_SQL =
    ' insert into TMP_DEALLOCATE_DETAILS
    (AllocationDetailsID,OrderNo,OrderLineNO
     ,CustomerID,Sku,LotNUM,UOM
     ,Location,TraceID,Qty,Qty_Each,PackID
     ,WaveNo,STATUS,Notes,QtyPicked_Each,QtyShipped_Each
     ,SoftAllocationDetailsID,PickToLocation
     ,Cubic,picktotraceid,RequiredeliveryNo
     ,CustomerID2,OrderType,erpcancelflag,CarrierID
    )
    Select a.AllocationDetailsID
           ,a.OrderNo,a.OrderLineNO,a.CustomerID,a.Sku
           ,a.LotNUM,a.UOM,a.Location,a.TraceID
           ,a.Qty,a.Qty_Each,a.PackID,a.WaveNo
           ,a.Status,a.Notes
           ,a.QtyPicked_Each,a.QtyShipped_Each
           ,a.SoftAllocationDetailsID
           ,a.PickToLocation,a.Cubic
           ,a.picktotraceid
           ,b.RequiredeliveryNo,b.CustomerID CustomerID2
           ,b.OrderType,b.erpcancelflag,b.CarrierID
      from ACT_ALLOCATION_DETAILS a
     INNER JOIN DOC_ORDER_HEADER b
        ON a.ORDERNO = b.ORDERNO/*V432E*/
       and a.organizationId = b.organizationId
       and a.warehouseId = b.warehouseId
      LEFT JOIN RUL_DELIVERY_CONFIG c /*V432K*/
        ON b.organizationId = c.organizationId
       and b.warehouseId = c.warehouseId
       and b.CUSTOMERID = c.CUSTOMERID
       and b.CARRIERID = c.CARRIERID
     Where a.organizationId = ?
       and a.warehouseId = ?
       and a.Status = ''40'' ';
    IF UPPER(IN_Process_By_C) = UPPER('By WaveNO') THEN
      SET r_SQL = CONCAT(r_SQL, ' and a.WaveNO = ? ');
      SET @SQL = r_SQL;
      SET v_errormessage = @SQL;
      SET @organizationId = In_organizationId;
      SET @In_warehouse = In_warehouse;
      SET @IN_WaveNO = IN_WaveNO;
      PREPARE STMT FROM @SQL;
      EXECUTE STMT USING @organizationId, @In_warehouse, @IN_WaveNO;
      DEALLOCATE PREPARE STMT;

    ELSEIF UPPER(IN_Process_By_C) = UPPER('By OrderNO') THEN
      SET r_SQL = CONCAT(r_SQL, ' and a.OrderNo = ?');
      SET @SQL = r_SQL;
      SET v_errormessage = @SQL;
      SET @organizationId = In_organizationId;
      SET @In_warehouse = In_warehouse;
      SET @IN_OrderNo = IN_OrderNo;
      PREPARE STMT FROM @SQL;
      EXECUTE STMT USING @organizationId, @In_warehouse, @IN_OrderNo;
      DEALLOCATE PREPARE STMT;

    ELSEIF UPPER(IN_Process_By_C) = UPPER('By OrderNO + OrderLineNO') THEN
      SET r_SQL = CONCAT(r_SQL, ' and a.OrderNo = ? and a.OrderLineNo = ? ');
      SET @SQL = r_SQL;
      SET v_errormessage = @SQL;
      SET @organizationId = In_organizationId;
      SET @In_warehouse = In_warehouse;
      SET @IN_OrderNo = IN_OrderNo;
      SET @IN_OrderLineNO = IN_OrderLineNO;
      PREPARE STMT FROM @SQL;
      EXECUTE STMT USING @organizationId, @In_warehouse, @IN_OrderNO, @IN_OrderLineNO;
      DEALLOCATE PREPARE STMT;
    ELSEIF UPPER(IN_Process_By_C) = UPPER('By AllocationDetailsID') THEN
      SET r_SQL = CONCAT(r_SQL, ' and a.AllocationDetailsID = ? ');
      SET @SQL = r_SQL;
      SET v_errormessage = @SQL;
      SET @organizationId = In_organizationId;
      SET @In_warehouse = In_warehouse;
      SET @IN_AllocationDetailsID = IN_AllocationDetailsID;
      PREPARE STMT FROM @SQL;
      EXECUTE STMT USING @organizationId, @In_warehouse, @IN_AllocationDetailsID;
      DEALLOCATE PREPARE STMT;
    ELSE
      SET OUT_Return_Code = '887SPSO_DEAllocation_Process';
      LEAVE END_PROC;
    END IF;
    SELECT
      COUNT(1)
    FROM TMP_DEALLOCATE_DETAILS a
    WHERE EXISTS (SELECT
        1
      FROM DOC_LOADING_DETAILS
      WHERE AllocationDetailsID = a.AllocationDetailsID) INTO v_nrow;
    IF @nrow > 0 THEN
      SET OUT_Return_Code = '477';
      LEAVE END_PROC;
    END IF;

    SET r_OrderNO_tmp = NULL;
    OPEN cCur_Act;
    SET v_error = 1;
    FETCH cCur_Act
    INTO r_AllocationDetailsID_A, r_OrderNO_A, r_OrderLineNO_A, R_CustomerID_A, R_Sku_A
    , R_LotNUM_A, R_UOM_A, R_Location_A, R_TraceID_A, R_Qty_A, R_Qty_Each_A, R_PackID_A
    , r_WaveNO_A, R_Status_A, R_Notes_A, R_QtyPicked_Each_A, R_QtyShipped_Each_A
    , R_SoftAllocationDetailsID_A, R_PickToLocation_A, R_Cubic_A, r_picktotraceid_A
    , r_RequiredeliveryNo, r_CustomerID, r_OrderType, r_erpcancelflag, r_CarrierID;
    WHILE v_error <> 0 DO


      IF r_CCL_ALC_LOG = 'Y' THEN
        INSERT INTO ACT_CANCEL_ALLOCATION_LOG (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNO, SKULineNO, WaveNo, STATUS, CustomerID, SKU, LotNUM, Location,
        TraceID, PackID, UOM, Qty, Qty_Each, QtyPicked_Each, QtyShipped_Each, PickToLocation, PickToTraceID, SoftAllocationDetailsID,
        CancelBy, CancelTime)
          VALUES (In_organizationId, In_warehouse, r_AllocationDetailsID_A, r_OrderNo_A, r_OrderLineNO_A, '0', r_WaveNo_A, r_Status_A, r_CustomerID_A, r_Sku_A, r_LotNUM_A, r_Location_A, r_TraceID_A, r_PackID_A, r_UOM_A, r_Qty_A, r_Qty_Each_A, r_QtyPicked_Each_A, r_QtyShipped_Each_A, r_PickToLocation_A, r_Picktotraceid_A, r_SoftAllocationDetailsID_A, IN_UserID, NOW());
      END IF;
      SELECT
        COUNT(CASE WHEN (TaskProcess <> '00' AND
            TaskProcess <> '15' AND
            TaskProcess <> '99') THEN 1 ELSE NULL END),
        COUNT(CASE WHEN IFNULL(a.grouptaskid, '*') <> '*' THEN 1 ELSE NULL END),
        MAX(a.taskid)
      FROM TSK_TASKLISTS a
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND AllocationDetailsID = r_AllocationDetailsID_A INTO v_nRow, v_nRow1, r_taskids;
      IF v_nRow > 0 THEN
        CLOSE cCur_Act;
        SET OUT_Return_Code = '417';
        ROLLBACK;
        LEAVE END_PROC;
      END IF;

      IF v_nRow1 > 0 THEN
        CLOSE cCur_Act;
        ROLLBACK;
        SET OUT_Return_Code = '277';
        LEAVE END_PROC;
      END IF;



      SET v_error = 1;
      SELECT
        QtyAllocated,
        QtyAllocated_Each,
        PackID,
        packUOM,
        IFNULL(a.qtysoftallocated, 0),
        IFNULL(a.qtysoftallocated_each, 0),
        linestatus
      FROM DOC_ORDER_DETAILS a
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND OrderNO = r_OrderNO_A
      AND OrderLineNO = r_OrderLineNO_A INTO R_QtyAllocated_Order, R_QtyAllocated_Each_Order, R_PackID_R, R_UOM_R
      , r_qtysoftallocated, r_qtysoftallocated_each
      , r_lineStatus
      FOR UPDATE;
      IF v_error = 0 THEN
        CLOSE cCUR_ACT;
        SET OUT_Return_Code = '888DOC_ORDER_DETAILS,OPEN';
        ROLLBACK;
        LEAVE END_PROC;
      END IF;

      SET v_error = 1;
      SELECT
        MAX(CASE WHEN packUom = 'EA' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'CS' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
        MAX(CASE WHEN packUom = 'OT' THEN qty ELSE NULL END)
      FROM BAS_PACKAGE_DETAILS
      WHERE organizationId = In_organizationId
      AND customerId = R_CustomerID_A
      AND PackID = R_PackID_A INTO R_QTY1_P, R_QTY2_P, R_QTY3_P, R_QTY4_P, R_QTY5_P;
      IF v_error = 0 THEN
        CLOSE cCUR_ACT;
        SET OUT_Return_Code = '888BAS_PACKAGE,OPEN';
        ROLLBACK;
        LEAVE END_PROC;
      END IF;
      IF R_UOM_R = 'EA' THEN
        SET R_UOMQty_Read = R_QTY1_P;
      ELSEIF R_UOM_R = 'IP' THEN
        SET R_UOMQty_Read = R_QTY2_P;
      ELSEIF R_UOM_R = 'CS' THEN
        SET R_UOMQty_Read = R_QTY3_P;
      ELSEIF R_UOM_R = 'PL' THEN
        SET R_UOMQty_Read = R_QTY4_P;
      ELSEIF R_UOM_R = 'OT' THEN
        SET R_UOMQty_Read = R_QTY5_P;
      END IF;
      SET R_QtyPicked_Each_A = IFNULL(R_QtyPicked_Each_A, 0);
      SET R_QtyShipped_Each_A = IFNULL(R_QtyShipped_Each_A, 0);
      SET R_QtyDeAllocation_Each = R_Qty_Each_A - R_QtyPicked_Each_A;
      IF R_QtyDeAllocation_Each < 0 THEN
        SET R_QtyDeAllocation_Each = 0;
      END IF;
      SET R_QtyAllocated_Each_Order = R_QtyAllocated_Each_Order - R_QtyDeAllocation_Each;
      SET R_QtyAllocated_Order = R_QtyAllocated_Each_Order / R_UOMQty_Read;
      SET r_qtysoftallocated_each = r_qtysoftallocated_each - R_QtyDeAllocation_Each;
      SET r_qtysoftallocated = r_qtysoftallocated_each / R_UOMQty_Read;
      IF r_qtysoftallocated_each = 0 THEN
        SET r_LineStatus = '00';
      ELSEIF R_QtyAllocated_Each_Order = 0 THEN
        SET r_LineStatus = '20';
      END IF;
      IF R_QtyDeAllocation_Each > 0 THEN
        IF r_SoftAllocationDetailsID_A <> '*' THEN
          SET r_QTYDeSoft = 0;
          SET r_QTYDeSoft_each = 0;
        ELSE
          SET r_QTYDeSoft = r_QtyDeAllocation_Each / r_UOMQty_Read;
          SET r_QTYDeSoft_each = r_QtyDeAllocation_Each;
        END IF;
        IF R_QtyAllocated_Each_Order < 0 THEN
          SET R_QtyAllocated_Each_Order = 0;
          SET R_QtyAllocated_Order = 0;
        END IF;
        IF r_qtysoftallocated_each < 0 THEN
          SET r_qtysoftallocated_each = 0;
          SET r_qtysoftallocated = 0;
        END IF;
        UPDATE DOC_ORDER_DETAILS
        SET QtyAllocated = R_QtyAllocated_Order,
            QtyAllocated_Each = R_QtyAllocated_Each_Order,
            QtySoftAllocated = QtySoftAllocated - r_QTYDeSoft,
            QtySoftAllocated_Each = QtySoftAllocated_Each - r_QTYDeSoft_each,
            linestatus = r_LineStatus,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND OrderNO = r_OrderNO_A
        AND OrderLineNO = r_OrderLineNO_A;



        UPDATE INV_LOT_LOC_ID
        SET QtyAllocated = QtyAllocated - R_QtyDeAllocation_Each,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND LotNUm = R_LotNUM_A
        AND TraceID = R_TraceID_A
        AND LocationID = R_Location_A;




        UPDATE INV_LOT
        SET QtyAllocated = QtyAllocated - R_QtyDeAllocation_Each,
            QtyPreAllocated = QtyPreAllocated - r_QTYDeSoft_Each,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizationId = In_organizationId
        AND LotNUm = R_LotNUM_A;



        IF r_SRT_LOC = 'Y' THEN
          UPDATE TSK_SORTATION_STATION
          SET CubicUsed = CubicUsed - R_Cubic_A,
              qty = qty - R_Qty_Each_A
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND LocationID = R_PickToLocation_A
          AND OrderNo = r_OrderNO_A;
          DELETE
            FROM TSK_SORTATION_STATION
          WHERE qty = 0;
        END IF;





        IF r_SoftAllocationDetailsID_A <> '*' THEN
          SELECT
            UOM,
            PACKID,
            QTY_each_Allocation
          FROM ACT_SOFTALLOCATION_DETAILS
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND SoftAllocationDetailsID = R_SoftAllocationDetailsID_A INTO R_UOM_Soft, R_PackID_Soft, R_QTY_each_Allocation_SOft;
          SET v_error = 1;
          SELECT
            MAX(CASE WHEN packUom = 'EA' THEN qty ELSE NULL END),
            MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
            MAX(CASE WHEN packUom = 'CS' THEN qty ELSE NULL END),
            MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
            MAX(CASE WHEN packUom = 'OT' THEN qty ELSE NULL END)
          FROM BAS_PACKAGE_DETAILS
          WHERE organizationId = In_organizationId
          AND customerId = R_CustomerID_A
          AND PackID = R_PackID_Soft INTO R_QTY1_P, R_QTY2_P, R_QTY3_P, R_QTY4_P, R_QTY5_P;
          IF v_error = 0 THEN
            CLOSE cCUR_ACT;
            SET OUT_Return_Code = '888BAS_PACKAGE,OPEN';
            ROLLBACK;
            LEAVE END_PROC;
          END IF;
          IF R_UOM_Soft = 'EA' THEN
            SET R_UOMQty_Soft = R_QTY1_P;
          ELSEIF R_UOM_Soft = 'IP' THEN
            SET R_UOMQty_Soft = R_QTY2_P;
          ELSEIF R_UOM_Soft = 'CS' THEN
            SET R_UOMQty_Soft = R_QTY3_P;
          ELSEIF R_UOM_Soft = 'PL' THEN
            SET R_UOMQty_Soft = R_QTY4_P;
          ELSEIF R_UOM_Soft = 'OT' THEN
            SET R_UOMQty_Soft = R_QTY5_P;
          END IF;
          SET R_QTY_each_Allocation_SOft = R_QTY_each_Allocation_SOft - R_QtyDeAllocation_Each;
          SET R_QTY_Allocation_Soft = R_QTY_each_Allocation_SOft / R_UOMQty_Soft;
          IF R_SoftAllocationDetailsID_A <> '***' THEN
            UPDATE ACT_SOFTALLOCATION_DETAILS
            SET QTY_each_Allocation = R_QTY_each_Allocation_SOft,
                QTY_Allocation = R_QTY_Allocation_Soft,
                editTime = R_CurrentTime,
                editwho = in_UserID
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND SoftAllocationDetailsID = R_SoftAllocationDetailsID_A;
          END IF;
        END IF;



        IF R_QtyDeAllocation_Each = R_Qty_Each_A THEN
          DELETE
            FROM ACT_ALLOCATION_DETAILS
          WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND AllocationDetailsID = r_AllocationDetailsID_A
            AND STATUS = '40';
        ELSE
          SET v_error = 1;
          SELECT
            MAX(CASE WHEN packUom = 'EA' THEN qty ELSE NULL END),
            MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
            MAX(CASE WHEN packUom = 'CS' THEN qty ELSE NULL END),
            MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
            MAX(CASE WHEN packUom = 'OT' THEN qty ELSE NULL END)
          FROM BAS_PACKAGE_DETAILS
          WHERE organizationId = In_organizationId
          AND customerId = R_CustomerID_A
          AND PackID = R_PackID_A INTO R_QTY1_P, R_QTY2_P, R_QTY3_P, R_QTY4_P, R_QTY5_P;
          IF v_error = 0 THEN
            CLOSE cCUR_ACT;
            SET OUT_Return_Code = '888BAS_PACKAGE,OPEN';
            ROLLBACK;
            LEAVE END_PROC;
          END IF;
          IF R_UOM_R = 'EA' THEN
            SET R_UOMQty_Read = R_QTY1_P;
          ELSEIF R_UOM_R = 'IP' THEN
            SET R_UOMQty_Read = R_QTY2_P;
          ELSEIF R_UOM_R = 'CS' THEN
            SET R_UOMQty_Read = R_QTY3_P;
          ELSEIF R_UOM_R = 'PL' THEN
            SET R_UOMQty_Read = R_QTY4_P;
          ELSEIF R_UOM_R = 'OT' THEN
            SET R_UOMQty_Read = R_QTY5_P;
          END IF;
          SET R_QTY_each_Allocation_Hard = R_QTY_each_A - R_QtyDeAllocation_Each;
          SET R_QTY_Allocation_Hard = R_QTY_each_Allocation_Hard / R_UOMQty_Hard;
          UPDATE ACT_ALLOCATION_DETAILS
          SET Qty_Each = R_QTY_each_Allocation_Hard,
              Qty = R_QTY_Allocation_Hard,
              editTime = R_CurrentTime,
              editwho = in_UserID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND AllocationDetailsID = r_AllocationDetailsID_A;
        END IF;





        DELETE
          FROM TSK_TASKLISTS
        WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND AllocationDetailsID = r_AllocationDetailsID_A
          AND (TaskProcess = '00'
          OR TaskProcess = '15');
      END IF;


      IF r_picktotraceid_tmp IS NOT NULL
        AND r_picktotraceid_tmp <> r_picktotraceid_A THEN
        SET r_DEL_DOC_SN = GETSYS_configuration(In_organizationId, IN_Warehouse, r_CustomerID_tmp, r_OrderType_tmp, 'DEL_DOC_SN#', 'N', 'C');
        IF r_DEL_DOC_SN IN ('A', 'C') THEN
          IF r_RequiredeliveryNo = 'Y'
            OR (r_RequiredeliveryNo = 'S'
            AND r_erpcancelflag = 'Y') THEN
            SELECT
              COUNT(1)
            FROM ACT_ALLOCATION_DETAILS b
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND PickToTraceID = r_picktotraceid_tmp INTO v_nRow;
            SELECT
              COUNT(1) + v_nRow
            FROM DOC_ORDER_HEADER b
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND deliveryno = r_picktotraceid_tmp
            AND soStatus <> '90' INTO v_nRow;
            IF v_nRow = 0
              AND IFNULL(r_keepDeliveryNo, 'N') <> 'Y' THEN
              UPDATE SYS_DELIVERY_NO
              SET UseFlag = 'N'
              WHERE organizationId = In_organizationId
              AND CarrierID = r_CarrierID_tmp
              AND UseFlag = 'Y'
              AND DeliveryNo = r_picktotraceid_tmp;
            END IF;
          END IF;
        END IF;
      ELSE
        SET r_CustomerID_tmp = r_CustomerID;
        SET r_OrderType_tmp = r_OrderType;
        SET r_CarrierID_tmp = r_CarrierID;
      END IF;
      SET r_OrderNO_tmp = r_OrderNO_A;
      SET r_picktotraceid_tmp = r_picktotraceid_A;


      SET v_error = 1;
      FETCH cCur_Act
      INTO r_AllocationDetailsID_A, r_OrderNO_A, r_OrderLineNO_A, R_CustomerID_A, R_Sku_A
      , R_LotNUM_A, R_UOM_A, R_Location_A, R_TraceID_A, R_Qty_A, R_Qty_Each_A, R_PackID_A
      , r_WaveNO_A, R_Status_A, R_Notes_A, R_QtyPicked_Each_A, R_QtyShipped_Each_A
      , R_SoftAllocationDetailsID_A, R_PickToLocation_A, R_Cubic_A, r_picktotraceid_A
      , r_RequiredeliveryNo, r_CustomerID, r_OrderType, r_erpcancelflag, r_CarrierID;
    END WHILE;
    CLOSE cCUR_ACT;
    SET OUT_Return_Code = '*_*';
    CALL SPSO_ModifyLineStatus(In_organizationId, IN_Warehouse, IN_Process_Action_C, IN_Process_By_C, IN_WaveNO, r_OrderNO_A
    , r_OrderLineNO_A, IN_AllocationDetailsID, IN_Language, IN_UserID
    , OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE END_PROC;
    END IF;
    IF r_Trans_Control = 'Y' THEN
      COMMIT;
    END IF;




    SET r_DEL_DOC_SN = GETSYS_configuration_D(In_organizationId, IN_Warehouse, r_CustomerID, r_OrderType, 'DEL_DOC_SN#', 'N');
    IF r_DEL_DOC_SN IN ('A', 'C') THEN
      IF r_RequiredeliveryNo = 'Y'
        OR (r_RequiredeliveryNo = 'S'
        AND r_erpcancelflag = 'Y') THEN
        SELECT
          COUNT(1)
        FROM ACT_ALLOCATION_DETAILS b
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND PickToTraceID = r_picktotraceid_tmp INTO v_nRow;
        SELECT
          COUNT(1) + v_nRow
        FROM DOC_ORDER_HEADER b
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND deliveryno = r_picktotraceid_tmp
        AND soStatus <> '90' INTO v_nRow;
        IF v_nRow = 0
          AND IFNULL(r_keepDeliveryNo, 'N') <> 'Y' THEN
          UPDATE SYS_DELIVERY_NO
          SET UseFlag = 'N'
          WHERE organizationId = In_organizationId
          AND CarrierID = r_CarrierID_tmp
          AND UseFlag = 'Y'
          AND DeliveryNo = r_picktotraceid_tmp;
        END IF;
      END IF;
    END IF;




    IF r_SoftAllocationDetailsID_A <> '*' THEN
      IF UPPER(IN_Process_By_C) = UPPER('By WaveNO') THEN
        SET OUT_Return_Code = '*-*';
        CALL SPSO_DESoftAllocation_Process(In_organizationId, IN_Warehouse, 'UnSoftAllocation', IN_Process_By_C, IN_WaveNO, IN_OrderNO, IN_OrderLineNO
        , '*', IN_Language, IN_UserID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000'
          AND SUBSTRING(OUT_Return_Code, 1, 3) <> '001' THEN
          ROLLBACK;
          LEAVE END_PROC;
        END IF;
        IF r_Trans_Control = 'Y' THEN
          COMMIT;
        END IF;
      ELSEIF UPPER(IN_Process_By_C) = UPPER('By OrderNO') THEN
        SET OUT_Return_Code = '*-*';
        CALL SPSO_DESoftAllocation_Process(In_organizationId, IN_Warehouse, 'UnSoftAllocation', IN_Process_By_C, IN_WaveNO, IN_OrderNO, IN_OrderLineNO
        , '*', IN_Language, IN_UserID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000'
          AND SUBSTRING(OUT_Return_Code, 1, 3) <> '001' THEN
          ROLLBACK;
          LEAVE END_PROC;
        END IF;
        IF r_Trans_Control = 'Y' THEN
          COMMIT;
        END IF;
      ELSEIF UPPER(IN_Process_By_C) = UPPER('By OrderNO + OrderLineNO') THEN
        SET OUT_Return_Code = '*-*';
        CALL SPSO_DESoftAllocation_Process(In_organizationId, IN_Warehouse, 'UnSoftAllocation', IN_Process_By_C
        , IN_WaveNO, IN_OrderNO, IN_OrderLineNO, '*', IN_Language, IN_UserID
        , OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000'
          AND SUBSTRING(OUT_Return_Code, 1, 3) <> '001' THEN
          ROLLBACK;
          LEAVE END_PROC;
        END IF;
        IF r_Trans_Control = 'Y' THEN
          COMMIT;
        END IF;
      ELSEIF UPPER(IN_Process_By_C) = UPPER('By AllocationDetailsID') THEN
        SET v_error = 1;
        SELECT
          WaveNO,
          OrderNO,
          OrderLineNO,
          SoftAllocationDetailsID
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND AllocationDetailsID = IN_AllocationDetailsID INTO IN_WaveNO, IN_OrderNO, IN_OrderLineNO, R_SoftAllocationDetailsID_A;
        IF v_error = 0 THEN
          SET IN_WaveNO = IN_WaveNO_C;
          SET IN_OrderNO = IN_OrderNO_C;
          SET IN_OrderLineNO = IN_OrderLineNO_C;
        END IF;
        SET OUT_Return_Code = '*_*';
        CALL SPSO_DESoftAllocation_Process(In_organizationId, IN_Warehouse, 'UnSoftAllocation', 'By SoftAllocationDetailsID', IN_WaveNO
        , IN_OrderNO, IN_OrderLineNO, R_SoftAllocationDetailsID_A, IN_Language, IN_UserID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000'
          AND SUBSTRING(OUT_Return_Code, 1, 3) <> '001' THEN
          ROLLBACK;
          LEAVE END_PROC;
        END IF;
        IF r_Trans_Control = 'Y' THEN
          COMMIT;
        END IF;
      END IF;
    END IF;
    IF IN_OrderNo IS NOT NULL THEN
      DELETE
        FROM DOC_ORDER_PACKING_SUMMARY
      WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND OrderNo = IN_OrderNo
        AND TraceID NOT IN (SELECT
            PickToTraceID
          FROM ACT_ALLOCATION_DETAILS
          WHERE OrderNo = IN_OrderNo);
    END IF;

    IF r_SRT_LOC = 'C' THEN
      IF UPPER(IN_Process_By_C) = UPPER('By WaveNO') THEN
        DELETE
          FROM TSK_SORTATION_STATION
        WHERE organizationId = In_organizationId
          AND OrderNo IN (SELECT
              OrderNo
            FROM DOC_ORDER_HEADER
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND sostatus = '00'
            AND WaveNo = IN_WaveNO);
      ELSE
        DELETE
          FROM TSK_SORTATION_STATION
        WHERE organizationId = In_organizationId
          AND OrderNo IN (SELECT
              OrderNo
            FROM DOC_ORDER_HEADER
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND sostatus = '00'
            AND OrderNO = r_OrderNO_A);
      END IF;
    END IF;







    SET OUT_Return_Code = '*_*';
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'DEALLOCATION_AFTER', r_Parameter2, '', r_Parameter4, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE END_PROC;
    END IF;
    IF v_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `SPSO_CANCEL_SHIPMENT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_CANCEL_SHIPMENT (IN IN_organizationId varchar(30),
IN IN_Warehouse varchar(30),
IN IN_TRANSACTIONID varchar(30),
IN IN_Language varchar(30),
IN IN_UserID varchar(30),
INOUT OUT_Return_Code varchar(2000))
ENDPROC:
  BEGIN

    DECLARE R_TRAN_CTL char(1) DEFAULT 'Y';
    DECLARE R_NROW int;
    DECLARE R_CURRENTTIME date;
    DECLARE R_SHP_CCL_CHK char(1);

    DECLARE R_TRANSACTIONTYPE_LOG varchar(30);
    DECLARE R_STATUS_LOG varchar(30);
    DECLARE R_ALLOCATIONDETAILSID varchar(30);


    DECLARE R_ORDERNO varchar(30);
    DECLARE R_ORDERLINENO varchar(30);
    DECLARE R_CUSTOMERID varchar(30);
    DECLARE R_SKU varchar(30);
    DECLARE R_LOTNUM varchar(30);
    DECLARE R_LOCATION varchar(30);
    DECLARE R_TRACEID varchar(30);
    DECLARE R_PICKTOLOCATION varchar(30);
    DECLARE R_PICKTOTRACEID varchar(30);
    DECLARE R_QTYACTED_EACH decimal(18, 8);
    DECLARE R_QTYPICKED_EACH decimal(18, 8);
    DECLARE R_QTYSHIPED_EACH decimal(18, 8);
    DECLARE R_CUBIC decimal(18, 8);
    DECLARE R_GROSSWEIGHT decimal(18, 8);
    DECLARE R_NETWEIGHT decimal(18, 8);
    DECLARE R_PRICE decimal(18, 8);
    DECLARE R_STATUS varchar(30);
    DECLARE R_PACKFLAG varchar(30);
    DECLARE R_CHECKWHO varchar(30);
    DECLARE R_SOSTATUS varchar(30);
    DECLARE R_ORDERTYPE varchar(30);
    DECLARE R_QTYORDERED_EACH_ORDER decimal(18, 8);
    DECLARE R_QTYALLOCATED_EACH_ORDER decimal(18, 8);
    DECLARE R_QTYSHIPED_ORDER decimal(18, 8);
    DECLARE R_QTYSHIPED_EACH_ORDER decimal(18, 8);
    DECLARE R_LINESTATUS_ORDER varchar(30);
    DECLARE R_UOM_ORDER varchar(30);
    DECLARE R_PACKID_ORDER varchar(30);
    DECLARE R_ERPCANCELFLAG_ORDER varchar(30);
    DECLARE R_SALESORDERNO varchar(30);
    DECLARE R_SALESORDERLINENO int;

    DECLARE R_QTY1_P decimal(18, 8);
    DECLARE R_QTY2_P decimal(18, 8);
    DECLARE R_QTY3_P decimal(18, 8);
    DECLARE R_QTY4_P decimal(18, 8);
    DECLARE R_QTY5_P decimal(18, 8);
    DECLARE R_UOMQTY_ORDER decimal(18, 8);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_CANCEL_SHIPMENT,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;

    BEGIN
      IF OUT_RETURN_CODE = '*_*' THEN
        SET R_TRAN_CTL = 'N';
      END IF;
      SET R_CURRENTTIME = SYSDATE();
      SET OUT_RETURN_CODE = '000';
    END;

    BEGIN
      SET OUT_RETURN_CODE = '*_*';
      CALL SPUDF_PROCESSA(IN_organizationId, IN_WAREHOUSE, 'UNSHIP_BEFORE', IN_TRANSACTIONID, '', '', IN_LANGUAGE, IN_USERID, OUT_RETURN_CODE);
      IF SUBSTRING(OUT_RETURN_CODE, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      SELECT
        T.QCTASKID,
        T.DOCNO,
        T.DOCLINENO,
        T.TRANSACTIONTYPE,
        T.STATUS INTO R_ALLOCATIONDETAILSID, R_ORDERNO, R_ORDERLINENO, R_TRANSACTIONTYPE_LOG, R_STATUS_LOG
      FROM ACT_TRANSACTION_LOG T
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND T.TRANSACTIONID = IN_TRANSACTIONID
      FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_RETURN_CODE = '888ACT_TRANSACTION_LOG,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      IF R_TRANSACTIONTYPE_LOG <> 'SO' THEN
        SET OUT_RETURN_CODE = '999#????,???';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      IF R_STATUS_LOG <> '99' THEN
        SET OUT_RETURN_CODE = '999#????,???';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      UPDATE ACT_TRANSACTION_LOG
      SET STATUS = '90',
          EDITTIME = R_CURRENTTIME,
          EDITWHO = IN_USERID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND TRANSACTIONID = IN_TRANSACTIONID;
    END;

    BEGIN
      SELECT
        A.ORDERNO,
        A.ORDERLINENO,
        A.CUSTOMERID,
        A.SKU,
        A.LOTNUM,
        A.LOCATION,
        A.TRACEID,
        A.PICKTOLOCATION,
        A.PICKTOTRACEID,
        A.QTYPICKED_EACH,
        A.QTYSHIPPED_EACH,
        A.CUBIC,
        A.GROSSWEIGHT,
        A.NETWEIGHT,
        A.PRICE,
        A.CHECKWHO,
        A.STATUS INTO R_ORDERNO, R_ORDERLINENO, R_CUSTOMERID, R_SKU
      , R_LOTNUM, R_LOCATION, R_TRACEID, R_PICKTOLOCATION, R_PICKTOTRACEID
      , R_QTYPICKED_EACH, R_QTYSHIPED_EACH
      , R_CUBIC, R_GROSSWEIGHT, R_NETWEIGHT, R_PRICE
      , R_CHECKWHO, R_STATUS
      FROM ACT_ALLOCATION_DETAILS A
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND A.ALLOCATIONDETAILSID = R_ALLOCATIONDETAILSID
      FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_RETURN_CODE = '888ACT_ALLOCATION_DETAILS,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF R_STATUS <> '80' THEN
        SET OUT_RETURN_CODE = '999#????,???';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF R_QTYPICKED_EACH = 0 THEN
        SET R_STATUS = '40';



        IF R_CHECKWHO IS NULL THEN
          SET R_PICKTOLOCATION = R_LOCATION;
          SET R_PICKTOTRACEID = R_TRACEID;
        END IF;
      ELSE
        SET R_STATUS = '60';
      END IF;

      UPDATE ACT_ALLOCATION_DETAILS
      SET QTYSHIPPED_EACH = 0,
          SHIPMENTTIME = NULL,
          SHIPMENTWHO = NULL,
          STATUS = R_STATUS,
          EDITTIME = R_CURRENTTIME,
          EDITWHO = IN_USERID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND ALLOCATIONDETAILSID = R_ALLOCATIONDETAILSID;
    END;

    BEGIN
      SELECT
        SOSTATUS,
        ORDERTYPE INTO R_SOSTATUS, R_ORDERTYPE
      FROM DOC_ORDER_HEADER
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND ORDERNO = R_ORDERNO
      FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_RETURN_CODE = '888DOC_ORDER_HEADER,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      IF R_SOSTATUS = '90' THEN
        SET OUT_RETURN_CODE = '999#???????????';
        ROLLBACK;
        LEAVE ENDPROC;
      ELSEIF R_SOSTATUS = '99' THEN
        SET R_SHP_CCL_CHK = GETSYS_CONFIGURATION(IN_organizationId, IN_WAREHOUSE, R_CUSTOMERID, R_ORDERTYPE, 'SHP_CCL_CHK');
        IF R_SHP_CCL_CHK = 'N' THEN
          SET OUT_RETURN_CODE = '999#???????????';
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
      END IF;

      SELECT
        D.QTYORDERED_EACH,
        D.QTYALLOCATED_EACH,
        D.QTYSHIPPED,
        D.QTYSHIPPED_EACH,
        D.LINESTATUS,
        D.packUOM,
        D.PACKID,
        D.ERPCANCELFLAG,
        D.SALESORDERNO,
        D.SALESORDERLINENO INTO R_QTYORDERED_EACH_ORDER, R_QTYALLOCATED_EACH_ORDER, R_QTYSHIPED_ORDER, R_QTYSHIPED_EACH_ORDER, R_LINESTATUS_ORDER, R_UOM_ORDER, R_PACKID_ORDER, R_ERPCANCELFLAG_ORDER
      , R_SALESORDERNO, R_SALESORDERLINENO
      FROM DOC_ORDER_DETAILS D
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND ORDERNO = R_ORDERNO
      AND ORDERLINENO = R_ORDERLINENO
      FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_RETURN_CODE = '888DOC_ORDER_DETAILS,OPEN';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET R_QTYSHIPED_EACH_ORDER = R_QTYSHIPED_EACH_ORDER - R_QTYSHIPED_EACH;
      IF R_QTYSHIPED_EACH_ORDER < 0 THEN
        SET OUT_RETURN_CODE = '999#??????,???';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET R_UOMQTY_ORDER = 0;
      SELECT
        a.qty INTO r_UOMQty_Order
      FROM BAS_PACKAGE_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.customerId = R_CustomerID
      AND a.PackID = R_PACKID_ORDER
      AND packUom = R_UOM_ORDER;

      IF R_UOMQTY_ORDER <= 0 THEN
        SET OUT_Return_Code = '110';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      UPDATE DOC_ORDER_DETAILS
      SET LINESTATUS = R_LINESTATUS_ORDER,
          QTYSHIPPED_EACH = R_QTYSHIPED_EACH_ORDER,
          QTYSHIPPED = R_QTYSHIPED_EACH_ORDER / R_UOMQTY_ORDER,
          EDITTIME = R_CURRENTTIME,
          EDITWHO = IN_USERID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND ORDERNO = R_ORDERNO
      AND ORDERLINENO = R_ORDERLINENO;

      SET OUT_RETURN_CODE = '*_*';
      CALL SPSO_MODIFYLINESTATUS(IN_organizationId, IN_WAREHOUSE, 'CREATELST', 'By OrderNO + OrderLineNO', NULL, R_ORDERNO, R_ORDERLINENO, NULL, IN_LANGUAGE, IN_USERID, OUT_RETURN_CODE);
      IF SUBSTRING(OUT_RETURN_CODE, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      SET R_NROW = 0;
      SELECT
        1 INTO R_NROW
      FROM INV_LOT_LOC_ID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND LOTNUM = R_LOTNUM
      AND LOCATIONID = R_PICKTOLOCATION
      AND TRACEID = R_PICKTOTRACEID
      FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET R_NROW = 0;
      END IF;
      IF R_NROW = 0 THEN
        INSERT INTO INV_LOT_LOC_ID (LOTNUM, LOCATIONID, TRACEID
        , organizationId, warehouseId
        , CUSTOMERID, SKU, QTY, QTYALLOCATED
        , QTYRPOUT, QTYMVOUT, QTYRPIN, QTYMVIN, QTYONHOLD
        , CUBIC, GROSSWEIGHT, NETWEIGHT, PRICE
        , ADDTIME, ADDWHO, EDITTIME, EDITWHO)
          VALUES (R_LOTNUM, R_PICKTOLOCATION, R_PICKTOTRACEID, IN_organizationId, IN_Warehouse, R_CUSTOMERID, R_SKU, R_QTYSHIPED_EACH, R_QTYSHIPED_EACH, 0, 0, 0, 0, 0, R_CUBIC, R_GROSSWEIGHT, R_NETWEIGHT, R_PRICE, R_CURRENTTIME, IN_USERID, R_CURRENTTIME, IN_USERID);
      ELSE
        UPDATE INV_LOT_LOC_ID
        SET QTY = QTY + R_QTYSHIPED_EACH,
            QTYALLOCATED = QTYALLOCATED + R_QTYSHIPED_EACH,
            CUBIC = CUBIC + R_CUBIC,
            GROSSWEIGHT = GROSSWEIGHT + R_GROSSWEIGHT,
            NETWEIGHT = NETWEIGHT + R_NETWEIGHT,
            PRICE = PRICE + R_PRICE,
            EDITTIME = R_CURRENTTIME,
            EDITWHO = IN_USERID
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_Warehouse
        AND LOTNUM = R_LOTNUM
        AND LOCATIONID = R_PICKTOLOCATION
        AND TRACEID = R_PICKTOTRACEID;
      END IF;

      SELECT
        1 INTO R_NROW
      FROM INV_LOT
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND LOTNUM = R_LOTNUM
      FOR UPDATE;
      IF FOUND_ROWS() = 0 THEN
        SET R_NROW = 0;
      END IF;

      IF R_NROW = 0 THEN
        INSERT INTO INV_LOT (LOTNUM, CUSTOMERID, SKU
        , organizationId, warehouseId
        , QTY, QTYPREALLOCATED, QTYALLOCATED, QTYONHOLD
        , CUBIC, GROSSWEIGHT, NETWEIGHT, PRICE
        , ADDTIME, ADDWHO, EDITTIME, EDITWHO)
          VALUES (R_LOTNUM, R_CUSTOMERID, R_SKU, IN_organizationId, IN_Warehouse, R_QTYSHIPED_EACH, R_QTYSHIPED_EACH, R_QTYSHIPED_EACH, 0, R_CUBIC, R_GROSSWEIGHT, R_NETWEIGHT, R_PRICE, R_CURRENTTIME, IN_USERID, R_CURRENTTIME, IN_USERID);
      ELSE
        UPDATE INV_LOT
        SET QTY = QTY + R_QTYSHIPED_EACH,
            QTYPREALLOCATED = QTYPREALLOCATED + R_QTYSHIPED_EACH,
            QTYALLOCATED = QTYALLOCATED + R_QTYSHIPED_EACH,
            CUBIC = CUBIC + R_CUBIC,
            GROSSWEIGHT = GROSSWEIGHT + R_GROSSWEIGHT,
            NETWEIGHT = NETWEIGHT + R_NETWEIGHT,
            PRICE = PRICE + R_PRICE,
            EDITTIME = R_CURRENTTIME,
            EDITWHO = IN_USERID
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_Warehouse
        AND LOTNUM = R_LOTNUM;
      END IF;

    END;

    IF R_STATUS = '40' THEN
      UPDATE TSK_TASKLISTS
      SET TASKPROCESS = '00',
          COMPLETED_TRANSACTIONID = NULL,
          CLOSETIME = NULL,
          CLOSEWHO = NULL,
          EDITTIME = R_CURRENTTIME,
          EDITWHO = IN_USERID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_Warehouse
      AND ALLOCATIONDETAILSID = R_ALLOCATIONDETAILSID;
      IF ROW_COUNT() = 0 THEN
        SET OUT_Return_Code = CONCAT('999????', R_ALLOCATIONDETAILSID, IN_organizationId, IN_Warehouse);
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END IF;


    BEGIN
      IF IFNULL(R_SALESORDERNO, '*') <> '*'
        AND IFNULL(R_SALESORDERNO, '') <> '' THEN
        SELECT
          IFNULL(SUM(B.QTYSHIPPED), 0),
          IFNULL(SUM(B.QTYSHIPPED_EACH), 0) INTO @QTYSHIPPED, @QTYSHIPPED_EACH
        FROM DOC_ORDER_DETAILS B
        WHERE B.organizationId = IN_organizationId
        AND B.warehouseId = IN_Warehouse
        AND B.SALESORDERNO = R_SALESORDERNO
        AND B.SALESORDERLINENO = R_SALESORDERLINENO;

        UPDATE DOC_SALESORDER_DETAILS A
        SET A.QTYSHIPPED = QTYSHIPPED,
            A.QTYSHIPPED_EACH = QTYSHIPPED_EACH,
            A.EDITTIME = R_CURRENTTIME,
            A.EDITWHO = IN_USERID
        WHERE A.organizationId = IN_organizationId
        AND A.warehouseId = IN_Warehouse
        AND A.SALESORDERNO = R_SALESORDERNO
        AND A.SALESORDERLINENO = R_SALESORDERLINENO;

        UPDATE DOC_SALESORDER_DETAILS A
        SET A.LINESTATUS =
        CASE WHEN IFNULL(A.QTYSHIPPED_EACH, 0) = 0 THEN A.LINESTATUS WHEN A.QTYORDERED_EACH > A.QTYSHIPPED_EACH THEN '70' ELSE '80' END
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_Warehouse
        AND A.SALESORDERNO = R_SALESORDERNO
        AND A.SALESORDERLINENO = R_SALESORDERLINENO;

        UPDATE DOC_SALESORDER_HEADER A
        SET A.ORDERSTATUS = (SELECT
            CASE WHEN MIN(D.LINESTATUS) = '80' THEN '80' ELSE '70' END
          FROM DOC_SALESORDER_DETAILS D
          WHERE D.SALESORDERNO = A.SALESORDERNO)
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_Warehouse
        AND SALESORDERNO = R_SALESORDERNO;
      END IF;


    END;

    BEGIN
      SET OUT_RETURN_CODE = '*_*';
      CALL SPUDF_PROCESSA(IN_organizationId, IN_WAREHOUSE, 'UNSHIP_AFTER', IN_TRANSACTIONID, '', '', IN_LANGUAGE, IN_USERID, OUT_RETURN_CODE);
      IF SUBSTRING(OUT_RETURN_CODE, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END;

    BEGIN
      SET OUT_RETURN_CODE = '000';
      IF R_TRAN_CTL = 'Y' THEN
        COMMIT;
      END IF;
    END;
  END
  $$

--
-- Create procedure `Z_CHECKOVERPALLETINLOC`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_CHECKOVERPALLETINLOC (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_locId varchar(30),
IN IN_SKU varchar(30),
IN IN_QtyEAIn varchar(30),
OUT returncode varchar(1009))
ENDPROC:
  BEGIN

    -- Declare variables to store data from each row
    DECLARE done int DEFAULT FALSE;
    DECLARE v_locationId varchar(255);  -- Adjust lengths as needed
    DECLARE v_traceId varchar(255);
    DECLARE v_customerId varchar(255);
    DECLARE v_sku varchar(255);
    DECLARE v_qtyStock int;
    DECLARE v_rowcount int DEFAULT 0;
    DECLARE v_muid varchar(255);
    DECLARE v_qtyPallet int;
    DECLARE v_qtyPalletCount int;
    DECLARE v_qtyPercentage decimal(10, 2); -- Decimal for percentage
    DECLARE v_qtyPercentageQtyIn decimal(10, 2); -- Decimal for percentage qty In
    DECLARE v_totalperseninstock decimal(10, 2); -- Decimal for percentage qty In
    DECLARE v_packId varchar(255);
    DECLARE v_sum_percentage int DEFAULT 0;
    DECLARE v_packId_check varchar(255);
    DECLARE errorMessage varchar(255);

    DECLARE cur_inventory CURSOR FOR
    SELECT
      INVID.locationId,
      INVID.TRACEID,
      INVID.customerId,
      INVID.SKU,
      INVID.qty AS qtystock,
      INVID.muid,
      IFNULL(bpd.qty, 0) AS qtypallet,
      ((INVID.qty / bpd.qty) * 100) AS qtypercentage,
      bp.PACKID
    FROM INV_LOT_LOC_ID INVID
      INNER JOIN BAS_SKU bs
        ON (INVID.organizationId = bs.organizationId
        AND INVID.customerId = bs.customerId
        AND INVID.SKU = bs.SKU)
      INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
        ON (bs.organizationId = bsm.organizationId
        AND bs.customerId = bsm.customerId
        AND bs.SKU = bsm.SKU
        AND INVID.warehouseId = bsm.warehouseId)
      INNER JOIN BAS_PACKAGE bp
        ON bsm.organizationId = bp.organizationId
        AND bsm.PACKID = bp.PACKID
        AND bsm.customerId = bp.customerId
      INNER JOIN BAS_PACKAGE_DETAILS bpd
        ON bp.organizationId = bpd.organizationId
        AND bp.PACKID = bpd.PACKID
        AND bp.customerId = bpd.customerId
      INNER JOIN BAS_LOCATION bl
        ON INVID.organizationId = bl.organizationId
        AND INVID.locationId = bl.locationId
        AND INVID.warehouseId = bl.warehouseId
    WHERE INVID.organizationId = IN_organizationId
    AND INVID.warehouseId = IN_warehouseId
    AND bpd.packUom = 'PL'
    AND INVID.locationId = IN_locId
    AND INVID.qty > 0
    AND bl.locationCategory IN ('SD', 'DD')
    AND bl.locationId NOT LIKE ('%RCV%')
    AND bl.locationId NOT IN (SELECT
        bcm.configValue
      FROM BSM_CONFIG_RULES
      bcm
      WHERE bcm.organizationId = 'OJV_CML'
      AND bcm.configId = 'DFT_RCV_LOC'
      AND bcm.activeFlag = 'Y')
    AND INVID.warehouseId IN ('CBT01', 'CBT02', 'CBT03', 'JBK01');

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    OPEN cur_inventory;

  read_loop:
    LOOP
      FETCH cur_inventory INTO v_locationId,
      v_traceId,
      v_customerId,
      v_sku,
      v_qtyStock,
      v_muid,
      v_qtyPallet,
      v_qtyPercentage,
      v_packId;


      IF done THEN
        LEAVE read_loop;
      END IF;


      LEAVE read_loop;


      SET v_rowcount = v_rowcount + 1;

      --   SELECT v_sku,v_qtyStock,v_rowcount;


      SET v_sum_percentage = v_sum_percentage + v_qtyPercentage;

    END LOOP;

    IF v_rowcount = 0 THEN
      SET returnCode := '000';
      LEAVE ENDPROC;
    END IF;

    IF v_qtyPallet IS NULL
      OR v_qtyPallet = 0 THEN   -- IF PACKAGE NOT PL
      SET returnCode = '_Pallet Null!';
      LEAVE ENDPROC;
    END IF;

    SELECT
    DISTINCT
      bsm.PACKID INTO v_packId_check
    FROM BAS_SKU_MULTIWAREHOUSE bsm
    WHERE bsm.organizationId = IN_organizationId
    AND bsm.warehouseId = IN_warehouseId
    AND bsm.SKU = IN_SKU;

    SELECT
      IFNULL(bl.plCount, 0) INTO v_qtyPalletCount
    FROM BAS_LOCATION bl
    WHERE bl.organizationId = IN_organizationId
    AND bl.warehouseId = IN_warehouseId
    AND bl.locationId = IN_locId;


    IF v_qtyPalletCount IS NULL
      OR v_qtyPalletCount = ''
      OR v_qtyPalletCount = 0 THEN
      SET returnCode := '000';
      LEAVE ENDPROC;
    END IF;

    IF v_qtyPallet IS NULL
      OR v_qtyPallet = 0 THEN   -- IF PACKAGE NOT PL
      SET returnCode := '000';
      LEAVE ENDPROC;
    END IF;

    IF v_packId_check IS NULL
      OR v_packId_check = '' THEN

      SET returnCode = '_Pack ID Multiwarehouse Null!';
      LEAVE ENDPROC;
    END IF;


    SELECT
      (IN_QtyEAIn / bpd.qty) * 100 INTO v_qtyPercentageQtyIn
    FROM BAS_PACKAGE bp
      INNER JOIN BAS_PACKAGE_DETAILS bpd
        ON bp.organizationId = bpd.organizationId
        AND bp.PACKID = bpd.PACKID
        AND bp.customerId = bpd.customerId
      INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
        ON bp.organizationId = bsm.organizationId
        AND bpd.organizationId = bsm.organizationId
        AND bpd.customerId = bsm.customerId
        AND bpd.PACKID = bsm.PACKID
        AND bsm.organizationId = IN_organizationId
        AND bsm.warehouseId = IN_warehouseId
        AND bpd.packUom = 'PL'
        AND bsm.SKU = IN_SKU;


    IF ((v_sum_percentage + v_qtyPercentageQtyIn) > (100 * v_qtyPalletCount)) THEN
      SET errorMessage = CONCAT('Error OverPallet for Location [', IN_locId, ']');
      SET returnCode = errorMessage;
      LEAVE ENDPROC;
    END IF;
    SET returnCode = '_Percentace OverPallet!';
    CLOSE cur_inventory;
  END
  $$

--
-- Create procedure `SPINV_Movement_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPINV_Movement_Process (IN In_organizationId varchar(20),
IN In_Warehouse varchar(35),
IN In_MDOCNO varchar(40),
IN In_MDOCLineNo varchar(20),
IN In_CustomerID varchar(35),
IN In_SKU varchar(60),
IN In_LotNUM varchar(40),
IN In_FMLocation varchar(40),
IN In_FMTraceID varchar(40),
IN In_FMQty_C varchar(20),
IN In_ToLocation varchar(40),
IN In_ToTraceID_CC varchar(40),
IN In_ToQty varchar(20),
IN In_ReasonCode varchar(20),
IN In_Reason varchar(20),
IN In_MovingTime varchar(20),
IN In_Language varchar(20),
IN In_UserID varchar(40),
INOUT OUT_Return_Code varchar(2000))
ENDPROC:
  BEGIN

    DECLARE r_QtyAllocated decimal(18, 8);
    DECLARE r_QtyRPOUT decimal(18, 8);
    DECLARE r_QtyMVOUT decimal(18, 8);
    DECLARE r_QtyMVIN decimal(18, 8);
    DECLARE r_QtyOnHold decimal(18, 8);
    DECLARE r_QtyRPIN decimal(18, 8);
    DECLARE r_QtyMoveHold decimal(18, 8);
    DECLARE r_QtyADJ decimal(18, 8);
    DECLARE r_TotalPrice decimal(18, 8);
    DECLARE r_TotalCubic decimal(18, 8);
    DECLARE r_TotalGrossWeight decimal(18, 8);
    DECLARE r_TotalNetWeight decimal(18, 8);
    DECLARE r_ToTotalPrice decimal(18, 8);
    DECLARE r_ToTotalCubic decimal(18, 8);
    DECLARE r_ToTotalGrossWeight decimal(18, 8);
    DECLARE r_ToTotalNetWeight decimal(18, 8);
    DECLARE r_LoseID_Flag varchar(1);
    DECLARE r_Return_VarC varchar(100);
    DECLARE r_TransactionID varchar(30);
    DECLARE R_CurrentTime timestamp;
    DECLARE r_AllowQty decimal(18, 8);
    DECLARE r_Mix_Flag varchar(1);
    DECLARE r_Mix_LotFlag varchar(1);
    DECLARE r_SKUCount int;
    DECLARE r_MovingTime_C timestamp;
    DECLARE r_LocationHold varchar(1);
    DECLARE r_MOV_HLD varchar(1);
    DECLARE r_FMZone varchar(30);
    DECLARE r_TOZone varchar(30);
    DECLARE r_MOV_BTW_ARA varchar(1);
    DECLARE r_MOV_BTW_WH varchar(1);
    DECLARE SP_SQL_r varchar(1000);
    DECLARE IN_FMQty decimal(18, 8);
    DECLARE IN_ToTraceID varchar(40);
    DECLARE r_MoveLock varchar(1);
    DECLARE r_QtyMVLock decimal(18, 8);
    DECLARE r_FMQty_Each_task decimal(18, 8);
    DECLARE r_LOTKEY01 varchar(1);
    DECLARE r_LOTKEY02 varchar(1);
    DECLARE r_LOTKEY03 varchar(1);
    DECLARE r_LOTKEY04 varchar(1);
    DECLARE r_LOTKEY05 varchar(1);
    DECLARE r_LOTKEY06 varchar(1);
    DECLARE r_LOTKEY07 varchar(1);
    DECLARE r_LOTKEY08 varchar(1);
    DECLARE r_LOTKEY09 varchar(1);
    DECLARE r_LOTKEY10 varchar(1);
    DECLARE r_LOTKEY11 varchar(1);
    DECLARE r_LOTKEY12 varchar(1);
    DECLARE r_LotAtt01 varchar(20);
    DECLARE r_LotAtt02 varchar(20);
    DECLARE r_LotAtt03 varchar(20);
    DECLARE r_LotAtt04 varchar(100);
    DECLARE r_LotAtt05 varchar(100);
    DECLARE r_LotAtt06 varchar(100);
    DECLARE r_LotAtt07 varchar(100);
    DECLARE r_LotAtt08 varchar(100);
    DECLARE r_LotAtt09 varchar(100);
    DECLARE r_LotAtt10 varchar(100);
    DECLARE r_LotAtt11 varchar(100);
    DECLARE r_LotAtt12 varchar(100);
    DECLARE r_CustomerID_LOT varchar(100);
    DECLARE r_SKU_LOT varchar(100);
    DECLARE r_TOLPN varchar(30);
    DECLARE r_FMINVQty decimal(18, 8);
    DECLARE r_TOLocationID_T varchar(60);
    DECLARE r_TOTraceID_T varchar(30);
    DECLARE r_TOQty_T decimal(18, 8);
    DECLARE r_WarehouseID varchar(35);
    DECLARE r_ToWarehouseid varchar(35);
    DECLARE r_OnHoldLocker int;
    DECLARE r_para2 varchar(200);
    DECLARE r_para3 varchar(200);
    DECLARE r_Para4 varchar(200);
    DECLARE r_LocationAttribute char(2);
    DECLARE r_UDF2 varchar(100);
    DECLARE r_qtytmp decimal(18, 8);
    DECLARE r_qty decimal(18, 8);
    DECLARE r_lpn varchar(40);
    DECLARE r_Status varchar(2);
    DECLARE r_MOV_TSK_SPL char(1);
    DECLARE r_TOQty decimal(18, 8);
    DECLARE r_TaskID varchar(30);
    DECLARE r_Taskid_Sequence int;
    DECLARE r_NewTaskID varchar(20);
    DECLARE r_fmpackid_T varchar(20);
    DECLARE r_topackid_T varchar(20);
    DECLARE r_lotatt11_T varchar(100);
    DECLARE r_lotatt12_T varchar(100);
    DECLARE r_lotnum_NEW varchar(10);
    DECLARE r_CP_BFR_CFM varchar(10);
    DECLARE r_MOV_CTL varchar(10);
    DECLARE r_packId varchar(40);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE v_TRN_TYP varchar(100);
    DECLARE returnVal varchar(100);
    DECLARE errormessage varchar(1000);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPINV_Movement_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;
    SET v_error = 1;
    IF Out_return_Code = 'NO_COMMIT'
      OR Out_return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;
    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;

    /*====start check overpallet====add 2025-06-13==== */
    CALL Z_CHECKOVERPALLETINLOC(In_organizationId, IN_Warehouse, In_ToLocation, In_SKU, In_ToQty, returnVal);
    SET OUT_Return_Code = CONCAT('_Percentace OverPallet! locationId= ', In_ToLocation);
    SET errorMessage = OUT_Return_Code;

    IF returnVal <> '000' THEN
      LEAVE ENDPROC;
    END IF;
    /*====end check overpallet====add 2025-06-13==== */

    SET R_CurrentTime = NOW();
    SET Out_Return_Code = '000';

    SET IN_FMQty = IN_FMQty_C;
    SET IN_ToTraceID = IFNULL(TRIM(IN_ToTraceID_CC), '*');

    SET OUT_Return_Code = '*_*';
    SET R_Para2 = CONCAT(TRIM(IN_MDOCNO), '%', IN_MDOCLineNo, '%', TRIM(IN_CustomerID)
    , '%', TRIM(IN_SKU), '%', TRIM(IN_LotNum));
    SET r_Para3 = CONCAT(TRIM(in_FMLocation), '%', TRIM(IN_FMTraceID), '%', IN_FMQty, '%',
    TRIM(IN_TOLocation), '%', TRIM(IN_ToTraceID), '%', IN_TOQty);
    SET r_Para4 = CONCAT(TRIM(IN_ReasonCode), '%', TRIM(IN_Reason), '%', TRIM(IN_MovingTime));
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'MV_BEFORE', r_Para2, r_Para3, r_para4, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;
    SET R_CurrentTime = NOW();
    SET r_MovingTime_C = DATE_FORMAT(IN_MovingTime, '%Y-%m-%d %H:%i:%s');
    SET OUT_Return_Code = '000';
    SET r_LocationHold = 'N';
    IF (IN_FMQty = 0
      OR IN_ToQty = 0) THEN
      SET OUT_Return_Code = '313';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;
    IF (IN_FMQty < 0
      OR IN_ToQty < 0) THEN
      SET OUT_Return_Code = '315';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    SELECT
      a.qty,
      a.lpn
    FROM INV_LOT_LOC_ID a
    WHERE a.organizationId = In_organizationId
    AND a.warehouseId = In_warehouse
    AND a.lotnum = IN_LotNUM
    AND a.locationid = IN_FMLocation
    AND a.traceid = IN_FMTraceID INTO r_qty, r_lpn;
    SET r_TOLPN = IFNULL(r_lpn, '*');
    IF r_qty <> IN_ToQty
      AND IFNULL(r_lpn, '*') NOT IN ('*', 'N')
      AND IN_FMLocation <> IN_ToLocation THEN
      SET OUT_Return_Code = '369';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;




    SET v_error = 1;
    SELECT
      IFNULL(a.Price, 0),
      IFNULL(a.Cubic, 0),
      IFNULL(a.GrossWeight, 0),
      IFNULL(a.NetWeight, 0),
      IFNULL(a.Qty, 0),
      b.zoneid,
      a.WarehouseID
    FROM INV_LOT_LOC_ID a
      INNER JOIN BAS_LOCATION b
        ON a.organizationId = b.organizationId
        AND a.warehouseid = b.warehouseId
        AND a.LocationID = b.LocationID
    WHERE a.organizationId = In_organizationId
    AND a.warehouseId = In_warehouse
    AND a.LotNum = IN_LotNUM
    AND a.Locationid = IN_FMLocation
    AND a.TraceId = IN_FMTraceID
    AND a.qty - a.qtyallocated - a.qtyrpout >= IN_ToQty INTO r_TotalPrice, r_TotalCubic, r_TotalGrossWeight, r_TotalNetWeight
    , r_FMINVQTY
    , r_FMZone
    , r_WarehouseID
    FOR UPDATE;
    IF v_error = 0 THEN
      SET OUT_Return_Code = '353';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    SET r_MOV_BTW_WH = getsys_configuration(In_organizationId, IN_Warehouse, IN_CustomerID, '*', 'MOV_BTW_WH');
    IF r_WarehouseID <> IN_Warehouse
      AND r_MOV_BTW_WH = 'N' THEN
      SET OUT_Return_Code = '366';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;


    SET IN_FMQty = r_FMINVQTY;
    IF r_FMINVQTY = 0 THEN
      SET OUT_Return_Code = '315';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;


    SET v_error = 1;
    SELECT
      SUM(FMQty_Each)
    FROM TSK_TASKLISTS
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND CustomerID = IN_CustomerID
    AND SKU = IN_SKU
    AND FMLotNUM = IN_LotNUM
    AND FMLocation = IN_FMLocation
    AND FMID = IN_FMTraceID
    AND TaskProcess = '00'
    AND TaskType = 'PA' INTO r_FMQty_Each_task;
    IF v_error = 0 THEN
      SET r_FMQty_Each_task = 0;
    END IF;
    IF in_ToQty > r_FMINVQTY - r_FMQty_Each_task THEN
      SET OUT_Return_Code = '317';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    SET v_error = 1;
    SELECT
      (a.cubic / a.toqty) * IN_ToQty,
      (a.GrossWeight / a.toqty) * IN_ToQty
    FROM DOC_MOVEMENT_DETAILS a
    WHERE a.organizationId = In_organizationId
    AND a.warehouseId = In_warehouse
    AND a.mdocno = IN_MDOCNO
    AND a.mdoclineno = IN_MDOCLineNo INTO r_ToTotalCubic, r_ToTotalGrossWeight;
    IF r_ToTotalCubic <= 0 THEN
      SET r_ToTotalCubic = (r_TotalCubic * IN_ToQty) / IN_FMQty;
    END IF;
    IF r_ToTotalGrossWeight <= 0 THEN
      SET r_ToTotalGrossWeight = (r_TotalGrossWeight * IN_ToQty) / IN_FMQty;
    END IF;
    IF v_error = 0 THEN
      SET r_ToTotalCubic = (r_TotalCubic * IN_ToQty) / IN_FMQty;
      SET r_ToTotalGrossWeight = (r_TotalGrossWeight * IN_ToQty) / IN_FMQty;
    END IF;

    SET r_ToTotalPrice = (r_TotalPrice * IN_ToQty) / IN_FMQty;
    SET r_ToTotalNetWeight = (r_TotalNetWeight * IN_ToQty) / IN_FMQty;



    SET v_error = 1;
    SELECT
      LocationAttribute
    FROM BAS_LOCATION
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND LocationID = IN_FMLocation INTO r_LocationAttribute;
    IF v_error = 0 THEN
      SET OUT_Return_Code = CONCAT('101', IN_FMLocation);
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;
    IF r_LocationAttribute IN ('HD', 'FO') THEN
      SET OUT_Return_Code = '441';
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;



    SET v_error = 1;
    SELECT
      LoseID_Flag,
      Mix_Flag,
      Mix_LotFlag,
      zoneid,
      LocationAttribute,
      SKUCount
    FROM BAS_LOCATION
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND LocationID = IN_ToLocation INTO r_LoseID_Flag, r_Mix_Flag, r_Mix_LotFlag, r_TOZone
    , r_LocationAttribute, r_SKUCount;
    IF v_error = 0 THEN
      SET OUT_Return_Code = CONCAT('101', IN_ToLocation);
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    SET v_error = 1;
    SELECT
      warehouseid
    FROM BAS_LOCATION t
    WHERE t.organizationId = In_organizationId
    AND t.locationid = IN_ToLocation
    LIMIT 1 INTO r_ToWarehouseid;
    IF r_ToWarehouseid <> '*'
      AND r_ToWarehouseid <> IN_Warehouse
      AND r_MOV_BTW_WH = 'N' THEN
      SET OUT_Return_Code = '366';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;
    IF v_error = 0 THEN
      SET OUT_Return_Code = CONCAT('101', IN_ToLocation);
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    IF r_LocationAttribute IN ('HD', 'FI') THEN
      SET OUT_Return_Code = '333';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;
    SELECT
      COUNT(1)
    FROM INV_LOT_LOC_ID
    WHERE LocationID = IN_ToLocation
    AND SKU IN (SELECT
        ConflictSKU
      FROM BAS_SKU_CONFLICT
      WHERE CustomerID = IN_CustomerID
      AND SKU = IN_SKU) INTO v_nRow;
    IF v_nRow <> 0 THEN
      SET OUT_Return_Code = '235';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;
    IF r_Mix_Flag IS NULL THEN
      SET r_Mix_Flag = 'Y';
    END IF;
    IF r_Mix_LotFlag IS NULL THEN
      SET r_Mix_LotFlag = 'Y';
    END IF;
    IF r_LoseID_Flag IS NULL THEN
      SET r_LoseID_Flag = 'N';
    END IF;


    SET r_MOV_BTW_ARA = getsys_configuration(In_organizationId, IN_Warehouse, IN_CustomerID, '*', 'MOV_BTW_ARA');



    SET r_MOV_HLD = getsys_configuration(In_organizationId, IN_Warehouse, IN_CustomerID, '*', 'MOV_HLD');
    IF r_FMZone <> r_TOZone
      AND r_MOV_BTW_ARA = 'N' THEN
      SET OUT_Return_Code = '314';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    SET v_nRow = 0;
    SELECT
      COUNT(1)
    FROM ACT_INVENTORYHOLD
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND HoldBy = '2'
    AND HoldFlag = 'Y'
    AND LocationID = IN_ToLocation INTO v_nRow;
    IF v_nRow = 1 THEN
      SET r_LocationHold = 'Y';
    END IF;



    IF r_LoseID_Flag = 'Y'
      AND IN_ToTraceID <> '*' THEN
      SET IN_ToTraceID = '*';
    END IF;
    IF IN_MDOCNO <> 'CONSOLIDATION' THEN

      IF IFNULL(IN_MDOCNO, '*') <> '*' THEN
        SET OUT_Return_Code = 'MV';
      END IF;
      IF r_MOV_HLD = 'Y' THEN
        SET OUT_Return_Code = '*_*SPINV_MOVEMENT_HLD';
      END IF;


    END IF;



    IF (r_Mix_Flag = 'N'
      OR r_SKUCount > 0)
      AND IN_ToLocation <> IN_FMLocation THEN
      SELECT
        COUNT(DISTINCT SKU)
      FROM INV_LOT_LOC_ID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND LocationID = IN_ToLocation
      AND SKU <> IN_SKU
      AND (Qty > 0
      OR QTYPA > 0
      OR QTYRPIN > 0
      OR QTYMVIN > 0) INTO v_nRow;
      IF r_Mix_Flag = 'N'
        AND v_nRow >= 1 THEN
        SET OUT_Return_Code = '205';
        SET r_Return_VarC = IN_ToLocation;
        SET OUT_Return_Code = CONCAT(OUT_Return_Code, r_Return_VarC);
        IF v_NO_COMMIT = 'Y' THEN
          ROLLBACK;
        END IF;
        LEAVE ENDPROC;
      ELSEIF r_Mix_Flag = 'Y'
        AND r_SKUCount > 0
        AND v_nRow >= r_SKUCount THEN
        SET OUT_Return_Code = CONCAT('367', r_SKUCount);
        IF v_NO_COMMIT = 'Y' THEN
          ROLLBACK;
        END IF;
        LEAVE ENDPROC;
      END IF;
    END IF;
    SET v_error = 1;
    SELECT
      LotAtt01,
      LotAtt02,
      LotAtt03,
      LotAtt04,
      LotAtt05,
      LotAtt06,
      LotAtt07,
      LotAtt08,
      LotAtt09,
      LotAtt10,
      LotAtt11,
      LotAtt12,
      CustomerID,
      SKU
    FROM INV_LOT_ATT
    WHERE organizationId = In_organizationId
    AND LotNum = IN_LotNUM INTO r_LotAtt01, r_LotAtt02, r_LotAtt03, r_LotAtt04, r_LotAtt05, r_LotAtt06
    , r_LotAtt07, r_LotAtt08, r_LotAtt09, r_LotAtt10, r_LotAtt11, r_LotAtt12
    , r_CustomerID_LOT, r_SKU_LOT;
    IF v_error = 0 THEN
      SET OUT_Return_Code = CONCAT('104', IN_LotNUM);
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    IF IFNULL(r_CustomerID_LOT, '*') <> IN_CustomerID
      OR IFNULL(r_SKU_LOT, '*') <> IN_SKU THEN
      SET OUT_Return_Code = '111';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    IF r_Mix_LotFlag = 'N' THEN
      IF IN_ToLocation <> IN_FMLocation THEN
        SET v_error = 1;
        SELECT
          LOTKEY01,
          LOTKEY02,
          LOTKEY03,
          LOTKEY04,
          LOTKEY05,
          LOTKEY06,
          LOTKEY07,
          LOTKEY08,
          LOTKEY09,
          LOTKEY10,
          LOTKEY11,
          LOTKEY12
        FROM BAS_SKU a
          INNER JOIN BAS_LOTID b
            ON a.organizationId = b.organizationId
            AND a.LotID = b.LotID
        WHERE a.organizationId = In_organizationId
        AND a.customerId = In_customerId
        AND a.sku = IN_SKU INTO r_LOTKEY01, r_LOTKEY02, r_LOTKEY03, r_LOTKEY04, r_LOTKEY05, r_LOTKEY06
        , r_LOTKEY07, r_LOTKEY08, r_LOTKEY09, r_LOTKEY10, r_LOTKEY11, r_LOTKEY12;
        IF v_error = 0 THEN
          SET OUT_Return_Code = '888From BAS_SKU*BAS_LOTID,OPEN';
          LEAVE ENDPROC;
        END IF;
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.warehouseId = c.warehouseId
            AND a.lotnum = c.lotnum
        WHERE a.organizationId = In_organizationId
        AND a.warehouseId = In_warehouse
        AND a.LocationID = IN_ToLocation
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '*') <> IFNULL(r_LotAtt01, '*') AND
            r_LOTKEY01 = 'Y') OR
            (IFNULL(c.lotatt02, '*') <> IFNULL(r_LotAtt02, '*') AND
            r_LOTKEY02 = 'Y') OR
            (IFNULL(c.lotatt03, '*') <> IFNULL(r_LotAtt03, '*') AND
            r_LOTKEY03 = 'Y') OR
            (IFNULL(c.lotatt04, '*') <> IFNULL(r_LotAtt04, '*') AND
            r_LOTKEY04 = 'Y') OR
            (IFNULL(c.lotatt05, '*') <> IFNULL(r_LotAtt05, '*') AND
            r_LOTKEY05 = 'Y') OR
            (IFNULL(c.lotatt06, '*') <> IFNULL(r_LotAtt06, '*') AND
            r_LOTKEY06 = 'Y') OR
            (IFNULL(c.lotatt07, '*') <> IFNULL(r_LotAtt07, '*') AND
            r_LOTKEY07 = 'Y') OR
            (IFNULL(c.lotatt08, '*') <> IFNULL(r_LotAtt08, '*') AND
            r_LOTKEY08 = 'Y') OR
            (IFNULL(c.lotatt09, '*') <> IFNULL(r_LotAtt09, '*') AND
            r_LOTKEY09 = 'Y') OR
            (IFNULL(c.lotatt10, '*') <> IFNULL(r_LotAtt10, '*') AND
            r_LOTKEY10 = 'Y') OR
            (IFNULL(c.lotatt11, '*') <> IFNULL(r_LotAtt11, '*') AND
            r_LOTKEY11 = 'Y') OR
            (IFNULL(c.lotatt12, '*') <> IFNULL(r_LotAtt12, '*') AND
            r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_Return_Code = CONCAT('206', RTRIM(IN_ToLocation));
          IF v_NO_COMMIT = 'Y' THEN
            ROLLBACK;
          END IF;
          LEAVE ENDPROC;
        END IF;

      END IF;
    END IF;



    SET r_MoveLock = 'N';
    SET r_QtyMVLock = 0;
    IF IN_MDOCNo <> '*' THEN

      SET v_error = 1;
      SELECT
        PlantoLocation,
        PlanTOID,
        PlanToQty_Each,
        TaskID,
        Taskid_Sequence,
        fmpackid,
        plantopackid,
        lotatt11,
        lotatt12
      FROM TSK_TASKLISTS
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND DocNo = in_MDOCNo
      AND DocLineNo = in_MDocLineNo
      AND TaskType = 'MV'
      AND TaskProcess <= '50' INTO r_TOLocationID_T, r_TOTraceID_T, r_TOQty_T, r_TaskID, r_Taskid_Sequence
      , r_fmpackid_T, r_topackid_T, r_lotatt11_T, r_lotatt12_T
      FOR UPDATE;
      IF v_error = 0 THEN
        SET v_nRow = 0;
      END IF;

      SET r_CP_BFR_CFM = getsys_configuration(In_organizationId, IN_Warehouse, IN_CustomerID, '*', 'CP_BFR_CFM');
      IF r_CP_BFR_CFM = 'Y' THEN
        IF v_nRow = 0 THEN
          SET OUT_Return_Code = '999#????????,????????';
          IF v_NO_COMMIT = 'Y' THEN
            ROLLBACK;
          END IF;
          LEAVE ENDPROC;
        END IF;

        SELECT
          COUNT(1)
        FROM ACT_TRANSACTION_LOG a
        WHERE a.organizationId = In_organizationId
        AND a.warehouseId = In_warehouse
        AND a.qc_taskid = r_TaskID
        AND a.qc_sequence = r_Taskid_Sequence
        AND a.transactiontype = 'CP' INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_Return_Code = '999#????????,????????';
          IF v_NO_COMMIT = 'Y' THEN
            ROLLBACK;
          END IF;
          LEAVE ENDPROC;
        END IF;
      END IF;

      IF v_nRow > 0 THEN

        SET r_MOV_TSK_SPL = getsys_configuration(In_organizationId, IN_Warehouse, IN_CustomerID, '', 'MOV_TSK_SPL');
        IF r_MOV_TSK_SPL = 'N' THEN
          SET r_TOQty = r_TOQty_T;
        ELSE
          SET r_TOQty = IN_ToQty;
        END IF;

        IF r_TOTraceID_T IS NOT NULL THEN

          SELECT
            QtyMVIN - r_TOQty
          FROM INV_LOT_LOC_ID
          WHERE LotNum = IN_LOTNUM
          AND LocationID = r_TOLocationID_T
          AND TraceID = r_TOTraceID_T INTO r_qtytmp FOR UPDATE;
          IF r_qtytmp < 0 THEN
            SET OUT_Return_Code = '999#?????????????';
            IF v_NO_COMMIT = 'Y' THEN
              ROLLBACK;
            END IF;
            LEAVE ENDPROC;
          END IF;

          UPDATE INV_LOT_LOC_ID
          SET QtyMVIN = QtyMVIN - r_TOQty
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND LotNum = IN_LOTNUM
          AND LocationID = r_TOLocationID_T
          AND TraceID = r_TOTraceID_T;
        END IF;
        UPDATE INV_LOT_LOC_ID
        SET QtyMVOUT = QtyMVOUT - r_TOQty
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND LotNum = IN_LOTNUM
        AND LocationID = IN_FMLocation
        AND TraceID = IN_FMTraceID;

        IF r_TOQty_T > r_TOQty THEN
          SET OUT_Return_Code = '*_*';
          CALL SPCOM_GetIDSequence(In_organizationId, IN_Warehouse, IN_Language, 'TASKID', r_NewTaskID, OUT_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
            IF v_NO_COMMIT = 'Y' THEN
              ROLLBACK;
            END IF;
            LEAVE ENDPROC;
          END IF;
          SELECT
            MAX(mdoclineno)
          FROM DOC_MOVEMENT_DETAILS
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND MDOCNo = IN_MDOCNO INTO v_nRow;
          INSERT INTO TSK_TASKLISTS (organizationId, Taskid, Taskid_Sequence
          , Tasktype, Customerid, Sku, Doctype, Docno, Doclineno
          , Fmlotnum, Fmpackid, Fmuom, Fmqty, Fmqty_Each, Fmlocation, Logicalfmsequence, Fmid, Plantolotnum
          , Plantopackid, Plantouom, Plantoqty, Plantoqty_Each, Plantolocation, Planlogicaltosequence, Plantoid, Priority
          , Printflag, Taskprocess, Taskprocessmsg
          , Lotatt01, Lotatt02, Lotatt03, Lotatt04, Lotatt05, Lotatt06, Lotatt07, Lotatt08, Lotatt09, Lotatt10, Lotatt11, Lotatt12
          , Totalcubic, Totalgrossweight, Totalnetweight, Totalprice, warehouseid
          , Openwho, opentime, Closewho, closetime, editwho, Edittime, addwho, ADDTIME, Grouptaskid, Grouptasksequence)
            SELECT
              In_organizationId,
              r_NewTaskID,
              r_Taskid_Sequence,
              Tasktype,
              Customerid,
              Sku,
              Doctype,
              Docno,
              v_nRow + 1,
              Fmlotnum,
              Fmpackid,
              Fmuom,
              r_TOQty_T - r_TOQty,
              r_TOQty_T - r_TOQty,
              Fmlocation,
              Logicalfmsequence,
              Fmid,
              Plantolotnum,
              Plantopackid,
              Plantouom,
              r_TOQty_T - r_TOQty,
              r_TOQty_T - r_TOQty,
              Plantolocation,
              Planlogicaltosequence,
              Plantoid,
              Priority,
              Printflag,
              Taskprocess,
              Taskprocessmsg,
              Lotatt01,
              Lotatt02,
              Lotatt03,
              Lotatt04,
              Lotatt05,
              Lotatt06,
              Lotatt07,
              Lotatt08,
              Lotatt09,
              Lotatt10,
              Lotatt11,
              Lotatt12,
              Totalcubic,
              Totalgrossweight,
              Totalnetweight,
              Totalprice,
              warehouseid,
              IN_UserID,
              NOW(),
              Closewho,
              closetime,
              editwho,
              Edittime,
              addwho,
              ADDTIME,
              Grouptaskid,
              Grouptasksequence
            FROM TSK_TASKLISTS
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND TaskID = r_TaskID
            AND Taskid_Sequence = r_Taskid_Sequence;
          INSERT INTO DOC_MOVEMENT_DETAILS (mdocno, mdoclineno, mdoclinestatus, sku, fmlocation, fmid, tolocation,
          toid, fmqty, toqty, udf1, udf2, udf3, udf4, udf5, lotnum, descr_c,
          qtyallocated, qtyonhold, qtyavailable, cubic, grossweight, addwho,
          ADDTIME, editwho, edittime)
            SELECT
              mdocno,
              v_nRow + 1,
              mdoclinestatus,
              sku,
              fmlocation,
              fmid,
              tolocation,
              toid,
              fmqty - r_TOQty,
              0,
              udf1,
              udf2,
              udf3,
              udf4,
              udf5,
              lotnum,
              descr_c,
              qtyallocated,
              qtyonhold,
              qtyavailable,
              cubic,
              grossweight,
              IN_UserID,
              NOW(),
              IN_UserID,
              NOW()
            FROM DOC_MOVEMENT_DETAILS
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND mdocno = IN_MDOCNO
            AND mdocLineno = IN_MDOCLineNo;
        END IF;

        UPDATE TSK_TASKLISTS
        SET TaskProcess = '99',
            CloseWho = IN_UserID,
            CLoseTime = R_CurrentTime,
            editWho = IN_UserID,
            editTime = R_CurrentTime,
            plantoqty_each = IN_ToQty,
            plantoqty = IN_ToQty
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND Taskid = r_TaskID
        AND Taskid_Sequence = r_Taskid_Sequence;
        UPDATE DOC_MOVEMENT_DETAILS t
        SET t.toqty = IN_ToQty,
            t.mdoclinestatus = '10'
        WHERE t.organizationId = In_organizationId
        AND t.warehouseId = In_warehouse
        AND t.MDOCNo = IN_MDOCNO
        AND t.MDOCLINENO = IN_MDOCLineNo;
        SET r_QtyMVLock = IN_ToQty;
        SET r_MoveLock = 'Y';

        SELECT
          COUNT(1)
        FROM DOC_MOVEMENT_DETAILS md
        WHERE md.organizationId = In_organizationId
        AND md.warehouseId = In_warehouse
        AND md.MDOCNo = IN_MDOCNO
        AND md.mdoclinestatus <> '10' INTO v_nRow;
        IF v_nRow > 0 THEN
          SET r_Status = '05';
        ELSE


          SET r_MOV_CTL = getsys_configuration(In_organizationId, IN_Warehouse, IN_CustomerID, '*', 'MOV_CTL');
          IF r_MOV_CTL = 'Y' THEN
            SET r_Status = '99';
            UPDATE DOC_MOVEMENT_DETAILS
            SET mdoclinestatus = '99'
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND MDOCNo = IN_MDOCNO;
          ELSE
            SET r_Status = '10';
          END IF;

        END IF;

      END IF;
    END IF;
    UPDATE DOC_MOVEMENT_HEADER mh
    SET mh.status = IFNULL(r_Status, STATUS),
        mh.movementtime = R_CurrentTime
    WHERE mh.organizationId = In_organizationId
    AND mh.warehouseId = In_warehouse
    AND mh.mdocno = IN_MDOCNO;





    SET v_error = 1;
    SELECT
      QtyAllocated,
      QtyRPOUT,
      QtyMVOUT,
      QtyRPIN,
      QtyMVIN,
      QtyOnHold,
      OnHoldLocker
    FROM INV_LOT_LOC_ID
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND TraceID = IN_FMTraceID
    AND LocationID = IN_FMLocation
    AND LotNUM = IN_LotNUM INTO r_QtyAllocated, r_QtyRPOUT, r_QtyMVOUT, r_QtyRPIN, r_QtyMVIN, r_QtyOnHold
    , r_OnHoldLocker;
    IF v_error = 0 THEN
      SET OUT_Return_Code = '210';
      SET r_Return_VarC = CONCAT('@TraceID = ', IN_FMTraceID, '@Location = ', IN_FMLocation, 'IN_LotNUM = ', IN_LotNUM);
      SET OUT_Return_Code = CONCAT(OUT_Return_Code, r_Return_VarC);
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;
    SELECT
      COUNT(1)
    FROM TSK_TASKLISTS
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND tasktype = 'PA'
    AND TaskProcess = '00'
    AND FMID = IN_FMTraceID
    AND FMLocation = IN_FMLocation
    AND FMLotNum = IN_LOTNUM INTO v_nRow;
    IF r_MOV_HLD = 'Y'
      AND IN_FMQty = r_QtyOnHold
      AND IN_FMQty <> 0
      AND v_nRow <= 0 THEN
      SET r_AllowQty = IN_FMQty;
      SET r_QtyMoveHold = IN_ToQty;


      UPDATE ACT_INVENTORYHOLD
      SET TraceID = IN_TOTraceID,
          LocationID = IN_TOLocation
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND HoldBy = '5'
      AND TraceID = IN_FMTraceID
      AND LocationID = IN_FMLocation
      AND LotNUM = IN_LotNUM
      AND HoldFlag = 'Y';
      IF IN_ToQty <> IN_FMQty
        AND ROW_COUNT() > 0 THEN
        SET OUT_Return_Code = '324';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

    ELSE
      SET r_AllowQty = r_FMINVQTY - r_QtyAllocated - r_QtyRPOUT - r_QtyMVOut - r_QtyOnHold;


      SELECT
        r_AllowQty - IFNULL(SUM(B.ToQty), 0)
      FROM DOC_TRANSFER_DETAILS B
      WHERE B.organizationId = In_organizationId
      AND B.warehouseId = In_warehouse
      AND B.Fmlocation = IN_FMLocation
      AND B.fmLotnum = IN_LotNUM
      AND B.FMID = IN_FMTraceID
      AND B.TDOCLINESTATUS < '10' INTO r_AllowQty;
      SET r_QtyMoveHold = 0;
    END IF;

    SELECT
      IFNULL(SUM(QTY - TOQty), 0)
    FROM DOC_ADJ_DETAILS
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND adjLineStatus < '10'
    AND QTY > TOQTY
    AND TraceID = IN_FMTraceID
    AND LocationID = IN_FMLocation
    AND LotNUM = IN_LOTNUM INTO r_QtyADJ;
    SET r_AllowQty = r_AllowQty - r_QtyADJ;

    IF r_AllowQty < IN_ToQty THEN
      SET OUT_Return_Code = '312';
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;

    IF r_LocationHold = 'Y' THEN
      SET r_OnHoldLocker = r_OnHoldLocker + 1;
    END IF;

    SELECT
      COUNT(1)
    FROM ACT_INVENTORYHOLD
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND HoldBy = '2'
    AND HoldFlag = 'Y'
    AND LocationID = IN_FMLocation INTO v_nRow;
    IF v_nRow >= 1 THEN
      SET r_OnHoldLocker = r_OnHoldLocker - 1;
    END IF;



    SET OUT_Return_Code = 'NO_COMMIT';
    CALL SPCOM_GetIDSequence(In_organizationId, In_warehouse, IN_Language, 'TransactionID', r_TransactionID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;


    IF IN_FMTraceID <> IN_ToTraceID
      OR IN_FMLocation <> IN_ToLocation THEN
      UPDATE INV_LOT_LOC_ID
      SET Qty = Qty - IN_ToQty,
          QtyOnHold = QtyOnHold - r_QtyMoveHold,
          GrossWeight = GrossWeight - r_ToTotalGrossWeight,
          NetWeight = NetWeight - r_ToTotalNetWeight,
          Cubic = Cubic - r_ToTotalCubic,
          Price = Price - r_ToTotalPrice,
          editWho = IN_UserID,
          editTime = R_CurrentTime,
          OnHoldLocker = 99
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND TraceID = IN_FMTraceID
      AND LotNUM = IN_LotNUM
      AND LocationID = IN_FMLocation
      AND OnHoldLocker <> 99
      AND Qty >= IN_ToQty;
      IF ROW_COUNT() = 0 THEN
        IF v_NO_COMMIT = 'Y' THEN
          ROLLBACK;
        END IF;
        SET OUT_Return_Code = CONCAT('999#', SP_SQL_r);
        LEAVE ENDPROC;
      END IF;

      SELECT
        1
      FROM INV_LOT_LOC_ID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouse
      AND TraceID = IN_ToTraceID
      AND LotNUM = IN_LotNUM
      AND LocationID = IN_ToLocation INTO v_nRow FOR UPDATE;
      IF FOUND_ROWS() <= 0 THEN
        SET v_nRow = 0;
      END IF;
      IF v_nRow <= 0 THEN
        INSERT INTO INV_LOT_LOC_ID (organizationId, warehouseId, LocationID, LotNum, TraceID, CustomerID, SKU, QTy
        , QtyAllocated, QtyRPOUT, QtyMVOUT, QtyRPIN, QtyMVIN, QtyOnHold
        , Grossweight, NetWeight, Cubic, Price
        , OnHoldLocker
        , LPN
        , ADDTIME, AddWho, EditTime, EditWho
        , InLocTime)
          VALUES (In_organizationId, In_warehouse, IN_ToLocation, IN_LotNUM, IN_ToTraceID, IN_CustomerID, IN_SKU, IN_ToQty, 0, 0, 0, 0, 0, r_QtyMoveHold, r_ToTotalGrossWeight, r_ToTotalNetWeight, r_ToTotalCubic, r_ToTotalPrice, 0, R_TOLPN, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID, R_CurrentTime);
      ELSE
        UPDATE INV_LOT_LOC_ID
        SET Qty = Qty + IN_ToQty,
            QtyOnHold = IFNULL(QtyOnHold, 0) + r_QtyMoveHold,
            GrossWeight = GrossWeight + r_ToTotalGrossWeight,
            NetWeight = NetWeight + r_ToTotalNetWeight,
            Cubic = Cubic + r_ToTotalCubic,
            Price = Price + r_ToTotalPrice,
            OnHoldLocker = 0,
            LPN = r_TOLPN,
            editWho = IN_UserID,
            editTime = R_CurrentTime,
            InLocTime = (CASE WHEN Qty = 0 THEN R_CurrentTime ELSE InLocTime END)
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouse
        AND TraceID = IN_ToTraceID
        AND LotNUM = IN_LotNUM
        AND LocationID = IN_ToLocation;
      END IF;
    END IF;



    SET v_TRN_TYP = GETSYS_configuration(IN_OrganizationId, IN_Warehouse, IN_CustomerID, '', 'TRN_TYP');
    IF INSTR(v_TRN_TYP, 'AD') > 0 THEN
      SET r_UDF2 = 'N';
    ELSE
      SET r_UDF2 = 'O';
    END IF;


    SET v_error = 1;
    SELECT
      a.packid
    FROM BAS_SKU a
    WHERE a.organizationId = In_organizationId
    AND a.customerid = In_CustomerID
    AND a.sku = In_SKU INTO r_PackID;
    IF v_error = 0 THEN
      SET r_PackID = '*';
    END IF;

    INSERT INTO ACT_TRANSACTION_LOG (organizationId, TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
    , TransactionType
    , DocNo, DocLineNo, DocType
    , FMCustomerID, FMSku
    , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
    , ToCustomerID, ToSku
    , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
    , STATUS
    , WarehouseID
    , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
    , ReasonCode, Reason
    , ADDTIME, AddWho, EditTime, EditWho, TransactionTime
    , Edisendflag
    , Operator
    , fmlpn, tolpn)
      VALUES (In_organizationId, r_TransactionID, '*', '0', 'N', '*', '0', 'N', 'MV', IN_MDOCNO, IN_MDOCLineNo, 'MV', IN_CustomerID, IN_SKU, IN_LotNUM, IN_FMLocation, IN_FMTraceID, r_PackID, 'EA', IN_FMQty, IN_FMQty, IN_CustomerID, IN_SKU, IN_LotNUM, IN_ToLocation, IN_ToTraceID, r_PackID, 'EA', IN_ToQty, IN_ToQty, '99', r_WarehouseID, r_ToTotalCubic, r_ToTotalGrossWeight, r_ToTotalNetWeight, r_ToTotalPrice, IN_ReasonCode, IN_Reason, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID, r_MovingTime_C, r_UDF2, IN_UserID, r_lpn, r_TOLPN);

    SET r_lotnum_NEW = IN_LotNUM;
    IF IFNULL(r_fmpackid_T, '*') <> IFNULL(r_topackid_T, '*') THEN
      SET OUT_Return_Code = '*_*';
      CALL SPINV_Transfer_Process(In_organizationId, IN_Warehouse, '*', '0', IN_CustomerID, IN_SKU, IN_LotNUM, IN_ToLocation, IN_ToTraceID, IN_ToQty
      , IN_CustomerID, IN_SKU, IN_LotNUM, IN_ToLocation, IN_ToTraceID, IN_ToQty, 0
      , r_lotatt01, r_lotatt02, r_lotatt03, r_lotatt04, r_lotatt05, r_lotatt06
      , r_lotatt07, r_lotatt08, r_lotatt09, r_lotatt10, r_lotatt11_T, r_lotatt12_T
      , NULL, NULL, TO_CHAR(R_CurrentTime, 'yyyy-mm-dd hh24:mi:ss'), r_totalgrossweight, r_totalnetweight, r_totalcubic, r_totalprice
      , IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        IF v_NO_COMMIT = 'Y' THEN
          ROLLBACK;
        END IF;
        LEAVE ENDPROC;
      END IF;
      SET r_lotnum_NEW = SUBSTRING(OUT_Return_Code, 4);
    END IF;







    SET OUT_Return_Code = 'NO_COMMIT';
    CALL spinv_hold_update(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, r_lotnum_NEW, IN_TOLocation, IN_TOTraceID, IN_Language, IN_UserID, OUT_Return_Code);
    IF NOT (SUBSTRING(OUT_Return_Code, 1, 3) = '000') THEN
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;
    SET OUT_Return_Code = 'NO_COMMIT';
    CALL spinv_hold_update(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNUM, IN_FMLocation, IN_FMTraceID, IN_Language, IN_UserID, OUT_Return_Code);
    IF NOT (SUBSTRING(OUT_Return_Code, 1, 3) = '000') THEN
      IF v_NO_COMMIT = 'Y' THEN
        ROLLBACK;
      END IF;
      LEAVE ENDPROC;
    END IF;


    SET OUT_Return_Code = '*_*';
    SET r_Para2 = CONCAT(TRIM(IN_MDOCNO), '%', IN_MDOCLineNo, '%', TRIM(IN_CustomerID)
    , '%', TRIM(IN_SKU), '%', TRIM(IN_LotNum));
    SET r_Para3 = CONCAT(TRIM(IN_FMLocation), '%', TRIM(IN_FMTraceID), '%', IN_FMQty, '%',
    TRIM(IN_TOLocation), '%', TRIM(IN_ToTraceID), '%', IN_TOQty);
    SET r_Para4 = CONCAT(TRIM(IN_ReasonCode), '%', TRIM(IN_Reason), '%', TRIM(IN_MovingTime));
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'MV_AFTER', r_Para2, r_Para3, r_para4, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;


    IF v_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `SPSO_ModifyPicking`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_ModifyPicking (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_AllocationDetailsID_C varchar(20),
IN IN_OrderNO varchar(20),
IN IN_OrderLineNO varchar(20),
IN IN_ToLotNUM varchar(20),
IN IN_ToLocation varchar(20),
IN IN_ToTraceID varchar(20),
IN IN_ToQty_C varchar(20),
IN IN_ToUOM varchar(20),
IN IN_ToPackID varchar(20),
IN IN_PickToLocation varchar(20),
IN IN_PickToTraceID varchar(20),
IN IN_PickTime_CC varchar(20),
IN IN_PickWho_C varchar(20),
IN IN_ShipTime_CC varchar(20),
IN IN_ShipWho_C varchar(20),
IN IN_Notes varchar(20),
IN IN_ReasonCode varchar(20),
IN IN_Reason varchar(20),
IN IN_Language varchar(20),
IN IN_UserID varchar(20),
OUT OUT_NewAllocationDetailsID varchar(20),
INOUT OUT_Return_Code varchar(100))
ENDPROC:
  BEGIN

    DECLARE IN_PickTime_C timestamp;
    DECLARE IN_ShipTime_C timestamp;
    DECLARE IN_ToQty decimal(18, 8);
    DECLARE IN_AllocationDetailsID varchar(30);
    DECLARE IN_ToLocationID_C varchar(20);
    DECLARE IN_ToTraceID_C varchar(20);
    DECLARE r_ToQty_Each decimal(18, 8);
    DECLARE R_QTY1_P decimal(18, 8);
    DECLARE R_QTY2_P decimal(18, 8);
    DECLARE R_QTY3_P decimal(18, 8);
    DECLARE R_QTY4_P decimal(18, 8);
    DECLARE R_QTY5_P decimal(18, 8);
    DECLARE R_UOMQty_Read decimal(18, 8);
    DECLARE R_QtyChanged decimal(18, 8);
    DECLARE R_QtyChanged_C decimal(18, 8);
    DECLARE R_CustomerID varchar(30);
    DECLARE R_Sku varchar(50);
    DECLARE R_LotNUM varchar(10);
    DECLARE R_UOM varchar(10);
    DECLARE R_LocationID varchar(20);
    DECLARE R_TraceID varchar(20);
    DECLARE R_Qty decimal(18, 8);
    DECLARE R_Qty_Each decimal(18, 8);
    DECLARE R_PackID varchar(40);
    DECLARE R_WaveNo varchar(20);
    DECLARE R_Status varchar(2);
    DECLARE R_SoftAllocationDetailsID varchar(10);
    DECLARE R_QtyAllocated_Each_Order decimal(18, 8);
    DECLARE R_QtySoftAllocated_Each_Order decimal(18, 8);
    DECLARE R_QtyAllocated_Order decimal(18, 8);
    DECLARE R_PackID_Order varchar(40);
    DECLARE R_UOM_Order varchar(10);
    DECLARE R_Status_Order varchar(2);
    DECLARE R_QtyOrdered_Each_Order decimal(18, 8);
    DECLARE R_LineStatus varchar(2);
    DECLARE R_QtyAllocated decimal(18, 8);
    DECLARE R_QtyRPOut decimal(18, 8);
    DECLARE R_QtyMVOut decimal(18, 8);
    DECLARE R_QtyRPIN decimal(18, 8);
    DECLARE R_QTY_Allocation_Soft decimal(18, 8);
    DECLARE R_PackID_Soft varchar(40);
    DECLARE R_UOM_Soft varchar(10);
    DECLARE R_QTY_each_Allocation_Soft decimal(18, 8);
    DECLARE R_TotalCubic_Task decimal(18, 8);
    DECLARE R_TotalGrossWeight_Task decimal(18, 8);
    DECLARE R_TotalNetWeight_Task decimal(18, 8);
    DECLARE R_TotalPrice_Task decimal(18, 8);
    DECLARE R_FMQty_Each_Task decimal(18, 8);
    DECLARE R_LotNum_Soft varchar(10);
    DECLARE R_Qty_Each_Soft decimal(18, 8);
    DECLARE R_Qty_Soft decimal(18, 8);
    DECLARE r_LostLocation varchar(20);
    DECLARE r_PickTotraceID varchar(20);
    DECLARE r_PickToLocation varchar(20);
    DECLARE r_DropID varchar(30);
    DECLARE r_InsertQty decimal(18, 8);
    DECLARE R_QtyOnHold decimal(18, 8);
    DECLARE SP_SQL_R varchar(10000);
    DECLARE R_CurrentTime timestamp;
    DECLARE r_NO_COMMIT varchar(1);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_softallocationrule varchar(20);
    DECLARE r_orderType varchar(20);
    DECLARE r_OverPreAllocation varchar(20);
    DECLARE r_qty_mv decimal(18, 8);
    DECLARE R_TransactionID varchar(30);
    DECLARE r_PCK_SS_MOV varchar(20);
    DECLARE r_Para3 varchar(1000);
    DECLARE r_overallocation char(1) DEFAULT 'N';
    DECLARE r_allocationrule varchar(30);
    DECLARE v_done char(2);
    DECLARE R_QtyOnHoldfor varchar(30);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPSO_ModifyPicking,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;
    BEGIN
      IF Out_return_Code = 'NO_COMMIT'
        OR Out_return_Code = '*_*' THEN
        SET r_NO_COMMIT := 'N';
      ELSE
        SET r_NO_COMMIT := 'Y';
      END IF;
      SET R_CurrentTime := NOW();

      SET IN_ToLocationID_C := IN_PickToLocation;
      SET IN_ToTraceID_C := IN_PickToTraceID;
      SELECT
        IN_AllocationDetailsID_C,
        IN_OrderNO,
        IN_OrderLineNO,
        IN_ToLotNUM,
        IN_ToLocation,
        IN_ToTraceID,
        IN_ToQty_C,
        IN_ToUOM,
        IN_ToPackID,
        IN_ToLocationID_C,
        IN_ToTraceID_C,
        IN_PickTime_CC,
        IN_PickWho_C,
        IN_ShipTime_CC,
        IN_ShipWho_C,
        IN_Notes,
        IN_Language,
        IN_UserID;

      SET IN_PickTime_C := DATE_FORMAT(IN_PickTime_CC, '%Y-%m-%d %H:%i:%s');
      SET IN_ShipTime_C := DATE_FORMAT(IN_ShipTime_CC, '%Y-%m-%d %H:%i:%s');
      SET IN_ToQty := IN_ToQty_C;
      SET IN_AllocationDetailsID := IN_AllocationDetailsID_C;

      SET OUT_Return_Code := '000';
      SET OUT_NewAllocationDetailsID := IN_AllocationDetailsID;
      BEGIN
        SELECT
          Qty,
          UOM,
          Qty_Each,
          PackID,
          WaveNo,
          Status,
          SoftAllocationDetailsID,
          LotNum,
          Location,
          TraceID,
          CustomerID,
          SKU,
          picktotraceid,
          PicktoLocation,
          DropID
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND AllocationDetailsID = IN_AllocationDetailsID INTO R_Qty, R_UOM, R_Qty_Each
        , R_PackID, R_WaveNo, R_Status
        , R_SoftAllocationDetailsID
        , R_LotNum, R_LocationID, R_TraceID
        , R_CustomerID, R_SKU
        , r_PickTotraceID, r_PickToLocation, r_DropID
        FOR UPDATE;

        IF v_done = 0 THEN
          SET OUT_Return_Code := CONCAT('406', IN_AllocationDetailsID);
          LEAVE endproc;
        END IF;
      END;

      IF IN_ToLocationID_C IS NULL THEN
        SET IN_ToLocationID_C := r_PickToLocation;
      END IF;
      IF IN_ToTraceID_C IS NULL THEN
        SET IN_ToTraceID_C := r_PickTotraceID;
      END IF;



      IF R_Status <> '40' THEN
        SET OUT_Return_Code := '411';
        ROLLBACK;
        LEAVE endproc;
      END IF;


      SET OUT_Return_Code := '*_*';



      CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'MODIFYPICKING_BEFORE', IN_AllocationDetailsID_C,
      r_Para3, IN_Reason, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE endproc;
      END IF;

      IF IFNULL(IN_ReasonCode, '*') <> '*' THEN
        SELECT
          WarehouseID,
          OrderType
        FROM DOC_ORDER_HEADER
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND OrderNo = IN_OrderNo INTO R_WarehouseID, r_orderType;
        IF IN_ReasonCode = 'SS' THEN
          SET r_PCK_SS_MOV := getsys_configuration(R_WarehouseID, R_CustomerID, r_orderType, 'PCK_SS_MOV', 'Y');
        END IF;
      END IF;
      IF r_PickTotraceID <> IN_TOTraceID_C THEN
        SET r_DropID := IN_TOTraceID_C;
      END IF;

      IF R_Qty = IN_ToQty
        AND R_LotNum = IN_ToLotNUM
        AND R_LocationID = IN_ToLocation
        AND R_TraceID = IN_ToTraceID
        AND r_UOM = IN_ToUOM THEN
        UPDATE ACT_ALLOCATION_DETAILS
        SET PickToTraceID = IN_ToTraceID_C,
            PickToLocation = IN_ToLocationid_C,
            dropID = r_DropID,
            PickedTime = IN_PickTime_C,
            PickedWho = IN_PickWho_C,
            ShipmentTime = IN_ShipTime_C,
            ShipmentWho = IN_ShipWho_C,
            NOtes = IN_Notes,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND AllocationDetailsID = IN_AllocationDetailsID
        AND OrderNo = IN_OrderNO
        AND OrderLineNO = IN_OrderLineNO;

        UPDATE TSK_TASKLISTS
        SET PlantoID = IN_ToTraceID_C,
            PlanToLocation = IN_ToLocationid_C,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND AllocationDetailsID = IN_AllocationDetailsID
        AND DOCNo = IN_OrderNO
        AND DOCLineNO = IN_OrderLineNO
        AND DOCType = 'SO'
        AND TaskProcess = '00';
        SET OUT_Return_Code := '000';
        IF r_NO_COMMIT = 'Y' THEN
          COMMIT;
        END IF;

        LEAVE endproc;
      END IF;

      SET R_InsertQty := 0;
      IF (R_LotNum <> IN_ToLotNUM)
        OR (R_LocationID <> IN_ToLocation)
        OR (R_TraceID <> IN_ToTraceID) THEN
        SET R_InsertQty := IN_ToQty;
        SET IN_ToQty := 0;
      END IF;

      BEGIN
        SELECT
          Qty
        FROM BAS_PACKAGE_DETAILS
        WHERE organizationId = IN_organizationId
        AND PackID = IN_ToPackID
        AND packUom = IN_ToUOM INTO R_UOMQty_Read;
        IF v_done = 0 THEN
          SET OUT_Return_Code := '888BAS_Package,OPEN';
        END IF;
      END;
      IF R_UOMQty_Read <= 0
        OR R_UOMQty_Read IS NULL THEN
        SET OUT_Return_Code := '114';
        LEAVE endproc;
      END IF;

      SET r_ToQty_Each := IN_ToQty * R_UOMQty_Read;
      SET r_QtyChanged := r_ToQty_Each - R_Qty_Each;
      SET R_QtyChanged_C := -R_QtyChanged / R_UOMQty_Read;

      IF R_QtyChanged > 0 THEN
      BEGIN
        SELECT
          Qty,
          QtyAllocated,
          QtyRPOUT,
          QtyMVOUT,
          QtyRPIN,
          QtyOnHold
        FROM INV_LOT_LOC_ID
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND LotNum = R_LotNum
        AND TraceID = R_TraceID
        AND LocationID = R_LocationID INTO R_QTY, R_QtyAllocated, R_QtyRPOut, R_QtyMVOut, R_QtyRPIN, R_QtyOnHold
        FOR UPDATE;
        IF v_done = 0 THEN
          SET OUT_Return_Code := CONCAT('888', 'INV_LOT_LOC_ID,OPEN');
          LEAVE endproc;
        END IF;
      END;

      BEGIN
        SELECT
          IFNULL(r.overallocation, 'N')
        FROM DOC_ORDER_DETAILS d
          LEFT JOIN RUL_ALLOCATION_HEADER r
            ON r.organizationId = d.organizationId
            AND r.allocationRuleId = d.allocationrule
        WHERE d.warehouseId = IN_warehouse
        AND d.orderno = IN_OrderNO
        AND d.orderlineno = IN_OrderLineNO INTO r_overallocation;
        IF v_done = 0 THEN
          SET r_overallocation := 'N';
        END IF;
      END;

      IF R_QTY - R_QtyRPOut
        - R_QtyMVOut
        - R_QtyAllocated
        - R_QtyOnHold
        + CASE WHEN r_overallocation = 'Y' THEN R_QtyRPIN ELSE 0 END
        < R_QtyChanged THEN
        SET OUT_Return_Code := '312';
        LEAVE endproc;
      END IF;
      END IF;

      IF R_WaveNO IS NULL THEN
        SET R_WaveNO := '*';
      END IF;
      UPDATE ACT_SOFTALLOCATION_DETAILS
      SET Hard_SoftFlag = 'HARD',
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE SoftAllocationDetailsID = R_SoftAllocationDetailsID;

      SET OUT_Return_Code := 'NO_COMMIT';
      CALL SPSO_DEAllocation_Process(IN_Warehouse, 'UnAllocation', 'By AllocationDetailsID'
      , R_WaveNO, IN_OrderNO, IN_OrderLineNO, IN_AllocationDetailsID
      , IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE endproc;
      END IF;

      IF IN_ReasonCode IN ('SS', 'DM')
        AND R_QtyChanged_C > 0 THEN
        IF r_PCK_SS_MOV = 'Y' THEN
          SET r_LostLocation := CONCAT('LOST_', R_WarehouseID);
          SET OUT_Return_Code := '*_*';
          BEGIN
            BEGIN
              SELECT
                Qty - QtyAllocated - QtyRPOUT - QtyMVOUT - QtyOnHold
              FROM INV_LOT_LOC_ID
              WHERE organizationId = IN_organizationId
              AND d.warehouseId = IN_warehouse
              AND LotNum = R_LotNum
              AND TraceID = R_TraceID
              AND LocationID = R_LocationID INTO r_qty_mv;
              IF v_done = 0 THEN
                SET OUT_Return_Code := CONCAT('888', 'INV_LOT_LOC_ID,OPEN');
                ROLLBACK;
                LEAVE endproc;
              END IF;
            END;
          END;
          CALL SPINV_Movement_Process(IN_Warehouse, IN_OrderNO, IN_OrderLineNO, r_CustomerID, R_SKU, IN_TOLotNum, IN_TOLocation, IN_TOTraceID, r_qty_mv,
          R_LostLocation, '*', r_qty_mv, IN_ReasonCode, 'Inventory Shortage',
          DATE_FORMAT(R_CurrentTime, '%Y-%m-%d %H:%i:%s'), IN_Language, IN_UserID, out_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
            ROLLBACK;
            LEAVE endproc;
          END IF;
        END IF;
        IF IN_ReasonCode = 'DM' THEN
          UPDATE BAS_LOCATION t
          SET t.locationattribute = 'SC'
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND locationid = IN_TOLocation;
          SET OUT_Return_Code := 'NO_COMMIT';
          CALL SPCOM_GetIDSequence(IN_Warehouse, IN_Language, 'TransactionID', R_TransactionID, OUT_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
            ROLLBACK;
            LEAVE endproc;
          END IF;
          INSERT INTO ACT_TRANSACTION_LOG (TransactionID, QC_TaskID, QC_Sequence, QC_Flag, PA_TaskID, PA_Sequence, PA_Flag
          , TransactionType, DocNo, DocLineNo, DocType
          , FMCustomerID, FMSku
          , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
          , ToCustomerID, ToSku
          , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
          , Status
          , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
          , AddTime, AddWho, EditTime, EditWho
          , TransactionTime, WarehouseID, Operator)
            VALUES (R_TransactionID, '*', 0, 'N', '*', 0, 'N', 'SC', IN_OrderNO, IN_OrderLineNO, 'SO', '*', '*', '*', IN_TOLocation, IN_ToTraceID, '*', '*', 0, 0, '*', '*', '*', IN_TOLocation, IN_ToTraceID, '*', '*', 0, 0, '99', 0, 0, 0, 0, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_CurrentTime, r_WarehouseID, IN_UserID);
        END IF;
      END IF;


      IF R_InsertQty > 0 THEN
        IF IFNULL(r_SoftAllocationDetailsID, '*') = '*' THEN
          SET OUT_Return_Code := '*_**_*';

        ELSE
          SET OUT_Return_Code := 'NO_COMMIT';
        END IF;
        CALL SPSO_InsertPicking(IN_Warehouse, R_WaveNo, IN_OrderNO, IN_OrderLineNO, R_CustomerID, R_SKU, IN_ToLotNUM, IN_ToLocation, IN_ToTraceID,
        R_InsertQty, IN_ToUOM, IN_ToPackID, IN_ToLocationID_C, IN_ToTraceID_C, IN_PickTime_C, IN_PickWho_C, IN_ShipTime_C,
        IN_ShipWho_C, 'NO_PCK', IN_Language, IN_UserID,
        OUT_NewAllocationDetailsID,
        OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE endproc;
        END IF;



        IF IN_USERID <> 'SYS' THEN
          UPDATE TSK_TASKLISTS
          SET HoldWho = IN_USERID,
              HoldTime = R_CurrentTime
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouse
          AND AllocationDetailsID = OUT_NewAllocationDetailsID
          AND DOCNo = IN_OrderNO
          AND DOCLineNO = IN_OrderLineNO
          AND DOCType = 'SO'
          AND TaskProcess = '00';
        END IF;

      ELSEIF IN_ReasonCode IN ('SS', 'DM')
        AND r_PCK_SS_MOV = 'Y' THEN
        CALL SPSO_HardAllocation_Process(IN_Warehouse, 'Allocation', 'By OrderNO + OrderLineNO', '*', IN_OrderNO, IN_OrderLineNO, IN_Language, IN_UserID, OUT_Return_Code);
      END IF;


      IF IFNULL(IN_ReasonCode, '*') NOT IN ('*', 'OK', 'NO_SPLIT')
        AND R_Qty_Each > 0 THEN
        INSERT INTO DOC_ORDER_EXCEPTION (OrderNo, OrderLineNo, AllocationDetailsID, ExceptionCode, ExceptionDescr, CustomerID,
        SKU, LocationID, TraceID, Qty_Each, ConfirmBy, ConfirmTime, Memo, LotNum, AddTime, AddWho, EditTime, EditWho, WarehouseID)
          VALUES (IN_OrderNo, IN_OrderLineNo, IN_AllocationDetailsID, IN_ReasonCode, IN_Reason, R_CustomerID, R_SKU, R_LocationID, R_TraceID, R_Qty_Each, '', NULL, '', R_LotNum, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID, R_WarehouseID);
      END IF;


      BEGIN
        SELECT
          QtyAllocated_Each,
          QtyOrdered_Each,
          QtySoftAllocated_Each,
          PackID,
          packUom,
          LineStatus,
          softallocationrule
        FROM DOC_ORDER_DETAILS
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND OrderNo = IN_OrderNO
        AND OrderLineNO = IN_OrderLineNO INTO r_QtyAllocated_Each_Order, R_QtyOrdered_Each_Order, R_QtySoftAllocated_Each_Order
        , R_PackID_Order, R_UOM_Order, R_Status_Order
        , r_softallocationrule
        FOR UPDATE;
        IF v_done = 0 THEN
          SET OUT_Return_Code := CONCAT('888', 'DOC_Order_Details,OPEN');
          LEAVE endproc;
        END IF;
      END;
      BEGIN
        SELECT
          qty
        FROM BAS_PACKAGE_DETAILS
        WHERE organizationId = IN_organizationId
        AND PackID = R_PackID_Order
        AND packUom = R_UOM_Order INTO R_UOMQty_Read;
        IF v_done = 0 THEN
          SET OUT_Return_Code := CONCAT('888', 'bas_Package,OPEN=', R_PackID_Order);
          LEAVE endproc;
        END IF;
      END;

      BEGIN
        SELECT
          IFNULL(OverPreAllocation, 'N')
        FROM RUL_SOFTALLOCATION_HEADER a
        WHERE a.organizationId = IN_organizationId
        AND a.softallocationid = r_softallocationrule INTO r_OverPreAllocation;
        IF v_done = 1 THEN
          SET r_OverPreAllocation := 'N';
          LEAVE endproc;
        END IF;
      END;

      SET R_QtyAllocated_Each_Order := R_QtyAllocated_Each_Order + R_QtyChanged;
      SET R_QtyAllocated_Order := R_QtyAllocated_Each_Order / R_UOMQty_Read;

      IF r_QtyOrdered_Each_Order < r_QtyAllocated_Each_Order
        AND R_QtyChanged > 0
        AND r_OverPreAllocation = 'N' THEN
        ROLLBACK;
        SET OUT_Return_code := '410';
        LEAVE endproc;
      END IF;


      IF IFNULL(r_SoftAllocationDetailsID, '*') <> '*' THEN
      BEGIN
        SELECT
          QTY_Allocation,
          PackID,
          UOM,
          QTY_each_Allocation,
          Lotnum,
          Qty_Each,
          Qty
        FROM ACT_SOFTALLOCATION_DETAILS
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouse
        AND SoftAllocationDetailsID = R_SoftAllocationDetailsID INTO R_QTY_Allocation_Soft, R_PackID_Soft, R_UOM_Soft
        , R_QTY_each_Allocation_Soft, R_LotNum_Soft
        , R_Qty_Each_Soft, R_Qty_Soft;
        IF v_done = 0 THEN
          SET R_QTY_Allocation_Soft := -999999;
        END IF;
      END;
      IF R_QTY_Allocation_Soft <> -999999 THEN
      BEGIN
        SELECT
          qty
        FROM BAS_PACKAGE_DETAILS
        WHERE organizationId = IN_organizationId
        AND PackID = R_PackID_Soft
        AND packUom = R_UOM_Soft INTO R_UOMQty_Read;
        IF v_done = 0 THEN
          SET OUT_Return_Code := CONCAT('888', 'bas_Package,OPEN=', R_PackID_Soft);
          LEAVE endproc;
        END IF;
      END;
      SET R_QTY_each_Allocation_Soft := R_QTY_each_Allocation_Soft + R_QtyChanged;
      SET R_QTY_Allocation_Soft := R_QTY_each_Allocation_Soft / R_UOMQty_Read;



      IF R_QtyChanged < 0
        OR R_Qty_Each_Soft >= R_QTY_each_Allocation_Soft THEN
        UPDATE ACT_SOFTALLOCATION_DETAILS
        SET QTY_each_Allocation = R_QTY_each_Allocation_Soft,
            QTY_Allocation = R_QTY_Allocation_Soft,
            editTime = R_CurrentTime,
            editwho = in_UserID
        WHERE organizationId = IN_organizationId
        AND warehouseid = IN_Warehouse
        AND SoftAllocationDetailsID = R_SoftAllocationDetailsID;
      ELSE
        ROLLBACK;
        SET OUT_Return_Code := '412';
        LEAVE endproc;
      END IF;
      END IF;
      ELSE
        SET R_QtySoftAllocated_Each_Order := R_QtySoftAllocated_Each_Order + R_QtyChanged;

      END IF;


      BEGIN
        SELECT
          TotalCubic,
          TotalGrossWeight,
          TotalNetWeight,
          TotalPrice,
          FMQty_Each
        FROM TSK_TASKLISTS
        WHERE organizationId = IN_organizationId
        AND warehouseid = IN_Warehouse
        AND AllocationDetailsID = IN_AllocationDetailsID
        AND DOCNo = IN_OrderNO
        AND DOCLineNO = IN_OrderLineNO
        AND DOCType = 'SO'
        AND TaskProcess = '00' INTO R_TotalCubic_Task, R_TotalGrossWeight_Task, R_TotalNetWeight_Task
        , R_TotalPrice_Task, R_FMQty_Each_Task;
        IF v_done = 0 THEN
          SET OUT_Return_Code := CONCAT('888Tsk_TaskLists,OPEN=''', IN_AllocationDetailsID, ''',''', IN_OrderNO, ''',', IN_OrderLineNO);
          ROLLBACK;
          LEAVE endproc;
        END IF;
      END;

      UPDATE ACT_ALLOCATION_DETAILS
      SET Qty = IN_ToQty,
          UOM = IN_ToUOM,
          Qty_Each = r_ToQty_Each,
          PackID = IN_ToPackID,
          PickToTraceID = IN_ToTraceID_C,
          PickToLocation = IN_ToLocationid_C,
          dropID = R_DropID,
          PickedTime = IN_PickTime_C,
          PickedWho = IN_PickWho_C,
          ShipmentTime = IN_ShipTime_C,
          ShipmentWho = IN_ShipWho_C,
          Cubic = (R_TotalCubic_Task / R_FMQty_Each_Task) * r_ToQty_Each,
          GrossWeight = (R_TotalGrossWeight_task / R_FMQty_Each_Task) * r_ToQty_Each,
          NetWeight = (R_TotalNetWeight_task / R_FMQty_Each_Task) * r_ToQty_Each,
          Price = (R_TotalPrice_Task / R_FMQty_Each_Task) * r_ToQty_Each,
          notes = IN_Notes,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseid = IN_Warehouse
      AND AllocationDetailsID = IN_AllocationDetailsID
      AND OrderNo = IN_OrderNO
      AND OrderLineNO = IN_OrderLineNO;



      UPDATE TSK_SORTATION_STATION
      SET CubicUsed = CubicUsed - (R_TotalCubic_Task / R_FMQty_Each_Task) * (R_FMQty_Each_Task - r_ToQty_Each)
      WHERE organizationId = IN_organizationId
      AND warehouseid = IN_Warehouse
      AND LocationID = IN_ToLocationid_C
      AND OrderNo = IN_OrderNO;
      DELETE
        FROM TSK_SORTATION_STATION
      WHERE CubicUsed = 0;


      IF IN_ToQty = 0 THEN
        DELETE
          FROM TSK_TASKLISTS
        WHERE organizationId = IN_organizationId
          AND warehouseid = IN_Warehouse
          AND AllocationDetailsID = IN_AllocationDetailsID
          AND DOCNo = IN_OrderNO
          AND DOCLineNO = IN_OrderLineNO
          AND DOCType = 'SO'
          AND TaskProcess = '00';
      ELSE
        UPDATE TSK_TASKLISTS
        SET FMUOM = IN_ToUOM,
            FMQty = IN_ToQty,
            FMQty_Each = r_ToQty_Each,
            FMPackID = IN_ToPackID,
            PlanToPackID = IN_ToPackID,
            PlanToUOM = IN_ToUOM,
            PlanToQty = IN_ToQty,
            PlanToQty_Each = r_ToQty_Each,
            PlantoID = IN_ToTraceID_C,
            PlanToLocation = IN_ToLocationid_C,
            TotalCubic = (R_TotalCubic_Task / R_FMQty_Each_Task) * r_ToQty_Each,
            TotalGrossWeight = (R_TotalGrossWeight_task / R_FMQty_Each_Task) * r_ToQty_Each,
            TotalNetWeight = (R_TotalNetWeight_task / R_FMQty_Each_Task) * r_ToQty_Each,
            TotalPrice = (R_TotalPrice_Task / R_FMQty_Each_Task) * r_ToQty_Each,
            editTime = R_CurrentTime,
            editwho = in_UserID

        WHERE organizationId = IN_organizationId
        AND warehouseid = IN_Warehouse
        AND AllocationDetailsID = IN_AllocationDetailsID
        AND DOCNo = IN_OrderNO
        AND DOCLineNO = IN_OrderLineNO
        AND DOCType = 'SO'
        AND TaskProcess = '00';
      END IF;

      IF R_QtyOrdered_Each_order > R_QtyAllocated_Each_Order THEN
        SET R_LineStatus := '30';
      ELSE
        SET R_LineStatus := '40';
      END IF;
      IF R_QtyAllocated_Each_Order = 0 THEN
        IF R_QtyOrdered_Each_order > R_QtySoftAllocated_Each_Order THEN
          SET R_LineStatus := '10';
        ELSE
          SET R_LineStatus := '20';
        END IF;
      END IF;
      UPDATE DOC_ORDER_DETAILS
      SET QtyAllocated_Each = R_QtyAllocated_Each_Order,
          QtyAllocated = R_QtyAllocated_Order,
          QtySoftAllocated =
          CASE WHEN r_SoftAllocationDetailsID <> '*' THEN QtySoftAllocated ELSE R_QtySoftAllocated_EACH_Order / R_UOMQty_Read END,
          QtySoftAllocated_each =
          CASE WHEN r_SoftAllocationDetailsID <> '*' THEN QtySoftAllocated_Each ELSE R_QtySoftAllocated_Each_Order END,
          LineStatus = R_LineStatus,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseid = IN_Warehouse
      AND OrderNo = IN_OrderNO
      AND OrderLineNO = IN_OrderLineNO;

      UPDATE INV_LOT
      SET QtyAllocated = QtyAllocated + R_QtyChanged,
          QtyPreAllocated =
          CASE WHEN r_SoftAllocationDetailsID <> '*' THEN QtyPreAllocated ELSE QtyPreAllocated + r_QtyChanged END,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE LotNum = R_LotNum;

      UPDATE INV_LOT_LOC_ID
      SET QtyAllocated = QtyAllocated + R_QtyChanged,
          editTime = R_CurrentTime,
          editwho = in_UserID
      WHERE organizationId = IN_organizationId
      AND warehouseid = IN_Warehouse
      AND LotNum = R_LotNum
      AND TraceID = R_TraceID
      AND LocationID = R_LocationID;
      IF R_WaveNO IS NULL THEN
        SET R_WaveNO := '*';
      END IF;
      IF R_QtyChanged > 0 THEN
        SET OUT_Return_Code := 'NO_COMMIT';
        CALL SPSO_ModifyLineStatus(IN_Warehouse, 'Allocation', 'By OrderNO + OrderLineNO', R_WaveNO, IN_OrderNO, IN_OrderLineNO, '', IN_Language, IN_UserID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE endproc;
        END IF;
      ELSE
        SET OUT_Return_Code := 'NO_COMMIT';
        CALL SPSO_ModifyLineStatus(IN_Warehouse, 'UnAllocation', 'By OrderNO + OrderLineNO', R_WaveNO, IN_OrderNO, IN_OrderLineNO, '', IN_Language, IN_UserID, OUT_Return_Code);
        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE endproc;
        END IF;
      END IF;

      IF R_QtyChanged < 0 THEN
        IF r_SoftAllocationDetailsID IS NOT NULL THEN
          SET OUT_Return_Code := 'NO_COMMIT';
          CALL SPSO_DESoftAllocation_Process(IN_Warehouse, 'UnSoftAllocation', 'By SoftAllocationDetailsID', R_WaveNO,
          IN_OrderNO, IN_OrderLineNO, R_SoftAllocationDetailsID, IN_Language, IN_UserID, OUT_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000'
            AND SUBSTRING(OUT_Return_Code, 1, 3) <> '001' THEN
            ROLLBACK;
            LEAVE endproc;
          END IF;
        END IF;

        IF IFNULL(IN_ReasonCode, '*') NOT IN ('*', 'OK', 'NO_SPLIT')
          AND R_Qty_Each - R_ToQty_Each > 0 THEN
          INSERT INTO DOC_ORDER_EXCEPTION (OrderNo, OrderLineNo, AllocationDetailsID, ExceptionCode, ExceptionDescr, CustomerID,
          SKU, LocationID, TraceID, Qty_Each, ConfirmBy, ConfirmTime, Memo, LotNum, AddTime, AddWho, EditTime, EditWho, WarehouseID)
            VALUES (IN_OrderNo, IN_OrderLineNo, IN_AllocationDetailsID, IN_ReasonCode, IN_Reason, R_CustomerID, R_SKU, R_LocationID, R_TraceID, R_Qty_Each - R_ToQty_Each, '', NULL, '', R_LotNum, R_CurrentTime, IN_UserID, R_CurrentTime, IN_UserID, R_WarehouseID);
        END IF;

        SET OUT_Return_Code := 'NO_COMMIT';

        IF IFNULL(IN_ReasonCode, '*') IN ('*', 'OK') THEN

          CALL SPSO_InsertPicking(IN_Warehouse, R_WaveNo, IN_OrderNO, IN_OrderLineNO, r_CustomerID, R_SKU, r_LotNUM, r_LocationID, r_TraceID,
          r_QtyChanged_C, IN_ToUOM, IN_ToPackID, r_PickToLocation, r_PickTotraceID, IN_PickTime_C, IN_PickWho_C, IN_ShipTime_C,
          IN_ShipWho_C, 'NO_PCK', IN_Language, IN_UserID,
          IN_AllocationDetailsID,
          OUT_Return_Code);

          IF IN_USERID <> 'SYS' THEN
            UPDATE TSK_TASKLISTS
            SET HoldWho = IN_USERID,
                HoldTime = R_CurrentTime
            WHERE organizationId = IN_organizationId
            AND warehouseid = IN_Warehouse
            AND AllocationDetailsID = IN_AllocationDetailsID
            AND DOCNo = IN_OrderNO
            AND DOCLineNO = IN_OrderLineNO
            AND DOCType = 'SO'
            AND TaskProcess = '00';
          END IF;



        ELSEIF IN_ReasonCode = 'NO_SPLIT' THEN
          SET OUT_Return_Code := '000';
        ELSEIF IN_ReasonCode IN ('SS', 'DM') THEN
          IF r_PCK_SS_MOV = 'Y' THEN
          BEGIN
          BEGIN
            SELECT
              Qty - QtyAllocated - QtyRPOUT - QtyMVOUT - QtyOnHold
            FROM INV_LOT_LOC_ID
            WHERE organizationId = IN_organizationId
            AND warehouseid = IN_Warehouse
            AND LotNum = R_LotNum
            AND TraceID = R_TraceID
            AND LocationID = R_LocationID INTO r_qty_mv;
            IF v_done = 0 THEN
              SET OUT_Return_Code := CONCAT('888', 'INV_LOT_LOC_ID,OPEN');
              ROLLBACK;
              LEAVE endproc;
            END IF;
          END;
          END;
          SET r_LostLocation := CONCAT('LOST_', R_WarehouseID);
          CALL SPINV_Movement_Process(IN_Warehouse, IN_OrderNO, IN_OrderLineNO, r_CustomerID, R_SKU, IN_TOLotNum, IN_TOLocation, IN_TOTraceID, r_qty_mv,
          R_LostLocation, '*', r_qty_mv, 'SS', 'Inventory Shortage',
          DATE_FORMAT(R_CurrentTime, '%Y-%m-%d %H:%i:%s'), IN_Language, IN_UserID, out_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
            ROLLBACK;
            LEAVE endproc;
          END IF;
          SET OUT_Return_Code := '*_*';
          CALL SPSO_HardAllocation_Process(IN_Warehouse, 'Allocation', 'By OrderNO + OrderLineNO', '*', IN_OrderNO, IN_OrderLineNO, IN_Language, IN_UserID, OUT_Return_Code);
          END IF;
          IF IN_ReasonCode = 'DM' THEN
            UPDATE BAS_LOCATION t
            SET t.locationattribute = 'SC'
            WHERE organizationId = IN_organizationId
            AND warehouseid = IN_Warehouse
            AND locationid = IN_TOLocation;
            SET OUT_Return_Code := 'NO_COMMIT';
            CALL SPCOM_GetIDSequence(IN_Warehouse, IN_Language, 'TransactionID', R_TransactionID, OUT_Return_Code);
            IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
              ROLLBACK;
              LEAVE endproc;
            END IF;
            INSERT INTO ACT_TRANSACTION_LOG (TransactionID, QC_TaskID, QC_Sequence, QC_Flag, PA_TaskID, PA_Sequence, PA_Flag
            , TransactionType, DocNo, DocLineNo, DocType
            , FMCustomerID, FMSku
            , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
            , ToCustomerID, ToSku
            , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
            , Status
            , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
            , AddTime, AddWho, EditTime, EditWho
            , TransactionTime, WarehouseID, Operator)
              VALUES (R_TransactionID, '*', 0, 'N', '*', 0, 'N', 'SC', IN_OrderNO, IN_OrderLineNO, 'SO', '*', '*', '*', IN_TOLocation, IN_ToTraceID, '*', '*', 0, 0, '*', '*', '*', IN_TOLocation, IN_ToTraceID, '*', '*', 0, 0, '99', 0, 0, 0, 0, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_CurrentTime, r_WarehouseID, IN_UserID);
            SET OUT_Return_Code := '000';
          END IF;
        END IF;

        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE endproc;
        END IF;
        SET OUT_NewAllocationDetailsID := IN_AllocationDetailsID;
      END IF;

      SET OUT_Return_Code := '*_*';
      CALL SPUDF_ProcessA(IN_organizationId, IN_Warehouse, 'MODIFYPICKING_AFTER', IN_AllocationDetailsID_C,
      r_Para3,
      IN_Reason, IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE endproc;
      END IF;




      IF r_NO_COMMIT = 'Y' THEN
        COMMIT;
      END IF;
      SET OUT_Return_Code := '000';
    END;
  END
  $$

--
-- Create procedure `SPINV_Movement_Consolidation`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPINV_Movement_Consolidation (IN In_organizationId varchar(20),
IN In_Warehouse varchar(20),
IN In_ProcessBy varchar(20),
IN In_TraceID_C varchar(20),
IN In_Location_C varchar(20),
IN In_ToID_CC varchar(20),
IN In_ToLocation varchar(20),
IN In_ReasonCode varchar(20),
IN In_Reason_C varchar(20),
IN In_MovingTime varchar(20),
IN In_Language varchar(20),
IN In_UserID varchar(20),
INOUT OUT_Return_Code varchar(20))
ENDPROC:
  BEGIN
    DECLARE r_CustomerID varchar(30);
    DECLARE r_SKU varchar(50);
    DECLARE r_LotNum varchar(10);
    DECLARE r_Qty decimal(18, 8);
    DECLARE r_CurrentTime timestamp;
    DECLARE r_AllocationDetailsID char(10);
    DECLARE r_PickToTraceID varchar(30);
    DECLARE r_PickToLocation varchar(60);
    DECLARE IN_TraceID varchar(30);
    DECLARE IN_Location varchar(60);
    DECLARE sp_SQL_r varchar(1000);
    DECLARE IN_ToID varchar(30);
    DECLARE r_Reason varchar(400);
    DECLARE r_LPN varchar(30);
    DECLARE r_Para3 varchar(200);
    DECLARE r_Para4 varchar(200);
    DECLARE r_SN_CTL varchar(1);
    DECLARE r_LoseID_Flag varchar(1);
    DECLARE r_LocationUsage varchar(10);
    DECLARE r_PCK_LOS_SN char(1);
    DECLARE r_MDOCNO varchar(30);
    DECLARE r_Move_Count int;
    DECLARE r_Tolocation varchar(60);
    DECLARE r_Toid varchar(30);
    DECLARE r_Toqty decimal(18, 8);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE Cur_Allocation CURSOR FOR
    SELECT
      AllocationDetailsID,
      PickToLocation,
      PickToTraceID
    FROM ACT_ALLOCATION_DETAILS
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND PickToTraceID = IN_TraceID
    AND STATUS = '60';
    DECLARE CUR_INV CURSOR FOR
    SELECT
      CustomerID,
      SKU,
      LotNum,
      a.LocationID,
      TraceID,
      Qty,
      IN_ToLocation AS ToLocation,
      IFNULL(IN_ToID, TraceID) AS TOID,
      Qty AS TOQty
    FROM INV_LOT_LOC_ID a
    WHERE a.organizationId = In_organizationId
    AND a.Warehouseid = IN_Warehouse
    AND (TraceID = IN_TraceID
    AND IN_ProcessBy = 'ID')
    AND Qty > 0
    UNION ALL
    SELECT
      CustomerID,
      SKU,
      LotNum,
      LocationID,
      TraceID,
      Qty,
      IN_ToLocation AS ToLocation,
      IFNULL(IN_ToID, TraceID) AS TOID,
      Qty AS TOQty
    FROM INV_LOT_LOC_ID
    WHERE organizationId = In_organizationId
    AND WarehouseId = IN_Warehouse
    AND (LocationID = IN_Location
    AND IN_ProcessBy = 'LOC')
    AND Qty > 0

    UNION ALL
    SELECT
      CustomerID,
      SKU,
      LotNum,
      a.LocationID,
      TraceID,
      Qty,
      IN_ToLocation AS ToLocation,
      IFNULL(IN_ToID, TraceID) AS TOID,
      Qty AS TOQty
    FROM INV_LOT_LOC_ID a
    WHERE a.organizationId = In_organizationId
    AND a.Warehouseid = IN_Warehouse
    AND (LPN = IN_TraceID
    AND IN_ProcessBy = 'LPN')
    AND Qty > 0


    UNION ALL
    SELECT
      B.CustomerID,
      B.SKU,
      A.LotNum,
      A.FMLocation,
      FMTraceID,
      FMQty,
      TOLocation,
      TOTraceID,
      TOQty
    FROM TMP_MOVE_Consolidation A
      INNER JOIN INV_LOT_ATT B
        ON A.LotNum = B.LotNUm
        AND B.organizationId = In_organizationId
    WHERE A.UserID = IN_UserID
    AND UPPER(IN_ProcessBy) = 'LIST'


    UNION ALL
    SELECT
      A.CustomerID,
      A.SKU,
      A.LotNum,
      A.LocationID,
      TraceID,
      Qty,
      IFNULL(r_PickToLocation, a.LocationID),
      TraceID,
      Qty
    FROM INV_LOT_LOC_ID a
    WHERE a.organizationId = In_organizationId
    AND a.Warehouseid = IN_Warehouse
    AND a.TraceID = IN_TraceID
    AND UPPER(IN_ProcessBy) = 'ID2LPN';

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SELECT
        CONCAT('999#SPINV_GeneratePutawayTask,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;
    IF Out_return_Code = 'NO_COMMIT'
      OR Out_return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET R_CurrentTime = NOW();
    SET Out_Return_Code = '000';

    SET IN_ToID = TRIM(IN_ToID_CC);
    SET IN_TraceID = IN_TraceID_C;
    SET IN_Location = IN_Location_C;
    SET r_Reason = IN_Reason_C;
    SET R_LPN = IN_TraceID;
    SET r_Move_Count = 0;

    SET r_Para3 = CONCAT(TRIM(IN_TraceID), '%', TRIM(IN_Location));
    SET r_Para4 = CONCAT(TRIM(IN_ToID), '%', TRIM(IN_ToLocation));
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'CONSOLIDATION_MV_BEFORE', IN_ProcessBy, r_para3, r_para4, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(out_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;
    IF IN_Location = IN_ToLocation
      AND IN_TraceID = IFNULL(IN_ToID, '*')
      AND IFNULL(IN_ProcessBy, '*') <> 'LIST' THEN
      SET OUT_Return_Code = '336';
      LEAVE ENDPROC;
    END IF;


    SET v_nRow = 0;
    IF IN_ProcessBy = 'ID' THEN
      SELECT
        COUNT(1)
      FROM ACT_ALLOCATION_DETAILS
      WHERE organizationId = In_organizationId
      AND Warehouseid = IN_Warehouse
      AND PickToTraceID = IN_TraceID
      AND STATUS = '60' INTO v_nRow;
      IF v_nRow > 0 THEN
        OPEN Cur_Allocation;
        SET v_error = 1;
        FETCH Cur_Allocation INTO r_AllocationDetailsID, r_PickToLocation, r_PickToTraceID;
        WHILE v_error <> 0 DO
          UPDATE ACT_ALLOCATION_DETAILS
          SET TraceID = r_PickToTraceID,
              Location = r_PickToLocation,
              PickToTraceID = IFNULL(IN_ToID, '*'),
              PickToLocation = IN_ToLocation,
              PickedWho = IN_UserID,
              PickedTime = R_CurrentTime,
              editWho = IN_UserID,
              editTime = R_CurrentTime
          WHERE organizationId = In_organizationId
          AND Warehouseid = IN_Warehouse
          AND AllocationDetailsID = r_AllocationDetailsID;
          SET OUT_Return_Code = 'NO_COMMIT';
          CALL SPSO_Picking_Process(In_organizationId, IN_Warehouse, 'MV', r_AllocationDetailsID, '', ''
          , IN_Language, IN_UserID, OUT_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
            ROLLBACK;
            CLOSE Cur_Allocation;
            LEAVE ENDPROC;
          END IF;
          IF v_NO_COMMIT = 'Y' THEN
            COMMIT;
          END IF;
          SET r_Move_Count = r_Move_Count + 1;
          SET v_error = 1;
          FETCH Cur_Allocation INTO r_AllocationDetailsID, r_PickToLocation, r_PickToTraceID;
        END WHILE;
        CLOSE Cur_Allocation;
        IF v_NO_COMMIT = 'Y' THEN
          COMMIT;
        END IF;
        SET OUT_Return_Code = '000';
        LEAVE ENDPROC;
      END IF;
    END IF;




    IF IN_ProcessBy = 'LPN' THEN

      SET r_REASON = CONCAT('LPN', IFNULL(IN_ToID, '*'));
    END IF;

    IF UPPER(IN_ProcessBy) = 'ID2LPN' THEN
      SET v_error = 1;
      SELECT
        LocationID
      FROM INV_LOT_LOC_ID
      WHERE organizationId = In_organizationId
      AND Warehouseid = IN_Warehouse
      AND LPN = IN_ToLocation
      LIMIT 1 INTO r_PickToLocation;
      IF v_error = 0 THEN
        SET r_PickToLocation = '';
      END IF;

    ELSEIF UPPER(IN_ProcessBy) IN ('ID', 'LOC') THEN
      SET v_error = 1;
      SELECT
        LoseID_Flag,
        LocationUsage
      FROM BAS_LOCATION
      WHERE organizationId = In_organizationId
      AND Warehouseid = IN_Warehouse
      AND LocationID = IN_TOLocation INTO r_LoseID_Flag, r_LocationUsage;
      IF r_LoseID_Flag = 'Y' THEN
        SET IN_ToID = '*';
      END IF;
      IF v_error = 0 THEN
        SET OUT_Return_Code = '999#???????';
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SET r_SN_CTL = getsys_configuration(In_organizationId, IN_Warehouse, '*', '*', 'SN#_CTL', '0');
      SET r_PCK_LOS_SN = getsys_configuration(In_organizationId, IN_Warehouse, '*', '*', 'PCK_LOS_SN#');

      IF r_SN_CTL IN ('1', '2') THEN
        IF UPPER(IN_ProcessBy) = 'ID' THEN
          IF IFNULL(IN_TraceID, '*') = '*' THEN
            SET OUT_Return_Code = '999#?????*???';
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
          IF r_LocationUsage = 'EA'
            AND r_LoseID_Flag = 'Y' THEN
            UPDATE DOC_ASN_SERIALNO
            SET EditWho = IN_UserID,
                EditTime = R_CurrentTime,
                LocationID = IN_ToLocation,
                TraceID = IFNULL(IN_ToID, TraceID),
                StockFlag = CASE WHEN r_PCK_LOS_SN = 'Y' THEN 'N' ELSE 'Y' END
            WHERE TraceID = IN_TraceID
            AND StockFlag = 'Y';
          ELSE
            UPDATE DOC_ASN_SERIALNO
            SET EditWho = IN_UserID,
                EditTime = R_CurrentTime,
                LocationID = IN_ToLocation,
                TraceID = IFNULL(IN_ToID, TraceID)
            WHERE organizationId = In_organizationId
            AND Warehouseid = IN_Warehouse
            AND TraceID = IN_TraceID
            AND StockFlag = 'Y';
          END IF;
          IF r_SN_CTL = '2' THEN
            IF r_LocationUsage = 'EA'
              AND r_LoseID_Flag = 'Y' THEN
              UPDATE DOC_ASN_SUBSERIALNO
              SET EditWho = IN_UserID,
                  EditTime = R_CurrentTime,
                  LocationID = IN_ToLocation,
                  TraceID = IFNULL(IN_ToID, TraceID),
                  SerialNo = '*',
                  SerialNoChangeLog = CONCAT((CASE WHEN SerialNoChangeLog IS NOT NULL THEN SerialNoChangeLog ELSE SerialNO END), '-- >*')
              WHERE organizationId = In_organizationId
              AND Warehouseid = IN_Warehouse
              AND TraceID = IN_TraceID
              AND StockFlag = 'Y';
            ELSE
              UPDATE DOC_ASN_SUBSERIALNO
              SET EditWho = IN_UserID,
                  EditTime = R_CurrentTime,
                  LocationID = IN_ToLocation,
                  TraceID = IFNULL(IN_ToID, TraceID)
              WHERE organizationId = In_organizationId
              AND Warehouseid = IN_Warehouse
              AND TraceID = IN_TraceID
              AND StockFlag = 'Y';
            END IF;
          END IF;
        ELSE
          IF r_LocationUsage = 'EA'
            AND r_LoseID_Flag = 'Y' THEN
            UPDATE DOC_ASN_SERIALNO
            SET EditWho = IN_UserID,
                EditTime = R_CurrentTime,
                LocationID = IN_ToLocation,
                TraceID = IFNULL(IN_ToID, TraceID),
                StockFlag = CASE WHEN r_PCK_LOS_SN = 'Y' THEN 'N' ELSE 'Y' END
            WHERE organizationId = In_organizationId
            AND Warehouseid = IN_Warehouse
            AND LocationID = IN_Location
            AND StockFlag = 'Y';
          ELSE
            UPDATE DOC_ASN_SERIALNO
            SET EditWho = IN_UserID,
                EditTime = R_CurrentTime,
                LocationID = IN_ToLocation,
                TraceID = IFNULL(IN_ToID, TraceID)
            WHERE organizationId = In_organizationId
            AND Warehouseid = IN_Warehouse
            AND LocationID = IN_Location
            AND StockFlag = 'Y';
          END IF;
          IF r_SN_CTL = '2' THEN
            IF r_LocationUsage = 'EA'
              AND r_LoseID_Flag = 'Y' THEN
              UPDATE DOC_ASN_SUBSERIALNO
              SET EditWho = IN_UserID,
                  EditTime = R_CurrentTime,
                  LocationID = IN_ToLocation,
                  TraceID = IFNULL(IN_ToID, TraceID),
                  SerialNo = '*',
                  SerialNoChangeLog = CONCAT((CASE WHEN SerialNoChangeLog IS NOT NULL THEN SerialNoChangeLog ELSE SerialNO END), '-- >*')
              WHERE organizationId = In_organizationId
              AND Warehouseid = IN_Warehouse
              AND LocationID = IN_Location
              AND StockFlag = 'Y';
            ELSE
              UPDATE DOC_ASN_SUBSERIALNO
              SET EditWho = IN_UserID,
                  EditTime = R_CurrentTime,
                  LocationID = IN_ToLocation,
                  TraceID = IFNULL(IN_ToID, TraceID)
              WHERE organizationId = In_organizationId
              AND Warehouseid = IN_Warehouse
              AND LocationID = IN_Location
              AND StockFlag = 'Y';
            END IF;
          END IF;
        END IF;
      END IF;

    END IF;

    OPEN Cur_INV;
    SET v_error = 1;
    FETCH Cur_INV
    INTO r_CustomerID, r_SKU, r_LotNum, IN_Location, IN_TraceID, r_Qty
    , r_ToLocation, r_TOID, r_TOQty;
    WHILE v_error <> 0 DO
      SET r_CustomerID = cRow_CUR_INV.Customerid;
      SET r_SKU = cRow_CUR_INV.Sku;
      SET r_LotNum = cRow_CUR_INV.Lotnum;
      SET r_Qty = cRow_CUR_INV.Qty;
      SET IN_TraceID = cRow_CUR_INV.TraceID;
      SET IN_Location = cRow_CUR_INV.Locationid;
      IF UPPER(IN_ProcessBy) <> 'ID2LPN' THEN
        SET r_PickToLocation = r_ToLocation;
      END IF;

      IF IN_ProcessBy = 'LOC' THEN
        SET IN_ToID = IN_TraceID;
      ELSEIF r_REASON LIKE 'LPN%' THEN
        SET IN_ToID = IN_TraceID;
      END IF;


      SET OUT_Return_Code = '*_*';
      CALL SPINV_Movement_Process(In_organizationId, IN_Warehouse
      , 'CONSOLIDATION'
      , 0, r_CustomerID, r_SKU, r_LotNum, IN_Location, IN_TraceID, r_Qty
      , r_Tolocation, r_Toid, r_Toqty
      , IN_ReasonCode, r_Reason, IN_MovingTime
      , IN_Language, IN_UserID, OUT_Return_Code);
      IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
        CLOSE CUR_INV;
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      IF v_NO_COMMIT = 'Y' THEN
        COMMIT;
      END IF;
      SET r_Move_Count = r_Move_Count + 1;
    END WHILE;
    CLOSE CUR_INV;
    IF IN_ProcessBy IN ('LPN', 'ID2LPN', 'ID') THEN
      DELETE
        FROM TMP_Empty_LocationLocker
      WHERE ID = IN_TraceID_C;
    END IF;
    IF IN_ProcessBy = 'ID2LPN' THEN
      UPDATE INV_LOT_LOC_ID a
      SET LPN = IN_ToLocation
      WHERE organizationId = In_organizationId
      AND Warehouseid = IN_Warehouse
      AND TraceID = IN_TraceID;
    END IF;

    SET OUT_Return_Code = '*_*';
    CALL SPUDF_ProcessA(In_organizationId, IN_Warehouse, 'CONSOLIDATION_MV_AFTER'
    , IN_ProcessBy, r_para3, r_para4, IN_Language
    , IN_UserID, OUT_Return_Code);
    IF SUBSTRING(out_Return_Code, 1, 3) <> '000' THEN
      LEAVE ENDPROC;
    END IF;

    IF r_Move_Count <= 0 THEN
      SET OUT_Return_Code = '353';
      LEAVE ENDPROC;
    ELSE
      SET OUT_Return_Code = '000';
    END IF;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `OJV_CML_SPBCD_Sku_1`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPBCD_Sku_1 (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_customerId varchar(30),
IN IN_supplierId varchar(30),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_SKU varchar(50),
OUT OUT_TRACEID varchar(50),
OUT OUT_QTY varchar(50),
OUT OUT_serialNo varchar(50),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE r_location varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE r_AllocationDetailsID char(20);
    DECLARE r_PickToTraceID varchar(30);
    DECLARE r_PickToLocation varchar(60);
    DECLARE r_CurrentTime timestamp;

    DECLARE Cur_Allocation CURSOR FOR
    SELECT
      AllocationDetailsID,
      PickToTraceID,
      PickToLocation
    FROM ACT_ALLOCATION_DETAILS
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND dropid = IN_barcode
    AND STATUS = '60';

    DECLARE Cur_INV CURSOR FOR
    SELECT
      PickToTraceID,
      PickToLocation
    FROM ACT_ALLOCATION_DETAILS
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND dropid = IN_barcode
    AND STATUS = '60';




    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;

      SELECT
        A.SKU INTO OUT_sku
      FROM BAS_SKU A
      WHERE A.organizationId = IN_organizationId
      AND A.CUSTOMERID = IN_customerId
      AND (A.ALTERNATE_SKU1 = IN_barcode
      OR A.SKU = IN_barcode)
      LIMIT 1;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_Sku,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;

    SET R_CurrentTime = NOW();
    SET OUT_SKU = IN_barcode;



    IF IN_operation = 'DROPID_MOVE_DROPID' THEN

      SELECT
        COUNT(1) INTO v_nrow
      FROM ACT_ALLOCATION_DETAILS A
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.dropId = IN_barcode;
      IF v_nrow = 0 THEN
        SET OUT_returnCode = 'Invalid DropID';
        LEAVE END_PROC;
      END IF;


      SELECT
        COUNT(1) INTO v_nrow
      FROM ACT_ALLOCATION_DETAILS A
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.dropId = IN_barcode
      AND A.status <> '60';
      IF v_nrow > 0 THEN
        SET OUT_returnCode = 'State error';
        LEAVE END_PROC;
      END IF;


      BEGIN
        SELECT
          A.location INTO OUT_TRACEID
        FROM ACT_ALLOCATION_DETAILS A
          LEFT JOIN BAS_LOCATION B
            ON A.organizationId = B.organizationId
            AND A.warehouseId = B.warehouseId
            AND A.location = B.locationId
        WHERE A.organizationId = IN_organizationId
        AND A.warehouseId = IN_warehouseId
        AND B.zoneId = 'DOCK'
        AND B.locationUsage = 'SS'
        AND (A.waveNo = (SELECT
            T.waveNo
          FROM ACT_ALLOCATION_DETAILS T
          WHERE T.organizationId = IN_organizationId
          AND T.warehouseId = IN_warehouseId
          AND T.dropId = IN_barcode
          AND T.STATUS < '80'
          LIMIT 0, 1)
        OR A.waveNo = '*')
        LIMIT 0, 1;


        IF v_error = 0 THEN
        BEGIN

          SET v_error = 1;
          SELECT
            A.locationId INTO OUT_TRACEID
          FROM BAS_LOCATION A
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.zoneId = 'DOCK'
          AND A.locationUsage = 'SS'
          AND NOT EXISTS (SELECT
              1
            FROM ACT_ALLOCATION_DETAILS T
            WHERE T.organizationId = IN_organizationId
            AND T.warehouseId = IN_warehouseId
            AND A.locationId = T.location
            AND T.STATUS < '80')
          ORDER BY A.pickLogicalSequence
          LIMIT 0, 1;


          IF v_error = 0 THEN
            SET OUT_returnCode := 'No available location';
            LEAVE END_PROC;
          END IF;

        END;
        END IF;
      END;
    END IF;


    IF IN_operation = 'DROPID_MOVE_CONFIRM' THEN
      OPEN Cur_INV;
      SET v_error = 1;
      FETCH Cur_INV INTO r_PickToTraceID, r_PickToLocation;
      WHILE v_error <> 0 DO

        CALL SPINV_Movement_Consolidation(In_organizationId, IN_warehouseId, 'ID', r_PickToTraceID, r_PickToLocation,
        r_PickToTraceID, IN_para1, '', '', r_CurrentTime
        , IN_Language, IN_UserID, OUT_returnCode);
        IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
          ROLLBACK;
          CLOSE Cur_INV;
          LEAVE END_PROC;
        END IF;
        IF v_NO_COMMIT = 'Y' THEN
          COMMIT;
        END IF;
        SET v_error = 1;
        FETCH Cur_INV INTO r_PickToTraceID, r_PickToLocation;
      END WHILE;
      CLOSE Cur_INV;

    END IF;


    IF IN_operation = 'SERIAL_PCK' THEN
    BEGIN
      SET OUT_QTY = 1;

      SELECT
        A.sku,
        A.subSerialNo INTO OUT_SKU, OUT_serialNo
      FROM DOC_ORDER_SUBSERIALNO A
      WHERE A.organizationId = In_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.allocationDetailsId = IN_para1
      AND A.subSerialNo = IN_barcode;


      IF v_error = 0 THEN
        SET OUT_returnCode := 'Wrong SerialNo';
        LEAVE END_PROC;
      END IF;
    END;
    END IF;

    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';



  END
  $$

--
-- Create procedure `OJV_CML_SPBCD_Sku`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPBCD_Sku (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_customerId varchar(30),
IN IN_supplierId varchar(30),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_SKU varchar(50),
OUT OUT_TRACEID varchar(50),
OUT OUT_QTY varchar(50),
OUT OUT_serialNo varchar(50),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE r_location varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE r_AllocationDetailsID char(20);
    DECLARE r_PickToTraceID varchar(30);
    DECLARE r_PickToLocation varchar(60);
    DECLARE r_CurrentTime timestamp;
    DECLARE r_sku varchar(100);

    DECLARE Cur_Allocation CURSOR FOR
    SELECT
      AllocationDetailsID,
      PickToTraceID,
      PickToLocation
    FROM ACT_ALLOCATION_DETAILS
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND dropid = IN_barcode
    AND STATUS = '60';

    DECLARE Cur_INV CURSOR FOR
    SELECT
      PickToTraceID,
      PickToLocation
    FROM ACT_ALLOCATION_DETAILS
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND dropid = IN_barcode
    AND STATUS = '60';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      -- 		IF IN_warehouseId = 'BASF01' AND LENGTH(IN_barcode) > 20 THEN
      -- 			SET IN_barcode = SUBSTRING(IN_barcode,4,8);
      -- 		END IF ;
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SELECT
        A.SKU INTO OUT_sku
      FROM BAS_SKU A
      WHERE A.organizationId = IN_organizationId
      AND A.CUSTOMERID = IN_customerId
      AND (A.ALTERNATE_SKU1 = IN_barcode
      OR A.SKU = IN_barcode)
      LIMIT 1;

      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_Sku,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
      SET OUT_SKU = IN_barcode;
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
        IF IN_OPERATION IN ('GETCOUNTINGTASK', 'QC', 'RCV', 'PCK', 'CHK', 'OTH', 'MOV', 'PACK', 'REP', 'PTA') THEN
          SELECT
            CASE WHEN
                IFNULL(bs.sku, 'ERROR') <> 'ERROR' THEN IFNULL(bs.sku, 'ERROR') ELSE IN_barcode END
          FROM BAS_SKU bs
          WHERE 1 = 1
          AND bs.organizationId = IN_organizationId
          AND bs.customerId = IN_customerId
          AND (bs.sku = IN_barcode
          OR bs.alternate_sku1 = IN_barcode
          OR bs.alternate_sku2 = IN_barcode
          OR bs.alternate_sku3 = IN_barcode
          OR bs.alternate_sku4 = IN_barcode
          OR bs.alternate_sku5 = IN_barcode)
          AND bs.activeFlag = 'Y' INTO r_sku;
          SET IN_barcode = r_sku;
        END IF;

        IF IN_OPERATION = 'INV_QUERY' THEN
          SELECT
            CASE WHEN
                IFNULL(bs.sku, 'ERROR') <> 'ERROR' THEN IFNULL(bs.sku, 'ERROR') ELSE IN_barcode END
          FROM BAS_SKU bs
          WHERE 1 = 1
          AND bs.organizationId = IN_organizationId
          AND bs.customerId = IN_customerId
          AND (bs.sku = IN_barcode
          OR bs.alternate_sku1 = IN_barcode
          OR bs.alternate_sku2 = IN_barcode
          OR bs.alternate_sku3 = IN_barcode
          OR bs.alternate_sku4 = IN_barcode
          OR bs.alternate_sku5 = IN_barcode) INTO r_sku;
          SET IN_barcode = r_sku;
        END IF;
    END IF;
    IF IN_warehouseId = 'BASF01'
      AND LENGTH(IN_barcode) > 20 THEN
      SET IN_barcode = SUBSTRING(IN_barcode, 4, 8);
    END IF;

    SET R_CurrentTime = NOW();
    SET OUT_SKU = IN_barcode;

    IF IN_operation = 'DROPID_MOVE_DROPID' THEN

      SELECT
        COUNT(1) INTO v_nrow
      FROM ACT_ALLOCATION_DETAILS A
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.dropId = IN_barcode;
      IF v_nrow = 0 THEN
        SET OUT_returnCode = 'Invalid DropID';
        LEAVE END_PROC;
      END IF;


      SELECT
        COUNT(1) INTO v_nrow
      FROM ACT_ALLOCATION_DETAILS A
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.dropId = IN_barcode
      AND A.status <> '60';
      IF v_nrow > 0 THEN
        SET OUT_returnCode = 'State error';
        LEAVE END_PROC;
      END IF;


      BEGIN
        SELECT
          A.location INTO OUT_TRACEID
        FROM ACT_ALLOCATION_DETAILS A
          LEFT JOIN BAS_LOCATION B
            ON A.organizationId = B.organizationId
            AND A.warehouseId = B.warehouseId
            AND A.location = B.locationId
        WHERE A.organizationId = IN_organizationId
        AND A.warehouseId = IN_warehouseId
        AND B.LOCATIONID LIKE 'STG%'
        AND (A.waveNo = (SELECT
            T.waveNo
          FROM ACT_ALLOCATION_DETAILS T
          WHERE T.organizationId = IN_organizationId
          AND T.warehouseId = IN_warehouseId
          AND T.dropId = IN_barcode
          AND T.STATUS < '80'
          LIMIT 0, 1)
        OR A.waveNo = '*')
        LIMIT 0, 1;


        IF v_error = 0 THEN
        BEGIN

          SET v_error = 1;
          SELECT
            A.locationId INTO OUT_TRACEID
          FROM BAS_LOCATION A
          WHERE A.organizationId = IN_organizationId
          AND A.warehouseId = IN_warehouseId
          AND A.LOCATIONID LIKE 'STG%'
          AND NOT EXISTS (SELECT
              1
            FROM ACT_ALLOCATION_DETAILS T
            WHERE T.organizationId = IN_organizationId
            AND T.warehouseId = IN_warehouseId
            AND A.locationId = T.pickToLocation
            AND T.STATUS < '80')
          ORDER BY A.pickLogicalSequence
          LIMIT 0, 1;


          IF v_error = 0 THEN
            SET OUT_returnCode := 'No available location';
            LEAVE END_PROC;
          END IF;

        END;
        END IF;
      END;
    END IF;


    IF IN_operation = 'DROPID_MOVE_CONFIRM' THEN
      OPEN Cur_INV;
      SET v_error = 1;
      FETCH Cur_INV INTO r_PickToTraceID, r_PickToLocation;
      WHILE v_error <> 0 DO

        CALL SPINV_Movement_Consolidation(In_organizationId, IN_warehouseId, 'ID', r_PickToTraceID, r_PickToLocation,
        r_PickToTraceID, IN_para1, '', '', r_CurrentTime
        , IN_Language, IN_UserID, OUT_returnCode);
        IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
          ROLLBACK;
          CLOSE Cur_INV;
          LEAVE END_PROC;
        END IF;
        IF v_NO_COMMIT = 'Y' THEN
          COMMIT;
        END IF;
        SET v_error = 1;
        FETCH Cur_INV INTO r_PickToTraceID, r_PickToLocation;
      END WHILE;
      CLOSE Cur_INV;

    END IF;


    IF IN_operation = 'SERIAL_PCK' THEN
    BEGIN
      SET OUT_QTY = 1;

      SELECT
        A.sku,
        A.subSerialNo INTO OUT_SKU, OUT_serialNo
      FROM DOC_ORDER_SUBSERIALNO A
      WHERE A.organizationId = In_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.allocationDetailsId = IN_para1
      AND A.subSerialNo = IN_barcode;


      IF v_error = 0 THEN
        SET OUT_returnCode := 'Wrong SerialNo';
        LEAVE END_PROC;
      END IF;
    END;
    END IF;

    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';



  END
  $$

--
-- Create procedure `SPCOM_GetIDSequence_NEW`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCOM_GetIDSequence_NEW (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_Language varchar(30),
IN IN_Sequence_Name varchar(30),
OUT OUT_ReturnNo varchar(40),
INOUT OUT_Return_Code varchar(1000))
BEGIN
  DECLARE r_ID_Sequence decimal(18, 0);
  DECLARE r_Max_ID_Sequence decimal(18, 0);
  DECLARE R_Length int;
  DECLARE r_Start_i int;
  DECLARE r_PreFix varchar(20);
  DECLARE r_LastDate varchar(8);
  DECLARE r_Date_Format varchar(10);
  DECLARE r_Date_Max varchar(10);
  DECLARE R_Date_Str varchar(8);
  DECLARE r_WarehouseID varchar(100);
  DECLARE r_MLT_WH char(1);
  DECLARE r_NO_Commit char(1);

  SET r_ID_Sequence = -1;
  SET R_Length = 0;
  IF OUT_Return_Code = '*_*'
    OR OUT_Return_Code = 'NO_COMMIT' THEN
    SET r_NO_Commit := 'N';
  ELSE
    SET r_NO_Commit := 'Y';
  END IF;

  IF GET_LOCK('my_procedure_lock', 10) THEN

    IF r_NO_Commit = 'Y' THEN
      START TRANSACTION;
    END IF;

    SELECT
      IDSEQUENCE,
      MaxIDSequence,
      LENGTH,
      PreFix,
      DATE_FORMAT(EditTime, '%Y%m%d'),
      DateFormat,
      Datemax,
      WareHouseID
    FROM SYS_IDSEQUENCE
    WHERE IDName = IN_Sequence_Name
    AND organizationId = IN_organizationId
    AND WareHouseID = IN_WarehouseID LIMIT 1 INTO r_ID_Sequence, r_Max_ID_Sequence, R_Length, r_PreFix, r_LastDate
    , r_Date_Format, r_Date_Max, r_WarehouseID;
    IF r_ID_Sequence = -1 THEN
      SELECT
        IDSequence,
        MaxIDSequence,
        LENGTH,
        PreFix,
        DATE_FORMAT(EditTime, '%Y%m%d'),
        DateFormat,
        Datemax,
        WareHouseID INTO r_ID_Sequence, r_Max_ID_Sequence, R_Length, r_PreFix, r_LastDate
      , r_Date_Format, r_Date_Max, r_WarehouseID
      FROM SYS_IDSEQUENCE
      WHERE IDName = IN_Sequence_Name
      AND organizationId = IN_organizationId
      AND WareHouseID = IN_WarehouseID LIMIT 1
      FOR UPDATE;
    END IF;
    IF r_ID_Sequence = -1 THEN
      SET OUT_Return_Code = '100';
      ROLLBACK;

    END IF;
    IF r_Date_Format = 'YYYY'
      OR r_Date_Format = 'YY'
      OR r_Date_Format = 'YYYYMM'
      OR r_Date_Format = 'YYMM'
      OR r_Date_Format = 'YYYYMMDD'
      OR r_Date_Format = 'YYMMDD' THEN
      SET r_Date_Str = DATE_FORMAT(NOW(), '%Y%m%d');
      IF r_Date_Format = 'YYYY' THEN
        SET r_Date_Str = SUBSTRING(r_Date_Str, 1, 4);
      ELSEIF r_Date_Format = 'YY' THEN
        SET r_Date_Str = SUBSTRING(r_Date_Str, 3, 2);
      ELSEIF r_Date_Format = 'YYYYMM' THEN
        SET r_Date_Str = SUBSTRING(r_Date_Str, 1, 6);
      ELSEIF r_Date_Format = 'YYMM' THEN
        SET r_Date_Str = SUBSTRING(r_Date_Str, 3, 4);
      ELSEIF r_Date_Format = 'YYYYMMDD' THEN
        SET r_Date_Str = SUBSTRING(r_Date_Str, 1, 8);
      ELSEIF r_Date_Format = 'YYMMDD' THEN
        SET r_Date_Str = SUBSTRING(r_Date_Str, 3, 6);
      END IF;

      IF r_Date_Str = IFNULL(r_Date_Max, '') THEN
        SET r_ID_Sequence = IFNULL(r_ID_Sequence, 0) + 1;
      ELSE
        SET r_ID_Sequence = 1;
        UPDATE SYS_IDSEQUENCE
        SET Datemax = r_Date_Str
        WHERE IDName = IN_Sequence_Name
        AND organizationId = IN_organizationId
        AND WarehouseID = r_WarehouseID;
      END IF;
    ELSE
      SET r_ID_Sequence = r_ID_Sequence + 1;
      IF r_ID_Sequence > r_Max_ID_Sequence THEN
        SET r_ID_Sequence = 1;
      END IF;
    END IF;
    IF r_PreFix = 'YYMMDD'
      OR r_PreFix = 'YYYYMMDD' THEN
      IF r_PreFix = 'YYMMDD' THEN
        SET r_PreFix = to_CHar(NOW(), 'YYMMDD');
      ELSEIF r_PreFix = 'YYYYMMDD' THEN
        SET r_PreFix = to_CHar(NOW(), 'YYYYMMDD');
      END IF;
      IF NOT (r_PreFix = r_LastDate
        OR substrb(r_PreFix, 3, 6) = r_LastDate) THEN
        SET r_ID_Sequence = 1;
      END IF;
    END IF;
    SET OUT_ReturnNo = TRIM(r_ID_Sequence);

    SET r_Start_i = LENGTH(OUT_ReturnNo) + 1;
    WHILE (r_Start_i <= R_Length) DO

      SET OUT_ReturnNo = CONCAT('0', OUT_ReturnNo);
      SET r_Start_i = r_Start_i + 1;
    END WHILE;
    IF r_Date_Str IS NOT NULL THEN
      SET OUT_ReturnNo = CONCAT(TRIM(r_Date_Str), OUT_ReturnNo);
    END IF;
    IF r_PreFix IS NOT NULL THEN
      SET OUT_ReturnNo = CONCAT(RTRIM(r_PreFix), OUT_ReturnNo);
    END IF;

    UPDATE SYS_IDSEQUENCE
    SET IDSequence = r_ID_Sequence,
        EditTime = NOW(),
        Datemax = r_Date_Str
    WHERE IDName = IN_Sequence_Name
    AND organizationId = IN_organizationId
    AND WarehouseID = r_WarehouseID;
    IF r_NO_Commit = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = CONCAT('000', RTRIM(OUT_ReturnNo));
    DO RELEASE_LOCK('my_procedure_lock');

  ELSE
    -- Handle the situation when the lock could not be obtained
    SELECT
      'The procedure is already running.';
  END IF;


END
$$

--
-- Create procedure `Z_sp_cycle_count_finding`
--
CREATE 
	DEFINER = 'mysql.sys'@'%'
PROCEDURE Z_sp_cycle_count_finding(
    IN p_organizationId VARCHAR(50),
    IN p_warehouseId VARCHAR(50),
    IN p_idDocumentCycle VARCHAR(50),
    IN p_groupIdTask VARCHAR(200),
    IN p_counting_qty DECIMAL(23, 8),
    IN p_position_cycle VARCHAR(3),
    IN p_SKU VARCHAR(50),
    IN p_TraceId VARCHAR(50),
    IN p_Batch VARCHAR(50),
    IN p_ExpDate VARCHAR(50),
    IN p_UOM VARCHAR(50),
    IN p_userId VARCHAR(50),
    IN p_location varchar(50),
    IN p_status varchar(50),
    IN p_skudescr varchar(100),
    OUT p_return_code VARCHAR(500)
)
sp_main: BEGIN
    DECLARE v_idDocumentDetailCycle VARCHAR(50);
    DECLARE v_skuDescr VARCHAR(500);
    DECLARE v_customerId VARCHAR(50);
    DECLARE v_location VARCHAR(50);
    DECLARE v_groupIdTaskFinal VARCHAR(200);
    DECLARE v_countingSequence VARCHAR(50);
    DECLARE v_expDateFormatted DATETIME;
    DECLARE v_errorMsg VARCHAR(500);
    DECLARE OUT_returnCode varchar(500);
    -- Declare handler untuk error
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        GET DIAGNOSTICS CONDITION 1
            v_errorMsg = MESSAGE_TEXT;
        ROLLBACK;
        SET p_return_code = v_errorMsg;
    END;
    
    -- Start transaction
    START TRANSACTION;
    
    -- Inisialisasi return code
    SET p_return_code = '000';
    
    -- Validasi parameter mandatory
    IF p_SKU IS NULL OR TRIM(p_SKU) = '' THEN
        SET p_return_code = '001';
        ROLLBACK;
        LEAVE sp_main;
    END IF;
    

    
    IF p_UOM IS NULL OR TRIM(p_UOM) = '' THEN
        SET p_return_code = '003';
        ROLLBACK;
        LEAVE sp_main;
    END IF;

    IF p_location IS NULL OR TRIM(p_location) = '' THEN
        SET p_return_code = '005';
        ROLLBACK;
        LEAVE sp_main;
        ELSE
      SET  v_location =p_location;
    END IF;

    IF p_status IS NULL OR TRIM(p_status) = '' THEN
        SET p_return_code = '006';
        ROLLBACK;
        LEAVE sp_main;
    END IF;

    
    -- Validasi document cycle exists
    IF NOT EXISTS (SELECT 1 FROM Z_CYCLECOUNT_HEADER WHERE idDocumentCycle = p_idDocumentCycle) THEN
        SET p_return_code = '004';
        ROLLBACK;
        LEAVE sp_main;
    END IF;
    -- Generate ID baru untuk detail
     SET OUT_returnCode = '*_*';
    CALL SPCOM_GetIDSequence_NEW('OJV_CML', '*', 'en', 'CYCLECOUNTIDDETAIL', v_idDocumentDetailCycle, OUT_returnCode);
    SET  v_idDocumentDetailCycle = CONCAT('F-',v_idDocumentDetailCycle);
    -- Ambil informasi dari header
    SELECT customerId 
    INTO v_customerId
    FROM Z_CYCLECOUNT_HEADER
    WHERE idDocumentCycle = p_idDocumentCycle
    LIMIT 1;
    

    -- Set location default jika tidak ditemukan
    IF v_location IS NULL THEN
        SET v_location = 'FINDING_LOC';
    END IF;


    SET v_skuDescr = p_skudescr;
    
    -- Tentukan groupIdTask berdasarkan position cycle
    IF p_position_cycle = 'C1' THEN
        -- Jika C1, gunakan existing groupIdTask
        SET v_groupIdTaskFinal = p_groupIdTask;


    ELSE
        -- Jika bukan C1 (C2 atau C3), buat groupIdTask baru
        SET v_groupIdTaskFinal = CONCAT('F', p_groupIdTask);
    END IF;
    

    
    -- Set deskripsi SKU default untuk finding

    
    -- Insert ke table Z_CYCLECOUNT_DETAIL
    INSERT INTO Z_CYCLECOUNT_DETAIL (
        idDocumentDetailCycle,
        idDocumentCycle,
        organizationId,
        warehouseId,
        countingSequence,
        location,
        sku,
        skuDescr,
        qtyOnHand,
        uom,
        status,
        batch,
        expDate,
        traceId,
        dateTransaction,
        count1,
        count2,
        count3,
        countFinal,
        countDifferent,
        countStatus,
        findingFlag,
        customerId,
        groupIdTask,
        noteText,
        addTime,
        addWho,
        count1Status,
        count2Status,
        count3Status,udf01,oprSeqFlag
    ) VALUES (
        v_idDocumentDetailCycle,
        p_idDocumentCycle,
        p_organizationId,
        p_warehouseId,
        IFNULL(v_countingSequence, 'FINDING'),
        v_location,
        p_SKU,
        v_skuDescr,
        0, -- qtyOnHand = 0 karena ini finding (SKU tidak seharusnya ada)
        p_UOM,
        p_status,
        p_Batch,
        p_ExpDate,
        p_TraceId,
        NOW(),
        CASE WHEN p_position_cycle = 'C1' THEN p_counting_qty ELSE NULL END,
        CASE WHEN p_position_cycle = 'C2' THEN p_counting_qty ELSE NULL END,
        CASE WHEN p_position_cycle = 'C3' THEN p_counting_qty ELSE NULL END,
        p_counting_qty, -- countFinal
        p_counting_qty, -- countDifferent (karena qtyOnHand = 0)
        CONCAT('FINDING_', p_position_cycle),
        'Y', -- findingFlag
        v_customerId,
        v_groupIdTaskFinal,
        CONCAT('Finding at ', p_position_cycle, ' - TraceId: ', p_TraceId),
        NOW(),
        p_userId,
        CASE WHEN p_position_cycle = 'C1' THEN 'Y' ELSE 'N' END,
        CASE WHEN p_position_cycle = 'C2' THEN 'Y' ELSE 'N' END,
        CASE WHEN p_position_cycle = 'C3' THEN 'Y' ELSE 'N' END ,'TO_C2',v_idDocumentDetailCycle
    );
    
    -- Update existing finding jika ada (untuk C2 atau C3)
    IF p_position_cycle IN ('C2', 'C3') THEN
        UPDATE Z_CYCLECOUNT_DETAIL
        SET count2 = CASE WHEN p_position_cycle = 'C2' THEN p_counting_qty ELSE count2 END,
            count3 = CASE WHEN p_position_cycle = 'C3' THEN p_counting_qty ELSE count3 END,
            count2Status = CASE WHEN p_position_cycle = 'C2' THEN 'Y' ELSE count2Status END,
            count3Status = CASE WHEN p_position_cycle = 'C3' THEN 'Y' ELSE count3Status END,
            countFinal = p_counting_qty,location=p_location,status=p_status,skuDescr=p_skudescr,
            editTime = NOW(),
            editWho = p_userId
        WHERE idDocumentCycle = p_idDocumentCycle
        AND sku = p_SKU
        AND traceId = p_TraceId
        AND location = v_location
        AND findingFlag = 'Y'
        AND idDocumentDetailCycle = v_idDocumentDetailCycle;
    END IF;
    
    COMMIT;
    SET p_return_code = '000'; -- Success
    
END sp_main
$$

--
-- Create procedure `Z_OT_SPLITDETAILS`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_OT_SPLITDETAILS (IN IN_organizationId varchar(255),
IN IN_warehouseId varchar(255),
IN IN_userId varchar(255),
IN IN_language varchar(255),
IN IN_customerId varchar(255),
IN IN_tariffMaster varchar(255))
BEGIN
  DECLARE v_total_minutes int;
  DECLARE v_total_hours decimal(5, 2);
  DECLARE v_day_type varchar(10);
  DECLARE v_day_of_week int;

  DECLARE done int DEFAULT FALSE;
  DECLARE v_label varchar(50);
  DECLARE v_lower decimal(5, 2);
  DECLARE v_upper decimal(5, 2);

  -- Untuk Ngetracking Time
  DECLARE v_start_time datetime;
  DECLARE v_segment_start datetime;
  DECLARE v_segment_end datetime;
  DECLARE v_segment_hours decimal(5, 2);
  DECLARE v_hours_in_category decimal(5, 2);
  DECLARE v_cost decimal(5, 2);
  DECLARE OUT_returnCode varchar(1000);

  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(255);
  DECLARE v_customerId varchar(255);
  DECLARE v_idOt varchar(255);
  DECLARE v_overtimeType varchar(255);
  DECLARE v_SBUSKU varchar(255);
  DECLARE v_employeeId varchar(255);
  DECLARE v_employeeName varchar(255);
  DECLARE v_employeePosition varchar(255);
  DECLARE v_timeIn datetime;
  DECLARE v_timeOut datetime;
  DECLARE v_breakTime decimal(5, 2);
  DECLARE v_totalOt decimal(5, 2);
  DECLARE v_Reason varchar(255);
  DECLARE v_codeType varchar(255);
  DECLARE v_codeId varchar(255);
  DECLARE v_outerCode varchar(255);
  DECLARE read_done int DEFAULT FALSE;
  DECLARE split_done int DEFAULT FALSE;

  DECLARE cat_cursor CURSOR FOR

  SELECT
    zto.organizationId,
    zto.warehouseId,
    zto.customerId,
    zto.idOt,
    zto.overtimeType,
    zto.SBUSKU,
    zto.employeeId,
    zto.employeeName,
    zto.employeePosition,
    zto.timeIn,
    zto.timeOut,
    zto.breakTime,
    zto.totalOt,
    zto.Reason,
    bcm.codeType,
    bcm.codeId,
    bm1.outerCode
  FROM Z_TEMP_OT zto
    LEFT JOIN BSM_CODE_ML bcm
      ON bcm.organizationId = zto.organizationId
      AND bcm.codeDescr = zto.overtimeType
      AND bcm.codeType = 'Z_OT_TYPE'
      AND bcm.languageId = 'en'
    LEFT JOIN BSM_CODE bm1
      ON bm1.organizationId = bcm.organizationId
      AND bm1.codeType = bcm.codeType
      AND bm1.codeId = bcm.codeId
  WHERE zto.organizationId = IN_organizationId
  AND zto.customerId = IN_customerId
  AND zto.warehouseId = IN_warehouseId
  AND zto.splitFlag = 'N';

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET read_done = TRUE;

  OPEN cat_cursor;

read_loop:
  LOOP
    FETCH cat_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_idOt, v_overtimeType, v_SBUSKU,
    v_employeeId, v_employeeName, v_employeePosition, v_timeIn, v_timeOut, v_breakTime, v_totalOt,
    v_Reason, v_codeType, v_codeId, v_outerCode;

    IF read_done THEN
      SET read_done = FALSE;
      LEAVE read_loop;
    END IF;

    BEGIN
      DECLARE b_organizationId varchar(255);
      DECLARE b_warehouseId varchar(255);
      DECLARE b_customerId varchar(255);
      DECLARE b_billingdate varchar(255);
      DECLARE b_tarrifid varchar(255);
      DECLARE b_tariffLineNo varchar(255);
      DECLARE b_chargeCategory varchar(255);
      DECLARE b_chargeType varchar(255);
      DECLARE b_descrC varchar(255);
      DECLARE b_ratebase varchar(255);
      DECLARE b_fixAmount varchar(255);
      DECLARE b_minAmount varchar(255);
      DECLARE b_MaterialNo varchar(255);
      DECLARE b_itemChargeCategory varchar(255);
      DECLARE b_UDF05 varchar(255);
      DECLARE b_divisionCode varchar(255);
      DECLARE b_UDF07 varchar(255);
      DECLARE b_UDF08 varchar(255);
      DECLARE b_contractNo varchar(255);
      DECLARE b_tariffMasterId varchar(255);
      DECLARE b_rate varchar(255);
      DECLARE b_udf02 decimal(5, 2); -- VARCHAR(255);
      DECLARE b_udf03 decimal(5, 2); -- VARCHAR(255);
      DECLARE b_udf04 varchar(255);
      DECLARE b_rateperunit varchar(255);
      DECLARE b_tariffClassNo varchar(255);
      DECLARE R_billsummaryId varchar(30) DEFAULT '';
      DECLARE R_billsummaryNo varchar(30) DEFAULT '';
      DECLARE split_details CURSOR FOR

      SELECT DISTINCT
        bcm.organizationId,
        bcm.warehouseId,
        bcm.customerId,
        DAY(STR_TO_DATE(CONCAT(YEAR(NOW()), '-', MONTH(NOW()), '-', bth.udf02), '%Y-%m-%d')) billingDate, -- change akbar 27-12-24 , correction fix date
        btd.tariffId,
        btd.tariffLineNo,
        btd.chargeCategory,
        btd.chargeType,
        btd.descrC,
        btd.ratebase,
        IF(btd.UDF03 = '', 0, btd.UDF03) AS fixAmount,
        btd.minAmount,
        btd.UDF01 AS MaterialNo,
        btd.udf02 AS itemChargeCategory,
        btd.UDF05,
        btd.UDF06 AS divisionCode,
        btd.UDF07,
        btd.UDF08,
        bth.contractNo,
        bth.tariffMasterId,
        btr.rate,
        btr.udf02,
        btr.udf03,
        btr.udf04,
        btr.ratePerUnit,
        btr.tariffClassNo
      FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
        INNER JOIN BAS_CUSTOMER bc
          ON bc.customerId = bcm.customerId
          AND bc.organizationId = bcm.organizationId
          AND bc.CustomerType = 'OW'
        INNER JOIN BIL_TARIFF_HEADER bth
          ON bth.organizationId = bcm.organizationId
          AND bth.tariffMasterId = bcm.tariffMasterId
        INNER JOIN BIL_TARIFF_DETAILS btd
          ON btd.organizationId = bth.organizationId
          AND btd.tariffId = bth.tariffId
          AND btd.chargeCategory = 'OV'
          AND btd.chargeType = v_outerCode
        INNER JOIN BIL_TARIFF_RATE btr
          ON btr.organizationId = btd.organizationId
          AND btr.tariffId = btd.tariffId
          AND btr.tariffLineNo = btd.tariffLineNo
      WHERE bcm.organizationId = IN_organizationId
      AND bcm.warehouseId = IN_warehouseId
      AND bcm.customerId = IN_customerId
      AND (DATE_FORMAT(v_timeIn, '%Y-%m-%d') BETWEEN bth.effectiveFrom AND bth.effectiveTo)
      ORDER BY bcm.organizationId, bcm.customerId, btd.chargeCategory, btd.chargeType, btr.tariffClassNo;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET split_done = TRUE;

      SET v_total_minutes = TIMESTAMPDIFF(MINUTE, v_timeIn, v_timeOut);
      SET v_total_hours = (v_total_minutes / 60) - v_breakTime;

      -- Start Time dikurangi Break
      SET v_start_time = v_timeIn + INTERVAL v_breakTime HOUR;

      OPEN split_details;

    read_loop1:
      LOOP
        FETCH split_details INTO b_organizationId, b_warehouseId, b_customerId, b_billingdate, b_tarrifid,
        b_tariffLineNo, b_chargeCategory, b_chargeType, b_descrC, b_ratebase,
        b_fixAmount, b_minAmount, b_MaterialNo, b_itemChargeCategory, b_UDF05,
        b_divisionCode, b_UDF07, b_UDF08, b_contractNo, b_tariffMasterId,
        b_rate, b_udf02, b_udf03, b_udf04, b_rateperunit, b_tariffClassNo;


        IF split_done THEN
          SET split_done = FALSE;
          LEAVE read_loop1;
        END IF;

        -- Itung jam sing masuk ning kategori iki
        IF v_total_hours > b_udf02 THEN   -- v_min_hour = b_udf02
          -- Yen max_hour NULL (unlimited), gunakake sisa jam kabeh
          IF b_udf03 IS NULL THEN -- v_max_hour = b_udf03
            SET v_hours_in_category = v_total_hours - b_udf02;
          ELSE
            -- Itung jam maksimal ning kategori iki
            SET v_hours_in_category = LEAST(v_total_hours, b_udf03) - b_udf02;
          END IF;

          -- Mung diproses yen ana jam ning kategori iki
          IF v_hours_in_category > 0 THEN

            -- SET v_cost = v_hours_in_category * v_hourly_rate;
            SELECT
              'TRAP 0 ',
              b_tariffClassNo,
              v_outerCode,
              v_total_hours,
              b_udf02,
              b_udf03,
              LEAST(v_total_hours, b_udf03),
              LEAST(v_total_hours, b_udf03) - b_udf02,
              v_hours_in_category;
            -- SELECT 'TRAP 1' , v_hours_in_category;

            -- Simpen data biaya ning tabel billing summary
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(b_organizationId, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE read_loop1;
              END IF;
            END IF;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                b_organizationId,
                b_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                -- DATE_FORMAT(b_billingdate, '%Y-%m-%d'),
                -- DATE_FORMAT(b_billingdate, '%Y-%m-%d'),
                DATE_FORMAT(v_timeOut, '%Y-%m-%d'),
                DATE_FORMAT(v_timeOut, '%Y-%m-%d'),
                b_customerId,
                '',
                '',
                '',
                b_tarrifid,
                b_chargeCategory,
                b_chargeType,
                b_udf04,
                b_ratebase,
                b_rateperunit, -- b_rate,
                v_hours_in_category,
                'HOURS', -- od_uom
                '0',
                '0',
                b_rate,-- b_rateperunit,
                v_hours_in_category * b_rate / b_rateperunit,
                v_hours_in_category * b_rate / b_rateperunit, -- 0 -- (v_segment_hours * (b_rate / b_rateperunit)) + (b_rate * (b_rate / b_rateperunit)) * R_INCOMETAX,
                0,
                0,
                0,
                NULL confirmTime,
                '' confirmWho,
                '' dockType,
                v_idOt docNo,
                '' createTransactionid,
                v_Reason notes,
                NULL ediSendTime,
                b_customerId billTo,
                NULL settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NULL costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NULL costSettleTime,
                '' costSettleWho,
                NULL incomeTaxRate,
                0 costTaxRate,
                NULL incomeTax,
                0 cosTax,
                NULL incomeWithoutTax,
                NULL cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                b_materialNo AS udf01,
                b_itemChargeCategory AS udf02,
                '' udf03,
                b_divisionCode udf04,
                NULL udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                'CUSTOMBILL' addWho,
                NOW() ADDTIME,
                'CUSTOMBILL' editWho,
                NOW() editTime,
                '' locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NULL ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;

          END IF;
        END IF;

      END LOOP;
      --		read_loop1;
      CLOSE split_details;
    END;

    SELECT
      'TRAP 2',
      v_idOt;

    UPDATE Z_TEMP_OT
    SET splitFlag = 'Y',
        editTime = NOW(),
        editWho = IN_userId
    WHERE organizationId = v_organizationId
    AND WarehouseId = v_warehouseId
    AND customerId = v_customerId
    AND idOt = v_idOt;

  END LOOP;
  --    SET v_outerCode=v_outerCode;
  CLOSE cat_cursor;

END
$$

--
-- Create procedure `Z_AUTOHOLD_DMG`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_AUTOHOLD_DMG (IN p_organizationId varchar(255),
IN p_warehouseId varchar(255),
IN p_customerId varchar(255),
IN p_language varchar(10),
IN p_user varchar(20),
INOUT OUT_Return_Code varchar(500))
BEGIN
  DECLARE done int DEFAULT FALSE;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(255);
  DECLARE v_customerId varchar(255);
  DECLARE v_idHold varchar(50);
  DECLARE v_sku varchar(255);
  DECLARE v_lotNum varchar(255);
  DECLARE v_locationId varchar(255);
  DECLARE v_traceId varchar(255);
  DECLARE v_muid varchar(255);
  DECLARE v_qtyAvailed_each decimal(18, 2);
  DECLARE v_transactionId varchar(50);

  -- Add a flag to track if any errors occurred
  DECLARE v_error_occurred boolean DEFAULT FALSE;

  DECLARE cur CURSOR FOR
  SELECT
    a.organizationId,
    a.warehouseId,
    a.customerId,
    a.SKU,
    a.lotnum,
    a.locationId,
    a.TRACEID,
    a.muid,
    a.qty - a.qtyAllocated - (a.qtyOnHold + 0) - a.qtyRpOut - a.qtyMvOut AS qtyAvailed_each
  FROM INV_LOT_LOC_ID a
    LEFT JOIN BAS_SKU bas_sku
      ON a.organizationId = bas_sku.organizationId
      AND bas_sku.customerId = a.customerId
      AND bas_sku.SKU = a.SKU
    LEFT JOIN BAS_CUSTOMER b
      ON a.organizationId = b.organizationId
      AND a.customerId = b.customerId
      AND b.customerType = 'OW'
    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
      ON a.organizationId = bsm.organizationId
      AND a.warehouseId = bsm.warehouseId
      AND a.customerId = bsm.customerId
      AND a.SKU = bsm.SKU
    LEFT JOIN BAS_PACKAGE_DETAILS t
      ON a.organizationId = t.organizationId
      AND CASE WHEN IFNULL(bsm.customerId, '') != '' THEN bsm.customerId ELSE bas_sku.customerId END = t.customerId
      AND CASE WHEN IFNULL(bsm.PACKID, '') != '' THEN bsm.PACKID ELSE bas_sku.PACKID END = t.PACKID
      AND CASE WHEN IFNULL(bsm.reportUom, '') != '' THEN bsm.reportUom ELSE bas_sku.reportUom END = t.packUom
    LEFT JOIN BAS_LOCATION d
      ON a.organizationId = d.organizationId
      AND a.warehouseId = d.warehouseId
      AND a.locationId = d.locationId
    LEFT JOIN BAS_ZONE h
      ON a.organizationId = h.organizationId
      AND a.warehouseId = h.warehouseId
      AND d.zoneId = h.zoneId
    LEFT JOIN BAS_ZONEGROUP BAS_ZONEGROUP
      ON a.organizationId = BAS_ZONEGROUP.organizationId
      AND a.warehouseId = BAS_ZONEGROUP.warehouseId
      AND h.zoneGroup = BAS_ZONEGROUP.zoneGroup
    LEFT JOIN INV_LOT_ATT ila
      ON a.organizationId = ila.organizationId
      AND a.lotnum = ila.lotnum
    LEFT JOIN BAS_PACKAGE_DETAILS l12p
      ON ila.organizationId = l12p.organizationId
      AND ila.customerId = l12p.customerId
      AND ila.lotatt12 = l12p.PACKID
      AND l12p.packUom = 'CS'
    LEFT JOIN (SELECT
        organizationId,
        warehouseId,
        locationId,
        lotnum,
        TRACEID,
        SUM(IFNULL(TOQTY, 0) - IFNULL(qty, 0)) AS toAdjQty
      FROM DOC_ADJ_DETAILS
      WHERE organizationId = p_organizationId
      AND warehouseId = p_customerId
      AND adjLineStatus < '10'
      GROUP BY organizationId,
               warehouseId,
               locationId,
               lotnum,
               TRACEID) adj
      ON adj.organizationId = a.organizationId
      AND adj.warehouseId = a.warehouseId
      AND adj.locationId = a.locationId
      AND adj.lotnum = a.lotnum
      AND adj.TRACEID = a.TRACEID
  WHERE a.organizationId = p_organizationId
  AND (a.qty > 0
  OR a.qtyRpIn > 0
  OR a.qtyMvIn > 0
  OR a.qtyPa > 0)
  AND (a.qty - a.qtyAllocated - (a.qtyOnHold + 0) - a.qtyRpOut - a.qtyMvOut) > 0
  AND a.warehouseId = p_warehouseId
  AND a.customerId = p_customerId
  AND ila.lotatt08 = 'Y'
  AND a.qtyOnHold = 0;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  -- Start transaction
  START TRANSACTION;

    OPEN cur;

  read_loop:
    LOOP
      FETCH cur INTO v_organizationId, v_warehouseId, v_customerId, v_sku, v_lotNum, v_locationId, v_traceId, v_muid, v_qtyAvailed_each;
      IF done THEN
        LEAVE read_loop;
      END IF;

      -- Process data here
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_sku,
        v_lotNum,
        v_locationId,
        v_traceId,
        v_muid,
        v_qtyAvailed_each;

      SET v_idHold = '';
      SET v_transactionId = '';

      -- Update INV_LOT_LOC_ID
      UPDATE INV_LOT_LOC_ID
      SET onHoldLocker = IFNULL(onHoldLocker, 0) + 1,
          qtyOnHold = v_qtyAvailed_each,
          editWho = p_user,
          currentVersion = currentVersion + 1,
          editTime = NOW()
      WHERE organizationId = p_organizationId
      AND customerId = v_customerId
      AND warehouseId = p_warehouseId
      AND lotnum = v_lotNum
      AND locationId = v_locationId
      AND TRACEID = v_traceId;

      -- Check if the update was successful
      IF ROW_COUNT() = 0 THEN
        SET v_error_occurred = TRUE;
        LEAVE read_loop;
      END IF;

      -- Update INV_LOT
      UPDATE INV_LOT
      INNER JOIN (SELECT
          SUM(QtyOnHold) qty,
          LotNum,
          organizationId,
          warehouseId
        FROM INV_LOT_LOC_ID h1
        WHERE h1.organizationId = v_organizationId
        AND h1.warehouseId = v_warehouseId
        AND h1.LotNUM = v_lotNum
        AND h1.locationId = v_locationId
        AND h1.traceId = v_traceId
        GROUP BY LotNum,
                 organizationId,
                 warehouseId) x
      SET editWho = p_user,
          editTime = NOW(),
          currentVersion = currentVersion + 1,
          INV_LOT.QtyOnHold = x.qty
      WHERE INV_LOT.organizationId = x.organizationId
      AND INV_LOT.warehouseId = x.warehouseId
      AND INV_LOT.LotNum = x.LotNum
      AND INV_LOT.organizationId = p_organizationId
      AND INV_LOT.warehouseId = p_warehouseId;

      -- Check if the update was successful
      IF ROW_COUNT() = 0 THEN
        SET v_error_occurred = TRUE;
        LEAVE read_loop;
      END IF;

      SET @linenumber = 0;
      SET OUT_Return_Code = '*_*';
      CALL SPCOM_GetIDSequence_NEW(p_organizationId, '*', p_language, 'INVENTORYHOLDID', v_idHold, OUT_Return_Code);

      IF (v_idHold <> '') THEN
        -- Insert into ACT_INVENTORYHOLD
        INSERT INTO `ACT_INVENTORYHOLD` (`organizationid`, `warehouseid`, `inventoryholdid`, `holdflag`, `holdby`, `holdcode`, `holdreason`, `customerid`, `sku`, `lotnum`, `locationid`, `traceid`, `qtyonhold`, `dateon`, `whoon`, `transactionid`, `oprseqflag`, `addwho`, `editwho`, `addtime`, `edittime`)
          VALUES (p_organizationId, v_warehouseId, v_idHold, 'Y', '5', 'DM', 'DM', v_customerId, v_sku, v_lotNum, v_locationId, v_traceId, v_qtyAvailed_each, NOW(), p_user, '*', '20250123150131000562RA172031009087[A2503]', p_user, p_user, NOW(), NOW());

        -- Check if the insert was successful
        IF ROW_COUNT() = 0 THEN
          SET v_error_occurred = TRUE;
          LEAVE read_loop;
        END IF;

        IF EXISTS (SELECT
              1
            FROM ACT_INVENTORYHOLD ai
            WHERE ai.organizationId = p_organizationId
            AND ai.customerId = v_customerId
            AND ai.lotNum = v_lotNum) THEN
          CALL SPCOM_GetIDSequence_NEW(p_organizationId, '*', p_language, 'TRANSACTIONID', v_transactionId, OUT_Return_Code);

          -- Insert into ACT_TRANSACTION_LOG
          -- **NOTE:** I've replaced the IN_* and R_* variables with their actual values or 
          -- with placeholders if I don't have enough context to know their values.
          -- Please replace the placeholders with the correct values.
          INSERT INTO ACT_TRANSACTION_LOG (organizationId, TransactionID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag, TransactionType,
          DocNo, DocLineNo, DocType, FMCustomerID, FMSku, FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each,
          ToCustomerID, ToSku, ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each, STATUS, TotalCubic,
          TotalGrossWeight, TotalNetWeight, TotalPrice, ReasonCode, Reason, WarehouseID, ADDTIME, AddWho, EditTime,
          EditWho, TransactionTime, Edisendflag, Operator)
            VALUES (p_organizationId, v_transactionId, 0, 'N', '*', '0', 'N', 'HD', v_transactionId, 5, '*', v_customerId, v_sku, v_lotNum, v_locationId, v_traceId, '*', 'EA', ABS(v_qtyAvailed_each), ABS(v_qtyAvailed_each),  -- Assuming R_QtyOnHold_Before is 0
            p_customerId, v_sku, v_lotNum, v_locationId, v_traceId, '*', 'EA', ABS(v_qtyAvailed_each), ABS(v_qtyAvailed_each),  -- Assuming R_QtyOnHold_Before is 0
            '99', 0, 0, 0, 0, 'OK', 'Damage', p_warehouseId, NOW(), p_user, NOW(), p_user, NOW(), 'N', p_user);

          -- Check if the insert was successful
          IF ROW_COUNT() = 0 THEN
            SET v_error_occurred = TRUE;
            LEAVE read_loop;
          END IF;
        END IF;
      END IF;
    END LOOP;

    CLOSE cur;

    -- Commit or rollback transaction based on error flag
    IF v_error_occurred THEN
      ROLLBACK;
      SET OUT_Return_Code = '#999';
    ELSE
      COMMIT;
      SET OUT_Return_Code = '000';
    END IF;
END
$$

--
-- Create procedure `OJV_CML_SPUDF_Process7`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE OJV_CML_SPUDF_Process7 (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE done int DEFAULT FALSE;
  DECLARE v_warehouseId varchar(255);
  DECLARE v_customerId varchar(255);

  -- Declare the cursor
  DECLARE cursorcustom CURSOR FOR
  SELECT
    bcr.warehouseId,
    bcr.customerId
  FROM BSM_CONFIG bc
    INNER JOIN BSM_CONFIG_ML bcm
      ON bc.organizationId = bcm.organizationId
      AND bc.configId = bcm.configId
    INNER JOIN BSM_CONFIG_RULES bcr
      ON bc.organizationId = bcr.organizationId
      AND bc.configId = bcr.configId
  WHERE bc.configId = 'DMG_HLD'
  AND bc.activeFlag = 'Y'
  AND bcr.configValue = 'Y';

  -- Declare a handler for the end of the cursor
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  -- Open the cursor
  OPEN cursorcustom;

-- Loop through the cursor
read_loop:
  LOOP
    -- Fetch the next row from the cursor
    FETCH cursorcustom INTO v_warehouseId, v_customerId;

    -- Exit the loop if no more rows
    IF done THEN
      LEAVE read_loop;
    END IF;


    --  SELECT v_warehouseId, v_customerId;



    SET @p_organizationId = IN_organizationId;
    SET @p_warehouseId = v_warehouseId;
    SET @p_customerId = v_customerId;
    SET @p_language = 'en';
    SET @p_user = IN_userId;
    SET @OUT_returnCode = '';
    CALL Z_AUTOHOLD_DMG(@p_organizationId, @p_warehouseId, @p_customerId, @p_language, @p_user, @OUT_returnCode);
    SELECT
      @OUT_returnCode;


  END LOOP;

  -- Close the cursor
  CLOSE cursorcustom;
END
$$

--
-- Create procedure `CML_BILL_MIN_CHARGE`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_BILL_MIN_CHARGE (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
ENDPROC:
  BEGIN
    -- Declare variables to hold cursor data
    DECLARE done int DEFAULT 0;
    DECLARE tariff_done int DEFAULT 0;
    DECLARE days_done int DEFAULT 0;
    DECLARE v_organizationId varchar(255);
    DECLARE v_warehouseId varchar(20);
    DECLARE v_customerId varchar(20);
    DECLARE v_qty_charge varchar(20);
    DECLARE v_type_handling varchar(20);
    /*  DECLARE v_qty_TraceId decimal(24, 8);
      DECLARE v_qty_MUID decimal(24, 8);
      DECLARE v_max_TraceId decimal(24, 8);
      DECLARE v_avg_TraceId decimal(24, 8);
      DECLARE v_max_MUID decimal(24, 8);
      DECLARE v_avg_MUID decimal(24, 8);
      DECLARE v_max_qty decimal(24, 8);
      DECLARE v_avg_qty decimal(24, 8);
      DECLARE v_qty decimal(24, 8);
      DECLARE v_max_qty_cbm decimal(24, 8);
      DECLARE v_avg_qty_cbm decimal(24, 8);
      DECLARE v_qty_cbm decimal(24, 8);
      DECLARE v_chargeType varchar(255);
      DECLARE v_countDays varchar(255);
      DECLARE v_storageType varchar(255);*/
    -- Declare for Billing
    DECLARE R_CURRENTDATE timestamp;
    DECLARE R_OPDATE varchar(10);
    DECLARE R_FMDATE varchar(10);
    DECLARE R_TODATE varchar(10);
    DECLARE R_BILLINGDAY int;
    DECLARE R_BILLINGDATE varchar(10);
    DECLARE R_Days int(11);
    DECLARE R_TARGETDATE varchar(10);
    DECLARE R_DAYOFMONTH int(11);
    DECLARE R_ORGANIZATIONID varchar(30);
    DECLARE R_WAREHOUSEID varchar(30);
    DECLARE R_CUSTOMERID varchar(30);
    DECLARE R_STOCKDATE varchar(10);
    DECLARE R_TARIFFID varchar(10);
    DECLARE R_TARIFFMASTERID varchar(20);
    DECLARE R_TARIFFLINENO int(11);
    DECLARE R_TARIFFCLASSNO int(11);
    DECLARE R_CHARGECATEGORY varchar(20);
    DECLARE R_CHARGETYPE varchar(20);
    DECLARE R_descrC varchar(50);
    DECLARE R_ratebase varchar(20);
    DECLARE R_docType varchar(20);
    DECLARE R_rate_udf03 varchar(50);
    DECLARE R_rateperunit decimal(24, 8);
    DECLARE R_rate decimal(24, 8);
    DECLARE R_minQty varchar(500);
    DECLARE R_minAmount decimal(24, 8);
    DECLARE R_maxAmount decimal(24, 8);
    DECLARE R_billQty decimal(24, 8);
    DECLARE R_Cost decimal(24, 8);
    DECLARE R_materialNo varchar(500);
    DECLARE R_itemChargeCategory varchar(500);
    DECLARE R_billMode varchar(500);
    DECLARE R_UDF03 varchar(500);
    DECLARE R_UDF06 varchar(500);
    DECLARE R_UDF07 varchar(500);
    DECLARE R_UDF08 varchar(500);
    DECLARE R_qtyMinimumContract decimal(24, 8);
    DECLARE R_chamberName varchar(500);
    DECLARE R_FINALAMOUNT decimal(24, 6);
    DECLARE R_billsummaryId varchar(30) DEFAULT '';
    DECLARE R_billsummaryNo varchar(30) DEFAULT '';
    DECLARE R_LOCATIONCAT char(2);
    DECLARE R_LOCATIONGROUP varchar(500);
    DECLARE R_INCOMETAX decimal(24, 8);
    DECLARE R_RESULTQTYCHARGE decimal(24, 6);  -- add for calculation
    DECLARE R_CLASSFROM decimal(24, 6);
    DECLARE R_CLASSTO decimal(24, 6);
    DECLARE R_CONTRACTNO varchar(100);
    DECLARE R_BILLINGMONTH varchar(10);
    DECLARE R_BILLINGPARTY varchar(10);
    DECLARE R_BILLINGTRANCATEGORY varchar(10);
    DECLARE R_BILLTO varchar(30);
    DECLARE R_NROW integer;
    DECLARE OUT_returnCode varchar(1000);


    -- Declare the cursor
    DECLARE my_cursor CURSOR FOR
    SELECT
      bl1.organizationId,
      bl1.warehouseId,
      bl1.customerId,
      SUM(bl1.qty) AS qtyCharge,
      bl1.type_handling
    FROM (SELECT
        bl.organizationId,
        bl.customerId,
        bl.warehouseId,
        bl.chargeCategory,
        bpd.uomDescr,
        CASE WHEN bpd.customerId = 'ONDULINE' THEN (
              CASE WHEN bpd.uomDescr = 'EA' AND
                  bl.chargeCategory IN ('IB', 'OB') THEN 'PALLET' WHEN bpd.uomDescr = 'PCS' AND
                  bl.chargeCategory = 'IB' THEN 'PALLET' ELSE 'QUANTITY' END) ELSE 'QUANTITY' END AS type_handling,
        CASE WHEN bpd.customerId = 'ONDULINE' THEN SUM(bl.cubic) ELSE SUM(bl.billingAmount / bl.chargeRate) END AS qty
      FROM BIL_SUMMARY bl
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
          ON bsm.organizationId = bl.organizationId
          AND bsm.customerId = bl.customerId
          AND bsm.warehouseId = bl.warehouseId
          AND bsm.sku = bl.sku
        LEFT JOIN BAS_PACKAGE_DETAILS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN BAS_PACKAGE_DETAILS bpd1
          ON bpd1.organizationId = bsm.organizationId
          AND bpd1.packId = bsm.packId
          AND bpd1.customerId = bsm.customerId
          AND bpd1.uomDescr = 'CS'
        LEFT JOIN BAS_PACKAGE_DETAILS bpd2
          ON bpd2.organizationId = bsm.organizationId
          AND bpd2.packId = bsm.packId
          AND bpd2.customerId = bsm.customerId
          AND bpd2.uomDescr = 'PL'
      WHERE bl.organizationId = IN_organizationId
      AND bl.warehouseId = IN_warehouseId
      AND bl.customerId = IN_CustomerId -- and bl.billingFromDate between '2025-04-26' and '2025-05-25'
      AND bl.chargeCategory IN ('IB', 'OB')
      AND bl.billingFromDate BETWEEN DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d') AND DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY) -- '2025-03-26' and '2025-04-25'
      GROUP BY bl.organizationId,
               bl.customerId,
               bl.warehouseId,
               bl.chargeCategory,
               bpd.customerId,
               bpd.packUom,
               bpd.uomDescr) bl1
    WHERE bl1.organizationId = IN_organizationId
    AND bl1.warehouseId = IN_warehouseId
    AND bl1.customerId = IN_CustomerId
    GROUP BY bl1.organizationId,
             bl1.customerId,
             bl1.warehouseId,
             bl1.type_handling;
    -- and bl1.type_handling = 'PALLET'
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

    -- Open the cursor
    OPEN my_cursor;

  -- Loop through the results
  read_loop:
    LOOP
      -- Fetch the values into variables
      FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_qty_charge, v_type_handling;

      -- Exit the loop if no more rows
      IF done = 1 THEN

        LEAVE read_loop;
      END IF;

      IF NOT EXISTS (SELECT
            1
          FROM BIL_SUMMARY bs
          WHERE bs.organizationId = v_organizationId
          AND bs.warehouseId = v_warehouseId
          AND bs.customerId = v_customerId
          AND bs.billingFromDate BETWEEN DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d') AND DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)
          --        AND bs.billingFromDate>= IN_datefrom
          --        AND bs.billingFromDate<= IN_dateto
          -- DATE(DATE_ADD(CURDATE(), INTERVAL -1 MONTH))
          -- AND DATE(bs.billingFromDate) = v_stockDate
          -- AND bs.descr = v_workingArea
          AND bs.chargeCategory = 'MC'
          AND bs.chargeType = 'MCB'
          AND bs.notes = v_type_handling
          AND bs.arNo IN ('*')) THEN


      BLOCK2:
        BEGIN
          DECLARE cur_Tariff CURSOR FOR
          SELECT DISTINCT
            bcm.organizationId,
            bcm.warehouseId,
            bcm.CUSTOMERID,
            DATE_FORMAT(DATE(DATE_ADD(bth.billingdate, INTERVAL -1 DAY)), '%d') AS billingDate,
            btr.tariffId,
            btr.tariffLineNo,
            btr.tariffClassNo,
            btd.chargeCategory,
            btd.chargeType,
            btd.descrC,
            btd.docType,
            btd.udf05, -- sementara pengganti ratebase
            btr.ratePerUnit,
            btr.rate,
            btd.minAmount,
            btd.maxAmount,
            -- if (btr.udf02 = '',0,btr,udf02) as minQty,-- minimum billing
            btr.udf03,-- chamber name
            IF(btr.UDF02 = '', 0, btr.UDF02) AS minQty,
            btd.UDF01 AS MaterialNo,
            btd.udf02 AS itemChargeCategory,
            btd.udf04 AS billMode,
            btd.locationCategory,
            btd.UDF05,
            btd.UDF06,
            btd.UDF07,
            btd.UDF08,
            IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
            CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
            IFNULL(btr.classTo, 0),
            bth.contractNo,
            bth.tariffMasterId,
            btr.cost,
            IF(btr.udf03 = '', 0, btr.udf03) AS storageType,
            btd.billingParty,
            -- btd.billingTranCategory,
            IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
          FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
            INNER JOIN BAS_CUSTOMER bc
              ON bc.customerId = bcm.customerId
              AND bc.organizationId = bcm.organizationId
              AND bc.CustomerType = 'OW'
            INNER JOIN BIL_TARIFF_HEADER bth
              ON bth.organizationId = bcm.organizationId
              AND bth.tariffMasterId = bcm.tariffMasterId
            INNER JOIN BIL_TARIFF_DETAILS btd
              ON btd.organizationId = bth.organizationId
              AND btd.tariffId = bth.tariffId
            INNER JOIN BIL_TARIFF_RATE btr
              ON btr.organizationId = btd.organizationId
              AND btr.tariffId = btd.tariffId
              AND btr.tariffLineNo = btd.tariffLineNo
            LEFT JOIN BSM_CODE_ML bm
              ON bm.organizationId = btd.organizationId
              AND bm.codeId = btd.chargeCategory
              AND bm.codeType = 'CHARGE_CATEGORY'
              AND bm.languageId = 'en'

          WHERE bcm.organizationId = v_organizationId
          AND bcm.warehouseId = v_warehouseId
          AND bcm.customerId = v_customerId
          AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
          AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
          AND btd.chargeCategory = 'MC'
          AND btd.chargeType = 'MCB'
          AND btr.rate > 0
          AND btr.udf03 = v_type_handling
          /*        AND case when bcm.customerId in ('ECMAMA','ECMAMAB2C','MAPCLUB') then (btr.udf03 = v_storageType)
                  else (btr.udf03 ='') end*/
          #AND IFNULL(DAY(bth.billingdate),0)!=0 
          ORDER BY bcm.organizationId, bcm.warehouseId, bcm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo, btr.rate, btr.udf03;


          DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

          SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd


          #
          OPEN cur_Tariff;
        getTariff:
          LOOP
            FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
            R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount,/*R_qtyMinimumContract,*/ R_chamberName, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
            R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_rate_udf03, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;

            /*SELECT
                      'look->',
                      tariff_done,
                      R_RESULTQTYCHARGE,
                        v_qty_TraceId,
                        v_qty_MUID,
                        v_max_TraceId,
                        v_avg_TraceId,
                        v_max_MUID,
                        v_avg_MUID,
            			v_qty,
                        v_max_qty,
                        v_avg_qty,
                        v_chargeType,
                        R_minAmount,
                        R_rate,
                        R_ratePerUnit;*/
            --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;


            IF tariff_done = 1 THEN
              SET tariff_done = 0;
              LEAVE getTariff;
            END IF;

            -- SELECT R_CUSTOMERID,R_WAREHOUSEID;
            -- SELECT tariff_done;


            IF (LTRIM(RTRIM(R_WAREHOUSEID)) = LTRIM(RTRIM(v_warehouseId)))
              AND (LTRIM(RTRIM(R_CUSTOMERID)) = LTRIM(RTRIM(v_customerId))) THEN

              -- CALCULATION
              -- UOM
              -- PALLET
              -- CUBIC
              -- M2
              -- CASE
              -- IP
              -- PIECES
              -- KG
              -- LITER
              -- DO
              -- HOUR
              -- MONTH


              --           SELECT  'check=>',R_ratebase,R_TARIFFID;
              SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
              SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
              SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
              SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
              SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
              SET R_billsummaryId = '';

              /*IF (R_billMode = 'CUBIC') THEN
               IF(v_max_TraceId > sum(R_minAmount/(R_rate/R_ratePerUnit)) THEN
                  SET R_RESULTQTYCHARGE = v_max_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minAmount;
                END IF;*/

              SELECT
                'TRAP',
                R_rate,
                R_billMode,
                R_rate_udf03,
                v_type_handling,
                R_minAmount,
                R_rate,
                R_ratePerUnit;
              IF (R_ratebase = 'CUBIC') THEN
                IF (v_qty_charge > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 0;
                ELSE
                  SET R_RESULTQTYCHARGE = (R_minQty - v_qty_charge);
                END IF;
              ELSEIF (R_ratebase = 'QUANTITY') THEN
                IF (v_qty_charge > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 0;
                ELSE
                  SET R_RESULTQTYCHARGE = (R_minQty - v_qty_charge);
                END IF;
              ELSEIF (R_ratebase = 'PALLET') THEN
                IF (v_qty_charge > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 0;
                ELSE
                  SET R_RESULTQTYCHARGE = (R_minQty - v_qty_charge);
                END IF;
              ELSEIF (R_ratebase = 'CASE') THEN
                IF (v_qty_charge > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 0;
                ELSE
                  SET R_RESULTQTYCHARGE = (R_minQty - v_qty_charge);
                END IF;
              ELSEIF (R_ratebase = 'ORDERNO') THEN
                IF (v_qty_charge > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 0;
                ELSE
                  SET R_RESULTQTYCHARGE = (R_minQty - v_qty_charge);
                END IF;
              ELSEIF (R_ratebase = 'MT') THEN
                IF (v_qty_charge > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 0;
                ELSE
                  SET R_RESULTQTYCHARGE = (R_minQty - v_qty_charge);
                END IF;
              ELSEIF (R_ratebase = 'KG') THEN
                IF (v_qty_charge > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 0;
                ELSE
                  SET R_RESULTQTYCHARGE = (R_minQty - v_qty_charge);
                END IF;
              /*           ELSEIF (R_billMode = 'MONTHLOC') THEN
                          IF (v_qty_MUID > R_minQty) THEN
                            SET R_RESULTQTYCHARGE = v_qty_MUID;
                          ELSE
                            SET R_RESULTQTYCHARGE = R_minQty;
                          END IF;
                         ELSEIF (R_billMode = 'MONTHPL') THEN
                          IF (v_qty_MUID > R_minQty) THEN
                            SET R_RESULTQTYCHARGE = v_qty_MUID;
                          ELSE
                            SET R_RESULTQTYCHARGE = R_minQty;
                          END IF;
                         ELSEIF (R_billMode = 'MONTHQTY') THEN
                          IF (v_qty > R_minQty) THEN
                            SET R_RESULTQTYCHARGE = v_qty;
                          ELSE
                            SET R_RESULTQTYCHARGE = R_minQty;
                          END IF;
                         ELSEIF (R_billMode = 'MAXCBM') THEN
                          IF (v_max_qty_cbm > R_minQty) then
                            SET R_RESULTQTYCHARGE = v_max_qty_cbm;
                          ELSE
                            SET R_RESULTQTYCHARGE = R_minQty;
                          END IF;
                         ELSEIF (R_billMode = 'MAXPL') and v_customerId in ('NIA_SBY','SKU_SBY') THEN
                          IF (v_max_MUID > R_minQty) then
                            SET R_RESULTQTYCHARGE = (v_max_MUID * v_countDays);
                          ELSE
                            SET R_RESULTQTYCHARGE = (R_minQty * v_countDays);
                          END IF;*/
              END IF;


              IF EXISTS (SELECT
                    1
                  FROM BIL_SUMMARY
                  WHERE billingFromDate = R_BILLINGDATE
                  AND BillingToDate = R_BILLINGDATE
                  AND ChargeCategory = R_CHARGECATEGORY
                  AND chargeType = R_CHARGETYPE
                  AND CustomerID = R_CUSTOMERID
                  AND billTo = R_BILLTO
                  AND rateBase = R_rateBase
                  AND chargeRate = R_rate
                  AND arNo IN ('*')) THEN
                INSERT INTO BIL_SUMMARY_LOG
                  SELECT
                    *
                  FROM BIL_SUMMARY
                  WHERE billingFromDate = R_BILLINGDATE
                  AND BillingToDate = R_BILLINGDATE
                  AND ChargeCategory = R_CHARGECATEGORY
                  AND chargeType = R_CHARGETYPE
                  AND CustomerID = R_CUSTOMERID
                  AND billTo = R_BILLTO
                  AND rateBase = R_rateBase
                  AND chargeRate = R_rate
                  AND arNo IN ('*');
                DELETE
                  FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                  AND BillingToDate = R_BILLINGDATE
                  AND ChargeCategory = R_CHARGECATEGORY
                  AND chargeType = R_CHARGETYPE
                  AND CustomerID = R_CUSTOMERID
                  AND billTo = R_BILLTO
                  AND rateBase = R_rateBase
                  AND chargeRate = R_rate
                  AND arNo IN ('*');
              END IF; -- EXIST BILLING SUMMARY

              #
              IF (R_billsummaryId = '') THEN
                SET @linenumber = 0;
                SET OUT_returnCode = '';
                CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

                IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                  SET OUT_returnCode = '999#????????';
                  LEAVE getTariff;
                END IF;
              END IF;
              #


              INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
              , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
              , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
              , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
              , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
              , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
              , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
              , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
              , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
              , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
                SELECT
                  v_organizationId,
                  v_warehouseId,
                  CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                  R_BILLINGDATE,
                  R_BILLINGDATE,
                  v_customerId,
                  '',
                  '',
                  '',
                  R_TARIFFID,
                  R_CHARGECATEGORY,
                  R_chargetype,
                  R_descrC,
                  -- '',
                  R_rateBase,
                  R_rateperunit,
                  R_RESULTQTYCHARGE,
                  '',
                  0,
                  0,
                  R_rate,
                  R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                  (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                  0,
                  R_cost * R_RESULTQTYCHARGE,
                  0,
                  NOW() confirmTime,
                  '' confirmWho,
                  '',
                  '',
                  '' createTransactionid,
                  R_rate_udf03 AS notes,
                  NOW() ediSendTime,
                  v_customerId AS billTo,
                  NOW() settleTime,
                  '' settleWho,
                  '' followUp,
                  '' invoiceType,
                  '' paidTo,
                  '' costConfirmFlag,
                  NOW() costConfirmTime,
                  '' costConfirmWho,
                  '' costSettleFlag,
                  NOW() costSettleTime,
                  '' costSettleWho,
                  0 incomeTaxRate,
                  0 costTaxRate,
                  R_INCOMETAX incomeTax,
                  0 cosTax,
                  R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                  0 cosWithoutTax,
                  '' costInvoiceType,
                  '' noteText,
                  R_materialNo AS udf01,
                  R_itemChargeCategory AS udf02,
                  0 udf03,
                  R_UDF06 udf04,
                  '' udf05,
                  0 currentVersion,
                  '2020' oprSeqFlag,
                  'CUSTOMBILL' addWho,
                  NOW() ADDTIME,
                  'CUSTOMBILL' editWho,
                  NOW() editTime,
                  R_LOCATIONCAT locationCategory,
                  '' manual,
                  0 lineCount,
                  '*' arNo,
                  0 arLineNo,
                  '*' apNo,
                  0 apLineNo,
                  'N' ediSendFlag,
                  '' ediErrorCode,
                  '' ediErrorMessage,
                  NOW() ediSendTime2,
                  'N' ediSendFlag2,
                  '' ediErrorCode2,
                  '' ediErrorMessage2,
                  '' billingTranCategory,
                  '' orderType,
                  '' containerType,
                  '' containerSize;

            END IF; -- END IF docType

          END LOOP getTariff;
          CLOSE cur_Tariff;

        END;
      ELSE
        ITERATE read_loop;
      END IF;

    END LOOP;

    -- Close the cursor
    CLOSE my_cursor;

  END
  $$

--
-- Create procedure `CML_BILLVASSPECIALSTD`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLVASSPECIALSTD (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN


  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_VASTYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  DECLARE od_organizationId varchar(255);
  DECLARE od_soReference1 varchar(255);
  DECLARE od_skuDescr1 varchar(255);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_vasNo varchar(255);
  DECLARE od_vasLineNo varchar(255);
  DECLARE od_sku varchar(255);
  DECLARE od_qtyReceived varchar(255);
  DECLARE od_uom varchar(255);
  DECLARE od_qtyReceivedEach varchar(255);
  DECLARE od_totalCube varchar(255);
  DECLARE od_vasType varchar(255);
  DECLARE od_chargeCategory varchar(255);
  DECLARE od_chargeType varchar(255);
  DECLARE od_qtyCharge varchar(255);
  DECLARE od_closetime datetime;
  DECLARE OUT_returnCode varchar(1000);

  ####################################################################
  ##????
  DECLARE inventory_done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE order_done,
          attribute_done int DEFAULT 0;



  DECLARE cur_orderno CURSOR FOR
  SELECT
    dvh.organizationId,
    dvh.warehouseId,
    dvd.customerId,
    dvh.vasNo,
    dvd.vasLineNo,
    dvd.sku,
    dvs.vasType,
    dvf.chargeCategory,
    dvf.chargeType,
    dvf.rateQty1 AS qtycharge,
    dvf.chargeDate
  FROM DOC_VAS_HEADER dvh
    INNER JOIN DOC_VAS_DETAILS dvd
      ON dvh.organizationId = dvd.organizationId
      AND dvh.warehouseId = dvd.warehouseId
      AND dvh.vasNo = dvd.vasNo
      AND dvh.customerId = dvd.customerId
    INNER JOIN DOC_VAS_SERVICE dvs
      ON dvh.organizationId = dvs.organizationId
      AND dvh.warehouseId = dvs.warehouseId
      AND dvh.vasNo = dvs.vasNo
    INNER JOIN DOC_VAS_FEE dvf
      ON dvh.organizationId = dvf.organizationId
      AND dvd.warehouseId = dvf.warehouseId
      AND dvh.vasNo = dvf.vasNo
  WHERE dvh.organizationId = IN_organizationId
  AND dvh.customerId = IN_CustomerId
  AND dvh.warehouseId = IN_warehouseId
  AND dvh.vasNo = IN_trans_no;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET order_done = 1;
  OPEN cur_orderno;
cur_order_loop:
  LOOP
    FETCH FROM cur_orderno INTO od_organizationId,
    od_warehouseId,
    od_customerId,
    od_vasNo,
    od_vasLineNo,
    od_sku,
    od_vasType,
    od_chargeCategory,
    od_chargeType,
    od_qtyCharge,
    od_closetime;

    IF order_done = 1 THEN

      SET order_done = 0;
      LEAVE cur_order_loop;
    END IF;


  BLOCK2:
    BEGIN

      DECLARE cur_Tariff CURSOR FOR
      SELECT DISTINCT
        bsm.organizationId,
        bsm.warehouseId,
        bsm.CUSTOMERID,
        DAY(bth.billingdate) billingDate,
        btr.tariffId,
        btr.tariffLineNo,
        btr.tariffClassNo,
        btd.chargeCategory,
        btd.chargeType,
        btd.vasType,
        btd.descrC,
        btd.docType,
        btd.ratebase,
        btr.ratePerUnit,
        btr.rate,
        btd.minAmount,
        btd.maxAmount,
        IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
        btd.UDF01 AS MaterialNo,
        btd.udf02 AS itemChargeCategory,
        btd.udf04 billMode,
        locationCategory,
        btd.UDF05,
        btd.UDF06,
        btd.UDF07,
        btd.UDF08,
        IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
        CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
        IFNULL(classTo, 0),
        bth.contractNo,
        bth.tariffMasterId,
        btr.cost,
        btd.billingParty,
        -- btd.billingTranCategory,
        IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
      FROM BAS_SKU_MULTIWAREHOUSE bsm
        INNER JOIN BAS_CUSTOMER bc
          ON bc.customerId = bsm.customerId
          AND bc.organizationId = bsm.organizationId
          AND bc.CustomerType = 'OW'
        INNER JOIN BIL_TARIFF_HEADER bth
          ON bth.organizationId = bsm.organizationId
          AND bth.tariffMasterId = bsm.tariffMasterId
        INNER JOIN BIL_TARIFF_DETAILS btd
          ON btd.organizationId = bth.organizationId
          AND btd.tariffId = bth.tariffId
        INNER JOIN BIL_TARIFF_RATE btr
          ON btr.organizationId = btd.organizationId
          AND btr.tariffId = btd.tariffId
          AND btr.tariffLineNo = btd.tariffLineNo
      WHERE bsm.organizationId = 'OJV_CML'
      AND bsm.warehouseId = IN_warehouseId
      AND bsm.customerId = IN_CustomerId
      AND bth.tariffMasterId = IN_tariffMaster
      AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND btd.chargeCategory = 'VA'
      AND btd.chargeType = od_chargeType /*AB update chargeType 2024-10-28*/
      AND btd.vasType = od_vasType /*AB update detail vasType 2025-06-04*/
      AND btd.udf01 IN ('1700000145', '1700000008', '1700000147')
      AND btr.rate > 0
      AND btd.tariffLineNo > 100
      #AND IFNULL(DAY(bth.billingdate),0)!=0 
      ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

      SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
      #
      OPEN cur_Tariff;
    getTariff:
      LOOP
        FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_VASTYPE, R_descrC, R_docType,
        R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
        R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;
        IF tariff_done THEN
          SET tariff_done = FALSE;
          LEAVE getTariff;
        END IF;


        SELECT
          UPPER(R_CHARGECATEGORY),
          UPPER(R_CHARGETYPE),
          UPPER(R_VASTYPE),
          UPPER(od_chargeCategory),
          UPPER(od_chargeType),
          UPPER(od_vasType);

        IF (UPPER(R_CHARGETYPE) = UPPER(od_chargeType))
          AND (UPPER(R_CHARGECATEGORY) = UPPER(od_chargeCategory))
          AND (UPPER(R_VASTYPE) = UPPER(od_vasType)) THEN /*update detail vasType AB '2025-06-04*/
          -- CALCULATION
          -- UOM
          -- PALLET
          -- CUBIC
          -- M2
          -- CASE
          -- IP
          -- PIECES
          -- KG
          -- LITER
          -- DO
          -- HOUR
          -- MONTH



          SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
          SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
          SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
          SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
          SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
          SET R_billsummaryId = '';


          SET R_RESULTQTYCHARGE = od_qtyCharge;






          IF EXISTS (SELECT
                1
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*')) THEN
            INSERT INTO BIL_SUMMARY_LOG
              SELECT
                *
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
            DELETE
              FROM BIL_SUMMARY
            WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
          END IF; -- EXIST BILLING SUMMARY
          #
          IF (R_billsummaryId = '') THEN
            SET @linenumber = 0;
            SET OUT_returnCode = '*_*';
            CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              SET OUT_returnCode = '999#????????';
              LEAVE getTariff;
            END IF;
          END IF;
          #


          INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
          , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
          , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
          , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
          , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
          , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
          , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
          , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
          , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
          , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
            SELECT
              od_organizationId,
              od_warehouseId,
              CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
              DATE_FORMAT(od_closetime, '%Y-%m-%d'),
              DATE_FORMAT(od_closetime, '%Y-%m-%d'),
              od_customerId,
              od_sku,
              '',
              '',
              R_TARIFFID,
              R_CHARGECATEGORY,
              R_chargetype,
              R_descrC,
              R_rateBase,
              R_rateperunit,
              od_qtyCharge,
              od_uom,
              '0',
              '0',
              R_rate,
              R_RESULTQTYCHARGE * R_rate / R_rateperunit,
              (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
              0,
              R_cost * R_RESULTQTYCHARGE,
              0,
              NULL confirmTime,
              '' confirmWho,
              'VAS' dockType,
              od_vasNo,
              '' createTransactionid,
              R_CHARGETYPE notes,
              NULL ediSendTime,
              R_BILLTO billTo,
              NULL settleTime,
              '' settleWho,
              '' followUp,
              '' invoiceType,
              '' paidTo,
              '' costConfirmFlag,
              NULL costConfirmTime,
              '' costConfirmWho,
              '' costSettleFlag,
              NULL costSettleTime,
              '' costSettleWho,
              NULL incomeTaxRate,
              0 costTaxRate,
              NULL incomeTax,
              0 cosTax,
              NULL incomeWithoutTax,
              NULL cosWithoutTax,
              '' costInvoiceType,
              '' noteText,
              R_materialNo AS udf01,
              R_itemChargeCategory AS udf02,
              R_UDF08 udf03,
              R_UDF06 udf04,
              NULL udf05,
              0 currentVersion,
              '2020' oprSeqFlag,
              IN_USERID addWho,
              NOW() ADDTIME,
              IN_USERID editWho,
              NOW() editTime,
              R_LOCATIONCAT locationCategory,
              '' manual,
              0 lineCount,
              '*' arNo,
              0 arLineNo,
              '*' apNo,
              0 apLineNo,
              'N' ediSendFlag,
              '' ediErrorCode,
              '' ediErrorMessage,
              NULL ediSendTime2,
              'N' ediSendFlag2,
              '' ediErrorCode2,
              '' ediErrorMessage2,
              '' billingTranCategory,
              '' orderType,
              '' containerType,
              '' containerSize;

        END IF; -- END IF docType

      END LOOP getTariff;
      CLOSE cur_Tariff;


    --  END IF; 
    --  END IF TARIFF ORDER KOSONG
    END;




  END LOOP cur_order_loop;
  CLOSE cur_orderno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_BILLTRFBAGGINGSTD`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_BILLTRFBAGGINGSTD (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
ENDPROC:
  BEGIN
    DECLARE R_CURRENTDATE timestamp;
    DECLARE R_OPDATE varchar(10);
    DECLARE R_FMDATE varchar(10);
    DECLARE R_TODATE varchar(10);
    DECLARE R_BILLINGDAY integer;
    DECLARE R_BILLINGDATE varchar(10);
    DECLARE R_TARGETDATE varchar(10);
    DECLARE R_DAYOFMONTH int;
    DECLARE R_ORGANIZATIONID varchar(30);
    DECLARE R_WAREHOUSEID varchar(30);
    DECLARE R_CUSTOMERID varchar(30);
    DECLARE R_STOCKDATE varchar(10);
    DECLARE R_TARIFFID varchar(10);
    DECLARE R_TARIFFMASTERID varchar(20);
    DECLARE R_TARIFFLINENO int(11);
    DECLARE R_TARIFFCLASSNO int(11);
    DECLARE R_CHARGECATEGORY varchar(20);
    DECLARE R_CHARGETYPE varchar(20);
    DECLARE R_descrC varchar(50);
    DECLARE R_ratebase varchar(20);
    DECLARE R_docType varchar(20);
    DECLARE R_rateperunit decimal(24, 8);
    DECLARE R_rate decimal(24, 8);
    DECLARE R_minQty varchar(500);
    DECLARE R_minAmount decimal(24, 8);
    DECLARE R_maxAmount decimal(24, 8);
    DECLARE R_billQty decimal(24, 8);
    DECLARE R_Cost decimal(24, 8);
    DECLARE R_materialNo varchar(500);
    DECLARE R_itemChargeCategory varchar(500);
    DECLARE R_billMode varchar(500);
    DECLARE R_UDF06 varchar(500);
    DECLARE R_FINALAMOUNT decimal(24, 8);
    DECLARE R_billsummaryId varchar(30) DEFAULT '';
    DECLARE R_billsummaryNo varchar(30) DEFAULT '';
    DECLARE R_LOCATIONCAT char(2);
    DECLARE R_LOCATIONGROUP varchar(500);
    DECLARE R_INCOMETAX decimal(24, 8);
    DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
    DECLARE R_CLASSFROM decimal(24, 8);
    DECLARE R_CLASSTO decimal(24, 8);
    DECLARE R_CONTRACTNO varchar(100);
    DECLARE R_BILLINGMONTH varchar(10);
    DECLARE R_BILLINGPARTY varchar(10);
    DECLARE R_BILLINGTRANCATEGORY varchar(10);
    DECLARE R_BILLTO varchar(30);
    DECLARE R_NROW integer;
    DECLARE R_UDF08 varchar(500);
    DECLARE R_UDF07 varchar(500);
    DECLARE R_Days int(11) DEFAULT NULL;
    DECLARE OD_CURSORDONE boolean DEFAULT FALSE;
    DECLARE odh_organizationId varchar(20);
    DECLARE odh_warehouseId varchar(20);
    DECLARE odh_tdocNo varchar(20);
    DECLARE vodh_tdocNo varchar(20);
    DECLARE od_tdocType varchar(20);
    DECLARE od_status varchar(2);
    DECLARE od_customerId varchar(30);
    DECLARE od_organizationId varchar(20);
    DECLARE od_warehouseId varchar(20);
    DECLARE od_tdocNo varchar(20);
    DECLARE od_tdocLineNo int(11);
    DECLARE od_tdocLineStatus varchar(2);
    DECLARE od_fmCustomerId varchar(30);
    DECLARE od_fmSku varchar(50);
    DECLARE od_fmQty decimal(18, 8);
    DECLARE od_toCustomerId varchar(30);
    DECLARE od_toSku varchar(50);
    DECLARE od_toLotAtt04 varchar(30);/*AB additional information to billing list 11/11/24*/
    DECLARE od_toLotAtt05 varchar(30);/*AB additional information to billing list 11/11/24*/
    DECLARE od_toLotAtt06 varchar(30);/*AB additional information to billing list 11/11/24*/
    DECLARE od_toLotAtt08 varchar(30);/*AB additional information to billing list 11/11/24*/
    DECLARE od_codeDescr varchar(50);/*AB additional information to billing list 11/11/24*/
    DECLARE od_toQty decimal(18, 8);
    DECLARE od_closedtime timestamp;
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE tariff_done int DEFAULT 0;
    DECLARE _GETLINEORDER CURSOR FOR
    SELECT
      dth.organizationId,
      dth.warehouseId,
      dth.customerId,
      dth.tdocNo,
      dth.tdocType,
      dtd.tdocLineNo,
      dtd.toSku,
      dtd.toLotAtt04,/*AB additional information to billing list 11/11/24*/
      dtd.toLotAtt05,/*AB additional information to billing list 11/11/24*/
      dtd.toLotAtt06,/*AB additional information to billing list 11/11/24*/
      dtd.toLotAtt08,/*AB additional information to billing list 11/11/24*/
      dtd.fmSku,
      dtd.fmQty,
      dtd.toQty,
      bcm.codeDescr,/*AB additional information to billing list 11/11/24*/
      dth.editTime
    FROM DOC_TRANSFER_HEADER dth
      INNER JOIN DOC_TRANSFER_DETAILS dtd
        ON dth.organizationId = dtd.organizationId
        AND dth.warehouseId = dtd.warehouseId
        AND dth.tdocNo = dtd.tdocNo
      LEFT JOIN BSM_CODE_ML bcm
        ON bcm.organizationId = dth.organizationId
        AND bcm.codeId = dth.tdocType
        AND bcm.codeType = 'TRF_TYP'
        AND bcm.languageId = 'en'
    WHERE dth.organizationId = IN_organizationId
    AND dtd.warehouseId = IN_warehouseId
    AND dth.tdocNo = IN_trans_no
    AND dth.customerId = IN_CustomerId
    AND dth.status = '99'
    AND dtd.tdocLineStatus = '99';
    -- AND dth.tdocType = 'BG';
    -- AND dtd.tdocLineNo = IN_lineNO;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET OD_CURSORDONE = TRUE;
    OPEN _GETLINEORDER;
  GETLINEORDERLOOP:
    LOOP FETCH FROM _GETLINEORDER INTO od_organizationId,
      od_warehouseId,
      od_customerId,
      od_tdocNo,
      od_tdocType,
      od_tdocLineNo,
      od_toSku,
      od_toLotAtt04,
      od_toLotAtt05,
      od_toLotAtt06,
      od_toLotAtt08,
      od_fmSku,
      od_fmQty,
      od_toQty,
      od_codeDescr,
      od_closedtime;


      IF OD_CURSORDONE THEN
        SET OD_CURSORDONE = FALSE;
        LEAVE GETLINEORDERLOOP;
      END IF;

      BEGIN

        IF (od_tdocType IS NULL) THEN
          SET OUT_Return_Code = '201';
          LEAVE ENDPROC;
        END IF;


      /*       SELECT
                btm.tariffMasterId INTO IN_tariffMaster
              FROM BIL_TARIFF_MASTER btm
              WHERE btm.organizationId = IN_organizationId
              AND btm.customerId = IN_CustomerId;*/

      --         CALL SPCOM_GetIDSequence_NEW(IN_organizationId,
      --         IN_warehouseId,'en',
      --         'TDOCNO',
      --         vodh_tdocNo,
      --         OUT_Return_Code);

      BLOCK2:
        BEGIN
          DECLARE cur_Tariff CURSOR FOR
          SELECT DISTINCT
            bsm.organizationId,
            bsm.warehouseId,
            bsm.CUSTOMERID,
            bsm.tariffMasterId,
            DAY(bth.billingdate) billingDate,
            btr.tariffId,
            btr.tariffLineNo,
            btr.tariffClassNo,
            btd.chargeCategory,
            btd.chargeType,
            btd.descrC,
            btd.docType,
            btd.ratebase,
            btr.ratePerUnit,
            btr.rate,
            btd.minAmount,
            btd.maxAmount,
            IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
            btd.UDF01 AS MaterialNo,
            btd.udf02 AS itemChargeCategory,
            btd.udf04 billMode,
            locationCategory,
            btd.UDF05,
            btd.UDF06,
            btd.UDF07,
            btd.UDF08,
            IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
            CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
            IFNULL(classTo, 0),
            bth.contractNo,
            bth.tariffMasterId,
            btr.cost,
            btd.billingParty,
            -- btd.billingTranCategory,
            IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
          FROM BAS_SKU_MULTIWAREHOUSE bsm
            INNER JOIN BAS_CUSTOMER bc
              ON bc.customerId = bsm.customerId
              AND bc.organizationId = bsm.organizationId
              AND bc.CustomerType = 'OW'
            INNER JOIN BIL_TARIFF_HEADER bth
              ON bth.organizationId = bsm.organizationId
              AND bth.tariffMasterId = bsm.tariffMasterId
            INNER JOIN BIL_TARIFF_DETAILS btd
              ON btd.organizationId = bth.organizationId
              AND btd.tariffId = bth.tariffId
            INNER JOIN BIL_TARIFF_RATE btr
              ON btr.organizationId = btd.organizationId
              AND btr.tariffId = btd.tariffId
              AND btr.tariffLineNo = btd.tariffLineNo
          WHERE bsm.organizationId = 'OJV_CML'
          AND bsm.warehouseId = IN_warehouseId
          AND bsm.customerId = IN_CustomerId
          -- AND bth.tariffMasterId = IN_tariffMasterId
          AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
          AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
          AND btd.chargeCategory = 'TD'
          AND btd.chargeType = od_tdocType
          -- AND btd.vasType = 'BG'
          AND btd.udf01 IN ('1700000008')
          AND btr.rate > 0
          AND btd.tariffLineNo > 100
          #AND IFNULL(DAY(bth.billingdate),0)!=0 
          ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
          DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

          SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
          #
          OPEN cur_Tariff;
        getTariff:
          LOOP
            FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_TARIFFMASTERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
            R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
            R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;
            IF tariff_done THEN
              SET tariff_done = FALSE;
              LEAVE getTariff;
            END IF;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';


            SET R_RESULTQTYCHARGE = od_toQty;
            SET R_CHARGETYPE = od_tdocType;

            SELECT
              od_tdocType,
              od_tdocLineNo,
              od_tdocNo,
              od_toLotAtt04,
              od_toLotAtt05,
              od_toLotAtt06,
              od_toLotAtt08,
              od_codeDescr,
              R_RESULTQTYCHARGE;

            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_Return_Code = '*_*';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_Return_Code);
              IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
                SET OUT_Return_Code = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #


            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                od_organizationId,
                od_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(od_closedtime, '%Y-%m-%d'),
                DATE_FORMAT(od_closedtime, '%Y-%m-%d'),
                od_customerId,
                od_toSku,
                '',
                '',
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                R_descrC,
                R_rateBase,
                R_rateperunit,
                od_toQty,
                '',
                '0',
                '0',
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_rate * R_RESULTQTYCHARGE,
                0,
                NULL confirmTime,
                '' confirmWho,
                od_tdocType,
                od_tdocNo,
                '' createTransactionid,
                od_toLotAtt06 notes,
                NULL ediSendTime,
                R_BILLTO,
                NULL settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NULL costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NULL costSettleTime,
                '' costSettleWho,
                NULL incomeTaxRate,
                0 costTaxRate,
                NULL incomeTax,
                0 cosTax,
                NULL incomeWithoutTax,
                NULL cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                R_UDF08 udf03,
                R_UDF06 udf04,
                NULL udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NULL ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                od_tdocType orderType,
                '' containerType,
                '' containerSize;



          END LOOP getTariff;
          CLOSE cur_Tariff;






        END;
      END;
    END LOOP GETLINEORDERLOOP;
    CLOSE _GETLINEORDER;

  END
  $$

--
-- Create procedure `CML_BILLSUMMARYPROCESS_MANUAL`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE CML_BILLSUMMARYPROCESS_MANUAL (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(30),
IN IN_USERID varchar(30),
INOUT OUT_Return_Code varchar(500))
ENDPROC:
  BEGIN
    DECLARE delimiterChar longtext;
    DECLARE inputString longtext;
    DECLARE OUT_returnCode varchar(1000);
    DECLARE r_generateArno char(15);
    DECLARE r_totalbillingAmount decimal(24, 8);


    SET r_totalbillingAmount = 0;


    -- GENERATE ARNUMBER
    SET OUT_returnCode = '*_*';
    SET @linenumber = 0;
    CALL SPCOM_GetIDSequence_NEW(IN_organizationId, '*', 'en', 'BILLINGARC', r_generateArno, OUT_returnCode);
    IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
      SET OUT_returnCode = '999#????????';
    --   LEAVE cur_billingsm_loop;
    END IF;
    SET @linenumber = 0;

    BEGIN


      DECLARE r_organizationId varchar(20);
      DECLARE r_warehouseId varchar(20);
      DECLARE r_billingSummaryId varchar(30);
      DECLARE r_billingFromDate varchar(30);
      DECLARE r_billingToDate varchar(30);
      DECLARE r_customerId varchar(30);

      DECLARE r_chargeCategory varchar(20);
      DECLARE r_chargeType varchar(20);

      DECLARE r_amount decimal(24, 8);
      DECLARE r_billingAmount decimal(24, 8);





      DECLARE inventory_done int DEFAULT 0;
      DECLARE tariff_done int DEFAULT 0;
      DECLARE billing_sm_done,
              attribute_done int DEFAULT 0;




      DECLARE cur_billingsm CURSOR FOR
      SELECT
        bs.organizationId,
        bs.warehouseId,
        -- billingSummaryId,
        NOW() AS billingFromDate,
        NOW() AS billingToDate,
        bs.customerId,
        bs.chargeCategory,
        bs.chargeType,
        SUM(bs.billingAmount) AS total_billingAmount
      FROM BIL_SUMMARY bs
        INNER JOIN Z_CML_BILLINGSUMMARYID zcb
          ON bs.organizationId = zcb.organizationId
          AND bs.warehouseId = zcb.warehouseId
          AND bs.customerId = zcb.customerId
          AND bs.billingSummaryId = zcb.billingSummaryId
      WHERE bs.organizationId = IN_organizationId
      AND bs.warehouseId = IN_warehouseId
      AND bs.customerId = IN_customerId
      AND (bs.arNo = '*'
      OR bs.arNo IS NULL
      OR bs.arNo = '') -- ADD VALIDASI ONLY BILLING WITH NO AR
      GROUP BY organizationId,
               warehouseId,
               customerId,
               chargeCategory,
               chargeType;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET billing_sm_done = 1;
      OPEN cur_billingsm;
    cur_billingsm_loop:
      LOOP
        FETCH FROM cur_billingsm INTO r_organizationId,
        r_warehouseId, r_billingFromDate, r_billingToDate, r_customerId, r_chargeCategory, r_chargeType, r_billingAmount;

        IF billing_sm_done = 1 THEN
          SET billing_sm_done = 0;
          LEAVE cur_billingsm_loop;
        END IF;


        SET r_totalbillingAmount = r_totalbillingAmount + r_billingAmount;

        -- INSERT DETAIL
        INSERT INTO BIL_BILLING_DETAILS (organizationId, warehouseId, billingNo, billingLineNo, chargeCategory,
        chargeType, billingAmount, noteText, udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag,
        addWho, addTime, editWho, editTime)
          SELECT
            r_organizationId,
            r_warehouseId,
            r_generateArno,
            -- NULL,
            (@linenumber := @linenumber + 1),
            r_chargeCategory,
            r_chargeType,
            r_billingAmount,
            NULL,
            NULL,
            NULL,
            NULL,
            NULL,
            NULL,
            100,
            '20230925105523000711RA172031009087[A3702]',
            IN_USERID,
            NOW(),
            IN_USERID,
            NOW();



        -- UPDATE AR NO
        UPDATE BIL_SUMMARY bs
        SET bs.arNo = r_generateArno,
            bs.arLineNo = @linenumber
        WHERE bs.organizationId = IN_organizationId
        AND bs.billingSummaryId IN (SELECT
            zcb.billingSummaryId
          FROM Z_CML_BILLINGSUMMARYID zcb)
        AND (bs.arNo = '*'
        OR bs.arNo IS NULL
        OR bs.arNo = '')

        AND bs.warehouseId = r_warehouseId
        AND bs.customerId = r_customerId
        AND bs.chargeCategory = r_chargeCategory
        AND bs.chargeType = r_chargeType;

      END LOOP cur_billingsm_loop;
      CLOSE cur_billingsm;
      -- SET OUT_returnCode = '000';



      -- INSERT HEADER
      INSERT INTO BIL_BILLING_HEADER (organizationId, warehouseId, billingNo, STATUS, billTo, customerId, billingDate, billDateFM, billDateTO,
      totalAmount, discountStart, discountRate, totalBillingAmount, actualAmount, noteText, udf01, udf02, udf03, udf04, udf05, currentVersion,
      oprSeqFlag, addWho, addTime, editWho, editTime, billingType, minAmount, maxAmount)
        SELECT
          r_organizationId,
          r_warehouseId,
          r_generateArno,
          '00',
          r_customerId,
          r_customerId,
          NOW(),
          NOW(),
          NOW(),
          r_totalbillingAmount,
          0,
          0,
          NULL AS totalBillingAmount,
          NULL AS actualAmount,
          NULL AS noteText,
          NULL AS udf01,
          NULL AS udf02,
          NULL AS udf03,
          NULL AS udf04,
          'N' AS udf05,
          100 AS currentVersion,
          '20230925105523000711RA172031009087[A3702]' AS oprSeqFlag,
          IN_USERID AS addWho,
          NOW() AS addTime,
          IN_USERID AS editWho,
          NOW() AS editTime,
          'AR',
          NULL,
          NULL;



      -- Clear Temporary

      DELETE
        FROM Z_CML_BILLINGSUMMARYID;


      COMMIT;
      SET OUT_Return_Code = r_generateArno;
    END;
  END
  $$

--
-- Create procedure `CML_BILLSUMMARYPROCESS`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE CML_BILLSUMMARYPROCESS (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_BillingSummaryID longtext)
ENDPROC:
  BEGIN
    DECLARE delimiterChar longtext;
    DECLARE inputString longtext;
    DECLARE OUT_returnCode varchar(1000);
    DECLARE r_generateArno char(15);
    DECLARE r_totalbillingAmount decimal(24, 8);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_BILLSUMMARYPROCESS', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
    END;

    DROP TEMPORARY TABLE IF EXISTS temp_bilsummaryId;
    CREATE TEMPORARY TABLE temp_bilsummaryId (
      vals longtext
    );


    SET r_totalbillingAmount = 0;
    SET delimiterChar = ',';
    SET inputString = IN_BillingSummaryID;
    WHILE LOCATE(delimiterChar, inputString) > 1 DO
      INSERT INTO temp_bilsummaryId
        SELECT
          SUBSTRING_INDEX (inputString, delimiterChar, 1);
      SET inputString = REPLACE(inputString, (SELECT
          LEFT(inputString, LOCATE(delimiterChar, inputString))), '');
    END WHILE;
    INSERT INTO temp_bilsummaryId (vals)
      VALUES (inputString);

    -- GENERATE ARNUMBER
    SET OUT_returnCode = '*_*';
    SET @linenumber = 0;
    CALL SPCOM_GetIDSequence_NEW(IN_organizationId, '*', IN_Language, 'BILLINGARC', r_generateArno, OUT_returnCode);
    IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
      SET OUT_returnCode = '999#????????';
    --   LEAVE cur_billingsm_loop;
    END IF;
    SET @linenumber = 0;

    BEGIN


      DECLARE r_organizationId varchar(20);
      DECLARE r_warehouseId varchar(20);
      DECLARE r_billingSummaryId varchar(30);
      DECLARE r_billingFromDate varchar(30);
      DECLARE r_billingToDate varchar(30);
      DECLARE r_customerId varchar(30);

      DECLARE r_chargeCategory varchar(20);
      DECLARE r_chargeType varchar(20);

      DECLARE r_amount decimal(24, 8);
      DECLARE r_billingAmount decimal(24, 8);





      DECLARE inventory_done int DEFAULT 0;
      DECLARE tariff_done int DEFAULT 0;
      DECLARE billing_sm_done,
              attribute_done int DEFAULT 0;


      DECLARE cur_billingsm CURSOR FOR
      SELECT
        organizationId,
        warehouseId,
        -- billingSummaryId,
        NOW() AS billingFromDate,
        NOW() AS billingToDate,
        customerId,
        chargeCategory,
        chargeType,
        SUM(
        CASE WHEN billingAmount IS NULL OR
            billingAmount = 0 THEN COALESCE(amount, 0) ELSE billingAmount END
        ) AS total_billingAmount
      FROM BIL_SUMMARY bs
      WHERE bs.organizationId = IN_organizationId
      AND bs.warehouseId = IN_warehouseId
      AND (bs.arNo = '*'
      OR bs.arNo IS NULL
      OR bs.arNo = '') -- ADD VALIDASI ONLY BILLING WITH NO AR
      AND bs.billingSummaryId IN (SELECT
          vals
        FROM temp_bilsummaryId)
      GROUP BY organizationId,
               warehouseId,
               customerId,
               chargeCategory,
               chargeType;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET billing_sm_done = 1;

      OPEN cur_billingsm;
    cur_billingsm_loop:
      LOOP
        FETCH FROM cur_billingsm INTO r_organizationId,
        r_warehouseId, r_billingFromDate, r_billingToDate, r_customerId, r_chargeCategory, r_chargeType, r_billingAmount;


        IF billing_sm_done = 1 THEN
          SET billing_sm_done = 0;
          LEAVE cur_billingsm_loop;
        END IF;

        SET r_totalbillingAmount = r_totalbillingAmount + r_billingAmount;

        -- INSERT DETAIL
        INSERT INTO BIL_BILLING_DETAILS (organizationId, warehouseId, billingNo, billingLineNo, chargeCategory,
        chargeType, billingAmount, noteText, udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag,
        addWho, addTime, editWho, editTime)
          SELECT
            r_organizationId,
            r_warehouseId,
            r_generateArno,
            -- NULL,
            (@linenumber := @linenumber + 1),
            r_chargeCategory,
            r_chargeType,
            r_billingAmount,
            NULL,
            NULL,
            NULL,
            NULL,
            NULL,
            NULL,
            100,
            '20230925105523000711RA172031009087[A3702]',
            IN_USERID,
            NOW(),
            IN_USERID,
            NOW();



        -- UPDATE AR NO
        UPDATE BIL_SUMMARY bs
        SET bs.arNo = r_generateArno,
            bs.arLineNo = @linenumber
        WHERE bs.organizationId = IN_organizationId
        AND bs.billingSummaryId IN (SELECT
            vals
          FROM temp_bilsummaryId)
        AND (bs.arNo = '*'
        OR bs.arNo IS NULL
        OR bs.arNo = '')

        AND bs.warehouseId = r_warehouseId
        AND bs.customerId = r_customerId
        AND bs.chargeCategory = r_chargeCategory
        AND bs.chargeType = r_chargeType;

      END LOOP cur_billingsm_loop;
      CLOSE cur_billingsm;
      -- SET OUT_returnCode = '000';



      -- INSERT HEADER
      INSERT INTO BIL_BILLING_HEADER (organizationId, warehouseId, billingNo, STATUS, billTo, customerId, billingDate, billDateFM, billDateTO,
      totalAmount, discountStart, discountRate, totalBillingAmount, actualAmount, noteText, udf01, udf02, udf03, udf04, udf05, currentVersion,
      oprSeqFlag, addWho, addTime, editWho, editTime, billingType, minAmount, maxAmount)
        SELECT
          r_organizationId,
          r_warehouseId,
          r_generateArno,
          '00',
          r_customerId,
          r_customerId,
          NOW(),
          NOW(),
          NOW(),
          r_totalbillingAmount,
          0,
          0,
          NULL AS totalBillingAmount,
          NULL AS actualAmount,
          NULL AS noteText,
          NULL AS udf01,
          NULL AS udf02,
          NULL AS udf03,
          NULL AS udf04,
          'N' AS udf05,
          100 AS currentVersion,
          '20230925105523000711RA172031009087[A3702]' AS oprSeqFlag,
          IN_USERID AS addWho,
          NOW() AS addTime,
          IN_USERID AS editWho,
          NOW() AS editTime,
          'AR',
          NULL,
          NULL;







      DROP TEMPORARY TABLE IF EXISTS temp_bilsummaryId;
      COMMIT;
    END;
  END
  $$

--
-- Create procedure `CML_BILLSTORAGE_R_BILL_MODE_SPLIT`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_BILLSTORAGE_R_BILL_MODE_SPLIT (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_qty_TraceId decimal(24, 8);
  DECLARE v_qty_MUID decimal(24, 8);
  DECLARE v_max_TraceId decimal(24, 8);
  DECLARE v_avg_TraceId decimal(24, 8);
  DECLARE v_max_MUID decimal(24, 8);
  DECLARE v_avg_MUID decimal(24, 8);
  DECLARE v_max_qty decimal(24, 8);
  DECLARE v_avg_qty decimal(24, 8);
  DECLARE v_qty decimal(24, 8);
  DECLARE v_max_qty_cbm decimal(24, 8);
  DECLARE v_avg_qty_cbm decimal(24, 8);
  DECLARE v_qty_cbm decimal(24, 8);
  DECLARE v_chargeType varchar(255);
  DECLARE v_countDays varchar(255);
  DECLARE v_storageType varchar(255);
  -- Declare for Billing
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY int;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_Days int(11);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int(11);
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rate_udf03 varchar(50);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF03 varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_qtyMinimumContract decimal(24, 8);
  DECLARE R_chamberName varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 6);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 6);
  DECLARE R_CLASSFROM decimal(24, 6);
  DECLARE R_CLASSTO decimal(24, 6);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Variables for split logic -- add akbar
  DECLARE v_split_qty decimal(24, 8);
  DECLARE v_remaining_qty decimal(24, 8);
  DECLARE v_split_counter int DEFAULT 1;
  DECLARE v_max_split_qty decimal(24, 8) DEFAULT 1200; -- Maximum qty per split, ini bisa diubah ubah sesuai kebutuhan

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib.organizationId,
    zib.warehouseId,
    zib.customerId,
    SUM(zib.qty_TraceId) AS sum_traceId,
    SUM(zib.qty_MUID) AS sum_MUID,
    MAX(zib.qty_TraceId) AS max_TraceId,
    AVG(zib.qty_TraceId) AS avg_TraceId,
    MAX(zib.qty_MUID) AS max_MUID,
    AVG(zib.qty_MUID) AS avg_MUID,
    SUM(zib.qty) AS sum_qty,
    MAX(zib.qty) AS max_qty,
    AVG(zib.qty) AS avg_qty,
    SUM(zib.qty_cbm) AS sum_cbm,
    MAX(zib.qty_cbm) AS max_qty_cbm,
    AVG(zib.qty_cbm) AS avg_qty_cbm,
    zib.udf01,
    SUM(zib.udf02),
    zib.chargeType
  FROM Z_BIL_AKUM_DAYS_STORAGE zib
  WHERE zib.organizationId = IN_organizationId
  AND zib.customerId = IN_CustomerId
  AND zib.StockDate BETWEEN DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d') AND DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)
  AND zib.warehouseId = IN_warehouseId
  AND zib.chargeType = 'STRG'
  GROUP BY zib.organizationId,
           zib.warehouseId,
           zib.customerId,
           zib.udf01,
           zib.chargeType
  ORDER BY zib.organizationId, zib.warehouseId, zib.customerId, zib.chargeType;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop
read_loop:
  LOOP
    -- Fetch
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_qty_TraceId, v_qty_MUID, v_max_TraceId, v_avg_TraceId, v_max_MUID, v_avg_MUID, v_qty, v_max_qty, v_avg_qty, v_qty_cbm, v_max_qty_cbm, v_avg_qty_cbm, v_storageType, v_countDays, v_chargeType;

    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;

    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = v_organizationId
        AND bs.warehouseId = v_warehouseId
        AND bs.customerId = v_customerId
        AND bs.billingFromDate BETWEEN DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d') AND DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)
        AND bs.chargeCategory = 'IV'
        AND bs.chargeType = 'ST'
        AND bs.notes = v_storageType
        AND bs.arNo IN ('*')) THEN

    BLOCK2:
      BEGIN
        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bcm.organizationId,
          bcm.warehouseId,
          bcm.CUSTOMERID,
          DATE_FORMAT(DATE(DATE_ADD(bth.billingdate, INTERVAL -1 DAY)), '%d') AS billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          btr.udf03,-- chamber name
          IF(btr.UDF02 = '', 0, btr.UDF02) AS minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 AS billMode,
          btd.locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(btr.classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          IF(btr.udf03 = '', 0, btr.udf03) AS storageType,
          btd.billingParty,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bcm.customerId
            AND bc.organizationId = bcm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bcm.organizationId
            AND bth.tariffMasterId = bcm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
          LEFT JOIN BSM_CODE_ML bm
            ON bm.organizationId = btd.organizationId
            AND bm.codeId = btd.udf04
            AND bm.codeType = 'SP_TRACEID'
            AND bm.languageId = 'en'

        WHERE bcm.organizationId = v_organizationId
        AND bcm.warehouseId = v_warehouseId
        AND bcm.customerId = v_customerId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IV'
        AND btd.chargeType = 'ST'
        AND btr.rate > 0
        AND CASE WHEN bcm.customerId IN ('ECMAMA', 'ECMAMAB2C', 'MAPCLUB', 'CERESSMG', 'NLDC', 'NLDCSBY', 'CERESSBY', 'PT.ITT_MDN', 'PPG', 'DNN_MDN') THEN (btr.udf03 = v_storageType) ELSE (btr.udf03 = '') END
        ORDER BY bcm.organizationId, bcm.warehouseId, bcm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo, btr.rate, btr.udf03;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

        SET R_CURRENTDATE = CURDATE();

        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_chamberName, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_rate_udf03, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;

          IF tariff_done = 1 THEN
            SET tariff_done = 0;
            LEAVE getTariff;
          END IF;

          IF (LTRIM(RTRIM(R_WAREHOUSEID)) = LTRIM(RTRIM(v_warehouseId)))
            AND (LTRIM(RTRIM(R_CUSTOMERID)) = LTRIM(RTRIM(v_customerId))) THEN

            -- CALCULATION LOGIC (sama seperti sebelumnya)
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';

            -- [CALCULATION LOGIC - same as original code for all billMode cases]
            IF (R_billMode = 'MAXTRACE') THEN
              IF v_customerId IN ('LTL')
                AND v_warehouseId IN ('CBT01') THEN
                IF (v_max_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (v_max_TraceId - R_minQty);
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId IN ('PPG')
                AND R_rate_udf03 = 'NON WH-C' THEN
                IF (v_max_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_max_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId IN ('DNN_MDN')
                AND v_warehouseId IN ('KIMSTR')
                AND R_TARIFFMASTERID = 'BIL00085' THEN
                IF ((v_max_TraceId * 1.44) > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (v_max_TraceId * 1.44);
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId NOT IN ('LTL', 'PPG', 'DNN_MDN') THEN
                IF (v_max_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_max_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              END IF;
            ELSEIF (R_billMode = 'MAXPL') THEN
              IF v_customerId IN ('NIA_SBY', 'SKU_SBY')
                AND v_warehouseId IN ('SBYKK') THEN
                IF (v_max_MUID > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (v_max_MUID * v_countDays);
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId IN ('API')
                AND v_warehouseId IN ('CBT02') THEN
                IF ((((v_max_MUID * 1.44) / 2) + ((((v_max_MUID * 1.44) / 2) / 6.5) * 3.5)) > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (((v_max_MUID * 1.44) / 2) + ((((v_max_MUID * 1.44) / 2) / 6.5) * 3.5));
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId NOT IN ('NIA_SBY', 'SKU_SBY', 'API') THEN
                IF (v_max_MUID > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_max_MUID;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              END IF;
            ELSEIF (R_billMode = 'MAXQTY') THEN
              IF v_customerId IN ('PT.ITT_MDN')
                AND v_warehouseid = 'KIMSTR'
                AND v_storageType = 'REGULER' THEN
                IF ((v_max_qty / 1000) > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (v_max_qty / 1000);
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId IN ('PT.ITT_MDN')
                AND v_warehouseid = 'KIMSTR'
                AND v_storageType = 'EXCESS' THEN
                IF ((v_max_qty / 1000) > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 1;
                ELSE
                  SET R_RESULTQTYCHARGE = 1;
                END IF;
              ELSEIF v_customerId NOT IN ('PT.ITT_MDN') THEN
                IF (v_max_qty > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_max_qty;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              END IF;
            ELSEIF (R_billMode = 'AVGTRACE') THEN
              IF v_customerId IN ('PPG')
                AND R_rate_udf03 IN ('WH-C') THEN
                IF (v_avg_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_avg_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId NOT IN ('PPG')
                AND R_rate_udf03 NOT IN ('WH-C') THEN
                IF (v_avg_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_avg_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              END IF;
            ELSEIF (R_billMode = 'AVGLOC') THEN
              IF (v_avg_TraceId > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_avg_TraceId;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'AVGPL') THEN
              IF (v_avg_MUID > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_avg_MUID;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'AVGQTY') THEN
              IF (v_avg_qty > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_avg_qty;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MONTHTRACE') THEN
              IF (v_qty_TraceId > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty_TraceId;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MONTHLOC') THEN
              IF (v_qty_MUID > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty_MUID;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MONTHPL') THEN
              IF (v_qty_MUID > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty_MUID;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MONTHQTY') THEN
              IF (v_qty > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MAXCBM') THEN
              IF (v_max_qty_cbm > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_max_qty_cbm;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'INTRACE') THEN
              IF (v_qty_TraceId > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty_TraceId;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            END IF;


            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND chargeRate = R_rate
                AND arNo IN ('*')) THEN

              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND chargeRate = R_rate
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND chargeRate = R_rate
                AND arNo IN ('*');
            END IF;

            -- Get billing summary ID
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;

            -- ==================== mulai split ====================

            SET v_remaining_qty = R_RESULTQTYCHARGE;
            SET v_split_counter = 1;

          -- Split loop: lakukan loop insert jika lebih dari 1200
          split_loop:
            LOOP
              -- metu nek qty ne 0
              IF v_remaining_qty <= 0 THEN
                LEAVE split_loop;
              END IF;

              -- di split jika lebih dari maximum 1200
              IF v_remaining_qty > v_max_split_qty THEN
                SET v_split_qty = v_max_split_qty;
              ELSE
                SET v_split_qty = v_remaining_qty;
              END IF;

              -- Mulai insert split record
              INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId,
              sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits,
              qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid,
              confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime,
              billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag,
              costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate,
              costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText,
              udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory,
              manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2,
              ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
                VALUES (v_organizationId, v_warehouseId, CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')), R_BILLINGDATE, R_BILLINGDATE, v_customerId, '', '', '', R_TARIFFID, R_CHARGECATEGORY, R_chargetype, CONCAT(R_descrC, ' - Split ', v_split_counter), R_rateBase, R_rateperunit, v_split_qty, -- Use split quantity instead of total
                '', 0, 0, R_rate, (v_split_qty * R_rate) / R_rateperunit, (v_split_qty * (R_rate / R_rateperunit)), 0, R_cost * v_split_qty, 0, NOW(), '', '', '', '', R_rate_udf03, NOW(), v_customerId, NOW(), '', '', '', '', '', NOW(), '', '', NOW(), '', 0, 0, R_INCOMETAX, 0, v_split_qty * R_rate / R_rateperunit, 0, '', '', R_materialNo, R_itemChargeCategory, 0, R_UDF06, '', 0, '2020', 'CUSTOMBILL', NOW(), 'CUSTOMBILL', NOW(), R_LOCATIONCAT, '', 0, '*', 0, '*', 0, 'N', '', '', NOW(), 'N', '', '', '', '', '', '');

              -- Update sisa qty
              SET v_remaining_qty = v_remaining_qty - v_split_qty;
              SET v_split_counter = v_split_counter + 1;

            END LOOP split_loop;


          END IF;
        END LOOP getTariff;
        CLOSE cur_Tariff;

      END;
    ELSE
      ITERATE read_loop;
    END IF;

  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLSTORAGE_R_BILL_MODE`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_BILLSTORAGE_R_BILL_MODE (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_qty_TraceId decimal(24, 8);
  DECLARE v_qty_MUID decimal(24, 8);
  DECLARE v_max_TraceId decimal(24, 8);
  DECLARE v_avg_TraceId decimal(24, 8);
  DECLARE v_max_MUID decimal(24, 8);
  DECLARE v_avg_MUID decimal(24, 8);
  DECLARE v_max_qty decimal(24, 8);
  DECLARE v_avg_qty decimal(24, 8);
  DECLARE v_qty decimal(24, 8);
  DECLARE v_max_qty_cbm decimal(24, 8);
  DECLARE v_avg_qty_cbm decimal(24, 8);
  DECLARE v_qty_cbm decimal(24, 8);
  DECLARE v_chargeType varchar(255);
  DECLARE v_countDays varchar(255);
  DECLARE v_storageType varchar(255);
  -- Declare for Billing
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY int;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_Days int(11);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int(11);
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rate_udf03 varchar(50);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF03 varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_qtyMinimumContract decimal(24, 8);
  DECLARE R_chamberName varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 6);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 6);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 6);
  DECLARE R_CLASSTO decimal(24, 6);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib.organizationId,
    zib.warehouseId,
    zib.customerId,
    SUM(zib.qty_TraceId) AS sum_traceId,
    SUM(zib.qty_MUID) AS sum_MUID,
    MAX(zib.qty_TraceId) AS max_TraceId,
    AVG(zib.qty_TraceId) AS avg_TraceId,
    MAX(zib.qty_MUID) AS max_MUID,
    AVG(zib.qty_MUID) AS avg_MUID,
    SUM(zib.qty) AS sum_qty,
    MAX(zib.qty) AS max_qty,
    AVG(zib.qty) AS avg_qty,
    SUM(zib.qty_cbm) AS sum_cbm,
    MAX(zib.qty_cbm) AS max_qty_cbm,
    AVG(zib.qty_cbm) AS avg_qty_cbm,
    zib.udf01,
    SUM(zib.udf02),
    zib.chargeType
  FROM Z_BIL_AKUM_DAYS_STORAGE zib
  WHERE zib.organizationId = IN_organizationId
  AND zib.customerId = IN_CustomerId
  AND zib.StockDate BETWEEN DATE_FORMAT(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), '%Y-%m-%d') AND DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)
  --  AND zib.StockDate >= '2025-05-26'
  --  AND zib.StockDate <= '2025-06-25'
  AND zib.warehouseId = IN_warehouseId
  AND zib.chargeType = 'STRG'
  GROUP BY zib.organizationId,
           zib.warehouseId,
           zib.customerId,
           zib.udf01,
           zib.chargeType
  ORDER BY zib.organizationId, zib.warehouseId, zib.customerId, zib.chargeType;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_qty_TraceId, v_qty_MUID, v_max_TraceId, v_avg_TraceId, v_max_MUID, v_avg_MUID, v_qty, v_max_qty, v_avg_qty, v_qty_cbm, v_max_qty_cbm, v_avg_qty_cbm, v_storageType, v_countDays, v_chargeType;




    -- Exit the loop if no more rows
    IF done = 1 THEN

      LEAVE read_loop;
    END IF;




    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = v_organizationId
        AND bs.warehouseId = v_warehouseId
        AND bs.customerId = v_customerId
        AND bs.billingFromDate BETWEEN DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d') AND DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)
        --        AND bs.billingFromDate>= IN_datefrom
        --        AND bs.billingFromDate<= IN_dateto
        -- DATE(DATE_ADD(CURDATE(), INTERVAL -1 MONTH))
        -- AND DATE(bs.billingFromDate) = v_stockDate
        -- AND bs.descr = v_workingArea
        AND bs.chargeCategory = 'IV'
        AND bs.chargeType = 'ST'
        AND bs.notes = v_storageType
        AND bs.arNo IN ('*')) THEN


    BLOCK2:
      BEGIN
        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bcm.organizationId,
          bcm.warehouseId,
          bcm.CUSTOMERID,
          DATE_FORMAT(DATE(DATE_ADD(bth.billingdate, INTERVAL -1 DAY)), '%d') AS billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          -- if (btr.udf02 = '',0,btr,udf02) as minQty,-- minimum billing
          btr.udf03,-- chamber name
          IF(btr.UDF02 = '', 0, btr.UDF02) AS minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 AS billMode,
          btd.locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(btr.classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          IF(btr.udf03 = '', 0, btr.udf03) AS storageType,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bcm.customerId
            AND bc.organizationId = bcm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bcm.organizationId
            AND bth.tariffMasterId = bcm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
          LEFT JOIN BSM_CODE_ML bm
            ON bm.organizationId = btd.organizationId
            AND bm.codeId = btd.udf04
            AND bm.codeType = 'SP_TRACEID'
            AND bm.languageId = 'en'

        WHERE bcm.organizationId = v_organizationId
        AND bcm.warehouseId = v_warehouseId
        AND bcm.customerId = v_customerId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IV'
        AND btd.chargeType = 'ST'
        AND btr.rate > 0
        AND CASE WHEN bcm.customerId IN ('ECMAMA', 'ECMAMAB2C', 'MAPCLUB', 'CERESSMG', 'NLDC', 'NLDCSBY', 'CERESSBY', 'PT.ITT_MDN', 'PPG', 'DNN_MDN', 'MAP') THEN (btr.udf03 = v_storageType) ELSE (btr.udf03 = '') END
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bcm.organizationId, bcm.warehouseId, bcm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo, btr.rate, btr.udf03;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd


        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount,/*R_qtyMinimumContract,*/ R_chamberName, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_rate_udf03, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;

          /*SELECT
                    'look->',
                    tariff_done,
                    R_RESULTQTYCHARGE,
                      v_qty_TraceId,
                      v_qty_MUID,
                      v_max_TraceId,
                      v_avg_TraceId,
                      v_max_MUID,
                      v_avg_MUID,
          			v_qty,
                      v_max_qty,
                      v_avg_qty,
                      v_chargeType,
                      R_minAmount,
                      R_rate,
                      R_ratePerUnit;*/
          --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;


          IF tariff_done = 1 THEN
            SET tariff_done = 0;
            LEAVE getTariff;
          END IF;

          -- SELECT R_CUSTOMERID,R_WAREHOUSEID;
          -- SELECT tariff_done;


          IF (LTRIM(RTRIM(R_WAREHOUSEID)) = LTRIM(RTRIM(v_warehouseId)))
            AND (LTRIM(RTRIM(R_CUSTOMERID)) = LTRIM(RTRIM(v_customerId))) THEN

            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH


            --           SELECT  'check=>',R_ratebase,R_TARIFFID;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';

            /*IF (R_billMode = 'CUBIC') THEN
             IF(v_max_TraceId > sum(R_minAmount/(R_rate/R_ratePerUnit)) THEN
                SET R_RESULTQTYCHARGE = v_max_TraceId;
              ELSE
                SET R_RESULTQTYCHARGE = R_minAmount;
              END IF;*/


            IF (R_billMode = 'MAXTRACE') THEN
              IF v_customerId IN ('LTL')
                AND v_warehouseId IN ('CBT01') THEN
                IF (v_max_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (v_max_TraceId - R_minQty);
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId IN ('PPG')
                AND R_rate_udf03 = 'NON WH-C' THEN
                IF (v_max_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_max_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId IN ('DNN_MDN')
                AND v_warehouseId IN ('KIMSTR')
                AND R_TARIFFMASTERID = 'BIL00085' THEN
                IF ((v_max_TraceId * 1.44) > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (v_max_TraceId * 1.44);
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId NOT IN ('LTL', 'PPG', 'DNN_MDN') THEN
                IF (v_max_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_max_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              END IF;
            ELSEIF (R_billMode = 'MAXPL') THEN
              IF v_customerId IN ('NIA_SBY', 'SKU_SBY')
                AND v_warehouseId IN ('SBYKK') THEN
                IF (v_max_MUID > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (v_max_MUID * v_countDays);
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId IN ('API')
                AND v_warehouseId IN ('CBT02') THEN
                IF ((((v_max_MUID * 1.44) / 2) + ((((v_max_MUID * 1.44) / 2) / 6.5) * 3.5)) > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (((v_max_MUID * 1.44) / 2) + ((((v_max_MUID * 1.44) / 2) / 6.5) * 3.5));
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId NOT IN ('NIA_SBY', 'SKU_SBY', 'API') THEN
                IF (v_max_MUID > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_max_MUID;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              END IF;
            /*            ELSEIF (R_billMode = 'MAXPL') and v_customerId in ('NIA_SBY','SKU_SBY') THEN
                          IF (v_max_MUID > R_minQty) then
                            SET R_RESULTQTYCHARGE = (v_max_MUID * v_countDays);
                          ELSE
                            SET R_RESULTQTYCHARGE = (R_minQty * v_countDays);
                          END IF;           
             */
            ELSEIF (R_billMode = 'MAXQTY') THEN
              IF v_customerId IN ('PT.ITT_MDN')
                AND v_warehouseid = 'KIMSTR'
                AND v_storageType = 'REGULER' THEN
                IF ((v_max_qty / 1000) > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = (v_max_qty / 1000);
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId IN ('PT.ITT_MDN')
                AND v_warehouseid = 'KIMSTR'
                AND v_storageType = 'EXCESS' THEN
                IF ((v_max_qty / 1000) > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = 1;
                ELSE
                  SET R_RESULTQTYCHARGE = 1;
                END IF;
              ELSEIF v_customerId NOT IN ('PT.ITT_MDN') THEN
                IF (v_max_qty > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_max_qty;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              END IF;
            /*             ELSEIF (R_billMode = 'MAXQTY') and v_customerId in ('PT.ITT_MDN')  and v_storageType = 'EXCESS' THEN
                          IF ((v_max_qty/1000) > R_minQty) then
                            SET R_RESULTQTYCHARGE = 1;
                          ELSE
                            SET R_RESULTQTYCHARGE = 1;
                          END IF;           
                         ELSEIF (R_billMode = 'MAXQTY') and v_customerId in ('PT.ITT_MDN')  and v_storageType = 'REGULER' THEN
                          IF ((v_max_qty/1000) > R_minQty) then
                            SET R_RESULTQTYCHARGE = (v_max_qty/1000);
                          ELSE
                            SET R_RESULTQTYCHARGE = R_minQty;
                          END IF;           
            */
            ELSEIF (R_billMode = 'AVGTRACE') THEN
              IF v_customerId IN ('PPG')
                AND R_rate_udf03 IN ('WH-C') THEN
                IF (v_avg_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_avg_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              ELSEIF v_customerId NOT IN ('PPG')
                AND R_rate_udf03 NOT IN ('WH-C') THEN
                IF (v_avg_TraceId > R_minQty) THEN
                  SET R_RESULTQTYCHARGE = v_avg_TraceId;
                ELSE
                  SET R_RESULTQTYCHARGE = R_minQty;
                END IF;
              END IF;
            ELSEIF (R_billMode = 'AVGLOC') THEN
              IF (v_avg_TraceId > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_avg_TraceId;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'AVGPL') THEN
              IF (v_avg_MUID > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_avg_MUID;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'AVGQTY') THEN
              IF (v_avg_qty > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_avg_qty;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MONTHTRACE') THEN
              IF (v_qty_TraceId > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty_TraceId;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MONTHLOC') THEN
              IF (v_qty_MUID > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty_MUID;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MONTHPL') THEN
              IF (v_qty_MUID > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty_MUID;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MONTHQTY') THEN
              IF (v_qty > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'MAXCBM') THEN
              IF (v_max_qty_cbm > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_max_qty_cbm;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            ELSEIF (R_billMode = 'INTRACE') THEN
              IF (v_qty_TraceId > R_minQty) THEN
                SET R_RESULTQTYCHARGE = v_qty_TraceId;
              ELSE
                SET R_RESULTQTYCHARGE = R_minQty;
              END IF;
            END IF;
            SELECT
              'TRAP',
              R_rate,
              R_billMode,
              R_rate_udf03,
              v_storageType,
              R_minAmount,
              R_rate,
              R_ratePerUnit,
              R_RESULTQTYCHARGE;

            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND chargeRate = R_rate
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND chargeRate = R_rate
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND chargeRate = R_rate
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY

            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #


            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                v_organizationId,
                v_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                R_BILLINGDATE,
                R_BILLINGDATE,
                v_customerId,
                '',
                '',
                '',
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                R_descrC,
                -- '',
                R_rateBase,
                R_rateperunit,
                R_RESULTQTYCHARGE,
                '',
                0,
                0,
                R_rate,
                (R_RESULTQTYCHARGE * R_rate) / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)),
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                '',
                '',
                '' createTransactionid,
                R_rate_udf03 AS notes,
                NOW() ediSendTime,
                v_customerId AS billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                0 udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                'CUSTOMBILL' addWho,
                NOW() ADDTIME,
                'CUSTOMBILL' editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;

      END;
    ELSE
      ITERATE read_loop;
    END IF;

  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLSTORAGE_MONTH_CBM`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLSTORAGE_MONTH_CBM (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(30),
IN IN_language varchar(30),
IN IN_customerId varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE v_stockDate date;
  DECLARE v_customerId varchar(20);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_skuGroup1 varchar(255);
  DECLARE v_qtyCharge decimal(18, 4);
  DECLARE v_storagetype varchar(100);


  -- Declare for Billing
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_Days int;
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF03 varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_qtyMinimumContract decimal(24, 8);
  DECLARE R_customInformation varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR

  SELECT
    zbads.warehouseId,
    zbads.customerId,
    MAX(zbads.qty_cbm) AS qty_charge,
    zbads.UDF01 AS storage_type,
    DATE(DATE_ADD(NOW(), INTERVAL -1 DAY)) AS stockdate   -- stock date generate must H-1 26 end of month
  FROM Z_BIL_AKUM_DAYS_STORAGE zbads
  WHERE zbads.organizationId = IN_organizationId
  AND zbads.chargeType = 'STRG'
  AND zbads.customerId = IN_CustomerId
  AND DATE(zbads.StockDate) >= '2025-04-26'
  AND DATE(zbads.StockDate) <= '2025-05-18'
  GROUP BY zbads.warehouseId,
           zbads.customerId,
           zbads.UDF01;

  -- Declare a handler for NOT FOUND condition
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_warehouseId, v_customerId, v_qtyCharge, v_storagetype, v_stockDate;

    SELECT
      v_warehouseId,
      v_customerId,
      v_qtyCharge,
      v_storagetype,
      v_stockDate;

    IF done = 1 THEN
      LEAVE read_loop;
    END IF;

    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = IN_organizationId
        AND bs.warehouseId = v_warehouseId
        AND bs.customerId = v_customerId
        -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
        AND DATE(bs.billingFromDate) = DATE(NOW())
        AND bs.descr = v_storagetype
        AND bs.chargeCategory = 'IV') THEN



    BLOCK2:
      BEGIN
        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          btr.udf02,-- minimum billing
          btr.udf03,-- chamber name  / storage type
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = v_warehouseId
        AND bsm.customerId = v_customerId
        AND btr.udf03 = v_storagetype -- for filter chamber name /custom information
        -- AND bth.tariffMasterId = od_tariffMasterId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IV'
        AND btr.rate > 0
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;


        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd

        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_qtyMinimumContract, R_customInformation, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;


          IF tariff_done = 1 THEN
            SET tariff_done = 0;
            LEAVE getTariff;
          END IF;



          SELECT
            R_WAREHOUSEID,
            v_warehouseId,
            R_CUSTOMERID,
            v_customerId,
            R_customInformation,
            v_storagetype;

          IF (LTRIM(RTRIM(R_WAREHOUSEID)) = LTRIM(RTRIM(v_warehouseId)))
            AND (LTRIM(RTRIM(R_CUSTOMERID)) = LTRIM(RTRIM(v_customerId)))
            AND (LTRIM(RTRIM(R_customInformation)) = LTRIM(RTRIM(v_storagetype))) THEN



            --           SELECT  'check=>',R_ratebase,R_TARIFFID;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';



            IF (v_qtyCharge > R_qtyMinimumContract) THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSE
              SET R_RESULTQTYCHARGE = R_qtyMinimumContract;
            END IF;






            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #
            SELECT
              R_RESULTQTYCHARGE * R_rate,
              v_storagetype;


          --             INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
          --             , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
          --             , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
          --             , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
          --             , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
          --             , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
          --             , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
          --             , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
          --             , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
          --             , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
          --               SELECT
          --                 IN_organizationId,
          --                 v_warehouseId,
          --                 CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
          --                 DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
          --                 DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
          --                 v_customerId,
          --                 '',
          --                 '',
          --                 '',
          --                 R_TARIFFID,
          --                 R_CHARGECATEGORY,
          --                 R_chargetype,
          --                 -- R_descrC,
          --                 CONCAT(v_storagetype),
          --                 R_rateBase,
          --                 R_rateperunit,
          --                 R_RESULTQTYCHARGE,
          --                 '',
          --                 0,
          --                 0,
          --                 R_rate,
          --                 R_RESULTQTYCHARGE * R_rate / R_rateperunit,
          --                 (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
          --                 0,
          --                 R_cost * R_RESULTQTYCHARGE,
          --                 0,
          --                 NOW() confirmTime,
          --                 '' confirmWho,
          --                 '',
          --                 '',
          --                 '' createTransactionid,
          --                 '' notes,
          --                 NOW() ediSendTime,
          --                 v_customerId AS billTo,
          --                 NOW() settleTime,
          --                 '' settleWho,
          --                 '' followUp,
          --                 '' invoiceType,
          --                 '' paidTo,
          --                 '' costConfirmFlag,
          --                 NOW() costConfirmTime,
          --                 '' costConfirmWho,
          --                 '' costSettleFlag,
          --                 NOW() costSettleTime,
          --                 '' costSettleWho,
          --                 0 incomeTaxRate,
          --                 0 costTaxRate,
          --                 R_INCOMETAX incomeTax,
          --                 0 cosTax,
          --                 R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
          --                 0 cosWithoutTax,
          --                 '' costInvoiceType,
          --                 '' noteText,
          --                 R_materialNo AS udf01,
          --                 R_itemChargeCategory AS udf02,
          --                 0 udf03,
          --                 R_UDF06 udf04,
          --                 '' udf05,
          --                 0 currentVersion,
          --                 '2020' oprSeqFlag,
          --                 IN_USERID addWho,
          --                 NOW() ADDTIME,
          --                 IN_USERID editWho,
          --                 NOW() editTime,
          --                 R_LOCATIONCAT locationCategory,
          --                 '' manual,
          --                 0 lineCount,
          --                 '*' arNo,
          --                 0 arLineNo,
          --                 '*' apNo,
          --                 0 apLineNo,
          --                 'N' ediSendFlag,
          --                 '' ediErrorCode,
          --                 '' ediErrorMessage,
          --                 NOW() ediSendTime2,
          --                 'N' ediSendFlag2,
          --                 '' ediErrorCode2,
          --                 '' ediErrorMessage2,
          --                 '' billingTranCategory,
          --                 '' orderType,
          --                 '' containerType,
          --                 '' containerSize;
          -- 
          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;



      END;
    ELSE
      ITERATE read_loop;
    END IF;



  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLSTORAGE_DAILY_PER_SKUGROUP`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLSTORAGE_DAILY_PER_SKUGROUP (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT FALSE;
  DECLARE tariff_done int DEFAULT FALSE;
  DECLARE v_stockDate date;
  DECLARE v_customerId varchar(20);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_skuGroup1 varchar(255);
  DECLARE v_qtyCharge decimal(18, 4);

  -- Declare for Billing
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_Days int;
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS stockDate,
    zib.customerId,
    zib.warehouseId AS warehouseId,
    s.sku_group1 AS skugroup1,
    SUM(CASE WHEN zib.customerId = 'MDS' THEN (CASE WHEN pd2.uomdescr = 'KG' THEN zib.qtyonHand ELSE zib.qtyonHand * s.sku_group6 END) ELSE zib.qtyonHand END) AS qtyCharge
  FROM Z_InventoryBalance zib
    LEFT JOIN INV_LOT_ATT la
      ON la.organizationId = zib.organizationId
      AND la.customerId = zib.customerId
      AND la.sku = zib.sku
      AND la.lotNum = zib.lotNum
    LEFT OUTER JOIN (SELECT
        *
      FROM BSM_CODE_ML
      WHERE codetype = 'OWNER_LTL'
      AND languageid = 'en') la1
      ON la.organizationId = la1.organizationId
      AND la.lotatt11 = la1.codeid
    LEFT JOIN BAS_LOCATION l
      ON l.organizationId = zib.organizationId
      AND l.locationId = zib.locationId
      AND l.warehouseId = zib.warehouseId
    LEFT JOIN BAS_SKU s
      ON s.organizationId = zib.organizationId
      AND s.customerId = zib.customerId
      AND s.sku = zib.sku
    LEFT JOIN BAS_SKU_MULTIWAREHOUSE sm
      ON sm.organizationId = zib.organizationId
      AND sm.customerId = zib.customerId
      AND sm.sku = zib.sku
      AND sm.warehouseId = zib.warehouseId
    LEFT JOIN BAS_PACKAGE_DETAILS pd
      ON sm.organizationId = pd.organizationId
      AND sm.customerId = pd.customerId
      AND sm.packId = pd.packId
      AND pd.packUom = 'PL'
    LEFT JOIN BAS_PACKAGE_DETAILS pd1
      ON sm.organizationId = pd1.organizationId
      AND sm.customerId = pd1.customerId
      AND sm.packId = pd1.packId
      AND pd1.packUom = 'CS'
    LEFT JOIN BAS_PACKAGE_DETAILS pd2
      ON sm.organizationId = pd2.organizationId
      AND sm.customerId = pd2.customerId
      AND sm.packId = pd2.packId
      AND pd2.packUom = 'EA'
    LEFT JOIN BSM_CODE_ML lc
      ON lc.organizationId = zib.organizationId
      AND zib.locationCategory = lc.codeid
      AND lc.codeType = 'LOC_CAT'
      AND lc.languageId = 'en'
    LEFT JOIN BSM_CODE_ML lc1
      ON lc1.organizationId = la.organizationId
      AND la.lotAtt07 = lc1.codeid
      AND lc1.codeType = 'PLT_TYP'
      AND lc1.languageId = 'en'
    LEFT JOIN BSM_CODE_ML lc2
      ON lc2.organizationId = la.organizationId
      AND la.lotAtt08 = lc2.codeid
      AND lc2.codeType = 'DMG_FLG'
      AND lc2.languageId = 'en'
  WHERE zib.organizationId = IN_organizationId
  AND zib.warehouseId = IN_warehouseId
  AND zib.customerId = IN_CustomerId
  -- AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
  AND DATE(zib.StockDate) > '2025-01-20'
  AND DATE(zib.StockDate) < '2025-01-22'
  AND qtyonHand > 0
  AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20',/* 'SORTATIONCBT01', */ 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATIONCBT02', 'SORTATIONCBT03', 'SORTATION', 'SORTATIONMRD02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA', 'B04A065', 'B04A066', 'B04B065', 'B04B065')
  AND zib.sku NOT IN (SELECT
      sku
    FROM BAS_SKU bs2
    WHERE organizationId = zib.organizationId
    AND customerId = 'LTL'
    AND sku LIKE '13%'
    UNION ALL
    SELECT
      sku
    FROM BAS_SKU bs2
    WHERE organizationid = zib.organizationId
    AND customerid = 'SMARTSBY'
    AND sku = 'PALLET'
    UNION ALL
    SELECT
      sku
    FROM BAS_SKU
    WHERE organizationid = zib.organizationId
    AND customerid IN ('ECMAMA', 'ECMAMAB2C')
    AND sku LIKE '%TEST%'
    UNION ALL
    SELECT
      sku
    FROM BAS_SKU
    WHERE organizationid = zib.organizationId
    AND customerid IN ('MAP')
    AND sku IN ('DEMO TABLE AT', 'DEMO TABLE SAM', 'HOT STAMP'))
  GROUP BY zib.warehouseId,
           s.sku_group1,
           zib.StockDate,
           zib.customerId
  ORDER BY zib.customerId;

  -- Declare a handler for NOT FOUND condition
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_stockDate, v_customerId, v_warehouseId, v_skuGroup1, v_qtyCharge;

    -- Exit the loop if no more rows
    IF done THEN
      LEAVE read_loop;
    END IF;

    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = IN_organizationId
        AND bs.warehouseId = IN_warehouseId
        AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
        AND bs.descr = v_skuGroup1
        AND bs.chargeCategory = 'IV') THEN

    BLOCK2:
      BEGIN



        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = IN_warehouseId
        AND bsm.customerId = IN_CustomerId
        -- AND bth.tariffMasterId = od_tariffMasterId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IV'
        AND btd.udf08 = v_skuGroup1
        AND btr.rate > 0
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;
          IF tariff_done THEN
            SET tariff_done = FALSE;
            LEAVE getTariff;
          END IF;





          IF (LTRIM(RTRIM(R_UDF08)) = LTRIM(RTRIM(v_skuGroup1))) THEN
            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH


            --           SELECT  'check=>',R_ratebase,R_TARIFFID;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';


            IF (R_ratebase = 'CUBIC') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'M2') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'IP') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'KG') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'LITER') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'DO') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'PALLET') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'CASE') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'QUANTITY') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'NETWEIGHT') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'GW') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            /*additional nettweight grossweight*/
            ELSEIF (R_ratebase = 'MT') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            END IF;



            --           SELECT 'check 2=>',R_RESULTQTYCHARGE;

            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #
            SELECT
              R_billsummaryId;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                IN_organizationId,
                IN_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
                DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
                v_customerId,
                '',
                '',
                '',
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                -- R_descrC,
                v_skuGroup1,
                R_rateBase,
                R_rateperunit,
                v_qtyCharge,
                '',
                0,
                0,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                '',
                '',
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                v_customerId AS billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                0 udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;






      END;

    END IF;



  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLSTORAGE_DAILY_CBM_DATE`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLSTORAGE_DAILY_CBM_DATE (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30),
IN IN_datefrom varchar(30),
IN IN_dateto varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE v_stockDate date;
  DECLARE v_customerId varchar(20);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_skuGroup1 varchar(255);
  DECLARE v_workingArea varchar(255);
  DECLARE v_qtyCharge decimal(18, 4);

  -- Declare for Billing
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_Days int;
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF03 varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_qtyMinimumContract decimal(24, 8);
  DECLARE R_chamberName varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    DATE_FORMAT(ls_storage.stockdate, '%Y-%m-%d') AS stockDate,
    ls_storage.warehouseid,
    ls_storage.customerid,
    ls_storage.workingArea,
    SUM(ls_storage.qtycbm) AS qtycbm
  FROM (SELECT
      DATE_FORMAT(stockDate, '%Y-%m-%d') AS stockdate,
      zib.warehouseId AS warehouseid,
      sm.tariffMasterId AS tariffmasterid,
      CASE WHEN zib.customerId = 'LTL' THEN la1.codeDescr ELSE sm.tariffId END AS tariffid,
      CASE WHEN zib.customerId = 'XXX' THEN 'SAMSONITE' ELSE zib.customerId END AS customerid,
      zib.locationId AS locationid,
      zib.locationCategory AS locationcategory,
      lc.codeDescr AS locationcategorydescr,
      zib.TRACEID AS traceid,
      s.sku_group1 AS muidltl,
      zib.muid AS muid,
      zib.lotNum AS lotnum,
      s.PACKID AS packid,
      CASE WHEN zib.customerId = 'MDS' THEN 'KG' ELSE zib.UOM END AS uom,
      CASE WHEN zib.warehouseId = 'CBT02' THEN 'LINC' WHEN zib.warehouseId = 'CBT03' AND
          /*l.workingArea = 'WHTMLA' THEN 'WHTMLA' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLB' THEN 'WHTMLB' WHEN zib.warehouseId = 'CBT03' AND*/
          l.workingArea = 'WHTMLC' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLD' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLE' THEN 'WHTMLE+G' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLG' THEN 'WHTMLE+G' WHEN zib.warehouseId = 'JBK01' AND
          l.locationId LIKE 'A%' THEN 'A' WHEN zib.warehouseId = 'JBK01' AND
          l.locationId LIKE 'RCV%' THEN 'A' ELSE l.workingArea END AS workingArea,
      /*before updatel.workingArea = 'WHTMLA' THEN 'WHTMLA' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLB' THEN 'WHTMLB' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLC' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLD' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTML3' THEN 'WHTMLE' ELSE l.workingArea END AS workingArea,
       * AB 24/12/30
       */
      zib.SKU AS sku,
      skuDesc AS skudesc,
      la.lotatt09 AS ponum,
      lc1.codeDescr AS typepallet,
      CASE WHEN zib.customerId = 'MDS' THEN (
            CASE WHEN pd2.uomDescr = 'KG' THEN zib.qtyonHand ELSE zib.qtyonHand * s.sku_group6 END
            ) ELSE zib.qtyonHand END AS qtyonhand,
      pd.qty AS qtyperpallet,
      CASE zib.customerId WHEN 'ASP' THEN zib.cube WHEN 'MAP' THEN s.cube WHEN 'ONDULINE' THEN s.cube WHEN 'SST_JKT' THEN s.cube WHEN 'CPI_JKT' THEN s.cube ELSE s.cube / 1000000 END AS cbmsku,
      CASE zib.customerId WHEN 'MAP' THEN (
            CASE WHEN la.lotatt04 = 'SET' THEN 0 ELSE (s.cube * zib.qtyonHand) END
            ) WHEN 'ONDULINE' THEN s.cube * zib.qtyonHand ELSE totalcube END AS qtycbm,
      CASE WHEN LENGTH(zib.locationId) = 7 THEN SUBSTRING(zib.locationId, 1, 1) WHEN LENGTH(zib.locationId) = 8 THEN SUBSTRING(zib.locationId, 1, 1) WHEN SUBSTRING(zib.locationId, 1, 3) = 'TML' AND
          zib.customerId <> 'LTL' THEN SUBSTRING(zib.locationId, 4, 1) WHEN sm.putawayRule = 'LTL09' THEN 'E' WHEN zib.SKU IN ('000000001100012851', '000000001100010211', '000000001100000616', '000000001100013296', '000000001100008797', '000000001100012070', '000000001100012068', '000000001100012478', '000000001100012898', '000000001100014515') THEN 'G' WHEN sm.putawayRule IN ('LTL03', 'GMPA-NONDG', 'ICHIKOH-NONDG', 'ITOCHU-NONDG', 'PMM-NONDG', 'LTL06', 'LTL07') THEN 'G' WHEN sm.putawayRule IN ('LTL08', 'ITOCHU-DG', 'PMM-DG', 'LTL01', 'LTL02', 'SMT') THEN 'B' WHEN sm.putawayRule = 'LTL-BULK' THEN 'D' WHEN sm.putawayRule IN ('BAJ', 'PLB-LTL', 'ADF', 'CCDI', 'CTI') THEN 'A' WHEN sm.putawayRule IN ('GYI', 'DKJ') THEN 'J' WHEN sm.putawayRule = 'LTL04' THEN 'B' WHEN sm.putawayRule IN ('DNN', 'PMM', 'ITOCHU') THEN 'C' ELSE l.udf03 END AS chamber,
      sm.putawayRule AS putawayrule,
      la.lotatt04 AS batchno,
      la.lotatt02 AS expiredate,
      la.lotatt03 AS whdate,
      CASE WHEN zib.customerId = 'ECCOSBY' THEN (
            CASE WHEN SUBSTRING(zib.locationId, 3, 1) = 'I' THEN 'ECCO2' ELSE 'ECCO' END
            ) ELSE SUBSTRING(zib.locationId, 1, 1) END AS area,
      CASE WHEN zib.customerId = 'PLB-LTL' THEN la.lotatt10 ELSE la.lotatt09 END AS externalpo,
      lc2.codeDescr AS whetherdamaged,
      CEILING(qtyonHand / pd.qty) AS palletused,
      CASE WHEN zib.customerId = 'RBFOOD' THEN pd1.qty ELSE s.NETWEIGHT END AS netweight
    FROM Z_InventoryBalance zib
      LEFT JOIN INV_LOT_ATT la
        ON la.organizationId = zib.organizationId
        AND la.customerId = zib.customerId
        AND la.sku = zib.sku
        AND la.lotNum = zib.lotNum
      LEFT OUTER JOIN (SELECT
          *
        FROM BSM_CODE_ML
        WHERE codetype = 'OWNER_LTL'
        AND languageid = 'en') la1
        ON la.organizationId = la1.organizationId
        AND la.lotatt11 = la1.codeid
      LEFT JOIN BAS_LOCATION l
        ON l.organizationId = zib.organizationId
        AND l.locationId = zib.locationId
        AND l.warehouseId = zib.warehouseId
      LEFT JOIN BAS_SKU s
        ON s.organizationId = zib.organizationId
        AND s.customerId = zib.customerId
        AND s.sku = zib.sku
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE sm
        ON sm.organizationId = zib.organizationId
        AND sm.customerId = zib.customerId
        AND sm.sku = zib.sku
        AND sm.warehouseId = zib.warehouseId
      LEFT JOIN BAS_PACKAGE_DETAILS pd
        ON sm.organizationId = pd.organizationId
        AND sm.customerId = pd.customerId
        AND sm.packId = pd.packId
        AND pd.packUom = 'PL'
      LEFT JOIN BAS_PACKAGE_DETAILS pd1
        ON sm.organizationId = pd1.organizationId
        AND sm.customerId = pd1.customerId
        AND sm.packId = pd1.packId
        AND pd1.packUom = 'CS'
      LEFT JOIN BAS_PACKAGE_DETAILS pd2
        ON sm.organizationId = pd2.organizationId
        AND sm.customerId = pd2.customerId
        AND sm.packId = pd2.packId
        AND pd2.packUom = 'EA'
      LEFT JOIN BSM_CODE_ML lc
        ON lc.organizationId = zib.organizationId
        AND zib.locationCategory = lc.codeid
        AND lc.codeType = 'LOC_CAT'
        AND lc.languageId = 'en'
      LEFT JOIN BSM_CODE_ML lc1
        ON lc1.organizationId = la.organizationId
        AND la.lotAtt07 = lc1.codeid
        AND lc1.codeType = 'PLT_TYP'
        AND lc1.languageId = 'en'
      LEFT JOIN BSM_CODE_ML lc2
        ON lc2.organizationId = la.organizationId
        AND la.lotAtt08 = lc2.codeid
        AND lc2.codeType = 'DMG_FLG'
        AND lc2.languageId = 'en'
    WHERE zib.organizationId = IN_organizationId
    AND DATE(zib.StockDate) >= IN_datefrom
    AND DATE(zib.StockDate) <= IN_dateto
    -- AND zib.warehouseId IN ('LADC01')
    AND zib.warehouseId IN ('CBT02', 'CBT03', 'LADC01', 'JBK01')
    -- AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))

    AND zib.customerId = IN_CustomerId
    AND zib.qtyonHand > 0
    AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATIONCBT02', 'SORTATIONCBT03', 'SORTATION', 'SORTATIONMRD02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA', 'B04A065', 'B04A066', 'B04B065', 'B04B065')
    AND zib.sku NOT IN (SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationId = zib.organizationId
      AND customerId = 'LTL'
      AND sku LIKE '13%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationid = zib.organizationId
      AND customerid = 'SMARTSBY'
      AND sku = 'PALLET'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('ECMAMA', 'ECMAMAB2C')
      AND sku LIKE '%TEST%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('MAP')
      AND sku IN ('DEMO TABLE AT', 'DEMO TABLE SAM', 'HOT STAMP'))
    ORDER BY zib.customerId) ls_storage
  GROUP BY ls_storage.warehouseId,
           ls_storage.customerId,
           ls_storage.StockDate,
           ls_storage.workingArea
  ORDER BY ls_storage.customerId, stockDate, ls_storage.workingArea;
  --   UNION ALL
  --   SELECT
  --     DATE(DATE_ADD(NOW(), INTERVAL -1 DAY)) AS stockDate,
  --     bth.warehouseId,
  --     btm.customerId,
  --     btr.udf03 AS workingArea,
  --     0 AS qtycbm
  --   FROM BIL_TARIFF_HEADER bth
  --     INNER JOIN BIL_TARIFF_DETAILS btd
  --       ON bth.organizationId = btd.organizationId
  --       AND bth.warehouseId = btd.warehouseId
  --       AND bth.tariffId = btd.tariffId
  --     INNER JOIN BIL_TARIFF_RATE btr
  --       ON bth.organizationId = btr.organizationId
  --       AND bth.warehouseId = btr.warehouseId
  --       AND bth.tariffId = btr.tariffId
  --       AND btd.tariffLineNo = btr.tariffLineNo
  --     INNER JOIN BIL_TARIFF_MASTER btm
  --       ON bth.organizationId = btm.organizationId
  --       AND bth.tariffMasterId = btm.tariffMasterId
  --   WHERE bth.organizationId = IN_organizationId
  --   AND btd.warehouseId IN ('CBT02', 'CBT03', 'LADC01')
  --   AND btm.Customerid = IN_CustomerId
  --   AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  --   AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  --   AND btd.chargeCategory = 'IV'
  --   AND btr.rate > 0
  --   AND btr.udf03 NOT IN (SELECT DISTINCT
  --       CASE WHEN bl.warehouseId = 'CBT02' THEN 'LINC' ELSE bl.workingArea END AS workingArea
  --     FROM Z_InventoryBalance lc
  --       INNER JOIN BAS_LOCATION bl
  --         ON lc.organizationId = bl.organizationId
  --         AND lc.warehouseId = bl.warehouseId
  --         AND lc.locationId = bl.locationId
  --     WHERE lc.organizationId = IN_organizationId
  --     AND DATE(lc.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
  --     AND bl.warehouseId IN ('CBT02', 'CBT03', 'LADC01')
  --     AND lc.customerId = IN_CustomerId
  --     AND lc.qtyavailable > 0)
  --   ORDER BY stockDate ASC;

  -- Declare a handler for NOT FOUND condition
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_stockDate, v_warehouseId, v_customerId, v_workingArea, v_qtyCharge;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;

    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = IN_organizationId
        AND bs.warehouseId = v_warehouseId
        AND bs.customerId = v_customerId
        -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
        AND DATE(bs.billingFromDate) = v_stockDate
        AND bs.descr = v_workingArea
        AND bs.chargeCategory = 'IV') THEN


    BLOCK2:
      BEGIN
        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          btr.udf02,-- minimum billing
          btr.udf03,-- chamber name
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = v_warehouseId
        AND bsm.customerId = v_customerId
        AND btr.udf03 = v_workingArea -- for filter chamber name
        -- AND bth.tariffMasterId = od_tariffMasterId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IV'
        AND btr.rate > 0
        AND bth.tariffMasterId NOT IN ('BIL00062PT')
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;
        SELECT
          'look->',
          tariff_done;
        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd

        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_qtyMinimumContract, R_chamberName, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;

          --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
          IF tariff_done = 1 THEN
            SET tariff_done = 0;
            LEAVE getTariff;
          END IF;

          -- SELECT R_CUSTOMERID,R_WAREHOUSEID;
          -- SELECT tariff_done;



          IF (LTRIM(RTRIM(R_WAREHOUSEID)) = LTRIM(RTRIM(v_warehouseId)))
            AND (LTRIM(RTRIM(R_CUSTOMERID)) = LTRIM(RTRIM(v_customerId)))
            AND (LTRIM(RTRIM(R_chamberName)) = LTRIM(RTRIM(v_workingArea))) THEN
            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH


            --           SELECT  'check=>',R_ratebase,R_TARIFFID;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';


            IF (R_ratebase = 'CUBIC') THEN
              IF (v_qtyCharge > R_qtyMinimumContract) THEN
                SET R_RESULTQTYCHARGE = v_qtyCharge;
              ELSE
                SET R_RESULTQTYCHARGE = R_qtyMinimumContract;
              END IF;
            ELSEIF (R_ratebase = 'M2') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'IP') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'KG') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'LITER') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'DO') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'PALLET') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'CASE') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'QUANTITY') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'NETWEIGHT') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'GW') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            /*additional nettweight grossweight*/
            ELSEIF (R_ratebase = 'MT') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            END IF;

            SELECT
              'DEBUG=>',
              v_customerId,
              R_CUSTOMERID,
              R_WAREHOUSEID,
              v_warehouseId,
              R_RESULTQTYCHARGE;

            --           SELECT 'check 2=>',R_RESULTQTYCHARGE;

            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #
            SELECT
              R_billsummaryId;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                IN_organizationId,
                v_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
                DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
                v_customerId,
                '',
                '',
                '',
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                -- R_descrC,
                CONCAT(v_workingArea),
                R_rateBase,
                R_rateperunit,
                R_RESULTQTYCHARGE,
                '',
                0,
                0,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                '',
                '',
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                v_customerId AS billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                0 udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;






      END;
    ELSE
      ITERATE read_loop;
    END IF;



  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLSTORAGE_DAILY_CBM_BAK`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLSTORAGE_DAILY_CBM_BAK (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE v_stockDate date;
  DECLARE v_customerId varchar(20);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_skuGroup1 varchar(255);
  DECLARE v_workingArea varchar(255);
  DECLARE v_qtyCharge decimal(18, 4);

  -- Declare for Billing
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_Days int;
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF03 varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_qtyMinimumContract decimal(24, 8);
  DECLARE R_chamberName varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    DATE_FORMAT(ls_storage.stockdate, '%Y-%m-%d') AS stockDate,
    ls_storage.warehouseid,
    ls_storage.customerid,
    ls_storage.workingArea,
    SUM(ls_storage.qtycbm) AS qtycbm
  FROM (SELECT
      DATE_FORMAT(stockDate, '%Y-%m-%d') AS stockdate,
      zib.warehouseId AS warehouseid,
      sm.tariffMasterId AS tariffmasterid,
      CASE WHEN zib.customerId = 'LTL' THEN la1.codeDescr ELSE sm.tariffId END AS tariffid,
      CASE WHEN zib.customerId = 'XXX' THEN 'SAMSONITE' ELSE zib.customerId END AS customerid,
      zib.locationId AS locationid,
      zib.locationCategory AS locationcategory,
      lc.codeDescr AS locationcategorydescr,
      zib.TRACEID AS traceid,
      s.sku_group1 AS muidltl,
      zib.muid AS muid,
      zib.lotNum AS lotnum,
      s.PACKID AS packid,
      CASE WHEN zib.customerId = 'MDS' THEN 'KG' ELSE zib.UOM END AS uom,
      CASE WHEN zib.warehouseId = 'CBT02' THEN 'LINC' WHEN zib.warehouseId = 'CBT03' AND
          /*l.workingArea = 'WHTMLA' THEN 'WHTMLA' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLB' THEN 'WHTMLB' WHEN zib.warehouseId = 'CBT03' AND*/
          l.workingArea = 'WHTMLC' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLD' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLE' THEN 'WHTMLE+G' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLG' THEN 'WHTMLE+G' ELSE l.workingArea END AS workingArea,
      /*before updatel.workingArea = 'WHTMLA' THEN 'WHTMLA' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLB' THEN 'WHTMLB' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLC' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLD' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTML3' THEN 'WHTMLE' ELSE l.workingArea END AS workingArea,
       * AB 24/12/30
       */
      zib.SKU AS sku,
      skuDesc AS skudesc,
      la.lotatt09 AS ponum,
      lc1.codeDescr AS typepallet,
      CASE WHEN zib.customerId = 'MDS' THEN (
            CASE WHEN pd2.uomDescr = 'KG' THEN zib.qtyonHand ELSE zib.qtyonHand * s.sku_group6 END
            ) ELSE zib.qtyonHand END AS qtyonhand,
      pd.qty AS qtyperpallet,
      CASE zib.customerId WHEN 'ASP' THEN zib.cube WHEN 'MAP' THEN s.cube WHEN 'ONDULINE' THEN s.cube WHEN 'SST_JKT' THEN s.cube WHEN 'CPI_JKT' THEN s.cube ELSE s.cube / 1000000 END AS cbmsku,
      CASE zib.customerId WHEN 'MAP' THEN (
            CASE WHEN la.lotatt04 = 'SET' THEN 0 ELSE (s.cube * zib.qtyonHand) END
            ) WHEN 'ONDULINE' THEN s.cube * zib.qtyonHand ELSE totalcube END AS qtycbm,
      CASE WHEN LENGTH(zib.locationId) = 7 THEN SUBSTRING(zib.locationId, 1, 1) WHEN LENGTH(zib.locationId) = 8 THEN SUBSTRING(zib.locationId, 1, 1) WHEN SUBSTRING(zib.locationId, 1, 3) = 'TML' AND
          zib.customerId <> 'LTL' THEN SUBSTRING(zib.locationId, 4, 1) WHEN sm.putawayRule = 'LTL09' THEN 'E' WHEN zib.SKU IN ('000000001100012851', '000000001100010211', '000000001100000616', '000000001100013296', '000000001100008797', '000000001100012070', '000000001100012068', '000000001100012478', '000000001100012898', '000000001100014515') THEN 'G' WHEN sm.putawayRule IN ('LTL03', 'GMPA-NONDG', 'ICHIKOH-NONDG', 'ITOCHU-NONDG', 'PMM-NONDG', 'LTL06', 'LTL07') THEN 'G' WHEN sm.putawayRule IN ('LTL08', 'ITOCHU-DG', 'PMM-DG', 'LTL01', 'LTL02', 'SMT') THEN 'B' WHEN sm.putawayRule = 'LTL-BULK' THEN 'D' WHEN sm.putawayRule IN ('BAJ', 'PLB-LTL', 'ADF', 'CCDI', 'CTI') THEN 'A' WHEN sm.putawayRule IN ('GYI', 'DKJ') THEN 'J' WHEN sm.putawayRule = 'LTL04' THEN 'B' WHEN sm.putawayRule IN ('DNN', 'PMM', 'ITOCHU') THEN 'C' ELSE l.udf03 END AS chamber,
      sm.putawayRule AS putawayrule,
      la.lotatt04 AS batchno,
      la.lotatt02 AS expiredate,
      la.lotatt03 AS whdate,
      CASE WHEN zib.customerId = 'ECCOSBY' THEN (
            CASE WHEN SUBSTRING(zib.locationId, 3, 1) = 'I' THEN 'ECCO2' ELSE 'ECCO' END
            ) ELSE SUBSTRING(zib.locationId, 1, 1) END AS area,
      CASE WHEN zib.customerId = 'PLB-LTL' THEN la.lotatt10 ELSE la.lotatt09 END AS externalpo,
      lc2.codeDescr AS whetherdamaged,
      CEILING(qtyonHand / pd.qty) AS palletused,
      CASE WHEN zib.customerId = 'RBFOOD' THEN pd1.qty ELSE s.NETWEIGHT END AS netweight
    FROM Z_InventoryBalance zib
      LEFT JOIN INV_LOT_ATT la
        ON la.organizationId = zib.organizationId
        AND la.customerId = zib.customerId
        AND la.sku = zib.sku
        AND la.lotNum = zib.lotNum
      LEFT OUTER JOIN (SELECT
          *
        FROM BSM_CODE_ML
        WHERE codetype = 'OWNER_LTL'
        AND languageid = 'en') la1
        ON la.organizationId = la1.organizationId
        AND la.lotatt11 = la1.codeid
      LEFT JOIN BAS_LOCATION l
        ON l.organizationId = zib.organizationId
        AND l.locationId = zib.locationId
        AND l.warehouseId = zib.warehouseId
      LEFT JOIN BAS_SKU s
        ON s.organizationId = zib.organizationId
        AND s.customerId = zib.customerId
        AND s.sku = zib.sku
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE sm
        ON sm.organizationId = zib.organizationId
        AND sm.customerId = zib.customerId
        AND sm.sku = zib.sku
        AND sm.warehouseId = zib.warehouseId
      LEFT JOIN BAS_PACKAGE_DETAILS pd
        ON sm.organizationId = pd.organizationId
        AND sm.customerId = pd.customerId
        AND sm.packId = pd.packId
        AND pd.packUom = 'PL'
      LEFT JOIN BAS_PACKAGE_DETAILS pd1
        ON sm.organizationId = pd1.organizationId
        AND sm.customerId = pd1.customerId
        AND sm.packId = pd1.packId
        AND pd1.packUom = 'CS'
      LEFT JOIN BAS_PACKAGE_DETAILS pd2
        ON sm.organizationId = pd2.organizationId
        AND sm.customerId = pd2.customerId
        AND sm.packId = pd2.packId
        AND pd2.packUom = 'EA'
      LEFT JOIN BSM_CODE_ML lc
        ON lc.organizationId = zib.organizationId
        AND zib.locationCategory = lc.codeid
        AND lc.codeType = 'LOC_CAT'
        AND lc.languageId = 'en'
      LEFT JOIN BSM_CODE_ML lc1
        ON lc1.organizationId = la.organizationId
        AND la.lotAtt07 = lc1.codeid
        AND lc1.codeType = 'PLT_TYP'
        AND lc1.languageId = 'en'
      LEFT JOIN BSM_CODE_ML lc2
        ON lc2.organizationId = la.organizationId
        AND la.lotAtt08 = lc2.codeid
        AND lc2.codeType = 'DMG_FLG'
        AND lc2.languageId = 'en'
    WHERE zib.organizationId = IN_organizationId
    --  AND DATE(zib.StockDate) > '2025-01-26'
    --  AND DATE(zib.StockDate) < '2025-01-28'
    -- AND zib.warehouseId IN ('LADC01')
    AND zib.warehouseId IN ('CBT02', 'CBT03', 'LADC01')
    AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))

    AND zib.customerId = IN_CustomerId
    AND qtyonHand > 0
    AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATIONCBT02', 'SORTATIONCBT03', 'SORTATION', 'SORTATIONMRD02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA', 'B04A065', 'B04A066', 'B04B065', 'B04B065')
    AND zib.sku NOT IN (SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationId = zib.organizationId
      AND customerId = 'LTL'
      AND sku LIKE '13%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationid = zib.organizationId
      AND customerid = 'SMARTSBY'
      AND sku = 'PALLET'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('ECMAMA', 'ECMAMAB2C')
      AND sku LIKE '%TEST%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('MAP')
      AND sku IN ('DEMO TABLE AT', 'DEMO TABLE SAM', 'HOT STAMP'))
    ORDER BY zib.customerId) ls_storage
  GROUP BY ls_storage.warehouseId,
           ls_storage.customerId,
           ls_storage.StockDate,
           ls_storage.workingArea
  ORDER BY ls_storage.customerId, stockDate, ls_storage.workingArea;
  --   UNION ALL
  --   SELECT
  --     DATE(DATE_ADD(NOW(), INTERVAL -1 DAY)) AS stockDate,
  --     bth.warehouseId,
  --     btm.customerId,
  --     btr.udf03 AS workingArea,
  --     0 AS qtycbm
  --   FROM BIL_TARIFF_HEADER bth
  --     INNER JOIN BIL_TARIFF_DETAILS btd
  --       ON bth.organizationId = btd.organizationId
  --       AND bth.warehouseId = btd.warehouseId
  --       AND bth.tariffId = btd.tariffId
  --     INNER JOIN BIL_TARIFF_RATE btr
  --       ON bth.organizationId = btr.organizationId
  --       AND bth.warehouseId = btr.warehouseId
  --       AND bth.tariffId = btr.tariffId
  --       AND btd.tariffLineNo = btr.tariffLineNo
  --     INNER JOIN BIL_TARIFF_MASTER btm
  --       ON bth.organizationId = btm.organizationId
  --       AND bth.tariffMasterId = btm.tariffMasterId
  --   WHERE bth.organizationId = IN_organizationId
  --   AND btd.warehouseId IN ('CBT02', 'CBT03', 'LADC01')
  --   AND btm.Customerid = IN_CustomerId
  --   AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  --   AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  --   AND btd.chargeCategory = 'IV'
  --   AND btr.rate > 0
  --   AND btr.udf03 NOT IN (SELECT DISTINCT
  --       CASE WHEN bl.warehouseId = 'CBT02' THEN 'LINC' ELSE bl.workingArea END AS workingArea
  --     FROM Z_InventoryBalance lc
  --       INNER JOIN BAS_LOCATION bl
  --         ON lc.organizationId = bl.organizationId
  --         AND lc.warehouseId = bl.warehouseId
  --         AND lc.locationId = bl.locationId
  --     WHERE lc.organizationId = IN_organizationId
  --     AND DATE(lc.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
  --     AND bl.warehouseId IN ('CBT02', 'CBT03', 'LADC01')
  --     AND lc.customerId = IN_CustomerId
  --     AND lc.qtyavailable > 0)
  --   ORDER BY stockDate ASC;

  -- Declare a handler for NOT FOUND condition
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_stockDate, v_warehouseId, v_customerId, v_workingArea, v_qtyCharge;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;

    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = IN_organizationId
        AND bs.warehouseId = v_warehouseId
        AND bs.customerId = v_customerId
        -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
        AND DATE(bs.billingFromDate) = v_stockDate
        AND bs.descr = v_workingArea
        AND bs.chargeCategory = 'IV') THEN


    BLOCK2:
      BEGIN
        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          btr.udf02,-- minimum billing
          btr.udf03,-- chamber name
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = v_warehouseId
        AND bsm.customerId = v_customerId
        AND btr.udf03 = v_workingArea -- for filter chamber name
        -- AND bth.tariffMasterId = od_tariffMasterId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IV'
        AND btr.rate > 0
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;
        SELECT
          'look->',
          tariff_done;
        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd

        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_qtyMinimumContract, R_chamberName, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;

          --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
          IF tariff_done = 1 THEN
            SET tariff_done = 0;
            LEAVE getTariff;
          END IF;

          -- SELECT R_CUSTOMERID,R_WAREHOUSEID;
          -- SELECT tariff_done;



          IF (LTRIM(RTRIM(R_WAREHOUSEID)) = LTRIM(RTRIM(v_warehouseId)))
            AND (LTRIM(RTRIM(R_CUSTOMERID)) = LTRIM(RTRIM(v_customerId)))
            AND (LTRIM(RTRIM(R_chamberName)) = LTRIM(RTRIM(v_workingArea))) THEN
            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH


            --           SELECT  'check=>',R_ratebase,R_TARIFFID;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';


            IF (R_ratebase = 'CUBIC') THEN
              IF (v_qtyCharge > R_qtyMinimumContract) THEN
                SET R_RESULTQTYCHARGE = v_qtyCharge;
              ELSE
                SET R_RESULTQTYCHARGE = R_qtyMinimumContract;
              END IF;
            ELSEIF (R_ratebase = 'M2') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'IP') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'KG') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'LITER') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'DO') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'PALLET') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'CASE') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'QUANTITY') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'NETWEIGHT') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'GW') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            /*additional nettweight grossweight*/
            ELSEIF (R_ratebase = 'MT') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            END IF;

            SELECT
              'DEBUG=>',
              v_customerId,
              R_CUSTOMERID,
              R_WAREHOUSEID,
              v_warehouseId,
              R_RESULTQTYCHARGE;

            --           SELECT 'check 2=>',R_RESULTQTYCHARGE;

            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #
            SELECT
              R_billsummaryId;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                IN_organizationId,
                v_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
                DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
                v_customerId,
                '',
                '',
                '',
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                -- R_descrC,
                CONCAT(v_workingArea),
                R_rateBase,
                R_rateperunit,
                R_RESULTQTYCHARGE,
                '',
                0,
                0,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                '',
                '',
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                v_customerId AS billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                0 udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;






      END;
    ELSE
      ITERATE read_loop;
    END IF;



  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLSTORAGE_DAILY_CBM`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLSTORAGE_DAILY_CBM (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE v_stockDate date;
  DECLARE v_customerId varchar(20);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_skuGroup1 varchar(255);
  DECLARE v_workingArea varchar(255);
  DECLARE v_qtyCharge decimal(18, 4);

  -- Declare for Billing
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_Days int;
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF03 varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_qtyMinimumContract decimal(24, 8);
  DECLARE R_chamberName varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    DATE_FORMAT(ls_storage.stockdate, '%Y-%m-%d') AS stockDate,
    ls_storage.warehouseid,
    ls_storage.customerid,
    ls_storage.workingArea,
    SUM(ls_storage.qtycbm) AS qtycbm
  FROM (SELECT
      DATE_FORMAT(stockDate, '%Y-%m-%d') AS stockdate,
      zib.warehouseId AS warehouseid,
      sm.tariffMasterId AS tariffmasterid,
      CASE WHEN zib.customerId = 'LTL' THEN la1.codeDescr ELSE sm.tariffId END AS tariffid,
      CASE WHEN zib.customerId = 'XXX' THEN 'SAMSONITE' ELSE zib.customerId END AS customerid,
      zib.locationId AS locationid,
      zib.locationCategory AS locationcategory,
      lc.codeDescr AS locationcategorydescr,
      zib.TRACEID AS traceid,
      s.sku_group1 AS muidltl,
      zib.muid AS muid,
      zib.lotNum AS lotnum,
      s.PACKID AS packid,
      CASE WHEN zib.customerId = 'MDS' THEN 'KG' ELSE zib.UOM END AS uom,
      CASE WHEN zib.warehouseId = 'CBT02' THEN 'LINC' WHEN zib.warehouseId = 'CBT03' AND
          /*l.workingArea = 'WHTMLA' THEN 'WHTMLA' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLB' THEN 'WHTMLB' WHEN zib.warehouseId = 'CBT03' AND*/
          l.workingArea = 'WHTMLC' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLD' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLE' THEN 'WHTMLE+G' WHEN zib.warehouseId = 'CBT03' AND
          l.workingArea = 'WHTMLG' THEN 'WHTMLE+G' WHEN zib.warehouseId = 'JBK01' AND
          l.locationId LIKE 'A%' THEN 'A' WHEN zib.warehouseId = 'JBK01' AND
          l.locationId LIKE 'RCV%' THEN 'A' ELSE l.workingArea END AS workingArea, /*AB 22/07/25 add rcv1 to working area A*/
      /*before updatel.workingArea = 'WHTMLA' THEN 'WHTMLA' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLB' THEN 'WHTMLB' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLC' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTMLD' THEN 'WHTMLC+D' WHEN zib.warehouseId = 'CBT03' AND
      l.workingArea = 'WHTML3' THEN 'WHTMLE' ELSE l.workingArea END AS workingArea,
       * AB 24/12/30
       */
      zib.SKU AS sku,
      skuDesc AS skudesc,
      la.lotatt09 AS ponum,
      lc1.codeDescr AS typepallet,
      CASE WHEN zib.customerId = 'MDS' THEN (
            CASE WHEN pd2.uomDescr = 'KG' THEN zib.qtyonHand ELSE zib.qtyonHand * s.sku_group6 END
            ) ELSE zib.qtyonHand END AS qtyonhand,
      pd.qty AS qtyperpallet,
      CASE zib.customerId WHEN 'ASP' THEN zib.cube WHEN 'MAP' THEN s.cube WHEN 'ONDULINE' THEN s.cube WHEN 'SST_JKT' THEN s.cube WHEN 'CPI_JKT' THEN s.cube ELSE s.cube / 1000000 END AS cbmsku,
      CASE zib.customerId WHEN 'MAP' THEN (
            CASE WHEN la.lotatt04 = 'SET' THEN 0 ELSE (s.cube * zib.qtyonHand) END
            ) WHEN 'ONDULINE' THEN s.cube * zib.qtyonHand ELSE totalcube END AS qtycbm,
      CASE WHEN LENGTH(zib.locationId) = 7 THEN SUBSTRING(zib.locationId, 1, 1) WHEN LENGTH(zib.locationId) = 8 THEN SUBSTRING(zib.locationId, 1, 1) WHEN SUBSTRING(zib.locationId, 1, 3) = 'TML' AND
          zib.customerId <> 'LTL' THEN SUBSTRING(zib.locationId, 4, 1) WHEN sm.putawayRule = 'LTL09' THEN 'E' WHEN zib.SKU IN ('000000001100012851', '000000001100010211', '000000001100000616', '000000001100013296', '000000001100008797', '000000001100012070', '000000001100012068', '000000001100012478', '000000001100012898', '000000001100014515') THEN 'G' WHEN sm.putawayRule IN ('LTL03', 'GMPA-NONDG', 'ICHIKOH-NONDG', 'ITOCHU-NONDG', 'PMM-NONDG', 'LTL06', 'LTL07') THEN 'G' WHEN sm.putawayRule IN ('LTL08', 'ITOCHU-DG', 'PMM-DG', 'LTL01', 'LTL02', 'SMT') THEN 'B' WHEN sm.putawayRule = 'LTL-BULK' THEN 'D' WHEN sm.putawayRule IN ('BAJ', 'PLB-LTL', 'ADF', 'CCDI', 'CTI') THEN 'A' WHEN sm.putawayRule IN ('GYI', 'DKJ') THEN 'J' WHEN sm.putawayRule = 'LTL04' THEN 'B' WHEN sm.putawayRule IN ('DNN', 'PMM', 'ITOCHU') THEN 'C' ELSE l.udf03 END AS chamber,
      sm.putawayRule AS putawayrule,
      la.lotatt04 AS batchno,
      la.lotatt02 AS expiredate,
      la.lotatt03 AS whdate,
      CASE WHEN zib.customerId = 'ECCOSBY' THEN (
            CASE WHEN SUBSTRING(zib.locationId, 3, 1) = 'I' THEN 'ECCO2' ELSE 'ECCO' END
            ) ELSE SUBSTRING(zib.locationId, 1, 1) END AS area,
      CASE WHEN zib.customerId = 'PLB-LTL' THEN la.lotatt10 ELSE la.lotatt09 END AS externalpo,
      lc2.codeDescr AS whetherdamaged,
      CEILING(qtyonHand / pd.qty) AS palletused,
      CASE WHEN zib.customerId = 'RBFOOD' THEN pd1.qty ELSE s.NETWEIGHT END AS netweight
    FROM Z_InventoryBalance zib
      LEFT JOIN INV_LOT_ATT la
        ON la.organizationId = zib.organizationId
        AND la.customerId = zib.customerId
        AND la.sku = zib.sku
        AND la.lotNum = zib.lotNum
      LEFT OUTER JOIN (SELECT
          *
        FROM BSM_CODE_ML
        WHERE codetype = 'OWNER_LTL'
        AND languageid = 'en') la1
        ON la.organizationId = la1.organizationId
        AND la.lotatt11 = la1.codeid
      LEFT JOIN BAS_LOCATION l
        ON l.organizationId = zib.organizationId
        AND l.locationId = zib.locationId
        AND l.warehouseId = zib.warehouseId
      LEFT JOIN BAS_SKU s
        ON s.organizationId = zib.organizationId
        AND s.customerId = zib.customerId
        AND s.sku = zib.sku
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE sm
        ON sm.organizationId = zib.organizationId
        AND sm.customerId = zib.customerId
        AND sm.sku = zib.sku
        AND sm.warehouseId = zib.warehouseId
      LEFT JOIN BAS_PACKAGE_DETAILS pd
        ON sm.organizationId = pd.organizationId
        AND sm.customerId = pd.customerId
        AND sm.packId = pd.packId
        AND pd.packUom = 'PL'
      LEFT JOIN BAS_PACKAGE_DETAILS pd1
        ON sm.organizationId = pd1.organizationId
        AND sm.customerId = pd1.customerId
        AND sm.packId = pd1.packId
        AND pd1.packUom = 'CS'
      LEFT JOIN BAS_PACKAGE_DETAILS pd2
        ON sm.organizationId = pd2.organizationId
        AND sm.customerId = pd2.customerId
        AND sm.packId = pd2.packId
        AND pd2.packUom = 'EA'
      LEFT JOIN BSM_CODE_ML lc
        ON lc.organizationId = zib.organizationId
        AND zib.locationCategory = lc.codeid
        AND lc.codeType = 'LOC_CAT'
        AND lc.languageId = 'en'
      LEFT JOIN BSM_CODE_ML lc1
        ON lc1.organizationId = la.organizationId
        AND la.lotAtt07 = lc1.codeid
        AND lc1.codeType = 'PLT_TYP'
        AND lc1.languageId = 'en'
      LEFT JOIN BSM_CODE_ML lc2
        ON lc2.organizationId = la.organizationId
        AND la.lotAtt08 = lc2.codeid
        AND lc2.codeType = 'DMG_FLG'
        AND lc2.languageId = 'en'
    WHERE zib.organizationId = IN_organizationId
    --  AND DATE(zib.StockDate) > '2025-01-26'
    --  AND DATE(zib.StockDate) < '2025-01-28'
    -- AND zib.warehouseId IN ('LADC01')
    AND zib.warehouseId IN ('CBT02', 'CBT03', 'LADC01', 'JBK01')
    AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))

    AND zib.customerId = IN_CustomerId
    AND qtyonHand > 0
    AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATIONCBT02', 'SORTATIONCBT03', 'SORTATION', 'SORTATIONMRD02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA', 'B04A065', 'B04A066', 'B04B065', 'B04B065')
    AND zib.sku NOT IN (SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationId = zib.organizationId
      AND customerId = 'LTL'
      AND sku LIKE '13%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationid = zib.organizationId
      AND customerid = 'SMARTSBY'
      AND sku = 'PALLET'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('ECMAMA', 'ECMAMAB2C')
      AND sku LIKE '%TEST%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('MAP')
      AND sku IN ('DEMO TABLE AT', 'DEMO TABLE SAM', 'HOT STAMP'))
    ORDER BY zib.customerId) ls_storage
  GROUP BY ls_storage.warehouseId,
           ls_storage.customerId,
           ls_storage.StockDate,
           ls_storage.workingArea
  ORDER BY ls_storage.customerId, stockDate, ls_storage.workingArea;
  --   UNION ALL
  --   SELECT
  --     DATE(DATE_ADD(NOW(), INTERVAL -1 DAY)) AS stockDate,
  --     bth.warehouseId,
  --     btm.customerId,
  --     btr.udf03 AS workingArea,
  --     0 AS qtycbm
  --   FROM BIL_TARIFF_HEADER bth
  --     INNER JOIN BIL_TARIFF_DETAILS btd
  --       ON bth.organizationId = btd.organizationId
  --       AND bth.warehouseId = btd.warehouseId
  --       AND bth.tariffId = btd.tariffId
  --     INNER JOIN BIL_TARIFF_RATE btr
  --       ON bth.organizationId = btr.organizationId
  --       AND bth.warehouseId = btr.warehouseId
  --       AND bth.tariffId = btr.tariffId
  --       AND btd.tariffLineNo = btr.tariffLineNo
  --     INNER JOIN BIL_TARIFF_MASTER btm
  --       ON bth.organizationId = btm.organizationId
  --       AND bth.tariffMasterId = btm.tariffMasterId
  --   WHERE bth.organizationId = IN_organizationId
  --   AND btd.warehouseId IN ('CBT02', 'CBT03', 'LADC01')
  --   AND btm.Customerid = IN_CustomerId
  --   AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  --   AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  --   AND btd.chargeCategory = 'IV'
  --   AND btr.rate > 0
  --   AND btr.udf03 NOT IN (SELECT DISTINCT
  --       CASE WHEN bl.warehouseId = 'CBT02' THEN 'LINC' ELSE bl.workingArea END AS workingArea
  --     FROM Z_InventoryBalance lc
  --       INNER JOIN BAS_LOCATION bl
  --         ON lc.organizationId = bl.organizationId
  --         AND lc.warehouseId = bl.warehouseId
  --         AND lc.locationId = bl.locationId
  --     WHERE lc.organizationId = IN_organizationId
  --     AND DATE(lc.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
  --     AND bl.warehouseId IN ('CBT02', 'CBT03', 'LADC01')
  --     AND lc.customerId = IN_CustomerId
  --     AND lc.qtyavailable > 0)
  --   ORDER BY stockDate ASC;

  -- Declare a handler for NOT FOUND condition
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_stockDate, v_warehouseId, v_customerId, v_workingArea, v_qtyCharge;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;

    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = IN_organizationId
        AND bs.warehouseId = v_warehouseId
        AND bs.customerId = v_customerId
        -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
        AND DATE(bs.billingFromDate) = v_stockDate
        AND bs.descr = v_workingArea
        AND bs.chargeCategory = 'IV') THEN


    BLOCK2:
      BEGIN
        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          btr.udf02,-- minimum billing
          btr.udf03,-- chamber name
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = v_warehouseId
        AND bsm.customerId = v_customerId
        AND btr.udf03 = v_workingArea -- for filter chamber name
        -- AND bth.tariffMasterId = od_tariffMasterId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IV'
        AND btr.rate > 0
        AND bth.tariffMasterId NOT IN ('BIL00062PT')
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;
        SELECT
          'look->',
          tariff_done;
        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd

        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_qtyMinimumContract, R_chamberName, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;

          --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
          IF tariff_done = 1 THEN
            SET tariff_done = 0;
            LEAVE getTariff;
          END IF;

          -- SELECT R_CUSTOMERID,R_WAREHOUSEID;
          -- SELECT tariff_done;



          IF (LTRIM(RTRIM(R_WAREHOUSEID)) = LTRIM(RTRIM(v_warehouseId)))
            AND (LTRIM(RTRIM(R_CUSTOMERID)) = LTRIM(RTRIM(v_customerId)))
            AND (LTRIM(RTRIM(R_chamberName)) = LTRIM(RTRIM(v_workingArea))) THEN
            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH


            --           SELECT  'check=>',R_ratebase,R_TARIFFID;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';


            IF (R_ratebase = 'CUBIC') THEN
              IF (v_qtyCharge > R_qtyMinimumContract) THEN
                SET R_RESULTQTYCHARGE = v_qtyCharge;
              ELSE
                SET R_RESULTQTYCHARGE = R_qtyMinimumContract;
              END IF;
            ELSEIF (R_ratebase = 'M2') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'IP') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'KG') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'LITER') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'DO') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'PALLET') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'CASE') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'QUANTITY') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'NETWEIGHT') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            ELSEIF (R_ratebase = 'GW') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            /*additional nettweight grossweight*/
            ELSEIF (R_ratebase = 'MT') THEN
              SET R_RESULTQTYCHARGE = v_qtyCharge;
            END IF;

            SELECT
              'DEBUG=>',
              v_customerId,
              R_CUSTOMERID,
              R_WAREHOUSEID,
              v_warehouseId,
              R_RESULTQTYCHARGE;

            --           SELECT 'check 2=>',R_RESULTQTYCHARGE;

            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #
            SELECT
              R_billsummaryId;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                IN_organizationId,
                v_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
                DATE_FORMAT(v_stockDate, '%Y-%m-%d'),
                v_customerId,
                '',
                '',
                '',
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                -- R_descrC,
                CONCAT(v_workingArea),
                R_rateBase,
                R_rateperunit,
                R_RESULTQTYCHARGE,
                '',
                0,
                0,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                '',
                '',
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                v_customerId AS billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                0 udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;






      END;
    ELSE
      ITERATE read_loop;
    END IF;



  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLSOVASSTD`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLSOVASSTD (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN


  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_VASTYPE varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  DECLARE od_organizationId varchar(255);
  DECLARE od_soReference1 varchar(255);
  DECLARE od_skuDescr1 varchar(255);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_soNo varchar(255);
  DECLARE od_soLineNo varchar(255);
  DECLARE od_sku varchar(255);
  DECLARE od_qtyReceived varchar(255);
  DECLARE od_uom varchar(255);
  DECLARE od_qtyReceivedEach varchar(255);
  DECLARE od_totalCube varchar(255);
  DECLARE od_vasType varchar(255);
  DECLARE od_qtyCharge varchar(255);
  DECLARE od_tarifMaster varchar(255);
  DECLARE OUT_returnCode varchar(1000);

  ####################################################################
  ##????
  DECLARE inventory_done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE order_done,
          attribute_done int DEFAULT 0;



  DECLARE cur_orderno CURSOR FOR
  SELECT
    IFNULL(CAST(doh.organizationId AS char(255)), '') AS organizationId,
    IFNULL(CAST(doh.warehouseId AS char(255)), '') AS warehouseId,
    IFNULL(CAST(doh.customerId AS char(255)), '') AS customerId,
    IFNULL(CAST(doh.orderNo AS char(255)), '') AS orderNo,
    IFNULL(CAST(doh.soReference1 AS char(255)), '') AS soReference1,
    -- IFNULL(CAST(dod.sku AS char(255)), '') AS sku,
    -- IFNULL(CAST(bs.skuDescr1 AS char(255)), '') AS skuDescr1,
    vsdo.orderLineNo AS orderlineNo,
    IFNULL(CAST(vsdo.vasType AS char(255)), '') AS vasType,
    IFNULL(CAST(vsdo.vasqty AS char(255)), '') AS qtyCharge,
    IFNULL(CAST(vsdo.packUom AS char(255)), '') AS packUom,
    IFNULL(CAST(bsm.tariffMasterId AS char(255)), '') AS tarifMaster
  FROM DOC_ORDER_HEADER doh
    LEFT OUTER JOIN DOC_ORDER_VAS vsdo
      ON doh.organizationId = vsdo.organizationId
      AND doh.warehouseId = vsdo.warehouseId
      AND doh.orderNo = vsdo.orderNo
    LEFT OUTER JOIN DOC_ORDER_DETAILS dod
      ON dod.organizationId = vsdo.organizationId
      AND dod.warehouseId = vsdo.warehouseId
      AND dod.orderNo = vsdo.orderNo
      AND dod.orderLineNo = vsdo.orderLineNo
    LEFT OUTER JOIN BAS_SKU bs
      ON bs.organizationId = dod.organizationId
      AND bs.customerId = dod.customerId
      AND bs.SKU = dod.sku
    LEFT OUTER JOIN BAS_SKU_MULTIWAREHOUSE bsm
      ON bsm.organizationId = doh.organizationId
      AND bsm.warehouseId = doh.warehouseId
      AND bsm.customerId = doh.customerId
      AND bsm.SKU = dod.Sku
  WHERE vsdo.warehouseId = IN_warehouseId
  AND doh.customerId = IN_CustomerId
  AND doh.orderNo = IN_trans_no
  -- AND bsm.tariffMasterId = 'BIL00418'
  AND doh.orderType NOT IN ('FREE')
  AND doh.soStatus IN ('99')
  GROUP BY doh.organizationId,
           doh.warehouseId,
           doh.customerId,
           doh.orderNo,
           doh.soReference1,
           dod.sku,
           bs.skuDescr1,
           vsdo.orderLineNo,
           vsdo.vasType,
           vsdo.vasqty,
           vsdo.packUom,
           bsm.tariffMasterId;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET order_done = 1;
  OPEN cur_orderno;
cur_order_loop:
  LOOP
    FETCH FROM cur_orderno INTO od_organizationId,
    od_warehouseId,
    od_customerId,
    od_soNo,
    od_soReference1,
    /*od_sku,
    od_skuDescr1,*/
    od_soLineNo,
    od_vasType,
    od_qtyCharge,
    od_uom,
    od_tarifMaster;

    IF order_done = 1 THEN

      SET order_done = 0;
      LEAVE cur_order_loop;
    END IF;
  --     SELECT
  --       CONCAT('** DEBUG:', od_asnNo) AS debug;


  BLOCK2:
    BEGIN
      --  IF (od_tariffMasterId <> '') THEN

      DECLARE cur_Tariff CURSOR FOR
      SELECT DISTINCT
        bsm.organizationId,
        bsm.warehouseId,
        bsm.CUSTOMERID,
        DAY(bth.billingdate) billingDate,
        btr.tariffId,
        btr.tariffLineNo,
        btr.tariffClassNo,
        btd.chargeCategory,
        btd.chargeType,
        btd.descrC,
        btd.docType,
        btd.ratebase,
        btr.ratePerUnit,
        btr.rate,
        btd.minAmount,
        btd.maxAmount,
        IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
        btd.UDF01 AS MaterialNo,
        btd.udf02 AS itemChargeCategory,
        btd.udf04 billMode,
        locationCategory,
        btd.UDF05,
        btd.UDF06,
        btd.UDF07,
        btd.UDF08,
        IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
        CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
        IFNULL(classTo, 0),
        bth.contractNo,
        bth.tariffMasterId,
        btr.cost,
        btd.billingParty,
        IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory,
        btd.vasType
      FROM BAS_SKU_MULTIWAREHOUSE bsm
        INNER JOIN BAS_CUSTOMER bc
          ON bc.customerId = bsm.customerId
          AND bc.organizationId = bsm.organizationId
          AND bc.CustomerType = 'OW'
        INNER JOIN BIL_TARIFF_HEADER bth
          ON bth.organizationId = bsm.organizationId
          AND bth.tariffMasterId = bsm.tariffMasterId
        INNER JOIN BIL_TARIFF_DETAILS btd
          ON btd.organizationId = bth.organizationId
          AND btd.tariffId = bth.tariffId
        INNER JOIN BIL_TARIFF_RATE btr
          ON btr.organizationId = btd.organizationId
          AND btr.tariffId = btd.tariffId
          AND btr.tariffLineNo = btd.tariffLineNo
      WHERE bsm.organizationId = 'OJV_CML'
      AND bsm.warehouseId = IN_warehouseId
      AND bsm.customerId = IN_CustomerId
      AND bth.tariffMasterId = od_tarifMaster
      AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND btd.chargeCategory = 'VA'
      AND btd.tariffLineNo <= 100
      AND btd.vasType = od_vasType
      --       AND btd.docType IN (SELECT
      --           dah.asnType
      --         FROM DOC_ASN_HEADER dah
      --         WHERE dah.asnNo = IN_asnNo)
      AND btr.rate > 0
      #AND IFNULL(DAY(bth.billingdate),0)!=0
      ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

      SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
      #
      OPEN cur_Tariff;
    getTariff:
      LOOP
        FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
        R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
        R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY, R_VASTYPE;
        IF tariff_done THEN
          SET tariff_done = FALSE;
          LEAVE getTariff;
        END IF;


        IF (UPPER(R_VASTYPE) = UPPER(od_vasType)) THEN
          -- CALCULATION
          -- UOM
          -- PALLET
          -- CUBIC
          -- M2
          -- CASE
          -- IP
          -- PIECES
          -- KG
          -- LITER
          -- DO
          -- HOUR
          -- MONTH



          SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
          SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
          SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
          SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
          SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
          SET R_billsummaryId = '';


          SET R_RESULTQTYCHARGE = od_qtyCharge; /*update ini saja, sebelumnya od_qtyCharge = R_RESULTCHARGE*/

          SELECT
            'check===>',
            UPPER(R_CHARGETYPE),
            UPPER(od_vasType),
            od_tarifMaster,
            R_docType,
            R_RESULTQTYCHARGE,
            od_qtyCharge,
            R_VASTYPE;

          IF EXISTS (SELECT
                1
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*')) THEN
            INSERT INTO BIL_SUMMARY_LOG
              SELECT
                *
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
            DELETE
              FROM BIL_SUMMARY
            WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
          END IF; -- EXIST BILLING SUMMARY
          #
          IF (R_billsummaryId = '') THEN
            SET @linenumber = 0;
            SET OUT_returnCode = '';
            CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              SET OUT_returnCode = '999#????????';
              LEAVE getTariff;
            END IF;
          END IF;
          #


          INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
          , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
          , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
          , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
          , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
          , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
          , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
          , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
          , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
          , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
            SELECT
              od_organizationId,
              od_warehouseId,
              CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
              CURDATE(),
              CURDATE(),
              od_customerId,
              '', -- od_sku,
              '',
              '',
              R_TARIFFID,
              R_CHARGECATEGORY,
              R_chargetype,
              R_descrC,
              R_rateBase,
              R_rateperunit,
              od_qtyCharge,
              od_uom,
              '0',
              '0',
              R_rate,
              R_RESULTQTYCHARGE * R_rate / R_rateperunit,
              (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
              0,
              R_cost * R_RESULTQTYCHARGE,
              0,
              NULL confirmTime,
              '' confirmWho,
              'SO' dockType,
              od_soNo,
              '' createTransactionid,
              R_CHARGETYPE notes,
              NULL ediSendTime,
              R_BILLTO billTo,
              NULL settleTime,
              '' settleWho,
              '' followUp,
              '' invoiceType,
              '' paidTo,
              '' costConfirmFlag,
              NULL costConfirmTime,
              '' costConfirmWho,
              '' costSettleFlag,
              NULL costSettleTime,
              '' costSettleWho,
              NULL incomeTaxRate,
              0 costTaxRate,
              NULL incomeTax,
              0 cosTax,
              NULL incomeWithoutTax,
              NULL cosWithoutTax,
              '' costInvoiceType,
              '' noteText,
              R_materialNo AS udf01,
              R_itemChargeCategory AS udf02,
              R_UDF08 udf03,
              R_UDF06 udf04,
              NULL udf05,
              0 currentVersion,
              '2020' oprSeqFlag,
              IN_USERID addWho,
              NOW() ADDTIME,
              IN_USERID editWho,
              NOW() editTime,
              R_LOCATIONCAT locationCategory,
              '' manual,
              0 lineCount,
              '*' arNo,
              0 arLineNo,
              '*' apNo,
              0 apLineNo,
              'N' ediSendFlag,
              '' ediErrorCode,
              '' ediErrorMessage,
              NULL ediSendTime2,
              'N' ediSendFlag2,
              '' ediErrorCode2,
              '' ediErrorMessage2,
              '' billingTranCategory,
              '' orderType,
              '' containerType,
              '' containerSize;

        END IF; -- END IF docType

      END LOOP getTariff;
      CLOSE cur_Tariff;


    --  END IF; 
    --  END IF TARIFF ORDER KOSONG
    END;




  END LOOP cur_order_loop;
  CLOSE cur_orderno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_BILLRENTPALLET_R_BILL_MODE`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_BILLRENTPALLET_R_BILL_MODE (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_qty_TraceId decimal(24, 8);
  DECLARE v_qty_MUID decimal(24, 8);
  DECLARE v_max_TraceId decimal(24, 8);
  DECLARE v_avg_TraceId decimal(24, 8);
  DECLARE v_max_MUID decimal(24, 8);
  DECLARE v_avg_MUID decimal(24, 8);
  DECLARE v_max_qty decimal(24, 8);
  DECLARE v_avg_qty decimal(24, 8);
  DECLARE v_qty decimal(24, 8);
  DECLARE v_max_qty_cbm decimal(24, 8);
  DECLARE v_avg_qty_cbm decimal(24, 8);
  DECLARE v_qty_cbm decimal(24, 8);
  DECLARE v_chargeType varchar(255);
  DECLARE v_storageType varchar(255);
  -- Declare for Billing
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY int;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_Days int(11);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int(11);
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rate_udf03 varchar(50);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF03 varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_qtyMinimumContract decimal(24, 8);
  DECLARE R_chamberName varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 6);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 6);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 6);
  DECLARE R_CLASSTO decimal(24, 6);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib.organizationId,
    zib.warehouseId,
    zib.customerId,
    SUM(zib.qty_TraceId),
    SUM(zib.qty_MUID),
    MAX(zib.qty_TraceId) AS max_TraceId,
    AVG(zib.qty_TraceId) AS avg_TraceId,
    MAX(zib.qty_MUID) AS max_MUID,
    AVG(zib.qty_MUID) AS avg_MUID,
    SUM(zib.qty),
    MAX(zib.qty) AS max_qty,
    AVG(zib.qty) AS avg_qty,
    SUM(zib.qty_cbm),
    MAX(zib.qty_cbm) AS max_qty_cbm,
    AVG(zib.qty_cbm) AS avg_qty_cbm,
    zib.udf01,
    zib.chargeType
  FROM Z_BIL_AKUM_DAYS_STORAGE zib
  WHERE zib.organizationId = IN_organizationId
  AND zib.customerId = IN_CustomerId
  AND zib.StockDate BETWEEN DATE_FORMAT(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), '%Y-%m-%d') AND DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)
  -- AND zib.StockDate >= IN_datefrom
  -- AND zib.StockDate <= IN_dateto
  AND zib.warehouseId = IN_warehouseId
  AND zib.chargeType = 'RP'
  GROUP BY zib.organizationId,
           zib.warehouseId,
           zib.customerId,
           zib.udf01,
           zib.chargeType
  ORDER BY zib.organizationId, zib.warehouseId, zib.customerId, zib.chargeType;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_qty_TraceId, v_qty_MUID, v_max_TraceId, v_avg_TraceId, v_max_MUID, v_avg_MUID, v_qty, v_max_qty, v_avg_qty, v_qty_cbm, v_max_qty_cbm, v_avg_qty_cbm, v_storageType, v_chargeType;




    -- Exit the loop if no more rows
    IF done = 1 THEN

      LEAVE read_loop;
    END IF;




    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = v_organizationId
        AND bs.warehouseId = v_warehouseId
        AND bs.customerId = v_customerId
        AND bs.billingFromDate BETWEEN DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d') AND DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)
        --        AND bs.billingFromDate>= IN_datefrom
        --        AND bs.billingFromDate<= IN_dateto
        -- DATE(DATE_ADD(CURDATE(), INTERVAL -1 MONTH))
        -- AND DATE(bs.billingFromDate) = v_stockDate
        -- AND bs.descr = v_workingArea
        AND bs.chargeCategory = 'IV'
        AND bs.chargeType = 'PL'
        AND bs.arNo IN ('*')) THEN


    BLOCK2:
      BEGIN
        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bcm.organizationId,
          bcm.warehouseId,
          bcm.CUSTOMERID,
          DATE_FORMAT(DATE(DATE_ADD(bth.billingdate, INTERVAL -1 DAY)), '%d') AS billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          -- btr.udf02,-- minimum billing
          btr.udf03,-- chamber name
          IF(btd.UDF03 = '', 0, btd.UDF03) AS minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 AS billMode,
          btd.locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(btr.classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          IF(btr.udf03 = '', 0, btr.udf03) AS storageType,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bcm.customerId
            AND bc.organizationId = bcm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bcm.organizationId
            AND bth.tariffMasterId = bcm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
          LEFT JOIN BSM_CODE_ML bm
            ON bm.organizationId = btd.organizationId
            AND bm.codeId = btd.udf04
            AND bm.codeType = 'SP_TRACEID'
            AND bm.languageId = 'en'

        WHERE bcm.organizationId = v_organizationId
        AND bcm.warehouseId = v_warehouseId
        AND bcm.customerId = v_customerId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IV'
        AND btd.chargeType = 'PL'
        AND btr.rate > 0
        AND CASE WHEN bcm.customerId IN ('ECMAMA', 'ECMAMAB2C', 'LTL') THEN (btr.udf03 = v_storageType) ELSE (btr.udf03 = '') END
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bcm.organizationId, bcm.warehouseId, bcm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd


        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount,/*R_qtyMinimumContract,*/ R_chamberName, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_rate_udf03, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;

          /*SELECT
                    'look->',
                    tariff_done,
                    R_RESULTQTYCHARGE,
                      v_qty_TraceId,
                      v_qty_MUID,
                      v_max_TraceId,
                      v_avg_TraceId,
                      v_max_MUID,
                      v_avg_MUID,
          			v_qty,
                      v_max_qty,
                      v_avg_qty,
                      v_chargeType,
                      R_minAmount,
                      R_rate,
                      R_ratePerUnit;*/
          --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;


          IF tariff_done = 1 THEN
            SET tariff_done = 0;
            LEAVE getTariff;
          END IF;

          -- SELECT R_CUSTOMERID,R_WAREHOUSEID;
          -- SELECT tariff_done;


          IF (LTRIM(RTRIM(R_WAREHOUSEID)) = LTRIM(RTRIM(v_warehouseId)))
            AND (LTRIM(RTRIM(R_CUSTOMERID)) = LTRIM(RTRIM(v_customerId))) THEN

            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH


            --           SELECT  'check=>',R_ratebase,R_TARIFFID;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';

            /*IF (R_billMode = 'CUBIC') THEN
             IF(v_max_TraceId > sum(R_minAmount/(R_rate/R_ratePerUnit)) THEN
                SET R_RESULTQTYCHARGE = v_max_TraceId;
              ELSE
                SET R_RESULTQTYCHARGE = R_minAmount;
              END IF;*/

            SELECT
              'TRAP',
              R_rate,
              R_billMode;
            IF (R_billMode = 'MAXTRACE') THEN
              SET R_RESULTQTYCHARGE = v_max_TraceId;
            ELSEIF (R_billMode = 'MAXPL') THEN
              SET R_RESULTQTYCHARGE = v_max_MUID;
            ELSEIF (R_billMode = 'MAXQTY') THEN
              SET R_RESULTQTYCHARGE = v_max_qty;
            ELSEIF (R_billMode = 'AVGLOC') THEN
              SET R_RESULTQTYCHARGE = v_avg_TraceId;
            ELSEIF (R_billMode = 'AVGPL') THEN
              SET R_RESULTQTYCHARGE = v_avg_MUID;
            ELSEIF (R_billMode = 'AVGQTY') THEN
              SET R_RESULTQTYCHARGE = v_avg_qty;
            ELSEIF (R_billMode = 'MONTHTRACE') THEN
              SET R_RESULTQTYCHARGE = v_qty_TraceId;
            ELSEIF (R_billMode = 'MONTHLOC') THEN
              SET R_RESULTQTYCHARGE = v_qty_MUID;
            ELSEIF (R_billMode = 'MONTHPL') THEN
              SET R_RESULTQTYCHARGE = v_qty_MUID;
            ELSEIF (R_billMode = 'MONTHQTY') THEN
              SET R_RESULTQTYCHARGE = v_qty;
            ELSEIF (R_billMode = 'MAXCBM') THEN
              SET R_RESULTQTYCHARGE = v_max_qty_cbm;
            ELSEIF (R_billMode = 'INTRACE') THEN
              SET R_RESULTQTYCHARGE = v_qty_TraceId;
            END IF;


            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY

            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #


            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                v_organizationId,
                v_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                R_BILLINGDATE,
                R_BILLINGDATE,
                v_customerId,
                '',
                '',
                '',
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                R_descrC,
                --               '',
                R_rateBase,
                R_rateperunit,
                R_RESULTQTYCHARGE,
                '',
                0,
                0,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                '',
                '',
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                v_customerId AS billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                0 udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                'CUSTOMBILL' addWho,
                NOW() ADDTIME,
                'CUSTOMBILL' editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                '' orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;

      END;
    ELSE
      ITERATE read_loop;
    END IF;

  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLHOSTD_TYPE2`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_BILLHOSTD_TYPE2 (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN
  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE R_PALLETCNT varchar(30);
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  DECLARE od_organizationId varchar(20);
  DECLARE od_orderNo varchar(20);
  DECLARE od_soReference1 varchar(255);
  DECLARE od_soReference3 varchar(255);
  DECLARE od_orderType varchar(255);
  DECLARE od_docType varchar(255);
  DECLARE od_docTypeDescr varchar(255);
  DECLARE od_soStatus varchar(255);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_orderLineNo varchar(255);
  DECLARE od_SKU varchar(255);
  DECLARE od_ShipmentTime varchar(255);
  DECLARE od_qty varchar(255);
  DECLARE od_qty_each varchar(255);
  DECLARE od_qtyShipped_each varchar(255);
  DECLARE od_uom varchar(255);
  DECLARE od_qtyCharge varchar(255);
  DECLARE od_totalCube varchar(255);
  DECLARE od_editTime varchar(255);
  DECLARE od_lotNum varchar(255);
  DECLARE od_traceId varchar(255);
  DECLARE od_pickToTraceId varchar(255);
  DECLARE od_dropId varchar(255);
  DECLARE od_location varchar(255);
  DECLARE od_pickToLocation varchar(255);
  DECLARE od_line_transaction varchar(255);
  DECLARE od_skuDescr1 varchar(255);
  DECLARE od_grossWeight varchar(255);
  DECLARE od_cubeNya varchar(255);
  DECLARE od_tariffMasterId varchar(255);
  DECLARE od_QtyPerCases varchar(255);
  DECLARE od_QtyPerPallet varchar(255);
  DECLARE od_zone varchar(255);
  DECLARE od_batch varchar(255);
  DECLARE od_lotAtt07 varchar(255);
  DECLARE od_RecType varchar(21);
  DECLARE od_Billtranctg varchar(21);
  DECLARE OUT_returnCode varchar(1000);
  ####################################################################
  DECLARE od_qtyChargeEA varchar(255);
  DECLARE od_qtyChargeCS varchar(255);
  DECLARE od_qtyChargeIP varchar(255);
  DECLARE od_qtyChargePL varchar(255);
  DECLARE od_qtyChargeCBM varchar(255);
  DECLARE od_qtyChargeDropId varchar(255);
  DECLARE od_qtyChargeTotDO varchar(255);
  DECLARE od_qtyChargeTotLine varchar(255);
  DECLARE od_qtyChargeNettWeight varchar(255);/*additional nettweight Gross Weight ABYuhuu*/
  DECLARE od_qtyChargeGrossWeight varchar(255);
  DECLARE od_qtyChargeMetricTon varchar(255);
  DECLARE od_closetimetransaction datetime; /*additional close transaction by AKBAR */
  ####################################################################
  DECLARE sum_organizationId varchar(20);
  DECLARE sum_warehouseId varchar(20);
  DECLARE sum_customerId varchar(20);
  DECLARE sum_orderNo varchar(20);
  DECLARE sum_orderType varchar(255);
  DECLARE sum_soReference1 varchar(255);
  DECLARE sum_soReference3 varchar(255);
  DECLARE sum_tariffMasterId varchar(255);
  DECLARE sum_qtyChargeEA varchar(255);
  DECLARE sum_qtyChargeCS varchar(255);
  DECLARE sum_qtyChargeIP varchar(255);
  DECLARE sum_qtyChargePL varchar(255);
  DECLARE sum_qtyChargeCBM varchar(255);
  DECLARE sum_qtyChargeTotDO varchar(255);
  DECLARE sum_qtyChargeTotLine varchar(255);
  DECLARE sum_qtyChargeNettWeight varchar(255);/*additional nettweight Gross Weight ABYuhuu*/
  DECLARE sum_qtyChargeGrossWeight varchar(255);
  DECLARE sum_qtyChargeMetricTon varchar(255);
  ####################################################################

  ##????
  DECLARE inventory_done int DEFAULT FALSE;
  DECLARE tariff_done,
          tariff2_done int DEFAULT FALSE;
  DECLARE order_done,
          attribute_done boolean DEFAULT FALSE;
  DECLARE cur_orderno CURSOR FOR
  SELECT
    sumso.organizationId,
    sumso.warehouseId,
    sumso.customerId,
    sumso.orderNo,
    sumso.orderType,
    SUM(sumso.qtyChargeEA) AS qtyChargeEA,
    SUM(sumso.qtyChargeCS) AS qtyChargeCS,
    SUM(sumso.qtyChargeIP) AS qtyChargeIP,
    SUM(sumso.qtyChargePL) AS qtyChargePL,
    SUM(sumso.qtyChargeCBM) AS qtyChargeCBM,
    COUNT(sumso.qtyChargeDropId) AS qtyChargeDropId,
    COUNT(sumso.qtyChargeTotDO) AS qtyChargeTotDO,
    SUM(sumso.qtyChargeTotLine) AS qtyChargeTotLine,
    SUM(sumso.qtyChargeNettWeight) AS qtyChargeNettWeight,
    SUM(sumso.qtyChargeGrossWeight) AS qtyChargeGrossWeight,
    SUM(sumso.qtyChargeMetricTon) AS qtyChargeMetricTon,
    sumso.closeTime
  FROM (SELECT
      IFNULL(CAST(doh.organizationId AS char), '') AS organizationId,
      IFNULL(CAST(doh.orderNo AS char), '') AS orderNo,
      IFNULL(CAST(doh.orderType AS char(255)), '') AS orderType,
      IFNULL(CAST(doh.warehouseId AS char(255)), '') AS warehouseId,
      IFNULL(CAST(aad.customerId AS char(255)), '') AS customerId,
      IFNULL(CAST(SUM(aad.qty) AS char(255)), 0) AS qty,
      IFNULL(CAST(SUM(aad.qty_each) AS char(255)), 0) AS qty_each,
      IFNULL(CAST(SUM(aad.qtyShipped_each) AS char(255)), 0) AS qtyShipped_each,
      IFNULL(CAST(SUM(aad.qtyShipped_each / bpdEA.qty) AS char(255)), 0) AS qtyChargeEA,
      IFNULL(CAST(CEIL(SUM(aad.qtyShipped_each / bpdCS.qty)) AS char(255)), 0) AS qtyChargeCS,
      IFNULL(CAST(CEIL(SUM(aad.qtyShipped_each / bpdIP.qty)) AS char(255)), 0) AS qtyChargeIP,
      IFNULL(CAST(CEIL(SUM(aad.qtyShipped_each / bpdPL.qty)) AS char(255)), 0) AS qtyChargePL,
      IFNULL(CAST(SUM(aad.qtyShipped_each * bs.cube) AS char(255)), 0) AS qtyChargeCBM,
      IFNULL(CAST(COUNT(DISTINCT aad.dropId) AS char(255)), 0) AS qtyChargeDropId,
      IFNULL(CAST(COUNT(DISTINCT doh.orderNo) AS char(255)), 0) AS qtyChargeTotDO,
      IFNULL(CAST(COUNT(DISTINCT aad.orderLineNo) AS char(255)), 0) AS qtyChargeTotLine,
      IFNULL(CAST(SUM(aad.qtyShipped_each * bs.cube) AS char(255)), 0) AS totalCube,
      IFNULL(CAST(SUM(aad.qtyShipped_each * bs.grossWeight) AS char(255)), 0) AS qtyChargeGrossWeight,
      IFNULL(CAST(SUM(bs.cube) AS char(255)), 0) AS cubeNya,
      IFNULL(CAST(SUM(aad.qtyShipped_each * bs.netWeight) AS char(255)), 0) AS qtyChargeNettWeight,
      CASE WHEN aad.customerId LIKE '%ABC%' THEN IFNULL(CAST(SUM((aad.qtyShipped_Each * bpdCS.qty) / 1000) AS char(255)), 0) ELSE IFNULL(CAST(SUM(aad.qtyShipped_Each / 1000) AS char(255)), 0) END AS qtyChargeMetricTon,
      df.closeTime
    /*additional nettweight Gross Weight ABYuhuu*/
    FROM ACT_ALLOCATION_DETAILS aad
      LEFT OUTER JOIN DOC_ORDER_HEADER doh
        ON doh.organizationId = aad.organizationId
        AND doh.customerId = aad.customerId
        AND doh.orderNo = aad.orderNo
      LEFT JOIN DOC_ORDER_HEADER_UDF df
        ON (doh.organizationId = df.organizationId)
        AND doh.warehouseId = df.warehouseId
        AND doh.orderNo = df.orderNo
      LEFT OUTER JOIN BAS_SKU bs
        ON bs.organizationId = aad.organizationId
        AND bs.SKU = aad.SKU
        AND bs.customerId = aad.customerId
      LEFT OUTER JOIN BAS_SKU_MULTIWAREHOUSE bsm
        ON bsm.organizationId = bs.organizationId
        AND bsm.SKU = bs.SKU
        AND bsm.customerId = bs.customerId
        AND bsm.warehouseId = aad.warehouseId
      /*      LEFT OUTER JOIN INV_LOT_ATT ila
              ON ila.organizationId = aad.organizationId
              AND ila.SKU = aad.SKU
              AND ila.lotnum = aad.lotnum
              AND ila.customerId = aad.customerId*/
      LEFT JOIN BAS_PACKAGE_DETAILS bpdEA
        ON bpdEA.organizationId = bs.organizationId
        AND bpdEA.packId = bs.packId
        AND bpdEA.customerId = bs.customerId
        AND bpdEA.packUom = 'EA'
      LEFT JOIN BAS_PACKAGE_DETAILS bpdIP
        ON bpdIP.organizationId = bs.organizationId
        AND bpdIP.packId = bs.packId
        AND bpdIP.customerId = bs.customerId
        AND bpdIP.packUom = 'IP'
      LEFT JOIN BAS_PACKAGE_DETAILS bpdCS
        ON bpdCS.organizationId = bs.organizationId
        AND bpdCS.packId = bs.packId
        AND bpdCS.customerId = bs.customerId
        AND bpdCS.packUom = 'CS'
      LEFT JOIN BAS_PACKAGE_DETAILS bpdPL
        ON bpdPL.organizationId = bs.organizationId
        AND bpdPL.packId = bs.packId
        AND bpdPL.customerId = bs.customerId
        AND bpdPL.packUom = 'PL'
      LEFT JOIN BSM_CODE_ML t1
        ON t1.organizationId = aad.organizationId
        AND t1.codeType = 'SO_TYP'
        AND t1.codeId = doh.orderType
        AND t1.languageId = 'en'
      LEFT JOIN BAS_LOCATION bl
        ON bl.organizationId = aad.organizationId
        AND bl.warehouseId = aad.warehouseId
        AND bl.locationId = aad.location
      LEFT JOIN BAS_ZONE bz
        ON bz.organizationId = bl.organizationId
        AND bz.warehouseId = bl.warehouseId
        AND bz.zoneId = bl.zoneId
        AND bz.zoneGroup = bl.zoneGroup
    WHERE aad.organizationId = IN_organizationId
    AND aad.customerId = IN_CustomerId
    AND aad.warehouseId = IN_warehouseId
    AND doh.orderNo = IN_trans_no
    AND aad.Status IN ('99', '80')
    AND bs.skuDescr1 NOT LIKE '%PALLET%'
    AND aad.sku NOT IN (SELECT
        sku
      FROM Z_SKUNOTBILLING zsnb
      WHERE organizationId = aad.organizationId
      AND customerId = aad.customerId)
    /* AND aad.sku NOT IN ('DEMOTABLEAT',
        'DEMOTABLESAM',
        'HOTSTAMP',
        'COLLATERAL-COLLECTABLESTICKER',
        'HELLOBASTC',
        'MAMALOVSTC',
        'MAMANOUSTC',
        'MAMAPCK02',
        'STCMCBMS-TH',
        'BUMILTSTC2',
        'COLLATERAL-STICKERPINK',
        'PRINCTSTC3',
        'PRINCTSTC3',
        'PINKBOX03P',
        'YFI001',
        'MAMASTT',
        'TAP-COMBOX',
        'MAMABOXPINK',
        'MAMABOX01',
        'MAMABOX02',
        'BIGBOX5',
        'COLLATERAL-PIZZABOX',
        'MAMABOX01',
        'MAMABOX02',
        'MEDIUMBOX4',
        'SMALLBOX',
        'GRTGCRD',
        'BUNBUNSTC01',
        'BUNBUNSTC02',
        'CONGRATSTC1',
        'MAMAMWTH',
        'STCABS-MY',
        'STCABS-TH',
        'STCANTCOLIC-BIG-TH',
        'STCANTCOLIC-SMALL-TH',
        'STCAPCN',
        'STCGFW-VN', -- add 26-05-25  akbar
        'STCAPRCMMY',
        'STCAPRCMY',
        'STCAPRCTH',
        'STCAPRCTH-DIR',
        'STCAPRCTH-NIG',
        'STCAPRCTH-NUT',
        'STCAPRMMY',
        'STCAPRMTH',
        'STCAPRMTH-DIR',
        'STCAPRMTH-NIG',
        'STCAPRMTH-NUT',
        'STCBFS-PH',
        'STCBHABMY',
        'STCBHABTH',
        'STCBHABWPH',
        'STCBHABWTH',
        'STCBPOMSC',
        'STCDC-TH',
        'STCDCIC-TH',
        'STCDCPH',
        'STCDCW-TH',
        'STCDPFMPH',
        'STCDPFMPH-TH',
        'STCDSDTH',
        'STCEBPTH',
        'STCFWID',
        'STCGBSID',
        'STCGBSMY',
        'STCGBSTH',
        'STCGFW-MY',
        'STCGFWPH',
        'STCGFWTH',
        'STCHPSEATCR',
        'STCINCMY',
        'STCKTP-PH',
        'STCKTPBGTH',
        'STCKTPBID',
        'STCKTPEN',
        'STCKTPSID',
        'STCKTPSTH',
        'STCMCDNFC-ID',
        'STCMCDNFC-MY',
        'STCMCDNFC-PH',
        'STCMCDNFC-SG',
        'STCMCDNFC-TH',
        'STCMCDSD-EN',
        'STCMCDSD-MY',
        'STCMCDSD-SG',
        'STCMCDSD-TH',
        'STCMCHVL-MY',
        'STCMCHVL-PH',
        'STCMCHVL-SG',
        'STCMCHVL-TH',
        'STCMCHVLTH',
        'STCMCMBP-TH',
        'STCMCPH',
        'STCMCSHS-MY',
        'STCMCSHS-PH',
        'STCMCSHS-SG',
        'STCMCSHS-TH',
        'STCMCSVL-ID',
        'STCMCSVL-MY',
        'STCMCTH',
        'STCMCWBP-TH',
        'STCMHG-PH',
        'STCMOSPL-SG',
        'STCMSMY',
        'STCMSTH',
        'STCMWPH',
        'STCMWSG',
        'STCMWTH',
        'STCNCPH',
        'STCNCSG',
        'STCNCTH',
        'STCREVIMSK-TH',
        'STCRFW-MY',
        'STCRFW-TH',
        'STCRMOMY',
        'STCRMOPH',
        'STCRMOTH',
        'STCSMRPH',
        'STCSOOTHMSK-TH',
        'STCSPL-PH',
        'STCSPL-SG',
        'STCTC-TH',
        'STCTCA-TH',
        'STCTCI-TH',
        'STCTCID',
        'STCTCMY',
        'STCTCPH',
        'STCTCSG',
        'STCTO',
        'STCTO-ID',
        'STCTO-PH',
        'STCTPPH',
        'STCTPSG',
        'STCTPTH',
        'STCTSA-TH',
        'STCTSI-TH',
        'STCTSMY',
        'STCTSPH',
        'STCTSSG',
        'STCTTH',
        'STCCAS-ID',
        'STCHIPSEATMI',
        'AMLBL-TH',
        'CFBC-TH',
        'STCABIZNEDR150',
        'STCABIZNEDR250',
        'STCAL-TH-L/XL',
        'STCAL-TH-S/M',
        'STCAPCI-TH',
        'STCAPMI-TH',
        'STCAWN-TH',
        'STCCAS-ID',
        'STCEBPIZNEDR',
        'STCMBPIZNEDR',
        'STCMCSVL-TH',
        'STCMTPID',
        'STCNCMU',
        'STCOLIVE-TH',
        'STCTBRIZNEDR',
        'STDCDR-TH',
        'GRCRDT3',
        'PINKBOX03P',
        'TAP-COMBOX',
        'MAMABOXPINK',
        'STCABS-VN',
        'STCDPFM-VN',
        'STCKTPS-VN',
        'STCMCDSD-VN',
        'STCMCHVL-VN',
        'STCMCSHS-VN',
        'STCRC-VN',
        'STCABSIG-VN',
        'STCABSMNF-VN',
        'STCAPMNF-VN',
        'STCAPSIG-VN',
        'STCTPIG-VN',
        'STCTPMNF-VN',
        'STCACP-VN',
        'STCAMP-VN',
        'STCAPL-VN',
        'STCBNS-VN',
        'STCFBTPTH',
        'STCGS-VN',
        'STCHVLIGT-VN',
        'STCHVLMNF-VN',
        'STCINC-VN',
        'STCMITPTH',
        'STCMT-VN',
        'STCNFC-VN',
        'STCRFW-VN',
        'STCSMC-VN',
        'STCSMS-VN',
        'STCTMTH',
    	'SMALL BOX',
    	'STCBSBCCREAMXXLVN',
    'STCFHRCPINKVN',
    'STCFHRCYELLOWVN',
    'STCFRSTBRSHVN',
    'STCFRSTBRSPNKVN',
    'STCHCBLUEVN',
    'STCHGGINGBLUVN',
    'STCHGGINGPNKVN',
    'STCHGGINGWHTVN',
    'STCHIPSEATTRQSVN',
    'STCMNBCREAMLVN',
    'STCMNBCREAMMVN',
    'STCMNBLACKXLVN',
    'STCNANOCRSTS/MVN',
    'STCPAACCREAM3XLVN',
    'STCPACBLACK3XLVN',
    'STCPACCREAMLVN',
    'STCPREGBELTCVN',
    'STCPREGBELTVN',
    'STCSPBMBLACKVN',
    'STCSPBXLBLACKVN',
    'STCWBPADVN','STCMACAV','STCMCBBLCK','STCMCBCRM'
    ) 
    */
    /*AB-update sku take out base on handing out ls-11-09-24*/
    AND doh.orderType NOT IN ('FREE', 'KT', 'TROF', 'TTG') /*AB-update so type base on handing out ls-11-09-24*/

    GROUP BY doh.organizationId,
             doh.orderNo,
             doh.orderType,
             doh.warehouseId,
             aad.dropId,
             aad.customerId,
             df.closeTime) sumso
  GROUP BY organizationId,
           warehouseId,
           customerId,
           orderType,
           closeTime,
           orderNo;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET order_done = TRUE;
  OPEN cur_orderno;
cur_order_loop:
  LOOP
    FETCH FROM cur_orderno INTO od_organizationId,
    od_warehouseId,
    od_customerId,
    od_orderNo,
    od_orderType,
    -- od_soReference1,
    -- od_soReference3,
    --   od_tariffMasterId,
    od_qtyChargeEA,
    od_qtyChargeCS,
    od_qtyChargeIP,
    od_qtyChargePL,
    od_qtyChargeCBM,
    od_qtyChargeDropId,
    od_qtyChargeTotDO,
    od_qtyChargeTotLine,
    od_qtyChargeNettWeight,
    od_qtyChargeGrossWeight,
    od_qtyChargeMetricTon,
    od_closetimetransaction;
    /*additional close transaction by AKBAR */

    IF order_done THEN
      SET order_done = FALSE;
      LEAVE cur_order_loop;
    END IF;
    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = od_organizationId
        AND bs.warehouseId = od_warehouseId
        AND bs.docNo = od_orderNo
        AND bs.chargeCategory = 'OB') THEN

    BLOCK2:
      BEGIN

        DECLARE cur_Tariff CURSOR FOR

        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          -- btd.udf05,
          btd.ratebase,
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = IN_warehouseId
        AND bsm.customerId = IN_CustomerId
        --        AND bth.tariffMasterId = od_tariffMasterId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'OB'
        AND btd.docType = od_orderType
        -- AND btr.rate > 0
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = TRUE;
        ####################################################################


        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;
          IF tariff_done THEN
            SET tariff_done = FALSE;
            LEAVE getTariff;
          END IF;


          -- ADDING AKBAR RULE => JIKA BILLING CATEGORY TIDAK DI SETUP DI BILING SETUP, SKIP VALIDASI 07.03.2024

          /* IF R_BILLINGTRANCATEGORY IS NULL
             OR R_BILLINGTRANCATEGORY = '' THEN
             SET R_BILLINGTRANCATEGORY = od_Billtranctg;
           END IF;*/

          IF (RTRIM(LTRIM(od_orderType)) = RTRIM(LTRIM(R_docType))) THEN
            -- AND (RTRIM(LTRIM(od_Billtranctg)) = RTRIM(LTRIM(R_BILLINGTRANCATEGORY))) THEN

            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');


            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);

            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';


            IF (R_ratebase = 'CUBIC') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeCBM;
            ELSEIF (R_ratebase = 'M2') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'IP') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeIP;
            ELSEIF (R_ratebase = 'KG') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'LITER') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'QUANTITY') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'DO') THEN
              SET R_RESULTQTYCHARGE = CEILING(od_qtyChargeEA / R_CLASSTO);
            ELSEIF (R_ratebase = 'PALLET') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargePL;
            ELSEIF (R_ratebase = 'NETWEIGHT') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeNettWeight;
            ELSEIF (R_ratebase = 'GW') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeGrossWeight; /*additional nettweight Gross Weight ABYuhuu*/
            ELSEIF (R_ratebase = 'DID') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeDropId; /*additional nettweight Gross Weight ABYuhuu*/
            ELSEIF (R_ratebase = 'DID1') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeDropId; /*additional nettweight Gross Weight ABYuhuu*/
            ELSEIF (R_ratebase = 'MT') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeMetricTon;
            END IF;

            SELECT
              ' check=> ',
              od_qtyChargeEA,
              R_CLASSTO,
              R_RESULTQTYCHARGE,
              R_TARIFFID,
              R_ratebase;


            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF;
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '*_*';
              CALL SPCOM_GetIDSequence_NEW('OJV_CML', '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);
              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                od_organizationId,
                od_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(od_closetimetransaction, '%Y-%m-%d'),
                DATE_FORMAT(od_closetimetransaction, '%Y-%m-%d'),
                od_customerId,
                '' sku,
                '' lotNum,
                '' traceId,
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                R_descrC,
                R_rateBase,
                R_rateperunit,
                R_RESULTQTYCHARGE qtyShipped_each,
                '' uom,
                od_totalCube totalCube,
                0 grossWeight,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                'SO',
                od_orderNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                R_UDF08 udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                od_orderType orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType



        END LOOP getTariff;
        CLOSE cur_Tariff;
      END;
    END IF;
  END LOOP cur_order_loop;
  CLOSE cur_orderno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_BILLHOSTD`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_BILLHOSTD (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN
  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE R_PALLETCNT varchar(30);
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  DECLARE od_organizationId varchar(20);
  DECLARE od_orderNo varchar(20);
  DECLARE od_soReference1 varchar(255);
  DECLARE od_soReference3 varchar(255);
  DECLARE od_orderType varchar(255);
  DECLARE od_docType varchar(255);
  DECLARE od_docTypeDescr varchar(255);
  DECLARE od_soStatus varchar(255);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_orderLineNo varchar(255);
  DECLARE od_SKU varchar(255);
  DECLARE od_ShipmentTime varchar(255);
  DECLARE od_qty varchar(255);
  DECLARE od_qty_each varchar(255);
  DECLARE od_qtyShipped_each varchar(255);
  DECLARE od_uom varchar(255);
  DECLARE od_qtyCharge varchar(255);
  DECLARE od_totalCube varchar(255);
  DECLARE od_editTime varchar(255);
  DECLARE od_lotNum varchar(255);
  DECLARE od_traceId varchar(255);
  DECLARE od_pickToTraceId varchar(255);
  DECLARE od_dropId varchar(255);
  DECLARE od_location varchar(255);
  DECLARE od_pickToLocation varchar(255);
  DECLARE od_allocationDetailsId varchar(255);
  DECLARE od_skuDescr1 varchar(255);
  DECLARE od_grossWeight varchar(255);
  DECLARE od_cubeNya varchar(255);
  DECLARE od_tariffMasterId varchar(255);
  DECLARE od_QtyPerCases varchar(255);
  DECLARE od_QtyPerPallet varchar(255);
  DECLARE od_zone varchar(255);
  DECLARE od_batch varchar(255);
  DECLARE od_lotAtt07 varchar(255);
  DECLARE od_RecType varchar(21);
  DECLARE od_Billtranctg varchar(21);
  DECLARE OUT_returnCode varchar(1000);
  ####################################################################
  DECLARE od_qtyChargeEA varchar(255);
  DECLARE od_qtyChargeCS varchar(255);
  DECLARE od_qtyChargeIP varchar(255);
  DECLARE od_qtyChargePL varchar(255);
  DECLARE od_qtyChargeCBM varchar(255);
  DECLARE od_qtyChargeTotDO varchar(255);
  DECLARE od_qtyChargeTotLine varchar(255);
  DECLARE od_qtyChargeNettWeight varchar(255);/*additional nettweight Gross Weight ABYuhuu*/
  DECLARE od_qtyChargeGrossWeight varchar(255);
  DECLARE od_qtyChargeMetricTon varchar(255);
  DECLARE od_closetimetransaction datetime; /*additional close transaction by AKBAR */
  DECLARE od_line_transaction varchar(255); /*additional line id unique transaction 02.07.2024 */
  ####################################################################

  ##????
  DECLARE inventory_done int DEFAULT FALSE;
  DECLARE tariff_done int DEFAULT FALSE;
  DECLARE order_done,
          attribute_done boolean DEFAULT FALSE;
  DECLARE cur_orderno CURSOR FOR
  SELECT
    IFNULL(CAST(doh.organizationId AS char), '') AS organizationId,
    IFNULL(CAST(doh.orderNo AS char), '') AS orderNo,
    IFNULL(CAST(doh.soReference1 AS char(255)), '') AS soReference1,
    IFNULL(CAST(doh.soReference3 AS char(255)), '') AS soReference3,
    IFNULL(CAST(doh.orderType AS char(255)), '') AS orderType,
    IFNULL(CAST(t1.codeType AS char(255)), '') AS docType,
    IFNULL(CAST(t1.codeDescr AS char(255)), '') AS docTypeDescr,
    IFNULL(CAST(doh.soStatus AS char(255)), '') AS soStatus,
    IFNULL(CAST(doh.warehouseId AS char(255)), '') AS warehouseId,
    IFNULL(CAST(aad.customerId AS char(255)), '') AS customerId,
    IFNULL(CAST(aad.orderLineNo AS char(255)), 0) AS orderLineNo,
    IFNULL(CAST(aad.SKU AS char(255)), '') AS SKU,
    CAST(DATE_FORMAT(aad.shipmentTime, '%Y-%m-%d') AS char(255)) AS ShipmentTime,
    IFNULL(CAST(aad.qty AS char(255)), 0) AS qty,
    IFNULL(CAST(aad.qty_each AS char(255)), 0) AS qty_each,
    IFNULL(CAST(aad.qtyShipped_each AS char(255)), 0) AS qtyShipped_each,
    IFNULL(CAST(aad.uom AS char(255)), '') AS uom,
    CASE WHEN aad.customerId IN ('MAP') AND
        ila.lotAtt04 IN ('SETA', 'SET A', 'SET_A', 'SET-A', 'NONSET', 'NON SET', 'NON_SET', 'NON-SET') AND
        bsm.tariffMasterId LIKE '%PIECE%' THEN IFNULL(CAST(SUM(aad.qtyShipped_each / bpdEA.qty) AS char(255)), 0) ELSE IFNULL(CAST(SUM(aad.qtyShipped_each / bpdEA.qty) AS char(255)), 0) END AS qtyChargeEA,
    IFNULL(CAST(CEIL(SUM(aad.qtyShipped_each / bpdCS.qty)) AS char(255)), 0) AS qtyChargeCS,
    IFNULL(CAST(CEIL(SUM(aad.qtyShipped_each / bpdIP.qty)) AS char(255)), 1) AS qtyChargeIP,
    IFNULL(CAST(CEIL(SUM(aad.qtyShipped_each / bpdPL.qty)) AS char(255)), 0) AS qtyChargePL,
    CASE WHEN aad.customerId IN ('MAP') AND
        ila.lotAtt04 IN ('SETA', 'SET A', 'SET_A', 'SET-A', 'NONSET', 'NON SET', 'NON_SET', 'NON-SET') AND
        bsm.tariffMasterId NOT LIKE '%PIECE%' THEN IFNULL(CAST(SUM(aad.qtyShipped_each * bs.cube) AS char(255)), 0) ELSE IFNULL(CAST(SUM(aad.qtyShipped_each * bs.cube) AS char(255)), 0) END AS qtyChargeCBM,
    IFNULL(CAST(COUNT(doh.orderNo) AS char(255)), 0) AS qtyChargeTotDO,
    IFNULL(CAST(COUNT(aad.orderLineNo) AS char(255)), 0) AS qtyChargeTotLine,
    IFNULL(CAST((SUM(aad.qtyShipped_each * bs.cube)) AS char(255)), 0) AS totalCube,
    IFNULL(CAST(aad.editTime AS char(255)), '') AS editTime,
    IFNULL(CAST(aad.lotNum AS char(255)), '') AS lotNum,
    IFNULL(CAST(aad.traceId AS char(255)), '') AS traceId,
    IFNULL(CAST(aad.pickToTraceId AS char(255)), '') AS pickToTraceId,
    IFNULL(CAST(aad.dropId AS char(255)), '') AS dropId,
    IFNULL(CAST(aad.location AS char(255)), '') AS location,
    IFNULL(CAST(aad.pickToLocation AS char(255)), '') AS pickToLocation,
    IFNULL(CAST(aad.allocationDetailsId AS char(255)), '') AS allocationDetailsId,
    IFNULL(CAST(bs.skuDescr1 AS char(255)), '') AS skuDescr1,
    IFNULL(CAST(bs.grossWeight AS char(255)), 0) AS grossWeight,
    IFNULL(CAST(bs.cube AS char(255)), 0) AS cubeNya,
    IFNULL(CAST(bsm.tariffMasterId AS char(255)), '') AS tariffMasterId,
    IFNULL(CAST(bpdCS.qty AS char(255)), 0) AS QtyPerCases,
    IFNULL(CAST(bpdPL.qty AS char(255)), 0) AS QtyPerPallet,
    IFNULL(CAST(bz.zoneDescr AS char(255)), '') AS zone,
    IFNULL(CAST(ila.lotAtt04 AS char(255)), '') AS batch,
    IFNULL(CAST(ila.lotAtt07 AS char(255)), '') AS lotAtt07,
    IFNULL(CAST(BT.codeid AS char(255)), '') AS billtranctg,
    IFNULL(CAST(SUM(aad.qtyShipped_each * bs.netWeight) AS char(255)), 0) AS qtyChargeNettWeight,
    CASE WHEN bpdEA.uomdescr IN ('G', 'GRAM', 'Gram') THEN IFNULL(CAST(SUM(aad.qtyShipped_each / 1000) AS char(255)), 0) WHEN bpdEA.uomdescr IN ('MT', 'Metric Ton', 'METRIC TON') THEN IFNULL(CAST(SUM(aad.qtyShipped_each * 1000) AS char(255)), 0) ELSE IFNULL(CAST(SUM(aad.qtyShipped_each * bs.grossWeight) AS char(255)), 0) END AS qtyChargeGrossWeight,
    CASE WHEN aad.customerId LIKE '%ABC%' THEN IFNULL(CAST(SUM((aad.qtyShipped_Each * bpdCS.qty) / 1000) AS char(255)), 0) ELSE IFNULL(CAST(SUM(aad.qtyShipped_Each / 1000) AS char(255)), 0) END AS qtyChargeMetricTon,
    df.closeTime,
    aad.allocationDetailsId AS line_trans -- add transaction line
  /*additional nettweight Gross Weight ABYuhuu*/
  FROM ACT_ALLOCATION_DETAILS aad
    LEFT OUTER JOIN DOC_ORDER_HEADER doh
      ON doh.organizationId = aad.organizationId
      AND doh.customerId = aad.customerId
      AND doh.orderNo = aad.orderNo
    LEFT JOIN DOC_ORDER_HEADER_UDF df
      ON (doh.organizationId = df.organizationId)
      AND doh.warehouseId = df.warehouseId
      AND doh.orderNo = df.orderNo
    LEFT OUTER JOIN BAS_SKU bs
      ON bs.organizationId = aad.organizationId
      AND bs.SKU = aad.SKU
      AND bs.customerId = aad.customerId
    LEFT OUTER JOIN BAS_SKU_MULTIWAREHOUSE bsm
      ON bsm.organizationId = bs.organizationId
      AND bsm.SKU = bs.SKU
      AND bsm.customerId = bs.customerId
      AND bsm.warehouseId = aad.warehouseId
    LEFT OUTER JOIN INV_LOT_ATT ila
      ON ila.organizationId = aad.organizationId
      AND ila.SKU = aad.SKU
      AND ila.lotnum = aad.lotnum
      AND ila.customerId = aad.customerId
    LEFT JOIN BAS_PACKAGE_DETAILS bpdEA
      ON bpdEA.organizationId = bs.organizationId
      AND bpdEA.packId = bs.packId
      AND bpdEA.customerId = bs.customerId
      AND bpdEA.packUom = 'EA'
    LEFT JOIN BAS_PACKAGE_DETAILS bpdIP
      ON bpdIP.organizationId = bs.organizationId
      AND bpdIP.packId = bs.packId
      AND bpdIP.customerId = bs.customerId
      AND bpdIP.packUom = 'IP'
    LEFT JOIN BAS_PACKAGE_DETAILS bpdCS
      ON bpdCS.organizationId = bs.organizationId
      AND bpdCS.packId = bs.packId
      AND bpdCS.customerId = bs.customerId
      AND bpdCS.packUom = 'CS'
    LEFT JOIN BAS_PACKAGE_DETAILS bpdPL
      ON bpdPL.organizationId = bs.organizationId
      AND bpdPL.packId = bs.packId
      AND bpdPL.customerId = bs.customerId
      AND bpdPL.packUom = 'PL'
    LEFT JOIN BSM_CODE_ML t1
      ON t1.organizationId = aad.organizationId
      AND t1.codeType = 'SO_TYP'
      AND t1.codeId = doh.orderType
      AND t1.languageId = 'en'
    LEFT JOIN BSM_CODE BT
      ON BT.organizationId = aad.organizationId
      AND BT.codeType = 'BILLING_TRANSACTION_CATEGORY'
      AND BT.outerCode = ila.lotAtt07
    LEFT JOIN BAS_LOCATION bl
      ON bl.organizationId = aad.organizationId
      AND bl.warehouseId = aad.warehouseId
      AND bl.locationId = aad.location
    LEFT JOIN BAS_ZONE bz
      ON bz.organizationId = bl.organizationId
      AND bz.warehouseId = bl.warehouseId
      AND bz.zoneId = bl.zoneId
      AND bz.zoneGroup = bl.zoneGroup
  WHERE aad.organizationId = IN_organizationId
  AND aad.customerId = IN_CustomerId
  AND aad.warehouseId = IN_warehouseId
  AND doh.orderNo = IN_trans_no
  -- AND bsm.tariffMasterId = IN_tariffMaster
  -- AND DATE_FORMAT(aad.shipmentTime, '%Y-%m-%d') >= '2023-09-10'
  --  AND DATE_FORMAT(aad.shipmentTime, '%Y-%m-%d') <= '2023-09-12'
  AND aad.Status IN ('99', '80')
  AND bs.skuDescr1 NOT LIKE '%PALLET%'
  AND aad.sku NOT IN (SELECT
      sku
    FROM Z_SKUNOTBILLING zsnb
    WHERE organizationId = aad.organizationId
    AND customerId = aad.customerId)
  /*  AND aad.sku NOT IN ('DEMOTABLEAT',
    'DEMOTABLESAM',
    'HOTSTAMP',
    'COLLATERAL-COLLECTABLESTICKER',
    'HELLOBASTC',
    'MAMALOVSTC',
    'MAMANOUSTC',
    'MAMAPCK02',
    'STCMCBMS-TH',
    'BUMILTSTC2',
    'COLLATERAL-STICKERPINK',
    'PRINCTSTC3',
    'PRINCTSTC3',
    'PINKBOX03P',
    'YFI001',
    'MAMASTT',
    'TAP-COMBOX',
    'MAMABOXPINK',
    'MAMABOX01',
    'MAMABOX02',
    'BIGBOX5',
    'COLLATERAL-PIZZABOX',
    'MAMABOX01',
    'MAMABOX02',
    'MEDIUMBOX4',
    'SMALLBOX',
    'GRTGCRD',
    'BUNBUNSTC01',
    'BUNBUNSTC02',
    'CONGRATSTC1',
    'MAMAMWTH',
    'STCABS-MY',
    'STCABS-TH',
    'STCANTCOLIC-BIG-TH',
    'STCANTCOLIC-SMALL-TH',
    'STCAPCN',
    'STCAPRCMMY',
    'STCAPRCMY',
    'STCAPRCTH',
    'STCAPRCTH-DIR',
    'STCAPRCTH-NIG',
    'STCAPRCTH-NUT',
    'STCAPRMMY',
    'STCAPRMTH',
    'STCAPRMTH-DIR',
    'STCAPRMTH-NIG',
    'STCAPRMTH-NUT',
    'STCBFS-PH',
    'STCBHABMY',
    'STCBHABTH',
    'STCBHABWPH',
    'STCBHABWTH',
    'STCBPOMSC',
    'STCDC-TH',
    'STCDCIC-TH',
    'STCDCPH',
    'STCDCW-TH',
    'STCDPFMPH',
     'STCGFW-VN', -- add 26-05-25  akbar
    'STCDPFMPH-TH',
    'STCDSDTH',
    'STCEBPTH',
    'STCFWID',
    'STCGBSID',
    'STCGBSMY',
    'STCGBSTH',
    'STCGFW-MY',
    'STCGFWPH',
    'STCGFWTH',
    'STCHPSEATCR',
    'STCINCMY',
    'STCKTP-PH',
    'STCKTPBGTH',
    'STCKTPBID',
    'STCKTPEN',
    'STCKTPSID',
    'STCKTPSTH',
    'STCMCDNFC-ID',
    'STCMCDNFC-MY',
    'STCMCDNFC-PH',
    'STCMCDNFC-SG',
    'STCMCDNFC-TH',
    'STCMCDSD-EN',
    'STCMCDSD-MY',
    'STCMCDSD-SG',
    'STCMCDSD-TH',
    'STCMCHVL-MY',
    'STCMCHVL-PH',
    'STCMCHVL-SG',
    'STCMCHVL-TH',
    'STCMCHVLTH',
    'STCMCMBP-TH',
    'STCMCPH',
    'STCMCSHS-MY',
    'STCMCSHS-PH',
    'STCMCSHS-SG',
    'STCMCSHS-TH',
    'STCMCSVL-ID',
    'STCMCSVL-MY',
    'STCMCTH',
    'STCMCWBP-TH',
    'STCMHG-PH',
    'STCMOSPL-SG',
    'STCMSMY',
    'STCMSTH',
    'STCMWPH',
    'STCMWSG',
    'STCMWTH',
    'STCNCPH',
    'STCNCSG',
    'STCNCTH',
    'STCREVIMSK-TH',
    'STCRFW-MY',
    'STCRFW-TH',
    'STCRMOMY',
    'STCRMOPH',
    'STCRMOTH',
    'STCSMRPH',
    'STCSOOTHMSK-TH',
    'STCSPL-PH',
    'STCSPL-SG',
    'STCTC-TH',
    'STCTCA-TH',
    'STCTCI-TH',
    'STCTCID',
    'STCTCMY',
    'STCTCPH',
    'STCTCSG',
    'STCTO',
    'STCTO-ID',
    'STCTO-PH',
    'STCTPPH',
    'STCTPSG',
    'STCTPTH',
    'STCTSA-TH',
    'STCTSI-TH',
    'STCTSMY',
    'STCTSPH',
    'STCTSSG',
    'STCTTH',
    'STCCAS-ID',
    'STCHIPSEATMI',
    'AMLBL-TH',
    'CFBC-TH',
    'STCABIZNEDR150',
    'STCABIZNEDR250',
    'STCAL-TH-L/XL',
    'STCAL-TH-S/M',
    'STCAPCI-TH',
    'STCAPMI-TH',
    'STCAWN-TH',
    'STCCAS-ID',
    'STCEBPIZNEDR',
    'STCMBPIZNEDR',
    'STCMCSVL-TH',
    'STCMTPID',
    'STCNCMU',
    'STCOLIVE-TH',
    'STCTBRIZNEDR',
    'STDCDR-TH',
    'GRCRDT3',
    'PINKBOX03P',
    'TAP-COMBOX',
    'MAMABOXPINK',
    'STCABS-VN',
    'STCDPFM-VN',
    'STCKTPS-VN',
    'STCMCDSD-VN',
    'STCMCHVL-VN',
    'STCMCSHS-VN',
    'STCRC-VN',
    'STCABSIG-VN',
    'STCABSMNF-VN',
    'STCAPMNF-VN',
    'STCAPSIG-VN',
    'STCTPIG-VN',
    'STCTPMNF-VN',
    'STCACP-VN',
    'STCAMP-VN',
    'STCAPL-VN',
    'STCBNS-VN',
    'STCFBTPTH',
    'STCGS-VN',
    'STCHVLIGT-VN',
    'STCHVLMNF-VN',
    'STCINC-VN',
    'STCMITPTH',
    'STCMT-VN',
    'STCNFC-VN',
    'STCRFW-VN',
    'STCSMC-VN',
    'STCSMS-VN',
    'STCTMTH',
    'STCBSBCCREAMXXLVN',
  'STCFHRCPINKVN',
  'STCFHRCYELLOWVN',
  'STCFRSTBRSHVN',
  'STCFRSTBRSPNKVN',
  'STCHCBLUEVN',
  'STCHGGINGBLUVN',
  'STCHGGINGPNKVN',
  'STCHGGINGWHTVN',
  'STCHIPSEATTRQSVN',
  'STCMNBCREAMLVN',
  'STCMNBCREAMMVN',
  'STCMNBLACKXLVN',
  'STCNANOCRSTS/MVN',
  'STCPAACCREAM3XLVN',
  'STCPACBLACK3XLVN',
  'STCPACCREAMLVN',
  'STCPREGBELTCVN',
  'STCPREGBELTVN',
  'STCSPBMBLACKVN',
  'STCSPBXLBLACKVN',
  'STCWBPADVN','STCMACAV','STCMCBBLCK','STCMCBCRM'
  )
  */
  /*AB-update sku take out base on handing out ls-11-09-24 update 2 12/11/24*/
  AND doh.orderType NOT IN ('FREE', 'KT', 'TROF', 'TTG') /*AB-update so type base on handing out ls-11-09-24*/
  AND COALESCE(ila.lotAtt04, '') NOT IN ('SET') /*AL validate batch*/
  GROUP BY doh.organizationId,
           doh.orderNo,
           doh.soReference1,
           doh.soReference3,
           t1.codeid,
           doh.soStatus,
           doh.orderType,
           doh.warehouseId,
           aad.orderLineNo,
           aad.traceId,
           aad.pickToTraceId,
           aad.dropId,
           aad.customerId,
           aad.location,
           aad.pickToLocation,
           aad.shipmentTime,
           aad.allocationDetailsId,
           aad.SKU,
           aad.qty,
           aad.qty_each,
           aad.qtyShipped_each,
           aad.uom,
           aad.editTime,
           aad.lotNum,
           bsm.tariffMasterId,
           bs.skuDescr1,
           bs.grossWeight,
           bs.cube,
           t1.codeDescr,
           bz.zoneDescr,
           ila.lotAtt04,
           ila.lotAtt07,
           BT.codeid;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET order_done = TRUE;
  OPEN cur_orderno;
cur_order_loop:
  LOOP
    FETCH FROM cur_orderno INTO od_organizationId,
    od_orderNo,
    od_soReference1,
    od_soReference3,
    od_orderType,
    od_docType,
    od_docTypeDescr, od_soStatus, od_warehouseId,
    od_customerId, od_orderLineNo, od_SKU, od_ShipmentTime, od_qty,
    od_qty_each, od_qtyShipped_each, od_uom,
    od_qtyChargeEA,
    od_qtyChargeCS,
    od_qtyChargeIP,
    od_qtyChargePL,
    od_qtyChargeCBM,
    od_qtyChargeTotDO,
    od_qtyChargeTotLine,
    od_totalCube,
    od_editTime, od_lotNum, od_traceId, od_pickToTraceId, od_dropId,
    od_location, od_pickToLocation, od_allocationDetailsId, od_skuDescr1,
    od_grossWeight, od_cubeNya, od_tariffMasterId, od_QtyPerCases,
    od_QtyPerPallet, od_zone, od_batch, od_lotAtt07, od_Billtranctg, od_qtyChargeNettWeight, od_qtyChargeGrossWeight, od_qtyChargeMetricTon,/*additional nettweight Gross Weight ABYuhuu*/
    od_closetimetransaction, /*additional close transaction by AKBAR */
    od_line_transaction;-- line transaction
    IF order_done THEN
      SET order_done = FALSE;
      LEAVE cur_order_loop;
    END IF;

    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = od_organizationId
        AND bs.warehouseId = od_warehouseId
        AND bs.docNo = od_orderNo
        AND bs.udf03 = od_line_transaction
        AND bs.chargeCategory = 'OB') THEN


    BLOCK2:
      BEGIN
        DECLARE cur_Tariff CURSOR FOR

        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          -- btd.udf05,
          btd.ratebase,
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = IN_warehouseId
        AND bsm.customerId = IN_CustomerId
        AND bth.tariffMasterId = od_tariffMasterId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'OB'
        AND btd.docType = od_orderType
        AND btr.rate > 0
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = TRUE;
        ####################################################################


        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;
          IF tariff_done THEN
            SET tariff_done = FALSE;
            LEAVE getTariff;
          END IF;


          -- ADDING AKBAR RULE => JIKA BILLING CATEGORY TIDAK DI SETUP DI BILING SETUP, SKIP VALIDASI 07.03.2024

          IF R_BILLINGTRANCATEGORY IS NULL
            OR R_BILLINGTRANCATEGORY = '' THEN
            SET R_BILLINGTRANCATEGORY = od_Billtranctg;
          END IF;

          SELECT
            R_BILLINGDAY;

          IF R_BILLINGDAY = 31 THEN
            SET R_BILLINGDAY = DAY(LAST_DAY(CURDATE()));
          END IF;

          SELECT
            od_orderType,
            R_docType,
            od_Billtranctg,
            R_BILLINGTRANCATEGORY,
            R_ratebase;
          IF (RTRIM(LTRIM(od_orderType)) = RTRIM(LTRIM(R_docType)))
            AND (RTRIM(LTRIM(od_Billtranctg)) = RTRIM(LTRIM(R_BILLINGTRANCATEGORY))) THEN

            --           SELECT
            --             od_orderType,
            --             R_docType,
            --             od_Billtranctg,
            --             R_BILLINGTRANCATEGORY,
            --             R_RESULTQTYCHARGE,
            --             R_ratebase;


            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH
            SELECT
              R_BILLINGDAY;


            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');


            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);

            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';

            IF (R_ratebase = 'CUBIC') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeCBM;
            ELSEIF (R_ratebase = 'M2') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'IP') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeIP;
            ELSEIF (R_ratebase = 'KG') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'LITER') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'QUANTITY') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'DO') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeTotDO;
            ELSEIF (R_ratebase = 'PALLET') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargePL;
            ELSEIF (R_ratebase = 'CASE') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeCS;
            ELSEIF (R_ratebase = 'NETWEIGHT') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeNettWeight;
            ELSEIF (R_ratebase = 'GW') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeGrossWeight; /*additional nettweight Gross Weight ABYuhuu*/
            ELSEIF (R_ratebase = 'MT') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeMetricTon;/*additional metric ton 29042024*/
            --             IF (R_PALLETCNT = 'N') THEN
            --               SET R_RESULTQTYCHARGE = od_qtyCharge;
            --             ELSEIF (R_PALLETCNT = 'Y') THEN
            --               SET R_RESULTQTYCHARGE = od_qtyCharge;
            --             ELSEIF (R_PALLETCNT = 'X') THEN
            --               SET R_RESULTQTYCHARGE = od_qtyCharge;
            --             END IF;
            END IF;


            SELECT
              'check=>',
              R_RESULTQTYCHARGE,
              R_TARIFFID;


            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF;
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '*_*';
              CALL SPCOM_GetIDSequence_NEW('OJV_CML', '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);
              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                od_organizationId,
                od_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(od_closetimetransaction, '%Y-%m-%d'),
                DATE_FORMAT(od_closetimetransaction, '%Y-%m-%d'),
                od_customerId,
                od_sku,
                od_lotNum,
                od_traceId,
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                R_descrC,
                R_rateBase,
                R_rateperunit,
                od_qtyShipped_each,
                od_uom,
                od_totalCube,
                od_grossWeight,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                'SO',
                od_orderNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                -- R_UDF08 udf03,
                od_line_transaction udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                od_orderType orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType



        END LOOP getTariff;
        CLOSE cur_Tariff;


      --  END IF; 
      --  END IF TARIFF ORDER KOSONG
      END;
    END IF; -- END IF JIKA LINE DI BILSUMMARY SUDAH ADA ( AVOID DOUBLE)
  END LOOP cur_order_loop;
  CLOSE cur_orderno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_BILLHISTD_TYPE2`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_BILLHISTD_TYPE2 (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30))
BEGIN
  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  DECLARE od_organizationId varchar(255);
  DECLARE od_asnReference1 varchar(255);
  DECLARE od_asnReference3 varchar(255);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_asnNo varchar(255);
  DECLARE od_qtyReceived varchar(255);
  DECLARE od_qtyReceivedEach varchar(255);
  DECLARE od_docType varchar(255);
  DECLARE od_docTypeDescr varchar(255);
  DECLARE od_QtyPerCases varchar(255);
  DECLARE od_QtyPerPallet varchar(255);
  DECLARE OUT_returnCode varchar(1000);
  DECLARE od_qtyChargeEA varchar(255);
  DECLARE od_qtyChargeCS varchar(255);
  DECLARE od_qtyChargeIP varchar(255);
  DECLARE od_qtyChargePL varchar(255);
  DECLARE od_qtyChargeCBM varchar(255);
  DECLARE od_qtyChargeTotDO varchar(255);
  DECLARE od_qtyChargeDropId varchar(255);
  DECLARE od_qtyChargeTotLine varchar(255);
  DECLARE od_qtyChargeNettWeight varchar(255); /*additional nettweight NettWeight by IT-ARI BUDIMAN 06.03.2024*/
  DECLARE od_qtyChargeGrossWeight varchar(255);/*additional nettweight grossweight by IT-ARI BUDIMAN 06.03.2024*/
  DECLARE od_qtyChargeMetricTon varchar(255);/*additional MetricTon by IT-ARI BUDIMAN 22.03.2024*/
  DECLARE od_closetimetransaction timestamp; /*additional close transaction by AKBAR */
  ####################################################################
  ##????
  DECLARE inventory_done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE order_done,
          attribute_done int DEFAULT 0;

  DECLARE cur_orderno CURSOR FOR

  SELECT
    sumasn.organizationId,
    sumasn.warehouseId,
    sumasn.customerId,
    sumasn.asnNo,
    sumasn.docType,
    sumasn.asnReference1,
    sumasn.asnReference3,
    SUM(sumasn.qtyChargeEA) AS qtyChargeEA,
    SUM(sumasn.qtyChargeCS) AS qtyChargeCS,
    SUM(sumasn.qtyChargeIP) AS qtyChargeIP,
    SUM(sumasn.qtyChargePL) AS qtyChargePL,
    SUM(sumasn.qtyChargeCBM) AS qtyChargeCBM,
    COUNT(sumasn.qtyChargeDropId) AS qtyChargeDropId,
    COUNT(sumasn.qtyChargeTotDO) AS qtyChargeTotDO,
    SUM(sumasn.qtyChargeTotLine) AS qtyChargeTotLine,
    SUM(sumasn.qtyChargeNettWeight) AS qtyChargeNettWeight,
    SUM(sumasn.qtyChargeGrossWeight) AS qtyChargeGrossWeight,
    SUM(sumasn.qtyChargeMetricTon) AS qtyChargeMetricTon,
    sumasn.closeTime
  FROM (SELECT DISTINCT
      IFNULL(CAST(dah.organizationId AS char(255)), '') AS organizationId,
      IFNULL(CAST(dah.asnReference1 AS char(255)), '') AS asnReference1,
      IFNULL(CAST(dah.asnReference3 AS char(255)), '') AS asnReference3,
      IFNULL(CAST(atl.warehouseId AS char(255)), '') AS warehouseId,
      IFNULL(CAST(atl.docNo AS char(255)), '') AS asnNo,
      IFNULL(CAST(atl.tocustomerId AS char(255)), '') AS customerId,
      IFNULL(CAST(COUNT(atl.docLineNo) AS char(255)), 0) AS qtyChargeTotLine,
      IFNULL(CAST(SUM(atl.toQty) AS char(255)), 0) AS qtyReceived,
      IFNULL(CAST(SUM(atl.toQty_Each) AS char(255)), 0) AS qtyReceivedEach,
      IFNULL(CAST(SUM(atl.toQty_Each / bpdEA.qty) AS char(255)), 0) AS qtyChargeEA,
      IFNULL(CAST(CEIL(SUM(atl.toQty_Each / bpdCS.qty)) AS char(255)), 0) AS qtyChargeCS,
      IFNULL(CAST(CEIL(SUM(atl.toQty_Each / bpdIP.qty)) AS char(255)), 0) AS qtyChargeIP,
      IFNULL(CAST(CEIL(SUM(atl.toQty_Each / bpdPL.qty)) AS char(255)), 0) AS qtyChargePL,
      IFNULL(CAST(SUM(atl.toQty_Each * bs.cube) AS char(255)), 0) AS qtyChargeCBM,
      IFNULL(CAST(atl.docNo AS char(255)), 0) AS qtyChargeTotDO,
      IFNULL(CAST(SUM(bs.cube) AS char(255)), 0) AS totalCube,
      IFNULL(CAST(atl.tomuid AS char(255)), '') AS qtyChargeDropId,
      IFNULL(CAST(t1.codeid AS char(255)), '') AS docType,
      IFNULL(CAST(t1.codeDescr AS char(255)), '') AS docTypeDescr,
      IFNULL(CAST(SUM(atl.toQty_Each * bs.netWeight) AS char(255)), 0) AS qtyChargeNettWeight,/*additional nettweight grossweight*/
      CASE WHEN bpdEA.uomdescr IN ('G', 'GRAM', 'Gram') THEN IFNULL(CAST(SUM(atl.toQty_Each / 1000) AS char(255)), 0) WHEN bpdEA.uomdescr IN ('MT', 'Metric Ton', 'METRIC TON') THEN IFNULL(CAST(SUM(atl.toQty_Each * 1000) AS char(255)), 0) ELSE IFNULL(CAST(SUM(atl.toQty_Each * bs.grossWeight) AS char(255)), 0) END AS qtyChargeGrossWeight,
      CASE WHEN atl.tocustomerId LIKE '%ABC%' THEN IFNULL(CAST(SUM((atl.toQty_Each * bpdCS.qty) / 1000) AS char(255)), 0) ELSE IFNULL(CAST(SUM(atl.toQty_Each / 1000) AS char(255)), 0) END AS qtyChargeMetricTon,
      daf.closeTime
    FROM ACT_TRANSACTION_LOG atl
      LEFT OUTER JOIN BAS_SKU bs
        ON bs.organizationId = atl.organizationId
        AND bs.customerId = atl.toCustomerId
        AND bs.SKU = atl.toSku
      LEFT OUTER JOIN BAS_SKU_MULTIWAREHOUSE bsm
        ON bsm.organizationId = atl.organizationId
        AND bsm.warehouseId = atl.warehouseId
        AND bsm.customerId = atl.tocustomerId
        AND bsm.SKU = atl.toSku
      LEFT OUTER JOIN DOC_ASN_HEADER dah
        ON dah.organizationId = atl.organizationId
        AND dah.warehouseId = atl.warehouseId
        AND dah.asnNo = atl.docNo
        AND dah.customerId = atl.fmCustomerId
      LEFT JOIN DOC_ASN_HEADER_UDF daf
        ON dah.organizationId = daf.organizationId
        AND dah.warehouseId = daf.warehouseId
        AND dah.asnNo = daf.asnNo
      LEFT OUTER JOIN DOC_ASN_DETAILS dad
        ON dad.organizationId = atl.organizationId
        AND dad.warehouseId = atl.warehouseId
        AND dad.asnNo = atl.docNo
        AND dad.asnLineNo = atl.docLineNo
        AND dad.sku = atl.toSku
      LEFT OUTER JOIN INV_LOT_ATT ila
        ON ila.organizationId = atl.organizationId
        AND ila.customerId = atl.toCustomerId
        AND ila.SKU = atl.toSku
        AND ila.lotNum = atl.toLotNum
      LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpdEA
        ON bpdEA.organizationId = bs.organizationId
        AND bpdEA.packId = bs.packId
        AND bpdEA.customerId = bs.customerId
        AND bpdEA.packUOM = 'EA'
      LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpdIP
        ON bpdIP.organizationId = bs.organizationId
        AND bpdIP.packId = bs.packId
        AND bpdIP.customerId = bs.customerId
        AND bpdIP.packUOM = 'IP'
      LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpdCS
        ON bpdCS.organizationId = bs.organizationId
        AND bpdCS.packId = bs.packId
        AND bpdCS.customerId = bs.customerId
        AND bpdCS.packUOM = 'CS'
      LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpdPL
        ON bpdPL.organizationId = bs.organizationId
        AND bpdPL.packId = bs.packId
        AND bpdPL.customerId = bs.customerId
        AND bpdPL.packUOM = 'PL'
      LEFT JOIN BSM_CODE_ML t1
        ON t1.organizationId = atl.organizationId
        AND t1.codeType = 'ASN_TYP'
        AND dah.asnType = t1.codeId
        AND t1.languageId = 'en'
      LEFT JOIN BSM_CODE BT
        ON BT.organizationId = atl.organizationId
        AND BT.codeType = 'BILLING_TRANSACTION_CATEGORY'
        AND BT.outerCode = ila.lotAtt07
      LEFT JOIN BAS_LOCATION bl
        ON bl.organizationId = atl.organizationId
        AND bl.warehouseId = atl.warehouseId
        AND bl.locationId = atl.tolocation
      LEFT JOIN BAS_ZONE bz
        ON bz.organizationId = bl.organizationId
        AND bz.organizationId = bl.organizationId
        AND bz.warehouseId = bl.warehouseId
        AND bz.zoneId = bl.zoneId
        AND bz.zoneGroup = bl.zoneGroup
    WHERE atl.organizationId = IN_organizationId
    AND atl.warehouseId = IN_warehouseId
    AND dah.customerId = IN_CustomerId
    AND dah.asnNo = IN_trans_no
    AND COALESCE(ila.lotAtt04, '') NOT IN ('SET') /*AL validate batch*/
    # AND bsm.tariffMasterId = IN_tariffMaster
    AND atl.transactionType = 'IN'
    AND dah.asnType NOT IN ('FREE', 'IU', 'TTG')
    AND dad.skuDescr NOT LIKE '%PALLET%'
    AND atl.toSku NOT IN (SELECT
        sku
      FROM Z_SKUNOTBILLING zsnb
      WHERE organizationId = atl.organizationId
      AND customerId = atl.toCustomerId)
    /*    AND atl.toSku NOT IN ('YFI001', 'DEMO TABLE AT', 'DEMO TABLE SAM', 'HOT STAMP', 'COLLATERAL-COLLECTABLE STICKER', 'HELLOBASTC', 'MAMALOVSTC', 'MAMANOUSTC', 'MAMAPCK02',
        'MAMASTT', 'STCMCBMS-TH', 'BUMILTSTC2', 'COLLATERAL-STICKERPINK', 'PRINCTSTC3',
        'MAMABOX01',
        'MAMABOX02',
        'MAMABOXPINK',
        'PINKBOX03P',
        'BIGBOX5',
        'COLLATERAL-PIZZABOX',
        'MAMABOX01',
        'MAMABOX02',
        'MAMABOXPINK',
        'MEDIUMBOX4',
        'PINKBOX03P',
        'SMALL BOX',
        'TAP-COMBOX',
        'GRTGCRD',
        'BUNBUNSTC01',
        'BUNBUNSTC02',
        'CONGRATSTC1',
        'MAMAMWTH',
        'STCABS-MY',
        'STCABS-TH',
        'STCANTCOLIC-BIG-TH',
        'STCANTCOLIC-SMALL-TH',
        'STCAPCN',
        'STCAPRCMMY',
        'STCAPRCMY',
        'STCAPRCTH',
        'STCAPRCTH-DIR',
        'STCAPRCTH-NIG',
        'STCAPRCTH-NUT',
        'STCAPRMMY',
        'STCAPRMTH',
        'STCAPRMTH-DIR',
        'STCAPRMTH-NIG',
        'STCAPRMTH-NUT',
        'STCBFS-PH',
        'STCBHABMY',
        'STCBHABTH',
        'STCBHABWPH',
        'STCBHABWTH',
        'STCBPOMSC',
        'STCDC-TH',
        'STCDCIC-TH',
        'STCDCPH',
        'STCDCW-TH',
        'STCDPFMPH',
        'STCDPFMPH-TH',
        'STCDSDTH',
        'STCEBPTH',
        'STCFWID',
            'STCGFW-VN', -- add 26-05-25  akbar
        'STCGBSID',
        'STCGBSMY',
        'STCGBSTH',
        'STCGFW-MY',
        'STCGFWPH',
        'STCGFWTH',
        'STCHPSEATCR',
        'STCINCMY',
        'STCKTP-PH',
        'STCKTPBGTH',
        'STCKTPBID',
        'STCKTPEN',
        'STCKTPSID',
        'STCKTPSTH',
        'STCMCDNFC-ID',
        'STCMCDNFC-MY',
        'STCMCDNFC-PH',
        'STCMCDNFC-SG',
        'STCMCDNFC-TH',
        'STCMCDSD-EN',
        'STCMCDSD-MY',
        'STCMCDSD-SG',
        'STCMCDSD-TH',
        'STCMCHVL-MY',
        'STCMCHVL-PH',
        'STCMCHVL-SG',
        'STCMCHVL-TH',
        'STCMCHVLTH',
        'STCMCMBP-TH',
        'STCMCPH',
        'STCMCSHS-MY',
        'STCMCSHS-PH',
        'STCMCSHS-SG',
        'STCMCSHS-TH',
        'STCMCSVL-ID',
        'STCMCSVL-MY',
        'STCMCTH',
        'STCMCWBP-TH',
        'STCMHG-PH',
        'STCMOSPL-SG',
        'STCMSMY',
        'STCMSTH',
        'STCMWPH',
        'STCMWSG',
        'STCMWTH',
        'STCNCPH',
        'STCNCSG',
        'STCNCTH',
        'STCREVIMSK-TH',
        'STCRFW-MY',
        'STCRFW-TH',
        'STCRMOMY',
        'STCRMOPH',
        'STCRMOTH',
        'STCSMRPH',
        'STCSOOTHMSK-TH',
        'STCSPL-PH',
        'STCSPL-SG',
        'STCTC-TH',
        'STCTCA-TH',
        'STCTCI-TH',
        'STCTCID',
        'STCTCMY',
        'STCTCPH',
        'STCTCSG',
        'STCTO',
        'STCTO-ID',
        'STCTO-PH',
        'STCTPPH',
        'STCTPSG',
        'STCTPTH',
        'STCTSA-TH',
        'STCTSI-TH',
        'STCTSMY',
        'STCTSPH',
        'STCTSSG',
        'STCTTH',
        'STCHIPSEATMI',
        'STCBSBCCREAMXXLVN',
    'STCFHRCPINKVN',
    'STCFHRCYELLOWVN',
    'STCFRSTBRSHVN',
    'STCFRSTBRSPNKVN',
    'STCHCBLUEVN',
    'STCHGGINGBLUVN',
    'STCHGGINGPNKVN',
    'STCHGGINGWHTVN',
    'STCHIPSEATTRQSVN',
    'STCMNBCREAMLVN',
    'STCMNBCREAMMVN',
    'STCMNBLACKXLVN',
    'STCNANOCRSTS/MVN',
    'STCPAACCREAM3XLVN',
    'STCPACBLACK3XLVN',
    'STCPACCREAMLVN',
    'STCPREGBELTCVN',
    'STCPREGBELTVN',
    'STCSPBMBLACKVN',
    'STCSPBXLBLACKVN',
    'STCWBPADVN','STCMACAV','STCMCBBLCK','STCMCBCRM'
    )
    */
    AND atl.STATUS IN ('80', '99')
    AND dah.asnStatus IN ('99')
    GROUP BY atl.docNo,
             atl.docLineNo,
             atl.toCustomerId,
             atl.warehouseId,
             atl.tocustomerId,
             atl.toMuId,
             dah.organizationId,
             dah.asnNo,
             dah.asnType,
             dah.asnReference1,
             dah.asnReference3,
             t1.codeid,
             BT.codeid) sumasn
  GROUP BY sumasn.organizationId,
           sumasn.warehouseId,
           sumasn.customerId,
           sumasn.asnNo,
           sumasn.docType,
           sumasn.asnReference1,
           sumasn.asnReference3,
           sumasn.closeTime;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET order_done = 1;
  OPEN cur_orderno;
cur_order_loop:
  LOOP
    FETCH FROM cur_orderno INTO od_organizationId,
    od_warehouseId,
    od_customerId,
    od_asnNo,
    od_docType,
    od_asnReference1,
    od_asnReference3,
    od_qtyChargeEA,
    od_qtyChargeCS,
    od_qtyChargeIP,
    od_qtyChargePL,
    od_qtyChargeCBM,
    od_qtyChargeTotDO,
    od_qtyChargeDropId,
    od_qtyChargeTotLine,
    od_qtyChargeNettWeight,
    od_qtyChargeGrossWeight,
    od_qtyChargeMetricTon,
    od_closetimetransaction;/*additional nettweight grossweight metric ton*/

    IF order_done = 1 THEN

      SET order_done = 0;
      LEAVE cur_order_loop;
    END IF;



    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = od_organizationId
        AND bs.warehouseId = od_warehouseId
        AND bs.docNo = od_asnNo
        AND bs.chargeCategory = 'IB') THEN

    BLOCK2:
      BEGIN



        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = IN_warehouseId
        AND bsm.customerId = IN_CustomerId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IB'
        AND btd.docType = od_docType
        AND btr.rate > 0
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;
          IF tariff_done THEN
            SET tariff_done = FALSE;
            LEAVE getTariff;
          END IF;


          SELECT
            od_docType,
            R_docType,
            -- od_Billtranctg,
            R_BILLINGTRANCATEGORY;

          -- ADDING AKBAR RULE => JIKA BILLING CATEGORY TIDAK DI SETUP DI BILING SETUP, SKIP VALIDASI 07.03.2024

          IF R_BILLINGTRANCATEGORY IS NULL
            OR R_BILLINGTRANCATEGORY = '' THEN
            SET R_BILLINGTRANCATEGORY = '';
          END IF;

          IF (LTRIM(RTRIM(od_docType)) = LTRIM(RTRIM(R_docType))) THEN
            --  AND (LTRIM(RTRIM(od_Billtranctg)) = LTRIM(RTRIM(R_BILLINGTRANCATEGORY))) THEN
            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH


            --           SELECT  'check=>',R_ratebase,R_TARIFFID;
            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';


            IF (R_ratebase = 'CUBIC') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeCBM;
            ELSEIF (R_ratebase = 'M2') THEN
              SET R_RESULTQTYCHARGE = 0;
            ELSEIF (R_ratebase = 'IP') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeIP;
            ELSEIF (R_ratebase = 'KG') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'LITER') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'DO') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeTotDO;
            ELSEIF (R_ratebase = 'PALLET') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargePL;
            ELSEIF (R_ratebase = 'CASE') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeCS;
            ELSEIF (R_ratebase = 'QUANTITY') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'NETWEIGHT') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeNettWeight;
            ELSEIF (R_ratebase = 'GW') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeGrossWeight;
            /*additional nettweight grossweight*/
            ELSEIF (R_ratebase = 'DID') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeDropId;
            ELSEIF (R_ratebase = 'DID1') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeDropId;
            ELSEIF (R_ratebase = 'MT') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeMetricTon;
            END IF;



            --           SELECT 'check 2=>',R_RESULTQTYCHARGE;

            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #
            SELECT
              R_billsummaryId;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                od_organizationId,
                od_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(od_closetimetransaction, '%Y-%m-%d'),
                DATE_FORMAT(od_closetimetransaction, '%Y-%m-%d'),
                od_customerId,
                '' SKU,
                '' lotNum,
                '' traceId,
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                R_descrC,
                R_rateBase,
                R_rateperunit,
                R_RESULTQTYCHARGE,
                '' uom,
                od_qtyChargeCBM,
                od_qtyChargeGrossWeight,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                od_docType,
                od_asnNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                '' udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                od_docType orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;






      END;

    END IF; -- END IF JIKA LINE DI BILSUMMARY SUDAH ADA ( AVOID DOUBLE)


  END LOOP cur_order_loop;
  CLOSE cur_orderno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_BILLHISTD`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_BILLHISTD (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN


  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  DECLARE od_organizationId varchar(255);
  DECLARE od_asnReference1 varchar(255);
  DECLARE od_asnReference3 varchar(255);
  DECLARE od_skuDescr1 varchar(255);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_asnNo varchar(255);
  DECLARE od_asnLineNo varchar(255);
  DECLARE od_sku varchar(255);
  DECLARE od_qtyReceived varchar(255);
  DECLARE od_uom varchar(255);
  DECLARE od_qtyReceivedEach varchar(255);
  DECLARE od_totalCube varchar(255);
  DECLARE od_addTime varchar(255);
  DECLARE od_editTime varchar(255);
  DECLARE od_transactionTime varchar(255);
  DECLARE od_lotNum varchar(255);
  DECLARE od_traceId varchar(255);
  DECLARE od_muid varchar(255);
  DECLARE od_toLocation varchar(255);
  DECLARE od_transactionId varchar(255);
  DECLARE od_docType varchar(255);
  DECLARE od_docTypeDescr varchar(255);
  DECLARE od_packId varchar(255);
  DECLARE od_QtyPerCases varchar(255);
  DECLARE od_QtyPerPallet varchar(255);
  DECLARE od_sku_group1 varchar(255);
  DECLARE od_grossWeight varchar(255);
  DECLARE od_cubeNya varchar(255);
  DECLARE od_tariffMasterId varchar(255);
  DECLARE od_zone varchar(255);
  DECLARE od_batch varchar(255);
  DECLARE od_lotAtt07 varchar(255);
  DECLARE od_RecType varchar(21);
  DECLARE od_Billtranctg varchar(21);
  DECLARE OUT_returnCode varchar(1000);
  DECLARE od_qtyChargeEA varchar(255);
  DECLARE od_qtyChargeCS varchar(255);
  DECLARE od_qtyChargeIP varchar(255);
  DECLARE od_qtyChargePL varchar(255);
  DECLARE od_qtyChargeCBM varchar(255);
  DECLARE od_qtyChargeTotDO varchar(255);
  DECLARE od_qtyChargeTotLine varchar(255);
  DECLARE od_qtyChargeNettWeight varchar(255); /*additional nettweight NettWeight by IT-ARI BUDIMAN 06.03.2024*/
  DECLARE od_qtyChargeGrossWeight varchar(255);/*additional nettweight grossweight by IT-ARI BUDIMAN 06.03.2024*/
  DECLARE od_qtyChargeMetricTon varchar(255);/*additional MetricTon by IT-ARI BUDIMAN 22.03.2024*/
  DECLARE od_closetimetransaction timestamp; /*additional close transaction by AKBAR */
  DECLARE od_line_transaction varchar(255); /*additional line id unique transaction 02.07.2024 */
  ####################################################################
  ##????
  DECLARE inventory_done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE order_done,
          attribute_done int DEFAULT 0;



  DECLARE cur_orderno CURSOR FOR
  SELECT
    IFNULL(CAST(dah.organizationId AS char(255)), '') AS organizationId,
    IFNULL(CAST(dah.asnReference1 AS char(255)), '') AS asnReference1,
    IFNULL(CAST(dah.asnReference3 AS char(255)), '') AS asnReference3,
    IFNULL(CAST(dad.skuDescr AS char(255)), '') AS skuDescr1,
    IFNULL(CAST(atl.warehouseId AS char(255)), '') AS warehouseId,
    IFNULL(CAST(atl.tocustomerId AS char(255)), '') AS customerId,
    IFNULL(CAST(atl.docNo AS char(255)), '') AS asnNo,
    IFNULL(CAST(atl.docLineNo AS char(255)), 0) AS asnLineNo,
    IFNULL(CAST(atl.toSku AS char(255)), '') AS sku,
    IFNULL(CAST(atl.toQty AS char(255)), 0) AS qtyReceived,
    IFNULL(CAST(atl.toUom AS char(255)), '') AS uom,
    IFNULL(CAST(atl.toQty_Each AS char(255)), 0) AS qtyReceivedEach,
    CASE WHEN atl.tocustomerId IN ('MAP') AND
        ila.lotAtt04 IN ('SETA', 'SET A', 'SET_A', 'SET-A', 'NONSET', 'NON SET', 'NON_SET', 'NON-SET') AND
        bsm.tariffMasterId LIKE '%PIECE%' THEN IFNULL(CAST(SUM(atl.toQty_Each / bpdEA.qty) AS char(255)), 0) ELSE IFNULL(CAST(SUM(atl.toQty_Each / bpdEA.qty) AS char(255)), 0) END AS qtyChargeEA,
    IFNULL(CAST(CEIL(SUM(atl.toQty_Each / bpdCS.qty)) AS char(255)), 0) AS qtyChargeCS,
    IFNULL(CAST(CEIL(SUM(atl.toQty_Each / bpdIP.qty)) AS char(255)), 0) AS qtyChargeIP,
    IFNULL(CAST(CEIL(SUM(atl.toQty_Each / bpdPL.qty)) AS char(255)), 0) AS qtyChargePL,
    CASE WHEN atl.tocustomerId IN ('MAP') AND
        ila.lotAtt04 IN ('SETA', 'SET A', 'SET_A', 'SET-A', 'NONSET', 'NON SET', 'NON_SET', 'NON-SET') AND
        bsm.tariffMasterId NOT LIKE '%PIECE%' THEN IFNULL(CAST(SUM(atl.toQty_Each * bs.cube) AS char(255)), 0) ELSE IFNULL(CAST(SUM(atl.toQty_Each * bs.cube) AS char(255)), 0) END AS qtyChargeCBM,
    IFNULL(CAST(COUNT(atl.docNo) AS char(255)), 0) AS qtyChargeTotDO,
    IFNULL(CAST(COUNT(atl.docLineNo) AS char(255)), 0) AS qtyChargeTotLine,
    IFNULL(CAST(SUM(bs.cube) AS char(255)), 0) AS totalCube,
    CAST(DATE_FORMAT(atl.addTime, '%Y-%m-%d') AS char(255)) AS addTime,
    CAST(DATE_FORMAT(atl.editTime, '%Y-%m-%d') AS char(255)) AS editTime,
    CAST(DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') AS char(255)) AS transactionTime,
    IFNULL(CAST(atl.tolotNum AS char(255)), '') AS lotNum,
    IFNULL(CAST(atl.toId AS char(255)), '') AS traceId,
    IFNULL(CAST(atl.tomuid AS char(255)), '') AS muid,
    IFNULL(CAST(atl.toLocation AS char(255)), '') AS toLocation,
    IFNULL(CAST(t1.codeid AS char(255)), '') AS docType,
    IFNULL(CAST(t1.codeDescr AS char(255)), '') AS docTypeDescr,
    IFNULL(CAST(bpdCS.packId AS char(255)), '') AS packId,
    IFNULL(CAST(bpdCS.qty AS char(255)), 0) AS QtyPerCases,
    IFNULL(CAST(bpdPL.qty AS char(255)), 0) AS QtyPerPallet,
    IFNULL(CAST(bs.sku_group1 AS char(255)), '') AS sku_group1,
    IFNULL(CAST(bs.grossWeight AS char(255)), 0) AS grossWeight,
    IFNULL(CAST(bs.cube AS char(255)), 0) AS cubeNya,
    IFNULL(CAST(bsm.tariffMasterId AS char(255)), '') AS tariffMasterId,
    IFNULL(CAST(bz.zoneDescr AS char(255)), '') AS zone,
    IFNULL(CAST(ila.lotAtt04 AS char(255)), '') AS batch,
    IFNULL(CAST(ila.lotAtt07 AS char(10)), '') AS lotAtt07,
    IFNULL(CAST(BT.codeid AS char(255)), '') AS billtranctg,
    IFNULL(CAST(SUM(atl.toQty_Each * bs.netWeight) AS char(255)), 0) AS qtyChargeNettWeight,/*additional nettweight grossweight*/
    CASE WHEN bpdEA.uomdescr IN ('G', 'GRAM', 'Gram') THEN IFNULL(CAST(SUM(atl.toQty_Each / 1000) AS char(255)), 0) WHEN bpdEA.uomdescr IN ('MT', 'Metric Ton', 'METRIC TON') THEN IFNULL(CAST(SUM(atl.toQty_Each * 1000) AS char(255)), 0) ELSE IFNULL(CAST(SUM(atl.toQty_Each * bs.grossWeight) AS char(255)), 0) END AS qtyChargeGrossWeight,
    CASE WHEN atl.tocustomerId LIKE '%ABC%' THEN IFNULL(CAST(SUM((atl.toQty_Each * bpdCS.qty) / 1000) AS char(255)), 0) ELSE IFNULL(CAST(SUM(atl.toQty_Each / 1000) AS char(255)), 0) END AS qtyChargeMetricTon,
    daf.closeTime,
    atl.transactionId -- add transaction line
  FROM ACT_TRANSACTION_LOG atl
    LEFT OUTER JOIN BAS_SKU bs
      ON bs.organizationId = atl.organizationId
      AND bs.customerId = atl.toCustomerId
      AND bs.SKU = atl.toSku
    LEFT OUTER JOIN BAS_SKU_MULTIWAREHOUSE bsm
      ON bsm.organizationId = atl.organizationId
      AND bsm.warehouseId = atl.warehouseId
      AND bsm.customerId = atl.tocustomerId
      AND bsm.SKU = atl.toSku
    LEFT OUTER JOIN DOC_ASN_HEADER dah
      ON dah.organizationId = atl.organizationId
      AND dah.warehouseId = atl.warehouseId
      AND dah.asnNo = atl.docNo
      AND dah.customerId = atl.fmCustomerId
    LEFT JOIN DOC_ASN_HEADER_UDF daf
      ON dah.organizationId = daf.organizationId
      AND dah.warehouseId = daf.warehouseId
      AND dah.asnNo = daf.asnNo
    LEFT OUTER JOIN DOC_ASN_DETAILS dad
      ON dad.organizationId = atl.organizationId
      AND dad.warehouseId = atl.warehouseId
      AND dad.asnNo = atl.docNo
      AND dad.asnLineNo = atl.docLineNo
      AND dad.sku = atl.toSku
    LEFT OUTER JOIN INV_LOT_ATT ila
      ON ila.organizationId = atl.organizationId
      AND ila.customerId = atl.toCustomerId
      AND ila.SKU = atl.toSku
      AND ila.lotNum = atl.toLotNum
    LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpdEA
      ON bpdEA.organizationId = bs.organizationId
      AND bpdEA.packId = bs.packId
      AND bpdEA.customerId = bs.customerId
      AND bpdEA.packUOM = 'EA'
    LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpdIP
      ON bpdIP.organizationId = bs.organizationId
      AND bpdIP.packId = bs.packId
      AND bpdIP.customerId = bs.customerId
      AND bpdIP.packUOM = 'IP'
    LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpdCS
      ON bpdCS.organizationId = bs.organizationId
      AND bpdCS.packId = bs.packId
      AND bpdCS.customerId = bs.customerId
      AND bpdCS.packUOM = 'CS'
    LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpdPL
      ON bpdPL.organizationId = bs.organizationId
      AND bpdPL.packId = bs.packId
      AND bpdPL.customerId = bs.customerId
      AND bpdPL.packUOM = 'PL'
    LEFT JOIN BSM_CODE_ML t1
      ON t1.organizationId = atl.organizationId
      AND t1.codeType = 'ASN_TYP'
      AND dah.asnType = t1.codeId
      AND t1.languageId = 'en'
    LEFT JOIN BSM_CODE BT
      ON BT.organizationId = atl.organizationId
      AND BT.codeType = 'BILLING_TRANSACTION_CATEGORY'
      AND BT.outerCode = ila.lotAtt07
    LEFT JOIN BAS_LOCATION bl
      ON bl.organizationId = atl.organizationId
      AND bl.warehouseId = atl.warehouseId
      AND bl.locationId = atl.tolocation
    LEFT JOIN BAS_ZONE bz
      ON bz.organizationId = bl.organizationId
      AND bz.organizationId = bl.organizationId
      AND bz.warehouseId = bl.warehouseId
      AND bz.zoneId = bl.zoneId
      AND bz.zoneGroup = bl.zoneGroup
  WHERE atl.organizationId = IN_organizationId
  AND atl.warehouseId = IN_warehouseId
  AND dah.customerId = IN_CustomerId
  AND dah.asnNo = IN_trans_no
  AND COALESCE(ila.lotAtt04, '') NOT IN ('SET') /*AL validate batch*/
  # AND bsm.tariffMasterId = IN_tariffMaster
  AND atl.transactionType = 'IN'
  AND dah.asnType NOT IN ('FREE', 'IU', 'TTG')
  AND dad.skuDescr NOT LIKE '%PALLET%'
  AND atl.toSku NOT IN (SELECT
      sku
    FROM Z_SKUNOTBILLING zsnb
    WHERE organizationId = atl.organizationId
    AND customerId = atl.toCustomerId)
  /*  AND atl.toSku NOT IN ('DEMOTABLEAT',
    'DEMOTABLESAM',
    'HOTSTAMP',
    'COLLATERAL-COLLECTABLESTICKER',
    'HELLOBASTC',
    'MAMALOVSTC',
    'MAMANOUSTC',
    'MAMAPCK02',
    'STCMCBMS-TH',
    'BUMILTSTC2',
    'COLLATERAL-STICKERPINK',
    'PRINCTSTC3',
    'PRINCTSTC3',
    'PINKBOX03P',
    'YFI001',
    'MAMASTT',
    'TAP-COMBOX',
    'MAMABOXPINK',
    'MAMABOX01',
    'MAMABOX02',
    'BIGBOX5',
    'COLLATERAL-PIZZABOX',
    'MAMABOX01',
    'MAMABOX02',
    'MEDIUMBOX4',
    'SMALLBOX',
    'GRTGCRD',
    'BUNBUNSTC01',
    'BUNBUNSTC02',
    'CONGRATSTC1',
    'MAMAMWTH',
    'STCABS-MY',
    'STCABS-TH',
    'STCANTCOLIC-BIG-TH',
    'STCANTCOLIC-SMALL-TH',
    'STCAPCN',
    'STCAPRCMMY',
    'STCAPRCMY',
    'STCAPRCTH',
    'STCAPRCTH-DIR',
    'STCAPRCTH-NIG',
    'STCAPRCTH-NUT',
    'STCAPRMMY',
    'STCAPRMTH',
    'STCAPRMTH-DIR',
    'STCAPRMTH-NIG',
    'STCAPRMTH-NUT',
    'STCBFS-PH',
    'STCGFW-VN', -- add 26-05-25  akbar
    'STCBHABMY',
    'STCBHABTH',
    'STCBHABWPH',
    'STCBHABWTH',
    'STCBPOMSC',
    'STCDC-TH',
    'STCDCIC-TH',
    'STCDCPH',
    'STCDCW-TH',
    'STCDPFMPH',
    'STCDPFMPH-TH',
    'STCDSDTH',
    'STCEBPTH',
    'STCFWID',
    'STCGBSID',
    'STCGBSMY',
    'STCGBSTH',
    'STCGFW-MY',
    'STCGFWPH',
    'STCGFWTH',
    'STCHPSEATCR',
    'STCINCMY',
    'STCKTP-PH',
    'STCKTPBGTH',
    'STCKTPBID',
    'STCKTPEN',
    'STCKTPSID',
    'STCKTPSTH',
    'STCMCDNFC-ID',
    'STCMCDNFC-MY',
    'STCMCDNFC-PH',
    'STCMCDNFC-SG',
    'STCMCDNFC-TH',
    'STCMCDSD-EN',
    'STCMCDSD-MY',
    'STCMCDSD-SG',
    'STCMCDSD-TH',
    'STCMCHVL-MY',
    'STCMCHVL-PH',
    'STCMCHVL-SG',
    'STCMCHVL-TH',
    'STCMCHVLTH',
    'STCMCMBP-TH',
    'STCMCPH',
    'STCMCSHS-MY',
    'STCMCSHS-PH',
    'STCMCSHS-SG',
    'STCMCSHS-TH',
    'STCMCSVL-ID',
    'STCMCSVL-MY',
    'STCMCTH',
    'STCMCWBP-TH',
    'STCMHG-PH',
    'STCMOSPL-SG',
    'STCMSMY',
    'STCMSTH',
    'STCMWPH',
    'STCMWSG',
    'STCMWTH',
    'STCNCPH',
    'STCNCSG',
    'STCNCTH',
    'STCREVIMSK-TH',
    'STCRFW-MY',
    'STCRFW-TH',
    'STCRMOMY',
    'STCRMOPH',
    'STCRMOTH',
    'STCSMRPH',
    'STCSOOTHMSK-TH',
    'STCSPL-PH',
    'STCSPL-SG',
    'STCTC-TH',
    'STCTCA-TH',
    'STCTCI-TH',
    'STCTCID',
    'STCTCMY',
    'STCTCPH',
    'STCTCSG',
    'STCTO',
    'STCTO-ID',
    'STCTO-PH',
    'STCTPPH',
    'STCTPSG',
    'STCTPTH',
    'STCTSA-TH',
    'STCTSI-TH',
    'STCTSMY',
    'STCTSPH',
    'STCTSSG',
    'STCTTH',
    'STCCAS-ID',
    'STCHIPSEATMI',
    'AMLBL-TH',
    'CFBC-TH',
    'STCABIZNEDR150',
    'STCABIZNEDR250',
    'STCAL-TH-L/XL',
    'STCAL-TH-S/M',
    'STCAPCI-TH',
    'STCAPMI-TH',
    'STCAWN-TH',
    'STCCAS-ID',
    'STCEBPIZNEDR',
    'STCMBPIZNEDR',
    'STCMCSVL-TH',
    'STCMTPID',
    'STCNCMU',
    'STCOLIVE-TH',
    'STCTBRIZNEDR',
    'STDCDR-TH',
    'GRCRDT3',
    'PINKBOX03P',
    'TAP-COMBOX',
    'MAMABOXPINK',
    'STCABS-VN',
    'STCDPFM-VN',
    'STCKTPS-VN',
    'STCMCDSD-VN',
    'STCMCHVL-VN',
    'STCMCSHS-VN',
    'STCRC-VN',
    'STCABSIG-VN',
    'STCABSMNF-VN',
    'STCAPMNF-VN',
    'STCAPSIG-VN',
    'STCTPIG-VN',
    'STCTPMNF-VN',
    'STCACP-VN',
    'STCAMP-VN',
    'STCAPL-VN',
    'STCBNS-VN',
    'STCFBTPTH',
    'STCGS-VN',
    'STCHVLIGT-VN',
    'STCHVLMNF-VN',
    'STCINC-VN',
    'STCMITPTH',
    'STCMT-VN',
    'STCNFC-VN',
    'STCRFW-VN',
    'STCSMC-VN',
    'STCSMS-VN',
    'STCTMTH',
    'STCBSBCCREAMXXLVN',
  'STCFHRCPINKVN', 
  'STCFHRCYELLOWVN',
  'STCFRSTBRSHVN',
  'STCFRSTBRSPNKVN',
  'STCHCBLUEVN',
  'STCHGGINGBLUVN',
  'STCHGGINGPNKVN',
  'STCHGGINGWHTVN',
  'STCHIPSEATTRQSVN',
  'STCMNBCREAMLVN',
  'STCMNBCREAMMVN',
  'STCMNBLACKXLVN',
  'STCNANOCRSTS/MVN',
  'STCPAACCREAM3XLVN',
  'STCPACBLACK3XLVN',
  'STCPACCREAMLVN',
  'STCPREGBELTCVN',
  'STCPREGBELTVN',
  'STCSPBMBLACKVN',
  'STCSPBXLBLACKVN',
  'STCWBPADVN','STCMACAV','STCMCBBLCK','STCMCBCRM'
  )
  */ AND atl.STATUS IN ('80', '99')
  AND dah.asnStatus IN ('99')
  GROUP BY atl.docNo,
           atl.docLineNo,
           atl.toCustomerId,
           atl.toSku,
           atl.toQty,
           atl.toQty_Each,
           atl.toUom,
           atl.addTime,
           atl.transactionTime,
           atl.toLotNum,
           atl.toId,
           atl.tomuid,
           atl.toLocation,
           atl.warehouseId,
           atl.tocustomerId,
           atl.transactionId,
           atl.editTime,
           dah.organizationId,
           dah.asnNo,
           dah.asnType,
           dah.asnReference1,
           dah.asnReference3,
           dah.asnReference1,
           dad.SkuDescr,
           bsm.tariffMasterId,
           bs.grossWeight,
           bs.cube,
           bs.sku_group1,
           bz.zoneDescr,
           bpdCS.packId,
           bpdPL.packId,
           bpdCS.qty,
           bpdPL.qty,
           ila.lotAtt04,
           ila.lotAtt07,
           t1.codeid,
           BT.codeid;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET order_done = 1;
  OPEN cur_orderno;
cur_order_loop:
  LOOP
    FETCH FROM cur_orderno INTO od_organizationId,
    od_asnReference1, od_asnReference3, od_skuDescr1, od_warehouseId,
    od_customerId, od_asnNo, od_asnLineNo, od_sku, od_qtyReceived, od_uom,
    od_qtyReceivedEach,
    od_qtyChargeEA,
    od_qtyChargeCS,
    od_qtyChargeIP,
    od_qtyChargePL,
    od_qtyChargeCBM,
    od_qtyChargeTotDO,
    od_qtyChargeTotLine,
    od_totalCube, od_addTime, od_editTime,
    od_transactionTime, od_lotNum, od_traceId, od_muid, od_toLocation,
    od_docType, od_docTypeDescr, od_packId, od_QtyPerCases, od_QtyPerPallet, od_sku_group1,
    od_grossWeight, od_cubeNya, od_tariffMasterId, od_zone, od_batch, od_lotAtt07, od_Billtranctg,
    od_qtyChargeNettWeight, od_qtyChargeGrossWeight, od_qtyChargeMetricTon, od_closetimetransaction, od_line_transaction;/*additional nettweight grossweight metric ton*/

    IF order_done = 1 THEN

      SET order_done = 0;
      LEAVE cur_order_loop;
    END IF;



    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = od_organizationId
        AND bs.warehouseId = od_warehouseId
        AND bs.docNo = od_asnNo
        AND bs.udf03 = od_line_transaction
        AND bs.chargeCategory = 'IB') THEN

    BLOCK2:
      BEGIN



        DECLARE cur_Tariff CURSOR FOR
        SELECT DISTINCT
          bsm.organizationId,
          bsm.warehouseId,
          bsm.CUSTOMERID,
          DAY(bth.billingdate) billingDate,
          btr.tariffId,
          btr.tariffLineNo,
          btr.tariffClassNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.docType,
          btd.udf05, -- sementara pengganti ratebase
          btr.ratePerUnit,
          btr.rate,
          btd.minAmount,
          btd.maxAmount,
          IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.udf04 billMode,
          locationCategory,
          btd.UDF05,
          btd.UDF06,
          btd.UDF07,
          btd.UDF08,
          IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
          CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
          IFNULL(classTo, 0),
          bth.contractNo,
          bth.tariffMasterId,
          btr.cost,
          btd.billingParty,
          -- btd.billingTranCategory,
          IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory
        FROM BAS_SKU_MULTIWAREHOUSE bsm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE bsm.organizationId = 'OJV_CML'
        AND bsm.warehouseId = IN_warehouseId
        AND bsm.customerId = IN_CustomerId
        AND bth.tariffMasterId = od_tariffMasterId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'IB'
        AND btd.docType = od_docType
        AND btr.rate > 0
        #AND IFNULL(DAY(bth.billingdate),0)!=0 
        ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
          R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
          R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY;
          IF tariff_done THEN
            SET tariff_done = FALSE;
            LEAVE getTariff;
          END IF;


          SELECT
            od_docType,
            R_docType,
            od_Billtranctg,
            R_BILLINGTRANCATEGORY,
            R_ratebase;


          IF (R_BILLINGDAY) = 31 THEN
            SET R_BILLINGDAY = DAY(LAST_DAY(CURDATE()));
          END IF;

          -- ADDING AKBAR RULE => JIKA BILLING CATEGORY TIDAK DI SETUP DI BILING SETUP, SKIP VALIDASI 07.03.2024

          IF R_BILLINGTRANCATEGORY IS NULL
            OR R_BILLINGTRANCATEGORY = '' THEN
            SET R_BILLINGTRANCATEGORY = od_Billtranctg;
          END IF;

          IF (LTRIM(RTRIM(od_docType)) = LTRIM(RTRIM(R_docType)))
            AND (LTRIM(RTRIM(od_Billtranctg)) = LTRIM(RTRIM(R_BILLINGTRANCATEGORY))) THEN
            -- CALCULATION
            -- UOM
            -- PALLET
            -- CUBIC
            -- M2
            -- CASE
            -- IP
            -- PIECES
            -- KG
            -- LITER
            -- DO
            -- HOUR
            -- MONTH


            --           SELECT  'check=>',R_ratebase,R_TARIFFID;


            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
            SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
            SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
            SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
            SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
            SET R_billsummaryId = '';


            IF (R_ratebase = 'CUBIC') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeCBM;
            ELSEIF (R_ratebase = 'M2') THEN
              SET R_RESULTQTYCHARGE = 0;
            ELSEIF (R_ratebase = 'IP') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeIP;
            ELSEIF (R_ratebase = 'KG') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'LITER') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'DO') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeTotDO;
            ELSEIF (R_ratebase = 'PALLET') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargePL;
            ELSEIF (R_ratebase = 'CASE') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeCS;
            ELSEIF (R_ratebase = 'QUANTITY') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeEA;
            ELSEIF (R_ratebase = 'NETWEIGHT') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeNettWeight;
            ELSEIF (R_ratebase = 'GW') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeGrossWeight;
            /*additional nettweight grossweight*/
            ELSEIF (R_ratebase = 'MT') THEN
              SET R_RESULTQTYCHARGE = od_qtyChargeMetricTon;
            END IF;



            --           SELECT 'check 2=>',R_RESULTQTYCHARGE;

            IF EXISTS (SELECT
                  1
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*')) THEN
              INSERT INTO BIL_SUMMARY_LOG
                SELECT
                  *
                FROM BIL_SUMMARY
                WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
              DELETE
                FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
                AND BillingToDate = R_BILLINGDATE
                AND ChargeCategory = R_CHARGECATEGORY
                AND chargeType = R_CHARGETYPE
                AND CustomerID = R_CUSTOMERID
                AND billTo = R_BILLTO
                AND rateBase = R_rateBase
                AND arNo IN ('*');
            END IF; -- EXIST BILLING SUMMARY
            #
            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;
            END IF;
            #
            SELECT
              R_billsummaryId;

            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                od_organizationId,
                od_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(od_closetimetransaction, '%Y-%m-%d'),
                DATE_FORMAT(od_closetimetransaction, '%Y-%m-%d'),
                od_customerId,
                od_sku,
                od_lotNum,
                od_traceId,
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                R_descrC,
                R_rateBase,
                R_rateperunit,
                od_qtyReceivedEach,
                od_uom,
                od_totalCube,
                od_grossWeight,
                R_rate,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit,
                (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                od_docType,
                od_asnNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                od_line_transaction udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                IN_USERID addWho,
                NOW() ADDTIME,
                IN_USERID editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                od_docType orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;






      END;

    END IF; -- END IF JIKA LINE DI BILSUMMARY SUDAH ADA ( AVOID DOUBLE)


  END LOOP cur_order_loop;
  CLOSE cur_orderno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_BILLFIXSTD`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_BILLFIXSTD ()
BEGIN


  ####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_fixAmmount decimal(24, 8);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  DECLARE od_organizationId varchar(255);
  DECLARE od_asnReference1 varchar(255);
  DECLARE od_asnReference3 varchar(255);
  DECLARE od_skuDescr1 varchar(255);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_asnNo varchar(255);
  DECLARE od_asnLineNo varchar(255);
  DECLARE od_sku varchar(255);
  DECLARE od_qtyReceived varchar(255);
  DECLARE od_uom varchar(255);
  DECLARE od_qtyReceivedEach varchar(255);
  DECLARE od_totalCube varchar(255);
  DECLARE od_addTime varchar(255);
  DECLARE od_editTime varchar(255);
  DECLARE od_transactionTime varchar(255);
  DECLARE od_lotNum varchar(255);
  DECLARE od_traceId varchar(255);
  DECLARE od_muid varchar(255);
  DECLARE od_toLocation varchar(255);
  DECLARE od_transactionId varchar(255);
  DECLARE od_docType varchar(255);
  DECLARE od_docTypeDescr varchar(255);
  DECLARE od_packId varchar(255);
  DECLARE od_QtyPerCases varchar(255);
  DECLARE od_QtyPerPallet varchar(255);
  DECLARE od_sku_group1 varchar(255);
  DECLARE od_grossWeight varchar(255);
  DECLARE od_cubeNya varchar(255);
  DECLARE od_tariffMasterId varchar(255);
  DECLARE od_zone varchar(255);
  DECLARE od_batch varchar(255);
  DECLARE od_lotAtt07 varchar(255);
  DECLARE od_RecType varchar(21);
  DECLARE od_Billtranctg varchar(21);
  DECLARE OUT_returnCode varchar(1000);
  DECLARE od_qtyChargeEA varchar(255);
  DECLARE od_qtyChargeCS varchar(255);
  DECLARE od_qtyChargeIP varchar(255);
  DECLARE od_qtyChargePL varchar(255);
  DECLARE od_qtyChargeCBM varchar(255);
  DECLARE od_qtyChargeTotDO varchar(255);
  DECLARE od_qtyChargeTotLine varchar(255);
  DECLARE od_qtyChargeNettWeight varchar(255); /*additional nettweight NettWeight by IT-ARI BUDIMAN 06.03.2024*/
  DECLARE od_qtyChargeGrossWeight varchar(255);/*additional nettweight grossweight by IT-ARI BUDIMAN 06.03.2024*/
  DECLARE od_qtyChargeMetricTon varchar(255);/*additional MetricTon by IT-ARI BUDIMAN 22.03.2024*/
  DECLARE od_closetimetransaction timestamp; /*additional close transaction by AKBAR */
  DECLARE od_line_transaction varchar(255); /*additional line id unique transaction 02.07.2024 */
  ####################################################################
  ##????
  DECLARE inventory_done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE order_done,
          attribute_done int DEFAULT 0;



  DECLARE cur_orderno CURSOR FOR
  -- --        SELECT DISTINCT bth.warehouseId, bc.customerId, btm.tariffMasterId
  -- --         FROM BIL_TARIFF_HEADER bth 
  -- --         INNER JOIN BIL_TARIFF_DETAILS btd ON bth.organizationId = btd.organizationId AND bth.warehouseId = btd.warehouseId AND bth.tariffId = btd.tariffId
  -- --         INNER JOIN BIL_TARIFF_MASTER btm ON bth.organizationId = btm.organizationId AND bth.tariffMasterId = btm.tariffMasterId
  -- --         INNER JOIN BAS_CUSTOMER bc ON btm.organizationId = bc.organizationId AND btm.Customerid = bc.customerId
  -- --         INNER JOIN BSM_WAREHOUSE bw ON bw.organizationId = bth.organizationId AND bw.warehouseId = bth.warehouseId
  -- --         WHERE btd.organizationId = 'OJV_CML'
  -- --         AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  -- --         AND bth.effectiveTo >= DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -1 DAY), '%Y-%m-%d')
  -- --         AND bc.customerType = 'OW'
  -- --         AND bc.activeFlag = 'Y'
  -- --         AND btd.chargeCategory = 'FX';


  SELECT
  DISTINCT
    bcm.warehouseId,
    bcm.customerId,
    bth.tariffMasterId
  FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
    INNER JOIN BAS_CUSTOMER bc
      ON bc.customerId = bcm.customerId
      AND bc.organizationId = bcm.organizationId
      AND bc.CustomerType = 'OW'
    INNER JOIN BIL_TARIFF_HEADER bth
      ON bth.organizationId = bcm.organizationId
      AND bth.tariffMasterId = bcm.tariffMasterId
    INNER JOIN BIL_TARIFF_MASTER btm
      ON bcm.organizationId = btm.organizationId
      AND bth.tariffMasterId = btm.tariffMasterId
      AND bc.customerId = btm.customerId
    INNER JOIN BIL_TARIFF_DETAILS btd
      ON btd.organizationId = bth.organizationId
      AND btd.tariffId = bth.tariffId
  WHERE bcm.organizationId = 'OJV_CML'
  --   AND bth.tariffMasterId = od_tariffMasterId 
  AND bc.activeFlag = 'Y'
  AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND btd.chargeCategory = 'FX'
  ORDER BY bcm.warehouseId;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET order_done = 1;
  OPEN cur_orderno;
cur_order_loop:
  LOOP
    FETCH FROM cur_orderno INTO od_warehouseId,
    od_customerId, od_tariffMasterId;

    IF order_done = 1 THEN

      SET order_done = 0;
      LEAVE cur_order_loop;
    END IF;



    IF NOT EXISTS (SELECT
          1
        FROM BIL_SUMMARY bs
        WHERE bs.organizationId = od_organizationId
        AND bs.warehouseId = od_warehouseId
        AND bs.customerId = od_customerId
        AND DATE(bs.billingFromDate) > CONCAT(YEAR(NOW()), '-', MONTH(NOW()), '-19')
        AND bs.chargeCategory = 'FX') THEN

    --  SELECT od_tariffMasterId;
    BLOCK2:
      BEGIN



        DECLARE cur_Tariff CURSOR FOR

        SELECT DISTINCT
          bcm.organizationId,
          bcm.warehouseId,
          bcm.customerId,
          DAY(STR_TO_DATE(CONCAT(YEAR(NOW()), '-', MONTH(NOW()), '-', bth.udf02), '%Y-%m-%d')) billingDate, -- change akbar 27-12-24 , correction fix date
          btd.tariffId,
          btd.tariffLineNo,
          btd.chargeCategory,
          btd.chargeType,
          btd.descrC,
          btd.ratebase,
          IF(btd.minAmount = '', 0, btd.minAmount) AS fixAmount,
          btd.minAmount,
          btd.UDF01 AS MaterialNo,
          btd.udf02 AS itemChargeCategory,
          btd.UDF05,
          btm.udf01 AS divisionCode,
          btd.UDF07,
          btd.UDF08,
          bth.contractNo,
          bth.tariffMasterId
        FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bcm.customerId
            AND bc.organizationId = bcm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bcm.organizationId
            AND bth.tariffMasterId = bcm.tariffMasterId
          INNER JOIN BIL_TARIFF_MASTER btm
            ON bcm.organizationId = btm.organizationId
            AND bth.tariffMasterId = btm.tariffMasterId
            AND bc.customerId = btm.customerId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
        WHERE bcm.organizationId = 'OJV_CML'
        AND bth.tariffMasterId = od_tariffMasterId
        AND bcm.Customerid = od_customerId
        AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
        AND btd.chargeCategory = 'FX'
        ORDER BY bcm.organizationId, bcm.customerId, btd.chargeCategory, btd.chargeType;

        DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

        SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
        #
        OPEN cur_Tariff;
      getTariff:
        LOOP
          FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC,
          R_ratebase, R_fixAmmount, R_minAmount, R_materialNo, R_itemChargeCategory, R_billMode, R_UDF06, R_UDF07, R_UDF08, R_CONTRACTNO, R_TARIFFMASTERID;
          IF tariff_done THEN
            SET tariff_done = FALSE;
            LEAVE getTariff;
          END IF;


          SELECT
            od_customerId;




          IF (1 = 1) THEN

            SET R_CURRENTDATE = NOW();

            SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', DAY(R_CURRENTDATE)), '%Y-%m-%d');

            SET R_billsummaryId = '';



            SET R_RESULTQTYCHARGE = R_fixAmmount;




            IF (R_billsummaryId = '') THEN
              SET @linenumber = 0;
              SET OUT_returnCode = '';
              CALL SPCOM_GetIDSequence_NEW('OJV_CML', '*', 'en', 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);

              IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                SET OUT_returnCode = '999#????????';
                LEAVE getTariff;
              END IF;



            END IF;



            INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
            , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
            , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
            , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
            , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
            , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
            , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
            , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
            , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
            , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
              SELECT
                'OJV_CML',
                od_warehouseId,
                CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
                DATE_FORMAT(R_CURRENTDATE, '%Y-%m-%d'),
                DATE_FORMAT(R_CURRENTDATE, '%Y-%m-%d'),
                od_customerId,
                od_sku,
                od_lotNum,
                od_traceId,
                R_TARIFFID,
                R_CHARGECATEGORY,
                R_chargetype,
                R_descrC,
                R_rateBase,
                R_rateperunit,
                od_qtyReceivedEach,
                od_uom,
                od_totalCube,
                od_grossWeight,
                R_rate,
                R_RESULTQTYCHARGE,
                R_RESULTQTYCHARGE,
                0,
                R_cost * R_RESULTQTYCHARGE,
                0,
                NOW() confirmTime,
                '' confirmWho,
                od_docType,
                od_asnNo,
                '' createTransactionid,
                '' notes,
                NOW() ediSendTime,
                R_BILLTO billTo,
                NOW() settleTime,
                '' settleWho,
                '' followUp,
                '' invoiceType,
                '' paidTo,
                '' costConfirmFlag,
                NOW() costConfirmTime,
                '' costConfirmWho,
                '' costSettleFlag,
                NOW() costSettleTime,
                '' costSettleWho,
                0 incomeTaxRate,
                0 costTaxRate,
                R_INCOMETAX incomeTax,
                0 cosTax,
                R_RESULTQTYCHARGE * R_rate / R_rateperunit incomeWithoutTax,
                0 cosWithoutTax,
                '' costInvoiceType,
                '' noteText,
                R_materialNo AS udf01,
                R_itemChargeCategory AS udf02,
                od_line_transaction udf03,
                R_UDF06 udf04,
                '' udf05,
                0 currentVersion,
                '2020' oprSeqFlag,
                'CUSTOMBILL' addWho,
                NOW() ADDTIME,
                'CUSTOMBILL' editWho,
                NOW() editTime,
                R_LOCATIONCAT locationCategory,
                '' manual,
                0 lineCount,
                '*' arNo,
                0 arLineNo,
                '*' apNo,
                0 apLineNo,
                'N' ediSendFlag,
                '' ediErrorCode,
                '' ediErrorMessage,
                NOW() ediSendTime2,
                'N' ediSendFlag2,
                '' ediErrorCode2,
                '' ediErrorMessage2,
                '' billingTranCategory,
                od_docType orderType,
                '' containerType,
                '' containerSize;

          END IF; -- END IF docType

        END LOOP getTariff;
        CLOSE cur_Tariff;






      END;

    END IF; -- END IF JIKA LINE DI BILSUMMARY SUDAH ADA ( AVOID DOUBLE)


  END LOOP cur_order_loop;
  CLOSE cur_orderno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_BILLFIXCHG`
--
CREATE
DEFINER = 'root'@'%'
PROCEDURE CML_BILLFIXCHG (IN IN_organizationId varchar(30),/*AB 06/12/24*/
IN IN_warehouseId varchar(30),
IN IN_CustomerId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_fixAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;
  DECLARE R_PALLETCNT varchar(30);
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF05 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  DECLARE OUT_returnCode varchar(1000);
  ####################################################################
  DECLARE od_organizationId varchar(20);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_tariffMasterId varchar(255);
  DECLARE od_tariffId varchar(50);
  DECLARE od_chargeType varchar(255);
  DECLARE od_fixAmount varchar(255);
  DECLARE od_incomeTaxRate varchar(20);
  DECLARE od_ratebase varchar(255);
  DECLARE od_udf02 varchar(255);
  DECLARE od_tariffLineNo varchar(255);
  DECLARE tariff_done int DEFAULT FALSE;
  DECLARE bil_done,
          attribute_done boolean DEFAULT FALSE;
  DECLARE cur_bilno CURSOR FOR
  SELECT DISTINCT
    c1.organizationId,
    c1.warehouseId,
    c1.customerId,
    c1.tariffMasterId,
    IFNULL(b.tariffId, '*'),
    a.chargeType,
    -- a.fixAmount, /*chage from minAmount to fixAmount AB 24/04/25*/    ==> tidak ada kolom fixAmount    error 1 Unknown column 'a.fixAmount' in 'field list' SQL2.sql 20 1 
    a.udf03, -- back to udf03 AKB 25/04/2025
    a.incomeTaxRate,
    a.rateBase,
    CASE WHEN b.udf02 = ' ' THEN DAY(b.billingDate) ELSE b.udf02 END AS udf02,
    a.tariffLineNo
  FROM BAS_CUSTOMER_MULTIWAREHOUSE c1
    LEFT JOIN BIL_TARIFF_HEADER b
      ON b.organizationId = c1.organizationId
      AND b.tariffMasterId = c1.tariffMasterId
    LEFT JOIN BIL_TARIFF_DETAILS a
      ON a.organizationId = b.organizationId
      AND a.tariffId = b.tariffId
  WHERE IFNULL(b.tariffId, '*') <> '*'
  AND c1.organizationId = IN_organizationId
  AND c1.customerId = IN_CustomerId
  AND c1.warehouseId = IN_warehouseId
  AND a.chargeCategory = 'FX';
  /*  AND TIMESTAMPDIFF(SECOND, b.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, b.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;*/
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET bil_done = TRUE;
  OPEN cur_bilno;
cur_bil_loop:
  LOOP
    FETCH FROM cur_bilno INTO od_organizationId,
    od_warehouseId,
    od_customerId,
    od_tariffMasterId,
    od_tariffId,
    od_chargeType,
    od_fixAmount,
    od_incomeTaxRate,
    od_ratebase,
    od_udf02,
    od_tariffLineNo;

    SELECT
      od_organizationId;
    IF bil_done THEN
      SET bil_done = FALSE;
      LEAVE cur_bil_loop;
    END IF;
  BLOCK2:
    BEGIN
      DECLARE cur_Tariff CURSOR FOR
      SELECT DISTINCT
        bcm.organizationId,
        bcm.warehouseId,
        bcm.customerId,
        DAY(STR_TO_DATE(CONCAT(YEAR(NOW()), '-', MONTH(NOW()), '-', bth.udf02), '%Y-%m-%d')) billingDate, -- change akbar 27-12-24 , correction fix date
        btd.tariffId,
        btd.tariffLineNo,
        btd.chargeCategory,
        btd.chargeType,
        btd.descrC,
        btd.ratebase,
        IF(btd.UDF03 = '', 0, btd.UDF03) AS fixAmount,
        btd.minAmount,
        btd.UDF01 AS MaterialNo,
        btd.udf02 AS itemChargeCategory,
        btd.UDF05,
        btd.UDF06 AS divisionCode,
        btd.UDF07,
        btd.UDF08,
        bth.contractNo,
        bth.tariffMasterId
      FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
        INNER JOIN BAS_CUSTOMER bc
          ON bc.customerId = bcm.customerId
          AND bc.organizationId = bcm.organizationId
          AND bc.CustomerType = 'OW'
        INNER JOIN BIL_TARIFF_HEADER bth
          ON bth.organizationId = bcm.organizationId
          AND bth.tariffMasterId = bcm.tariffMasterId
        INNER JOIN BIL_TARIFF_DETAILS btd
          ON btd.organizationId = bth.organizationId
          AND btd.tariffId = bth.tariffId
      WHERE bcm.organizationId = 'OJV_CML'
      AND bcm.warehouseId = IN_warehouseId
      AND bcm.customerId = IN_CustomerId
      AND bth.tariffMasterId = od_tariffMasterId
      AND bth.tariffId = od_tariffId
      AND btd.tariffLineNo = od_tariffLineNo
      AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND btd.chargeCategory = 'FX'
      ORDER BY bcm.organizationId, bcm.customerId, btd.chargeCategory, btd.chargeType;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = TRUE;
      ####################################################################
      SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
      #
      OPEN cur_Tariff;
    getTariff:
      LOOP
        FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC,
        R_ratebase, R_fixAmount, R_minAmount, R_materialNo, R_itemChargeCategory, R_UDF05, R_UDF06, R_UDF07, R_UDF08, R_CONTRACTNO, R_TARIFFMASTERID;
        IF tariff_done THEN
          SET tariff_done = FALSE;
          LEAVE getTariff;
        END IF;
        SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
        SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
        SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
        SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH);
        SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
        SET R_billsummaryId = '';
        --  Di remark karena gk ada fungsi -- AKB 28.4.25
        --         SELECT R_ratebase;
        --         IF (R_ratebase = 'DAY') THEN
        --           SET R_RESULTQTYCHARGE = od_fixAmount;
        --         ELSEIF (R_ratebase = 'MONTH') THEN
        --           SET R_RESULTQTYCHARGE = od_fixAmount;

        --        END IF;
        SELECT
          'check=>',
          R_RESULTQTYCHARGE,
          R_TARIFFID;
        IF EXISTS (SELECT
              1
            FROM BIL_SUMMARY
            WHERE billingFromDate = R_BILLINGDATE
            AND BillingToDate = R_BILLINGDATE
            AND ChargeCategory = R_CHARGECATEGORY
            AND chargeType = R_CHARGETYPE
            AND CustomerID = R_CUSTOMERID
            AND billTo = R_BILLTO
            AND rateBase = R_rateBase
            AND arNo IN ('*')) THEN
          SELECT
            '1';
          INSERT INTO BIL_SUMMARY_LOG
            SELECT
              *
            FROM BIL_SUMMARY
            WHERE billingFromDate = R_BILLINGDATE
            AND BillingToDate = R_BILLINGDATE
            AND ChargeCategory = R_CHARGECATEGORY
            AND chargeType = R_CHARGETYPE
            AND CustomerID = R_CUSTOMERID
            AND billTo = R_BILLTO
            AND rateBase = R_rateBase
            AND arNo IN ('*');
          DELETE
            FROM BIL_SUMMARY
          WHERE billingFromDate = R_BILLINGDATE
            AND BillingToDate = R_BILLINGDATE
            AND ChargeCategory = R_CHARGECATEGORY
            AND chargeType = R_CHARGETYPE
            AND CustomerID = R_CUSTOMERID
            AND billTo = R_BILLTO
            AND rateBase = R_rateBase
            AND arNo IN ('*');
        END IF;
        #
        IF (R_billsummaryId = '') THEN
          SET @linenumber = 0;
          SET OUT_returnCode = '*_*';
          CALL SPCOM_GetIDSequence_NEW('OJV_CML', '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);
          IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
            SET OUT_returnCode = '999#????????';
            LEAVE getTariff;
          END IF;
        END IF;

        -- debug 
        IF R_BILLINGDATE IS NULL THEN
          SELECT
            od_warehouseId,
            od_customerId,
            od_tariffMasterId;
        END IF;

        INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
        , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
        , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
        , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
        , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
        , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
        , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
        , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
        , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
        , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
          SELECT
            od_organizationId,
            od_warehouseId,
            CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
            R_BILLINGDATE,
            R_BILLINGDATE,
            od_customerId,
            '' sku,
            '' lotNum,
            '' traceId,
            R_TARIFFID,
            R_CHARGECATEGORY,
            R_chargetype,
            R_descrC,
            R_rateBase,
            1,
            1,
            '' uom,
            0 cubic,
            0 grossWeight,
            od_fixAmount,
            od_fixAmount,
            od_fixAmount,
            0,
            R_RESULTQTYCHARGE,
            0,
            NOW() confirmTime,
            '' confirmWho,
            'FX',
            '' docNo,
            '' createTransactionid,
            '' notes,
            NOW() ediSendTime,
            od_customerId billTo,
            NOW() settleTime,
            '' settleWho,
            '' followUp,
            '' invoiceType,
            '' paidTo,
            '' costConfirmFlag,
            NOW() costConfirmTime,
            '' costConfirmWho,
            '' costSettleFlag,
            NOW() costSettleTime,
            '' costSettleWho,
            0 incomeTaxRate,
            0 costTaxRate,
            R_INCOMETAX incomeTax,
            0 cosTax,
            R_RESULTQTYCHARGE * R_rateperunit incomeWithoutTax,
            0 cosWithoutTax,
            '' costInvoiceType,
            '' noteText,
            R_materialNo AS udf01,
            R_itemChargeCategory AS udf02,
            '' udf03,
            R_UDF06 udf04,
            '' udf05,
            0 currentVersion,
            '2020' oprSeqFlag,
            IN_USERID addWho,
            NOW() ADDTIME,
            IN_USERID editWho,
            NOW() editTime,
            '' locationCategory,
            '' manual,
            0 lineCount,
            '*' arNo,
            0 arLineNo,
            '*' apNo,
            0 apLineNo,
            'N' ediSendFlag,
            '' ediErrorCode,
            '' ediErrorMessage,
            NOW() ediSendTime2,
            'N' ediSendFlag2,
            '' ediErrorCode2,
            '' ediErrorMessage2,
            '' billingTranCategory,
            '' orderType,
            '' containerType,
            '' containerSize;
      END LOOP getTariff;
      CLOSE cur_Tariff;
    END;
  END LOOP cur_bil_loop;
  CLOSE cur_bilno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_EXECUTE_BILLFIX`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_EXECUTE_BILLFIX ()
BEGIN
  DECLARE done int DEFAULT FALSE;
  DECLARE v_warehouseId varchar(255);
  DECLARE v_customerId varchar(255);
  DECLARE v_tariffMasterId varchar(255);

  DECLARE cur CURSOR FOR
  SELECT DISTINCT
    bth.warehouseId,
    bc.customerId,
    btm.tariffMasterId
  FROM BIL_TARIFF_HEADER bth
    INNER JOIN BIL_TARIFF_DETAILS btd
      ON bth.organizationId = btd.organizationId
      AND bth.warehouseId = btd.warehouseId
      AND bth.tariffId = btd.tariffId
    INNER JOIN BIL_TARIFF_MASTER btm
      ON bth.organizationId = btm.organizationId
      AND bth.tariffMasterId = btm.tariffMasterId
    INNER JOIN BAS_CUSTOMER bc
      ON btm.organizationId = bc.organizationId
      AND btm.Customerid = bc.customerId
    INNER JOIN BSM_WAREHOUSE bw
      ON bw.organizationId = bth.organizationId
      AND bw.warehouseId = bth.warehouseId
  WHERE btd.organizationId = 'OJV_CML'
  AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND bth.effectiveTo >= DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL -1 DAY), '%Y-%m-%d')
  AND bc.customerType = 'OW'
  AND bc.activeFlag = 'Y'
  AND btd.chargeCategory = 'FX';
  --         AND bc.customerId NOT IN (
  --         SELECT DISTINCT customerId FROM BIL_SUMMARY
  -- WHERE organizationId='OJV_CML'
  -- AND chargeCategory='FX'
  -- AND date(addTime) >= '2025-03-17'
  -- AND date(addTime) <= '2025-03-28') AND bc.customerId NOT IN ('PT.ITT_MDN');

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  OPEN cur;

read_loop:
  LOOP
    FETCH cur INTO v_warehouseId, v_customerId, v_tariffMasterId;
    IF done THEN
      LEAVE read_loop;
    END IF;

    SELECT
      v_warehouseId,
      v_customerId,
      v_tariffMasterId;

    SET @IN_organizationId = 'OJV_CML';
    SET @IN_warehouseId = v_warehouseId;
    SET @IN_CustomerId = v_customerId;
    SET @IN_USERID = 'CUSTOMBILL';
    SET @IN_Language = 'en';
    SET @IN_tariffMaster = v_tariffMasterId;
    CALL CML_BILLFIXCHG(@IN_organizationId, @IN_warehouseId, @IN_CustomerId, @IN_USERID, @IN_Language, @IN_tariffMaster);


  END LOOP;

  CLOSE cur;
END
$$

--
-- Create procedure `CML_BILLASNVASSTD`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLASNVASSTD (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN


  #####################################################################
  ##????
  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(20);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);
  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);
  DECLARE R_ratebase varchar(20);
  DECLARE R_docType varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);
  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);
  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_RESULTQTYCHARGE decimal(24, 8);  -- add for calculation
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLINGTRANCATEGORY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_VASTYPE varchar(30);
  DECLARE R_NROW integer;
  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_Cub decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCub decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';
  DECLARE R_UDF08 varchar(500);
  DECLARE R_UDF07 varchar(500);
  DECLARE R_Days int(11) DEFAULT NULL;
  ####################################################################
  DECLARE od_organizationId varchar(255);
  DECLARE od_asnReference1 varchar(255);
  DECLARE od_skuDescr1 varchar(255);
  DECLARE od_warehouseId varchar(255);
  DECLARE od_customerId varchar(255);
  DECLARE od_asnNo varchar(255);
  DECLARE od_asnLineNo varchar(255);
  DECLARE od_sku varchar(255);
  DECLARE od_qtyReceived varchar(255);
  DECLARE od_uom varchar(255);
  DECLARE od_qtyReceivedEach varchar(255);
  DECLARE od_totalCube varchar(255);
  DECLARE od_vasType varchar(255);
  DECLARE od_qtyCharge varchar(255);
  DECLARE od_tarifMaster varchar(255);
  DECLARE OUT_returnCode varchar(1000);
  DECLARE od_closetime timestamp;

  ####################################################################
  ##????
  DECLARE inventory_done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE order_done,
          attribute_done int DEFAULT 0;



  DECLARE cur_orderno CURSOR FOR
  SELECT
    IFNULL(CAST(dah.organizationId AS char(255)), '') AS organizationId,
    IFNULL(CAST(dah.warehouseId AS char(255)), '') AS warehouseId,
    IFNULL(CAST(dah.customerId AS char(255)), '') AS customerId,
    IFNULL(CAST(dah.asnNo AS char(255)), '') AS asnNo,
    IFNULL(CAST(dah.asnReference1 AS char(255)), '') AS asnReference1,
    IFNULL(CAST(dad.sku AS char(255)), '') AS sku,
    IFNULL(CAST(bs.skuDescr1 AS char(255)), '') AS skuDescr1,
    vsasn.asnLineNo AS asnLineNo,
    IFNULL(CAST(vsasn.vasType AS char(255)), '') AS vasType,
    IFNULL(CAST(vsasn.vasqty AS char(255)), '') AS qtyCharge,
    IFNULL(CAST(vsasn.packUom AS char(255)), '') AS packUom,
    IFNULL(CAST(bsm.tariffMasterId AS char(255)), '') AS tarifMaster,
    dahu.closeTime
  FROM DOC_ASN_HEADER dah
    LEFT OUTER JOIN DOC_ASN_VAS vsasn
      ON dah.organizationId = vsasn.organizationId
      AND dah.warehouseId = vsasn.warehouseId
      AND dah.asnNo = vsasn.asnNo
    LEFT OUTER JOIN DOC_ASN_DETAILS dad
      ON dad.organizationId = vsasn.organizationId
      AND dad.warehouseId = vsasn.warehouseId
      AND dad.asnNo = vsasn.asnNo
      AND dad.asnLineNo = vsasn.asnLineNo
    LEFT OUTER JOIN BAS_SKU bs
      ON bs.organizationId = dad.organizationId
      AND bs.customerId = dad.customerId
      AND bs.SKU = dad.sku
    LEFT OUTER JOIN BAS_SKU_MULTIWAREHOUSE bsm
      ON bsm.organizationId = dah.organizationId
      AND bsm.warehouseId = dah.warehouseId
      AND bsm.customerId = dah.customerId
      AND bsm.SKU = dad.Sku
    LEFT JOIN DOC_ASN_HEADER_UDF dahu
      ON dah.organizationId = dahu.organizationId
      AND dah.warehouseId = dahu.warehouseId
      AND dah.asnNo = dahu.asnNo
  WHERE vsasn.warehouseId = IN_warehouseId
  AND dah.customerId = IN_CustomerId
  AND dah.asnNo = IN_trans_no
  -- AND bsm.tariffMasterId = 'BIL00418'
  AND dah.asnType NOT IN ('FREE')
  AND dah.asnStatus IN ('99')
  GROUP BY dah.organizationId,
           dah.warehouseId,
           dah.asnNo,
           dah.asnReference1,
           dad.sku,
           bs.skuDescr1,
           vsasn.asnLineNo,
           vsasn.vasType,
           vsasn.packUom;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET order_done = 1;
  OPEN cur_orderno;
cur_order_loop:
  LOOP
    FETCH FROM cur_orderno INTO od_organizationId,
    od_warehouseId,
    od_customerId,
    od_asnNo,
    od_asnReference1,
    od_sku,
    od_skuDescr1,
    od_asnLineNo,
    od_vasType,
    od_qtyCharge,
    od_uom,
    od_tarifMaster, od_closetime;

    IF order_done = 1 THEN

      SET order_done = 0;
      LEAVE cur_order_loop;
    END IF;

    SELECT
      CONCAT('** DEBUG:', od_asnNo, od_vasType, od_tarifMaster) AS debug;

  BLOCK2:
    BEGIN
      --  IF (od_tariffMasterId <> '') THEN

      DECLARE cur_Tariff CURSOR FOR
      SELECT DISTINCT
        bsm.organizationId,
        bsm.warehouseId,
        bsm.CUSTOMERID,
        DAY(bth.billingdate) billingDate,
        btr.tariffId,
        btr.tariffLineNo,
        btr.tariffClassNo,
        btd.chargeCategory,
        btd.chargeType,
        btd.descrC,
        btd.docType,
        btd.ratebase,
        btr.ratePerUnit,
        btr.rate,
        btd.minAmount,
        btd.maxAmount,
        IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
        btd.UDF01 AS MaterialNo,
        btd.udf02 AS itemChargeCategory,
        btd.udf04 billMode,
        locationCategory,
        btd.UDF05,
        btd.UDF06,
        btd.UDF07,
        btd.UDF08,
        IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
        CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END,
        IFNULL(classTo, 0),
        bth.contractNo,
        bth.tariffMasterId,
        btr.cost,
        btd.billingParty,
        -- btd.billingTranCategory,
        IFNULL(CAST(btd.billingTranCategory AS char(10)), '') AS billingTranCategory,
        btd.vasType
      FROM BAS_SKU_MULTIWAREHOUSE bsm
        INNER JOIN BAS_CUSTOMER bc
          ON bc.customerId = bsm.customerId
          AND bc.organizationId = bsm.organizationId
          AND bc.CustomerType = 'OW'
        INNER JOIN BIL_TARIFF_HEADER bth
          ON bth.organizationId = bsm.organizationId
          AND bth.tariffMasterId = bsm.tariffMasterId
        INNER JOIN BIL_TARIFF_DETAILS btd
          ON btd.organizationId = bth.organizationId
          AND btd.tariffId = bth.tariffId
        INNER JOIN BIL_TARIFF_RATE btr
          ON btr.organizationId = btd.organizationId
          AND btr.tariffId = btd.tariffId
          AND btr.tariffLineNo = btd.tariffLineNo
      WHERE bsm.organizationId = 'OJV_CML'
      AND bsm.warehouseId = IN_warehouseId
      AND bsm.customerId = IN_CustomerId
      AND bth.tariffMasterId = od_tarifMaster
      AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND btd.chargeCategory = 'VA'
      AND btd.tariffLineNo <= 100
      --       AND btd.docType IN (SELECT
      --           dah.asnType
      --         FROM DOC_ASN_HEADER dah
      --         WHERE dah.asnNo = IN_trans_no)
      AND btr.rate > 0
      AND btd.vasType = od_vasType
      #AND IFNULL(DAY(bth.billingdate),0)!=0 
      ORDER BY bsm.organizationId, bsm.customerId, btr.tariffId, btr.tariffLineNo, btr.tariffClassNo;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

      SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd
      #
      OPEN cur_Tariff;
    getTariff:
      LOOP
        FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC, R_docType,
        R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06, R_UDF07, R_UDF08,
        R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY, R_BILLINGTRANCATEGORY, R_VASTYPE;
        IF tariff_done THEN
          SET tariff_done = FALSE;
          LEAVE getTariff;
        END IF;


        SELECT
          UPPER(R_VASTYPE),
          UPPER(od_vasType),
          R_docType;

        IF (UPPER(R_VASTYPE) = UPPER(od_vasType)) THEN
          -- CALCULATION
          -- UOM
          -- PALLET
          -- CUBIC
          -- M2
          -- CASE
          -- IP
          -- PIECES
          -- KG
          -- LITER
          -- DO
          -- HOUR
          -- MONTH



          SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');
          SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
          SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
          SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
          SET R_Days = DATEDIFF(R_TODATE, R_FMDATE) + 1;
          SET R_billsummaryId = '';


          SET R_RESULTQTYCHARGE = od_qtyCharge;






          IF EXISTS (SELECT
                1
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*')) THEN
            INSERT INTO BIL_SUMMARY_LOG
              SELECT
                *
              FROM BIL_SUMMARY
              WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
            DELETE
              FROM BIL_SUMMARY
            WHERE billingFromDate = R_BILLINGDATE
              AND BillingToDate = R_BILLINGDATE
              AND ChargeCategory = R_CHARGECATEGORY
              AND chargeType = R_CHARGETYPE
              AND CustomerID = R_CUSTOMERID
              AND billTo = R_BILLTO
              AND rateBase = R_rateBase
              AND arNo IN ('*');
          END IF; -- EXIST BILLING SUMMARY
          #
          IF (R_billsummaryId = '') THEN
            SET @linenumber = 0;
            SET OUT_returnCode = '*_*';
            CALL SPCOM_GetIDSequence_NEW(R_ORGANIZATIONID, '*', IN_Language, 'BILLINGSUMMARYIDCUST', R_billsummaryId, OUT_returnCode);
            IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
              SET OUT_returnCode = '999#????????';
              LEAVE getTariff;
            END IF;
          END IF;
          #


          INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
          , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
          , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
          , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
          , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
          , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
          , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
          , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
          , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
          , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
            SELECT
              od_organizationId,
              od_warehouseId,
              CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
              DATE_FORMAT(od_closetime, '%Y-%m-%d'),
              DATE_FORMAT(od_closetime, '%Y-%m-%d'),
              od_customerId,
              od_sku,
              '',
              '',
              R_TARIFFID,
              R_CHARGECATEGORY,
              R_chargetype,
              R_descrC,
              R_rateBase,
              R_rateperunit,
              od_qtyCharge,
              od_uom,
              '0',
              '0',
              R_rate,
              R_RESULTQTYCHARGE * R_rate / R_rateperunit,
              (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) + (R_RESULTQTYCHARGE * (R_rate / R_rateperunit)) * R_INCOMETAX,
              0,
              R_cost * R_RESULTQTYCHARGE,
              0,
              NULL confirmTime,
              '' confirmWho,
              'ASN' dockType,
              od_asnNo,
              '' createTransactionid,
              R_CHARGETYPE notes,
              NULL ediSendTime,
              R_BILLTO billTo,
              NULL settleTime,
              '' settleWho,
              '' followUp,
              '' invoiceType,
              '' paidTo,
              '' costConfirmFlag,
              NULL costConfirmTime,
              '' costConfirmWho,
              '' costSettleFlag,
              NULL costSettleTime,
              '' costSettleWho,
              NULL incomeTaxRate,
              0 costTaxRate,
              NULL incomeTax,
              0 cosTax,
              NULL incomeWithoutTax,
              NULL cosWithoutTax,
              '' costInvoiceType,
              '' noteText,
              R_materialNo AS udf01,
              R_itemChargeCategory AS udf02,
              R_UDF08 udf03,
              R_UDF06 udf04,
              NULL udf05,
              0 currentVersion,
              '2020' oprSeqFlag,
              IN_USERID addWho,
              NOW() ADDTIME,
              IN_USERID editWho,
              NOW() editTime,
              R_LOCATIONCAT locationCategory,
              '' manual,
              0 lineCount,
              '*' arNo,
              0 arLineNo,
              '*' apNo,
              0 apLineNo,
              'N' ediSendFlag,
              '' ediErrorCode,
              '' ediErrorMessage,
              NULL ediSendTime2,
              'N' ediSendFlag2,
              '' ediErrorCode2,
              '' ediErrorMessage2,
              '' billingTranCategory,
              '' orderType,
              '' containerType,
              '' containerSize;

        END IF; -- END IF docType

      END LOOP getTariff;
      CLOSE cur_Tariff;


    --  END IF; 
    --  END IF TARIFF ORDER KOSONG
    END;




  END LOOP cur_order_loop;
  CLOSE cur_orderno;
  SET OUT_returnCode = '000';
END
$$

--
-- Create procedure `CML_APPT_GET_TICKET`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_APPT_GET_TICKET (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_arrivalNo varchar(30),
INOUT OUT_ticketNo varchar(1000),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE OUT_ReturnNo varchar(40);
    DECLARE R_CurrentTime timestamp;
    DECLARE r_Count int;
    DECLARE r_Count_Status int; -- add for validation ignored entrance 17.05.2024
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_APPT_GET_TICKET', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_arrivalNo;
    END;
    IF IFNULL(IN_arrivalNo, '') != '' THEN
      SET OUT_returnCode = '000';
      SET OUT_ticketNo = '000';

      -- add for validation ignored entrance 17.05.2024

      SELECT
        COUNT(1)
      FROM DOC_ARRIVAL_HEADER dah
      WHERE dah.organizationId = IN_organizationId
      AND dah.warehouseId = IN_warehouseId
      AND dah.arrivalNo = IN_arrivalNo
      AND dah.arrivalStatus = '00' INTO r_Count_Status;
      IF r_Count_Status > 0 THEN
        SET OUT_returnCode = 'Please set status to Entrance!';
        LEAVE ENDPROC;
      END IF;


      SELECT
        COUNT(1)
      FROM DOC_ARRIVAL_PASSID
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND arrivalNo = IN_arrivalNo INTO r_Count;

      IF r_Count > 0 THEN
        SET OUT_returnCode = 'Ticket Has Already Been Issued';
        LEAVE ENDPROC;
      END IF;

      START TRANSACTION;
        SET OUT_Return_Code = '*_*';
        SET R_CurrentTime = NOW();
        CALL SPCOM_GetIDSequence_NEW(IN_organizationId, In_warehouseID, IN_languageId, 'TICKETNO', OUT_ReturnNo, OUT_Return_Code);

        IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;

        SET OUT_ticketNo = OUT_ReturnNo;


        INSERT INTO DOC_ARRIVAL_PASSID (organizationId, warehouseId, arrivalNo, cardSerialNo, cardId, issueTime, udf01, addWho, addTime, editWho, editTime)
          VALUES (IN_organizationId, IN_warehouseId, IN_arrivalNo, OUT_ticketNo, OUT_ticketNo, R_CurrentTime, 'N', IN_userId, R_CurrentTime, IN_userId, R_CurrentTime);
      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `CML_COUNT_STORAGE_DAYS`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_STORAGE_DAYS (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    zib4.StockDate,
    CASE WHEN zib4.customerId = 'GMC' AND
        zib4.warehouseId = 'CBT01' THEN SUM(zib4.qtyCharge_TraceId) - 100 ELSE SUM(zib4.qtyCharge_TraceId) END AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    SUM(zib4.qty) AS qty,
    SUM(zib4.qtycbm) AS qtycbm,
    zib4.Storage_Type,
    'STRG' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib1.locationId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib1.muid) AS qtyCharge_MUID,
      SUM(zib1.qty) AS qty,
      SUM(zib1.qty_cbm) AS qtycbm,
      zib1.Storage_Type
    FROM (SELECT
      DISTINCT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.sku AS SKU,
        zib.SKUDesc AS SKUDesc,
        zib.UOM AS UOM,
        SUM(zib.qtyonHand) AS qtyonHand,
        zib.muid AS muid,
        zib.traceId AS traceId,
        zib.lotNum AS lotNum,
        zib.packkey AS packkey,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        zib.locationCategory AS locationCategory,
        ila.lotAtt04 AS batch,
        ila.lotAtt11 AS owner,
        ila.lotAtt07 AS lotAtt07,
        CASE WHEN zib.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd.uomdescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomdescr = 'LT' THEN zib.qtyOnHand ELSE (
                  zib.qtyOnHand * bs.netweight) END) WHEN zib.customerId IN ('MDS') THEN (CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand ELSE (zib.qtyOnHand) * bs.sku_group6 END) WHEN zib.customerId IN ('PACIFICPAINT') THEN (zib.qtyOnHand * bs.grossweight) WHEN zib.customerId IN ('GCM') THEN (CASE WHEN bpd.uomDescr = 'ZK' THEN zib.qtyOnHand * bs.grossweight WHEN bpd.uomDescr = 'EA' THEN zib.qtyOnHand * bs.grossweight ELSE (zib.qtyOnHand) END) WHEN zib.customerId IN ('TUMI') THEN (zib.qtyOnHand) WHEN zib.customerId IN ('BMM_JKT') THEN (zib.qtyOnHand / 1000) WHEN zib.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'LT' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'L' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'G' THEN zib.qtyOnHand / 1000 WHEN
                  bpd.uomDescr = 'MT' THEN zib.qtyOnHand * 1000 ELSE (
                  zib.qtyOnHand * bs.grossweight) END) WHEN
            zib.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'PC' THEN (zib.qtyOnHand * (CAST((
                    CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN bs.sku_group6 IS NULL THEN 0 ELSE bs.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'EA' THEN (zib.qtyOnHand * (CAST((CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN
                        bs.sku_group6 IS
                        NULL THEN 0 ELSE bs.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib.qtyOnHand END) WHEN zib.customerId = 'TMB_SMG' THEN (zib.qtyOnHand) WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib.qtyOnHand) ELSE (zib.qtyOnHand) END AS qty,
        -- case when zib.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm.packId LIKE '1/%' THEN ROUND(zib.qtyonHand * bs.`cube`, 6) ELSE ROUND(zib.qtyonHand * (bs.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E08%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E09%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib.customerId = 'MAPCLUB' THEN (CASE WHEN zib.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) WHEN zib.customerid = 'PPG' THEN (CASE WHEN zib.locationId LIKE 'C%' THEN 'WH-C' ELSE 'NON WH-C' END) WHEN zib.customerId IN ('DNN_MDN') THEN (CASE WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10215338' THEN 'PREFORM 1500' WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10215336' THEN 'PREFORM 600' WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10425007' THEN 'CAPSHIELD' ELSE 'RESIN' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --				AND CONVERT(zib.StockDate, DATE) between '2025-05-01' and '2025-06-30'
      AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND bl.workingArea NOT IN ('LTL-BULK')
      -- and zib.locationId not like 'K%'
      -- and ila.lotAtt11 is not null
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.SKU,
               zib.SKUDesc,
               zib.qtyonHand,
               zib.UOM,
               zib.muid,
               zib.traceId,
               zib.lotNum,
               zib.packkey,
               zib.StockDate,
               ila.lotAtt04,
               ila.lotAtt11,
               ila.lotAtt07,
               zib.locationId,
               zib.locationCategory,
               bsm.tariffMasterId,
               bs.sku_group6
      ORDER BY StockDate,
      locationId ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseId = IN_WarehouseId
    AND DATE(zib1.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --		    and CONVERT(zib1.StockDate, DATE) between '2025-05-01' and '2025-06-30'
    AND zib1.locationCategory IN ('SD', 'DD', 'GR')
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.Storage_Type
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib3.traceId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib3.muid) AS qtyCharge_MUID,
      SUM(zib3.qty) AS qty,
      SUM(zib3.qty_cbm) AS qtycbm,
      zib3.Storage_Type
    FROM (SELECT
      DISTINCT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.sku AS SKU,
        zib2.SKUDesc AS SKUDesc,
        zib2.UOM AS UOM,
        SUM(zib2.qtyonHand) AS qtyonHand,
        zib2.muid AS muid,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'FMI_JKT') THEN '' ELSE zib2.traceId END AS traceId,
        zib2.lotNum AS lotNum,
        zib2.packkey AS packkey,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.locationId AS locationId,
        zib2.locationCategory AS locationCategory,
        ila1.lotAtt04 AS batch,
        ila1.lotAtt11 AS owner,
        ila1.lotAtt07 AS lotAtt07,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd1.uomdescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomdescr = 'LT' THEN zib2.qtyOnHand ELSE (
                  zib2.qtyOnHand * bs1.netweight) END) WHEN zib2.customerId IN ('MDS') THEN (CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand ELSE (zib2.qtyOnHand) * bs1.sku_group6 END) WHEN zib2.customerId IN ('PACIFICPAINT') THEN (zib2.qtyOnHand * bs1.grossweight) WHEN zib2.customerId IN ('GCM') THEN (CASE WHEN bpd1.uomDescr = 'ZK' THEN zib2.qtyOnHand * bs1.grossweight WHEN bpd1.uomDescr = 'EA' THEN zib2.qtyOnHand * bs1.grossweight ELSE (zib2.qtyOnHand) END) WHEN zib2.customerId IN ('TUMI') THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('BMM_JKT') THEN (zib2.qtyOnHand / 1000) WHEN zib2.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'LT' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'L' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'G' THEN zib2.qtyOnHand / 1000 WHEN
                  bpd1.uomDescr = 'MT' THEN zib2.qtyOnHand * 1000 ELSE (
                  zib2.qtyOnHand * bs1.grossweight) END) WHEN
            zib2.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'PC' THEN (zib2.qtyOnHand * (CAST((
                    CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN bs1.sku_group6 IS NULL THEN 0 ELSE bs1.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'EA' THEN (zib2.qtyOnHand * (CAST((CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN
                        bs1.sku_group6 IS
                        NULL THEN 0 ELSE bs1.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib2.qtyOnHand END) WHEN zib2.customerId = 'TMB_SMG' THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib2.qtyOnHand) ELSE (zib2.qtyOnHand) END AS qty,
        -- case when zib2.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm1.packId LIKE '1/%' THEN ROUND(zib2.qtyonHand * bs1.`cube`, 6) ELSE ROUND(zib2.qtyonHand * (bs1.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E08%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E09%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib2.customerId = 'MAPCLUB' THEN (CASE WHEN zib2.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) WHEN zib2.customerid = 'PPG' THEN (CASE WHEN zib2.locationId LIKE 'C%' THEN 'WH-C' ELSE 'NON WH-C' END) WHEN zib2.customerId IN ('DNN_MDN') THEN (CASE WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10215338' THEN 'PREFORM 1500' WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10215336' THEN 'PREFORM 600' WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10425007' THEN 'CAPSHIELD' ELSE 'RESIN' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila1.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      AND DATE(zib2.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --				AND CONVERT(zib2.StockDate, DATE) between '2025-05-01' and '2025-06-30'
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND bl.workingArea NOT IN ('LTL-BULK')
      -- and zib2.locationId not like 'K%'
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.SKU,
               zib2.SKUDesc,
               zib2.qtyonHand,
               zib2.UOM,
               zib2.muid,
               zib2.traceId,
               zib2.lotNum,
               zib2.packkey,
               zib2.StockDate,
               ila1.lotAtt04,
               ila1.lotAtt11,
               ila1.lotAtt07,
               zib2.locationId,
               zib2.locationCategory,
               bsm1.tariffMasterId,
               bs1.sku_group6
      ORDER BY StockDate,
      traceId ASC) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    AND DATE(zib3.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --		    and CONVERT(zib3.StockDate, DATE) between '2025-05-01' and '2025-06-30'
    AND CASE WHEN zib3.customerId IN ('ECMAMA', 'ECMAMAB2C', 'MAPCLUB', 'PANDA') THEN zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'VT', 'CSG') ELSE zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'CSG') END
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.Storage_Type) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate,
           zib4.Storage_Type;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_qty_cbm, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_qty_cbm,
      v_chargeType;


    /*IF NOT EXISTS (SELECT
              1
            FROM Z_BIL_AKUM_DAYS_STORAGE zads1
            WHERE zads1.organizationId = v_organizationId
            AND zads1.warehouseId = v_warehouseId
            AND zads1.customerId = v_customerId
            -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
             AND DATE(zads1.StockDate) = v_stockDate) THEN
    /*    BLOCK2:
          BEGIN
            DECLARE cur_days CURSOR FOR
            SELECT DISTINCT 
    zads.organizationId,
    zads.warehouseId,
    zads.customerId,
    zads.StockDate,
    zads.qty_traceId,
    zads.qty_MUID,
    zads.chargeType,
    zads.addWHo,
    zads.addTime,
    zads.editWho,
    zads.editTime,
    zads.UDF01,
    zads.UDF02,
    zads.UDF03,
    zads.UDF04,
    zads.UDF05,
    zads.lotAtt01,
    zads.lotAtt02,
    zads.lotAtt03,
    zads.lotAtt05
            FROM Z_BIL_AKUM_DAYS_STORAGE zads
    		where 
    		zads.organizationId = v_organizationId
    		and zads.customerId = v_customerId
    		and zads.warehouseId = v_warehouseId
    		and CONVERT(zads.StockDate,DATE) between '2024-12-26' and '2025-01-25';
            DECLARE CONTINUE HANDLER FOR NOT FOUND SET days_done = 1;
    /*        SELECT
              'look->',
               days_done;
            SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd*/

    #
    /*        OPEN cur_days;testing insert
     */
    /*getDays:
      LOOP
        FETCH cur_days INTO R_organizationId,R_warehouseId,R_customerId,R_StockDate,R_qty_traceId,R_qty_MUID,R_chargeType,R_addWHo,R_addTime,R_editWho,R_editTime,
        R_UDF01,R_UDF02,R_UDF03,R_UDF04,R_UDF05,R_lotAtt01,R_lotAtt02,R_lotAtt03,R_lotAtt05;


        --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
        IF days_done THEN
          SET days_done = FALSE;
          LEAVE getDays;
        END IF;

          --           SELECT 'check 2=>',R_RESULTQTYCHARGE;*/

    /*W             IF EXISTS (SELECT
                      1
                    FROM Z_BIL_AKUM_DAYS_STORAGE zi6
                    WHERE zi6.organzationId = v_organizationId 
                    AND zi6.warehouseId = v_warehouseId
                    AND zi6.customerId = v_customerId
                    AND zi6.StockDate = v_StockDate) then
                  DELETE
                    FROM Z_BIL_AKUM_DAYS_STORAGE
                    WHERE organizationId = v_organizationId
                    AND warehouseId = v_warehouseId
                    AND customerId = v_customerId
                    AND StockDate = v_StockDate;
                END IF; -- EXISTstorage akum days 
                #
                  IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                    SET OUT_returnCode = '999#????????';
                    LEAVE read_loop;
                  END IF;
               /* SELECT
                  'DEBUG=>',
                  v_customerId,
                  R_CUSTOMERID,
                  R_WAREHOUSEID,
                  days_done,
                  v_warehouseId;*/

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_qty_cbm,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `Z_EXEC_BILLING_Storage`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE Z_EXEC_BILLING_Storage ()
BEGIN
  -- Declare variables for cursor
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(30);
  DECLARE v_customerId varchar(30);
  DECLARE v_done int DEFAULT FALSE;
  DECLARE v_error_msg varchar(500);
  DECLARE v_row_count int DEFAULT 0;
  DECLARE v_success_count int DEFAULT 0;
  DECLARE v_error_count int DEFAULT 0;

  -- Declare cursor for selecting distinct combinations where lotatt02='R'
  DECLARE cur_billing CURSOR FOR
  SELECT DISTINCT
    organizationId,
    warehouseId,
    customerId
  FROM Z_BAS_CUSTOMER_CUSTBILLING
  WHERE lotatt03 = 'S';

  -- Declare continue handler for cursor
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_done = TRUE;

  -- Declare error handler
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
  BEGIN
    GET DIAGNOSTICS CONDITION 1 v_error_msg = MESSAGE_TEXT;
    SET v_error_count = v_error_count + 1;
    -- Log error (optional - you can create an error log table)
    SELECT
      CONCAT('Error processing: ', v_organizationId, '/', v_warehouseId, '/', v_customerId, ' - Error: ', v_error_msg) AS error_message;
  END;

  -- Start processing
  SELECT
    'Starting Z_EXEC_BILLING_Storage procedure...' AS status_message;

  -- Open cursor
  OPEN cur_billing;

-- Loop through cursor results
read_loop:
  LOOP
    FETCH cur_billing INTO v_organizationId, v_warehouseId, v_customerId;

    IF v_done THEN
      LEAVE read_loop;
    END IF;

    SET v_row_count = v_row_count + 1;

    -- Execute the CML_COUNT_RENT_PALLET_DAYS procedure for each record
    -- Note: Using 'en' as the language parameter as in your example
    CALL CML_COUNT_STORAGE_DAYS(v_organizationId, v_warehouseId, 'en', v_customerId);

    SET v_success_count = v_success_count + 1;

    -- Optional: Display progress every 10 records
    IF v_row_count MOD 10 = 0 THEN
      SELECT
        CONCAT('Processed ', v_row_count, ' records...') AS progress_message;
    END IF;

  END LOOP;

  -- Close cursor
  CLOSE cur_billing;

  -- Display final summary
  SELECT
    CONCAT('Z_EXEC_BILLING_Storage completed. Total records: ', v_row_count,
    ', Success: ', v_success_count,
    ', Errors: ', v_error_count) AS completion_message;

END
$$

--
-- Create procedure `CML_COUNT_RENT_PALLET_DAYS`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_RENT_PALLET_DAYS (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_chargeType varchar(255);
  DECLARE v_locType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    zib4.StockDate,
    SUM(zib4.qtyCharge_TraceId) AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    zib4.locType,
    'RP' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib1.locationId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib1.muid) AS qtyCharge_MUID,
      zib1.locType
    FROM (SELECT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.muid AS muid,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        CASE WHEN zib.customerId = 'LTL' THEN (CASE WHEN zib.warehouseId = 'CBT01' AND
                  zib.locationId LIKE 'K%' THEN 'WH-K' ELSE 'NOT WH-K' END) ELSE 'GENERAL' END AS locType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --     			AND CONVERT(zib.StockDate, DATE) between '2025-05-26' and '2025-06-30'
      AND ila.lotAtt07 NOT IN ('O', 'OP', 'OL', 'OPC')
      AND zib.locationId NOT IN ('CONSWOR',
      'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20',
      'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02',
      'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03',
      'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25',
      'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND zib.locationCategory IN ('SD', 'DD', 'GR')
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.muid,
               zib.StockDate,
               zib.locationId
      ORDER BY StockDate ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseid = IN_WarehouseId
    AND DATE(zib1.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --			and CONVERT(zib1.StockDate, DATE) between '2025-05-26' and '2025-06-30'
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.locType
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib3.traceId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib3.muid) AS qtyCharge_MUID,
      zib3.locType
    FROM (SELECT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.muid AS muid,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.traceId AS traceId,
        CASE WHEN zib2.customerId = 'LTL' THEN (CASE WHEN zib2.warehouseId = 'CBT01' AND
                  zib2.locationId LIKE 'K%' THEN 'WH-K' ELSE 'NOT WH-K' END) ELSE 'GENERAL' END AS locType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      AND ila1.lotAtt07 NOT IN ('O', 'OP', 'OL', 'OPC')
      AND DATE(zib2.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --				AND CONVERT(zib2.StockDate, DATE) between '2025-05-26' and '2025-06-30'
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      -- and ila1.lotAtt11 is not null
      -- and zib2.locationId not like 'K%'
      AND CASE WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN zib2.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'VT') ELSE zib2.locationCategory IN ('BS', 'FS', 'DR', 'PK') END
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.muid,
               zib2.traceId,
               zib2.StockDate,
               zib2.locationId
      ORDER BY StockDate) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    AND DATE(zib3.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --			and CONVERT(zib3.StockDate, DATE) between '2025-05-26' and '2025-06-30'
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.locType) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate,
           zib4.locType;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_locType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      R_CUSTOMERID,
      R_WAREHOUSEID,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_chargeType,
      v_locType;


    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_locType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `Z_EXEC_BILLING_PalletRental`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE Z_EXEC_BILLING_PalletRental ()
BEGIN
  -- Declare variables for cursor
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(30);
  DECLARE v_customerId varchar(30);
  DECLARE v_done int DEFAULT FALSE;
  DECLARE v_error_msg varchar(500);
  DECLARE v_row_count int DEFAULT 0;
  DECLARE v_success_count int DEFAULT 0;
  DECLARE v_error_count int DEFAULT 0;

  -- Declare cursor for selecting distinct combinations where lotatt02='R'
  DECLARE cur_billing CURSOR FOR
  SELECT DISTINCT
    organizationId,
    warehouseId,
    customerId
  FROM Z_BAS_CUSTOMER_CUSTBILLING
  WHERE lotatt02 = 'R';

  -- Declare continue handler for cursor
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_done = TRUE;

  -- Declare error handler
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
  BEGIN
    GET DIAGNOSTICS CONDITION 1 v_error_msg = MESSAGE_TEXT;
    SET v_error_count = v_error_count + 1;
    -- Log error (optional - you can create an error log table)
    SELECT
      CONCAT('Error processing: ', v_organizationId, '/', v_warehouseId, '/', v_customerId, ' - Error: ', v_error_msg) AS error_message;
  END;

  -- Start processing
  SELECT
    'Starting Z_EXEC_BILLING_PalletRental procedure...' AS status_message;

  -- Open cursor
  OPEN cur_billing;

-- Loop through cursor results
read_loop:
  LOOP
    FETCH cur_billing INTO v_organizationId, v_warehouseId, v_customerId;

    IF v_done THEN
      LEAVE read_loop;
    END IF;

    SET v_row_count = v_row_count + 1;

    -- Execute the CML_COUNT_RENT_PALLET_DAYS procedure for each record
    -- Note: Using 'en' as the language parameter as in your example
    CALL CML_COUNT_RENT_PALLET_DAYS(v_organizationId, v_warehouseId, 'en', v_customerId);

    SET v_success_count = v_success_count + 1;

    -- Optional: Display progress every 10 records
    IF v_row_count MOD 10 = 0 THEN
      SELECT
        CONCAT('Processed ', v_row_count, ' records...') AS progress_message;
    END IF;

  END LOOP;

  -- Close cursor
  CLOSE cur_billing;

  -- Display final summary
  SELECT
    CONCAT('Z_EXEC_BILLING_PalletRental completed. Total records: ', v_row_count,
    ', Success: ', v_success_count,
    ', Errors: ', v_error_count) AS completion_message;

END
$$

--
-- Create procedure `Z_CYCLEGROUPINFO_UPDATE`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_CYCLEGROUPINFO_UPDATE (IN IN_organizationId varchar(50),
IN IN_warehouseId varchar(50),
IN IN_idDocumentCycle varchar(50),
IN IN_userCount int,
OUT returncode varchar(1009))
ENDPROC:
  BEGIN

    -- Declare variables to store data from each row
    DECLARE done int DEFAULT FALSE;
    DECLARE v_organizationId varchar(30);
    DECLARE v_warehouseId varchar(30);
    DECLARE v_idDocumentCycle varchar(255);
    DECLARE v_userCount int;
    DECLARE v_location varchar(30);
    DECLARE v_groupInfo varchar(30);
    DECLARE errorMessage varchar(255);
    -- SET returncode:='000';

    DECLARE cyc_details CURSOR FOR

    SELECT
      organizationId,
      warehouseId,
      idDocumentCycle,
      location,
      CONCAT('GROUP', NTILE(IN_userCount) OVER (
      ORDER BY location)) AS group_information
    FROM Z_CYCLECOUNT_DETAIL
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    OPEN cyc_details;

    SELECT
      IN_organizationId,
      IN_warehouseId,
      IN_idDocumentCycle,
      IN_userCount;

  read_loop:
    LOOP
      FETCH cyc_details INTO v_organizationId,
      v_warehouseId,
      v_idDocumentCycle,
      v_location,
      v_groupInfo;


      IF done THEN
        LEAVE read_loop;
      END IF;

      UPDATE Z_CYCLECOUNT_DETAIL
      SET groupIdTask = v_groupInfo
      WHERE organizationId = v_organizationId
      AND warehouseId = v_warehouseId
      AND idDocumentCycle = v_idDocumentCycle
      AND location = v_location;

    END LOOP;

    SET returncode = '000';

    CLOSE cyc_details;

  END
  $$

--
-- Create procedure `Z_CYCLEDETAIL_INSERT_C04`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_CYCLEDETAIL_INSERT_C04 (IN IN_organizationId varchar(50),
IN IN_warehouseId varchar(50),
IN IN_userId varchar(50),
IN IN_customerId varchar(50),
IN IN_idDocumentCycle varchar(50),
IN IN_methodCycle varchar(50),
IN IN_sku varchar(1000),
IN IN_chamber varchar(50),
IN IN_aisle varchar(50),
IN IN_level varchar(50),
IN IN_userCount int,
-- IN IN_dateFrom DateTime,
-- IN IN_dateTo DateTime,
IN IN_dateFrom varchar(50),
IN IN_dateTo varchar(50),
IN IN_locCategory varchar(50),
IN IN_levCategory varchar(50),
OUT OUT_returnCode varchar(1009))
ENDPROC:
  BEGIN

    -- Declare variables to store data from each row
    DECLARE done int DEFAULT FALSE;
    DECLARE v_organizationId varchar(50);
    DECLARE v_warehouseId varchar(50);
    DECLARE v_customerId varchar(50);
    DECLARE v_idDocumentCycle varchar(255);
    DECLARE v_idDocumentDetailCycle varchar(255);
    DECLARE v_methodCycle varchar(50);
    DECLARE v_sku varchar(100);
    DECLARE v_chamber varchar(50);
    DECLARE v_aisle varchar(50);
    DECLARE v_level varchar(50);
    DECLARE v_userCount int;
    --    DECLARE v_dateFrom DateTime;
    --    DECLARE v_dateTo DateTime;
    DECLARE v_dateFrom varchar(50);
    DECLARE v_dateTo varchar(50);
    DECLARE v_location varchar(50);
    DECLARE v_groupInfo varchar(50);
    DECLARE errorMessage varchar(255);
    DECLARE count_cycdtl int(100);
    DECLARE v_hitungRow int;
    DECLARE v_skuDescr varchar(1000);
    DECLARE v_qtyOnHand varchar(50);
    DECLARE v_uom varchar(50);
    DECLARE v_status varchar(50);
    DECLARE v_lotnum varchar(50);
    DECLARE v_batch varchar(50);
    DECLARE v_expDate varchar(50);
    DECLARE v_traceid varchar(50);
    DECLARE v_picksequence varchar(50);
    DECLARE cnt_userCount int;
    DECLARE myreturncode varchar(1009);

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#Z_CHECK_LDLEXISTAPPDOC', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
    END;

    SET count_cycdtl := 0;
    SET v_hitungRow := 0;

    SELECT
      COUNT(1) INTO count_cycdtl
    FROM Z_CYCLECOUNT_DETAIL
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle;

    IF count_cycdtl > 0 THEN
      SET OUT_returnCode = CONCAT('You Already Generated Data Details!');
      LEAVE ENDPROC;
    ELSE
      SET OUT_returnCode = '000';
    END IF;

    SET cnt_userCount := 0;

    SELECT
      userCountTotal INTO cnt_userCount
    FROM Z_CYCLECOUNT_HEADER
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle;

    IF cnt_userCount = 0
      OR cnt_userCount IS NULL THEN
      SET OUT_returnCode = CONCAT('User Count Harus > 1 !!');
      LEAVE ENDPROC;
    ELSE
      SET OUT_returnCode = '000';
    END IF;

    IF IN_methodCycle = 'TPIC' THEN
    BEGIN
      DECLARE cyc_details CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT DISTINCT
          fmlocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PK')
      AND a.sku IN (SELECT DISTINCT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PK')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04,
               c.lotatt02
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details;
    END;
    ELSEIF IN_methodCycle = 'TPUT' THEN
    BEGIN
      DECLARE cyc_details_tput CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT
          tolocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PA')
      AND a.sku IN (SELECT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PA')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04,
               c.lotatt02
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_tput;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_tput INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_tput;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Transaksi Putaway) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'MV' THEN
    BEGIN
      DECLARE cyc_details_mv CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT
          tolocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'MV')
      AND a.sku IN (SELECT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'MV')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04,
               c.lotatt02
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_mv;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_mv INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_mv;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Transaksi Movement) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'SKU' THEN
    BEGIN
      DECLARE delimiterChar longtext;
      DECLARE inputString longtext;
      DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        GET DIAGNOSTICS CONDITION 1
        @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
        ROLLBACK;
        SET OUT_returnCode = CONCAT('999#Z_CYCLEDETAIL_INSERT', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      END;

      DROP TEMPORARY TABLE IF EXISTS temp_skucycledtl;
      CREATE TEMPORARY TABLE temp_skucycledtl (
        vals longtext
      );

      SET delimiterChar = ',';
      SET inputString = IN_sku;
      WHILE LOCATE(delimiterChar, inputString) > 1 DO
        INSERT INTO temp_skucycledtl
          SELECT
            SUBSTRING_INDEX (inputString, delimiterChar, 1);
        SET inputString = REPLACE(inputString, (SELECT
            LEFT(inputString, LOCATE(delimiterChar, inputString))), '');
      END WHILE;
      INSERT INTO temp_skucycledtl (vals)
        VALUES (inputString);

      BEGIN

        DECLARE r_organizationId varchar(20);
        DECLARE r_warehouseId varchar(20);
        DECLARE r_billingSummaryId varchar(30);
        DECLARE r_billingFromDate varchar(30);
        DECLARE r_billingToDate varchar(30);
        DECLARE r_customerId varchar(30);
        DECLARE r_chargeCategory varchar(20);
        DECLARE r_chargeType varchar(20);
        DECLARE r_amount decimal(24, 8);
        DECLARE r_billingAmount decimal(24, 8);
        DECLARE inventory_done int DEFAULT 0;
        DECLARE tariff_done int DEFAULT 0;
        DECLARE billing_sm_done,
                attribute_done int DEFAULT 0;

        DECLARE cyc_details_sku CURSOR FOR

        SELECT
          IN_idDocumentCycle AS idDocumentCycle,
          CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
          a.organizationId,
          a.warehouseId,
          a.customerId,
          a.locationid AS Location,
          a.sku AS SKU,
          b.skudescr1 AS skuDescr,
          SUM(a.qty) AS QtyOnHand,
          d.uomdescr AS uom,
          c.lotatt08 AS status,
          --		a.lotnum as LotNum,
          --		c.lotatt04 as Batch,
          --		c.lotatt02 as ExpDate,
          --		a.traceid as Traceid 
          '' AS LotNum,
          c.lotatt04 AS Batch,
          c.lotatt02 AS ExpDate,
          '' AS Traceid,
          a1.pickLogicalSequence
        FROM BAS_LOCATION a1
          LEFT OUTER JOIN INV_LOT_LOC_ID a
            ON a1.organizationid = a.organizationid
            AND a1.warehouseid = a.warehouseid
            AND a1.locationid = a.locationid
            AND a.qty > 0
          LEFT OUTER JOIN BAS_SKU b
            ON a.organizationid = b.organizationid
            AND a.customerid = b.customerid
            AND a.sku = b.sku
          LEFT OUTER JOIN INV_LOT_ATT c
            ON a.organizationid = c.organizationid
            AND a.customerid = c.customerid
            AND a.lotnum = c.lotnum
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
            ON b.organizationid = d.organizationid
            AND b.customerid = d.customerid
            AND b.packid = d.packid
            AND d.packuom = 'EA'
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
            ON b.organizationid = d1.organizationid
            AND b.customerid = d1.customerid
            AND b.packid = d1.packid
            AND d1.packuom = 'IP'
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
            ON b.organizationid = d2.organizationid
            AND b.customerid = d2.customerid
            AND b.packid = d2.packid
            AND d2.packuom = 'CS'
          LEFT OUTER JOIN BSM_CODE_ML e
            ON c.organizationid = e.organizationid
            AND c.lotatt08 = e.codeid
            AND e.codetype = 'DMG_FLG'
            AND e.languageid = 'en'
        WHERE a1.organizationid = IN_organizationId
        AND a1.warehouseid = IN_warehouseId
        -- and a1.locGroup2 in (IN_chamber)
        -- and a1.aisleNo in (IN_aisle)
        -- and a1.locLevel in (IN_level)
        AND a.sku IN (SELECT
            vals
          FROM temp_skucycledtl)
        -- and a.qty >0
        AND a.locationId NOT LIKE 'SORTATION%'
        AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
                codeId
              FROM BSM_CODE bc
              WHERE organizationId = 'OJV_CML'
              AND codeType = 'LOC_CAT'
              AND activeFlag = 'Y') END
        AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
                udf04
              FROM BAS_LOCATION bl
              WHERE organizationId = IN_organizationId
              AND warehouseId = IN_warehouseId) END
        GROUP BY a.organizationId,
                 a.warehouseId,
                 a.customerId,
                 a.locationid,
                 a.sku,
                 b.skudescr1,
                 d.uomdescr,
                 c.lotatt08,
                 c.lotatt04,
                 c.lotatt02
        ORDER BY a1.locationId;

        DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

        OPEN cyc_details_sku;

        SELECT
          IN_organizationId,
          IN_warehouseId,
          IN_idDocumentCycle,
          IN_userCount,
          IN_dateFrom,
          IN_dateTo;

      read_loop:
        LOOP
          FETCH cyc_details_sku INTO v_idDocumentCycle, v_idDocumentDetailCycle,
          v_organizationId, v_warehouseId,
          v_customerId, v_location, v_sku, v_skuDescr,
          v_qtyOnHand, v_uom, v_status, v_lotnum,
          v_batch, v_expDate, v_traceid, v_picksequence;

          SET v_hitungRow = v_hitungRow + 1;

          IF done THEN
            LEAVE read_loop;
          END IF;

          INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
          location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
          countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
            SELECT
              v_idDocumentCycle,
              v_idDocumentDetailCycle,
              v_organizationId,
              v_warehouseId,
              v_customerId,
              v_location,
              v_sku,
              v_skuDescr,
              v_qtyOnHand,
              v_uom,
              v_status,
              v_lotnum,
              v_batch,
              v_expDate,
              v_traceid,
              NULL count1,
              NULL count2,
              NULL count3,
              NULL countFinal,
              NULL countDifferent,
              'UNMATCH' countStatus,
              NOW() addTime,
              IN_userId addWho,
              NOW() editTime,
              IN_userId editWho,
              'N' findingFlag,
              v_idDocumentDetailCycle,
              v_picksequence;

        END LOOP;
        SELECT
          v_hitungRow;
        CLOSE cyc_details_sku;

        DROP TEMPORARY TABLE IF EXISTS temp_skucycledtl;
        COMMIT;
      END;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (SKU) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LL' THEN
    BEGIN
      DECLARE cyc_details_ll CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      -- and a.sku is null
      -- and a.qty >0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04,
               c.lotatt02
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_ll;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_ll INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_ll;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location All) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LE' THEN
    BEGIN
      DECLARE cyc_details_le CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      AND a.sku IS NULL
      -- and a.qty >0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04,
               c.lotatt02
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_le;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_le INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_le;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location Empty) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LA' THEN
    BEGIN
      DECLARE cyc_details_la CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      -- and a.sku is null
      AND a.qty > 0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04,
               c.lotatt02
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_la;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_la INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_la;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location with SOH) belum ada!!');
    		LEAVE ENDPROC;	
    		*/
    END IF;

    SELECT
      IN_organizationId,
      IN_warehouseId,
      IN_idDocumentCycle,
      cnt_userCount,
      myreturncode;
    CALL Z_CYCLEGROUPINFO_UPDATE(IN_organizationId, IN_warehouseId, IN_idDocumentCycle, cnt_userCount, myreturncode);

  END
  $$

--
-- Create procedure `Z_CYCLEDETAIL_INSERT_C03`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_CYCLEDETAIL_INSERT_C03 (IN IN_organizationId varchar(50),
IN IN_warehouseId varchar(50),
IN IN_userId varchar(50),
IN IN_customerId varchar(50),
IN IN_idDocumentCycle varchar(50),
IN IN_methodCycle varchar(50),
IN IN_sku varchar(1000),
IN IN_chamber varchar(50),
IN IN_aisle varchar(50),
IN IN_level varchar(50),
IN IN_userCount int,
-- IN IN_dateFrom DateTime,
-- IN IN_dateTo DateTime,
IN IN_dateFrom varchar(50),
IN IN_dateTo varchar(50),
IN IN_locCategory varchar(50),
IN IN_levCategory varchar(50),
OUT OUT_returnCode varchar(1009))
ENDPROC:
  BEGIN

    -- Declare variables to store data from each row
    DECLARE done int DEFAULT FALSE;
    DECLARE v_organizationId varchar(50);
    DECLARE v_warehouseId varchar(50);
    DECLARE v_customerId varchar(50);
    DECLARE v_idDocumentCycle varchar(255);
    DECLARE v_idDocumentDetailCycle varchar(255);
    DECLARE v_methodCycle varchar(50);
    DECLARE v_sku varchar(100);
    DECLARE v_chamber varchar(50);
    DECLARE v_aisle varchar(50);
    DECLARE v_level varchar(50);
    DECLARE v_userCount int;
    --    DECLARE v_dateFrom DateTime;
    --    DECLARE v_dateTo DateTime;
    DECLARE v_dateFrom varchar(50);
    DECLARE v_dateTo varchar(50);
    DECLARE v_location varchar(50);
    DECLARE v_groupInfo varchar(50);
    DECLARE errorMessage varchar(255);
    DECLARE count_cycdtl int(100);
    DECLARE v_hitungRow int;
    DECLARE v_skuDescr varchar(1000);
    DECLARE v_qtyOnHand varchar(50);
    DECLARE v_uom varchar(50);
    DECLARE v_status varchar(50);
    DECLARE v_lotnum varchar(50);
    DECLARE v_batch varchar(50);
    DECLARE v_expDate varchar(50);
    DECLARE v_traceid varchar(50);
    DECLARE v_picksequence varchar(50);
    DECLARE cnt_userCount int;
    DECLARE myreturncode varchar(1009);

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#Z_CHECK_LDLEXISTAPPDOC', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
    END;

    SET count_cycdtl := 0;
    SET v_hitungRow := 0;

    SELECT
      COUNT(1) INTO count_cycdtl
    FROM Z_CYCLECOUNT_DETAIL
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle;

    IF count_cycdtl > 0 THEN
      SET OUT_returnCode = CONCAT('You Already Generated Data Details!');
      LEAVE ENDPROC;
    ELSE
      SET OUT_returnCode = '000';
    END IF;

    SET cnt_userCount := 0;

    SELECT
      userCountTotal INTO cnt_userCount
    FROM Z_CYCLECOUNT_HEADER
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle;

    IF cnt_userCount = 0
      OR cnt_userCount IS NULL THEN
      SET OUT_returnCode = CONCAT('User Count Harus > 1 !!');
      LEAVE ENDPROC;
    ELSE
      SET OUT_returnCode = '000';
    END IF;

    IF IN_methodCycle = 'TPIC' THEN
    BEGIN
      DECLARE cyc_details CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        NULL AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT DISTINCT
          fmlocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PK')
      AND a.sku IN (SELECT DISTINCT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PK')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details;
    END;
    ELSEIF IN_methodCycle = 'TPUT' THEN
    BEGIN
      DECLARE cyc_details_tput CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        NULL AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT
          tolocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PA')
      AND a.sku IN (SELECT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PA')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_tput;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_tput INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_tput;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Transaksi Putaway) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'MV' THEN
    BEGIN
      DECLARE cyc_details_mv CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        NULL AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT
          tolocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'MV')
      AND a.sku IN (SELECT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'MV')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_mv;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_mv INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_mv;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Transaksi Movement) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'SKU' THEN
    BEGIN
      DECLARE delimiterChar longtext;
      DECLARE inputString longtext;
      DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        GET DIAGNOSTICS CONDITION 1
        @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
        ROLLBACK;
        SET OUT_returnCode = CONCAT('999#Z_CYCLEDETAIL_INSERT', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      END;

      DROP TEMPORARY TABLE IF EXISTS temp_skucycledtl;
      CREATE TEMPORARY TABLE temp_skucycledtl (
        vals longtext
      );

      SET delimiterChar = ',';
      SET inputString = IN_sku;
      WHILE LOCATE(delimiterChar, inputString) > 1 DO
        INSERT INTO temp_skucycledtl
          SELECT
            SUBSTRING_INDEX (inputString, delimiterChar, 1);
        SET inputString = REPLACE(inputString, (SELECT
            LEFT(inputString, LOCATE(delimiterChar, inputString))), '');
      END WHILE;
      INSERT INTO temp_skucycledtl (vals)
        VALUES (inputString);

      BEGIN

        DECLARE r_organizationId varchar(20);
        DECLARE r_warehouseId varchar(20);
        DECLARE r_billingSummaryId varchar(30);
        DECLARE r_billingFromDate varchar(30);
        DECLARE r_billingToDate varchar(30);
        DECLARE r_customerId varchar(30);
        DECLARE r_chargeCategory varchar(20);
        DECLARE r_chargeType varchar(20);
        DECLARE r_amount decimal(24, 8);
        DECLARE r_billingAmount decimal(24, 8);
        DECLARE inventory_done int DEFAULT 0;
        DECLARE tariff_done int DEFAULT 0;
        DECLARE billing_sm_done,
                attribute_done int DEFAULT 0;

        DECLARE cyc_details_sku CURSOR FOR

        SELECT
          IN_idDocumentCycle AS idDocumentCycle,
          CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
          a.organizationId,
          a.warehouseId,
          a.customerId,
          a.locationid AS Location,
          a.sku AS SKU,
          b.skudescr1 AS skuDescr,
          SUM(a.qty) AS QtyOnHand,
          d.uomdescr AS uom,
          c.lotatt08 AS status,
          --		a.lotnum as LotNum,
          --		c.lotatt04 as Batch,
          --		c.lotatt02 as ExpDate,
          --		a.traceid as Traceid 
          '' AS LotNum,
          c.lotatt04 AS Batch,
          NULL AS ExpDate,
          '' AS Traceid,
          a1.pickLogicalSequence
        FROM BAS_LOCATION a1
          LEFT OUTER JOIN INV_LOT_LOC_ID a
            ON a1.organizationid = a.organizationid
            AND a1.warehouseid = a.warehouseid
            AND a1.locationid = a.locationid
            AND a.qty > 0
          LEFT OUTER JOIN BAS_SKU b
            ON a.organizationid = b.organizationid
            AND a.customerid = b.customerid
            AND a.sku = b.sku
          LEFT OUTER JOIN INV_LOT_ATT c
            ON a.organizationid = c.organizationid
            AND a.customerid = c.customerid
            AND a.lotnum = c.lotnum
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
            ON b.organizationid = d.organizationid
            AND b.customerid = d.customerid
            AND b.packid = d.packid
            AND d.packuom = 'EA'
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
            ON b.organizationid = d1.organizationid
            AND b.customerid = d1.customerid
            AND b.packid = d1.packid
            AND d1.packuom = 'IP'
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
            ON b.organizationid = d2.organizationid
            AND b.customerid = d2.customerid
            AND b.packid = d2.packid
            AND d2.packuom = 'CS'
          LEFT OUTER JOIN BSM_CODE_ML e
            ON c.organizationid = e.organizationid
            AND c.lotatt08 = e.codeid
            AND e.codetype = 'DMG_FLG'
            AND e.languageid = 'en'
        WHERE a1.organizationid = IN_organizationId
        AND a1.warehouseid = IN_warehouseId
        -- and a1.locGroup2 in (IN_chamber)
        -- and a1.aisleNo in (IN_aisle)
        -- and a1.locLevel in (IN_level)
        AND a.sku IN (SELECT
            vals
          FROM temp_skucycledtl)
        -- and a.qty >0
        AND a.locationId NOT LIKE 'SORTATION%'
        AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
                codeId
              FROM BSM_CODE bc
              WHERE organizationId = 'OJV_CML'
              AND codeType = 'LOC_CAT'
              AND activeFlag = 'Y') END
        AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
                udf04
              FROM BAS_LOCATION bl
              WHERE organizationId = IN_organizationId
              AND warehouseId = IN_warehouseId) END
        GROUP BY a.organizationId,
                 a.warehouseId,
                 a.customerId,
                 a.locationid,
                 a.sku,
                 b.skudescr1,
                 d.uomdescr,
                 c.lotatt08,
                 c.lotatt04
        ORDER BY a1.locationId;

        DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

        OPEN cyc_details_sku;

        SELECT
          IN_organizationId,
          IN_warehouseId,
          IN_idDocumentCycle,
          IN_userCount,
          IN_dateFrom,
          IN_dateTo;

      read_loop:
        LOOP
          FETCH cyc_details_sku INTO v_idDocumentCycle, v_idDocumentDetailCycle,
          v_organizationId, v_warehouseId,
          v_customerId, v_location, v_sku, v_skuDescr,
          v_qtyOnHand, v_uom, v_status, v_lotnum,
          v_batch, v_expDate, v_traceid, v_picksequence;

          SET v_hitungRow = v_hitungRow + 1;

          IF done THEN
            LEAVE read_loop;
          END IF;

          INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
          location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
          countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
            SELECT
              v_idDocumentCycle,
              v_idDocumentDetailCycle,
              v_organizationId,
              v_warehouseId,
              v_customerId,
              v_location,
              v_sku,
              v_skuDescr,
              v_qtyOnHand,
              v_uom,
              v_status,
              v_lotnum,
              v_batch,
              v_expDate,
              v_traceid,
              NULL count1,
              NULL count2,
              NULL count3,
              NULL countFinal,
              NULL countDifferent,
              'UNMATCH' countStatus,
              NOW() addTime,
              IN_userId addWho,
              NOW() editTime,
              IN_userId editWho,
              'N' findingFlag,
              v_idDocumentDetailCycle,
              v_picksequence;

        END LOOP;
        SELECT
          v_hitungRow;
        CLOSE cyc_details_sku;

        DROP TEMPORARY TABLE IF EXISTS temp_skucycledtl;
        COMMIT;
      END;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (SKU) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LL' THEN
    BEGIN
      DECLARE cyc_details_ll CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        NULL AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      -- and a.sku is null
      -- and a.qty >0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_ll;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_ll INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_ll;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location All) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LE' THEN
    BEGIN
      DECLARE cyc_details_le CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        NULL AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      AND a.sku IS NULL
      -- and a.qty >0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_le;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_le INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_le;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location Empty) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LA' THEN
    BEGIN
      DECLARE cyc_details_la CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        c.lotatt04 AS Batch,
        NULL AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      -- and a.sku is null
      AND a.qty > 0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt04
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_la;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_la INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_la;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location with SOH) belum ada!!');
    		LEAVE ENDPROC;	
    		*/
    END IF;

    SELECT
      IN_organizationId,
      IN_warehouseId,
      IN_idDocumentCycle,
      cnt_userCount,
      myreturncode;
    CALL Z_CYCLEGROUPINFO_UPDATE(IN_organizationId, IN_warehouseId, IN_idDocumentCycle, cnt_userCount, myreturncode);

  END
  $$

--
-- Create procedure `Z_CYCLEDETAIL_INSERT_C02`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_CYCLEDETAIL_INSERT_C02 (IN IN_organizationId varchar(50),
IN IN_warehouseId varchar(50),
IN IN_userId varchar(50),
IN IN_customerId varchar(50),
IN IN_idDocumentCycle varchar(50),
IN IN_methodCycle varchar(50),
IN IN_sku varchar(1000),
IN IN_chamber varchar(50),
IN IN_aisle varchar(50),
IN IN_level varchar(50),
IN IN_userCount int,
-- IN IN_dateFrom DateTime,
-- IN IN_dateTo DateTime,
IN IN_dateFrom varchar(50),
IN IN_dateTo varchar(50),
IN IN_locCategory varchar(50),
IN IN_levCategory varchar(50),
OUT OUT_returnCode varchar(1009))
ENDPROC:
  BEGIN

    -- Declare variables to store data from each row
    DECLARE done int DEFAULT FALSE;
    DECLARE v_organizationId varchar(50);
    DECLARE v_warehouseId varchar(50);
    DECLARE v_customerId varchar(50);
    DECLARE v_idDocumentCycle varchar(255);
    DECLARE v_idDocumentDetailCycle varchar(255);
    DECLARE v_methodCycle varchar(50);
    DECLARE v_sku varchar(100);
    DECLARE v_chamber varchar(50);
    DECLARE v_aisle varchar(50);
    DECLARE v_level varchar(50);
    DECLARE v_userCount int;
    --    DECLARE v_dateFrom DateTime;
    --    DECLARE v_dateTo DateTime;
    DECLARE v_dateFrom varchar(50);
    DECLARE v_dateTo varchar(50);
    DECLARE v_location varchar(50);
    DECLARE v_groupInfo varchar(50);
    DECLARE errorMessage varchar(255);
    DECLARE count_cycdtl int(100);
    DECLARE v_hitungRow int;
    DECLARE v_skuDescr varchar(1000);
    DECLARE v_qtyOnHand varchar(50);
    DECLARE v_uom varchar(50);
    DECLARE v_status varchar(50);
    DECLARE v_lotnum varchar(50);
    DECLARE v_batch varchar(50);
    DECLARE v_expDate varchar(50);
    DECLARE v_traceid varchar(50);
    DECLARE v_picksequence varchar(50);
    DECLARE cnt_userCount int;
    DECLARE myreturncode varchar(1009);

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#Z_CHECK_LDLEXISTAPPDOC', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
    END;

    SET count_cycdtl := 0;
    SET v_hitungRow := 0;

    SELECT
      COUNT(1) INTO count_cycdtl
    FROM Z_CYCLECOUNT_DETAIL
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle;

    IF count_cycdtl > 0 THEN
      SET OUT_returnCode = CONCAT('You Already Generated Data Details!');
      LEAVE ENDPROC;
    ELSE
      SET OUT_returnCode = '000';
    END IF;

    SET cnt_userCount := 0;

    SELECT
      userCountTotal INTO cnt_userCount
    FROM Z_CYCLECOUNT_HEADER
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle;

    IF cnt_userCount = 0
      OR cnt_userCount IS NULL THEN
      SET OUT_returnCode = CONCAT('User Count Harus > 1 !!');
      LEAVE ENDPROC;
    ELSE
      SET OUT_returnCode = '000';
    END IF;

    IF IN_methodCycle = 'TPIC' THEN
    BEGIN
      DECLARE cyc_details CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        '' AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT DISTINCT
          fmlocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PK')
      AND a.sku IN (SELECT DISTINCT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PK')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt02
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details;
    END;
    ELSEIF IN_methodCycle = 'TPUT' THEN
    BEGIN
      DECLARE cyc_details_tput CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        '' AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT
          tolocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PA')
      AND a.sku IN (SELECT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PA')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt02
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_tput;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_tput INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_tput;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Transaksi Putaway) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'MV' THEN
    BEGIN
      DECLARE cyc_details_mv CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        '' AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        bl.pickLogicalSequence
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
        LEFT OUTER JOIN BAS_LOCATION bl
          ON a.organizationId = bl.organizationId
          AND a.warehouseId = bl.warehouseId
          AND a.locationId = bl.locationId
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT
          tolocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'MV')
      AND a.sku IN (SELECT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'MV')
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN bl.locationCategory = IN_locCategory ELSE bl.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN bl.udf04 = IN_levCategory ELSE bl.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt02
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_mv;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_mv INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_mv;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Transaksi Movement) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'SKU' THEN
    BEGIN
      DECLARE delimiterChar longtext;
      DECLARE inputString longtext;
      DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        GET DIAGNOSTICS CONDITION 1
        @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
        ROLLBACK;
        SET OUT_returnCode = CONCAT('999#Z_CYCLEDETAIL_INSERT', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      END;

      DROP TEMPORARY TABLE IF EXISTS temp_skucycledtl;
      CREATE TEMPORARY TABLE temp_skucycledtl (
        vals longtext
      );

      SET delimiterChar = ',';
      SET inputString = IN_sku;
      WHILE LOCATE(delimiterChar, inputString) > 1 DO
        INSERT INTO temp_skucycledtl
          SELECT
            SUBSTRING_INDEX (inputString, delimiterChar, 1);
        SET inputString = REPLACE(inputString, (SELECT
            LEFT(inputString, LOCATE(delimiterChar, inputString))), '');
      END WHILE;
      INSERT INTO temp_skucycledtl (vals)
        VALUES (inputString);

      BEGIN

        DECLARE r_organizationId varchar(20);
        DECLARE r_warehouseId varchar(20);
        DECLARE r_billingSummaryId varchar(30);
        DECLARE r_billingFromDate varchar(30);
        DECLARE r_billingToDate varchar(30);
        DECLARE r_customerId varchar(30);
        DECLARE r_chargeCategory varchar(20);
        DECLARE r_chargeType varchar(20);
        DECLARE r_amount decimal(24, 8);
        DECLARE r_billingAmount decimal(24, 8);
        DECLARE inventory_done int DEFAULT 0;
        DECLARE tariff_done int DEFAULT 0;
        DECLARE billing_sm_done,
                attribute_done int DEFAULT 0;

        DECLARE cyc_details_sku CURSOR FOR

        SELECT
          IN_idDocumentCycle AS idDocumentCycle,
          CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
          a.organizationId,
          a.warehouseId,
          a.customerId,
          a.locationid AS Location,
          a.sku AS SKU,
          b.skudescr1 AS skuDescr,
          SUM(a.qty) AS QtyOnHand,
          d.uomdescr AS uom,
          c.lotatt08 AS status,
          --		a.lotnum as LotNum,
          --		c.lotatt04 as Batch,
          --		c.lotatt02 as ExpDate,
          --		a.traceid as Traceid 
          '' AS LotNum,
          '' AS Batch,
          c.lotatt02 AS ExpDate,
          '' AS Traceid,
          a1.pickLogicalSequence
        FROM BAS_LOCATION a1
          LEFT OUTER JOIN INV_LOT_LOC_ID a
            ON a1.organizationid = a.organizationid
            AND a1.warehouseid = a.warehouseid
            AND a1.locationid = a.locationid
            AND a.qty > 0
          LEFT OUTER JOIN BAS_SKU b
            ON a.organizationid = b.organizationid
            AND a.customerid = b.customerid
            AND a.sku = b.sku
          LEFT OUTER JOIN INV_LOT_ATT c
            ON a.organizationid = c.organizationid
            AND a.customerid = c.customerid
            AND a.lotnum = c.lotnum
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
            ON b.organizationid = d.organizationid
            AND b.customerid = d.customerid
            AND b.packid = d.packid
            AND d.packuom = 'EA'
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
            ON b.organizationid = d1.organizationid
            AND b.customerid = d1.customerid
            AND b.packid = d1.packid
            AND d1.packuom = 'IP'
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
            ON b.organizationid = d2.organizationid
            AND b.customerid = d2.customerid
            AND b.packid = d2.packid
            AND d2.packuom = 'CS'
          LEFT OUTER JOIN BSM_CODE_ML e
            ON c.organizationid = e.organizationid
            AND c.lotatt08 = e.codeid
            AND e.codetype = 'DMG_FLG'
            AND e.languageid = 'en'
        WHERE a1.organizationid = IN_organizationId
        AND a1.warehouseid = IN_warehouseId
        -- and a1.locGroup2 in (IN_chamber)
        -- and a1.aisleNo in (IN_aisle)
        -- and a1.locLevel in (IN_level)
        AND a.sku IN (SELECT
            vals
          FROM temp_skucycledtl)
        -- and a.qty >0
        AND a.locationId NOT LIKE 'SORTATION%'
        AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
                codeId
              FROM BSM_CODE bc
              WHERE organizationId = 'OJV_CML'
              AND codeType = 'LOC_CAT'
              AND activeFlag = 'Y') END
        AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
                udf04
              FROM BAS_LOCATION bl
              WHERE organizationId = IN_organizationId
              AND warehouseId = IN_warehouseId) END
        GROUP BY a.organizationId,
                 a.warehouseId,
                 a.customerId,
                 a.locationid,
                 a.sku,
                 b.skudescr1,
                 d.uomdescr,
                 c.lotatt08,
                 c.lotatt02
        ORDER BY a1.locationId;

        DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

        OPEN cyc_details_sku;

        SELECT
          IN_organizationId,
          IN_warehouseId,
          IN_idDocumentCycle,
          IN_userCount,
          IN_dateFrom,
          IN_dateTo;

      read_loop:
        LOOP
          FETCH cyc_details_sku INTO v_idDocumentCycle, v_idDocumentDetailCycle,
          v_organizationId, v_warehouseId,
          v_customerId, v_location, v_sku, v_skuDescr,
          v_qtyOnHand, v_uom, v_status, v_lotnum,
          v_batch, v_expDate, v_traceid, v_picksequence;

          SET v_hitungRow = v_hitungRow + 1;

          IF done THEN
            LEAVE read_loop;
          END IF;

          INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
          location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
          countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
            SELECT
              v_idDocumentCycle,
              v_idDocumentDetailCycle,
              v_organizationId,
              v_warehouseId,
              v_customerId,
              v_location,
              v_sku,
              v_skuDescr,
              v_qtyOnHand,
              v_uom,
              v_status,
              v_lotnum,
              v_batch,
              v_expDate,
              v_traceid,
              NULL count1,
              NULL count2,
              NULL count3,
              NULL countFinal,
              NULL countDifferent,
              'UNMATCH' countStatus,
              NOW() addTime,
              IN_userId addWho,
              NOW() editTime,
              IN_userId editWho,
              'N' findingFlag,
              v_idDocumentDetailCycle,
              v_picksequence;

        END LOOP;
        SELECT
          v_hitungRow;
        CLOSE cyc_details_sku;

        DROP TEMPORARY TABLE IF EXISTS temp_skucycledtl;
        COMMIT;
      END;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (SKU) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LL' THEN
    BEGIN
      DECLARE cyc_details_ll CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        '' AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      -- and a.sku is null
      -- and a.qty >0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt02
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_ll;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_ll INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_ll;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location All) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LE' THEN
    BEGIN
      DECLARE cyc_details_le CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        '' AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      AND a.sku IS NULL
      -- and a.qty >0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt02
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_le;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_le INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_le;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location Empty) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LA' THEN
    BEGIN
      DECLARE cyc_details_la CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        SUM(a.qty) AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        --		a.lotnum as LotNum,
        --		c.lotatt04 as Batch,
        --		c.lotatt02 as ExpDate,
        --		a.traceid as Traceid 
        '' AS LotNum,
        '' AS Batch,
        c.lotatt02 AS ExpDate,
        '' AS Traceid,
        a1.pickLogicalSequence
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      -- and a.sku is null
      AND a.qty > 0
      AND CASE WHEN IN_locCategory <> '_NULL_' THEN a1.locationCategory = IN_locCategory ELSE a1.locationCategory IN (SELECT
              codeId
            FROM BSM_CODE bc
            WHERE organizationId = 'OJV_CML'
            AND codeType = 'LOC_CAT'
            AND activeFlag = 'Y') END
      AND CASE WHEN IN_levCategory <> '_NULL_' THEN a1.udf04 = IN_levCategory ELSE a1.udf04 IN (SELECT DISTINCT
              udf04
            FROM BAS_LOCATION bl
            WHERE organizationId = IN_organizationId
            AND warehouseId = IN_warehouseId) END
      GROUP BY a.organizationId,
               a.warehouseId,
               a.customerId,
               a.locationid,
               a.sku,
               b.skudescr1,
               d.uomdescr,
               c.lotatt08,
               c.lotatt02
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_la;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_la INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid, v_picksequence;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag, countingSequence)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle,
            v_picksequence;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_la;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location with SOH) belum ada!!');
    		LEAVE ENDPROC;	
    		*/
    END IF;

    SELECT
      IN_organizationId,
      IN_warehouseId,
      IN_idDocumentCycle,
      cnt_userCount,
      myreturncode;
    CALL Z_CYCLEGROUPINFO_UPDATE(IN_organizationId, IN_warehouseId, IN_idDocumentCycle, cnt_userCount, myreturncode);

  END
  $$

--
-- Create procedure `SPASN_Reserve_Cancel`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPASN_Reserve_Cancel (IN IN_organizationId varchar(20),
IN IN_warehouse varchar(20),
IN IN_By varchar(10),
IN IN_ASNNo varchar(20),
IN IN_ASNLineNO int,
IN IN_TraceID varchar(30),
IN In_Language varchar(10),
IN In_UserID varchar(35),
INOUT OUT_Return_Code varchar(500))
ENDPROC:
  BEGIN

    DECLARE r_CurrentTime timestamp;
    DECLARE v_nrow_Trace int;
    DECLARE r_TraceID varchar(30);
    DECLARE r_ASNLineNO int;
    DECLARE r_CustomerID varchar(35);
    DECLARE r_SKU varchar(50);
    DECLARE r_PackID varchar(20);
    DECLARE r_UOM varchar(10);
    DECLARE r_LotNUM varchar(10);
    DECLARE r_PlanToLoc varchar(30);
    DECLARE r_ExpectedQty decimal(18, 8);
    DECLARE r_ExpectedQty_Each decimal(18, 8);
    DECLARE r_TotalGrossWeight decimal(18, 8);
    DECLARE r_TotalCubic decimal(18, 8);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE cCUR_ASN CURSOR FOR
    SELECT
      TraceID,
      ASNLineNO,
      CustomerID,
      SKU,
      PackID,
      packUOM,
      LotNUM,
      PlanToLoc,
      ExpectedQty,
      ExpectedQty_Each,
      TotalGrossWeight,
      TotalCubic
    FROM DOC_TRACE_DETAILS
    WHERE (oraganizationId = In_oraganizaionId
    AND warehouseId = In_warehouse
    AND ASNNO = IN_ASNNo
    AND ReceivedQty_Each = 0
    AND TRIM(PlanToLoc) IS NOT NULL
    AND TRIM(PlanToLoc) <> '*'
    AND Reserve_Flag = 'Y'
    AND IN_By = 'ASNNO')
    OR (oraganizationId = In_oraganizaionId
    AND warehouseId = In_warehouse
    AND ASNNO = IN_ASNNO
    AND ASNLineNO = IN_ASNLineNO
    AND ReceivedQty_Each = 0
    AND TRIM(PlanToLoc) IS NOT NULL
    AND TRIM(PlanToLoc) <> '*'
    AND Reserve_Flag = 'Y'
    AND UPPER(IN_By) = UPPER('ASNLineNO'))
    OR (oraganizationId = In_oraganizaionId
    AND warehouseId = In_warehouse
    AND ASNNO = IN_ASNNo
    AND TraceID = IN_TraceID
    AND ASNLineNO = IN_ASNLineNO
    AND ReceivedQty_Each = 0
    AND TRIM(PlanToLoc) IS NOT NULL
    AND TRIM(PlanToLoc) <> '*'
    AND Reserve_Flag = 'Y'
    AND UPPER(IN_By) = UPPER('TraceID'));
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPASN_Reserve_Cancel,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;
    SET v_error = 1;
    IF OUT_Return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET R_CurrentTime = NOW();
    SET Out_Return_Code = '000';
    IF UPPER(IN_By) NOT IN ('ASNNO', UPPER('ASNLineNO'), UPPER('TraceID')) THEN
      SET OUT_Return_Code = '887SPASN_Reserve_Cancel';
      LEAVE ENDPROC;
    END IF;
    OPEN cCUR_ASN;
    SET v_error = 1;
    FETCH cCUR_ASN INTO r_TraceID, r_ASNLineNO, r_CustomerID, r_SKU
    , r_PackID, r_UOM, r_LotNUM, r_PlanToLoc
    , r_ExpectedQty, r_ExpectedQty_Each
    , r_TotalGrossWeight, r_TotalCubic;
    WHILE v_error <> 0 DO
      SELECT
        COUNT(1)
      FROM DOC_TRACE_DETAILS
      WHERE oraganizationId = In_oraganizaionId
      AND warehouseId = In_warehouse
      AND ASNNO = IN_ASNNo
      AND TraceID = r_TraceID INTO v_nRow;
      IF v_nRow = 1 THEN
        UPDATE INV_LOT_LOC_ID
        SET QTYPA = QTYPA - r_Expectedqty_Each,
            EditTime = R_CurrentTime,
            EditWho = IN_UserID
        WHERE oraganizationId = In_oraganizaionId
        AND warehouseId = In_warehouse
        AND LotNum = r_LotNum
        AND LocationID = r_PlanToLoc
        AND TraceID = r_TraceID;
        IF ROW_COUNT() = 0 THEN
          SET OUT_Return_Code = 'INV_LOT_LOC_ID,UPDATE';
          CLOSE cCUR_ASN;
          LEAVE ENDPROC;
        END IF;
        UPDATE DOC_TRACE_DETAILS
        SET PlanToLoc = '',
            Reserve_Flag = 'N',
            EditTime = R_CurrentTime,
            EditWho = IN_UserID
        WHERE oraganizationId = In_oraganizaionId
        AND warehouseId = In_warehouse
        AND ASNNO = iN_ASNNo
        AND ASNLineNO = r_ASNLineNO
        AND TraceID = r_TraceID;
        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS
        WHERE oraganizationId = In_oraganizaionId
        AND warehouseId = In_warehouse
        AND ASNNO = IN_ASNNo
        AND ASNLineNO = r_ASNLineNO
        AND TRIM(PlanToLoc) IS NOT NULL
        AND TRIM(PlanToLoc) <> '*' INTO v_nrow;
        IF v_nrow = 0 THEN
          UPDATE DOC_ASN_DETAILS
          SET Reserve_Flag = 'N',
              EditTime = R_CurrentTime,
              EditWho = IN_UserID
          WHERE oraganizationId = In_oraganizaionId
          AND warehouseId = In_warehouse
          AND ASNNO = IN_ASNNo
          AND ASNLineNO = r_ASNLineNO;
        END IF;
      END IF;
      IF v_NO_COMMIT = 'Y' THEN
        COMMIT;
      END IF;
      SET v_error = 1;
      FETCH cCUR_ASN INTO r_TraceID, r_ASNLineNO, r_CustomerID, r_SKU
      , r_PackID, r_UOM, r_LotNUM, r_PlanToLoc
      , r_ExpectedQty, r_ExpectedQty_Each
      , r_TotalGrossWeight, r_TotalCubic;
    END WHILE;
    CLOSE cCUR_ASN;
    SELECT
      COUNT(1)
    FROM DOC_ASN_DETAILS
    WHERE oraganizationId = In_oraganizaionId
    AND warehouseId = In_warehouse
    AND ASNNO = IN_ASNNo
    AND Reserve_Flag = 'Y' INTO v_nRow;
    IF v_nRow = 0 THEN
      UPDATE DOC_ASN_HEADER
      SET Reserve_Flag = 'N',
          EditTime = R_CurrentTime,
          EditWho = IN_UserID
      WHERE oraganizationId = In_oraganizaionId
      AND warehouseId = In_warehouse
      AND ASNNO = IN_ASNNo;
    END IF;
    IF v_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `SPASN_Receiving_Process_N`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPASN_Receiving_Process_N (IN IN_organizationId varchar(20),
IN In_warehouseID varchar(20),
IN In_Process_Action varchar(10),



IN In_ASNNo_C varchar(20),
IN In_ASNLineNo_C varchar(20),
IN In_FMTraceID_C varchar(30),
IN In_New_TraceID_C varchar(30),
IN In_ProductStatus varchar(2),
IN In_ProductStatus_Descr varchar(10),
IN In_HoldRejectCode_C varchar(10),
IN In_HoldRejectReason_C varchar(20),
IN In_PONo_C varchar(20),
IN In_CustomerID varchar(20),
IN In_SKU varchar(50),
IN In_ReceivedQty varchar(10),
IN In_RejectedQty varchar(10),
IN In_UOM varchar(10),
IN In_PackID varchar(10),
IN In_ContainerID varchar(10),



IN In_LotAtt01_C varchar(200),
IN In_LotAtt02_C varchar(200),
IN In_LotAtt03_C varchar(200),
IN In_LotAtt04_C varchar(200),
IN In_LotAtt05_C varchar(200),
IN In_LotAtt06_C varchar(200),
IN In_LotAtt07_C varchar(200),
IN In_LotAtt08_C varchar(200),
IN In_LotAtt09_C varchar(200),
IN In_LotAtt10_C varchar(200),
IN In_LotAtt11_C varchar(200),
IN In_LotAtt12_C varchar(200),
IN In_LotAtt13_C varchar(200),
IN In_LotAtt14_C varchar(200),
IN In_LotAtt15_C varchar(200),
IN In_LotAtt16_C varchar(200),
IN In_LotAtt17_C varchar(200),
IN In_LotAtt18_C varchar(200),
IN In_LotAtt19_C varchar(200),
IN In_LotAtt20_C varchar(200),
IN In_LotAtt21_C varchar(200),
IN In_LotAtt22_C varchar(200),
IN In_LotAtt23_C varchar(200),
IN In_LotAtt24_C varchar(200),
IN In_TotalCubic varchar(10),
IN In_TotalGrossWeight varchar(10),
IN In_TotalNetWeight varchar(10),
IN In_TotalPrice varchar(10),
IN In_UserDefine1 varchar(20),
IN In_UserDefine2 varchar(20),
IN In_UserDefine3 varchar(20),
IN In_UserDefine4 varchar(20),
IN In_UserDefine5 varchar(20),
IN In_FMLocation varchar(20),
IN In_TOLocation_C varchar(20),
IN In_QC_Type_C varchar(20),
IN In_PlanToLoc_C varchar(20),
IN In_ReceivingTime varchar(20),
IN In_LPN varchar(20),
IN In_Operator_C varchar(20),
IN IN_RCVModule varchar(20),
IN IN_RCVStation varchar(20),
IN In_Language varchar(20),
IN In_UserID varchar(20),
OUT OUT_New_TraceID varchar(20),
OUT OUT_Return_LotNum varchar(20),
OUT OUT_Return_Toloc varchar(20),
INOUT OUT_Return_Code varchar(20))
ENDPROC:
  BEGIN

    DECLARE R_ReceivingTime timestamp;
    DECLARE R_ReceivingTimeDTL timestamp;
    DECLARE R_Return_LotNum varchar(10);
    DECLARE R_TransactionID varchar(20);
    DECLARE R_QTY1_P decimal(18, 8);
    DECLARE R_QTY2_P decimal(18, 8);
    DECLARE R_QTY3_P decimal(18, 8);
    DECLARE R_QTY4_P decimal(18, 8);
    DECLARE R_QTY5_P decimal(18, 8);
    DECLARE R_UOMQty_Read decimal(18, 8);
    DECLARE R_LineStatus varchar(2);
    DECLARE R_CurrentTime timestamp;
    DECLARE R_PackID_ASN varchar(40);
    DECLARE R_UOM_ASN varchar(10);
    DECLARE R_ExpectedQty_ASN decimal(18, 8);
    DECLARE R_ExpectedQty_Each_ASN decimal(18, 8);
    DECLARE R_RejectedQty_ASN decimal(18, 8);
    DECLARE R_RejectedQty_Each_ASN decimal(18, 8);
    DECLARE R_ReceivedQty_ASN decimal(18, 8);
    DECLARE R_ReceivedQty_Each_ASN decimal(18, 8);
    DECLARE R_ReceivedQty_Each_TRACE decimal(18, 8);
    DECLARE R_ExpectedQty_Each_Trace decimal(18, 8);
    DECLARE R_UOMQty_ASN decimal(18, 8);
    DECLARE R_PONO varchar(20);
    DECLARE R_POLineNO int;
    DECLARE R_PackID_PO varchar(40);
    DECLARE R_UOM_PO varchar(10);
    DECLARE R_OrderedQty_PO decimal(18, 8);
    DECLARE R_OrderedQty_Each_PO decimal(18, 8);
    DECLARE R_RejectedQty_Each_PO decimal(18, 8);
    DECLARE R_ReceivedQty_PO decimal(18, 8);
    DECLARE R_ReceivedQty_Each_PO decimal(18, 8);
    DECLARE R_Receive_Qty_Current decimal(18, 8);
    DECLARE R_UOMQty_PO decimal(18, 8);
    DECLARE R_DocType varchar(20);
    DECLARE R_ReceivedQty_Each decimal(18, 8);
    DECLARE R_LocationUsage varchar(2);
    DECLARE R_LogicalFMSequence varchar(20);
    DECLARE R_LogicalTOSequence varchar(20);
    DECLARE R_HOLD_FLAG char(1);
    DECLARE R_QC_Sequence varchar(10);
    DECLARE R_PA_TaskID varchar(20);
    DECLARE R_PA_FLag char(1);
    DECLARE R_PA_Sequence varchar(10);
    DECLARE R_FMQty_Each decimal(18, 8);
    DECLARE R_FMQty decimal(18, 8);
    DECLARE R_FMUOM varchar(10);
    DECLARE R_FMPackID varchar(40);
    DECLARE R_LoseID_Flag char(1);
    DECLARE R_MaxPATaskID_Sequence int;
    DECLARE R_MaxQCTaskID_Sequence int;
    DECLARE R_PATaskID varchar(20);
    DECLARE R_PATaskID_Sequence int;
    DECLARE R_QCTaskID varchar(10);
    DECLARE R_QCTaskID_Sequence int;
    DECLARE R_LocationHold char(1);
    DECLARE R_Mix_Flag char(1);
    DECLARE R_Mix_LotFlag char(1);
    DECLARE R_Qty_PlanPutaway decimal(18, 8);

    DECLARE R_Return_ToLoc varchar(20);
    DECLARE R_ReserveCode varchar(2);

    DECLARE R_InboundLifeDays int;
    DECLARE R_Flag char(1);
    DECLARE R_RCV_CTL varchar(40);
    DECLARE R_OverReceiving varchar(40);
    DECLARE R_PLT_RCV varchar(40);
    DECLARE R_EXP_CTL varchar(40);
    DECLARE R_ASN_RCV_UPD varchar(40);
    DECLARE R_LotAtt01_Flag char(1);
    DECLARE R_LotAtt02_Flag char(1);
    DECLARE R_LotAtt03_Flag char(1);
    DECLARE R_LotAtt04_Flag char(1);
    DECLARE R_LotAtt05_Flag char(1);
    DECLARE R_LotAtt06_Flag char(1);
    DECLARE R_LotAtt07_Flag char(1);
    DECLARE R_LotAtt08_Flag char(1);
    DECLARE R_LotAtt09_Flag char(1);
    DECLARE R_LotAtt10_Flag char(1);
    DECLARE R_LotAtt11_Flag char(1);
    DECLARE R_LotAtt12_Flag char(1);
    DECLARE R_AsnRef1ToLot4 char(1);
    DECLARE R_AsnRef2ToLot5 char(1);
    DECLARE R_AsnRef3ToLot6 char(1);
    DECLARE R_AsnRef4ToLot7 char(1);
    DECLARE R_AsnRef5ToLot8 char(1);
    DECLARE R_ASNReference1 varchar(50);
    DECLARE R_ASNReference2 varchar(240);
    DECLARE R_ASNReference3 varchar(50);
    DECLARE R_ASNReference4 varchar(50);
    DECLARE R_ASNReference5 varchar(50);
    DECLARE R_OverRCVPercentage decimal(18, 4);
    DECLARE R_OverRCVPercentage_SKU decimal(18, 4);
    DECLARE R_OverRCVPercentage_Customer decimal(18, 4);
    DECLARE R_OverRCVPercentage_ASN decimal(18, 4);
    DECLARE R_BAS_PAC_CHK varchar(40);
    DECLARE R_BAS_LOT_CHK varchar(40);
    DECLARE R_BAS_GWT_CHK varchar(40);
    DECLARE R_BAS_CUB_CHK varchar(40);
    DECLARE R_SKU_LOTID varchar(10);
    DECLARE R_SKU_PackID varchar(40);
    DECLARE R_SKU_GrossWeight decimal(18, 8);
    DECLARE R_SKU_Cube decimal(18, 8);
    DECLARE R_Hold_EP varchar(40);
    DECLARE R_PRT_PTA_LBL varchar(40);
    DECLARE R_CopyPackIDToLotAtt12 char(1);
    DECLARE R_Reserve_Flag char(1);
    DECLARE In_LotAtt01 varchar(100);
    DECLARE In_LotAtt02 varchar(100);
    DECLARE In_LotAtt03 varchar(100);
    DECLARE In_LotAtt04 varchar(100);
    DECLARE In_LotAtt05 varchar(240);
    DECLARE In_LotAtt06 varchar(100);
    DECLARE In_LotAtt07 varchar(100);
    DECLARE In_LotAtt08 varchar(100);
    DECLARE In_LotAtt09 varchar(100);
    DECLARE In_LotAtt10 varchar(100);
    DECLARE In_LotAtt11 varchar(100);
    DECLARE In_LotAtt12 varchar(100);
    DECLARE In_LotAtt13 varchar(200);
    DECLARE In_LotAtt14 varchar(200);
    DECLARE In_LotAtt15 varchar(200);
    DECLARE In_LotAtt16 varchar(200);
    DECLARE In_LotAtt17 varchar(200);
    DECLARE In_LotAtt18 varchar(200);
    DECLARE In_LotAtt19 varchar(200);
    DECLARE In_LotAtt20 varchar(200);
    DECLARE In_LotAtt21 varchar(200);
    DECLARE In_LotAtt22 varchar(200);
    DECLARE In_LotAtt23 varchar(200);
    DECLARE In_LotAtt24 varchar(200);
    DECLARE In_HoldRejectCode varchar(10);
    DECLARE In_HoldRejectReason varchar(100);
    DECLARE In_New_TraceID varchar(40);
    DECLARE In_New_TraceID_OLD varchar(40);
    DECLARE In_TOLocation varchar(10);
    DECLARE In_Create_NewTraceID char(1);
    DECLARE In_QC_Type varchar(20);
    DECLARE In_FMTraceID varchar(40);
    DECLARE In_PlanToLoc varchar(10);
    DECLARE In_ASNNo varchar(20);
    DECLARE In_ASNLineNo int;
    DECLARE In_PONo varchar(20);
    DECLARE In_Operator varchar(30);
    DECLARE sp_SQL_r varchar(4000);
    DECLARE R_UNT_PRI_CTL varchar(40);
    DECLARE R_ASN_MDT_CHK varchar(40);
    DECLARE R_RCV_TID_CTL varchar(40);
    DECLARE R_RCV_TIM_CTL char(1);
    DECLARE R_PCK_LOS_SN char(1);
    DECLARE R_ExpectedArriveTime1 timestamp;
    DECLARE R_ExpectedArriveTime2 timestamp;
    DECLARE R_ZoneGroup varchar(10);
    DECLARE R_PTA_CLS_CHK char(1);
    DECLARE R_QC_RCV_CTL char(1);
    DECLARE R_QCStatus varchar(2);
    DECLARE R_ASNType varchar(20);
    DECLARE R_RCV_MIX_TID char(1);
    DECLARE R_RCV_MIX_SKU char(1);
    DECLARE R_SKUCount int;
    DECLARE R_TotalGrossWeight decimal(18, 8);
    DECLARE R_TotalCubic decimal(18, 8);
    DECLARE R_TotalNetWeight decimal(18, 8);
    DECLARE R_TotalPrice decimal(18, 8);
    DECLARE R_TaskQty decimal(18, 8);
    DECLARE R_TaskQty_Each decimal(18, 8);
    DECLARE R_TaskUOM varchar(10);
    DECLARE R_TaskGrossWeight decimal(18, 8);
    DECLARE R_TaskCubic decimal(18, 8);
    DECLARE R_TaskNetWeight decimal(18, 8);
    DECLARE R_TaskPrice decimal(18, 8);
    DECLARE R_BreakQty decimal(18, 8);
    DECLARE R_BreakQty_1 decimal(18, 8);
    DECLARE R_OpenQty decimal(18, 8);
    DECLARE R_RCV_BRK_TSK varchar(1);
    DECLARE R_TMPID varchar(15);
    DECLARE R_ASN_GEN_TID char(1);
    DECLARE R_UOM varchar(10);
    DECLARE v_strsql varchar(4000);
    DECLARE R_UDFParameter varchar(200);
    DECLARE R_WarehouseID varchar(30);
    DECLARE R_ReleaseStatus char(1);
    DECLARE R_ASNStatus varchar(2);
    DECLARE R_QtyMVOut decimal(18, 8);
    DECLARE R_SeqNo int;
    DECLARE R_LOT_12_PKG char(1);
    DECLARE R_TraceUOM varchar(10);
    DECLARE R_PlanToLoc_Trace varchar(20);
    DECLARE R_LineStatus_Trace char(2);
    DECLARE R_LPN varchar(30);
    DECLARE R_Priority char(1);

    DECLARE r_ASNContainerID varchar(30);
    DECLARE R_LocationAttribute char(2);
    DECLARE R_RCV_CRS_ARA char(1);
    DECLARE R_POLineStatus char(2);
    DECLARE R_AllowReceiving char(1);
    DECLARE R_ASN_LNK_PO char(1);
    DECLARE R_Lotnum_Trace varchar(30);
    DECLARE R_CancelQty_Trace decimal(18, 8);
    DECLARE R_UDF1 varchar(50);
    DECLARE R_QCQty_reject decimal(18, 8);
    DECLARE R_QCQTY_Pass decimal(18, 8);
    DECLARE R_EACanCalcLoc char(1);
    DECLARE R_OVR_RCV_BY varchar(30);
    DECLARE R_NO_COMMIT char(1);
    DECLARE R_IN_Label1 char(1);
    DECLARE R_IN_Label3 char(1);
    DECLARE R_IN_Label4 char(1);
    DECLARE R_SN_CTL char(1);
    DECLARE R_QC_PTA_CTL char(1);
    DECLARE R_QC_FRM_TRN varchar(20);
    DECLARE R_QCNO varchar(30);
    DECLARE R_QCLineNo int;
    DECLARE R_QCRULE varchar(30);
    DECLARE R_QCPoint varchar(15);
    DECLARE R_sampleqty int;
    DECLARE R_minqty int;
    DECLARE R_percentage decimal(5, 2);
    DECLARE R_QCQTY int;
    DECLARE R_IND_MED char(1);
    DECLARE R_PopInfo varchar(300);
    DECLARE R_GMPValidTo varchar(20);
    DECLARE R_ApprovalNoValidTo varchar(20);
    DECLARE R_ValidDateTo varchar(20);
    DECLARE R_RCV_MIX_GR1 char(1);
    DECLARE R_SKU_Group1 varchar(60);
    DECLARE R_UDF2_AD varchar(20);
    DECLARE R_UDF2_IN varchar(20);
    DECLARE R_QTY_DEC int;
    DECLARE R_ReservedField16 varchar(100);
    DECLARE R_IND_TEX char(1);
    DECLARE R_ShelfLifeFlag char(1);
    DECLARE R_ShelfLifeType char(1);
    DECLARE R_LocType varchar(20);
    DECLARE In_New_TraceID_loop varchar(30);
    DECLARE R_LOTKEY01 char(1);
    DECLARE R_LOTKEY02 char(1);
    DECLARE R_LOTKEY03 char(1);
    DECLARE R_LOTKEY04 char(1);
    DECLARE R_LOTKEY05 char(1);
    DECLARE R_LOTKEY06 char(1);
    DECLARE R_LOTKEY07 char(1);
    DECLARE R_LOTKEY08 char(1);
    DECLARE R_LOTKEY09 char(1);
    DECLARE R_LOTKEY10 char(1);
    DECLARE R_LOTKEY11 char(1);
    DECLARE R_LOTKEY12 char(1);
    DECLARE R_SupplierId varchar(30);
    DECLARE r_packingbox_lotnum varchar(30);
    DECLARE v_boxbatchno int;
    DECLARE v_boxcustomerid varchar(30);
    DECLARE v_boxpackingbox varchar(30);
    DECLARE v_boxqty decimal(18, 8);

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE V_S varchar(100);
    DECLARE v_lotAttId varchar(20);
    DECLARE V_lotAttFlag char(1);
    DECLARE V_lotKey char(1);
    DECLARE V_lotAttValue varchar(100);

    DECLARE C_ACT CURSOR FOR
    SELECT
      SUM(a.BreakQty_Each),
      SUM(a.BreakQty),
      a.BreakUOM,
      SUM(a.GrossWeight),
      SUM(a.Cubic),
      SUM(a.NetWeight),
      SUM(a.Price),
      a.Location,
      a.traceid,
      b.putawayLogicalSequence,
      LocType
    FROM TMP_PUTAWAY_TASK a
      LEFT JOIN BAS_LOCATION b
        ON a.Location = b.Locationid
        AND b.organizationId = In_organizationId
        AND b.warehouseId = In_warehouseId

    GROUP BY a.Location,
             a.traceid,
             a.BreakUOM,
             b.putawayLogicalSequence,
             LocType;
    DECLARE c_box CURSOR FOR
    SELECT
      p.batchno,
      p.customerid,
      p.packingbox,
      p.qty
    FROM DOC_ASN_PACKINGBOX p
    WHERE p.asnno = In_ASNNo
    AND p.asnlineno = In_ASNLineNo
    AND p.receiveflag = 'N'
    AND IFNULL(p.transactionid, '*') = '*';

    DECLARE C_LOTID CURSOR FOR
    SELECT
      `lotAttId`,
      `lotAttFlag`,
      `lotKey`
    FROM `BAS_LOTID_DETAILS` p
    WHERE p.`organizationId` = In_organizationId
    AND p.`lotId` = r_SKU_LOTID;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code;
    END;
    SET autocommit = 0;
    SET v_error = 1;
    IF OUT_return_Code = 'NO_COMMIT'
      OR OUT_return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET R_CurrentTime = NOW();
    SET Out_Return_Code = '000';
    IF IN_ReceivingTime IS NULL THEN
      SET R_ReceivingTime = NOW();
    ELSE
      SET R_ReceivingTime = DATE_FORMAT(IN_ReceivingTime, '%Y-%m-%d %H:%i:%s');
    END IF;

    IF IFNULL(In_LPN, '*') <> '*' THEN
      SET r_LPN = In_LPN;
    ELSE
      SET r_LPN = '*';
    END IF;

    IF IN_Operator IS NULL THEN
      SET IN_Operator = In_UserID;
    END IF;

    SET V_S = GETSYS_configuration(IN_OrganizationId, IN_WarehouseID, IN_CustomerID, '', 'TRN_TYP');
    IF INSTR(V_S, 'AD') > 0 THEN
      SET r_UDF2_AD = 'N';
    ELSE
      SET r_UDF2_AD = 'O';
    END IF;

    IF INSTR(V_S, 'IN') > 0 THEN
      SET r_UDF2_IN = 'N';
    ELSE
      SET r_UDF2_IN = 'O';
    END IF;


    SET R_Qty_PlanPutaway = 0;
    SET R_QCTaskID = '*';
    SET R_HOLD_FLAG = 'N';
    SET R_PA_TaskID = '*';
    SET R_PA_Flag = 'N';
    SET R_QC_Sequence = 0;
    SET R_PA_Sequence = 0;
    SET R_Reserve_Flag = 'N';
    SET R_QtyMVOut = 0;
    SET r_TotalGrossWeight = In_TotalGrossWeight;
    SET r_TotalCubic = In_TotalCubic;
    SET r_TotalNetWeight = IFNULL(In_TotalNetWeight, 0);
    SET r_TotalPrice = In_TotalPrice;
    SET In_LotAtt01 = In_LotAtt01_C;
    SET In_LotAtt02 = In_LotAtt02_C;
    SET In_LotAtt03 = In_LotAtt03_C;
    SET In_LotAtt04 = In_LotAtt04_C;
    SET In_LotAtt05 = In_LotAtt05_C;
    SET In_LotAtt06 = In_LotAtt06_C;
    SET In_LotAtt07 = In_LotAtt07_C;
    SET In_LotAtt08 = In_LotAtt08_C;
    SET In_LotAtt09 = In_LotAtt09_C;
    SET In_LotAtt10 = In_LotAtt10_C;
    SET In_LotAtt11 = In_LotAtt11_C;
    SET In_LotAtt12 = In_LotAtt12_C;
    SET In_LotAtt13 = In_LotAtt13_C;
    SET In_LotAtt14 = In_LotAtt14_C;
    SET In_LotAtt15 = In_LotAtt15_C;
    SET In_LotAtt16 = In_LotAtt16_C;
    SET In_LotAtt17 = In_LotAtt17_C;
    SET In_LotAtt18 = In_LotAtt18_C;
    SET In_LotAtt19 = In_LotAtt19_C;
    SET In_LotAtt20 = In_LotAtt20_C;
    SET In_LotAtt21 = In_LotAtt21_C;
    SET In_LotAtt22 = In_LotAtt22_C;
    SET In_LotAtt23 = In_LotAtt23_C;
    SET In_LotAtt24 = In_LotAtt24_C;

    SET In_HoldRejectCode = In_HoldRejectCode_C;
    SET In_HoldRejectReason = In_HoldRejectReason_C;
    SET In_TOLocation = In_TOLocation_C;
    SET In_New_TraceID = IFNULL(In_New_TraceID_C, '*');

    SET In_QC_Type = In_QC_Type_C;
    SET In_FMTraceID = In_FMTraceID_C;
    SET In_ASNNo = In_ASNNo_C;
    SET In_ASNLineNo = In_ASNLineNo_C;
    SET In_PONo = In_PONo_C;
    SET In_PlanToLoc = In_PlanToLoc_C;
    SET v_nRow = 0;
    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET Out_Return_Code = '*_*';
    CALL SPUDF_ProcessA(IN_organizationId, In_warehouseID, 'RCV_BEFORE', IN_ASNNO, IN_ASNLineNo, IN_ReceivedQty, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;

  Loop1:
    BEGIN

      IF In_Process_Action = '2' THEN
        SET R_ReceivedQty_Each = In_ReceivedQty;
        SET r_FMQty = 0;
        SET r_FMQty_Each = 0;
        SET R_Return_LotNum = TRIM(In_ContainerID);
        SET v_error = 1;
        SELECT
          LotAtt01,
          LotAtt02,
          LotAtt03,
          LotAtt04,
          LotAtt05,
          LotAtt06,
          LotAtt07,
          LotAtt08,
          LotAtt09,
          LotAtt10,
          LotAtt11,
          LotAtt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND LotNum = R_Return_LotNum INTO IN_LotAtt01, IN_LotAtt02, IN_LotAtt03, IN_LotAtt04, IN_LotAtt05, IN_LotAtt06
        , IN_LotAtt07, IN_LotAtt08, IN_LotAtt09, IN_LotAtt10, IN_LotAtt11, IN_LotAtt12
        ;
        IF v_error = 0 THEN
          SET OUT_Return_Code = '888INV_LOT_ATT,OPEN';
          LEAVE ENDPROC;
        END IF;
        LEAVE Loop1;
      END IF;



      IF In_ReceivedQty <= 0
        AND IFNULL(IN_ProductStatus, '00') = '00' THEN
        SET Out_Return_Code = '204';
        LEAVE ENDPROC;
      END IF;




      SET v_error = 1;
      SELECT
        IFNULL(OverReceiving, 'N'),
        IFNULL(OverRCVPercentage, 0),
        IFNULL(ASN_LNK_PO, 'Y'),
        AsnRef1ToLot4,
        AsnRef2ToLot5,
        AsnRef3ToLot6,
        AsnRef4ToLot7,
        AsnRef5ToLot8
      FROM BAS_CUSTOMER
      WHERE organizationId = In_organizationId
      AND CustomerID = In_CustomerID
      AND CustomerType = 'OW' INTO R_OverReceiving, R_OverRCVPercentage_Customer, r_ASN_LNK_PO,
      R_AsnRef1ToLot4, R_AsnRef2ToLot5, R_AsnRef3ToLot6, R_AsnRef4ToLot7, R_AsnRef5ToLot8
      ;
      IF v_error = 0 THEN
        SET OUT_Return_Code = '888BAS_CUSTOMER,OPEN';
        LEAVE ENDPROC;
      END IF;
      SET v_error = 1;
      SELECT
        ASNReference1,
        ASNReference2,
        ASNReference3,
        ASNReference4,
        ASNReference5,
        IFNULL(ExpectedArriveTime1, DATE_FORMAT('2000-01-01 00:00:00', '%Y-%m-%d %H:%i:%s')),
        IFNULL(ExpectedArriveTime2, DATE_FORMAT('2099-12-31 00:00:00', '%Y-%m-%d %H:%i:%s')),
        QCStatus,
        ASNType,
        WarehouseID,
        ReleaseStatus,
        IFNULL(Priority, '3'),
        ASNStatus,
        Supplierid
      FROM DOC_ASN_HEADER
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouseID
      AND ASNNO = IN_ASNNo INTO r_ASNReference1, r_ASNReference2, r_ASNReference3, r_ASNReference4, r_ASNReference5,
      r_ExpectedArriveTime1, r_ExpectedArriveTime2,
      r_QCStatus, r_ASNType, r_WarehouseID
      , R_ReleaseStatus
      , r_Priority
      , r_ASNStatus
      , r_Supplierid
      FOR UPDATE;
      IF v_error = 0 THEN
        SET OUT_Return_Code = '888DOC_ASN_Header,OPEN';
        LEAVE ENDPROC;
      END IF;



      IF r_ASNStatus >= '90' THEN
        SET Out_Return_Code = '201';
        LEAVE ENDPROC;
      END IF;
      IF R_AsnRef1ToLot4 = 'Y'
        AND IFNULL(R_ASNReference1, '*') <> '*'
        AND IFNULL(IN_LotAtt04, '*') = '*' THEN
        SET IN_LotAtt04 = R_AsnReference1;
      END IF;
      IF R_AsnRef2ToLot5 = 'Y'
        AND IFNULL(R_ASNReference2, '*') <> '*'
        AND IFNULL(IN_LotAtt05, '*') = '*' THEN
        SET In_LotAtt05 = R_AsnReference2;
      END IF;
      IF R_AsnRef3ToLot6 = 'Y'
        AND IFNULL(R_ASNReference3, '*') <> '*'
        AND IFNULL(IN_LotAtt06, '*') = '*' THEN
        SET In_LotAtt06 = R_AsnReference3;
      END IF;
      IF R_AsnRef4ToLot7 = 'Y'
        AND IFNULL(R_ASNReference4, '*') <> '*'
        AND IFNULL(IN_LotAtt07, '*') = '*' THEN
        SET In_LotAtt07 = R_AsnReference4;
      END IF;
      IF R_AsnRef5ToLot8 = 'Y'
        AND IFNULL(R_ASNReference5, '*') <> '*'
        AND IFNULL(IN_LotAtt08, '*') = '*' THEN
        SET In_LotAtt08 = R_AsnReference5;
      END IF;
      IF In_LotAtt01 = 'YYYY-MM-DD' THEN
        SET In_LotAtt01 = NULL;
      END IF;
      IF In_LotAtt02 = 'YYYY-MM-DD' THEN
        SET In_LotAtt02 = NULL;
      END IF;
      IF In_LotAtt03 = 'YYYY-MM-DD' THEN
        SET In_LotAtt03 = NULL;
      END IF;


      IF IFNULL(IN_ProductStatus, '00') <> '00' THEN
        SELECT
          COUNT(1) + 1
        FROM DOC_ASN_EXCEPTION
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND ASNNO = IN_ASNNO
        AND ASNLineNo = IN_ASNLineNo INTO r_SeqNo;
        INSERT INTO DOC_ASN_EXCEPTION (organizationId, ASNNo, ASNLineNo, SeqNo, ExceptionCode, ExceptionDescr
        , CustomerID, SKU, QtyEach, ConfirmBy, ConfirmTime, Memo
        , LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05, LotAtt06
        , LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12
        , ADDTIME, AddWho, EditTime, EditWho, WarehouseID)
          VALUES (In_organizationId, IN_ASNNO, IN_ASNLineNo, r_SeqNo, IN_ProductStatus, IN_ProductStatus_Descr, IN_CustomerID, IN_SKU, IN_RejectedQty, '', NULL, '', IN_LotAtt01, IN_LotAtt02, IN_LotAtt03, IN_LotAtt04, IN_LotAtt05, IN_LotAtt06, IN_LotAtt07, IN_LotAtt08, IN_LotAtt09, IN_LotAtt10, IN_LotAtt11, IN_LotAtt12, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_WarehouseID);

        IF IFNULL(IN_ReceivedQty, 0) = 0 THEN

          SET v_error = 1;
          SELECT
            MAX(CASE WHEN packUom = 'EA' THEN qty ELSE 0 END) AS QTY1,
            MAX(CASE WHEN packUom = 'IP' THEN qty ELSE 0 END) AS QTY2,
            MAX(CASE WHEN packUom = 'CS' THEN qty ELSE 0 END) AS QTY3,
            MAX(CASE WHEN packUom = 'PL' THEN qty ELSE 0 END) AS QTY4,
            MAX(CASE WHEN packUom = 'OT' THEN qty ELSE 0 END) AS QTY5
          FROM BAS_PACKAGE_DETAILS
          WHERE organizationId = In_organizationId
          AND customerId = In_CustomerID
          AND PackID = In_PackID
          GROUP BY organizationId,
                   customerId,
                   PackID INTO r_QTY1_P, r_QTY2_P, r_QTY3_P, r_QTY4_P, r_QTY5_P;
          IF v_error = 0 THEN
            SET OUT_Return_Code = CONCAT('104', In_PackID);
            LEAVE ENDPROC;
          END IF;
          UPDATE DOC_ASN_DETAILS
          SET RejectedQty = (RejectedQty_Each + In_RejectedQty) / (CASE packUOM WHEN 'EA' THEN r_QTY1_P WHEN 'IP' THEN r_QTY2_P WHEN 'CS' THEN r_QTY3_P WHEN 'PL' THEN r_QTY4_P WHEN 'OT' THEN r_QTY5_P ELSE r_QTY1_P END),
              RejectedQty_Each = RejectedQty_Each + In_RejectedQty
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND ASNNo = In_ASNNo
          AND ASNLineNo = In_ASNLineNo;

          SET Out_Return_Code = '000';
          LEAVE ENDPROC;
        END IF;
      END IF;





      IF (IFNULL(In_LotAtt01, '') <> ''
        AND IFNULL(In_LotAtt02, '') <> ''
        AND In_LotAtt01 >= In_LotAtt02)
        OR (IFNULL(In_LotAtt01, '') <> ''
        AND In_LotAtt01 > DATE_FORMAT(r_CurrentTime, '%Y-%m-%d')) THEN
        SET Out_Return_Code = '260';
        LEAVE ENDPROC;
      END IF;
      SET r_ASN_MDT_CHK = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'ASN_MDT_CHK');

      IF r_ASN_MDT_CHK = 'Y'
        AND TRIM(IN_LotAtt01) IS NOT NULL THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.lotnum = b.lotnum
          INNER JOIN BAS_LOCATION c
            ON a.organizationId = c.organizationId
            AND a.warehouseId = c.warehouseId
            AND a.locationId = c.locationId
        WHERE a.organizationId = In_organizationId
        AND a.warehouseId = In_warehouseID
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND c.LocationUsage <> 'ST'
        AND b.LotAtt01 > IN_LotAtt01 INTO v_nRow;
        IF v_nRow > 0 THEN
          SET out_Return_Code = '266INV_LOT_LOC_ID';
          LEAVE ENDPROC;
        END IF;
      END IF;



      SET v_error = 1;

      SELECT
        a.LotID,
        IFNULL(OverRCVPercentage, 0),
        PackID,
        GrossWeight,
        `CUBE`,
        CopyPackIDToLotAtt12,
        AllowReceiving,
        a.SKU_Group1,
        a.InboundLifeDays,
        a.ShelfLifeFlag,
        a.ShelfLifeType,
        a.ReserveCode,
        ReservedField16,
        ReserveCode INTO r_SKU_LOTID, r_OverRCVPercentage_SKU, r_SKU_PackID, r_SKU_GrossWeight, r_SKU_Cube
      , r_CopyPackIDToLotAtt12, r_AllowReceiving, r_SKU_Group1
      , r_InboundLifeDays, r_ShelfLifeFlag, r_ShelfLifeType, r_ReserveCode, r_ReservedField16
      , R_ReserveCode
      FROM BAS_SKU a
      WHERE a.organizationId = In_organizationId
      AND a.CustomerID = In_CustomerID
      AND a.sku = IN_SKU;

      OPEN C_LOTID;
    EndLotID:
      LOOP
        FETCH C_LOTID INTO v_lotAttId, v_lotAttFlag, v_lotKey;
        IF v_error = 0 THEN
          LEAVE EndLotID;
        END IF;
        IF v_lotAttId = 'lotAtt01' THEN
          SET r_LotAtt01_Flag = v_lotAttFlag;
          SET r_LOTKEY01 = v_lotKey;
          SET V_lotAttValue = In_LotAtt01;
        ELSEIF v_lotAttId = 'lotAtt02' THEN
          SET r_LotAtt02_Flag = v_lotAttFlag;
          SET r_LOTKEY02 = v_lotKey;
          SET V_lotAttValue = In_LotAtt02;
        ELSEIF v_lotAttId = 'lotAtt03' THEN
          SET r_LotAtt03_Flag = v_lotAttFlag;
          SET r_LOTKEY03 = v_lotKey;
          SET V_lotAttValue = In_LotAtt03;
        ELSEIF v_lotAttId = 'lotAtt04' THEN
          SET r_LotAtt04_Flag = v_lotAttFlag;
          SET r_LOTKEY04 = v_lotKey;
          SET V_lotAttValue = In_LotAtt04;
        ELSEIF v_lotAttId = 'lotAtt05' THEN
          SET r_LotAtt05_Flag = v_lotAttFlag;
          SET r_LOTKEY05 = v_lotKey;
          SET V_lotAttValue = In_LotAtt05;
        ELSEIF v_lotAttId = 'lotAtt06' THEN
          SET r_LotAtt06_Flag = v_lotAttFlag;
          SET r_LOTKEY06 = v_lotKey;
          SET V_lotAttValue = In_LotAtt06;
        ELSEIF v_lotAttId = 'lotAtt07' THEN
          SET r_LotAtt07_Flag = v_lotAttFlag;
          SET r_LOTKEY07 = v_lotKey;
          SET V_lotAttValue = In_LotAtt07;
        ELSEIF v_lotAttId = 'lotAtt08' THEN
          SET r_LotAtt08_Flag = v_lotAttFlag;
          SET r_LOTKEY08 = v_lotKey;
          SET V_lotAttValue = In_LotAtt08;
        ELSEIF v_lotAttId = 'lotAtt09' THEN
          SET r_LotAtt09_Flag = v_lotAttFlag;
          SET r_LOTKEY09 = v_lotKey;
          SET V_lotAttValue = In_LotAtt09;
        ELSEIF v_lotAttId = 'lotAtt10' THEN
          SET r_LotAtt10_Flag = v_lotAttFlag;
          SET r_LOTKEY10 = v_lotKey;
          SET V_lotAttValue = In_LotAtt10;
        ELSEIF v_lotAttId = 'lotAtt11' THEN
          SET r_LotAtt11_Flag = v_lotAttFlag;
          SET r_LOTKEY11 = v_lotKey;
          SET V_lotAttValue = In_LotAtt11;
        ELSEIF v_lotAttId = 'lotAtt12' THEN
          SET r_LotAtt12_Flag = v_lotAttFlag;
          SET r_LOTKEY12 = v_lotKey;
          SET V_lotAttValue = In_LotAtt12;
        END IF;
        IF v_lotAttFlag = '3'
          AND V_lotAttValue IS NULL THEN
          SELECT
            '221',
            v_lotAttId,
            v_lotAttFlag,
            V_lotAttValue;
          SET OUT_Return_Code = CONCAT('221', In_ASNLineNo_C);
          LEAVE ENDPROC;
        END IF;
      END LOOP;
      CLOSE C_Lotid;

      IF (r_LotAtt01_Flag = '3'
        AND In_LotAtt01 IS NULL)
        OR (r_LotAtt02_Flag = '3'
        AND In_LotAtt02 IS NULL)
        OR (r_LotAtt03_Flag = '3'
        AND In_LotAtt03 IS NULL)
        OR (r_LotAtt04_Flag = '3'
        AND IN_LotAtt04 IS NULL)
        OR (r_LotAtt05_Flag = '3'
        AND In_LotAtt05 IS NULL)
        OR (r_LotAtt06_Flag = '3'
        AND In_LotAtt06 IS NULL)
        OR (r_LotAtt07_Flag = '3'
        AND In_LotAtt07 IS NULL)
        OR (r_LotAtt08_Flag = '3'
        AND In_LotAtt08 IS NULL)
        OR (r_LotAtt09_Flag = '3'
        AND IN_LotAtt09 IS NULL)
        OR (r_LotAtt10_Flag = '3'
        AND In_LotAtt10 IS NULL)
        OR (r_LotAtt11_Flag = '3'
        AND In_LotAtt11 IS NULL)
        OR (r_LotAtt12_Flag = '3'
        AND In_LotAtt12 IS NULL) THEN

        SET OUT_Return_Code = CONCAT('221', In_ASNLineNo_C);
        LEAVE ENDPROC;
      END IF;

      IF r_AllowReceiving = 'N' THEN
        SET out_Return_Code = CONCAT('117', IN_SKU);
        LEAVE ENDPROC;
      END IF;



      IF (r_LotAtt01_Flag = '1'
        AND In_LotAtt01 IS NOT NULL) THEN
        SET In_LotAtt01 = NULL;
      END IF;
      IF (r_LotAtt02_Flag = '1'
        AND In_LotAtt02 IS NOT NULL) THEN
        SET In_LotAtt02 = NULL;
      END IF;
      IF (r_LotAtt03_Flag = '1'
        AND In_LotAtt03 IS NOT NULL) THEN
        SET In_LotAtt03 = NULL;
      END IF;
      IF (r_LotAtt04_Flag = '1'
        AND In_LotAtt04 IS NOT NULL) THEN
        SET In_LotAtt04 = NULL;
      END IF;
      IF (r_LotAtt05_Flag = '1'
        AND In_LotAtt05 IS NOT NULL) THEN
        SET In_LotAtt05 = NULL;
      END IF;
      IF (r_LotAtt06_Flag = '1'
        AND In_LotAtt06 IS NOT NULL) THEN
        SET In_LotAtt06 = NULL;
      END IF;
      IF (r_LotAtt07_Flag = '1'
        AND In_LotAtt07 IS NOT NULL) THEN
        SET In_LotAtt07 = NULL;
      END IF;
      IF (r_LotAtt08_Flag = '1'
        AND In_LotAtt08 IS NOT NULL) THEN
        SET In_LotAtt08 = NULL;
      END IF;
      IF (r_LotAtt09_Flag = '1'
        AND In_LotAtt09 IS NOT NULL) THEN
        SET In_LotAtt09 = NULL;
      END IF;
      IF (r_LotAtt10_Flag = '1'
        AND In_LotAtt10 IS NOT NULL) THEN
        SET In_LotAtt10 = NULL;
      END IF;


      IF (r_LotAtt12_Flag = '1'
        AND In_LotAtt12 IS NOT NULL) THEN
        SET In_LotAtt12 = NULL;
      END IF;

      SET R_LOT_12_PKG = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'LOT_#12_PKG');
      IF R_LOT_12_PKG = 'Y'
        AND isnumeric(In_LotAtt12) = 0 THEN
        SET Out_Return_Code = '232';
        LEAVE ENDPROC;
      END IF;

      SET r_PopInfo = '';
      SET R_IND_MED = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'IND_MED');
      IF r_IND_MED = 'Y'
        AND IN_LotAtt01 IS NOT NULL THEN

        SELECT
          GMPValidTo
        FROM BAS_SKU_PHARMGMPCERT
        WHERE organizationId = In_organizationId
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU
        ORDER BY GMPValidFrom DESC
        LIMIT 1 INTO r_GMPValidTo;
        IF r_GMPValidTo IS NOT NULL THEN
          SET v_nRow = DATEDIFF(DATE_FORMAT(r_GMPValidTo, '%Y-%m-%d'), DATE_FORMAT(IN_LotAtt01, '%Y-%m-%d'));
          IF v_nRow <= 0 THEN
            SET OUT_Return_Code = '999#??GMP????,?????';
            LEAVE ENDPROC;
          ELSEIF v_nRow < 90 THEN
            SET r_PopInfo = CONCAT('??GMP????', v_nRow, '?????');
          END IF;
        END IF;

        SET v_error = 1;
        SELECT
          ApprovalNoValidTo
        FROM BAS_SKU_PHARMAPPROVALNO
        WHERE organizationId = In_organizationId
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU
        ORDER BY ApprovalNoValidFrom DESC
        LIMIT 1 INTO r_ApprovalNoValidTo;
        IF r_ApprovalNoValidTo IS NOT NULL THEN
          SET v_nRow = DATE_FORMAT(r_ApprovalNoValidTo, '%Y-%m-%d') - DATE_FORMAT(IN_LotAtt01, '%Y-%m-%d');
          IF v_nRow <= 0 THEN
            SET out_Return_Code = '999#????????,?????';
            LEAVE ENDPROC;
          ELSEIF v_nRow < 90 THEN
            SET r_PopInfo = CONCAT('????????', v_nRow, '?????');
          END IF;
        END IF;

        SELECT
          B.ValidDateTo
        FROM DOC_ASN_HEADER A
          INNER JOIN BAS_CUSTOMER B
            ON A.organizationId = B.organizationId
            AND A.SupplierID = B.CustomerID
            AND B.CustomerType = 'VE'
        WHERE A.organizationId = In_organizationId
        AND A.warehouseId = In_warehouseID
        AND A.ASNNo = IN_ASNNo
        LIMIT 1 INTO r_ValidDateTo;
        IF r_ValidDateTo IS NOT NULL THEN
          SET v_nRow = DATEDIFF(DATE_FORMAT(r_ValidDateTo, '%Y-%m-%d'), DATE_FORMAT(IN_LotAtt01, '%Y-%m-%d'));
          IF v_nRow <= 0 THEN
            SET out_Return_Code = '999#??????????,?????';
            LEAVE ENDPROC;
          ELSEIF v_nRow < 90 THEN
            SET r_PopInfo = CONCAT('??????????', v_nRow, '?????');
          END IF;
        END IF;
      END IF;


      IF r_OverRCVPercentage_SKU <> 0 THEN
        SET r_OverRCVPercentage = r_OverRCVPercentage_SKU;
      ELSE
        SET r_OverRCVPercentage = r_OverRCVPercentage_Customer;
      END IF;



      IF r_ReleaseStatus IN ('N', 'H') THEN
        SET Out_Return_Code = '226';
        LEAVE ENDPROC;
      END IF;







      SET R_BAS_PAC_CHK = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'BAS_PAC_CHK');

      SET R_BAS_LOT_CHK = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'BAS_LOT_CHK');

      SET R_BAS_GWT_CHK = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'BAS_GWT_CHK');

      SET R_BAS_CUB_CHK = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'BAS_CUB_CHK');

      SET R_UNT_PRI_CTL = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'UNT_PRI_CTL');

      SET R_PRT_PTA_LBL = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'PRT_PTA_LBL');

      SET r_ASN_GEN_TID = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'ASN_GEN_TID');

      SET r_ASN_RCV_UPD = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'ASN_RCV_UPD');

      SET r_RCV_CTL = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'RCV_CTL');

      SET r_EXP_CTL = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'EXP_CTL');

      SET r_PLT_RCV = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'PLT_RCV');

      SET r_RCV_CRS_ARA = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'RCV_CRS_ARA');

      SET r_RCV_TID_CTL = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'RCV_TID_CTL');

      SET R_OverReceiving = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'OVR_RCV');

      SET r_RCV_TIM_CTL = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'RCV_TIM_CTL');

      SET r_RCV_MIX_TID = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'RCV_MIX_TID');
      SET r_RCV_MIX_GR1 = getsys_configuration_D(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'RCV_MIX_GR1', 'Y');

      SET r_PTA_CLS_CHK = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'PTA_CLS_CHK');

      SET r_RCV_BRK_TSK = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'RCV_BRK_TSK');

      SET R_SN_CTL = getsys_configuration_D(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'SN#_CTL', '0');

      SET r_QC_RCV_CTL = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'QC_RCV_CTL');

      SET R_PCK_LOS_SN = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'PCK_LOS_SN#');

      SET r_IND_TEX = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'IND_TEX');

      SET r_QC_PTA_CTL = getsys_configuration(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'QC_PTA_CTL');

      SET r_QC_FRM_TRN = getsys_configuration_D(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'QC_FRM_TRN', 'MANU');


      IF R_BAS_PAC_CHK = 'Y'
        AND (R_SKU_PackID IS NULL) THEN
        SET OUT_Return_Code = CONCAT('110', IN_SKU);
        LEAVE ENDPROC;
      END IF;

      IF R_BAS_LOT_CHK = 'Y'
        AND (R_SKU_LotID IS NULL) THEN
        SET OUT_Return_Code = '111';
        LEAVE ENDPROC;
      END IF;

      IF R_BAS_GWT_CHK = 'Y'
        AND r_SKU_Grossweight = 0 THEN
        SET OUT_Return_Code = '112';
        LEAVE ENDPROC;
      END IF;

      IF R_BAS_CUB_CHK = 'Y'
        AND r_SKU_Cube = 0 THEN
        SET OUT_Return_Code = '113';
        LEAVE ENDPROC;
      END IF;

      IF r_UNT_PRI_CTL = 'Y' THEN
        IF IN_TotalPrice IS NULL
          OR IN_TotalPrice <= 0 THEN
          SET Out_Return_Code = '050';
          LEAVE ENDPROC;
        END IF;
      END IF;

      IF r_RCV_TIM_CTL = 'Y'
        AND (r_CurrentTime < r_ExpectedArriveTime1
        OR r_CurrentTime > r_ExpectedArriveTime2) THEN
        SET out_Return_Code = '271';
        LEAVE ENDPROC;
      END IF;

      SET v_error = 1;
      SELECT
        ExpectedQty_Each,
        ReceivedQty_Each,
        POLineNO,
        PONO,
        OverRCVPercentage,
        IFNULL(ContainerID, ''),
        IFNULL(QCStatus, '*')
      FROM DOC_ASN_DETAILS
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouseID
      AND ASNNO = In_ASNNo
      AND ASNLineNo = IN_AsnLineNo INTO r_ExpectedQty_Each_ASN, r_ReceivedQty_Each_ASN, r_POLineNO, r_PONO
      , R_OverRCVPercentage_ASN, r_ASNContainerID, r_QCStatus
      FOR UPDATE;
      IF v_error = 0 THEN
        SELECT
          *
        FROM DOC_ASN_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND ASNNO = In_ASNNo
        AND ASNLineNo = IN_AsnLineNo;
        SET OUT_Return_Code = CONCAT('104', In_ASNNo, ':', IN_AsnLineNo);
        LEAVE ENDPROC;
      END IF;

      IF r_ASNContainerID IS NOT NULL
        AND (IFNULL(IN_New_TraceID, '*') = '*') THEN
        SET In_New_TraceID = r_ASNContainerID;
      END IF;


      IF r_RCV_TID_CTL = 'Y'
        AND IFNULL(IN_New_TraceID, '*') = '*' THEN
        SET OUT_Return_Code = '270';
        LEAVE ENDPROC;
      END IF;


      IF In_TOLocation = '*'
        OR IFNULL(TRIM(In_TOLocation), '') = '' THEN
        SET In_TOLocation = In_FMLocation;
      END IF;







      SET v_error = 1;
      SELECT
        LocationUsage,
        IFNULL(LoseID_Flag, 'N'),
        IFNULL(Mix_Flag, 'Y'),
        IFNULL(Mix_LotFlag, 'Y'),
        LocationAttribute,
        SKUCount,
        `putawayLogicalSequence`
      FROM BAS_LOCATION
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouseID
      AND LocationID = In_TOLocation INTO R_LocationUsage, R_LoseID_Flag, R_Mix_Flag, R_Mix_LotFlag
      , r_LocationAttribute, r_SKUCount
      , r_LogicalFMSequence;
      IF v_error = 0 THEN
        SET OUT_Return_Code = CONCAT('104', In_TOLocation);
        LEAVE ENDPROC;
      END IF;

      IF UPPER(In_FMLocation) = 'SCANSTATION' THEN
        SET r_RCV_MIX_SKU = 'Y';
      ELSE
        SET r_RCV_MIX_SKU = getsys_configuration_D(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'RCV_MIX_SKU', 'Y');
      END IF;

      IF IN_New_TraceID <> '*'
        AND TRIM(IFNULL(In_New_TraceID, '')) <> '' THEN
        IF r_LoseID_Flag = 'N' THEN
          IF r_RCV_MIX_TID = 'N' THEN
            SELECT
              COUNT(1)
            FROM INV_LOT_LOC_ID a
            WHERE a.organizationId = In_organizationId
            AND a.WarehouseID = In_warehouseID
            AND a.TraceID = IN_New_TraceID
            AND a.qty > 0 INTO v_nRow;
            IF v_nRow > 0 THEN
              ROLLBACK;
              SET out_Return_Code = CONCAT('218???????ID=', IN_New_TraceID);
              LEAVE ENDPROC;
            END IF;
          END IF;
          IF r_RCV_MIX_TID <> 'N' THEN
            IF r_RCV_MIX_SKU = 'N' THEN
              SELECT
                COUNT(1)
              FROM INV_LOT_LOC_ID
              WHERE organizationId = In_organizationId
              AND warehouseId = In_warehouseID
              AND TraceID = IN_New_TraceID
              AND sku <> In_SKU
              AND qty > 0 INTO v_nRow;
              IF v_nRow > 0 THEN
                ROLLBACK;
                SET out_Return_Code = '273';
                LEAVE ENDPROC;
              END IF;
            ELSEIF r_RCV_MIX_GR1 = 'N' THEN
              SELECT
                COUNT(1)
              FROM INV_LOT_LOC_ID a
                INNER JOIN BAS_SKU c
                  ON a.CUSTOMERID = c.CUSTOMERID
                  AND a.SKU = c.SKU
                  AND a.organizationId = c.organizationId
              WHERE a.organizationId = In_organizationId
              AND a.WarehouseID = In_warehouseID
              AND a.TraceID = IN_New_TraceID
              AND c.SKU_GROUP1 <> r_SKU_Group1
              AND a.qty > 0 INTO v_nRow;
              IF v_nRow > 0 THEN
                ROLLBACK;
                SET out_Return_Code = '273';
                LEAVE ENDPROC;
              END IF;
            END IF;
            SELECT
              COUNT(1)
            FROM INV_LOT_LOC_ID
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND LocationID <> In_TOLocation
            AND TraceID = In_New_TraceID
            AND Qty > 0 INTO v_nRow;
            IF v_nRow > 0 THEN
              SET OUT_Return_Code = CONCAT('218', In_New_TraceID);
              LEAVE ENDPROC;
            END IF;
          END IF;
        ELSE
          SET In_New_TraceID = '*';
        END IF;

      END IF;

      IF r_QC_RCV_CTL = 'Y'
        AND r_QCStatus <> '20' THEN
        SET out_Return_Code = '272';
        LEAVE ENDPROC;
      END IF;
      SET IN_New_TraceID_OLD = In_New_TraceID;

      IF TRIM(In_HoldRejectCode) IS NULL THEN
        SET In_HoldRejectCode = 'OK';
      END IF;



      IF r_LocationAttribute IN ('HD', 'FI') THEN
        SET OUT_Return_Code = '228';
        LEAVE ENDPROC;
      END IF;

      IF (r_Mix_Flag = 'N'
        OR r_SKUCount > 0)
        AND R_LocationUsage <> 'ST' THEN
        SELECT
          COUNT(DISTINCT SKU)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = IN_organizationId
        AND warehouseId = In_warehouseId
        AND LocationID = In_TOLocation
        AND SKU <> In_SKU
        AND Qty > 0 INTO v_nRow;
        IF v_nRow >= 1
          AND r_Mix_Flag = 'N' THEN
          SET OUT_Return_Code = CONCAT('205', TRIM(In_TOLocation));
          LEAVE ENDPROC;
        ELSEIF r_Mix_Flag = 'Y'
          AND r_SKUCount > 0
          AND v_nRow >= r_SKUCount THEN
          SET OUT_Return_Code = CONCAT('367', r_SKUCount);
          LEAVE ENDPROC;
        END IF;
      END IF;



      IF TRIM(In_FMTraceID) IS NULL THEN
        SET In_FMTraceID = '*';
      END IF;
      IF R_PLT_RCV = 'Y'
        AND In_FMTraceID = '*' THEN
        SET OUT_Return_Code = '217';
        LEAVE ENDPROC;
      END IF;
      IF In_FMTraceID <> '*'
        AND In_FMTraceID <> '' THEN

        SET v_error = 1;
        SELECT
          PlanToLoc,
          packUOM,
          LineStatus,
          Reserve_Flag,
          Lotnum,
          ExpectedQty_Each - ReceivedQty_Each
        FROM DOC_TRACE_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseId
        AND ASNNO = In_ASNNo
        AND ASNLineNO = IN_AsnLineNO
        AND TraceID = In_FMTraceID INTO r_PlanToLoc_Trace, r_TraceUOM, r_LineStatus_Trace, r_Reserve_Flag
        , r_Lotnum_Trace, r_CancelQty_Trace
        ;
        IF v_error = 0 THEN
          SET OUT_Return_Code = CONCAT('104', In_ASNNo, ':', IN_AsnLineNO);
          LEAVE ENDPROC;
        END IF;

        IF R_Reserve_Flag = 'Y'
          AND R_LocationUsage <> 'ST' THEN
          SET OUT_Return_Code = '*_*';
          CALL spasn_reserve_cancel(IN_organizationId, In_warehouseID, 'TRACEID', IN_ASNNo, IN_ASNLineNO
          , In_FMTraceID, In_Language, IN_UserID, OUT_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
        END IF;

      ELSE
        SET r_FMUOM = IN_UOM;
        SET r_FMPackID = In_PackID;
        SET r_FMQty_Each = r_ReceivedQty_Each;
        SET r_FMQty = In_ReceivedQty;
      END IF;

      IF r_FMPackID IS NULL THEN
        SELECT
          a.packid
        FROM BAS_SKU a
        WHERE a.organizationId = In_organizationId
        AND a.customerid = In_CustomerID
        AND a.sku = In_SKU INTO r_FMPackID;
      END IF;
      IF r_FMUOM IS NULL THEN
        SET r_FMUOM = 'EA';
      END IF;





      SET v_error = 1;
      SELECT
        MAX(CASE WHEN packUom = 'EA' THEN qty ELSE 0 END) AS QTY1,
        MAX(CASE WHEN packUom = 'IP' THEN qty ELSE 0 END) AS QTY2,
        MAX(CASE WHEN packUom = 'CS' THEN qty ELSE 0 END) AS QTY3,
        MAX(CASE WHEN packUom = 'PL' THEN qty ELSE 0 END) AS QTY4,
        MAX(CASE WHEN packUom = 'OT' THEN qty ELSE 0 END) AS QTY5,
        MAX(CASE WHEN packUom = 'EA' THEN IN_Label ELSE NULL END) AS IN_Label1,
        MAX(CASE WHEN packUom = 'CS' THEN IN_Label ELSE NULL END) AS IN_Label3,
        MAX(CASE WHEN packUom = 'PL' THEN IN_Label ELSE NULL END) AS IN_Label4
      FROM BAS_PACKAGE_DETAILS
      WHERE organizationId = In_organizationId
      AND customerId = In_CustomerID
      AND PackID = In_PackID
      GROUP BY organizationId,
               customerId,
               PackID INTO r_QTY1_P, r_QTY2_P, r_QTY3_P, r_QTY4_P, r_QTY5_P
      , r_IN_Label1, r_IN_Label3, r_IN_Label4;
      IF v_error = 0 THEN
        SET OUT_Return_Code = CONCAT('104', In_PackID);
        LEAVE ENDPROC;
      END IF;
      IF R_CopyPackIDToLotAtt12 = 'Y' THEN
        SET In_LotAtt12 = r_QTY3_P;
      END IF;
      IF R_LOT_12_PKG = 'Y'
        AND In_UOM = 'CS' THEN
        SET R_UOMQty_Read = In_LotAtt12;
      ELSE
        IF in_UOM = 'EA' THEN
          SET R_UOMQty_Read = r_QTY1_P;
        ELSEIF in_UOM = 'IP' THEN
          SET R_UOMQty_Read = r_QTY2_P;
        ELSEIF in_UOM = 'CS' THEN
          SET R_UOMQty_Read = r_QTY3_P;
        ELSEIF in_UOM = 'PL' THEN
          SET R_UOMQty_Read = r_QTY4_P;
        ELSEIF in_UOM = 'OT' THEN
          SET R_UOMQty_Read = r_QTY5_P;
        END IF;
      END IF;

      SET R_FMQty_Each = R_FMQty * R_UOMQty_Read;
      SET r_ReceivedQty_Each = In_ReceivedQty * R_UOMQty_Read;



      IF r_TotalCubic IS NULL THEN
        SET r_TotalCubic = IFNULL(r_SKU_Cube, 0) * IFNULL(r_ReceivedQty_Each, 0);
      END IF;
      IF r_TotalGrossWeight IS NULL THEN
        SET r_TotalGrossWeight = IFNULL(R_SKU_GrossWeight, 0) * IFNULL(r_ReceivedQty_Each, 0);
      END IF;


      IF TRIM(IN_PlanToLoc) IS NOT NULL
        AND r_RCV_CRS_ARA = 'N' THEN
        SET v_error = 1;
        SELECT
          c.ZoneGroup
        FROM BAS_LOCATION b
          INNER JOIN BAS_ZONE c
            ON b.organizationId = c.organizationId
            AND b.warehouseId = c.warehouseId
            AND b.PutawayZone = c.Zone
        WHERE b.organizationId = In_organizationId
        AND b.warehouseId = In_warehouseId
        AND b.LocationID = IN_PlanToLoc INTO r_ZoneGroup;
        IF v_error = 0 THEN
          SET r_ZoneGroup = NULL;
        END IF;
        IF IN_New_TraceID <> '*' THEN
          SELECT
            COUNT(1)
          FROM INV_LOT_LOC_ID a
            INNER JOIN BAS_LOCATION b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.locationId = b.locationId
            INNER JOIN BAS_ZONE c
              ON c.organizationId = b.organizationId
              AND c.warehouseId = b.warehouseId
              AND c.Zone = b.putawayzone
          WHERE a.organizationId = In_organizationId
          AND a.warehouseId = In_warehouseId
          AND a.TraceID = IN_New_TraceID
          AND c.ZoneGroup <> r_ZoneGroup
          AND b.LocationUsage <> 'ST' INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_Return_Code = '233';
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
        END IF;
      END IF;
      IF In_Process_Action <> 2 THEN
        IF R_OverRCVPercentage_ASN <> 0 THEN
          SET r_OverRCVPercentage = r_OverRCVPercentage_ASN;
        END IF;




        SELECT
          c.UDF01
        FROM DOC_QC_DETAILS a
          INNER JOIN DOC_QC_HEADER b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.QcNo = b.QcNo
          INNER JOIN BSM_CODE c
            ON a.organizationId = c.organizationId
            AND a.QCResult = c.codeId
            AND codeType = 'QC_RST'
        WHERE a.organizationId = In_organizationId
        AND a.warehouseId = In_warehouseId
        AND b.ASNNo = IN_ASNNo
        AND a.AsnLineNo = IN_ASNLineNo
        AND b.QCStatus <> '90'
        LIMIT 1 INTO r_UDF1;

        IF r_QC_RCV_CTL = 'C' THEN
          SELECT
            IFNULL(SUM(QCQty_PASS), 0)
          FROM ACT_QC_TRANSACTION a
            INNER JOIN DOC_QC_HEADER b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.QCNo = b.QcNo
          WHERE b.organizationId = In_organizationId
          AND b.warehouseId = In_warehouseID
          AND b.ASNNo = IN_ASNNo
          AND a.AsnLineNo = IN_ASNLineNo
          AND b.QCStatus <> '90' INTO r_QCQTY_Pass;
          IF (r_ReceivedQty_Each_ASN + r_ReceivedQty_Each) > r_QCQTY_Pass THEN
            SET OUT_Return_Code = '225';
            LEAVE ENDPROC;
          END IF;
        ELSEIF r_QC_RCV_CTL = 'Y' THEN
          IF r_UDF1 = 'NOPASS' THEN
            SET OUT_Return_Code = '229';
            LEAVE ENDPROC;
          ELSEIF r_UDF1 = 'CONTROL' THEN
            SELECT
              SUM(QcQty_Reject)
            FROM ACT_QC_TRANSACTION a
              INNER JOIN DOC_QC_HEADER b
                ON a.organizationId = b.organizationId
                AND a.warehouseId = b.warehouseId
                AND a.QCNo = b.QcNo
            WHERE b.organizationId = In_organizationId
            AND b.warehouseId = In_warehouseID
            AND b.ASNNo = IN_ASNNo
            AND a.AsnLineNo = IN_ASNLineNo
            AND b.QCStatus <> '90' INTO r_QCQTY_Reject;
            IF (r_ReceivedQty_Each_ASN + r_ReceivedQty_Each) > r_ExpectedQty_Each_ASN - r_QCQTY_Reject THEN
              SET OUT_Return_Code = '225';
              LEAVE ENDPROC;
            END IF;
          END IF;
        END IF;


      END IF;




      IF R_OverReceiving <> 'Y'
        AND r_ExpectedQty_Each_ASN <> 0
        AND In_Process_Action <> 2 THEN
        IF (r_ReceivedQty_Each_ASN + r_ReceivedQty_Each) > r_ExpectedQty_Each_ASN THEN
          SET OUT_Return_Code = CONCAT('215', In_CustomerID);
          LEAVE ENDPROC;
        END IF;
        IF IFNULL(r_PONO, '*') <> '*'
          AND r_POLineNo IS NOT NULL THEN
          SELECT
            OrderedQty_Each,
            ReceivedQty_Each
          FROM DOC_PO_DETAILS
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND PONO = r_PONO
          AND POLineNo = r_POLineNo INTO r_OrderedQty_PO, r_ReceivedQty_Each_PO;
          IF (r_ReceivedQty_Each_PO + r_ReceivedQty_Each) > r_OrderedQty_PO THEN
            SET out_Return_Code = CONCAT('215', In_CustomerID, ',PONo=', r_PONO);
            LEAVE ENDPROC;
          END IF;
        END IF;
      END IF;
      IF R_OverReceiving = 'Y'
        AND R_OverRCVPercentage <> 0
        AND r_ExpectedQty_Each_ASN <> 0
        AND In_Process_Action <> 2 THEN
        SET r_OVR_RCV_BY = getsys_configuration_D(IN_organizationId, In_warehouseID, IN_CustomerID, r_ASNType, 'OVR_RCV_BY', 'BOTH');

        IF r_OVR_RCV_BY IN ('ASN', 'BOTH') THEN
          IF (r_ReceivedQty_Each_ASN + r_ReceivedQty_Each) / r_ExpectedQty_Each_ASN > (1 + r_OverRCVPercentage) THEN
            SET OUT_Return_Code = CONCAT('215', In_CustomerID);
            LEAVE ENDPROC;
          END IF;
        ELSEIF r_OVR_RCV_BY IN ('PO', 'BOTH') THEN
          IF IFNULL(r_PONO, '*') <> '*'
            AND r_POLineNo IS NOT NULL THEN
            SELECT
              OrderedQty_Each,
              ReceivedQty_Each
            FROM DOC_PO_DETAILS
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND PONO = r_PONO
            AND POLineNo = r_POLineNo INTO r_OrderedQty_PO, r_ReceivedQty_Each_PO;
            IF (r_ReceivedQty_Each_PO + r_ReceivedQty_Each) / r_OrderedQty_PO > (1 + r_OverRCVPercentage) THEN
              SET out_Return_Code = CONCAT('215', In_CustomerID, ',PONo=', r_PONO);
              LEAVE ENDPROC;
            END IF;
          END IF;
        END IF;
      END IF;
      IF IN_AsnNo = '*' THEN
        SET r_DocType = '*';
      ELSE
        SET r_DocType = 'ASN';
      END IF;



      IF In_New_TraceID = '*'
        AND (r_PRT_PTA_LBL = 'Y'
        OR r_ASN_GEN_TID = 'Y') THEN
        IF R_LoseID_Flag <> 'Y' THEN
          SET OUT_Return_Code = '*_*';
          CALL SPCOM_GetIDSequence(IN_organizationId, In_warehouseID, IN_Language, 'TraceID', In_New_TraceID, OUT_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
            LEAVE ENDPROC;
          END IF;
          SET OUT_Return_Code = '000';
        END IF;
      END IF;




      SELECT
        COUNT(1)
      FROM ACT_INVENTORYHOLD
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouseID
      AND HoldBy = '2'
      AND HoldFlag = 'Y'
      AND LocationID = In_TOLocation INTO v_nRow;
      IF v_nRow >= 1 THEN
        SET r_LocationHold = 'Y';
      END IF;
      SET v_nRow = 0;
      SET r_LogicalToSequence = NULL;
      SET r_MaxPATaskID_Sequence = 0;
      SET r_MaxQCTaskID_Sequence = 0;

    END;




    SET v_error = 1;
    SELECT
      LotNum
    FROM INV_LOT_ATT
    WHERE organizationId = In_organizationId
    AND customerId = In_CustomerID
    AND SKU = in_SKU
    AND IFNULL(LotAtt01, '*') = IFNULL(TRIM(In_LotAtt01), '*')
    AND IFNULL(LotAtt02, '*') = IFNULL(TRIM(In_LotAtt02), '*')
    AND IFNULL(LotAtt03, '*') = IFNULL(TRIM(In_LotAtt03), '*')
    AND IFNULL(LotAtt04, '*') = IFNULL(TRIM(IN_LotAtt04), '*')
    AND IFNULL(LotAtt05, '*') = IFNULL(TRIM(In_LotAtt05), '*')
    AND IFNULL(LotAtt06, '*') = IFNULL(TRIM(In_LotAtt06), '*')
    AND IFNULL(LotAtt07, '*') = IFNULL(TRIM(In_LotAtt07), '*')
    AND IFNULL(LotAtt08, '*') = IFNULL(TRIM(In_LotAtt08), '*')
    AND IFNULL(LotAtt09, '*') = IFNULL(TRIM(IN_LotAtt09), '*')
    AND IFNULL(LotAtt10, '*') = IFNULL(TRIM(In_LotAtt10), '*')
    AND IFNULL(LotAtt11, '*') = IFNULL(TRIM(In_LotAtt11), '*')
    AND IFNULL(LotAtt12, '*') = IFNULL(TRIM(In_LotAtt12), '*')
    AND IFNULL(LotAtt13, '*') = IFNULL(TRIM(In_LotAtt13), '*')
    AND IFNULL(LotAtt14, '*') = IFNULL(TRIM(In_LotAtt14), '*')
    AND IFNULL(LotAtt15, '*') = IFNULL(TRIM(In_LotAtt15), '*')
    AND IFNULL(LotAtt16, '*') = IFNULL(TRIM(IN_LotAtt16), '*')
    AND IFNULL(LotAtt17, '*') = IFNULL(TRIM(In_LotAtt17), '*')
    AND IFNULL(LotAtt18, '*') = IFNULL(TRIM(In_LotAtt18), '*')
    AND IFNULL(LotAtt19, '*') = IFNULL(TRIM(In_LotAtt19), '*')
    AND IFNULL(LotAtt20, '*') = IFNULL(TRIM(In_LotAtt20), '*')
    AND IFNULL(LotAtt21, '*') = IFNULL(TRIM(IN_LotAtt21), '*')
    AND IFNULL(LotAtt22, '*') = IFNULL(TRIM(In_LotAtt22), '*')
    AND IFNULL(LotAtt23, '*') = IFNULL(TRIM(In_LotAtt23), '*')
    AND IFNULL(LotAtt24, '*') = IFNULL(TRIM(In_LotAtt24), '*')
    LIMIT 1 INTO r_Return_LotNum;

    IF v_error <= 0 THEN
      SET OUT_Return_Code = '*_*';
      CALL SPCOM_GetIDSequence(IN_organizationId, In_warehouseID, IN_Language, 'LOTNumber', r_Return_LotNum, OUT_Return_Code);
      IF SUBSTRING(out_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
      INSERT INTO INV_LOT_ATT (organizationId, CustomerID, SKU, LotNum
      , LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05, LotAtt06
      , LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12
      , LotAtt13, LotAtt14, LotAtt15, LotAtt16, LotAtt17, LotAtt18
      , LotAtt19, LotAtt20, LotAtt21, LotAtt22, LotAtt23, LotAtt24
      , ADDTIME, AddWho, EditTime, EditWho, ReceivingTime)
        VALUES (In_organizationId, In_CustomerID, IN_SKU, r_Return_LotNum, TRIM(In_LotAtt01), TRIM(In_LotAtt02), TRIM(In_LotAtt03), TRIM(IN_LotAtt04), TRIM(In_LotAtt05), TRIM(In_LotAtt06), TRIM(In_LotAtt07), TRIM(In_LotAtt08), TRIM(in_LotAtt09), TRIM(In_LotAtt10), TRIM(In_LotAtt11), TRIM(In_LotAtt12), TRIM(In_LotAtt13), TRIM(In_LotAtt14), TRIM(In_LotAtt15), TRIM(IN_LotAtt16), TRIM(In_LotAtt17), TRIM(In_LotAtt18), TRIM(In_LotAtt19), TRIM(In_LotAtt20), TRIM(in_LotAtt21), TRIM(In_LotAtt22), TRIM(In_LotAtt23), TRIM(In_LotAtt24), r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_CurrentTime);

      IF r_IND_MED = 'Y'
        AND In_LotAtt10 IS NOT NULL THEN
        SELECT
          COUNT(1)
        FROM IND_PHARM_POINVOICE p
        WHERE p.organizationId = In_organizationId
        AND p.warehouseId = In_warehouseID
        AND p.customerid = In_CustomerID
        AND p.sku = In_SKU
        AND p.lotatt04 = In_LotAtt04
        AND p.lotatt10 = In_LotAtt10 INTO v_nRow;
        IF v_nRow <= 0 THEN
          INSERT INTO IND_PHARM_POINVOICE (organizationId, CustomerID, SKU, LotAtt04, LotAtt10, POInvoiceFileName, WarehouseID, SupplierID
          , ADDTIME, AddWho, EditTime, EditWho
          , Lotatt05)
            VALUES (In_organizationId, In_CustomerID, In_SKU, In_LotAtt04, In_LotAtt10, NULL, In_warehouseID, r_Supplierid, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, In_LotAtt05);
        END IF;
      END IF;

    END IF;

    IF r_Mix_LotFlag = 'N'
      AND R_LocationUsage <> 'ST' THEN


      SELECT
        COUNT(1)
      FROM INV_LOT_LOC_ID a
        INNER JOIN INV_LOT_Att c
          ON a.organizationId = c.organizationId
          AND a.LotNum = c.LotNum
      WHERE a.organizationId = In_organizationId
      AND a.warehouseId = In_warehouseID
      AND a.LocationID = In_TOLocation
      AND 1 =
      CASE WHEN (IFNULL(c.lotatt01, '*') <> IFNULL(In_LotAtt01, '*') AND
          r_LOTKEY01 = 'Y') OR
          (IFNULL(c.lotatt02, '*') <> IFNULL(In_LotAtt02, '*') AND
          r_LOTKEY02 = 'Y') OR
          (IFNULL(c.lotatt03, '*') <> IFNULL(In_LotAtt03, '*') AND
          r_LOTKEY03 = 'Y') OR
          (IFNULL(c.lotatt04, '*') <> IFNULL(In_LotAtt04, '*') AND
          r_LOTKEY04 = 'Y') OR
          (IFNULL(c.lotatt05, '*') <> IFNULL(In_LotAtt05, '*') AND
          r_LOTKEY05 = 'Y') OR
          (IFNULL(c.lotatt06, '*') <> IFNULL(In_LotAtt06, '*') AND
          r_LOTKEY06 = 'Y') OR
          (IFNULL(c.lotatt07, '*') <> IFNULL(In_LotAtt07, '*') AND
          r_LOTKEY07 = 'Y') OR
          (IFNULL(c.lotatt08, '*') <> IFNULL(In_LotAtt08, '*') AND
          r_LOTKEY08 = 'Y') OR
          (IFNULL(c.lotatt09, '*') <> IFNULL(In_LotAtt09, '*') AND
          r_LOTKEY09 = 'Y') OR
          (IFNULL(c.lotatt10, '*') <> IFNULL(In_LotAtt10, '*') AND
          r_LOTKEY10 = 'Y') OR
          (IFNULL(c.lotatt11, '*') <> IFNULL(In_LotAtt11, '*') AND
          r_LOTKEY11 = 'Y') OR
          (IFNULL(c.lotatt12, '*') <> IFNULL(In_LotAtt12, '*') AND
          r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;

      IF v_nRow >= 1 THEN
        SET OUT_Return_Code = CONCAT('206', TRIM(In_TOLocation));
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;
    END IF;
    IF In_Process_Action <> '2' THEN


      IF r_Reserve_Flag = 'Y'
        AND r_LocationUsage = 'ST'
        AND r_Lotnum_Trace <> r_Return_LotNum THEN
        UPDATE INV_LOT_LOC_ID
        SET QTYPA = QTYPA - r_CancelQty_Trace
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND lotnum = r_Lotnum_Trace
        AND LocationID = r_PlanToLoc_Trace
        AND traceid = IN_FMTraceID;
        DELETE
          FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND lotnum = r_Lotnum_Trace
          AND LocationID = r_PlanToLoc_Trace
          AND traceid = IN_FMTraceID
          AND QTYPA = 0
          AND qty = 0
          AND qtyMvin = 0;
        SELECT
          1
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND lotnum = r_Return_LotNum
        AND LocationID = r_PlanToLoc_Trace
        AND traceid = IN_FMTraceID INTO v_nRow FOR UPDATE;
        IF FOUND_ROWS() > 0 THEN
          UPDATE INV_LOT_LOC_ID
          SET QTYPA = QTYPA + r_ReceivedQty_Each
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND lotnum = r_Return_LotNum
          AND LocationID = r_PlanToLoc_Trace
          AND traceid = IN_FMTraceID;
        ELSE
          INSERT INTO INV_LOT_LOC_ID (organizationId, warehouseId, LotNum, LocationID, TraceID, CustomerID, SKU
          , Qty, QtyAllocated, QtyRPIn, QtyRPOut, QtyMVIN, QtyMVOut, QtyOnHold
          , OnHoldLocker, GrossWeight, NetWeight, Cubic, Price
          , ADDTIME, AddWho, EditTime, EditWho, LPN, QTYPA)
            VALUES (In_organizationId, In_warehouseID, r_Return_LotNum, r_PlanToLoc_Trace, IN_FMTraceID, IN_CustomerID, IN_SKU, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, NULL, r_ReceivedQty_Each);
        END IF;
      END IF;

    END IF;

    IF r_ShelfLifeFlag = 'Y' THEN

      IF r_ShelfLifeType = 'E' THEN

        IF In_LotAtt02 IS NOT NULL
          AND isdate(IN_LotAtt02) = 1 THEN

          IF r_InboundLifeDays > 0
            AND DATE_FORMAT(In_LotAtt02, '%Y/%m/%d') - R_CurrentTime <= r_InboundLifeDays THEN
            IF r_EXP_CTL = 'Y' THEN
              SET OUT_Return_Code = '222';
              ROLLBACK;
              LEAVE ENDPROC;
            ELSE
              SET r_Hold_EP = 'Y';
            END IF;
          END IF;
        END IF;
      ELSEIF r_ShelfLifeType = 'M' THEN

        IF In_LotAtt01 IS NOT NULL
          AND isdate(In_LotAtt01) = 1 THEN
          IF r_InboundLifeDays > 0
            AND DATEDIFF(r_CurrentTime, DATE_FORMAT(In_LotAtt01, '%Y/%m/%d')) > r_InboundLifeDays THEN
            IF r_EXP_CTL = 'Y' THEN
              SET out_return_Code = '222';
              ROLLBACK;
              LEAVE ENDPROC;
            ELSE
              SET r_Hold_EP = 'Y';
            END IF;
          END IF;
        END IF;
      END IF;
    END IF;

    IF TRIM(IN_ContainerID) IS NOT NULL THEN
      UPDATE DOC_ASN_SERIALNO
      SET LotNum = r_Return_LotNum,
          edittime = R_CurrentTime,
          editwho = In_UserID
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouseID
      AND LocationID = IN_ToLocation
      AND TraceID = IN_New_TraceID
      AND LotNum = IN_ContainerID;
    END IF;





    IF In_Process_Action <> '2' THEN






      CREATE TEMPORARY TABLE IF NOT EXISTS TMP_PUTAWAY_TASK (
        CustomerID varchar(35),
        SKU varchar(40),
        BreakQty decimal(18, 8),
        BreakQty_Each decimal(18, 8),
        BreakUOM varchar(2),
        GrossWeight decimal(18, 8),
        Cubic decimal(18, 8),
        NetWeight decimal(18, 8),
        Price decimal(18, 8),
        Location varchar(40),
        LocType varchar(2),
        Traceid varchar(40),
        ADDTIME datetime


      );
      DELETE
        FROM TMP_PUTAWAY_TASK;

      IF r_ReserveCode = 'IN'
        AND R_LocationUsage = 'ST' THEN

        SET r_OpenQty = r_ReceivedQty_Each;
        WHILE r_OpenQty > 0 DO
          IF r_RCV_BRK_TSK IN ('Y', 'S')
            AND (In_PlanToLoc = '*'
            OR In_PlanToLoc IS NULL) THEN
            IF r_QTY4_P > 0
              AND r_OpenQty >= r_QTY4_P
              AND r_IN_Label4 = 'Y' THEN
              SET r_BreakQty = r_QTY4_P;
              SET r_OpenQty = r_OpenQty - r_QTY4_P;
              SET r_UOM = 'PL';
              SET R_BreakQty_1 = 1;
            ELSEIF r_QTY3_P > 0
              AND r_OpenQty >= r_QTY3_P
              AND r_IN_Label3 = 'Y' THEN
              SET r_BreakQty = r_QTY3_P;
              SET r_OpenQty = r_OpenQty - r_QTY3_P;
              SET r_UOM = 'CS';
              SET R_BreakQty_1 = 1;
            ELSEIF r_IN_Label1 = 'Y'
              AND r_OpenQty >= 1 THEN
              SET r_BreakQty = 1;
              SET R_BreakQty_1 = 1;
              SET r_OpenQty = r_OpenQty - 1;
              SET r_UOM = 'EA';

            ELSE
              SET r_BreakQty = r_OpenQty;
              SET r_OpenQty = 0;
              SET r_UOM = 'EA';
              SET R_BreakQty_1 = r_BreakQty;
            END IF;


            IF r_RCV_BRK_TSK = 'S' THEN
              SET out_Return_Code = '*_*';
              CALL SPCOM_GetIDSequence(IN_organizationId, In_warehouseID, IN_Language, 'Traceid', In_New_TraceID, out_Return_Code);
              IF SUBSTRING(Out_Return_Code, 1, 3) <> '000' THEN
                ROLLBACK;
                LEAVE ENDPROC;
              END IF;
            END IF;
          ELSE
            SET r_BreakQty = r_OpenQty;
            SET r_BreakQty_1 = r_BreakQty / r_UOMQty_Read;
            SET r_UOM = In_UOM;
            SET r_OpenQty = 0;
          END IF;
          SET r_TaskGrossWeight = r_TotalGrossWeight * r_BreakQty / r_ReceivedQty_Each;
          SET r_TaskCubic = r_TotalCubic * r_BreakQty / r_ReceivedQty_Each;
          SET r_TaskNetWeight = r_TotalNetWeight * r_BreakQty / r_ReceivedQty_Each;
          SET r_TaskPrice = r_TotalPrice * r_BreakQty / r_ReceivedQty_Each;

          IF IFNULL(r_EACanCalcLoc, 'Y') = 'Y'
            AND (In_PlanToLoc = '*'
            OR IFNULL(In_PlanToLoc, '') = '') THEN
            SET OUT_Return_Code = '*_*';
            SET r_Return_ToLoc = 'NO-LOC';






            IF r_Return_ToLoc = 'NO-LOC' THEN
              SET r_Return_ToLoc = NULL;
            END IF;
            IF IFNULL(R_Return_ToLoc, '') = ''
              AND r_UOM = 'EA'
              AND r_BreakQty = 1 THEN
              SET r_EACanCalcLoc = 'N';
            END IF;
          ELSE
            SET r_Return_ToLoc = IFNULL(In_PlanToLoc, '');
          END IF;



          IF IFNULL(R_Return_ToLoc, '') <> '' THEN
            SELECT
              COUNT(1)
            FROM INV_LOT_LOC_ID
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND LotNum = r_Return_LotNum
            AND LocationID = r_Return_ToLoc
            AND TraceID = In_New_TraceID INTO v_nRow;
            IF v_nRow > 0 THEN
              UPDATE INV_LOT_LOC_ID
              SET QtyPA = QtyPA + r_BreakQty,
                  EditTime = r_CurrentTime,
                  EditWho = IN_UserID
              WHERE organizationId = In_organizationId
              AND warehouseId = In_warehouseID
              AND LotNum = r_Return_LotNum
              AND LocationID = r_Return_ToLoc
              AND TraceID = In_New_TraceID;
            ELSE
              INSERT INTO INV_LOT_LOC_ID (organizationId, warehouseId, LotNum, LocationID, TraceID
              , CustomerID, SKU, Qty, QTYPA
              , QtyAllocated, QtyRPOut, QtyMVOut, QtyRPIn, QtyMVIn, QtyOnHold
              , Cubic, GrossWeight, NetWeight, Price
              , LPN
              , ADDTIME, AddWho, EditTime, EditWho)
                VALUES (In_organizationId, In_warehouseID, r_Return_LotNum, r_Return_ToLoc, In_New_TraceID, In_CustomerID, IN_SKU, 0, r_BreakQty, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, r_LPN, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID);
            END IF;
          END IF;

          INSERT INTO TMP_PUTAWAY_TASK (CustomerID, SKU, BreakQty, BreakQty_Each, BreakUOM, GrossWeight, Cubic, NetWeight, Price, Location, Traceid, ADDTIME, LocType)
            VALUES (IN_CustomerID, IN_SKU, R_BreakQty_1, r_BreakQty, r_UOM, r_TaskGrossWeight, r_TaskCubic, r_TaskNetWeight, r_TaskPrice, r_Return_ToLoc, In_New_TraceID, NOW(), 'ST');
        END WHILE;
      ELSE
        SET r_TaskGrossWeight = r_TotalGrossWeight;
        SET r_TaskCubic = r_TotalCubic;
        SET r_TaskNetWeight = r_TotalNetWeight;
        SET r_TaskPrice = r_TotalPrice;
        INSERT INTO TMP_PUTAWAY_TASK (CustomerID, SKU, BreakQty, BreakQty_Each, BreakUOM, GrossWeight, Cubic, NetWeight, Price, Location, Traceid, ADDTIME, LocType)
          VALUES (IN_CustomerID, IN_SKU, In_ReceivedQty, r_ReceivedQty_Each, In_UOM, r_TaskGrossWeight, r_TaskCubic, r_TaskNetWeight, r_TaskPrice, In_TOLocation, In_New_TraceID, NOW(), 'RS');
      END IF;

      SET v_error = 1;
      SELECT
        1
      FROM INV_LOT
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouseID
      AND LotNum = r_Return_LotNum INTO v_nRow FOR UPDATE;
      SET v_nRow = v_error;
      IF FOUND_ROWS() = 0 THEN
        INSERT INTO INV_LOT (organizationId, warehouseId, LotNum, CustomerID, SKU
        , Qty
        , Cubic, GrossWeight, NetWeight, Price
        , QtyPreAllocated, QtyAllocated, QtyOnHold
        , ADDTIME, AddWho, EditTime, EditWho)
          VALUES (In_organizationId, In_warehouseID, r_Return_LotNum, In_CustomerID, IN_SKU, r_ReceivedQty_Each, r_TotalCubic, r_TotalGrossWeight, r_TotalNetWeight, r_TotalPrice, 0, 0, 0, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID);
      ELSE
        UPDATE INV_LOT
        SET Qty = Qty + r_ReceivedQty_Each,
            Cubic = Cubic + r_TotalCubic,
            GrossWeight = GrossWeight + r_TotalGrossWeight,
            NetWeight = NetWeight + r_TotalNetWeight,
            Price = Price + r_TotalPrice,
            EditTime = r_CurrentTime,
            EditWho = IN_UserID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND LotNum = r_Return_LotNum;
      END IF;

      SET r_QtyMVOut = 0;



      OPEN C_ACT;
    LoopACT:
      LOOP
        SET v_error = 1;
        FETCH C_ACT INTO r_TaskQty_Each, r_TaskQty, r_TaskUOM, r_TaskGrossWeight, r_TaskCubic, r_TaskNetWeight, r_TaskPrice, In_PlanToLoc
        , In_New_TraceID_loop, r_LogicalToSequence, r_LocType;
        IF v_error = 0 THEN
          LEAVE LoopACT;
        END IF;

        SET OUT_Return_Code = '*_*';
        CALL SPCOM_GetIDSequence(IN_organizationId, In_warehouseID, IN_Language, 'TransactionID', r_TransactionID, OUT_Return_Code);
        IF SUBSTRING(out_Return_Code, 1, 3) <> '000' THEN
          CLOSE C_ACT;
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
        IF r_LocType = 'ST' THEN
          IF IN_New_TraceID <> '*'
            OR r_RCV_BRK_TSK IN ('Y', 'S') THEN
            SET v_error = 1;
            SELECT
              MAX(TaskID_Sequence),
              TaskID
            FROM TSK_TASKLISTS
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND docno = In_ASNNo
            AND FMID = In_New_TraceID_loop
            AND TaskType = 'PA'
            AND TaskID_Sequence > 0
            GROUP BY TaskID INTO r_MaxPATaskID_Sequence, r_PATaskID;
            IF v_error = 0 THEN
              SET r_MaxPATaskID_Sequence = 0;
            END IF;
            SET v_error = 1;
            SELECT
              MAX(TaskID_Sequence),
              TaskID
            FROM TSK_TASKLISTS
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND docno = In_ASNNo
            AND FMID = In_New_TraceID
            AND TaskType = 'QC'
            GROUP BY TaskID INTO r_MaxQCTaskID_Sequence, r_QCTaskID;
            IF v_error = 0 THEN
              SET r_MaxQCTaskID_Sequence = 0;
            END IF;
          END IF;
          IF r_MaxPATaskID_Sequence = 0
            OR (IN_New_TraceID = '*'
            AND r_RCV_BRK_TSK = 'N') THEN
            SET OUT_Return_Code = 'NO_COMMIT';
            CALL SPCOM_GetIDSequence(IN_organizationId, In_warehouseID, IN_Language, 'TaskID', r_PATaskID, out_Return_Code);
            IF SUBSTRING(Out_Return_Code, 1, 3) <> '000' THEN
              ROLLBACK;
              CLOSE C_ACT;
              LEAVE ENDPROC;
            END IF;
            SET OUT_Return_Code = '000';
            SET r_PATaskID_Sequence = 1;
          ELSE
            SET r_PATaskID_Sequence = r_MaxPATaskID_Sequence + 1;
          END IF;
          INSERT INTO TSK_TASKLISTS (organizationId, TaskID, TaskID_Sequence, TaskType, CustomerID, Sku
          , DocType, DocNO, DocLineNO
          , FMLotNum, FMUOM, FMPackID, FMQty_Each, FMQty
          , FMLocation, LogicalFMSequence, FMID
          , PlanToLotNum, PlanToUOM, PlanToPackID, PlanToQty_Each, PlanToQty
          , PlanToLocation, PlanLogicalToSequence, PlanToID
          , TaskProcess, Reasoncode, TaskProcessMsg, Priority
          , OpenWho, OpenTime, HoldWho, HoldTime, CloseWho, CloseTime
          , LotAtt01, LotAtt02, LotAtt03, LotAtt04, LotAtt05, LotAtt06
          , LotAtt07, LotAtt08, LotAtt09, LotAtt10, LotAtt11, LotAtt12
          , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
          , ReleaseTaskID, WarehouseID
          , Create_TransactionID)
            VALUES (In_organizationId, r_PATaskID, r_PATaskID_Sequence, 'PA', In_CustomerID, IN_SKU, r_DocType, IN_AsnNO, IN_AsnLineNo, r_Return_LotNum, r_TaskUOM, in_PackID, r_TaskQty_Each, r_TaskQty, In_TOLocation, r_LogicalFMSequence, In_New_TraceID_loop, r_Return_LotNum, r_TaskUOM, in_PackID, r_TaskQty_Each, r_TaskQty, In_PlanToLoc, r_LogicalToSequence, In_New_TraceID_loop, '00', NULL, 'Putaway Task', r_Priority, IN_UserID, r_CurrentTime, NULL, NULL, NULL, NULL, In_LotAtt01, In_LotAtt02, In_LotAtt03, IN_LotAtt04, In_LotAtt05, In_LotAtt06, In_LotAtt07, In_LotAtt08, in_LotAtt09, In_LotAtt10, In_LotAtt11, In_LotAtt12, IFNULL(r_TaskCubic, 0), IFNULL(r_TaskGrossWeight, 0), IFNULL(r_TaskNetWeight, 0), IFNULL(r_TaskPrice, 0), NULL, r_WarehouseID, r_TransactionID);
          SET r_PA_Flag = 'Y';
          SET r_PA_Sequence = r_PATaskID_Sequence;
          SET r_PA_TaskID = r_PATaskID;
          SET r_QtyMVOut = r_TaskQty_Each;
        ELSE
          SET r_QtyMVOut = 0;
        END IF;

        SELECT
          1
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND LotNum = r_Return_LotNum
        AND LocationID = In_TOLocation
        AND TraceID = In_New_TraceID_loop INTO v_nRow FOR UPDATE;
        IF FOUND_ROWS() > 0 THEN
          UPDATE INV_LOT_LOC_ID
          SET Qty = Qty + r_TaskQty_Each,
              QtyMVOut = QtyMVOut + r_QtyMVOut,
              Cubic = Cubic + r_TaskCubic,
              GrossWeight = GrossWeight + r_TaskGrossWeight,
              NetWeight = NetWeight + r_TaskNetWeight,
              Price = Price + r_TaskPrice,
              EditTime = r_CurrentTime,
              EditWho = IN_UserID,
              InLocTime = (CASE WHEN Qty = 0 THEN r_CurrentTime ELSE InLocTime END)
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND LotNum = r_Return_LotNum
          AND LocationID = In_TOLocation
          AND TraceID = In_New_TraceID_loop;
        ELSE
          INSERT INTO INV_LOT_LOC_ID (organizationId, warehouseId, LotNum, LocationID, TraceID, CustomerID, SKU
          , Qty, QtyAllocated, QtyRPOut, QtyMVOut, QtyRPIn, QtyMVIn, QtyOnHold, QTYPA
          , Cubic, GrossWeight, NetWeight, Price
          , LPN
          , ADDTIME, AddWho, EditTime, EditWho
          , InLocTime)
            VALUES (In_organizationId, In_warehouseID, r_Return_LotNum, In_TOLocation, In_New_TraceID_loop, In_CustomerID, IN_SKU, r_TaskQty_Each, 0, 0, r_QtyMVOut, 0, 0, 0, 0, r_TaskCubic, r_TaskGrossWeight, r_TaskNetWeight, r_TaskPrice, r_LPN, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, r_CurrentTime);
        END IF;

        INSERT INTO ACT_TRANSACTION_LOG (organizationId, TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PASequence, PAFlag
        , TransactionType
        , DocNo, DocLineNo, DocType
        , FMCustomerID, FMSKU
        , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
        , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
        , STATUS
        , TOCustomerID, TOSku
        , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
        , ADDTIME, AddWho, EditTime, EditWho
        , Operator


        , WarehouseID
        , TransactionTime
        , CallModule, CallWorkStation
        , Edisendflag)
          VALUES (In_organizationId, r_TransactionID, r_QCTaskID, r_QC_Sequence, r_HOLD_FLAG, r_PA_TaskID, r_PA_Sequence, r_PA_Flag, 'IN', IN_AsnNo, IN_AsnLineNo, r_DocType, In_CustomerID, IN_SKU, r_Return_LotNum, In_FMLocation, In_FMTraceID, r_FMPackID, r_TaskUOM, r_TaskQty, r_TaskQty_Each, r_Return_LotNum, In_TOLocation, In_New_TraceID_loop, In_PackID, r_TaskUOM, r_TaskQty, r_TaskQty_Each, '99', In_CustomerID, IN_SKU, IFNULL(r_TaskCubic, 0), IFNULL(r_TaskGrossWeight, 0), IFNULL(r_TaskNetWeight, 0), IFNULL(r_TaskPrice, 0), r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, IN_Operator, r_WarehouseID, r_ReceivingTime, IN_RCVModule, IN_RCVStation, r_UDF2_IN);




        IF TRIM(IN_AsnNo) IS NULL THEN
          SET IN_AsnNo = '*';
        END IF;
        IF IN_AsnNo = '*' THEN
          SET In_AsnLineNo = 0;
        END IF;

        SELECT
          COUNT(1)
        FROM TMP_QC_RESULT
        WHERE ASNLINENO = IN_AsnLineNo
        AND ASNNO = IN_AsnNo
        AND USERID = In_UserID INTO v_nRow;
        IF v_nRow >= 1 THEN
          INSERT INTO ACT_QC_TRANSACTION (organizationId, warehouseId, QCTransactionID, QCNo, QCLineNo, ASNLineNo, CustomerID
          , SKU, QCQty_Expected, QCQty_Completed, QCQty_PASS, QCQty_Reject
          , QCResult, UserDefine1, UserDefine2, UserDefine3, UserDefine4, UserDefine5, UserDefine6
          , Notes, QCTime, QCWho, RejectReasonCode, RejectReason
          , ADDTIME, AddWho, EditTime, EditWho)
            SELECT DISTINCT
              In_organizationId,
              In_warehouseID,
              r_TransactionID,
              IN_AsnNo,
              IN_AsnLineNo,
              IN_AsnLineNo,
              In_CustomerID,
              IN_SKU,
              r_FMQty_Each,
              QCSAMPLEQTY,
              NULL,
              NULL,
              QCRESULT,
              t.USERDEFINE1,
              t.USERDEFINE2,
              t.USERDEFINE3,
              t.USERDEFINE4,
              t.USERDEFINE5,
              t.USERDEFINE6,
              NULL,
              r_ReceivingTime,
              In_UserID,
              RejectReasonCode,
              RejectReason,
              r_CurrentTime,
              IN_UserID,
              r_CurrentTime,
              IN_UserID
            FROM TMP_QC_RESULT t
            WHERE ASNLINENO = IN_AsnLineNo
            AND ASNNO = IN_AsnNo
            AND USERID = In_UserID;
          SET r_HOLD_FLAG = 'D';
        END IF;


        IF r_IND_MED = 'Y' THEN
          IF r_ReservedField16 = 'Y' THEN
            SELECT
              COUNT(1)
            FROM IND_VISIBLEDETECTION_HEADER
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND ASNNO = IN_AsnNo INTO v_nRow;
            IF v_nRow = 0 THEN
              INSERT INTO IND_VISIBLEDETECTION_HEADER (organizationId, ASNNO, CustomerID, WarehouseID, DocStatus, addwho, ADDTIME, editwho, edittime)
                VALUES (In_organizationId, IN_AsnNo, In_CustomerID, In_warehouseID, '00', IN_UserID, NOW(), IN_UserID, NOW());
            END IF;
            INSERT INTO IND_VisibleDetection_Details (organizationId, warehouseId, ASNNO, ASNLineNo, TransactionID, CustomerID, SKU, LotAtt02, LotAtt04, addwho, ADDTIME, editwho, edittime)
              VALUES (In_organizationId, In_warehouseID, IN_AsnNo, IN_AsnLineNo, r_TransactionID, In_CustomerID, In_SKU, In_LotAtt02, In_LotAtt04, IN_UserID, NOW(), IN_UserID, NOW());
          END IF;
        END IF;

        IF r_QC_FRM_TRN = 'AUTO'
          AND r_QC_PTA_CTL = 'Y' THEN

          SET v_error = 1;
          SELECT
            IFNULL(a.QCRULE, b.QCRULE),
            a.QCPoint
          FROM BAS_SKU a
            INNER JOIN BAS_CUSTOMER b
              ON a.organizationId = b.organizationId
              AND a.CUSTOMERID = b.CUSTOMERID
              AND b.CustomerType = 'OW'
          WHERE a.organizationId = In_organizationId
          AND a.warehouseId = In_warehouseID
          AND a.CUSTOMERID = In_CustomerID
          AND a.SKU = IN_SKU INTO r_QCRULE, r_QCPoint;
          IF v_error = 0 THEN
            SET r_QCRULE = '*';
          END IF;
          IF r_QCPoint = 'AFTERRECEIVING' THEN
            SET v_error = 1;
            SELECT
              a.sampleqty,
              a.samplepercentage,
              a.minqty
            FROM RUL_QC_DETAILS a
            WHERE a.organizationId = In_organizationId
            AND a.warehouseId = In_warehouseID
            AND a.qcrule = r_QCRULE
            AND a.frombatchqty <= r_TaskQty_Each
            AND a.tobatchqty >= r_TaskQty_Each
            LIMIT 1 INTO r_sampleqty, r_percentage, r_minqty;
            IF v_error = 0 THEN
              SET OUT_Return_Code = '888RUL_QC_DETAILS,OPEN';
              CLOSE C_ACT;
              ROLLBACK;
              LEAVE ENDPROC;
            END IF;


            SET r_QTY_DEC = getsys_configuration_D(IN_organizationId, In_warehouseID, In_CustomerID, r_ASNType, 'QTY_DEC', 0);
            SET r_QCQTY = r_sampleqty;
            IF r_QCQTY = 0 THEN
              SET r_QCQTY = r_percentage * r_TaskQty_Each;
            END IF;
            IF r_QCQTY < r_minqty THEN
              SET r_QCQTY = r_minqty;
            END IF;
            IF r_TaskQty_Each < r_minqty THEN
              SET r_QCQTY = r_TaskQty_Each;
            END IF;
            SET r_QCQTY = ROUND(r_QCQTY, r_QTY_DEC);
            SELECT
              IFNULL(MAX(b.QCLINENO), 0) + 1,
              MAX(a.QCNO)
            FROM DOC_QC_DETAILS b
              RIGHT JOIN DOC_QC_HEADER a
                ON a.organizationId = b.organizationId
                AND a.warehouseId = b.warehouseId
                AND b.QCNO = a.QCNO
            WHERE a.organizationId = In_organizationId
            AND a.warehouseId = In_warehouseID
            AND a.asnno = IN_AsnNo INTO r_QCLineNo, r_QCNO;
            IF r_QCQTY > 0 THEN
              SELECT
                COUNT(1)
              FROM DOC_QC_HEADER a
              WHERE a.organizationId = In_organizationId
              AND a.warehouseId = In_warehouseID
              AND a.asnno = IN_AsnNo INTO v_nRow;
              IF v_nRow = 0 THEN
                SET OUT_Return_Code = '*_*';
                CALL spcom_getidsequence(IN_organizationId, In_warehouseID, 'C', 'QCNO', r_QCNO, OUT_Return_Code);
                IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
                  ROLLBACK;
                  CLOSE C_ACT;
                  LEAVE ENDPROC;
                END IF;
                INSERT INTO DOC_QC_HEADER (organizationId, warehouseId, QCNO, ASNNO, CustomerID
                , QCType, QCStatus, UserDefine1, UserDefine2, UserDefine3, UserDefine4, UserDefine5
                , QCCreationTime, ADDTIME, AddWho, warehouseID)
                  SELECT
                    In_organizationId,
                    In_warehouseID,
                    r_QCNO,
                    IN_AsnNo,
                    In_CustomerID,
                    r_ASNType,
                    '00',
                    NULL,
                    NULL,
                    NULL,
                    NULL,
                    NULL,
                    r_CurrentTime,
                    r_CurrentTime,
                    IN_UserID,
                    r_WarehouseID
                  FROM DUAL;
              ELSE
                UPDATE DOC_QC_HEADER a
                SET a.qcstatus = CASE a.qcstatus WHEN '00' THEN '00' WHEN '90' THEN '00' ELSE '10' END
                WHERE a.asnno = IN_AsnNo;
              END IF;
              INSERT INTO DOC_QC_DETAILS (organizationId, warehouseId, QCNO, QCLineNo, ASNLineNo, LineStatus, CustomerID, SKU
              , ASNQty_Expected, QCQty_Expected, QCQty_Completed
              , UserDefine1, UserDefine2, UserDefine3, UserDefine4, UserDefine5
              , traceid, lotnum
              , PackId, TransactionID)
                VALUES (In_organizationId, In_warehouseID, r_QCNO, r_QCLineNo, IN_AsnLineNo, '00', In_CustomerID, IN_SKU, r_TaskQty_Each, r_QCQTY, 0, NULL, NULL, NULL, NULL, NULL, In_New_TraceID_loop, r_Return_LotNum, In_PackID, r_TransactionID);
              UPDATE ACT_TRANSACTION_LOG
              SET qc_flag = 'Y'
              WHERE organizationId = In_organizationId
              AND warehouseId = In_warehouseID
              AND TransactionID = r_TransactionID;
            END IF;
          END IF;
        END IF;
















        IF r_Hold_EP = 'Y' THEN
          SET In_HoldRejectCode = 'EP';
          SET In_HoldRejectReason = '??/????';
        END IF;
        IF In_HoldRejectCode <> 'OK'
          AND IN_HoldRejectCode <> 'PA'
          AND IN_HoldRejectCode <> 'Q1'
          AND IN_HoldRejectCode <> 'Q2' THEN
          SET OUT_Return_Code = '*_*';
          CALL SPINV_Hold_Release(IN_organizationId, r_WarehouseID, 'Hold', '5', '*', 0, ''
          , r_Return_LotNum, IN_SKU, In_CustomerID, In_New_TraceID_loop, In_TOLocation
          , In_HoldRejectCode, In_HoldRejectReason
          , r_PATaskID, r_PATaskID_Sequence, r_QCTaskID, r_QCTaskID_Sequence
          , IN_Language, IN_UserID, OUT_Return_Code);
          IF SUBSTRING(OUT_Return_Code, 1, 3) NOT IN ('000', '302') THEN
            ROLLBACK;
            CLOSE C_ACT;
            LEAVE ENDPROC;

          ELSEIF SUBSTRING(OUT_Return_Code, 1, 3) IN ('000') THEN
            UPDATE ACT_INVENTORYHOLD
            SET TransactionID = r_TransactionID
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND INVENTORYHOLDID = SUBSTRING(OUT_Return_Code, 4, 20);

          END IF;
          SET OUT_Return_Code = '000';
        END IF;

      END LOOP;
      CLOSE C_ACT;

      DELETE
        FROM TMP_PUTAWAY_TASK;

      IF R_SN_CTL IN ('1', '2') THEN
        UPDATE DOC_ASN_SERIALNO
        SET LotNum = r_Return_LotNum,
            StockFlag = CASE WHEN R_LocationUsage = 'EA' AND
                R_LoseID_Flag = 'Y' AND
                r_IND_TEX = 'Y' AND
                R_PCK_LOS_SN = 'Y' THEN 'N' ELSE 'Y' END,
            TransactionID = R_TransactionID,
            TraceID = IN_New_TraceID,
            edittime = R_CurrentTime,
            editwho = In_UserID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND LocationID = IN_ToLocation
        AND TraceID = IN_New_TraceID_OLD
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU
        AND ASNNo = IN_ASNNo
        AND TransactionID IS NULL;
        IF R_SN_CTL = '2' THEN
          UPDATE DOC_ASN_SUBSERIALNO B
          SET LotNum = r_Return_LotNum,
              StockFlag = 'Y',
              TransactionID = r_TransactionID,
              TraceID = IN_New_TraceID,
              edittime = R_CurrentTime,
              editwho = In_UserID
          WHERE B.organizationId = In_organizationId
          AND B.warehouseId = In_warehouseID
          AND B.LocationID = IN_ToLocation
          AND B.TraceID = IN_New_TraceID_OLD
          AND B.CustomerID = IN_CustomerID
          AND B.SKU = IN_SKU
          AND EXISTS (SELECT
              1
            FROM DOC_ASN_SERIALNO A
            WHERE A.organizationId = B.organizationId
            AND A.warehouseId = B.warehouseId
            AND B.SerialNo = A.SerialNo
            AND A.ASNNo = IN_ASNNo)
          AND B.TransactionID IS NULL;

          UPDATE DOC_ASN_SERIALNO a
          SET StockFlag = CASE WHEN R_LocationUsage = 'EA' AND
                  R_LoseID_Flag = 'Y' AND
                  r_IND_TEX = 'Y' AND
                  R_PCK_LOS_SN = 'Y' THEN 'N' ELSE 'Y' END,
              TraceID = IN_New_TraceID,
              edittime = R_CurrentTime,
              editwho = In_UserID
          WHERE a.organizationId = In_organizationId
          AND a.warehouseId = In_warehouseID
          AND a.LocationID = IN_ToLocation
          AND a.TraceID = IN_New_TraceID_OLD
          AND a.CustomerID = IN_CustomerID
          AND a.ASNNo = IN_ASNNo
          AND a.Sku = 'MIXSKU'
          AND EXISTS (SELECT
              1
            FROM DOC_ASN_SUBSERIALNO b
            WHERE a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.serialno = b.serialno
            AND a.asnno = b.asnno
            AND StockFlag = 'Y');

        ELSE
          UPDATE DOC_ASN_SERIALNO
          SET StockFlag = CASE WHEN R_LocationUsage = 'EA' AND
                  R_LoseID_Flag = 'Y' AND
                  r_IND_TEX = 'Y' AND
                  R_PCK_LOS_SN = 'Y' THEN 'N' ELSE 'Y' END,
              TraceID = IN_New_TraceID,
              edittime = R_CurrentTime,
              editwho = In_UserID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND LocationID = IN_ToLocation
          AND TraceID = IN_New_TraceID_OLD
          AND CustomerID = IN_CustomerID
          AND ASNNo = IN_ASNNo
          AND sku = 'MIXSKU';

        END IF;
      END IF;




      IF In_FMTraceID <> '*' THEN
        SELECT
          ExpectedQty_Each,
          ReceivedQty_Each,
          Lotnum,
          ExpectedQty_Each - ReceivedQty_Each
        FROM DOC_TRACE_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND TraceID = In_FMTraceID
        AND ASNNO = In_ASNNo
        AND ASNLineNO = IN_AsnLineNO INTO r_ExpectedQty_Each_Trace, r_ReceivedQty_Each_Trace
        , r_Lotnum_Trace, r_CancelQty_Trace;
        IF r_ExpectedQty_Each_Trace > r_ReceivedQty_Each_Trace + r_ReceivedQty_Each THEN
          SET r_LineStatus = '30';
        ELSE
          SET r_LineStatus = '40';
        END IF;

        IF r_TraceUOM = 'EA' THEN
          SET r_UOMQty_ASN = r_QTY1_P;
        ELSEIF r_TraceUOM = 'IP' THEN
          SET r_UOMQty_ASN = r_QTY2_P;
        ELSEIF r_TraceUOM = 'CS' THEN
          SET r_UOMQty_ASN = r_QTY3_P;
        ELSEIF r_TraceUOM = 'PL' THEN
          SET r_UOMQty_ASN = r_QTY4_P;
        ELSEIF r_TraceUOM = 'OT' THEN
          SET r_UOMQty_ASN = r_QTY5_P;
        END IF;
        UPDATE DOC_TRACE_DETAILS
        SET LineStatus = r_LineStatus,
            ReceivedQty = (ReceivedQty_Each + r_ReceivedQty_Each) / r_UOMQty_ASN,
            ReceivedQty_Each = ReceivedQty_Each + r_ReceivedQty_Each,
            RejectedQty = (RejectedQty_Each + In_RejectedQty) / r_UOMQty_ASN,
            RejectedQty_Each = RejectedQty_Each + (In_RejectedQty),
            ReceivedTime = r_ReceivingTime,
            ContainerID = In_ContainerID,
            Reserve_Flag = 'Y',
            LotAtt01 = In_LotAtt01,
            LotAtt02 = In_LotAtt02,
            LotAtt03 = In_LotAtt03,
            LotAtt04 = In_LotAtt04,
            LotAtt05 = In_LotAtt05,
            LotAtt06 = In_LotAtt06,
            LotAtt07 = In_LotAtt07,
            LotAtt08 = In_LotAtt08,
            LotAtt09 = IN_LotAtt09,
            LotAtt10 = In_LotAtt10,
            LotAtt11 = In_LotAtt11,
            LotAtt12 = In_LotAtt12,
            ProductStatus = In_ProductStatus,
            ProductStatus_Descr = In_ProductStatus_Descr,
            HoldRejectCode = In_HoldRejectCode,
            HoldRejectReason = In_HoldRejectReason,
            EditTime = R_CurrentTime,
            EditWho = IN_UserID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND TraceID = In_FMTraceID
        AND ASNNO = In_ASNNo
        AND ASNLineNO = IN_AsnLineNO;
      END IF;



      IF r_POLineNO > 0
        AND In_PONo <> '*'
        AND r_ASN_LNK_PO = 'Y' THEN
        SET v_error = 1;
        SELECT
          PackID,
          packUOM,
          OrderedQty,
          OrderedQty_Each,
          ReceivedQty,
          ReceivedQty_Each,
          POLineStatus
        FROM DOC_PO_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND PONO = In_PONo
        AND PoLineNO = r_PoLineNO INTO r_PackID_PO, r_UOM_PO, r_OrderedQty_PO, R_OrderedQty_Each_PO
        , r_ReceivedQty_PO, r_ReceivedQty_Each_PO, r_POLineStatus;
        IF v_error = 0 THEN
          SET r_PackID_PO = '***';
        END IF;
        IF r_POLineStatus IN ('90', '99') THEN
          SET OUT_Return_Code = '224';
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
        SET r_Receive_Qty_Current = r_ReceivedQty_Each;
        IF r_PackID_PO <> '***' THEN
          SET v_error = 1;
          SELECT
            MAX(CASE WHEN packUom = 'EA' THEN qty ELSE 0 END) AS QTY1,
            MAX(CASE WHEN packUom = 'IP' THEN qty ELSE 0 END) AS QTY2,
            MAX(CASE WHEN packUom = 'CS' THEN qty ELSE 0 END) AS QTY3,
            MAX(CASE WHEN packUom = 'PL' THEN qty ELSE 0 END) AS QTY4,
            MAX(CASE WHEN packUom = 'OT' THEN qty ELSE 0 END) AS QTY5,
            MAX(CASE WHEN packUom = 'EA' THEN IN_Label ELSE NULL END) AS IN_Label1,
            MAX(CASE WHEN packUom = 'CS' THEN IN_Label ELSE NULL END) AS IN_Label3,
            MAX(CASE WHEN packUom = 'PL' THEN IN_Label ELSE NULL END) AS IN_Label4
          FROM BAS_PACKAGE_DETAILS
          WHERE organizationId = In_organizationId
          AND customerId = In_CustomerID
          AND PackID = In_PackID
          GROUP BY organizationId,
                   customerId,
                   PackID INTO r_QTY1_P, r_QTY2_P, r_QTY3_P, r_QTY4_P, r_QTY5_P
          , r_IN_Label1, r_IN_Label3, r_IN_Label4;
          IF v_error = 0 THEN
            SET OUT_Return_Code = CONCAT('104', In_PackID);
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
          IF r_UOM_PO = 'EA' THEN
            SET r_UOMQty_PO = r_QTY1_P;
          ELSEIF r_UOM_PO = 'IP' THEN
            SET r_UOMQty_PO = r_QTY2_P;
          ELSEIF r_UOM_PO = 'CS' THEN
            SET r_UOMQty_PO = r_QTY3_P;
          ELSEIF r_UOM_PO = 'PL' THEN
            SET r_UOMQty_PO = r_QTY4_P;
          ELSEIF r_UOM_PO = 'OT' THEN
            SET r_UOMQty_PO = r_QTY5_P;
          END IF;
          IF r_UOMQty_PO <= 0 THEN
            SET OUT_Return_Code = '888BAS_PACKAGE_DETAILS,OPEN';
            ROLLBACK;
            LEAVE ENDPROC;
          END IF;
          SET r_ReceivedQty_Each_PO = r_ReceivedQty_Each_PO + r_Receive_Qty_Current;
          SET r_ReceivedQty_PO = r_ReceivedQty_Each_PO / r_UOMQty_PO;
          IF r_ReceivedQty_Each_PO + IFNULL(r_RejectedQty_Each_PO, 0) >= r_OrderedQty_Each_PO THEN
            SET r_LineStatus = '40';
          ELSE
            SET r_LineStatus = '30';
          END IF;
          UPDATE DOC_PO_DETAILS
          SET POLineStatus = r_LineStatus,
              ReceivedQty = r_ReceivedQty_PO,
              ReceivedQty_Each = r_ReceivedQty_Each_PO,
              ReceivedTime = r_ReceivingTime,
              EditTime = R_CurrentTime,
              EditWho = IN_UserID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND PONO = In_PONo
          AND POLineNO = r_POLineNO;
          IF r_LineStatus = '40' THEN
            SELECT
              COUNT(1)
            FROM DOC_PO_DETAILS
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND PONO = In_PONo
            AND POLineNO <> r_POLineNO
            AND POLineStatus < '40' INTO v_nRow;
            IF v_nRow > 0 THEN
              SET r_LineStatus = '30';
            END IF;
          END IF;
          UPDATE DOC_PO_Header
          SET POStatus = r_LineStatus,
              EditTime = R_CurrentTime,
              EditWho = IN_UserID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND PONO = In_PONo;
        END IF;
      END IF;



      IF IN_AsnNO <> '*' THEN
        SET v_error = 1;
        SELECT
          PackID,
          packUOM,
          ExpectedQty,
          ExpectedQty_Each,
          RejectedQty,
          RejectedQty_Each,
          ReceivedQty,
          ReceivedQty_Each,
          POLineNO,
          PONO,
          ReceivedTime
        FROM DOC_ASN_DETAILS
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND ASNNO = In_ASNNo
        AND ASNLineNO = IN_AsnLineNO INTO r_PackID_ASN, r_UOM_ASN, r_ExpectedQty_ASN
        , r_ExpectedQty_Each_ASN, r_RejectedQty_ASN
        , r_RejectedQty_Each_ASN, r_ReceivedQty_ASN
        , r_ReceivedQty_Each_ASN
        , r_POLineNO, IN_PONo
        , R_ReceivingTimeDTL
        FOR UPDATE;
        IF v_error = 0 THEN
          SET OUT_Return_Code = CONCAT('203', IN_AsnNO, ',', IN_AsnLineNO);
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;


        IF R_OverReceiving <> 'Y'
          AND In_RejectedQty > 0
          AND In_RejectedQty > r_ExpectedQty_Each_ASN - r_RejectedQty_Each_ASN - r_ReceivedQty_Each_ASN - r_ReceivedQty_Each THEN
          SET OUT_Return_Code = '220';
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
        SET r_ReceivedQty_Each_ASN = r_ReceivedQty_Each + r_ReceivedQty_Each_ASN;
        IF r_UOM_ASN = 'EA' THEN
          SET r_UOMQty_ASN = r_QTY1_P;
        ELSEIF r_UOM_ASN = 'IP' THEN
          SET r_UOMQty_ASN = r_QTY2_P;
        ELSEIF r_UOM_ASN = 'CS' THEN
          SET r_UOMQty_ASN = r_QTY3_P;
        ELSEIF r_UOM_ASN = 'PL' THEN
          SET r_UOMQty_ASN = r_QTY4_P;
        ELSEIF r_UOM_ASN = 'OT' THEN
          SET r_UOMQty_ASN = r_QTY5_P;
        END IF;
        IF r_UOMQty_ASN <= 0 THEN
          SET OUT_Return_Code = CONCAT('103', TRIM(r_PackID_ASN));
          ROLLBACK;
          LEAVE ENDPROC;
        END IF;
        IF r_ReceivedQty_Each_ASN >= r_ExpectedQty_Each_ASN THEN
          SET r_LineStatus = '40';
        ELSE
          SET r_LineStatus = '30';
        END IF;
        IF R_Asn_RCV_UPD = 'Y' THEN
          UPDATE DOC_ASN_DETAILS
          SET LineStatus = r_LineStatus,
              ReceivedQty = (ReceivedQty_Each + r_ReceivedQty_Each) / r_UOMQty_ASN,
              ReceivedQty_Each = ReceivedQty_Each + r_ReceivedQty_Each,
              ReceivedTime = IFNULL(R_ReceivingTimeDTL, r_ReceivingTime),
              RejectedQty = (RejectedQty_Each + (In_RejectedQty)) / r_UOMQty_ASN,
              RejectedQty_Each = RejectedQty_Each + (In_RejectedQty),
              Reserve_Flag = 'Y',
              HoldRejectCode = In_HoldRejectCode,
              HoldRejectReason = In_HoldRejectReason,
              EditTime = R_CurrentTime,
              EditWho = IN_UserID,
              LotAtt01 = In_LotAtt01,
              LotAtt02 = In_LotAtt02,
              LotAtt04 = In_LotAtt04,
              LotAtt05 = In_LotAtt05,
              LotAtt06 = In_LotAtt06,
              LotAtt07 = In_LotAtt07,
              LotAtt08 = In_LotAtt08,
              LotAtt09 = In_LotAtt09,
              LotAtt10 = In_LotAtt10,
              LotAtt11 = In_LotAtt11,
              LotAtt12 = In_LotAtt12,
              Operator = In_Operator
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND ASNNO = In_ASNNo
          AND ASNLineNO = IN_AsnLineNO;
        ELSE
          UPDATE DOC_ASN_DETAILS
          SET LineStatus = r_LineStatus,
              ReceivedQty = (ReceivedQty_Each + r_ReceivedQty_Each) / r_UOMQty_ASN,
              ReceivedQty_Each = ReceivedQty_Each + r_ReceivedQty_Each,
              ReceivedTime = IFNULL(R_ReceivingTimeDTL, r_ReceivingTime),
              RejectedQty = (RejectedQty_Each + (In_RejectedQty)) / r_UOMQty_ASN,
              RejectedQty_Each = RejectedQty_Each + (In_RejectedQty),
              Reserve_Flag = 'Y',
              HoldRejectCode = In_HoldRejectCode,
              HoldRejectReason = In_HoldRejectReason,
              EditTime = R_CurrentTime,
              EditWho = IN_UserID,
              Operator = In_Operator
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND ASNNO = In_ASNNo
          AND ASNLineNO = IN_AsnLineNO;
        END IF;
        IF r_LineStatus = '40' THEN
          SELECT
            COUNT(1)
          FROM DOC_ASN_DETAILS
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouseID
          AND ASNNO = In_ASNNo
          AND ASNLineNO <> In_ASNLineNo
          AND LineStatus < '40' INTO v_nRow;
          IF v_nRow > 0 THEN
            SET r_LineStatus = '30';
          END IF;
        END IF;
        UPDATE DOC_ASN_HEADER
        SET ASNStatus = r_LineStatus,
            Reserve_Flag = 'Y',
            LastReceivingTime = r_ReceivingTime,
            EditTime = R_CurrentTime,
            EditWho = IN_UserID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND ASNNO = In_ASNNo;

        IF r_RCV_CTL = 'Y'
          AND r_LineStatus = '40' THEN
          SET v_nRow = 0;
          IF r_PTA_CLS_CHK = 'Y' THEN
            SELECT
              COUNT(1)
            FROM TSK_TASKLISTS
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouseID
            AND DocNo = IN_ASNNO
            AND TaskProcess = '00'
            AND DocType = 'ASN' INTO v_nRow;
          END IF;
          IF v_nRow = 0 THEN
            SET r_LineStatus = '99';
            SAVEPOINT a;
            SET OUT_Return_Code = '*_*';
            CALL SPASN_Close_Process(IN_organizationId, In_warehouseID, IN_ASNNO, '99', 'N', IN_Language, IN_UserID, OUT_Return_Code);
            IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN

              ROLLBACK TO SAVEPOINT a;




              IF r_NO_COMMIT = 'Y' THEN
                COMMIT;
              END IF;
              LEAVE ENDPROC;
            END IF;
          END IF;
        END IF;

      END IF;
    END IF;
    IF In_Process_Action = '2' THEN


      SELECT
        COUNT(1)
      FROM INV_LOT
      WHERE organizationId = In_organizationId
      AND warehouseId = In_warehouseID
      AND LotNum = r_Return_LotNum INTO v_nRow;
      IF v_nRow > 0 THEN
        UPDATE INV_LOT
        SET Qty = Qty + r_ReceivedQty_Each,
            EditTime = R_CurrentTime,
            EditWho = In_UserID
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND LotNum = r_Return_LotNum;
      ELSE
        INSERT INTO INV_LOT (organizationId, warehouseId, LotNum, CustomerID, SKU
        , Qty
        , Cubic, GrossWeight, NetWeight, Price
        , QtyPreAllocated, QtyAllocated, QtyOnHold
        , ADDTIME, AddWho, EditTime, EditWho)
          VALUES (In_organizationId, In_warehouseID, r_Return_LotNum, In_CustomerID, IN_SKU, r_ReceivedQty_Each, 0, 0, 0, 0, 0, 0, 0, R_CurrentTime, In_UserID, R_CurrentTime, In_UserID);
      END IF;

      SELECT
        COUNT(1)
      FROM INV_LOT_LOC_ID
      WHERE LotNum = r_Return_LotNum
      AND LocationID = In_TOLocation
      AND TraceID = In_New_TraceID INTO v_nRow;

      IF v_nRow > 0 THEN
        UPDATE INV_LOT_LOC_ID
        SET Qty = Qty + r_ReceivedQty_Each,
            EditTime = R_CurrentTime,
            EditWho = In_UserID,
            InLocTime = (CASE WHEN Qty = 0 THEN r_CurrentTime ELSE InLocTime END)
        WHERE organizationId = In_organizationId
        AND warehouseId = In_warehouseID
        AND LotNum = r_Return_LotNum
        AND LocationID = In_TOLocation
        AND TraceID = In_New_TraceID;
      ELSE
        INSERT INTO INV_LOT_LOC_ID (organizationId, warehouseId, LotNum, LocationID, TraceID
        , CustomerID, SKU, Qty, QtyPA
        , QtyAllocated, QtyRPOut, QtyMVOut, QtyRPIn, QtyMVIn, QtyOnHold
        , Cubic, GrossWeight, NetWeight, Price
        , LPN, OnHoldLocker
        , ADDTIME, AddWho, EditTime, EditWho
        , InLocTime)
          VALUES (In_organizationId, In_warehouseID, r_Return_LotNum, In_TOLocation, In_New_TraceID, In_CustomerID, In_SKU, r_ReceivedQty_Each, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, In_LPN, 0, R_CurrentTime, In_UserID, R_CurrentTime, In_UserID, r_CurrentTime);
      END IF;


      SET OUT_Return_Code = '*_*';
      CALL SPCOM_GetIDSequence(IN_organizationId, In_organizationId, In_warehouseID, IN_Language, 'TransactionID', r_TransactionID, OUT_Return_Code);
      IF SUBSTRING(out_Return_Code, 1, 3) <> '000' THEN
        ROLLBACK;
        LEAVE ENDPROC;
      END IF;

      SELECT
        WarehouseID
      FROM BAS_LOCATION
      WHERE organizationId = In_organizationId
      AND LocationID = In_TOLocation
      LIMIT 1 INTO r_WarehouseID;
      IF TRIM(isfull(r_WarehouseID, '')) = '' THEN
        SELECT
          CustomerID
        FROM BAS_CUSTOMER
        WHERE organizationId = In_organizationId
        AND CustomerType = 'WH'
        AND ACTIVE_FLAG = 'Y'
        LIMIT 1 INTO r_WarehouseID;
      END IF;

      INSERT INTO ACT_TRANSACTION_LOG (organizationId, TransactionID, QCTaskID, QCSequence, QCFlag, PATaskID, PA_Sequence, PAFlag
      , TransactionType
      , DocNo, DocLineNo, DocType
      , FMCustomerID, FMSKU
      , FMLotNum, FMLocation, FMID, FMPackID, FMUOM, FMQty, FMQty_Each
      , ToLotNum, ToLocation, ToID, ToPackID, ToUOM, ToQty, ToQty_Each
      , STATUS
      , WarehouseID
      , TOCustomerID, TOSku
      , TotalCubic, TotalGrossWeight, TotalNetWeight, TotalPrice
      , ADDTIME, AddWho, EditTime, EditWho
      , Operator
      , TransactionTime
      , CallModule, CallWorkStation
      , Edisendflag)
        VALUES (In_organizationId, r_TransactionID, '*', 0, 'N', '*', 0, 'N', 'AD', IN_AsnNO, In_ASNLineNo, 'AJ', In_CustomerID, IN_SKU, r_Return_LotNum, In_FMLocation, In_FMTraceID, r_FMPackID, r_FMUOM, r_FMQty, r_FMQty_Each, r_Return_LotNum, In_TOLocation, In_New_TraceID, In_PackID, In_UOM, In_ReceivedQty, r_ReceivedQty_Each, '99', r_WarehouseID, In_CustomerID, IN_SKU, r_TotalCubic, In_TotalGrossWeight, In_TotalNetWeight, In_TotalPrice, r_CurrentTime, IN_UserID, r_CurrentTime, IN_UserID, IN_Operator, r_ReceivingTime, IN_RCVModule, IN_RCVStation, r_UDF2_AD);
    END IF;





    SET OUT_Return_Code = '*_*';
    CALL SPUDF_ProcessA(IN_organizationId, In_warehouseID, 'RCV_AFTER', IN_ASNNo, r_TransactionID, r_PATaskID, IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;
    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;





    SET OUT_New_TraceID = IN_New_TraceID;
    SET OUT_Return_LotNum = r_Return_LotNum;
    SET OUT_Return_Toloc = in_PlanToLoc;

    IF r_PopInfo IS NOT NULL THEN
      SET OUT_Return_Code = CONCAT('000%', r_PopInfo);
    END IF;
  END
  $$

--
-- Create procedure `SPASN_Putaway_LocationFilter`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPASN_Putaway_LocationFilter (IN In_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_CustomerID varchar(30),
IN IN_SKU varchar(50),
IN IN_LotNum varchar(10),
IN IN_Weight varchar(20),
IN IN_Cubic varchar(20),
IN IN_Quantity varchar(20),
IN IN_putawayzone varchar(20),
IN IN_Dimension_Restrictions1 varchar(100),
IN IN_Dimension_Restrictions2 varchar(100),
IN IN_Dimension_Restrictions3 varchar(100),
IN IN_Dimension_Restrictions4 varchar(100),
IN IN_Dimension_Restrictions5 varchar(100),
IN IN_LocationStatus_Includes1 varchar(100),
IN IN_LocationStatus_Includes2 varchar(100),
IN IN_LocationStatus_Includes3 varchar(100),
IN IN_LocationStatus_Includes4 varchar(100),
IN IN_LocationUsage_Includes1 varchar(100),
IN IN_LocationUsage_Includes2 varchar(100),
IN IN_LocationUsage_Includes3 varchar(100),
IN IN_LocationUsage_Includes4 varchar(100),
IN IN_LocationUsage_Includes5 varchar(100),
IN IN_LocationUsage_Excludes1 varchar(100),
IN IN_LocationUsage_Excludes2 varchar(100),
IN IN_LocationUsage_Excludes3 varchar(100),
IN IN_LocationUsage_Excludes4 varchar(100),
IN IN_LocationUsage_Excludes5 varchar(100),
IN IN_LocationCategory_Includes1 varchar(100),
IN IN_LocationCategory_Includes2 varchar(100),
IN IN_LocationCategory_Includes3 varchar(100),
IN IN_LocationCategory_Includes4 varchar(100),
IN IN_LocationCategory_Excludes1 varchar(100),
IN IN_LocationCategory_Excludes2 varchar(100),
IN IN_LocationCategory_Excludes3 varchar(100),
IN IN_LocationCategory_Excludes4 varchar(100),
IN IN_LocationAttribute_Includes1 varchar(100),
IN IN_LocationAttribute_Includes2 varchar(100),
IN IN_LocationAttribute_Includes3 varchar(100),
IN IN_LocationAttribute_Includes4 varchar(100),
IN IN_LocationAttribute_Excludes1 varchar(100),
IN IN_LocationAttribute_Excludes2 varchar(100),
IN IN_LocationAttribute_Excludes3 varchar(100),
IN IN_LocationAttribute_Excludes4 varchar(100),
IN IN_LocationHandling_Includes1 varchar(100),
IN IN_LocationHandling_Includes2 varchar(100),
IN IN_LocationHandling_Includes3 varchar(100),
IN IN_LocationHandling_Includes4 varchar(100),
IN IN_LocationHandling_Excludes1 varchar(100),
IN IN_LocationHandling_Excludes2 varchar(100),
IN IN_LocationHandling_Excludes3 varchar(100),
IN IN_LocationHandling_Excludes4 varchar(100),
IN IN_LocationDemand_Includes1 varchar(100),
IN IN_LocationDemand_Includes2 varchar(100),
IN IN_LocationDemand_Includes3 varchar(100),
IN IN_LocationDemand_Excludes1 varchar(100),
IN IN_LocationDemand_Excludes2 varchar(100),
IN IN_LocationDemand_Excludes3 varchar(100),
IN IN_LocationGroup1_Includes1 varchar(100),
IN IN_LocationGroup1_Includes2 varchar(100),
IN IN_LocationGroup2_Includes1 varchar(100),
IN IN_LocationGroup2_Includes2 varchar(100),
IN IN_LocationGroup1_Excludes1 varchar(100),
IN IN_LocationGroup1_Excludes2 varchar(100),
IN IN_LocationGroup2_Excludes1 varchar(100),
IN IN_LocationGroup2_Excludes2 varchar(100),
INOUT IN_MaxMixSKU varchar(50),
INOUT IN_MaxMixLOT varchar(10),
INOUT OUT_Return_Code varchar(500))
ENDPROC:
  BEGIN

    DECLARE r_TempQty4 decimal(18, 8);
    DECLARE r_TempQty3 decimal(18, 8);
    DECLARE r_PLT_CNT char(1);
    DECLARE r_LOTKEY01 varchar(1);
    DECLARE r_LOTKEY02 varchar(1);
    DECLARE r_LOTKEY03 varchar(1);
    DECLARE r_LOTKEY04 varchar(1);
    DECLARE r_LOTKEY05 varchar(1);
    DECLARE r_LOTKEY06 varchar(1);
    DECLARE r_LOTKEY07 varchar(1);
    DECLARE r_LOTKEY08 varchar(1);
    DECLARE r_LOTKEY09 varchar(1);
    DECLARE r_LOTKEY10 varchar(1);
    DECLARE r_LOTKEY11 varchar(1);
    DECLARE r_LOTKEY12 varchar(1);
    DECLARE r_LOTKEY13 varchar(1);
    DECLARE r_LOTKEY14 varchar(1);
    DECLARE r_LOTKEY15 varchar(1);
    DECLARE r_LOTKEY16 varchar(1);
    DECLARE r_LOTKEY17 varchar(1);
    DECLARE r_LOTKEY18 varchar(1);
    DECLARE r_LOTKEY19 varchar(1);
    DECLARE r_LOTKEY20 varchar(1);
    DECLARE r_LOTKEY21 varchar(1);
    DECLARE r_LOTKEY22 varchar(1);
    DECLARE r_LOTKEY23 varchar(1);
    DECLARE r_LOTKEY24 varchar(1);
    DECLARE r_SKUGroup1 varchar(100);
    DECLARE r_SKUGroup2 varchar(100);
    DECLARE r_SKUGroup3 varchar(100);
    DECLARE r_SKUGroup4 varchar(100);
    DECLARE r_SKUGroup5 varchar(100);
    DECLARE r_SKULength decimal(18, 8);
    DECLARE r_LotAtt01 varchar(100);
    DECLARE r_LotAtt02 varchar(100);
    DECLARE r_LotAtt03 varchar(100);
    DECLARE r_LotAtt04 varchar(100);
    DECLARE r_LotAtt05 varchar(100);
    DECLARE r_LotAtt06 varchar(100);
    DECLARE r_LotAtt07 varchar(100);
    DECLARE r_LotAtt08 varchar(100);
    DECLARE r_LotAtt09 varchar(100);
    DECLARE r_LotAtt10 varchar(100);
    DECLARE r_LotAtt11 varchar(100);
    DECLARE r_LotAtt12 varchar(100);
    DECLARE r_LotAtt13 varchar(100);
    DECLARE r_LotAtt14 varchar(100);
    DECLARE r_LotAtt15 varchar(100);
    DECLARE r_LotAtt16 varchar(100);
    DECLARE r_LotAtt17 varchar(100);
    DECLARE r_LotAtt18 varchar(100);
    DECLARE r_LotAtt19 varchar(100);
    DECLARE r_LotAtt20 varchar(100);
    DECLARE r_LotAtt21 varchar(100);
    DECLARE r_LotAtt22 varchar(100);
    DECLARE r_LotAtt23 varchar(100);
    DECLARE r_LotAtt24 varchar(100);
    DECLARE r_ALotAtt01 varchar(100);
    DECLARE r_ALotAtt02 varchar(100);
    DECLARE r_ALotAtt03 varchar(100);
    DECLARE r_ALotAtt04 varchar(100);
    DECLARE r_ALotAtt05 varchar(100);
    DECLARE r_ALotAtt06 varchar(100);
    DECLARE r_ALotAtt07 varchar(100);
    DECLARE r_ALotAtt08 varchar(100);
    DECLARE r_ALotAtt09 varchar(100);
    DECLARE r_ALotAtt10 varchar(100);
    DECLARE r_ALotAtt11 varchar(100);
    DECLARE r_ALotAtt12 varchar(100);
    DECLARE r_ALotAtt13 varchar(100);
    DECLARE r_ALotAtt14 varchar(100);
    DECLARE r_ALotAtt15 varchar(100);
    DECLARE r_ALotAtt16 varchar(100);
    DECLARE r_ALotAtt17 varchar(100);
    DECLARE r_ALotAtt18 varchar(100);
    DECLARE r_ALotAtt19 varchar(100);
    DECLARE r_ALotAtt20 varchar(100);
    DECLARE r_ALotAtt21 varchar(100);
    DECLARE r_ALotAtt22 varchar(100);
    DECLARE r_ALotAtt23 varchar(100);
    DECLARE r_ALotAtt24 varchar(100);
    DECLARE r_DynamicPickingCount int;
    DECLARE r_DynamicLocationCount int;
    DECLARE r_SQL varchar(4000);
    DECLARE r_code varchar(30);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE r_CurrentTime timestamp;
    DECLARE v_lotAttId varchar(20);
    DECLARE v_lotKey char(1);
    DECLARE CUR_LOTID CURSOR FOR
    SELECT
      a.lotId,
      a.lotKey
    FROM BAS_LOTID_DETAILS a
      INNER JOIN BAS_SKU b
        ON a.organizationId = b.organizationId
        AND a.LotID = b.LotID
    WHERE b.organizationId = In_organizationId
    AND b.CustomerID = IN_CustomerID
    AND b.SKU = IN_SKU
    ORDER BY a.lotId;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SET OUT_Return_Code = 'T';
      SELECT
        CONCAT('999#SPASN_Putaway_LocationFilter,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;
    IF OUT_Return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET R_CurrentTime = NOW();


    IF IN_Dimension_Restrictions1 = '02'
      OR IN_Dimension_Restrictions2 = '02'
      OR IN_Dimension_Restrictions3 = '02'
      OR IN_Dimension_Restrictions4 = '02'
      OR IN_Dimension_Restrictions5 = '02' THEN
      DELETE
        FROM TMP_EMPTY_LOC
      WHERE (SELECT
            IFNULL(SUM((a.qty + a.QTYPA + QTYRPIN + QTYMVIN) * b.Cube), 0)
          FROM INV_LOT_LOC_ID a
            INNER JOIN BAS_SKU b
              ON a.organizationId = b.organizationId
              AND a.CustomerID = b.CustomerID
              AND a.SKU = b.SKU
            INNER JOIN TMP_EMPTY_LOC c
              ON a.locationid = c.locationid
          WHERE a.organizationId = In_organizationId
          AND a.LocationID = TMP_EMPTY_LOC.LocationID) + IN_Cubic > TMP_EMPTY_LOC.CubicCapacity;
    END IF;
    IF IN_Dimension_Restrictions1 = '04'
      OR IN_Dimension_Restrictions2 = '04'
      OR IN_Dimension_Restrictions3 = '04'
      OR IN_Dimension_Restrictions4 = '04'
      OR IN_Dimension_Restrictions5 = '04' THEN
      DELETE
        FROM TMP_EMPTY_LOC
      WHERE (SELECT
            IFNULL(SUM((a.qty + a.QTYPA + QTYRPIN + QTYMVIN) * b.GrossWeight), 0)
          FROM INV_LOT_LOC_ID a
            INNER JOIN BAS_SKU b
              ON a.organizationId = b.organizationId
              AND a.customerId = b.customerId
              AND a.sku = b.sku
          WHERE a.organizationId = In_organizationId
          AND a.LocationID = TMP_EMPTY_LOC.LocationID
          AND a.CustomerID = b.CustomerID
          AND a.SKU = b.SKU) + IN_Weight > TMP_EMPTY_LOC.WeightCapacity;
    END IF;
    IF IN_Dimension_Restrictions1 = '05'
      OR IN_Dimension_Restrictions2 = '05'
      OR IN_Dimension_Restrictions3 = '05'
      OR IN_Dimension_Restrictions4 = '05'
      OR IN_Dimension_Restrictions5 = '05' THEN
      DELETE
        FROM TMP_EMPTY_LOC
      WHERE (SELECT
            IFNULL(SUM(a.qty + a.QTYPA + QTYRPIN + QTYMVIN), 0)
          FROM INV_LOT_LOC_ID a
          WHERE a.organizationId = In_organizationId
          AND a.LocationID = TMP_EMPTY_LOC.LocationID) + IN_Quantity > TMP_EMPTY_LOC.CountCapacity;
    END IF;
    IF IN_Dimension_Restrictions1 = '06'
      OR IN_Dimension_Restrictions2 = '06'
      OR IN_Dimension_Restrictions3 = '06'
      OR IN_Dimension_Restrictions4 = '06'
      OR IN_Dimension_Restrictions5 = '06' THEN
      SELECT
        b.qty4,
        b.qty3
      FROM BAS_SKU a
        INNER JOIN BAS_PACKAGE b
          ON a.organizationId = b.organizationId
          AND a.customerId = b.a.CustomerID
          AND a.PackID = b.PackID
      WHERE a.organizationId = In_organizationId
      AND a.CustomerID = IN_CustomerID
      AND a.SKU = IN_SKU INTO r_TempQty4, r_TempQty3;
      SET r_PLT_CNT = getsys_configuration(In_organizationId, IN_Warehouse, IN_CustomerID, '*', 'PLT_CNT');
      IF r_PLT_CNT IS NULL THEN
        SET r_PLT_CNT = 'N';
      END IF;
      IF r_PLT_CNT = 'N' THEN
        IF r_TempQty4 <> 0 THEN
          DELETE
            FROM TMP_EMPTY_LOC
          WHERE (SELECT
                (IFNULL(SUM(a.qty + a.QTYPA + QTYRPIN + QTYMVIN), 0) + IN_Quantity) / r_TempQty4
              FROM INV_LOT_LOC_ID a
              WHERE a.organizationId = In_organizationId
              AND a.LocationID = TMP_EMPTY_LOC.LocationID) > TMP_EMPTY_LOC.PLCount;
        END IF;
      ELSEIF r_PLT_CNT = 'Y' THEN
        DELETE
          FROM TMP_EMPTY_LOC
        WHERE (SELECT
              COUNT(DISTINCT traceid)
            FROM INV_LOT_LOC_ID a
            WHERE organizationId = In_organizationId
            AND a.LocationID = TMP_EMPTY_LOC.LocationID) + (SELECT
              COUNT(DISTINCT TraceID) + 1
            FROM DOC_TRACE_DETAILS
            WHERE organizationId = In_organizationId
            AND PlanToLoc = TMP_EMPTY_LOC.LocationID
            AND LineStatus < '20') > TMP_EMPTY_LOC.PLCount;
      END IF;
    END IF;
    IF IN_Dimension_Restrictions1 = '09'
      OR IN_Dimension_Restrictions2 = '09'
      OR IN_Dimension_Restrictions3 = '09'
      OR IN_Dimension_Restrictions4 = '09'
      OR IN_Dimension_Restrictions5 = '09' THEN
      SELECT
        b.qty4,
        b.qty3
      FROM BAS_SKU a
        INNER JOIN BAS_PACKAGE b
          ON a.organizationId = b.organizationId
          AND a.PackID = b.PackID
          AND a.customerId = b.customerId
      WHERE a.organizationId = In_organizationId
      AND a.CustomerID = IN_CustomerID
      AND a.SKU = IN_SKU INTO r_TempQty4, r_TempQty3;
      SET r_PLT_CNT = getsys_configuration(In_organizationId, IN_Warehouse, IN_CustomerID, '*', 'PLT_CNT');
      IF r_PLT_CNT IS NULL THEN
        SET r_PLT_CNT = 'N';
      END IF;
      IF r_PLT_CNT = 'N' THEN

        IF r_TempQty3 <> 0 THEN
          DELETE
            FROM TMP_EMPTY_LOC
          WHERE (SELECT
                (IFNULL(SUM(a.qty + a.QTYPA + QTYRPIN + QTYMVIN), 0) + IN_Quantity) / r_TempQty3
              FROM INV_LOT_LOC_ID a
              WHERE a.organizationId = In_organizationId
              AND a.LocationID = TMP_EMPTY_LOC.LocationID) > TMP_EMPTY_LOC.CSCount;
        END IF;
      ELSEIF r_PLT_CNT = 'Y' THEN
        DELETE
          FROM TMP_EMPTY_LOC
        WHERE (SELECT
              COUNT(DISTINCT traceid)
            FROM INV_LOT_LOC_ID a
            WHERE a.organizationId = In_organizationId
            AND a.LocationID = TMP_EMPTY_LOC.LocationID) + (SELECT
              COUNT(DISTINCT TraceID) + 1
            FROM DOC_TRACE_DETAILS
            WHERE organizationId = In_organizationId
            AND planToLoc = TMP_EMPTY_LOC.LocationID
            AND lineStatus < '20') > TMP_EMPTY_LOC.CSCount;
      END IF;
    END IF;

    IF IN_Dimension_Restrictions1 = '10'
      OR IN_Dimension_Restrictions2 = '10'
      OR IN_Dimension_Restrictions3 = '10'
      OR IN_Dimension_Restrictions4 = '10'
      OR IN_Dimension_Restrictions5 = '10' THEN
      SELECT
        IN_Quantity * skuwidth
      FROM BAS_SKU
      WHERE organizationId = In_organizationId
      AND customerid = IN_Customerid
      AND sku = IN_sku INTO r_SKULength;
      SELECT
        COUNT(*)
      FROM TMP_CODE
      WHERE CODEID = 'DIM10' INTO v_nRow;
      IF v_nRow = 0 THEN
        IF IN_putawayzone IS NULL THEN
          INSERT INTO TMP_CODE (CODEID, CODE)
            SELECT
              'DIM10',
              e.locgroup1
            FROM BAS_LOCATION a
              INNER JOIN INV_LOT_LOC_ID b
                ON a.locationid = b.locationid
                AND a.warehouseId = b.warehouseId
                AND a.organizationId = b.organizationId
              INNER JOIN BAS_SKU c
                ON b.organizationId = c.organizationId
                AND b.customerid = c.customerid
                AND b.sku = c.sku
              INNER JOIN BAS_LOCGROUP1 e
                ON a.locgroup1 = e.locgroup1
                AND a.organizationId = e.organizationId
                AND a.warehouseId = e.warehouseId
            GROUP BY e.locgroup1,
                     e.Length
            HAVING IFNULL(SUM((b.qty + b.qtyrpin + b.qtypa) * c.skuwidth), 0) + r_SKULength > IFNULL(e.Length, 0);
        ELSE
          INSERT INTO TMP_CODE (CODEID, CODE)
            SELECT
              'DIM10',
              e.locGroup1
            FROM BAS_LOCATION a
              INNER JOIN INV_LOT_LOC_ID b
                ON a.locationid = b.locationid
                AND a.warehouseId = b.warehouseId
                AND a.organizationId = b.organizationId
              INNER JOIN BAS_SKU c
                ON b.organizationId = c.organizationId
                AND b.customerid = c.customerid
                AND b.sku = c.sku
              INNER JOIN BAS_LOCGROUP1 e
                ON a.locgroup1 = e.locgroup1
                AND a.organizationId = e.organizationId
                AND a.warehouseId = e.warehouseId
            WHERE a.organizationId = In_organizationId
            AND a.zoneId = IN_putawayzone
            GROUP BY e.locgroup1,
                     e.Length
            HAVING IFNULL(SUM((b.qty + b.qtyrpin + b.qtypa) * c.skuwidth), 0) + r_SKULength > IFNULL(e.Length, 0);
        END IF;
        INSERT INTO TMP_CODE (CODEID, CODE)
          VALUES ('DIM10', '*');
      END IF;
      DELETE
        FROM TMP_EMPTY_LOC
      WHERE EXISTS (SELECT
            1
          FROM BAS_LOCATION LOC
            INNER JOIN TMP_CODE GRP
              ON GRP.CodeID = 'DIM10'
              AND loc.locgroup1 = GRP.code
          WHERE LOC.locationid = TMP_EMPTY_LOC.LOCATIONID);
    END IF;


    IF IN_Dimension_Restrictions1 = '11'
      OR IN_Dimension_Restrictions2 = '11'
      OR IN_Dimension_Restrictions3 = '11'
      OR IN_Dimension_Restrictions4 = '11'
      OR IN_Dimension_Restrictions5 = '11' THEN
      SET v_error = 1;
      SELECT
        DynamicPickingCount
      FROM BAS_FORWARDING_LOC T
      WHERE organizationId = In_organizationId
      AND CustomerID = In_CustomerID
      AND SKU = IN_SKU
      AND T.LOCATION_USAGE = 'CS'
      AND FWDLOC LIKE 'DYNAMIC%'
      LIMIT 1 INTO r_DynamicPickingCount;
      IF v_error = 0 THEN
        SET r_DynamicPickingCount = 0;
      END IF;
      IF r_DynamicPickingCount > 0 THEN
        DELETE
          FROM TMP_CODE;
        INSERT INTO TMP_CODE (CODE, CODEID)
          SELECT DISTINCT
            a.LocationID,
            'DIM11'
          FROM INV_LOT_LOC_ID a
            INNER JOIN BAS_LOCATION b
              ON a.LOCATIONID = b.LOCATIONID
              AND a.warehouseId = b.warehouseId
              AND a.organizationId = b.organizationId
          WHERE a.organizationId = In_organizationId
          AND a.CustomerID = iN_CustomerID
          AND a.SKU = IN_SKU
          AND b.LocationUsage = 'CS';

        SELECT
          COUNT(1)
        FROM TMP_CODE
        WHERE CodeID = 'DIM11' INTO r_DynamicLocationCount;

        IF r_DynamicLocationCount >= r_DynamicPickingCount THEN
          DELETE
            FROM TMP_EMPTY_LOC
          WHERE NOT EXISTS (SELECT
                1
              FROM TMP_CODE CS
              WHERE CS.CodeID = 'DIM11'
              AND CS.CODE = TMP_EMPTY_LOC.LOCATIONID);
        END IF;
      END IF;
    END IF;
    IF IN_Dimension_Restrictions1 = '12'
      OR IN_Dimension_Restrictions2 = '12'
      OR IN_Dimension_Restrictions3 = '12'
      OR IN_Dimension_Restrictions4 = '12'
      OR IN_Dimension_Restrictions5 = '12' THEN
      SET v_error = 1;
      SELECT
        DynamicPickingCount
      FROM BAS_FORWARDING_LOC T
      WHERE CustomerID = In_CustomerID
      AND SKU = IN_SKU
      AND T.LOCATION_USAGE = 'EA'
      AND FWDLOC LIKE 'DYNAMIC%'
      LIMIT 1 INTO r_DynamicPickingCount;
      IF v_error = 0 THEN
        SET r_DynamicPickingCount = 0;
      END IF;
      IF r_DynamicPickingCount > 0 THEN
        DELETE
          FROM TMP_CODE;
        INSERT INTO TMP_CODE (CODE, CODEID)
          SELECT DISTINCT
            a.LocationID,
            'DIM12'
          FROM INV_LOT_LOC_ID a
            INNER JOIN BAS_LOCATION b
              ON a.LOCATIONID = b.LOCATIONID
              AND a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
          WHERE a.organizationId = In_organizationId
          AND a.CustomerID = iN_CustomerID
          AND a.SKU = IN_SKU
          AND b.LocationUsage = 'EA';

        SELECT
          COUNT(*)
        FROM TMP_CODE
        WHERE CodeID = 'DIM12' INTO r_DynamicLocationCount;

        IF r_DynamicLocationCount >= r_DynamicPickingCount THEN
          DELETE
            FROM TMP_EMPTY_LOC
          WHERE NOT EXISTS (SELECT
                1
              FROM TMP_CODE EA
              WHERE EA.CodeID = 'DIM12'
              AND EA.CODE = TMP_EMPTY_LOC.LOCATIONID);
        END IF;
      END IF;
    END IF;



    IF IN_LocationStatus_Includes1 = '02'
      OR IN_LocationStatus_Includes2 = '02'
      OR IN_LocationStatus_Includes3 = '02'
      OR IN_LocationStatus_Includes4 = '02' THEN
      DELETE
        FROM TMP_EMPTY_LOC
      WHERE LocationID IN (SELECT
            TOLOCATION
          FROM DOC_TRANSFER_DETAILS
          WHERE organizationId = In_organizationId
          AND TDOCLineStatus < '10');
      DELETE
        FROM TMP_EMPTY_LOC
      WHERE LocationID IN (SELECT
            TOLOCATION
          FROM DOC_MOVEMENT_DETAILS
          WHERE organizationId = In_organizationId
          AND MDOCLineStatus < '10');
    END IF;












    IF IN_LocationStatus_Includes1 = '04'
      OR IN_LocationStatus_Includes2 = '04'
      OR IN_LocationStatus_Includes3 = '04'
      OR IN_LocationStatus_Includes4 = '04'
      OR IN_LocationStatus_Includes1 = '07'
      OR IN_LocationStatus_Includes2 = '07'
      OR IN_LocationStatus_Includes3 = '07'
      OR IN_LocationStatus_Includes4 = '07' THEN

      SET r_LOTKEY01 = 'N';
      SET r_LOTKEY02 = 'N';
      SET r_LOTKEY03 = 'N';
      SET r_LOTKEY04 = 'N';
      SET r_LOTKEY05 = 'N';
      SET r_LOTKEY06 = 'N';
      SET r_LOTKEY07 = 'N';
      SET r_LOTKEY08 = 'N';
      SET r_LOTKEY09 = 'N';
      SET r_LOTKEY10 = 'N';
      SET r_LOTKEY11 = 'N';
      SET r_LOTKEY12 = 'N';
      SET r_LOTKEY13 = 'N';
      SET r_LOTKEY14 = 'N';
      SET r_LOTKEY15 = 'N';
      SET r_LOTKEY16 = 'N';
      SET r_LOTKEY17 = 'N';
      SET r_LOTKEY18 = 'N';
      SET r_LOTKEY19 = 'N';
      SET r_LOTKEY20 = 'N';
      SET r_LOTKEY21 = 'N';
      SET r_LOTKEY22 = 'N';
      SET r_LOTKEY23 = 'N';
      SET r_LOTKEY24 = 'N';
      OPEN CUR_LOTID;
      SET v_error = 1;
      FETCH CUR_LOTID INTO v_lotAttId, v_lotKey;
      WHILE v_error <> 0 DO
        IF UPPER(v_lotAttId) = 'LOTATT01' THEN
          SET r_LOTKEY01 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT02' THEN
          SET r_LOTKEY02 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT03' THEN
          SET r_LOTKEY03 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT04' THEN
          SET r_LOTKEY04 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT05' THEN
          SET r_LOTKEY05 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT06' THEN
          SET r_LOTKEY06 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT07' THEN
          SET r_LOTKEY07 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT08' THEN
          SET r_LOTKEY08 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT09' THEN
          SET r_LOTKEY09 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT10' THEN
          SET r_LOTKEY10 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT11' THEN
          SET r_LOTKEY11 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT12' THEN
          SET r_LOTKEY12 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT13' THEN
          SET r_LOTKEY13 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT14' THEN
          SET r_LOTKEY14 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT15' THEN
          SET r_LOTKEY15 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT16' THEN
          SET r_LOTKEY16 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT17' THEN
          SET r_LOTKEY17 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT18' THEN
          SET r_LOTKEY18 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT19' THEN
          SET r_LOTKEY19 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT20' THEN
          SET r_LOTKEY20 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT21' THEN
          SET r_LOTKEY21 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT22' THEN
          SET r_LOTKEY22 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT23' THEN
          SET r_LOTKEY23 = v_lotKey;
        ELSEIF UPPER(v_lotAttId) = 'LOTATT24' THEN
          SET r_LOTKEY24 = v_lotKey;
        END IF;
        SET v_error = 1;
        FETCH CUR_LOTID INTO v_lotAttId, v_lotKey;
      END WHILE;


      SELECT
        IFNULL(LotAtt01, '*'),
        IFNULL(LotAtt02, '*'),
        IFNULL(LotAtt03, '*'),
        IFNULL(LotAtt04, '*'),
        IFNULL(LotAtt05, '*'),
        IFNULL(LotAtt06, '*'),
        IFNULL(LotAtt07, '*'),
        IFNULL(LotAtt08, '*'),
        IFNULL(LotAtt09, '*'),
        IFNULL(LotAtt10, '*'),
        IFNULL(LotAtt11, '*'),
        IFNULL(LotAtt12, '*'),
        IFNULL(LotAtt13, '*'),
        IFNULL(LotAtt14, '*'),
        IFNULL(LotAtt15, '*'),
        IFNULL(LotAtt16, '*'),
        IFNULL(LotAtt17, '*'),
        IFNULL(LotAtt18, '*'),
        IFNULL(LotAtt19, '*'),
        IFNULL(LotAtt20, '*'),
        IFNULL(LotAtt21, '*'),
        IFNULL(LotAtt22, '*'),
        IFNULL(LotAtt23, '*'),
        IFNULL(LotAtt24, '*')
      FROM INV_LOT_ATT
      WHERE organizationId = In_organizationId
      AND lotnum = IN_Lotnum INTO r_ALotAtt01, r_ALotAtt02, r_ALotAtt03
      , r_ALotAtt04, r_ALotAtt05, r_ALotAtt06
      , r_ALotAtt07, r_ALotAtt08, r_ALotAtt09
      , r_ALotAtt10, r_ALotAtt11, r_ALotAtt12
      , r_ALotAtt13, r_ALotAtt14, r_ALotAtt15
      , r_ALotAtt16, r_ALotAtt17, r_ALotAtt18
      , r_ALotAtt19, r_ALotAtt20, r_ALotAtt21
      , r_ALotAtt22, r_ALotAtt23, r_ALotAtt24;
    END IF;

    IF IN_LocationStatus_Includes1 = '03'
      OR IN_LocationStatus_Includes2 = '03'
      OR IN_LocationStatus_Includes3 = '03'
      OR IN_LocationStatus_Includes4 = '06' THEN
      DELETE
        FROM TMP_EMPTY_LOC
      WHERE LocationID IN (SELECT
            LocationID
          FROM INV_LOT_LOC_ID a
          WHERE a.organizationId = In_organizationId
          AND (a.CustomerID <> IN_CustomerID
          OR a.SKU <> IN_SKU));
    END IF;
    IF IN_LocationStatus_Includes1 = '04'
      OR IN_LocationStatus_Includes2 = '04'
      OR IN_LocationStatus_Includes3 = '04'
      OR IN_LocationStatus_Includes4 = '04' THEN

      SET r_SQL = CONCAT('DELETE FROM TMP_EMPTY_LOC
    where exists(select 1
    from INV_LOT_LOC_ID a 
   inner join INV_LOT_ATT c
      on a.organizationId = c.organizationId
     and a.lotnum = c.lotnum
    where a.organizationId = ''', IN_organizationId, '''
      and a.LocationID = TMP_EMPTY_LOC.Locationid
      and a.CustomerID = ''', IN_CustomerID, ''' and a.SKU = ''', IN_SKU, ''' and (1 = 2');
      IF r_LOTKEY01 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt01,''*'')<> ''', IFNULL(r_ALotatt01, '*'), '''');
      END IF;
      IF r_LOTKEY02 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt02,''*'')<> ''', IFNULL(r_ALotatt02, '*'), '''');
      END IF;
      IF r_LOTKEY03 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt03,''*'')<> ''', IFNULL(r_ALotatt03, '*'), '''');
      END IF;
      IF r_LOTKEY04 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt04,''*'')<> ''', IFNULL(r_ALotatt04, '*'), '''');
      END IF;
      IF r_LOTKEY05 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt05,''*'')<> ''', IFNULL(r_ALotatt05, '*'), '''');
      END IF;
      IF r_LOTKEY06 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt06,''*'')<> ''', IFNULL(r_ALotatt06, '*'), '''');
      END IF;
      IF r_LOTKEY07 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt07,''*'')<> ''', IFNULL(r_ALotatt07, '*'), '''');
      END IF;
      IF r_LOTKEY08 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt08,''*'')<> ''', IFNULL(r_ALotatt08, '*'), '''');
      END IF;
      IF r_LOTKEY09 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt09,''*'')<> ''', IFNULL(r_ALotatt09, '*'), '''');
      END IF;
      IF r_LOTKEY10 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt10,''*'')<> ''', IFNULL(r_ALotatt10, '*'), '''');
      END IF;
      IF r_LOTKEY11 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt11,''*'')<> ''', IFNULL(r_ALotatt11, '*'), '''');
      END IF;
      IF r_LOTKEY12 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt12,''*'')<> ''', IFNULL(r_ALotatt12, '*'), '''');
      END IF;
      IF r_LOTKEY13 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt13,''*'')<> ''', IFNULL(r_ALotatt13, '*'), '''');
      END IF;
      IF r_LOTKEY14 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt14,''*'')<> ''', IFNULL(r_ALotatt14, '*'), '''');
      END IF;
      IF r_LOTKEY15 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt15,''*'')<> ''', IFNULL(r_ALotatt15, '*'), '''');
      END IF;
      IF r_LOTKEY16 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt16,''*'')<> ''', IFNULL(r_ALotatt16, '*'), '''');
      END IF;
      IF r_LOTKEY17 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt17,''*'')<> ''', IFNULL(r_ALotatt17, '*'), '''');
      END IF;
      IF r_LOTKEY18 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt18,''*'')<> ''', IFNULL(r_ALotatt18, '*'), '''');
      END IF;
      IF r_LOTKEY19 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt19,''*'')<> ''', IFNULL(r_ALotatt19, '*'), '''');
      END IF;
      IF r_LOTKEY20 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt20,''*'')<> ''', IFNULL(r_ALotatt20, '*'), '''');
      END IF;
      IF r_LOTKEY21 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt21,''*'')<> ''', IFNULL(r_ALotatt21, '*'), '''');
      END IF;
      IF r_LOTKEY22 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt22,''*'')<> ''', IFNULL(r_ALotatt22, '*'), '''');
      END IF;
      IF r_LOTKEY23 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt23,''*'')<> ''', IFNULL(r_ALotatt23, '*'), '''');
      END IF;
      IF r_LOTKEY24 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' or ifnull(c.lotatt24,''*'')<> ''', IFNULL(r_ALotatt24, '*'), '''');
      END IF;
      SET r_SQL = CONCAT(r_SQL, '))');
      SET @SQL = r_SQL;
      SET v_errormessage = @SQL;
      PREPARE STMT FROM @SQL;
      EXECUTE STMT;
      DEALLOCATE PREPARE STMT;

    END IF;
    IF IN_LocationStatus_Includes1 = '06'
      OR IN_LocationStatus_Includes2 = '06'
      OR IN_LocationStatus_Includes3 = '06'
      OR IN_LocationStatus_Includes4 = '06' THEN
      DELETE
        FROM TMP_EMPTY_LOC
      WHERE LocationID NOT IN (SELECT
            LocationID
          FROM INV_LOT_LOC_ID a
          WHERE a.organizationId = In_organizationId
          AND a.CustomerID = IN_CustomerID
          AND a.SKU = IN_SKU);
    END IF;
    IF IN_LocationStatus_Includes1 = '07'
      OR IN_LocationStatus_Includes2 = '07'
      OR IN_LocationStatus_Includes3 = '07'
      OR IN_LocationStatus_Includes4 = '07' THEN

      SET r_SQL = CONCAT('DELETE FROM TMP_EMPTY_LOC
      where LocationID not in
      (select LocationID FROM INV_LOT_LOC_ID a inner join INV_LOT_ATT c on a.organizationId = c.organizationId and a.LotNum = c.LotNum
      where a.CustomerID = ''', IN_CustomerID, ''' and a.SKU = ''', IN_SKU, '''');
      IF r_LOTKEY01 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt01,''*'') = ''', r_ALotatt01, '''');
      END IF;
      IF r_LOTKEY02 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt02,''*'') = ''', r_ALotatt02, '''');
      END IF;
      IF r_LOTKEY03 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt03,''*'') = ''', r_ALotatt03, '''');
      END IF;
      IF r_LOTKEY04 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt04,''*'') = ''', r_ALotatt04, '''');
      END IF;
      IF r_LOTKEY05 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt05,''*'') = ''', r_ALotatt05, '''');
      END IF;
      IF r_LOTKEY06 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt06,''*'') = ''', r_ALotatt06, '''');
      END IF;
      IF r_LOTKEY07 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt07,''*'') = ''', r_ALotatt07, '''');
      END IF;
      IF r_LOTKEY08 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt08,''*'') = ''', r_ALotatt08, '''');
      END IF;
      IF r_LOTKEY09 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt09,''*'') = ''', r_ALotatt09, '''');
      END IF;
      IF r_LOTKEY10 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt10,''*'') = ''', r_ALotatt10, '''');
      END IF;
      IF r_LOTKEY11 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt11,''*'') = ''', r_ALotatt11, '''');
      END IF;
      IF r_LOTKEY12 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt12,''*'') = ''', r_ALotatt12, '''');
      END IF;
      IF r_LOTKEY13 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt13,''*'') = ''', r_ALotatt13, '''');
      END IF;
      IF r_LOTKEY14 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt14,''*'') = ''', r_ALotatt14, '''');
      END IF;
      IF r_LOTKEY15 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt15,''*'') = ''', r_ALotatt15, '''');
      END IF;
      IF r_LOTKEY16 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt16,''*'') = ''', r_ALotatt16, '''');
      END IF;
      IF r_LOTKEY17 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt17,''*'') = ''', r_ALotatt17, '''');
      END IF;
      IF r_LOTKEY18 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt18,''*'') = ''', r_ALotatt18, '''');
      END IF;
      IF r_LOTKEY19 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt19,''*'') = ''', r_ALotatt19, '''');
      END IF;
      IF r_LOTKEY20 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt20,''*'') = ''', r_ALotatt20, '''');
      END IF;
      IF r_LOTKEY21 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt21,''*'') = ''', r_ALotatt21, '''');
      END IF;
      IF r_LOTKEY22 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt22,''*'') = ''', r_ALotatt22, '''');
      END IF;
      IF r_LOTKEY23 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt23,''*'') = ''', r_ALotatt23, '''');
      END IF;
      IF r_LOTKEY24 <> 'N' THEN
        SET r_SQL = CONCAT(r_SQL, ' and ifnull(c.lotatt24,''*'') = ''', r_ALotatt24, '''');
      END IF;
      SET r_SQL = CONCAT(r_SQL, ')');
      SET @SQL = r_SQL;
      SET v_errormessage = @SQL;
      PREPARE STMT FROM @SQL;
      EXECUTE STMT;
      DEALLOCATE PREPARE STMT;

    END IF;
    IF IN_LocationStatus_Includes1 IN ('08', '09', '10', '11', '12')
      OR IN_LocationStatus_Includes2 IN ('08', '09', '10', '11', '12')
      OR IN_LocationStatus_Includes3 IN ('08', '09', '10', '11', '12')
      OR IN_LocationStatus_Includes4 IN ('08', '09', '10', '11', '12') THEN
      SELECT
        a.SKu_Group1,
        a.SKu_Group2,
        a.SKu_Group3,
        a.SKu_Group4,
        a.SKu_Group5
      FROM BAS_SKU a
      WHERE a.organizationId = In_organizationId
      AND a.CustomerID = IN_CustomerID
      AND a.SKU = IN_SKU INTO r_SKuGroup1, r_SKuGroup2, r_SKuGroup3
      , r_SKuGroup4, r_SKuGroup5;
      IF IN_LocationStatus_Includes1 = '08'
        OR IN_LocationStatus_Includes2 = '08'
        OR IN_LocationStatus_Includes3 = '08'
        OR IN_LocationStatus_Includes4 = '08' THEN
        DELETE
          FROM TMP_EMPTY_LOC
        WHERE LocationID NOT IN (SELECT
              LocationID
            FROM INV_LOT_LOC_ID a
              INNER JOIN BAS_SKU c
                ON a.organizationId = b.organizationId
                AND a.customerId = b.customerId
                AND a.sku = b.sku
            WHERE a.organizationId = In_organizationId
            AND c.SKU_Group1 = r_SKUGroup1);
      END IF;
      IF IN_LocationStatus_Includes1 = '09'
        OR IN_LocationStatus_Includes2 = '09'
        OR IN_LocationStatus_Includes3 = '09'
        OR IN_LocationStatus_Includes4 = '09' THEN
        DELETE
          FROM TMP_EMPTY_LOC
        WHERE LocationID NOT IN (SELECT
              LocationID
            FROM INV_LOT_LOC_ID a
              INNER JOIN BAS_SKU c
                ON a.organizationId = b.organizationId
                AND a.customerId = b.customerId
                AND a.sku = b.sku
            WHERE a.organizationId = In_organizationId
            AND c.SKU_Group2 = r_SKUGroup2);
      END IF;
      IF IN_LocationStatus_Includes1 = '10'
        OR IN_LocationStatus_Includes2 = '10'
        OR IN_LocationStatus_Includes3 = '10'
        OR IN_LocationStatus_Includes4 = '10' THEN
        DELETE
          FROM TMP_EMPTY_LOC
        WHERE LocationID NOT IN (SELECT
              a.LocationID
            FROM INV_LOT_LOC_ID a
              INNER JOIN BAS_SKU c
                ON a.organizationId = b.organizationId
                AND a.customerId = b.customerId
                AND a.sku = b.sku
            WHERE a.organizationId = In_organizationId
            AND c.SKU_Group3 = r_SKUGroup3);
      END IF;
      IF IN_LocationStatus_Includes1 = '11'
        OR IN_LocationStatus_Includes2 = '11'
        OR IN_LocationStatus_Includes3 = '11'
        OR IN_LocationStatus_Includes4 = '11' THEN
        DELETE
          FROM TMP_EMPTY_LOC
        WHERE LocationID NOT IN (SELECT
              LocationID
            FROM INV_LOT_LOC_ID a
              INNER JOIN BAS_SKU c
                ON a.organizationId = b.organizationId
                AND a.customerId = b.customerId
                AND a.sku = b.sku
            WHERE a.organizationId = In_organizationId
            AND c.SKU_Group4 = r_SKUGroup4);
      END IF;
      IF IN_LocationStatus_Includes1 = '12'
        OR IN_LocationStatus_Includes2 = '12'
        OR IN_LocationStatus_Includes3 = '12'
        OR IN_LocationStatus_Includes4 = '12' THEN
        DELETE
          FROM TMP_EMPTY_LOC
        WHERE LocationID NOT IN (SELECT
              LocationID
            FROM INV_LOT_LOC_ID a
              INNER JOIN BAS_SKU c
                ON a.organizationId = b.organizationId
                AND a.customerId = b.customerId
                AND a.sku = b.sku
            WHERE a.organizationId = In_organizationId
            AND c.SKU_Group5 = r_SKUGroup5);
      END IF;

    END IF;
    DELETE
      FROM TMP_EMPTY_LOC
    WHERE LocationID IN (SELECT
          LocationID
        FROM TMP_EMPTY_LOCATIONLOCKER);
  END
  $$

--
-- Create procedure `SPASN_Putaway_restrictioncheck`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPASN_Putaway_restrictioncheck (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_CustomerID varchar(30),
IN IN_SKU varchar(50),
IN IN_LotNum varchar(10),
IN IN_PackID varchar(20),
IN IN_ToLoc varchar(60),
IN IN_Weight varchar(20),
IN IN_Cubic varchar(20),
IN IN_Qty varchar(20),
IN IN_Dimension_Restriction1 varchar(100),
IN IN_Dimension_Restriction2 varchar(100),
IN IN_Dimension_Restriction3 varchar(100),
IN IN_Dimension_Restriction4 varchar(100),
IN IN_Dimension_Restriction5 varchar(100),
IN IN_LocationStatus_Includes1 varchar(100),
IN IN_LocationStatus_Includes2 varchar(100),
IN IN_LocationStatus_Includes3 varchar(100),
IN IN_LocationStatus_Includes4 varchar(100),
IN IN_LocationUsage_Includes1 varchar(100),
IN IN_LocationUsage_Includes2 varchar(100),
IN IN_LocationUsage_Includes3 varchar(100),
IN IN_LocationUsage_Includes4 varchar(100),
IN IN_LocationUsage_Includes5 varchar(100),
IN IN_LocationUsage_Excludes1 varchar(100),
IN IN_LocationUsage_Excludes2 varchar(100),
IN IN_LocationUsage_Excludes3 varchar(100),
IN IN_LocationUsage_Excludes4 varchar(100),
IN IN_LocationUsage_Excludes5 varchar(100),
IN IN_LocationCategory_Includes1 varchar(100),
IN IN_LocationCategory_Includes2 varchar(100),
IN IN_LocationCategory_Includes3 varchar(100),
IN IN_LocationCategory_Includes4 varchar(100),
IN IN_LocationCategory_Excludes1 varchar(100),
IN IN_LocationCategory_Excludes2 varchar(100),
IN IN_LocationCategory_Excludes3 varchar(100),
IN IN_LocationCategory_Excludes4 varchar(100),
IN IN_LocationAttribute_Includes1 varchar(100),
IN IN_LocationAttribute_Includes2 varchar(100),
IN IN_LocationAttribute_Includes3 varchar(100),
IN IN_LocationAttribute_Includes4 varchar(100),
IN IN_LocationAttribute_Excludes1 varchar(100),
IN IN_LocationAttribute_Excludes2 varchar(100),
IN IN_LocationAttribute_Excludes3 varchar(100),
IN IN_LocationAttribute_Excludes4 varchar(100),
IN IN_LocationHandling_Includes1 varchar(100),
IN IN_LocationHandling_Includes2 varchar(100),
IN IN_LocationHandling_Includes3 varchar(100),
IN IN_LocationHandling_Includes4 varchar(100),
IN IN_LocationHandling_Excludes1 varchar(100),
IN IN_LocationHandling_Excludes2 varchar(100),
IN IN_LocationHandling_Excludes3 varchar(100),
IN IN_LocationHandling_Excludes4 varchar(100),
IN IN_LocationDemand_Includes1 varchar(100),
IN IN_LocationDemand_Includes2 varchar(100),
IN IN_LocationDemand_Includes3 varchar(100),
IN IN_LocationDemand_Excludes1 varchar(100),
IN IN_LocationDemand_Excludes2 varchar(100),
IN IN_LocationDemand_Excludes3 varchar(100),
IN IN_LocationGroup1_Includes1 varchar(100),
IN IN_LocationGroup1_Includes2 varchar(100),
IN IN_LocationGroup2_Includes1 varchar(100),
IN IN_LocationGroup2_Includes2 varchar(100),
IN IN_LocationGroup1_Excludes1 varchar(100),
IN IN_LocationGroup1_Excludes2 varchar(100),
IN IN_LocationGroup2_Excludes1 varchar(100),
IN IN_LocationGroup2_Excludes2 varchar(100),
IN IN_MaxMixSKU varchar(20),
IN IN_MaxMixLOT varchar(20),
INOUT OUT_FOUND varchar(1))
ENDPROC:
  BEGIN


    DECLARE r_DIMres varchar(2);
    DECLARE r_Dimi int;
    DECLARE r_STSres varchar(2);
    DECLARE r_SumQty decimal(18, 8);
    DECLARE r_SumWeight decimal(18, 8);
    DECLARE r_SumCubic decimal(18, 8);
    DECLARE r_sumLPN int;
    DECLARE r_SumPallet1 int;
    DECLARE r_SumPallet2 int;
    DECLARE r_SumPallet3 int;
    DECLARE r_SumCase1 int;
    DECLARE r_SumCase2 int;
    DECLARE r_SumTemp decimal(18, 8);
    DECLARE r_CountCapacity int;
    DECLARE r_WeightCapacity decimal(18, 8);
    DECLARE r_CubicCapacity decimal(18, 8);
    DECLARE r_PLCount int;
    DECLARE r_LocationHeight decimal(18, 8);
    DECLARE r_LocationArea decimal(18, 8);
    DECLARE r_Locationlength decimal(18, 8);
    DECLARE r_Locationwidth decimal(18, 8);
    DECLARE r_SKUHeight decimal(18, 8);
    DECLARE r_TempQty4 decimal(18, 8);
    DECLARE r_Levels char(1);
    DECLARE r_Levels_int int;
    DECLARE r_SKUArea decimal(18, 8);
    DECLARE r_SKUCSArea decimal(18, 8);
    DECLARE r_SKUPLArea decimal(18, 8);
    DECLARE r_SumHeight decimal(18, 8);
    DECLARE r_CountPerLevel int;
    DECLARE r_Mix_Flag char(1);
    DECLARE r_Mix_LotFlag char(1);
    DECLARE r_LocationUsage varchar(2);
    DECLARE r_LocationCategory varchar(2);
    DECLARE r_LocationAttribute varchar(2);
    DECLARE r_LocationHandling varchar(2);
    DECLARE r_LocationDemand char(1);
    DECLARE r_LocationGroup1 varchar(10);
    DECLARE r_LocationGroup2 varchar(10);
    DECLARE r_LotAtt01 varchar(100);
    DECLARE r_LotAtt02 varchar(100);
    DECLARE r_LotAtt03 varchar(100);
    DECLARE r_LotAtt04 varchar(100);
    DECLARE r_LotAtt05 varchar(100);
    DECLARE r_LotAtt06 varchar(100);
    DECLARE r_LotAtt07 varchar(100);
    DECLARE r_LotAtt08 varchar(100);
    DECLARE r_LotAtt09 varchar(100);
    DECLARE r_LotAtt10 varchar(100);
    DECLARE r_LotAtt11 varchar(100);
    DECLARE r_LotAtt12 varchar(100);
    DECLARE r_PUTAWAY_OT char(1);
    DECLARE r_PLT_CNT char(1);
    DECLARE r_CSCount int;
    DECLARE r_TempQty3 decimal(18, 8);
    DECLARE r_SKUGroup1 varchar(50);
    DECLARE r_SKUGroup2 varchar(50);
    DECLARE r_SKUGroup3 varchar(50);
    DECLARE r_SKUGroup4 varchar(50);
    DECLARE r_SKUGroup5 varchar(50);
    DECLARE r_DynamicPickingCount int;
    DECLARE r_DynamicLocationCount int;
    DECLARE r_LOTKEY01 char(1);
    DECLARE r_LOTKEY02 char(1);
    DECLARE r_LOTKEY03 char(1);
    DECLARE r_LOTKEY04 char(1);
    DECLARE r_LOTKEY05 char(1);
    DECLARE r_LOTKEY06 char(1);
    DECLARE r_LOTKEY07 char(1);
    DECLARE r_LOTKEY08 char(1);
    DECLARE r_LOTKEY09 char(1);
    DECLARE r_LOTKEY10 char(1);
    DECLARE r_LOTKEY11 char(1);
    DECLARE r_LOTKEY12 char(1);
    DECLARE v_nRow_task int;
    DECLARE v_nRow_task_LOC int;
    DECLARE v_nRow_INV int;
    DECLARE v_nRow_INV_LOC int;
    DECLARE v_nRow_trace int;
    DECLARE v_nRow_trace_LOC int;
    DECLARE r_SumSKUWidth1 decimal(18, 8);
    DECLARE r_SumSKUWidth2 decimal(18, 8);
    DECLARE r_LocLength decimal(18, 8);
    DECLARE r_LocGroup1 varchar(50);
    DECLARE r_packid varchar(40);
    DECLARE r_LotID varchar(60);
    DECLARE r_code varchar(30);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE r_CurrentTime timestamp;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SET OUT_FOUND = 'T';
      SELECT
        CONCAT('999#SPASN_Putaway_restrictioncheck,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    SET v_NO_COMMIT = 'N';




    SET R_CurrentTime = NOW();
    SET OUT_FOUND = 'T';
    IF IFNULL(IN_ToLoc, '') = '' THEN
      SET out_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;

    SELECT
      COUNT(1)
    FROM BAS_LOCATION a
    WHERE a.organizationId = In_organizationId
    AND a.warehouseid = IN_Warehouse
    AND a.locationid = IN_ToLoc INTO v_nRow;
    IF v_nRow = 0 THEN
      SET out_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;



    SET v_error = 1;
    SELECT
      IFNULL(CubicCapacity, 0),
      IFNULL(WeightCapacity, 0),
      IFNULL(EACount, 0),
      IFNULL(PLCount, 0),
      IFNULL(Height, 0),
      IFNULL(LENGTH * Width, 0),
      IFNULL(LENGTH, 0),
      IFNULL(Width, 0),
      IFNULL(CSCount, 0),
      IFNULL(Mix_Flag, ''),
      IFNULL(Mix_LotFlag, ''),
      IFNULL(LocationUsage, ''),
      IFNULL(LocationCategory, ''),
      IFNULL(LocationAttribute, ''),
      IFNULL(LocationHandling, ''),
      IFNULL(Demand, ''),
      IFNULL(LocGroup1, ''),
      IFNULL(LocGroup2, '')
    FROM BAS_LOCATION
    WHERE organizationId = In_organizationId
    AND warehouseId = In_warehouse
    AND LocationID = IN_ToLoc INTO r_CubicCapacity, r_WeightCapacity, R_CountCapacity
    , R_PLCount, R_LocationHeight, R_LocationArea
    , r_LocationLength
    , r_LocationWidth
    , r_CSCount
    , r_Mix_Flag, r_Mix_LotFlag, r_LocationUsage, r_LocationCategory
    , r_LocationAttribute, r_LocationHandling, r_LocationDemand, r_LocationGroup1
    , r_LocationGroup2;
    IF v_error = 0 THEN
      SET out_FOUND = 'T';
      LEAVE ENDPROC;
    END IF;
    SET r_PLT_CNT = getsys_configuration(IN_organizationId, IN_Warehouse, IN_CustomerID, '', 'PLT_CNT');
    IF IFNULL(r_PLT_CNT, '') = '' THEN
      SET r_PLT_CNT = 'N';
    END IF;




    IF IFNULL(TRIM(IN_Dimension_Restriction1), '') <> ''
      OR IFNULL(TRIM(IN_Dimension_Restriction2), '') <> ''
      OR IFNULL(TRIM(IN_Dimension_Restriction3), '') <> ''
      OR IFNULL(TRIM(IN_Dimension_Restriction4), '') <> ''
      OR IFNULL(TRIM(IN_Dimension_Restriction5), '') <> '' THEN

      SET v_error = 1;
      SELECT
        IFNULL(SUM(a.qty + a.QTYPA + QTYRPIN + QTYMVIN), 0),
        IFNULL(SUM((a.qty + a.QTYPA + QTYRPIN + QTYMVIN) * b.GrossWeight), 0),
        IFNULL(SUM((a.qty + a.QTYPA + QTYRPIN + QTYMVIN) * b.Cube), 0),
        COUNT(DISTINCT LPN)
      FROM INV_LOT_LOC_ID a
        INNER JOIN BAS_SKU b
          ON a.organizationId = b.organizationId
          AND a.customerId = b.customerId
          AND a.sku = b.sku
      WHERE a.organizationId = In_organizationId
      AND a.LocationID = IN_ToLoc INTO R_sumqty, R_sumweight, R_sumcubic, r_sumLPN;
      IF v_error = 0 THEN
        SET R_sumqty = 0;
        SET R_sumweight = 0;
        SET R_sumcubic = 0;
      END IF;

      IF IN_Dimension_Restriction1 = '13'
        OR IN_Dimension_Restriction2 = '13'
        OR IN_Dimension_Restriction3 = '13'
        OR IN_Dimension_Restriction4 = '13'
        OR IN_Dimension_Restriction5 = '13' THEN
        IF r_sumLPN >= R_PLCount THEN
          SET OUT_FOUND = 'N';
          LEAVE ENDPROC;
        END IF;
      END IF;







      SELECT
        SUBSTR(TRIM(ReservedField01), 1, 1),
        IFNULL(a.SKULength * a.SKUWidth, 0),
        a.SKu_Group1,
        a.SKu_Group2,
        a.SKu_Group3,
        a.SKu_Group4,
        a.SKu_Group5,
        packid
      FROM BAS_SKU a
      WHERE a.CustomerID = IN_CustomerID
      AND a.SKU = IN_SKU
      AND a.organizationId = In_organizationId INTO R_Levels, r_SKUArea
      , r_SKUGroup1, R_SKUGroup2, R_SKUGroup3, R_SKUGroup4, R_SKUGroup5
      , r_packid;


      SELECT
        b.qty,
        IFNULL(b.height, 0),
        IFNULL(b.Length * b.width, 0)
      FROM BAS_PACKAGE_DETAILS b
      WHERE b.CustomerID = IN_CustomerID
      AND b.packid = r_packid
      AND b.organizationId = In_organizationId
      AND b.packuom = 'PL' INTO R_TempQty4, r_SKUHeight, r_SKUPLArea;

      SELECT
        b.qty,
        IFNULL(b.length * b.width, 0)
      FROM BAS_PACKAGE_DETAILS b
      WHERE b.CustomerID = IN_CustomerID
      AND b.packid = r_packid
      AND b.organizationId = In_organizationId
      AND b.packuom = 'CS' INTO r_TempQty3, r_SKUCSArea;


      IF r_PLT_CNT = 'N' THEN


        SELECT
          SUM(CASE WHEN c.qty > 0 THEN CEIL(a.qty / c.qty) ELSE 1 END),
          SUM(CASE WHEN d.qty > 0 THEN CEIL(a.qty / d.qty) ELSE 1 END),
          SUM(GetLocationSKUHeight(a.Qty, c.Qty, d.Qty, d.length, d.width, d.height, c.length, c.width, c.height, b.SKULENGTH, b.SKUWIDTH, b.skuhigh, R_Locationlength, r_LocationWidth, r_LocationUsage))
        FROM (SELECT
            organizationId,
            warehouseId,
            customerid,
            sku,
            SUM(qty) qty
          FROM (SELECT
              organizationId,
              warehouseId,
              customerid,
              sku,
              qty + QTYPA + QTYRPIN + QTYMVIN qty
            FROM INV_LOT_LOC_ID
            WHERE organizationId = In_organizationId
            AND warehouseId = In_warehouse
            AND locationid = IN_ToLoc
            UNION ALL
            SELECT
              In_organizationId,
              In_warehouse,
              IN_CustomerID,
              IN_SKU,
              CAST(IN_Qty AS decimal(18, 8))
            FROM DUAL) t
          GROUP BY organizationId,
                   warehouseId,
                   customerid,
                   sku) a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.customerid = b.customerid
            AND a.sku = b.sku
          INNER JOIN BAS_PACKAGE_DETAILS c
            ON b.organizationId = c.organizationId
            AND b.customerid = c.customerid
            AND b.packid = c.packid
            AND c.packuom = 'CS'
          INNER JOIN BAS_PACKAGE_DETAILS d
            ON b.organizationId = d.organizationId
            AND b.customerid = d.customerid
            AND b.packid = d.packid
            AND d.packuom = 'PL';

        SET r_SumPallet2 = 0;
        SET r_SumCase2 = 0;

      ELSEIF r_PLT_CNT = 'Y' THEN

        SELECT
          COUNT(DISTINCT traceid)
        FROM INV_LOT_LOC_ID
        WHERE LocationID = IN_ToLoc
        AND organizationId = In_organizationId
        AND Qty > 0 INTO r_SumPallet1;

        SELECT
          COUNT(DISTINCT Plantoid)
        FROM TSK_TASKLISTS
        WHERE TaskType = 'PA'
        AND TaskProcess < '10'
        AND PlanToLocation = IN_ToLoc
        AND organizationId = In_organizationId
        AND warehouseid = IN_Warehouse INTO r_SumPallet2;

        SELECT
          COUNT(DISTINCT TraceID)
        FROM DOC_TRACE_DETAILS
        WHERE PlanToLoc = IN_ToLoc
        AND LineStatus < '20'
        AND organizationId = In_organizationId INTO r_SumPallet3;
        SET r_SumPallet2 = r_SumPallet2 + r_SumPallet3 + 1;

        SET r_SumCase1 = r_SumPallet1;
        SET r_SumCase2 = r_SumPallet2;
      ELSE
        SET r_SumCase1 = 0;
        SET r_SumCase2 = 0;
        SET r_SumPallet1 = 0;
        SET r_SumPallet2 = 0;
      END IF;

      IF (r_SKUArea IS NULL
        OR r_SKUArea = 0) THEN
        SET r_SKUArea = 99999999;
      END IF;
      IF R_Levels IS NULL THEN
        SET R_Levels = '0';
      END IF;
      IF (R_Levels >= '0'
        AND R_Levels <= '9') THEN
        SET R_levels_Int = R_Levels;
      END IF;
      IF R_Levels_int IS NULL THEN
        SET R_Levels_int = 0;
      END IF;

      IF r_LocationUsage = 'EA'
        OR r_LocationUsage = 'CS' THEN
        SET r_DynamicPickingCount = 0;
        SET r_DynamicLocationCount = 0;

        SET v_error = 1;
        SELECT
          IFNULL(SUM(a.qty + a.QTYPA + QTYRPIN + QTYMVIN), 0)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.customerId = b.customerId
            AND a.sku = b.sku
        WHERE a.LocationID = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.organizationId = In_organizationId INTO r_sumqty;
        IF v_error = 0 THEN
          SET r_sumqty = 0;
        END IF;
        SET v_error = 1;
        SELECT
          DynamicPickingCount,
          IFNULL(UpLimit, 0)
        FROM BAS_FORWARDING_LOC
        WHERE organizationId = In_organizationId
        AND warehouseid = IN_Warehouse
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU
        AND FWDLOC LIKE 'DYNAMIC%'
        LIMIT 1 INTO r_DynamicPickingCount, r_CountCapacity;
        IF v_error = 0 THEN
          SET r_DynamicPickingCount = 999;
        END IF;

        SET v_error = 1;
        SELECT
          DynamicPickingCount
        FROM BAS_FORWARDING_LOC
        WHERE organizationId = In_organizationId
        AND warehouseid = IN_Warehouse
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU
        AND ((r_LocationUsage = 'EA'
        AND FWDLOC LIKE 'DYNAMIC_EA%')
        OR (r_LocationUsage <> 'EA'
        AND FWDLOC LIKE 'DYNAMIC_CS%'))
        LIMIT 1 INTO r_DynamicPickingCount;
        IF v_error = 0 THEN
          SET r_DynamicPickingCount = 999;
        END IF;

        IF (r_LocationUsage = 'CS'
          AND (IN_Dimension_Restriction1 = '11'
          OR IN_Dimension_Restriction2 = '11'
          OR IN_Dimension_Restriction3 = '11'
          OR IN_Dimension_Restriction4 = '11'
          OR IN_Dimension_Restriction5 = '11'
          )
          )
          OR (r_LocationUsage = 'EA'
          AND (IN_Dimension_Restriction1 = '12'
          OR IN_Dimension_Restriction2 = '12'
          OR IN_Dimension_Restriction3 = '12'
          OR IN_Dimension_Restriction4 = '12'
          OR IN_Dimension_Restriction5 = '12')
          ) THEN

          IF r_DynamicPickingCount > 0 THEN
            SELECT
              COUNT(DISTINCT a.LocationID)
            FROM INV_LOT_LOC_ID a
              INNER JOIN BAS_LOCATION b
                ON a.organizationId = b.organizationId
                AND a.warehouseId = b.warehouseId
                AND a.locationId = b.locationId
            WHERE a.organizationId = In_organizationId
            AND a.CustomerID = IN_CustomerID
            AND a.SKU = IN_SKU
            AND b.LocationUsage = r_LocationUsage
            AND a.LocationID <> IN_ToLoc INTO r_DynamicLocationCount;
            IF r_DynamicLocationCount >= r_DynamicPickingCount THEN
              SET OUT_FOUND = 'N';
              LEAVE ENDPROC;
            END IF;
          END IF;
        END IF;
      END IF;

      SET R_CountPerLevel = R_LocationArea / r_SKUArea;

      IF r_Mix_Flag = 'Y'
        AND IN_MaxMixSKU <> 0 THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = In_ToLoc
        AND SKU <> IN_SKU INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixSKU THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_Mix_LotFlag = 'Y'
        AND IN_MaxMixLOT <> 0 THEN
        SELECT
          COUNT(DISTINCT LotNum)
        FROM (SELECT DISTINCT
            LotNum
          FROM INV_LOT_LOC_ID
          WHERE organizationId = In_organizationId
          AND LocationID = IN_ToLoc
          AND lotnum <> IN_LotNum
          UNION ALL

          SELECT DISTINCT
            PlanToLotNum AS LotNum
          FROM TSK_TASKLISTS
          WHERE organizationId = In_organizationId
          AND PlanToLocation = IN_ToLoc
          AND PlanToLotNum <> IN_LotNum
          AND TaskType = 'PA'
          AND TaskProcess < '10'
          UNION ALL

          SELECT DISTINCT
            LotNum
          FROM DOC_TRACE_DETAILS
          WHERE organizationId = In_organizationId
          AND PlanToLoc = IN_ToLoc
          AND LineStatus < '20'
          AND LotNUM <> IN_LotNum) X INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixLot THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;

      SELECT
        COUNT(1)
      FROM INV_LOT_LOC_ID
      WHERE organizationId = In_organizationId
      AND LocationID = IN_ToLoc
      AND SKU IN (SELECT
          ConflictSKU
        FROM BAS_SKU_CONFLICT
        WHERE organizationId = In_organizationId
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU) INTO v_nRow;
      IF v_nRow > 0 THEN
        SET OUT_FOUND = 'N';
      END IF;

      IF IN_Dimension_Restriction1 = '10'
        OR IN_Dimension_Restriction2 = '10'
        OR IN_Dimension_Restriction3 = '10'
        OR IN_Dimension_Restriction4 = '10'
        OR IN_Dimension_Restriction5 = '10' THEN
        SELECT
          IN_Qty * skuwidth
        FROM BAS_SKU
        WHERE organizationId = In_organizationId
        AND customerid = IN_CustomerID
        AND sku = IN_sku INTO r_SumSKUWidth2;
        SET v_error = 1;
        SELECT
          a.LocGroup1,
          b.length
        FROM BAS_LOCATION a
          INNER JOIN BAS_LOCGROUP1 b
            ON a.locgroup1 = b.locgroup1
            AND a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
        WHERE organizationId = In_organizationId
        AND locationid = IN_ToLoc INTO r_LocGroup1, r_LocLength;
        IF v_error = 0 THEN
          SET r_LocGroup1 = '';
          SET r_LocLength = 0;
        END IF;
        SELECT
          IFNULL(SUM((b.qty + b.qtyrpin + b.qtypa) * c.skuwidth), 0) INTO r_SumSKUWidth1
        FROM BAS_LOCATION a
          INNER JOIN INV_LOT_LOC_ID b
            ON a.locationid = b.locationid
            AND a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
          INNER JOIN BAS_SKU c
            ON a.organizationId = c.organizationId
            AND b.customerid = c.customerid
            AND b.sku = c.sku
        WHERE a.organizationId = In_organizationId
        AND a.LocGroup1 = r_LocGroup1;
      END IF;












      SET R_Dimi = 0;
    loopend:
      LOOP
        SET R_Dimi = R_Dimi + 1;
        IF R_Dimi = 1 THEN
          SET R_DimRes = IN_Dimension_Restriction1;
        ELSEIF R_Dimi = 2 THEN
          SET R_DimRes = IN_Dimension_Restriction2;
        ELSEIF R_Dimi = 3 THEN
          SET R_DimRes = IN_Dimension_Restriction3;
        ELSEIF R_Dimi = 4 THEN
          SET R_DimRes = IN_Dimension_Restriction4;
        ELSEIF R_Dimi = 5 THEN
          SET R_DimRes = IN_Dimension_Restriction5;
        END IF;
        IF (R_DimRes = '02'
          AND ((R_SumCubic + IN_Cubic) > r_CubicCapacity)) THEN
          SET OUT_FOUND = 'N';
        ELSEIF (R_DimRes = '04'
          AND ((R_SumWeight + IN_Weight) > r_WeightCapacity)) THEN
          SET OUT_FOUND = 'N';
        ELSEIF (R_DimRes = '05'
          AND ((R_SumQty + IN_Qty) > R_CountCapacity)) THEN
          SET OUT_FOUND = 'N';
        ELSEIF (R_DimRes = '06'
          AND ((R_SumPallet1 + R_SumPallet2) > R_PLCount)) THEN
          SET OUT_FOUND = 'N';
        ELSEIF (R_DimRes = '07'
          AND (r_SumHeight > R_LocationHeight
          OR (R_LocationArea < r_SKUArea
          AND R_LocationArea > 0))) THEN
          SET OUT_FOUND = 'N';
        ELSEIF (R_DimRes = '08'
          AND ((R_SumPallet1 + R_SumPallet2) > (R_CountPerLevel * R_Levels_Int))) THEN
          SET OUT_FOUND = 'N';
        ELSEIF (r_DimRes = '09'
          AND ((r_SumCase1 + r_SumCase2) > r_CSCount)) THEN
          SET OUT_FOUND = 'N';
        ELSEIF (r_DimRes = '10'
          AND ((r_SumSKUWidth1 + r_SumSKUWidth2) > r_LocLength)) THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF R_Dimi >= 5 THEN
          LEAVE loopend;
        END IF;
      END LOOP;
    END IF;
    IF OUT_FOUND = 'N' THEN
      LEAVE ENDPROC;
    END IF;














    IF TRIM(IN_LocationStatus_Includes1) IS NOT NULL
      OR TRIM(IN_LocationStatus_Includes2) IS NOT NULL
      OR TRIM(IN_LocationStatus_Includes3) IS NOT NULL
      OR TRIM(IN_LocationStatus_Includes4) IS NOT NULL THEN

      SELECT
        a.SKu_Group1,
        a.SKu_Group2,
        a.SKu_Group3,
        a.SKu_Group4,
        a.SKu_Group5,
        a.LotID
      FROM BAS_SKU a
      WHERE a.organizationId = In_organizationId
      AND a.CustomerID = IN_CustomerID
      AND a.SKU = IN_SKU INTO r_SKUGroup1, r_SKUGroup2, r_SKUGroup3, r_SKUGroup4, r_SKUGroup5
      , r_LotID;

      SELECT
        LOTKEY INTO r_LOTKEY01
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt01';
      SELECT
        LOTKEY INTO r_LOTKEY02
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt02';
      SELECT
        LOTKEY INTO r_LOTKEY03
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt03';
      SELECT
        LOTKEY INTO r_LOTKEY04
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt04';
      SELECT
        LOTKEY INTO r_LOTKEY05
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND lotID = r_LotID
      AND lotAttId = 'lotAtt05';
      SELECT
        LOTKEY INTO r_LOTKEY06
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt06';
      SELECT
        LOTKEY INTO r_LOTKEY07
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt07';
      SELECT
        LOTKEY INTO r_LOTKEY08
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt08';
      SELECT
        LOTKEY INTO r_LOTKEY09
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt09';
      SELECT
        LOTKEY INTO r_LOTKEY10
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt10';
      SELECT
        LOTKEY INTO r_LOTKEY11
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt11';

      SELECT
        LOTKEY INTO r_LOTKEY12
      FROM BAS_LOTID_DETAILS
      WHERE organizationId = In_organizationId
      AND LotID = r_LotID
      AND lotAttId = 'lotAtt12';


      SET R_STSRes = IN_LocationStatus_Includes1;
      IF R_STSRes = '02' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0 INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF R_STSRes = '03'
        OR R_Mix_Flag = 'N' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND ((SKU <> IN_SKU)
        OR (CustomerID <> IN_CustomerID)) INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF R_STSRes = '04'
        OR R_Mix_LotFlag = 'N' THEN




        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_lotnum INTO r_Lotatt01, r_Lotatt02, r_Lotatt03, r_Lotatt04, r_Lotatt05, r_Lotatt06
        , r_Lotatt07, r_Lotatt08, r_Lotatt09, r_Lotatt10, r_Lotatt11, r_Lotatt12;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU INTO v_nRow;
        IF v_nRow > 0 THEN

          SELECT
            COUNT(1)
          FROM TSK_TASKLISTS a
            INNER JOIN INV_LOT_ATT c
              ON a.organizationId = c.organizationId
              AND a.PlanToLotNum = c.LotNum
          WHERE a.organizationId = In_organizationId
          AND a.PlanToLocation = IN_ToLoc
          AND a.CustomerID = IN_CustomerID
          AND a.SKU = IN_SKU
          AND a.taskprocess < '10'
          AND a.TaskType = 'PA'
          AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
              r_LOTKEY01 = 'Y') OR
              (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
              r_LOTKEY02 = 'Y') OR
              (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
              r_LOTKEY03 = 'Y') OR
              (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
              r_LOTKEY04 = 'Y') OR
              (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
              r_LOTKEY05 = 'Y') OR
              (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
              r_LOTKEY06 = 'Y') OR
              (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
              r_LOTKEY07 = 'Y') OR
              (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
              r_LOTKEY08 = 'Y') OR
              (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
              r_LOTKEY09 = 'Y') OR
              (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
              r_LOTKEY10 = 'Y') OR
              (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
              r_LOTKEY11 = 'Y') OR
              (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
              r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_FOUND = 'N';
          ELSE

            SELECT
              COUNT(1)
            FROM INV_LOT_LOC_ID a
              INNER JOIN INV_LOT_ATT c
                ON a.organizationId = c.organizationId
                AND a.LotNum = c.LotNum
            WHERE a.organizationId = In_organizationId
            AND a.LocationID = IN_ToLoc
            AND a.CustomerID = IN_CustomerID
            AND a.SKU = IN_SKU
            AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
                r_LOTKEY01 = 'Y') OR
                (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
                r_LOTKEY02 = 'Y') OR
                (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
                r_LOTKEY03 = 'Y') OR
                (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
                r_LOTKEY04 = 'Y') OR
                (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
                r_LOTKEY05 = 'Y') OR
                (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
                r_LOTKEY06 = 'Y') OR
                (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
                r_LOTKEY07 = 'Y') OR
                (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
                r_LOTKEY08 = 'Y') OR
                (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
                r_LOTKEY09 = 'Y') OR
                (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
                r_LOTKEY10 = 'Y') OR
                (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
                r_LOTKEY11 = 'Y') OR
                (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
                r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
            IF v_nRow > 0 THEN
              SET OUT_FOUND = 'N';
            ELSE

              SELECT
                COUNT(1)
              FROM DOC_TRACE_DETAILS a
                INNER JOIN INV_LOT_ATT c
                  ON a.organizationId = c.organizationId
                  AND a.LotNum = c.LotNum
              WHERE a.PlanToLoc = IN_ToLoc
              AND a.CustomerID = IN_CustomerID
              AND a.SKU = IN_SKU
              AND LineStatus < '20'
              AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
                  r_LOTKEY01 = 'Y') OR
                  (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
                  r_LOTKEY02 = 'Y') OR
                  (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
                  r_LOTKEY03 = 'Y') OR
                  (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
                  r_LOTKEY04 = 'Y') OR
                  (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
                  r_LOTKEY05 = 'Y') OR
                  (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
                  r_LOTKEY06 = 'Y') OR
                  (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
                  r_LOTKEY07 = 'Y') OR
                  (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
                  r_LOTKEY08 = 'Y') OR
                  (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
                  r_LOTKEY09 = 'Y') OR
                  (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
                  r_LOTKEY10 = 'Y') OR
                  (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
                  r_LOTKEY11 = 'Y') OR
                  (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
                  r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
              IF v_nRow > 0 THEN
                SET OUT_FOUND = 'N';
              END IF;
            END IF;
          END IF;
        END IF;
      END IF;


      IF R_STSRes = '05' THEN
        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.taskprocess = '00'
        AND TaskType = 'PA'
        AND (IFNULL(c.lotatt01, '') <> IFNULL(R_Lotatt01, '')
        OR IFNULL(c.lotatt02, '') <> IFNULL(R_Lotatt02, '')
        OR IFNULL(c.lotatt04, '') <> IFNULL(R_Lotatt04, '')
        OR IFNULL(c.lotatt05, '') <> IFNULL(R_Lotatt05, '')
        OR IFNULL(c.lotatt06, '') <> IFNULL(R_Lotatt06, '')
        OR IFNULL(c.lotatt07, '') <> IFNULL(R_Lotatt07, '')
        OR IFNULL(c.lotatt08, '') <> IFNULL(R_Lotatt08, '')
        OR IFNULL(c.lotatt09, '') <> IFNULL(R_Lotatt09, '')
        OR IFNULL(c.lotatt10, '') <> IFNULL(R_Lotatt10, '')
        OR IFNULL(c.lotatt11, '') <> IFNULL(R_Lotatt11, '')
        OR IFNULL(c.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF OUT_FOUND <> 'N' THEN
          SELECT
            COUNT(1)
          FROM INV_LOT_LOC_ID a
            INNER JOIN INV_LOT_ATT c
              ON a.organizationId = c.organizationId
              AND a.LotNum = c.LotNum
          WHERE a.organizationId = In_organizationId
          AND a.LocationID = IN_ToLoc
          AND (IFNULL(c.lotatt01, '') <> IFNULL(R_Lotatt01, '')
          OR IFNULL(c.lotatt02, '') <> IFNULL(R_Lotatt02, '')
          OR IFNULL(c.lotatt04, '') <> IFNULL(R_Lotatt04, '')
          OR IFNULL(c.lotatt05, '') <> IFNULL(R_Lotatt05, '')
          OR IFNULL(c.lotatt06, '') <> IFNULL(R_Lotatt06, '')
          OR IFNULL(c.lotatt07, '') <> IFNULL(R_Lotatt07, '')
          OR IFNULL(c.lotatt08, '') <> IFNULL(R_Lotatt08, '')
          OR IFNULL(c.lotatt09, '') <> IFNULL(R_Lotatt09, '')
          OR IFNULL(c.lotatt10, '') <> IFNULL(R_Lotatt10, '')
          OR IFNULL(c.lotatt11, '') <> IFNULL(R_Lotatt11, '')
          OR IFNULL(c.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_FOUND = 'N';
          END IF;
        END IF;
      END IF;
      IF R_STSRes = '06' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND SKU = IN_SKU
        AND CustomerID = IN_CustomerID INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;

      IF R_STSRes = '07' THEN



        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;

        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.taskprocess < '10'
        AND TaskType = 'PA'
        AND 1 =
        CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_task;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.taskprocess < '10'
        AND TaskType = 'PA' INTO v_nRow_Task_Loc;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.qty > 0
        AND 1 =
        CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_INV;
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
        WHERE a.LocationID = IN_ToLoc
        AND a.qty > 0 INTO v_nRow_INV_LOC;

        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLoc = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND LineStatus < '20'
        AND 1 =
        CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_trace;

        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS a
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLoc = IN_ToLoc
        AND LineStatus < '20' INTO v_nRow_trace_LOC;

        IF v_nRow_Task <= 0
          AND v_nRow_INV <= 0
          AND v_nRow_trace <= 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Task <= 0
          AND v_nRow_Task_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Inv <= 0
          AND v_nRow_inv_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Trace <= 0
          AND v_nRow_Trace_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;



      IF r_STSRes = '08' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = in_ToLoc
        AND b.SKU_Group1 = r_SKUGroup1 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '09' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = in_ToLoc
        AND b.SKU_Group2 = r_SKUGroup2 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '10' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group3 = r_SKUGroup3 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '11' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group4 = r_SKUGroup4 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '12' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND b.SKU_Group5 = r_SKUGroup5 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '13' THEN
        SELECT
          LotAtt01
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_lotnum INTO r_Lotatt01;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.LotNum = b.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND b.LotAtt01 > r_LotAtt01 INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_FOUND = 'N';
        END IF;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = in_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.taskprocess < '10'
        AND TaskType = 'PA'
        AND c.LotAtt01 > r_LotAtt01 INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;


      IF (R_STSRes <> '03'
        AND R_Mix_Flag = 'Y'
        AND IN_MaxMixSKU <> 0) THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND SKU <> IN_SKU
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0 INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixSKU THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF (R_STSRes <> '04'
        AND R_Mix_LotFlag = 'Y'
        AND IN_MaxMixLOT <> 0) THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.LotNum = b.LotNum
        WHERE a.organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (IFNULL(b.lotatt01, '') <> IFNULL(R_Lotatt01, '')
        OR IFNULL(b.lotatt02, '') <> IFNULL(R_Lotatt02, '')
        OR IFNULL(b.lotatt03, '') <> IFNULL(R_Lotatt03, '')
        OR IFNULL(b.lotatt04, '') <> IFNULL(R_Lotatt04, '')
        OR IFNULL(b.lotatt05, '') <> IFNULL(R_Lotatt05, '')
        OR IFNULL(b.lotatt06, '') <> IFNULL(R_Lotatt06, '')
        OR IFNULL(b.lotatt07, '') <> IFNULL(R_Lotatt07, '')
        OR IFNULL(b.lotatt08, '') <> IFNULL(R_Lotatt08, '')
        OR IFNULL(b.lotatt09, '') <> IFNULL(R_Lotatt09, '')
        OR IFNULL(b.lotatt10, '') <> IFNULL(R_Lotatt10, '')
        OR IFNULL(b.lotatt11, '') <> IFNULL(R_Lotatt11, '')
        OR IFNULL(b.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixLOT THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF OUT_FOUND = 'N' THEN
        LEAVE ENDPROC;
      END IF;

      SET R_STSRes = IN_LocationStatus_Includes2;
      IF R_STSRes = '02' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0 INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixLOT THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF R_STSRes = '03' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND ((SKU <> IN_SKU)
        OR (CustomerID <> IN_CustomerID)) INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixLOT THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF R_STSRes = '04' THEN





        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU INTO v_nRow;
        IF v_nRow > 0 THEN

          SELECT
            COUNT(1)
          FROM TSK_TASKLISTS a
            INNER JOIN INV_LOT_ATT c
              ON a.organizationId = c.organizationId
              AND a.PlanToLotNum = c.LotNum
          WHERE a.organizationId = In_organizationId
          AND a.PlanToLocation = IN_ToLoc
          AND a.CustomerID = IN_CustomerID
          AND a.SKU = IN_SKU
          AND a.taskprocess < '10'
          AND TaskType = 'PA'
          AND 1 =
          CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
              r_LOTKEY01 = 'Y') OR
              (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
              r_LOTKEY02 = 'Y') OR
              (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
              r_LOTKEY03 = 'Y') OR
              (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
              r_LOTKEY04 = 'Y') OR
              (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
              r_LOTKEY05 = 'Y') OR
              (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
              r_LOTKEY06 = 'Y') OR
              (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
              r_LOTKEY07 = 'Y') OR
              (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
              r_LOTKEY08 = 'Y') OR
              (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
              r_LOTKEY09 = 'Y') OR
              (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
              r_LOTKEY10 = 'Y') OR
              (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
              r_LOTKEY11 = 'Y') OR
              (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
              r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_FOUND = 'N';
          ELSE

            SELECT
              COUNT(1)
            FROM INV_LOT_LOC_ID a
              INNER JOIN INV_LOT_ATT c
                ON a.organizationId = c.organizationId
                AND a.LotNum = c.LotNum
            WHERE a.organizationId = In_organizationId
            AND a.LocationID = IN_ToLoc
            AND a.CustomerID = IN_CustomerID
            AND a.SKU = IN_SKU
            AND 1 =
            CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
                r_LOTKEY01 = 'Y') OR
                (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
                r_LOTKEY02 = 'Y') OR
                (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
                r_LOTKEY03 = 'Y') OR
                (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
                r_LOTKEY04 = 'Y') OR
                (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
                r_LOTKEY05 = 'Y') OR
                (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
                r_LOTKEY06 = 'Y') OR
                (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
                r_LOTKEY07 = 'Y') OR
                (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
                r_LOTKEY08 = 'Y') OR
                (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
                r_LOTKEY09 = 'Y') OR
                (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
                r_LOTKEY10 = 'Y') OR
                (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
                r_LOTKEY11 = 'Y') OR
                (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
                r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
            IF v_nRow > 0 THEN
              SET OUT_FOUND = 'N';
            ELSE

              SELECT
                COUNT(1)
              FROM DOC_TRACE_DETAILS a
                INNER JOIN INV_LOT_ATT c
                  ON a.organizationId = c.organizationId
                  AND a.LotNum = c.LotNum
              WHERE a.organizationId = In_organizationId
              AND a.PlanToLoc = IN_ToLoc
              AND a.CustomerID = IN_CustomerID
              AND a.SKU = IN_SKU
              AND LineStatus < '20'
              AND 1 =
              CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
                  r_LOTKEY01 = 'Y') OR
                  (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
                  r_LOTKEY02 = 'Y') OR
                  (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
                  r_LOTKEY03 = 'Y') OR
                  (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
                  r_LOTKEY04 = 'Y') OR
                  (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
                  r_LOTKEY05 = 'Y') OR
                  (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
                  r_LOTKEY06 = 'Y') OR
                  (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
                  r_LOTKEY07 = 'Y') OR
                  (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
                  r_LOTKEY08 = 'Y') OR
                  (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
                  r_LOTKEY09 = 'Y') OR
                  (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
                  r_LOTKEY10 = 'Y') OR
                  (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
                  r_LOTKEY11 = 'Y') OR
                  (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
                  r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
              IF v_nRow > 0 THEN
                SET OUT_FOUND = 'N';
              END IF;
            END IF;
          END IF;
        END IF;


      END IF;
      IF R_STSRes = '05' THEN
        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.taskprocess = '00'
        AND TaskType = 'PA'
        AND (IFNULL(c.lotatt01, '') <> IFNULL(R_Lotatt01, '')
        OR IFNULL(c.lotatt02, '') <> IFNULL(R_Lotatt02, '')
        OR IFNULL(c.lotatt04, '') <> IFNULL(R_Lotatt04, '')
        OR IFNULL(c.lotatt05, '') <> IFNULL(R_Lotatt05, '')
        OR IFNULL(c.lotatt06, '') <> IFNULL(R_Lotatt06, '')
        OR IFNULL(c.lotatt07, '') <> IFNULL(R_Lotatt07, '')
        OR IFNULL(c.lotatt08, '') <> IFNULL(R_Lotatt08, '')
        OR IFNULL(c.lotatt09, '') <> IFNULL(R_Lotatt09, '')
        OR IFNULL(c.lotatt10, '') <> IFNULL(R_Lotatt10, '')
        OR IFNULL(c.lotatt11, '') <> IFNULL(R_Lotatt11, '')
        OR IFNULL(c.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF OUT_FOUND <> 'N' THEN
          SELECT
            COUNT(1)
          FROM INV_LOT_LOC_ID a
            INNER JOIN INV_LOT_ATT c
              ON a.organizationId = c.organizationId
              AND a.LotNum = c.LotNum
          WHERE a.organizationId = In_organizationId
          AND a.LocationID = IN_ToLoc
          AND (IFNULL(c.lotatt01, '') <> IFNULL(R_Lotatt01, '')
          OR IFNULL(c.lotatt02, '') <> IFNULL(R_Lotatt02, '')
          OR IFNULL(c.lotatt04, '') <> IFNULL(R_Lotatt04, '')
          OR IFNULL(c.lotatt05, '') <> IFNULL(R_Lotatt05, '')
          OR IFNULL(c.lotatt06, '') <> IFNULL(R_Lotatt06, '')
          OR IFNULL(c.lotatt07, '') <> IFNULL(R_Lotatt07, '')
          OR IFNULL(c.lotatt08, '') <> IFNULL(R_Lotatt08, '')
          OR IFNULL(c.lotatt09, '') <> IFNULL(R_Lotatt09, '')
          OR IFNULL(c.lotatt10, '') <> IFNULL(R_Lotatt10, '')
          OR IFNULL(c.lotatt11, '') <> IFNULL(R_Lotatt11, '')
          OR IFNULL(c.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_FOUND = 'N';
          END IF;
        END IF;
      END IF;
      IF R_STSRes = '06' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND SKU = IN_SKU
        AND CustomerID = IN_CustomerID INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;

      IF R_STSRes = '07' THEN



        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;

        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.taskprocess < '10'
        AND TaskType = 'PA'
        AND 1 =
        CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_task;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.taskprocess < '10'
        AND TaskType = 'PA' INTO v_nRow_Task_Loc;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.qty > 0
        AND 1 =
        CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_INV;
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND a.qty > 0 INTO v_nRow_INV_LOC;

        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLoc = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.LotNum = c.LotNum
        AND LineStatus < '20'
        AND 1 =
        CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_trace;

        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS a
        WHERE a.PlanToLoc = IN_ToLoc
        AND LineStatus < '20' INTO v_nRow_trace_LOC;

        IF v_nRow_Task <= 0
          AND v_nRow_INV <= 0
          AND v_nRow_trace <= 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Task <= 0
          AND v_nRow_Task_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Inv <= 0
          AND v_nRow_inv_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Trace <= 0
          AND v_nRow_Trace_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;




      IF r_STSRes = '08' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = in_ToLoc
        AND b.SKU_Group1 = r_SKUGroup1 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '09' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = in_ToLoc
        AND b.SKU_Group2 = r_SKUGroup2 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '10' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group3 = r_SKUGroup3 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '11' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group4 = r_SKUGroup4 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '12' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND b.SKU_Group5 = r_SKUGroup5 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '13' THEN
        SELECT
          LotAtt01
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_lotnum INTO r_Lotatt01;
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.LotNum = b.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND b.LotAtt01 > r_LotAtt01 INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_FOUND = 'N';
        END IF;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = in_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.taskprocess < '10'
        AND a.TaskType = 'PA'
        AND c.LotAtt01 > r_LotAtt01 INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;



      IF (R_STSRes <> '03'
        AND R_Mix_Flag = 'Y'
        AND IN_MaxMixSKU <> 0) THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND SKU <> IN_SKU
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0 INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixSKU THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF (R_STSRes <> '04'
        AND R_Mix_LotFlag = 'Y'
        AND IN_MaxMixLOT <> 0) THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.LotNum = b.LotNum
        WHERE a.organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND a.lotnum = b.lotnum
        AND (IFNULL(b.lotatt01, '') <> IFNULL(R_Lotatt01, '')
        OR IFNULL(b.lotatt02, '') <> IFNULL(R_Lotatt02, '')
        OR IFNULL(b.lotatt03, '') <> IFNULL(R_Lotatt03, '')
        OR IFNULL(b.lotatt04, '') <> IFNULL(R_Lotatt04, '')
        OR IFNULL(b.lotatt05, '') <> IFNULL(R_Lotatt05, '')
        OR IFNULL(b.lotatt06, '') <> IFNULL(R_Lotatt06, '')
        OR IFNULL(b.lotatt07, '') <> IFNULL(R_Lotatt07, '')
        OR IFNULL(b.lotatt08, '') <> IFNULL(R_Lotatt08, '')
        OR IFNULL(b.lotatt09, '') <> IFNULL(R_Lotatt09, '')
        OR IFNULL(b.lotatt10, '') <> IFNULL(R_Lotatt10, '')
        OR IFNULL(b.lotatt11, '') <> IFNULL(R_Lotatt11, '')
        OR IFNULL(b.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixLOT THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF OUT_FOUND = 'N' THEN
        LEAVE ENDPROC;
      END IF;

      SET R_STSRes = IN_LocationStatus_Includes3;
      IF R_STSRes = '02' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0 INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF R_STSRes = '03' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND ((SKU <> IN_SKU)
        OR (CustomerID <> IN_CustomerID)) INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF R_STSRes = '04' THEN





        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU INTO v_nRow;
        IF v_nRow > 0 THEN

          SELECT
            COUNT(1)
          FROM TSK_TASKLISTS a
            INNER JOIN INV_LOT_ATT c
              ON a.organizationId = c.organizationId
              AND a.PlanToLotNum = c.LotNum
          WHERE a.organizationId = In_organizationId
          AND a.PlanToLocation = IN_ToLoc
          AND a.CustomerID = IN_CustomerID
          AND a.SKU = IN_SKU
          AND a.taskprocess < '10'
          AND TaskType = 'PA'
          AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
              r_LOTKEY01 = 'Y') OR
              (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
              r_LOTKEY02 = 'Y') OR
              (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
              r_LOTKEY03 = 'Y') OR
              (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
              r_LOTKEY04 = 'Y') OR
              (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
              r_LOTKEY05 = 'Y') OR
              (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
              r_LOTKEY06 = 'Y') OR
              (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
              r_LOTKEY07 = 'Y') OR
              (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
              r_LOTKEY08 = 'Y') OR
              (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
              r_LOTKEY09 = 'Y') OR
              (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
              r_LOTKEY10 = 'Y') OR
              (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
              r_LOTKEY11 = 'Y') OR
              (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
              r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_FOUND = 'N';
          ELSE

            SELECT
              COUNT(1)
            FROM INV_LOT_LOC_ID a
              INNER JOIN INV_LOT_ATT c
                ON a.organizationId = c.organizationId
                AND a.LotNum = c.LotNum
            WHERE a.organizationId = In_organizationId
            AND a.LocationID = IN_ToLoc
            AND a.CustomerID = IN_CustomerID
            AND a.SKU = IN_SKU
            AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
                r_LOTKEY01 = 'Y') OR
                (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
                r_LOTKEY02 = 'Y') OR
                (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
                r_LOTKEY03 = 'Y') OR
                (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
                r_LOTKEY04 = 'Y') OR
                (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
                r_LOTKEY05 = 'Y') OR
                (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
                r_LOTKEY06 = 'Y') OR
                (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
                r_LOTKEY07 = 'Y') OR
                (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
                r_LOTKEY08 = 'Y') OR
                (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
                r_LOTKEY09 = 'Y') OR
                (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
                r_LOTKEY10 = 'Y') OR
                (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
                r_LOTKEY11 = 'Y') OR
                (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
                r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
            IF v_nRow > 0 THEN
              SET OUT_FOUND = 'N';
            ELSE

              SELECT
                COUNT(1)
              FROM DOC_TRACE_DETAILS a
                INNER JOIN INV_LOT_ATT c
                  ON a.organizationId = c.organizationId
                  AND a.LotNum = c.LotNum
              WHERE a.organizationId = In_organizationId
              AND a.PlanToLoc = IN_ToLoc
              AND a.CustomerID = IN_CustomerID
              AND a.SKU = IN_SKU
              AND LineStatus < '20'
              AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
                  r_LOTKEY01 = 'Y') OR
                  (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
                  r_LOTKEY02 = 'Y') OR
                  (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
                  r_LOTKEY03 = 'Y') OR
                  (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
                  r_LOTKEY04 = 'Y') OR
                  (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
                  r_LOTKEY05 = 'Y') OR
                  (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
                  r_LOTKEY06 = 'Y') OR
                  (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
                  r_LOTKEY07 = 'Y') OR
                  (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
                  r_LOTKEY08 = 'Y') OR
                  (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
                  r_LOTKEY09 = 'Y') OR
                  (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
                  r_LOTKEY10 = 'Y') OR
                  (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
                  r_LOTKEY11 = 'Y') OR
                  (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
                  r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
              IF v_nRow > 0 THEN
                SET OUT_FOUND = 'N';
              END IF;
            END IF;
          END IF;
        END IF;

      END IF;
      IF R_STSRes = '05' THEN
        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.taskprocess = '00'
        AND TaskType = 'PA'
        AND (IFNULL(c.lotatt01, '') <> IFNULL(R_Lotatt01, '')
        OR IFNULL(c.lotatt02, '') <> IFNULL(R_Lotatt02, '')
        OR IFNULL(c.lotatt04, '') <> IFNULL(R_Lotatt04, '')
        OR IFNULL(c.lotatt05, '') <> IFNULL(R_Lotatt05, '')
        OR IFNULL(c.lotatt06, '') <> IFNULL(R_Lotatt06, '')
        OR IFNULL(c.lotatt07, '') <> IFNULL(R_Lotatt07, '')
        OR IFNULL(c.lotatt08, '') <> IFNULL(R_Lotatt08, '')
        OR IFNULL(c.lotatt09, '') <> IFNULL(R_Lotatt09, '')
        OR IFNULL(c.lotatt10, '') <> IFNULL(R_Lotatt10, '')
        OR IFNULL(c.lotatt11, '') <> IFNULL(R_Lotatt11, '')
        OR IFNULL(c.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF OUT_FOUND <> 'N' THEN
          SELECT
            COUNT(1)
          FROM INV_LOT_LOC_ID a
            INNER JOIN INV_LOT_ATT c
              ON a.organizationId = c.organizationId
              AND a.LotNum = c.LotNum
          WHERE a.organizationId = In_organizationId
          AND a.LocationID = IN_ToLoc
          AND (IFNULL(c.lotatt01, '') <> IFNULL(R_Lotatt01, '')
          OR IFNULL(c.lotatt02, '') <> IFNULL(R_Lotatt02, '')
          OR IFNULL(c.lotatt04, '') <> IFNULL(R_Lotatt04, '')
          OR IFNULL(c.lotatt05, '') <> IFNULL(R_Lotatt05, '')
          OR IFNULL(c.lotatt06, '') <> IFNULL(R_Lotatt06, '')
          OR IFNULL(c.lotatt07, '') <> IFNULL(R_Lotatt07, '')
          OR IFNULL(c.lotatt08, '') <> IFNULL(R_Lotatt08, '')
          OR IFNULL(c.lotatt09, '') <> IFNULL(R_Lotatt09, '')
          OR IFNULL(c.lotatt10, '') <> IFNULL(R_Lotatt10, '')
          OR IFNULL(c.lotatt11, '') <> IFNULL(R_Lotatt11, '')
          OR IFNULL(c.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_FOUND = 'N';
          END IF;
        END IF;
      END IF;
      IF R_STSRes = '06' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND SKU = IN_SKU
        AND CustomerID = IN_CustomerID INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;

      IF R_STSRes = '07' THEN



        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;

        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.taskprocess < '10'
        AND TaskType = 'PA'
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_task;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.taskprocess < '10'
        AND TaskType = 'PA' INTO v_nRow_Task_Loc;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.qty > 0
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_INV;
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND a.qty > 0 INTO v_nRow_INV_LOC;

        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLoc = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND LineStatus < '20'
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_trace;

        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS a
        WHERE a.organizatonId = In_organizatonId
        AND a.PlanToLoc = IN_ToLoc
        AND LineStatus < '20' INTO v_nRow_trace_LOC;

        IF v_nRow_Task <= 0
          AND v_nRow_INV <= 0
          AND v_nRow_trace <= 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Task <= 0
          AND v_nRow_Task_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Inv <= 0
          AND v_nRow_inv_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Trace <= 0
          AND v_nRow_Trace_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;




      IF r_STSRes = '08' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group1 = r_SKUGroup1 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '09' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group2 = r_SKUGroup2 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '10' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group3 = r_SKUGroup3 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '11' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group4 = r_SKUGroup4 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '12' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.CustomerID = b.CustomerID
            AND a.SKU = b.SKU
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND b.SKU_Group5 = r_SKUGroup5 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '13' THEN
        SELECT
          LotAtt01
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_lotnum INTO r_Lotatt01;
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.lotnum = b.lotnum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND b.LotAtt01 > r_LotAtt01 INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_FOUND = 'N';
        END IF;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.planToLotNum = c.lotnum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = in_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.taskprocess < '10'
        AND TaskType = 'PA'
        AND c.LotAtt01 > r_LotAtt01 INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;



      IF (R_STSRes <> '03'
        AND R_Mix_Flag = 'Y'
        AND IN_MaxMixSKU <> 0) THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND SKU <> IN_SKU
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0 INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixSKU THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF (R_STSRes <> '04'
        AND R_Mix_LotFlag = 'Y'
        AND IN_MaxMixLOT <> 0) THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.lotnum = b.LotNum
        WHERE a.organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (IFNULL(b.lotatt01, '') <> IFNULL(R_Lotatt01, '')
        OR IFNULL(b.lotatt02, '') <> IFNULL(R_Lotatt02, '')
        OR IFNULL(b.lotatt03, '') <> IFNULL(R_Lotatt03, '')
        OR IFNULL(b.lotatt04, '') <> IFNULL(R_Lotatt04, '')
        OR IFNULL(b.lotatt05, '') <> IFNULL(R_Lotatt05, '')
        OR IFNULL(b.lotatt06, '') <> IFNULL(R_Lotatt06, '')
        OR IFNULL(b.lotatt07, '') <> IFNULL(R_Lotatt07, '')
        OR IFNULL(b.lotatt08, '') <> IFNULL(R_Lotatt08, '')
        OR IFNULL(b.lotatt09, '') <> IFNULL(R_Lotatt09, '')
        OR IFNULL(b.lotatt10, '') <> IFNULL(R_Lotatt10, '')
        OR IFNULL(b.lotatt11, '') <> IFNULL(R_Lotatt11, '')
        OR IFNULL(b.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixLOT THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF OUT_FOUND = 'N' THEN
        LEAVE ENDPROC;
      END IF;

      SET R_STSRes = IN_LocationStatus_Includes4;
      IF R_STSRes = '02' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0 INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF R_STSRes = '03' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND ((SKU <> IN_SKU)
        OR (CustomerID <> IN_CustomerID)) INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF R_STSRes = '04' THEN





        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND CustomerID = IN_CustomerID
        AND SKU = IN_SKU INTO v_nRow;
        IF v_nRow > 0 THEN

          SELECT
            COUNT(1)
          FROM TSK_TASKLISTS a
            INNER JOIN INV_LOT_ATT c
              ON a.organizationId = c.organizationId
              AND a.PlanToLotNum = c.LotNum
          WHERE a.organizationId = In_organizationId
          AND a.PlanToLocation = IN_ToLoc
          AND a.CustomerID = IN_CustomerID
          AND a.SKU = IN_SKU
          AND a.PlanToLotNum = c.LotNum
          AND a.taskprocess < '10'
          AND TaskType = 'PA'
          AND 1 =
          CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
              r_LOTKEY01 = 'Y') OR
              (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
              r_LOTKEY02 = 'Y') OR
              (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
              r_LOTKEY03 = 'Y') OR
              (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
              r_LOTKEY04 = 'Y') OR
              (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
              r_LOTKEY05 = 'Y') OR
              (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
              r_LOTKEY06 = 'Y') OR
              (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
              r_LOTKEY07 = 'Y') OR
              (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
              r_LOTKEY08 = 'Y') OR
              (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
              r_LOTKEY09 = 'Y') OR
              (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
              r_LOTKEY10 = 'Y') OR
              (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
              r_LOTKEY11 = 'Y') OR
              (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
              r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_FOUND = 'N';
          ELSE

            SELECT
              COUNT(1)
            FROM INV_LOT_LOC_ID a
              INNER JOIN INV_LOT_ATT c
                ON a.organizationId = c.organizationId
                AND a.LotNum = c.LotNum
            WHERE a.organizationId = In_organizationId
            AND a.LocationID = IN_ToLoc
            AND a.CustomerID = IN_CustomerID
            AND a.SKU = IN_SKU
            AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
                r_LOTKEY01 = 'Y') OR
                (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
                r_LOTKEY02 = 'Y') OR
                (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
                r_LOTKEY03 = 'Y') OR
                (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
                r_LOTKEY04 = 'Y') OR
                (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
                r_LOTKEY05 = 'Y') OR
                (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
                r_LOTKEY06 = 'Y') OR
                (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
                r_LOTKEY07 = 'Y') OR
                (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
                r_LOTKEY08 = 'Y') OR
                (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
                r_LOTKEY09 = 'Y') OR
                (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
                r_LOTKEY10 = 'Y') OR
                (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
                r_LOTKEY11 = 'Y') OR
                (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
                r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
            IF v_nRow > 0 THEN
              SET OUT_FOUND = 'N';
            ELSE

              SELECT
                COUNT(1)
              FROM DOC_TRACE_DETAILS a
                INNER JOIN INV_LOT_ATT c
                  ON a.organizationId = c.organizationId
                  AND a.LotNum = c.LotNum
              WHERE a.organizationId = In_organizationId
              AND a.PlanToLoc = IN_ToLoc
              AND a.CustomerID = IN_CustomerID
              AND a.SKU = IN_SKU
              AND LineStatus < '20'
              AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') <> IFNULL(r_Lotatt01, '') AND
                  r_LOTKEY01 = 'Y') OR
                  (IFNULL(c.lotatt02, '') <> IFNULL(r_Lotatt02, '') AND
                  r_LOTKEY02 = 'Y') OR
                  (IFNULL(c.lotatt03, '') <> IFNULL(r_Lotatt03, '') AND
                  r_LOTKEY03 = 'Y') OR
                  (IFNULL(c.lotatt04, '') <> IFNULL(r_Lotatt04, '') AND
                  r_LOTKEY04 = 'Y') OR
                  (IFNULL(c.lotatt05, '') <> IFNULL(r_Lotatt05, '') AND
                  r_LOTKEY05 = 'Y') OR
                  (IFNULL(c.lotatt06, '') <> IFNULL(r_Lotatt06, '') AND
                  r_LOTKEY06 = 'Y') OR
                  (IFNULL(c.lotatt07, '') <> IFNULL(r_Lotatt07, '') AND
                  r_LOTKEY07 = 'Y') OR
                  (IFNULL(c.lotatt08, '') <> IFNULL(r_Lotatt08, '') AND
                  r_LOTKEY08 = 'Y') OR
                  (IFNULL(c.lotatt09, '') <> IFNULL(r_Lotatt09, '') AND
                  r_LOTKEY09 = 'Y') OR
                  (IFNULL(c.lotatt10, '') <> IFNULL(r_Lotatt10, '') AND
                  r_LOTKEY10 = 'Y') OR
                  (IFNULL(c.lotatt11, '') <> IFNULL(r_Lotatt11, '') AND
                  r_LOTKEY11 = 'Y') OR
                  (IFNULL(c.lotatt12, '') <> IFNULL(r_Lotatt12, '') AND
                  r_LOTKEY12 = 'Y') THEN 1 ELSE 0 END INTO v_nRow;
              IF v_nRow > 0 THEN
                SET OUT_FOUND = 'N';
              END IF;
            END IF;
          END IF;
        END IF;

      END IF;
      IF R_STSRes = '05' THEN
        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12 INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.taskprocess = '00'
        AND TaskType = 'PA'
        AND (IFNULL(c.lotatt01, '') <> IFNULL(R_Lotatt01, '')
        OR IFNULL(c.lotatt02, '') <> IFNULL(R_Lotatt02, '')
        OR IFNULL(c.lotatt04, '') <> IFNULL(R_Lotatt04, '')
        OR IFNULL(c.lotatt05, '') <> IFNULL(R_Lotatt05, '')
        OR IFNULL(c.lotatt06, '') <> IFNULL(R_Lotatt06, '')
        OR IFNULL(c.lotatt07, '') <> IFNULL(R_Lotatt07, '')
        OR IFNULL(c.lotatt08, '') <> IFNULL(R_Lotatt08, '')
        OR IFNULL(c.lotatt09, '') <> IFNULL(R_Lotatt09, '')
        OR IFNULL(c.lotatt10, '') <> IFNULL(R_Lotatt10, '')
        OR IFNULL(c.lotatt11, '') <> IFNULL(R_Lotatt11, '')
        OR IFNULL(c.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
        IF v_nRow > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF OUT_FOUND <> 'N' THEN
          SELECT
            COUNT(1)
          FROM INV_LOT_LOC_ID a
            INNER JOIN INV_LOT_ATT c
              ON a.organizationId = c.organizationId
              AND a.lotnum = c.lotnum
          WHERE a.organizationId = In_organizationId
          AND a.LocationID = IN_ToLoc
          AND a.LotNum = c.LotNum
          AND (IFNULL(c.lotatt01, '') <> IFNULL(R_Lotatt01, '')
          OR IFNULL(c.lotatt02, '') <> IFNULL(R_Lotatt02, '')
          OR IFNULL(c.lotatt04, '') <> IFNULL(R_Lotatt04, '')
          OR IFNULL(c.lotatt05, '') <> IFNULL(R_Lotatt05, '')
          OR IFNULL(c.lotatt06, '') <> IFNULL(R_Lotatt06, '')
          OR IFNULL(c.lotatt07, '') <> IFNULL(R_Lotatt07, '')
          OR IFNULL(c.lotatt08, '') <> IFNULL(R_Lotatt08, '')
          OR IFNULL(c.lotatt09, '') <> IFNULL(R_Lotatt09, '')
          OR IFNULL(c.lotatt10, '') <> IFNULL(R_Lotatt10, '')
          OR IFNULL(c.lotatt11, '') <> IFNULL(R_Lotatt11, '')
          OR IFNULL(c.lotatt12, '') <> IFNULL(R_Lotatt12, '')) INTO v_nRow;
          IF v_nRow > 0 THEN
            SET OUT_FOUND = 'N';
          END IF;
        END IF;
      END IF;
      IF R_STSRes = '06' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0
        AND SKU = IN_SKU
        AND CustomerID = IN_CustomerID INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;

      IF R_STSRes = '07' THEN



        SELECT
          Lotatt01,
          Lotatt02,
          Lotatt03,
          Lotatt04,
          Lotatt05,
          Lotatt06,
          Lotatt07,
          Lotatt08,
          Lotatt09,
          Lotatt10,
          Lotatt11,
          Lotatt12
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_LotNum INTO R_LotAtt01, R_LotAtt02, R_LotAtt03, R_LotAtt04, R_LotAtt05, R_LotAtt06
        , R_LotAtt07, R_LotAtt08, R_LotAtt09, R_LotAtt10, R_LotAtt11, R_LotAtt12;

        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.taskprocess < '10'
        AND TaskType = 'PA'
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_task;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = IN_ToLoc
        AND a.taskprocess < '10'
        AND TaskType = 'PA' INTO v_nRow_Task_Loc;

        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.qty > 0
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_INV;
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND a.qty > 0 INTO v_nRow_INV_LOC;

        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.LotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLoc = IN_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.LineStatus < '20'
        AND 1 = CASE WHEN (IFNULL(c.lotatt01, '') = IFNULL(r_Lotatt01, '') OR
            r_LOTKEY01 = 'N') AND
            (IFNULL(c.lotatt02, '') = IFNULL(r_Lotatt02, '') OR
            r_LOTKEY02 = 'N') AND
            (IFNULL(c.lotatt03, '') = IFNULL(r_Lotatt03, '') OR
            r_LOTKEY03 = 'N') AND
            (IFNULL(c.lotatt04, '') = IFNULL(r_Lotatt04, '') OR
            r_LOTKEY04 = 'N') AND
            (IFNULL(c.lotatt05, '') = IFNULL(r_Lotatt05, '') OR
            r_LOTKEY05 = 'N') AND
            (IFNULL(c.lotatt06, '') = IFNULL(r_Lotatt06, '') OR
            r_LOTKEY06 = 'N') AND
            (IFNULL(c.lotatt07, '') = IFNULL(r_Lotatt07, '') OR
            r_LOTKEY07 = 'N') AND
            (IFNULL(c.lotatt08, '') = IFNULL(r_Lotatt08, '') OR
            r_LOTKEY08 = 'N') AND
            (IFNULL(c.lotatt09, '') = IFNULL(r_Lotatt09, '') OR
            r_LOTKEY09 = 'N') AND
            (IFNULL(c.lotatt10, '') = IFNULL(r_Lotatt10, '') OR
            r_LOTKEY10 = 'N') AND
            (IFNULL(c.lotatt11, '') = IFNULL(r_Lotatt11, '') OR
            r_LOTKEY11 = 'N') AND
            (IFNULL(c.lotatt12, '') = IFNULL(r_Lotatt12, '') OR
            r_LOTKEY12 = 'N') THEN 1 ELSE 0 END INTO v_nRow_trace;

        SELECT
          COUNT(1)
        FROM DOC_TRACE_DETAILS a
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLoc = IN_ToLoc
        AND LineStatus < '20' INTO v_nRow_trace_LOC;

        IF v_nRow_Task <= 0
          AND v_nRow_INV <= 0
          AND v_nRow_trace <= 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Task <= 0
          AND v_nRow_Task_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Inv <= 0
          AND v_nRow_inv_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
        IF v_nRow_Trace <= 0
          AND v_nRow_Trace_LOC > 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;




      IF r_STSRes = '08' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.customerId = b.customerId
            AND a.sku = b.sku
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = in_ToLoc
        AND b.SKU_Group1 = r_SKUGroup1 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '09' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.customerId = b.customerId
            AND a.sku = b.sku
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = in_ToLoc
        AND b.SKU_Group2 = r_SKUGroup2 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '10' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.customerId = b.customerId
            AND a.sku = b.sku
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group3 = r_SKUGroup3 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '11' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.customerId = b.customerId
            AND a.sku = b.sku
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = In_ToLoc
        AND b.SKU_Group4 = r_SKUGroup4 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '12' THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN BAS_SKU b
            ON a.organizationId = b.organizationId
            AND a.customerId = b.customerId
            AND a.sku = b.sku
        WHERE a.organizationId = In_organizationId
        AND a.LocationId = IN_ToLoc
        AND b.SKU_Group5 = r_SKUGroup5 INTO v_nRow;
        IF v_nRow = 0 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF r_STSRes = '13' THEN
        SELECT
          LotAtt01
        FROM INV_LOT_ATT
        WHERE organizationId = In_organizationId
        AND lotnum = IN_lotnum INTO r_Lotatt01;
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.LotNum = b.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND b.LotAtt01 > r_LotAtt01 INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_FOUND = 'N';
        END IF;
        SELECT
          COUNT(1)
        FROM TSK_TASKLISTS a
          INNER JOIN INV_LOT_ATT c
            ON a.organizationId = c.organizationId
            AND a.PlanToLotNum = c.LotNum
        WHERE a.organizationId = In_organizationId
        AND a.PlanToLocation = in_ToLoc
        AND a.CustomerID = IN_CustomerID
        AND a.SKU = IN_SKU
        AND a.taskprocess < '10'
        AND a.TaskType = 'PA'
        AND c.LotAtt01 > r_LotAtt01 INTO v_nRow;
        IF v_nRow >= 1 THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;

      IF (R_STSRes <> '03'
        AND R_Mix_Flag = 'Y'
        AND IN_MaxMixSKU <> 0) THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID
        WHERE organizationId = In_organizationId
        AND LocationID = IN_ToLoc
        AND SKU <> IN_SKU
        AND (qty + QTYPA + QTYRPIN + QTYMVIN) > 0 INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixSKU THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF (R_STSRes <> '04'
        AND R_Mix_LotFlag = 'Y'
        AND IN_MaxMixLOT <> 0) THEN
        SELECT
          COUNT(1)
        FROM INV_LOT_LOC_ID a
          INNER JOIN INV_LOT_ATT b
            ON a.organizationId = b.organizationId
            AND a.lotnum = b.lotnum
        WHERE a.organizationId = In_organizationId
        AND a.LocationID = IN_ToLoc
        AND (IFNULL(b.lotatt01, '') <> IFNULL(R_Lotatt01, '')
        OR IFNULL(b.lotatt02, '') <> IFNULL(R_Lotatt02, '')
        OR IFNULL(b.lotatt03, '') <> IFNULL(R_Lotatt03, '')
        OR IFNULL(b.lotatt04, '') <> IFNULL(R_Lotatt04, '')
        OR IFNULL(b.lotatt05, '') <> IFNULL(R_Lotatt05, '')
        OR IFNULL(b.lotatt06, '') <> IFNULL(R_Lotatt06, '')
        OR IFNULL(b.lotatt07, '') <> IFNULL(R_Lotatt07, '')
        OR IFNULL(b.lotatt08, '') <> IFNULL(R_Lotatt08, '')
        OR IFNULL(b.lotatt09, '') <> IFNULL(R_Lotatt09, '')
        OR IFNULL(b.lotatt10, '') <> IFNULL(R_Lotatt10, '')
        OR IFNULL(b.lotatt11, '') <> IFNULL(R_Lotatt11, '')
        OR IFNULL(b.lotatt12, '') <> IFNULL(R_Lotatt12, '')
        ) INTO v_nRow;
        IF v_nRow + 1 > IN_MaxMixLOT THEN
          SET OUT_FOUND = 'N';
        END IF;
      END IF;
      IF OUT_FOUND = 'N' THEN
        LEAVE ENDPROC;
      END IF;
    END IF;

    IF (R_LocationUsage <> IFNULL(IN_LocationUsage_Includes1, '')
      AND IFNULL(IN_LocationUsage_Includes1, '') <> '')
      OR (R_LocationUsage <> IFNULL(IN_LocationUsage_Includes2, '')
      AND IFNULL(IN_LocationUsage_Includes2, '') <> '')
      OR (R_LocationUsage <> IFNULL(IN_LocationUsage_Includes3, '')
      AND IFNULL(IN_LocationUsage_Includes3, '') <> '')
      OR (R_LocationUsage <> IFNULL(IN_LocationUsage_Includes4, '')
      AND IFNULL(IN_LocationUsage_Includes4, '') <> '')
      OR (R_LocationUsage <> IFNULL(IN_LocationUsage_Includes5, '')
      AND IFNULL(IN_LocationUsage_Includes5, '') <> '') THEN
      SET OUT_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;
    IF R_LocationUsage <> ''
      AND OUT_FOUND <> 'N' THEN
      IF (R_LocationUsage = IFNULL(IN_LocationUsage_Excludes1, '')
        AND IFNULL(IN_LocationUsage_Excludes1, '') <> '')
        OR (R_LocationUsage = IFNULL(IN_LocationUsage_Excludes2, '')
        AND IFNULL(IN_LocationUsage_Excludes2, '') <> '')
        OR (R_LocationUsage = IFNULL(IN_LocationUsage_Excludes3, '')
        AND IFNULL(IN_LocationUsage_Excludes3, '') <> '')
        OR (R_LocationUsage = IFNULL(IN_LocationUsage_Excludes4, '')
        AND IFNULL(IN_LocationUsage_Excludes4, '') <> '')
        OR (R_LocationUsage = IFNULL(IN_LocationUsage_Excludes5, '')
        AND IFNULL(IN_LocationUsage_Excludes5, '') <> '') THEN
        SET OUT_FOUND = 'N';
        LEAVE ENDPROC;
      END IF;
    END IF;

    IF (R_LocationCategory <> IFNULL(IN_LocationCategory_Includes1, '')
      AND IFNULL(IN_LocationCategory_Includes1, '') <> '')
      OR (R_LocationCategory <> IFNULL(IN_LocationCategory_Includes2, '')
      AND IFNULL(IN_LocationCategory_Includes2, '') <> '')
      OR (R_LocationCategory <> IFNULL(IN_LocationCategory_Includes3, '')
      AND IFNULL(IN_LocationCategory_Includes3, '') <> '')
      OR (R_LocationCategory <> IFNULL(IN_LocationCategory_Includes4, '')
      AND IFNULL(IN_LocationCategory_Includes4, '') <> '') THEN
      SET OUT_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;
    IF R_LocationCategory <> ''
      AND OUT_FOUND <> 'N' THEN
      IF (R_LocationCategory = IFNULL(IN_LocationCategory_Excludes1, '')
        AND IFNULL(IN_LocationCategory_Excludes1, '') <> '')
        OR (R_LocationCategory = IFNULL(IN_LocationCategory_Excludes2, '')
        AND IFNULL(IN_LocationCategory_Excludes2, '') <> '')
        OR (R_LocationCategory = IFNULL(IN_LocationCategory_Excludes3, '')
        AND IFNULL(IN_LocationCategory_Excludes3, '') <> '')
        OR (R_LocationCategory = IFNULL(IN_LocationCategory_Excludes4, '')
        AND IFNULL(IN_LocationCategory_Excludes4, '') <> '') THEN
        SET OUT_FOUND = 'N';
        LEAVE ENDPROC;
      END IF;
    END IF;

    IF (R_LocationAttribute <> IFNULL(IN_LocationAttribute_Includes1, '')
      AND IFNULL(IN_LocationAttribute_Includes1, '') <> '')
      OR (R_LocationAttribute <> IFNULL(IN_LocationAttribute_Includes2, '')
      AND IFNULL(IN_LocationAttribute_Includes2, '') <> '')
      OR (R_LocationAttribute <> IFNULL(IN_LocationAttribute_Includes3, '')
      AND IFNULL(IN_LocationAttribute_Includes3, '') <> '')
      OR (R_LocationAttribute <> IFNULL(IN_LocationAttribute_Includes4, '')
      AND IFNULL(IN_LocationAttribute_Includes4, '') <> '') THEN
      SET OUT_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;
    IF R_LocationAttribute <> ''
      AND OUT_FOUND <> 'N' THEN
      IF (R_LocationAttribute = IFNULL(IN_LocationAttribute_Excludes1, '')
        AND IFNULL(IN_LocationAttribute_Excludes1, '') <> '')
        OR (R_LocationAttribute = IFNULL(IN_LocationAttribute_Excludes2, '')
        AND IFNULL(IN_LocationAttribute_Excludes2, '') <> '')
        OR (R_LocationAttribute = IFNULL(IN_LocationAttribute_Excludes3, '')
        AND IFNULL(IN_LocationAttribute_Excludes3, '') <> '')
        OR (R_LocationAttribute = IFNULL(IN_LocationAttribute_Excludes4, '')
        AND IFNULL(IN_LocationAttribute_Excludes4, '') <> '') THEN
        SET OUT_FOUND = 'N';
        LEAVE ENDPROC;
      END IF;
    END IF;

    IF (R_LocationHandling <> IFNULL(IN_LocationHandling_Includes1, '')
      AND IFNULL(IN_LocationHandling_Includes1, '') <> '')
      OR (R_LocationHandling <> IFNULL(IN_LocationHandling_Includes2, '')
      AND IFNULL(IN_LocationHandling_Includes2, '') <> '')
      OR (R_LocationHandling <> IFNULL(IN_LocationHandling_Includes3, '')
      AND IFNULL(IN_LocationHandling_Includes3, '') <> '')
      OR (R_LocationHandling <> IFNULL(IN_LocationHandling_Includes4, '')
      AND IFNULL(IN_LocationHandling_Includes4, '') <> '') THEN
      SET OUT_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;
    IF R_LocationHandling <> ''
      AND OUT_FOUND <> 'N' THEN
      IF (R_LocationHandling = IFNULL(IN_LocationHandling_Excludes1, '')
        AND IFNULL(IN_LocationHandling_Excludes1, '') <> '')
        OR (R_LocationHandling = IFNULL(IN_LocationHandling_Excludes2, '')
        AND IFNULL(IN_LocationHandling_Excludes2, '') <> '')
        OR (R_LocationHandling = IFNULL(IN_LocationHandling_Excludes3, '')
        AND IFNULL(IN_LocationHandling_Excludes3, '') <> '')
        OR (R_LocationHandling = IFNULL(IN_LocationHandling_Excludes4, '')
        AND IFNULL(IN_LocationHandling_Excludes4, '') <> '') THEN
        SET OUT_FOUND = 'N';
        LEAVE ENDPROC;
      END IF;
    END IF;

    IF (IFNULL(IN_LocationDemand_Includes1, '') <> ''
      AND R_LocationDemand <> IFNULL(IN_LocationDemand_Includes1, ''))
      OR (IFNULL(IN_LocationDemand_Includes2, '') <> ''
      AND R_LocationDemand <> IFNULL(IN_LocationDemand_Includes2, ''))
      OR (IFNULL(IN_LocationDemand_Includes3, '') <> ''
      AND R_LocationDemand <> IFNULL(IN_LocationDemand_Includes3, '')) THEN
      SET OUT_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;
    IF R_LocationDemand <> ''
      AND OUT_FOUND <> 'N' THEN
      IF (R_LocationDemand = IFNULL(IN_LocationDemand_Excludes1, '')
        AND IFNULL(IN_LocationDemand_Excludes1, '') <> '')
        OR (R_LocationDemand = IFNULL(IN_LocationDemand_Excludes2, '')
        AND IFNULL(IN_LocationDemand_Excludes2, '') <> '')
        OR (R_LocationDemand = IFNULL(IN_LocationDemand_Excludes3, '')
        AND IFNULL(IN_LocationDemand_Excludes3, '') <> '') THEN
        SET OUT_FOUND = 'N';
        LEAVE ENDPROC;
      END IF;
    END IF;

    IF (r_LocationGroup1 <> IFNULL(IN_LocationGroup1_Includes1, '')
      AND IFNULL(IN_LocationGroup1_Includes1, '') <> '')
      OR (r_LocationGroup1 <> IFNULL(IN_LocationGroup1_Includes2, '')
      AND IFNULL(IN_LocationGroup1_Includes2, '') <> '') THEN
      SET OUT_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;
    IF r_LocationGroup1 <> ''
      AND OUT_FOUND <> 'N' THEN
      IF (r_LocationGroup1 = IFNULL(IN_LocationGroup1_Excludes1, '')
        AND IFNULL(IN_LocationGroup1_Excludes1, '') <> '')
        OR (r_LocationGroup1 = IFNULL(IN_LocationGroup1_Excludes2, '')
        AND IFNULL(IN_LocationGroup1_Excludes2, '') <> '') THEN
        SET OUT_FOUND = 'N';
        LEAVE ENDPROC;
      END IF;
    END IF;

    IF (r_LocationGroup2 <> IFNULL(IN_LocationGroup2_Includes1, '')
      AND IFNULL(IN_LocationGroup2_Includes1, '') <> '')
      OR (r_LocationGroup2 <> IFNULL(IN_LocationGroup2_Includes2, '')
      AND IFNULL(IN_LocationGroup2_Includes2, '') <> '') THEN
      SET OUT_FOUND = 'N';
      LEAVE ENDPROC;
    END IF;
    IF r_LocationGroup1 <> ''
      AND OUT_FOUND <> 'N' THEN
      IF (r_LocationGroup2 = IFNULL(IN_LocationGroup2_Excludes1, '')
        AND IFNULL(IN_LocationGroup2_Excludes1, '') <> '')
        OR (r_LocationGroup2 = IFNULL(IN_LocationGroup2_Excludes2, '')
        AND IFNULL(IN_LocationGroup2_Excludes2, '') <> '') THEN
        SET OUT_FOUND = 'N';
        LEAVE ENDPROC;
      END IF;
    END IF;
    IF OUT_FOUND = 'T' THEN
      SET OUT_FOUND = 'Y';
    END IF;
    LEAVE ENDPROC;
  END
  $$

--
-- Create procedure `SPASN_Putaway_Calculation`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPASN_Putaway_Calculation (IN IN_organizationId varchar(20),
IN IN_warehouse varchar(20),
IN IN_ASNNO varchar(20),
IN IN_ASNLineNo varchar(20),
IN IN_CustomerID varchar(20),
IN IN_SKU varchar(20),
IN IN_PackID varchar(20),
IN IN_UOM varchar(20),
IN IN_Quantity_C varchar(20),
IN IN_Weight varchar(20),
IN IN_Cubic varchar(20),
IN IN_LotNum varchar(20),
IN IN_FromLoc_C varchar(20),
INOUT Out_ToLoc varchar(500),
INOUT OUT_Return_Code varchar(500))
ENDPROC:
  BEGIN

    DECLARE r_PackUOM varchar(10);
    DECLARE r_MaxLocationCount int;
    DECLARE r_ActualLocationCount int;
    DECLARE R_SQL varchar(3000);
    DECLARE r_FOUND char(1);
    DECLARE r_Match char(1);
    DECLARE r_PARule varchar(20);
    DECLARE r_CurrentTime timestamp;
    DECLARE r_PutawayRule varchar(20);
    DECLARE r_zoneId varchar(20);
    DECLARE r_zoneId1 varchar(20);
    DECLARE r_FMLocationID varchar(20);
    DECLARE r_ToLocationID varchar(20);
    DECLARE r_Lowerlimit decimal(18, 8);
    DECLARE r_Uplimit decimal(18, 8);
    DECLARE r_NextStepWhenFound int;
    DECLARE r_NextStepWhenFail int;
    DECLARE r_NextStepWhenFound_A int;
    DECLARE r_NextStepWhenFail_A int;
    DECLARE r_LineNumber int;
    DECLARE r_CycleClass varchar(1);
    DECLARE r_LotAtt01 varchar(100);
    DECLARE r_LotAtt02 varchar(100);
    DECLARE r_LotAtt03 varchar(100);
    DECLARE r_LotAtt04 varchar(100);
    DECLARE r_LotAtt05 varchar(100);
    DECLARE r_LotAtt06 varchar(100);
    DECLARE r_LotAtt07 varchar(100);
    DECLARE r_LotAtt08 varchar(100);
    DECLARE r_LotAtt09 varchar(100);
    DECLARE r_LotAtt10 varchar(100);
    DECLARE r_LotAtt11 varchar(100);
    DECLARE r_LotAtt12 varchar(100);
    DECLARE r_ALotAtt01 varchar(100);
    DECLARE r_ALotAtt02 varchar(100);
    DECLARE r_ALotAtt03 varchar(100);
    DECLARE r_ALotAtt04 varchar(100);
    DECLARE r_ALotAtt05 varchar(100);
    DECLARE r_ALotAtt06 varchar(100);
    DECLARE r_ALotAtt07 varchar(100);
    DECLARE r_ALotAtt08 varchar(100);
    DECLARE r_ALotAtt09 varchar(100);
    DECLARE r_ALotAtt10 varchar(100);
    DECLARE r_ALotAtt11 varchar(100);
    DECLARE r_ALotAtt12 varchar(100);
    DECLARE r_ASNType varchar(10);
    DECLARE r_CRS_DCK varchar(1);
    DECLARE r_QtyCrossDocked int;
    DECLARE r_QtyCrossDocked_Each decimal(18, 8);
    DECLARE r_LocationSeeds varchar(20);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_Warehouse_ASN varchar(30);
    DECLARE r_nRow int;
    DECLARE R_x int;
    DECLARE R_y int;
    DECLARE R_z int;
    DECLARE r_SKUGroup1 varchar(200);
    DECLARE r_SKUGroup2 varchar(200);
    DECLARE r_SKUGroup3 varchar(200);
    DECLARE r_SKUGroup4 varchar(200);
    DECLARE r_SKUGroup5 varchar(200);
    DECLARE r_ASNLineFilter varchar(100);
    DECLARE r_ASNLineFilter_ASN varchar(100);
    DECLARE r_DYNAMIC_FMLOC varchar(100);
    DECLARE IN_FromLoc varchar(100);
    DECLARE IN_Quantity decimal(18, 8);
    DECLARE r_Location_Usage_1 varchar(20);
    DECLARE r_Location_Usage_2 varchar(20);
    DECLARE Rr_FWDLoc varchar(20);
    DECLARE rr_LocationUsage varchar(20);
    DECLARE r_Dimension_Restrictions1 varchar(10);
    DECLARE r_Dimension_Restrictions2 varchar(10);
    DECLARE r_Dimension_Restrictions3 varchar(10);
    DECLARE r_Dimension_Restrictions4 varchar(10);
    DECLARE r_Dimension_Restrictions5 varchar(10);
    DECLARE r_LocationStatus_Includes1 varchar(10);
    DECLARE r_LocationStatus_Includes2 varchar(10);
    DECLARE r_LocationStatus_Includes3 varchar(10);
    DECLARE r_LocationStatus_Includes4 varchar(10);
    DECLARE r_LocationUsage_Includes1 varchar(2);
    DECLARE r_LocationUsage_Includes2 varchar(2);
    DECLARE r_LocationUsage_Includes3 varchar(2);
    DECLARE r_LocationUsage_Includes4 varchar(2);
    DECLARE r_LocationUsage_Includes5 varchar(2);
    DECLARE r_LocationUsage_Excludes1 varchar(2);
    DECLARE r_LocationUsage_Excludes2 varchar(2);
    DECLARE r_LocationUsage_Excludes3 varchar(2);
    DECLARE r_LocationUsage_Excludes4 varchar(2);
    DECLARE r_LocationUsage_Excludes5 varchar(2);
    DECLARE r_LocationCategory_Includes1 varchar(2);
    DECLARE r_LocationCategory_Includes2 varchar(2);
    DECLARE r_LocationCategory_Includes3 varchar(2);
    DECLARE r_LocationCategory_Includes4 varchar(2);
    DECLARE r_LocationCategory_Excludes1 varchar(2);
    DECLARE r_LocationCategory_Excludes2 varchar(2);
    DECLARE r_LocationCategory_Excludes3 varchar(2);
    DECLARE r_LocationCategory_Excludes4 varchar(2);
    DECLARE r_LocationAttribute_Includes1 varchar(2);
    DECLARE r_LocationAttribute_Includes2 varchar(2);
    DECLARE r_LocationAttribute_Includes3 varchar(2);
    DECLARE r_LocationAttribute_Includes4 varchar(2);
    DECLARE r_LocationAttribute_Excludes1 varchar(2);
    DECLARE r_LocationAttribute_Excludes2 varchar(2);
    DECLARE r_LocationAttribute_Excludes3 varchar(2);
    DECLARE r_LocationAttribute_Excludes4 varchar(2);
    DECLARE r_LocationHandling_Includes1 varchar(2);
    DECLARE r_LocationHandling_Includes2 varchar(2);
    DECLARE r_LocationHandling_Includes3 varchar(2);
    DECLARE r_LocationHandling_Includes4 varchar(2);
    DECLARE r_LocationHandling_Excludes1 varchar(2);
    DECLARE r_LocationHandling_Excludes2 varchar(2);
    DECLARE r_LocationHandling_Excludes3 varchar(2);
    DECLARE r_LocationHandling_Excludes4 varchar(2);
    DECLARE r_LocationDemand_Includes1 varchar(1);
    DECLARE r_LocationDemand_Includes2 varchar(1);
    DECLARE r_LocationDemand_Includes3 varchar(1);
    DECLARE r_LocationDemand_Excludes1 varchar(1);
    DECLARE r_LocationDemand_Excludes2 varchar(1);
    DECLARE r_LocationDemand_Excludes3 varchar(1);
    DECLARE r_LocationGroup1_Includes1 varchar(10);
    DECLARE r_LocationGroup1_Includes2 varchar(10);
    DECLARE r_LocationGroup2_Includes1 varchar(10);
    DECLARE r_LocationGroup2_Includes2 varchar(10);
    DECLARE r_LocationGroup1_Excludes1 varchar(10);
    DECLARE r_LocationGroup1_Excludes2 varchar(10);
    DECLARE r_LocationGroup2_Excludes1 varchar(10);
    DECLARE r_LocationGroup2_Excludes2 varchar(10);
    DECLARE r_ReceiptType_Includes1 varchar(10);
    DECLARE r_ReceiptType_Includes2 varchar(10);
    DECLARE r_ReceiptType_Includes3 varchar(10);
    DECLARE r_ReceiptType_Includes4 varchar(10);
    DECLARE r_MaxMixSKU int;
    DECLARE r_MaxMixLot int;
    DECLARE r_SKUABC_Includes1 char(1);

    DECLARE r_code varchar(30);
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE cCur_Rules CURSOR FOR
    SELECT
      PutawayRule,
      putawayZone,
      FMLocationID,
      ToLocationID,
      Dimension_Restrictions1,
      Dimension_Restrictions2,
      Dimension_Restrictions3,
      Dimension_Restrictions4,
      Dimension_Restrictions5,
      LocationStatus_Includes1,
      LocationStatus_Includes2,
      LocationStatus_Includes3,
      LocationStatus_Includes4,
      LocationUsage_Includes1,
      LocationUsage_Includes2,
      LocationUsage_Includes3,
      LocationUsage_Includes4,
      LocationUsage_Includes5,
      LocationUsage_Excludes1,
      LocationUsage_Excludes2,
      LocationUsage_Excludes3,
      LocationUsage_Excludes4,
      LocationUsage_Excludes5,
      LocationCategory_Includes1,
      LocationCategory_Includes2,
      LocationCategory_Includes3,
      LocationCategory_Includes4,
      LocationCategory_Excludes1,
      LocationCategory_Excludes2,
      LocationCategory_Excludes3,
      LocationCategory_Excludes4,
      LocationAttribute_Includes1,
      LocationAttribute_Includes2,
      LocationAttribute_Includes3,
      LocationAttribute_Includes4,
      LocationAttribute_Excludes1,
      LocationAttribute_Excludes2,
      LocationAttribute_Excludes3,
      LocationAttribute_Excludes4,
      LocationHandling_Includes1,
      LocationHandling_Includes2,
      LocationHandling_Includes3,
      LocationHandling_Includes4,
      LocationHandling_Excludes1,
      LocationHandling_Excludes2,
      LocationHandling_Excludes3,
      LocationHandling_Excludes4,
      LocationDemand_Includes1,
      LocationDemand_Includes2,
      LocationDemand_Includes3,
      LocationDemand_Excludes1,
      LocationDemand_Excludes2,
      LocationDemand_Excludes3,
      LotAtt01,
      LotAtt02,
      LotAtt03,
      LotAtt04,
      LotAtt05,
      LotAtt06,
      LotAtt07,
      LotAtt08,
      LotAtt09,
      LotAtt10,
      LotAtt11,
      LotAtt12,
      TRIM(ReceiptType_Includes1) ReceiptType_Includes1,
      TRIM(ReceiptType_Includes2) ReceiptType_Includes2,
      TRIM(ReceiptType_Includes3) ReceiptType_Includes3,
      TRIM(ReceiptType_Includes4) ReceiptType_Includes4,
      LocationGroup1_Includes1,
      LocationGroup1_Includes2,
      LocationGroup2_Includes1,
      LocationGroup2_Includes2,
      LocationGroup1_Excludes1,
      LocationGroup1_Excludes2,
      LocationGroup2_Excludes1,
      LocationGroup2_Excludes2,
      IFNULL(MaxMixSKU, 0) MaxMixSKU,
      IFNULL(MaxMixLot, 0) MaxMixLot,
      SKUABC_Includes1,
      PackUOM,
      WarehouseID,
      MaxLocationCount,
      NextStepWhenFound,
      NextStepWhenFail,
      LineNumber,
      ASNLineFilter
    FROM RUL_PUTAWAY_DETAILS
    WHERE organizationId = IN_organizationId
    AND PutAwayID = r_PARule
    AND EnableFlag = 'Y'
    ORDER BY LineNumber;
    DECLARE CUR_Locs CURSOR FOR
    SELECT
      LocationID
    FROM TMP_EMPTY_LOC
    ORDER BY pickLogicalSequence, xyzpos;
    DECLARE cCur_PickLoc CURSOR FOR
    SELECT
      FWDLoc,
      Lowerlimit,
      Uplimit
    FROM BAS_FORWARDING_LOC
    WHERE organizationId = IN_organizationId
    AND customerID = IN_CustomerID
    AND SKU = IN_SKU
    AND (Location_Usage = r_Location_Usage_1
    OR Location_Usage = r_Location_Usage_2)
    AND FWDLoc NOT LIKE 'DYNAMIC_%'
    AND (r_WarehouseID = ''
    OR WarehouseID = r_WarehouseID)
    UNION ALL
    SELECT
      b.LocationID,
      a.Lowerlimit,
      a.Uplimit
    FROM BAS_FORWARDING_LOC a
      INNER JOIN INV_LOT_LOC_ID b
        ON a.organizationId = b.organizationId
        AND a.customerId = b.customerId
        AND a.SKU = b.SKU
      INNER JOIN BAS_LOCATION c
        ON b.organizationId = c.organizationId
        AND b.warehouseId = c.warehouseId
        AND b.LocationId = c.LocationId
      INNER JOIN INV_LOT_ATT d
        ON d.organizationId = b.organizationId
        AND d.lotnum = b.lotnum
        AND (d.lotatt04 = a.lotattvalue
        OR a.lotattvalue IS NULL)
    WHERE a.organizationId = IN_organizationId
    AND a.customerId = IN_CustomerId
    AND a.SKU = IN_SKU
    AND c.LocationUsage = rr_LocationUsage
    AND (b.qty > 0
    OR b.qtyrpin > 0
    OR b.qtymvin > 0
    OR b.qtypa > 0)
    AND a.FWDLoc LIKE CONCAT(Rr_FWDLoc, '%')
    AND c.WarehouseID = (CASE WHEN r_WarehouseID = '' THEN m.WarehouseID ELSE r_WarehouseID END);
    DECLARE cCUR_Locs CURSOR FOR
    SELECT
      aa.Locationid
    FROM TMP_EMPTY_LOC AA
      CROSS JOIN (SELECT
          t2.sequenceno
        FROM TMP_BASE_LOC t1
          INNER JOIN (SELECT
              a.locationId,
              a.pickLogicalSequence,
              a.plCount,
              a.csCount,
              a.cubicCapacity,
              a.weightCapacity,
              a.eaCount,
              @N := @N + 1 SequenceNo
            FROM BAS_LOCATION a,
                 (SELECT
                     @N := 0) b
            WHERE a.LocationAttribute NOT IN ('HD', 'FI')
            AND a.organizationId = In_organizationId
            ORDER BY a.organizationId, a.warehouseId, a.pickLogicalSequence) t2
            ON t1.LocationID = t2.LocationID) BB
    ORDER BY ABS(aa.sequenceno - bb.sequenceno), aa.LocationID;

    DECLARE c_code CURSOR FOR
    SELECT
      CODE
    FROM TMP_CODE
    WHERE CODEID = 'ZONEID'
    ORDER BY CODE1
    ;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_Return_Code = CONCAT('999#SPASN_Putaway_Calculation,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;
    SET v_error = 1;
    IF OUT_Return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_CODE (
      codeId varchar(30),
      CODE varchar(100),
      CODE1 varchar(100),
      CODE2 varchar(100)
    );


    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_EMPTY_LOC (
      locationid varchar(30) NOT NULL,
      pickLogicalSequence varchar(20),
      xyzpos decimal(18, 8),
      plcount int,
      cscount int,
      cubiccapacity decimal(18, 8),
      weightcapacity decimal(18, 8),
      eaCount decimal(18, 8),
      sequenceno int
    );
    DELETE
      FROM TMP_EMPTY_LOC;
    SET R_CurrentTime = NOW();
    SET OUT_Return_Code = '000';
    SET r_FOUND = 'N';
    SET IN_FromLoc = IN_FromLoc_C;
    IF IN_UOM = 'EA' THEN
      SET IN_Quantity = IN_Quantity_C;
    ELSE
      SELECT
        IN_Quantity_C * Qty
      FROM BAS_PACKAGE_DETAILS
      WHERE organizationId = In_organizationId
      AND customerId = In_customerId
      AND packid = IN_PackID
      AND pacUom = IN_UOM INTO IN_Quantity;
    END IF;
    IF IN_ASNNO <> '*' THEN




      SET r_CRS_DCK = getsys_configuration(IN_organizationId, IN_Warehouse, In_customerId, r_ASNType, 'CRS_DCK');
      IF r_CRS_DCK = 'Y' THEN
        SELECT
          COUNT(1)
        FROM DOC_ASN_HEADER a
          INNER JOIN RUL_DOC_CTL b
            ON a.ASNType = b.docType
            AND a.customerId = b.customerId
            AND a.organizationId = b.organizationId
            AND b.docType = 'ASN'
            AND b.configId = 'CROSSDOCK'
            AND b.valueString = 'Y'
        WHERE a.organizationId = In_organizationId
        AND a.warehouseId = In_warehouse
        AND a.ASNNO = IN_ASNNO INTO r_nRow;
        IF r_nRow > 0 THEN

          SET v_error = 1;
          SELECT
            LotAtt01,
            LotAtt02,
            LotAtt03,
            LotAtt04,
            LotAtt05,
            LotAtt06,
            LotAtt07,
            LotAtt08,
            LotAtt09,
            LotAtt10,
            LotAtt11,
            LotAtt12
          FROM INV_LOT_ATT
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND lotnum = IN_LotNum INTO r_ALotAtt01, r_ALotAtt02, r_ALotAtt03, r_ALotAtt04, r_ALotAtt05, r_ALotAtt06
          , r_ALotAtt07, r_ALotAtt08, r_ALotAtt09, r_ALotAtt10, r_ALotAtt11, r_ALotAtt12;
          IF v_error = 0 THEN
            SET OUT_Return_Code = '888INV_LOT_ATT,OPEN';
            LEAVE ENDPROC;
          END IF;

          SELECT
            SUM(Qty + QtyPA)
          FROM INV_LOT_LOC_ID
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND customerId = IN_customerId
          AND SKU = IN_SKU
          AND locationID = 'CROSSDOCK' INTO r_QtyCrossDocked;
          IF r_QtyCrossDocked IS NULL THEN
            SET r_QtyCrossDocked = 0;
          END IF;
          SELECT
            (SUM(QtyOrdered_Each - QtyAllocated) - r_QtyCrossDocked)
          FROM DOC_ORDER_DETAILS a
            INNER JOIN DOC_ORDER_HEADER b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.orderNo = b.orderNo
            INNER JOIN RUL_DOC_CTL c
              ON b.organizationId = c.organizationId
              AND b.customerId = c.customerId
              AND b.orderType = c.docType
              AND c.docType = 'SO'
              AND configId = 'CROSSDOCK'
              AND valueString = 'Y'
          WHERE a.organizationId = In_organizationId
          AND a.customerId = In_customerId
          AND a.sku = IN_sku
          AND (LotAtt02 IS NULL
          OR LotAtt02 = 'YYYY-MM-DD')
          AND (LotAtt03 IS NULL
          OR LotAtt03 = 'YYYY-MM-DD')
          AND (LotAtt04 IS NULL
          OR LotAtt04 = r_ALotAtt04)
          AND (LotAtt05 IS NULL
          OR LotAtt05 = r_ALotAtt05)
          AND (LotAtt06 IS NULL
          OR LotAtt06 = r_ALotAtt06)
          AND (LotAtt07 IS NULL
          OR LotAtt07 = r_ALotAtt07)
          AND (LotAtt08 IS NULL
          OR LotAtt08 = r_ALotAtt08)
          AND (LotAtt09 IS NULL
          OR LotAtt09 = r_ALotAtt09)
          AND (LotAtt10 IS NULL
          OR LotAtt10 = r_ALotAtt10)
          AND (LotAtt11 IS NULL
          OR LotAtt11 = r_ALotAtt11)
          AND (LotAtt12 IS NULL
          OR LotAtt12 = r_ALotAtt12) INTO r_QtyCrossDocked;
          IF r_QtyCrossDocked IS NULL THEN
            SET r_QtyCrossDocked = 0;
          END IF;
          IF r_QtyCrossDocked > 0 THEN
            SET r_QtyCrossDocked_Each = IN_Quantity;
            SET OUT_Return_Code = '000';
            SET out_ToLoc = 'CROSSDOCK';
            LEAVE ENDPROC;
          END IF;
        END IF;
      END IF;
    END IF;

    SET v_errormessage = '-2-CrossDock ????';


    IF SUBSTRING(IN_FromLoc, 1, 8) = 'DYNAMIC_' THEN
      SET r_DYNAMIC_FMLOC = Get_UDFA_Parameter(IN_FromLoc, '%', 2);
      SET IN_FromLoc = Get_UDFA_Parameter(IN_FromLoc, '%', 1);

      SET v_error = 1;
      SELECT
        b.putawayrule,
        CASE WHEN IN_UOM = 'EA' THEN a.eaCycleClass ELSE a.Cscycleclass END
      FROM BAS_SKU_MULTIWAREHOUSE a
        INNER JOIN RUL_REPLENISHMENT b
          ON a.organizationId = b.organizationId
          AND a.warehouseId = b.warehouseId
          AND a.ReplenishRule = b.ReplenishID
      WHERE a.organizationId = In_organizationId
      AND a.WarehouseId = IN_Warehouse
      AND a.CustomerID = IN_CustomerID
      AND a.SKU = IN_SKU
      AND a.ReplenishRule IS NOT NULL INTO r_PARule, r_CycleClass;
      IF v_error = 0 THEN
        SET v_error = 1;
        SELECT
          b.PutawayRule,
          a.CycleClass
        FROM BAS_SKU a
          INNER JOIN RUL_REPLENISHMENT b
            ON a.ReplenishRule = b.ReplenishId
            AND b.warehouseId = In_warehouse
            AND a.organizationId = b.organizationId
        WHERE a.organizationId = In_organizationId
        AND a.SKU = IN_SKU
        AND a.CustomerID = IN_CustomerID INTO r_PARule, r_CycleClass;
        IF v_error = 0 THEN
          SET r_PARule = NULL;
        END IF;
      END IF;

    ELSE

      SET v_error = 1;
      SET r_nRow = 1;
      SELECT
        0,
        PutawayRule,
        CASE WHEN IN_UOM = 'EA' THEN Eacycleclass ELSE Cscycleclass END
      FROM BAS_SKU_MULTIWAREHOUSE
      WHERE organizationId = In_organizationId
      AND Warehouseid = IN_Warehouse
      AND CustomerID = IN_CustomerID
      AND SKU = IN_SKU
      AND PutawayRule IS NOT NULL INTO r_nRow, r_PARule, r_CycleClass;
      IF r_nRow = 1 THEN
        SET r_nRow = 1;
        SELECT
          0,
          PutawayRule,
          CycleClass
        FROM BAS_SKU
        WHERE CustomerID = IN_CustomerID
        AND SKU = IN_SKU
        AND organizationId = In_organizationId INTO r_nRow, r_PARule, r_CycleClass;
        IF r_nRow = 1 THEN
          SET r_PARule = NULL;
        END IF;
      END IF;

    END IF;

    IF IFNULL(r_PARule, '') = '' THEN
      SET out_ToLoc = 'NO-LOC';
      SET OUT_Return_Code = '000';
      LEAVE ENDPROC;
    END IF;

    SET v_errormessage = '-3-??????';


    OPEN cCUR_Rules;
    SET v_errormessage = 'Fetch cCur_Rules';
    SET v_error = 1;
    FETCH cCur_Rules
    INTO r_PutawayRule, r_zoneId, r_FMLocationID, r_ToLocationID
    , r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5
    , r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4
    , r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5
    , r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5
    , r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4
    , r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4
    , r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4
    , r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4
    , r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4
    , r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4
    , r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3
    , r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3
    , r_LotAtt01, r_LotAtt02, r_LotAtt03, r_LotAtt04, r_LotAtt05, r_LotAtt06, r_LotAtt07, r_LotAtt08, r_LotAtt09, r_LotAtt10, r_LotAtt11, r_LotAtt12
    , r_ReceiptType_Includes1, r_ReceiptType_Includes2, r_ReceiptType_Includes3, r_ReceiptType_Includes4
    , r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2
    , r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2
    , r_MaxMixSKU, r_MaxMixLot, r_SKUABC_Includes1, r_PackUOM, r_WarehouseID
    , r_MaxLocationCount, r_NextStepWhenFound, r_NextStepWhenFail, r_LineNumber, r_ASNLineFilter;
    IF v_error = 0 THEN
      SET out_ToLoc = 'NO-LOC';
      SET OUT_Return_Code = '000';
      LEAVE ENDPROC;
    END IF;


  while0:
    WHILE r_FOUND = 'N' DO
    loop1:
      BEGIN
        SET r_MaxLocationCount = IFNULL(r_MaxLocationCount, 0);
        SET r_PackUOM = TRIM(r_PackUOM);


        SET r_WarehouseID = IFNULL(r_Warehouseid, '');



        IF r_WarehouseID <> ''
          AND IN_ASNNO <> '*' THEN
          SET r_Warehouse_ASN = '';
          SELECT
            IFNULL(WarehouseID, '')
          FROM DOC_ASN_HEADER
          WHERE organizationId = In_organizationId
          AND ASNNO = IN_ASNNO INTO r_Warehouse_ASN;
        ELSEIF IFNULL(r_WarehouseID, '') <> ''
          AND IN_ASNNO = '*' THEN
          SET r_Warehouse_ASN = IN_WareHouse;
        END IF;
        IF r_Warehouse_ASN <> r_WarehouseID
          AND r_WarehouseID <> '' THEN
          LEAVE Loop1;
        END IF;



        IF IFNULL(r_Asnlinefilter, '') <> ''
          AND IN_ASNNO <> '' THEN
          SET v_error = 1;
          SELECT
            IFNULL(ASNLineFilter, '')
          FROM DOC_ASN_DETAILS
          WHERE organizationId = IN_organizationId
          AND warehouseId = In_warehouse
          AND ASNNO = IN_ASNNO
          AND ASNLineNo = IN_ASNLineNo INTO r_ASNLineFilter_ASN;
          IF v_error = 0 THEN
            SET r_ASNLineFilter_ASN = '';
          END IF;
          IF r_Asnlinefilter <> r_ASNLineFilter_ASN
            AND r_ASNLineFilter_ASN <> '' THEN
            LEAVE Loop1;
          END IF;
        END IF;


        IF (IFNULL(r_ReceiptType_Includes1, '') <> ''
          OR IFNULL(r_ReceiptType_Includes2, '') <> ''
          OR IFNULL(r_ReceiptType_Includes3, '') <> ''
          OR IFNULL(r_ReceiptType_Includes4, '') <> '')
          AND IN_ASNNO <> '*' THEN
          SELECT
            ASNType
          FROM DOC_ASN_HEADER
          WHERE organizationId = In_organizationId
          AND warehouseId = In_warehouse
          AND ASNNO = IN_ASNNO INTO r_ASNTYPE;
          IF r_ASNType NOT IN (r_ReceiptType_Includes1, r_ReceiptType_Includes2
            , r_ReceiptType_Includes3, r_ReceiptType_Includes4) THEN
            LEAVE Loop1;
          END IF;
        END IF;

        IF IFNULL(r_SKUABC_Includes1, '') <> ''
          AND IFNULL(r_CycleClass, '') <> IFNULL(r_SKUABC_Includes1, '') THEN
          LEAVE Loop1;
        END IF;

        IF IFNULL(r_PackUOM, '') <> ''
          AND r_PackUOM <> IN_UOM THEN
          LEAVE Loop1;
        END IF;





        IF r_PutawayRule IN ('01', '04', '07') THEN
          IF (IN_FromLoc = r_FMLocationID
            OR r_PutawayRule IN ('04', '07')) THEN
            IF r_PutawayRule = '07' THEN
              SET v_error = 1;
              SELECT
                IFNULL(PutawayLocation, '')
              FROM BAS_SKU_MULTIWAREHOUSE
              WHERE CustomerID = IN_CustomerID
              AND sku = IN_SKU
              AND warehouseid = IN_Warehouse
              AND organizationId = In_organizationId INTO r_ToLocationID;
              IF v_error = 0 THEN
                SET r_ToLocationID = '';
              END IF;
            END IF;

            CALL SPASN_Putaway_RestrictionCheck(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_PackID, r_ToLocationID, IN_Weight, IN_Cubic, IN_Quantity,
            r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
            r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
            '', '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '',
            r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
            r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
            r_MaxMixSKU, r_MaxMixLOT,
            r_FOUND);
            IF r_FOUND = 'Y' THEN
              SET OUT_ToLoc = r_ToLocationID;
            END IF;
            IF r_FOUND = 'T' THEN
              SET OUT_ToLoc = '******';
            END IF;
          END IF;
        END IF;









        IF r_PutawayRule IN ('02', '03', '08', '09', '10', '31', '33', '06') THEN
          IF IN_FromLoc = r_FMLocationID
            OR r_PutawayRule IN ('03', '08', '09', '10', '31', '33', '06') THEN

            DELETE
              FROM TMP_CODE
            WHERE codeId = 'ZONEID';
            IF r_PutawayRule IN ('08', '09', '10') THEN
              SELECT
                CASE r_PutawayRule WHEN '08' THEN zoneId WHEN '09' THEN alternative_zoneId1 WHEN '10' THEN alternative_zoneId2 END
              FROM BAS_SKU
              WHERE CustomerID = IN_CustomerID
              AND SKU = IN_SKU INTO r_zoneId;
            END IF;
            IF r_PutawayRule = '06' THEN
              INSERT INTO TMP_CODE (CODEID, CODE, CODE1)
                SELECT
                  'ZONEID',
                  a.zoneId,
                  a.seqno
                FROM BAS_SKU_zoneId a
                WHERE a.Customerid = IN_CustomerID
                AND a.Sku = IN_SKU
                AND a.Warehouseid = IN_Warehouse
                AND a.organizationId = In_organizationId;
            ELSE
              INSERT INTO TMP_CODE (CODEID, CODE, CODE1)
                VALUES ('ZONEID', r_zoneId, '1');
            END IF;
            OPEN c_code;
            SET v_error = 1;
            FETCH c_code INTO r_code;
            WHILE v_error <> 0 DO
              SET r_zoneId = r_code;
              IF r_MaxLocationCount > 0 THEN

                SELECT
                  COUNT(DISTINCT a.LocationID)
                FROM INV_LOT_LOC_ID a
                  INNER JOIN BAS_LOCATION b
                    ON a.organizationId = b.organizationId
                    AND a.warehouseId = b.warehouseId
                    AND a.LocationID = b.LocationID
                WHERE b.zoneId = r_zoneId
                AND a.CustomerID = IN_CustomerID
                AND a.SKU = IN_SKU
                AND a.warehouseId = In_warehouse
                AND a.organizationId = In_organizationId
                AND (a.qty > 0
                OR a.qtyrpin > 0
                OR a.qtymvin > 0
                OR a.qtypa > 0) INTO r_ActualLocationCount;
                IF r_ActualLocationCount >= r_MaxLocationCount THEN
                  LEAVE Loop1;
                END IF;
              END IF;

              SET r_SQL = 'Insert Into TMP_EMPTY_LOC(LocationID, PLCount, CSCOUNT, cubiccapacity, weightcapacity, eaCount, pickLogicalSequence, XYZPOS) ';
              SET r_SQL = CONCAT(r_SQL, 'Select a.LocationID, PLCount, CSCOUNT, cubiccapacity, weightcapacity, eaCount');
              IF r_PutawayRule IN ('31', '33') THEN
                IF r_PutawayRule = '31' THEN

                  SET r_x = 0;
                  SET R_y = 0;
                  SET R_z = 0;
                  IF IFNULL(IN_FromLoc, '') <> '' THEN
                    SELECT
                      b.XCoord,
                      b.YCoord,
                      b.ZCoord
                    FROM BAS_FORWARDING_LOC a
                      INNER JOIN BAS_LOCATION b
                        ON a.fwdloc = b.locationid
                        AND a.organizationId = b.organizationId
                        AND b.warehouseId = In_warehouse
                    WHERE a.organizationId = In_organizationId
                    AND a.customerid = IN_CustomerID
                    AND a.sku = IN_SKU
                    AND a.fmLocation = IN_FromLoc
                    AND a.fwdloc NOT LIKE 'DYNAMIC_%'
                    LIMIT 1 INTO r_x, r_y, r_z;
                  END IF;
                  IF r_x = 0
                    AND r_Y = 0
                    AND r_Z = 0 THEN
                    SET v_error = 1;
                    SELECT
                      b.XCoord,
                      b.YCoord,
                      b.ZCoord
                    FROM BAS_FORWARDING_LOC a
                      INNER JOIN BAS_LOCATION b
                        ON a.organizationId = b.organizationId
                        AND a.fwdloc = b.locationid
                        AND b.warehouseId = In_warehouse
                    WHERE a.organizationId = In_organizationId
                    AND a.customerid = IN_CustomerID
                    AND a.sku = IN_SKU
                    AND a.fwdloc NOT LIKE 'DYNAMIC_%'
                    LIMIT 1 INTO r_x, r_y, r_z;
                    IF v_error = 0 THEN


                      SET v_error = 1;
                      SELECT
                        XCoord,
                        YCoord,
                        ZCoord
                      FROM INV_LOT_LOC_ID a
                        INNER JOIN BAS_LOCATION b
                          ON a.organizationId = b.organizationId
                          AND a.warehouseId = b.warehouseId
                          AND a.LocationId = b.LocationId
                      WHERE a.organizationId = In_organizationId
                      AND a.warehouseId = In_warehouse
                      AND a.CustomerID = IN_CustomerID
                      AND a.SKU = IN_SKU
                      AND b.LocationUsage IN ('EA', 'CS', 'PC')
                      AND (a.Qty > 0
                      OR a.QTYPA > 0
                      OR a.QTYRPIN > 0
                      OR QTYMVIN > 0)
                      LIMIT 1 INTO r_x, r_y, r_Z;

                      IF v_error = 0 THEN
                        SET r_x = 0;
                        SET R_y = 0;
                        SET R_z = 0;
                      END IF;

                    END IF;
                  END IF;
                ELSE
                  SET v_error = 1;
                  SELECT
                    XCoord,
                    YCoord,
                    ZCoord
                  FROM BAS_LOCATION b
                  WHERE b.LocationID = r_DYNAMIC_FMLOC
                  AND b.organizationId = In_organizationId
                  AND b.warehouseId = In_warehouse INTO r_x, r_y, r_Z;
                  IF v_error = 0 THEN
                    SET r_x = 0;
                    SET R_y = 0;
                    SET R_z = 0;
                  END IF;
                END IF;

                SET r_x = IFNULL(r_X, 0);
                SET R_y = IFNULL(r_y, 0);
                SET R_z = IFNULL(R_z, 0);
                SET r_SQL = CONCAT(r_SQL, ', null');

                IF r_x >= 0 THEN

                  SET r_SQL = CONCAT(r_SQL, ',power(a.xCoord-', r_x, ', 2) ');
                ELSE
                  SET r_SQL = CONCAT(r_SQL, ',power(a.xCoord+', ABS(r_x), ', 2) ');
                END IF;
                IF r_y >= 0 THEN

                  SET r_SQL = CONCAT(r_SQL, '+power(a.yCoord-', r_Y, ', 2) ');
                ELSE
                  SET r_SQL = CONCAT(r_SQL, '+power(a.YCoord+', ABS(r_Y), ', 2) ');
                END IF;
                IF r_z >= 0 THEN

                  SET r_SQL = CONCAT(r_SQL, '+power(a.zCoord-', r_z, ', 2) ');
                ELSE
                  SET r_SQL = CONCAT(r_SQL, '+power(a.zCoord+', ABS(r_z), ', 2) ');
                END IF;
                SET r_SQL = CONCAT(r_SQL, ' from BAS_LOCATION a ');
              ELSE
                SET r_SQL = CONCAT(r_SQL, ', a.pickLogicalSequence, null from BAS_LOCATION a ');
              END IF;

              SET r_SQL = CONCAT(r_SQL, ' Where a.organizationId = ? and a.LocationAttribute not in(''HD'',''FI'')');
              IF IFNULL(R_zoneId, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.zoneId = ''', R_zoneId, ''' ');
              END IF;
              IF r_LocationStatus_Includes1 = '02'
                OR r_LocationStatus_Includes2 = '02'
                OR r_LocationStatus_Includes3 = '02'
                OR r_LocationStatus_Includes4 = '02' THEN
                SET r_SQL = CONCAT(r_SQL, ' and not exists (select 1 from INV_LOT_LOC_ID  b WHERE a.Locationid = b.Locationid and (b.qty>0 or b.qtyrpin >0 or b.qtymvin >0 or b.qtypa >0)) ');
                SET r_SQL = CONCAT(r_SQL, ' and not exists(select 1 from DOC_ASN_PREPALLETIZE c WHERE A.Locationid = c.RESERVEDLOCATION and c.ActualPalletNo = ''*'') ');
              END IF;
              IF IFNULL(r_LocationUsage_Includes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocationUsage = ''', r_LocationUsage_Includes1, '''');
              END IF;
              IF IFNULL(r_LocationUsage_Excludes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocationUsage <> ''', r_LocationUsage_Excludes1, '''');
              END IF;
              IF IFNULL(r_LocationCategory_Includes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocationCategory = ''', r_LocationCategory_Includes1, '''');
              END IF;
              IF IFNULL(r_LocationCategory_Excludes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocationCategory <> ''', r_LocationCategory_Excludes1, '''');
              END IF;
              IF IFNULL(r_LocationHandling_Includes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocationHandling = ''', r_LocationHandling_Includes1, '''');
              END IF;
              IF IFNULL(r_LocationHandling_Excludes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocationHandling <> ''', r_LocationHandling_Excludes1, '''');
              END IF;
              IF IFNULL(r_LocationUsage_Includes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocationUsage = ''', r_LocationUsage_Includes1, '''');
              END IF;
              IF IFNULL(r_LocationUsage_Excludes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocationUsage <> ''', r_LocationUsage_Excludes1, '''');
              END IF;
              IF IFNULL(r_LocationGroup1_Includes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup1 = ''', r_LocationGroup1_Includes1, '''');
              END IF;
              IF IFNULL(r_LocationGroup1_Excludes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup1 <> ''', r_LocationGroup1_Excludes1, '''');
              END IF;
              IF IFNULL(r_LocationGroup2_Includes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup2 = ''', r_LocationGroup2_Includes1, '''');
              END IF;
              IF IFNULL(r_LocationGroup2_Excludes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup2 <> ''', r_LocationGroup2_Excludes1, '''');
              END IF;

              IF r_LocationStatus_Includes1 = '05'
                OR r_LocationStatus_Includes2 = '05'
                OR r_LocationStatus_Includes3 = '05'
                OR r_LocationStatus_Includes4 = '05' THEN
                SET r_SQL = CONCAT(r_SQL, ' and not exists(select 1 FROM INV_LOT_LOC_ID t where t.CustomerID <> '''
                , IN_CustomerID, ''' and t.organizationId = t.organizationId and a.warehouseId = t.warehouseId and t.LocationID = a.LocationID and (t.qty>0 or t.qtyrpin >0 or t.qtymvin >0 or t.qtypa >0))');
              END IF;


              IF r_LocationStatus_Includes1 = '06'
                OR r_LocationStatus_Includes2 = '06'
                OR r_LocationStatus_Includes3 = '06'
                OR r_LocationStatus_Includes4 = '06'
                OR r_LocationStatus_Includes1 = '07'
                OR r_LocationStatus_Includes2 = '07'
                OR r_LocationStatus_Includes3 = '07'
                OR r_LocationStatus_Includes4 = '07' THEN
                SET r_SQL = CONCAT(r_SQL, ' and exists(select 1 FROM INV_LOT_LOC_ID t where t.CustomerID = ''', IN_CustomerID, ''' ', ' and t.SKU = ''', IN_SKU, ''' and t.organizationId = a.organizationId and t.warehouseId=a.warehouseId and t.LocationID = a.LocationID and (t.qty>0 or t.qtyrpin >0 or t.qtymvin >0 or t.qtypa >0))');
              END IF;

              IF r_LocationStatus_Includes1 >= '08'
                AND r_LocationStatus_Includes1 <= '12'
                OR r_LocationStatus_Includes2 >= '08'
                AND r_LocationStatus_Includes2 <= '12'
                OR r_LocationStatus_Includes3 >= '08'
                AND r_LocationStatus_Includes3 <= '12'
                OR r_LocationStatus_Includes4 >= '08'
                AND r_LocationStatus_Includes4 <= '12' THEN
                SELECT
                  a.SKu_Group1,
                  a.SKu_Group2,
                  a.SKu_Group3,
                  a.SKu_Group4,
                  a.SKu_Group5
                FROM BAS_SKU a
                WHERE a.organizationId = In_organizationId
                AND a.CustomerID = IN_CustomerID
                AND a.SKU = IN_SKU INTO r_SKuGroup1, r_SKuGroup2, r_SKuGroup3, r_SKuGroup4, r_SKuGroup5;
                SET r_SQL = CONCAT(r_SQL, ' and exists (select 1 FROM INV_LOT_LOC_ID t1 inner join BAS_SKU t2 on t1.CustomerID = t2.CustomerID and t1.SKU = t2.SKU  and t1.organizationId = t2.organizationId');
                SET r_SQL = CONCAT(r_SQL, '   where t1.locationid = a.LocationID and t.organizationId = a.organizationId and t.warehouseId=a.warehouseId and (t1.qty>0 or t1.qtyrpin >0 or t1.qtymvin >0 or t1.qtypa >0)');
                IF r_LocationStatus_Includes1 = '08'
                  OR r_LocationStatus_Includes2 = '08'
                  OR r_LocationStatus_Includes3 = '08'
                  OR r_LocationStatus_Includes4 = '08' THEN
                  SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group1 = ''', r_SKUGroup1, '''');
                END IF;
                IF r_LocationStatus_Includes1 = '09'
                  OR r_LocationStatus_Includes2 = '09'
                  OR r_LocationStatus_Includes3 = '09'
                  OR r_LocationStatus_Includes4 = '09' THEN
                  SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group2 = ''', r_SKUGroup2, '''');
                END IF;
                IF r_LocationStatus_Includes1 = '10'
                  OR r_LocationStatus_Includes2 = '10'
                  OR r_LocationStatus_Includes3 = '10'
                  OR r_LocationStatus_Includes4 = '10' THEN
                  SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group3 = ''', r_SKUGroup3, '''');
                END IF;
                IF r_LocationStatus_Includes1 = '11'
                  OR r_LocationStatus_Includes2 = '11'
                  OR r_LocationStatus_Includes3 = '11'
                  OR r_LocationStatus_Includes4 = '11' THEN
                  SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group4 = ''', r_SKUGroup4, '''');
                END IF;
                IF r_LocationStatus_Includes1 = '12'
                  OR r_LocationStatus_Includes2 = '12'
                  OR r_LocationStatus_Includes3 = '12'
                  OR r_LocationStatus_Includes4 = '12' THEN
                  SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group5 = ''', r_SKUGroup5, '''');
                END IF;
                SET r_SQL = CONCAT(r_SQL, ')');
              END IF;


              IF IFNULL(r_LocationGroup1_Includes2, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup1 = ''', r_LocationGroup1_Includes2, '''');
              END IF;
              IF IFNULL(r_LocationGroup1_Excludes2, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup1 <> ''', r_LocationGroup1_Excludes2, '''');
              END IF;
              IF IFNULL(r_LocationGroup2_Includes2, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup2 = ''', r_LocationGroup2_Includes2, '''');
              END IF;
              IF IFNULL(r_LocationGroup2_Excludes2, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup2 <> ''', r_LocationGroup2_Excludes2, '''');
              END IF;


              IF IFNULL(r_LocationDemand_Includes1, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.Demand = ''', r_LocationDemand_Includes1, '''');
              END IF;
              IF IFNULL(r_LocationDemand_Includes2, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.Demand = ''', r_LocationDemand_Includes2, '''');
              END IF;
              IF IFNULL(r_LocationDemand_Includes3, '') <> '' THEN
                SET r_SQL = CONCAT(r_SQL, ' and a.Demand = ''', r_LocationDemand_Includes3, '''');
              END IF;

              DELETE
                FROM TMP_EMPTY_LOC;
              IF r_LocationStatus_Includes1 = '06'
                OR r_LocationStatus_Includes2 = '06'
                OR r_LocationStatus_Includes3 = '06'
                OR r_LocationStatus_Includes4 = '06'
                OR r_LocationStatus_Includes1 = '07'
                OR r_LocationStatus_Includes2 = '07'
                OR r_LocationStatus_Includes3 = '07'
                OR r_LocationStatus_Includes4 = '07' THEN
                SET @SQL = r_SQL;
                SET v_errormessage = @SQL;
                SET @organizationId = In_organizationId;
                PREPARE STMT FROM @SQL;
                EXECUTE STMT USING @organizationId;
                DEALLOCATE PREPARE STMT;
              ELSE
                SET @SQL = r_SQL;
                SET v_errormessage = @SQL;
                SET @organizationId = In_organizationId;
                PREPARE STMT FROM @SQL;
                EXECUTE STMT USING @organizationId;
                DEALLOCATE PREPARE STMT;
              END IF;

              CALL SPASN_Putaway_LocationFilter(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_Weight, IN_Cubic, IN_Quantity,
              NULL,
              r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
              r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
              r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5,
              r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5,
              r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4,
              r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4,
              r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4,
              r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4,
              r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4,
              r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4,
              r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3,
              r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3,
              r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
              r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
              r_MaxMixSKU, r_MaxMixLOT, OUT_Return_Code);

              OPEN CUR_Locs;
              SET v_error = 1;
              FETCH CUR_Locs INTO R_ToLocationID;
            whilefound:
              WHILE v_error <> 0 DO
                IF R_FOUND <> 'N' THEN
                  LEAVE whilefound;
                END IF;
                CALL SPASN_Putaway_RestrictionCheck(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_PackID, r_ToLocationID, IN_Weight, IN_Cubic, IN_Quantity,
                r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
                r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
                r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5,
                r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5,
                r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4,
                r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4,
                r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4,
                r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4,
                r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4,
                r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4,
                r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3,
                r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3,
                r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
                r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
                r_MaxMixSKU, r_MaxMixLOT,
                r_FOUND);
                IF r_FOUND = 'Y' THEN
                  SET OUT_ToLoc = r_ToLocationID;
                END IF;
                IF r_FOUND = 'T' THEN
                  SET OUT_ToLoc = '******';
                END IF;
                SET v_error = 1;
                FETCH CUR_Locs INTO R_ToLocationID;
              END WHILE;
              CLOSE CUR_Locs;
              SET v_error = 1;
              FETCH c_code INTO r_code;
            END WHILE;
            CLOSE c_code;
          END IF;
        END IF;





        SET v_errormessage = '11/12/13';
        IF (r_PutawayRule = '11'
          OR r_PutawayRule = '12'
          OR r_PutawayRule = '13') THEN
          IF r_PutawayRule = '11' THEN
            SET rR_FWDLoc = 'DYNAMIC_EA';
            SET rr_LocationUsage = 'EA';
            SET r_Location_Usage_1 = 'EA';
            SET r_Location_Usage_2 = 'PC';
          ELSEIF r_PutawayRule = '12' THEN
            SET Rr_FWDLoc = 'DYNAMIC_CS';
            SET rr_LocationUsage = 'CS';
            SET r_Location_Usage_1 = 'CS';
            SET r_Location_Usage_2 = 'PC';
          ELSEIF r_PutawayRule = '13' THEN
            SET Rr_FWDLoc = 'DYNAMIC_PC';
            SET rr_LocationUsage = 'PC';
            SET r_Location_Usage_1 = 'PC';
            SET r_Location_Usage_2 = '**';
          END IF;
          OPEN cCur_PickLoc;
          SET v_error = 1;
          FETCH cCur_PickLoc INTO r_ToLocationID, r_Lowerlimit, r_Uplimit;
        whilefound2:
          WHILE v_error <> 0 DO
            SET v_errormessage = 'Fetch cCur_PickLoc';
            IF r_FOUND <> 'N' THEN
              LEAVE whilefound2;
            END IF;
            CALL SPASN_Putaway_RestrictionCheck(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_PackID, r_ToLocationID, IN_Weight, IN_Cubic, IN_Quantity,
            r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
            r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
            r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5,
            r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5,
            r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4,
            r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4,
            r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4,
            r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4,
            r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4,
            r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4,
            r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3,
            r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3,
            r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
            r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
            r_MaxMixSKU, r_MaxMixLOT,
            r_FOUND);
            IF r_FOUND = 'Y' THEN
              SET out_ToLoc = r_ToLocationID;
            END IF;
            IF r_FOUND = 'T' THEN
              SET out_ToLoc = '******';
            END IF;
            SET v_error = 1;
            FETCH cCur_PickLoc INTO r_ToLocationID, r_Lowerlimit, r_Uplimit;
          END WHILE;
          CLOSE cCUR_PickLoc;
        END IF;




        SET v_errormessage = '21/22';
        IF r_PutawayRule IN ('21', '22') THEN

          SET v_error = 1;
          SELECT
            LotAtt01,
            LotAtt02,
            LotAtt03,
            LotAtt04,
            LotAtt05,
            LotAtt06,
            LotAtt07,
            LotAtt08,
            LotAtt09,
            LotAtt10,
            LotAtt11,
            LotAtt12
          FROM INV_LOT_ATT
          WHERE organizationId = In_organizationId
          AND lotnum = IN_LotNum INTO r_ALotAtt01, r_ALotAtt02, r_ALotAtt03, r_ALotAtt04, r_ALotAtt05, r_ALotAtt06
          , r_ALotAtt07, r_ALotAtt08, r_ALotAtt09, r_ALotAtt10, r_ALotAtt11, r_ALotAtt12;

          SET r_Match = 'Y';
          IF IFNULL(r_LotAtt01, '') <> ''
            AND IFNULL(r_LotAtt01, '') <> IFNULL(r_ALotAtt01, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt02, '') <> ''
            AND IFNULL(r_LotAtt02, '') <> IFNULL(r_ALotAtt02, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt03, '') <> ''
            AND IFNULL(r_LotAtt03, '') <> IFNULL(r_ALotAtt03, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt04, '') <> ''
            AND IFNULL(r_LotAtt04, '') <> IFNULL(r_ALotAtt04, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt05, '') <> ''
            AND IFNULL(r_LotAtt05, '') <> IFNULL(r_ALotAtt05, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt06, '') <> ''
            AND IFNULL(r_LotAtt06, '') <> IFNULL(r_ALotAtt06, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt07, '') <> ''
            AND IFNULL(r_LotAtt07, '') <> IFNULL(r_ALotAtt07, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt08, '') <> ''
            AND IFNULL(r_LotAtt08, '') <> IFNULL(r_ALotAtt08, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt09, '') <> ''
            AND IFNULL(r_LotAtt09, '') <> IFNULL(r_ALotAtt09, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt10, '') <> ''
            AND IFNULL(r_LotAtt10, '') <> IFNULL(r_ALotAtt10, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt11, '') <> ''
            AND IFNULL(r_LotAtt11, '') <> IFNULL(r_ALotAtt11, '') THEN
            SET r_Match = 'N';
          END IF;
          IF IFNULL(r_LotAtt12, '') <> ''
            AND IFNULL(r_LotAtt12, '') <> IFNULL(r_ALotAtt12, '') THEN
            SET r_Match = 'N';
          END IF;

          IF (r_PutawayRule = '22'
            AND r_Match = 'Y') THEN
            CALL SPASN_Putaway_RestrictionCheck(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_PackID, r_ToLocationID, IN_Weight, IN_Cubic, IN_Quantity,
            r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
            r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
            '', '', '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '', '', '',
            '', '', '', '', '', '',
            r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
            r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
            r_MaxMixSKU, r_MaxMixLOT,
            r_FOUND);
            IF r_FOUND = 'Y' THEN
              SET out_ToLoc = r_ToLocationID;
            END IF;
            IF r_FOUND = 'T' THEN
              SET out_ToLoc = '******';
            END IF;
          END IF;
          IF (r_PutawayRule = '21'
            AND r_Match = 'Y') THEN
            IF r_MaxLocationCount > 0 THEN

              SELECT
                COUNT(DISTINCT a.LocationID)
              FROM INV_LOT_LOC_ID a
                INNER JOIN BAS_LOCATION b
                  ON a.organizationId = b.organizationId
                  AND a.warehouseId = b.warehouseId
                  AND a.locationId = b.locationId
              WHERE a.organizationId = In_organizationId
              AND b.zoneId = r_zoneId
              AND a.CustomerID = IN_CustomerID
              AND a.SKU = IN_SKU
              AND (a.qty > 0
              OR a.qtyrpin > 0
              OR a.qtymvin > 0
              OR a.qtypa > 0) INTO r_ActualLocationCount;
              IF r_ActualLocationCount >= r_MaxLocationCount THEN
                LEAVE Loop1;
              END IF;
            END IF;
            SET r_SQL = 'Insert Into TMP_EMPTY_LOC(LocationID, PLCount, CSCOUNT, cubiccapacity, weightcapacity, eaCount, pickLogicalSequence, XYZPOS) ';
            SET r_SQL = CONCAT(r_SQL, 'Select a.LocationID, PLCount, CSCOUNT, cubiccapacity, weightcapacity, eaCount');
            SET r_SQL = CONCAT(r_SQL, ', a.pickLogicalSequence, null from BAS_LOCATION a ');

            SET r_SQL = CONCAT(r_SQL, ' Where a.organizationId = ? and a.LocationAttribute not in(''HD'',''FI'') )');
            SET r_SQL = CONCAT(r_SQL, ' and a.zoneId = ''', R_zoneId, ''' ');
            IF r_LocationStatus_Includes1 = '02'
              OR r_LocationStatus_Includes2 = '02'
              OR r_LocationStatus_Includes3 = '02'
              OR r_LocationStatus_Includes4 = '02' THEN
              SET r_SQL = CONCAT(r_SQL, ' and not exists (select 1 from INV_LOT_LOC_ID  b WHERE a.organizationId = b.organizationId and a.warehouseId = b.warehouseId and a.Locationid = b.Locationid and (b.qty>0 or b.qtyrpin >0 or b.qtymvin >0 or b.qtypa >0)) ');
              SET r_SQL = CONCAT(r_SQL, ' and not exists(select 1 from DOC_ASN_PREPALLETIZE c WHERE a.organizationId = c.organizationId and a.warehouseId = c.warehouseId and a.Locationid = c.RESERVEDLOCATION and c.ActualPalletNo = ''*'') ');
            END IF;
            IF IFNULL(r_LocationUsage_Includes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocationUsage = ''', r_LocationUsage_Includes1, '''');
            END IF;
            IF IFNULL(r_LocationUsage_Excludes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocationUsage <> ''', r_LocationUsage_Excludes1, '''');
            END IF;
            IF IFNULL(r_LocationCategory_Includes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocationCategory = ''', r_LocationCategory_Includes1, '''');
            END IF;
            IF IFNULL(r_LocationCategory_Excludes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocationCategory <> ''', r_LocationCategory_Excludes1, '''');
            END IF;
            IF IFNULL(r_LocationHandling_Includes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocationHandling = ''', r_LocationHandling_Includes1, '''');
            END IF;
            IF IFNULL(r_LocationHandling_Excludes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocationHandling <> ''', r_LocationHandling_Excludes1, '''');
            END IF;
            IF IFNULL(r_LocationUsage_Includes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocationUsage = ''', r_LocationUsage_Includes1, '''');
            END IF;
            IF IFNULL(r_LocationUsage_Excludes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocationUsage <> ''', r_LocationUsage_Excludes1, '''');
            END IF;
            IF IFNULL(r_LocationGroup1_Includes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup1 = ''', r_LocationGroup1_Includes1, '''');
            END IF;
            IF IFNULL(r_LocationGroup1_Excludes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup1 <> ''', r_LocationGroup1_Excludes1, '''');
            END IF;
            IF IFNULL(r_LocationGroup2_Includes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup2 = ''', r_LocationGroup2_Includes1, '''');
            END IF;
            IF IFNULL(r_LocationGroup2_Excludes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup2 <> ''', r_LocationGroup2_Excludes1, '''');
            END IF;

            IF r_LocationStatus_Includes1 = '05'
              OR r_LocationStatus_Includes2 = '05'
              OR r_LocationStatus_Includes3 = '05'
              OR r_LocationStatus_Includes4 = '05' THEN
              SET r_SQL = CONCAT(r_SQL, ' and not exists(select 1 FROM INV_LOT_LOC_ID t where t.CustomerID <> ''', IN_CustomerID, ''' and a.organizationId = t.organizationId and a.warehouseId = t.warehouseId and and t.LocationID = a.LocationID and (t.qty>0 or t.qtyrpin >0 or t.qtymvin >0 or t.qtypa >0))');
            END IF;


            IF r_LocationStatus_Includes1 = '06'
              OR r_LocationStatus_Includes2 = '06'
              OR r_LocationStatus_Includes3 = '06'
              OR r_LocationStatus_Includes4 = '06'
              OR r_LocationStatus_Includes1 = '07'
              OR r_LocationStatus_Includes2 = '07'
              OR r_LocationStatus_Includes3 = '07'
              OR r_LocationStatus_Includes4 = '07' THEN
              SET r_SQL = CONCAT(r_SQL, ' and exists(select 1 FROM INV_LOT_LOC_ID t where t.CustomerID = '''
              , IN_CustomerID, ''' and t.SKU = ''', IN_SKU, ''' and t.LocationID = a.LocationID and (t.qty>0 or t.qtyrpin >0 or t.qtymvin >0 or t.qtypa >0))');
            END IF;


            IF r_LocationStatus_Includes1 >= '08'
              AND r_LocationStatus_Includes1 <= '12'
              OR r_LocationStatus_Includes2 >= '08'
              AND r_LocationStatus_Includes2 <= '12'
              OR r_LocationStatus_Includes3 >= '08'
              AND r_LocationStatus_Includes3 <= '12'
              OR r_LocationStatus_Includes4 >= '08'
              AND r_LocationStatus_Includes4 <= '12' THEN
              SELECT
                a.SKu_Group1,
                a.SKu_Group2,
                a.SKu_Group3,
                a.SKu_Group4,
                a.SKu_Group5
              FROM BAS_SKU a
              WHERE a.CustomerID = IN_CustomerID
              AND a.SKU = IN_SKU INTO r_SKuGroup1, r_SKuGroup2, r_SKuGroup3, r_SKuGroup4, r_SKuGroup5;
              SET r_SQL = CONCAT(r_SQL, ' and exists (select 1 FROM INV_LOT_LOC_ID t1 inner join BAS_SKU t2 on t1.CustomerID = t2.CustomerID and t1.SKU = t2.SKU ');
              SET r_SQL = CONCAT(r_SQL, '   where a.organizationId = t1.organizationId and a.warehouseId = t1.warehouseId and t1.locationid = a.LocationID and (t1.qty>0 or t1.qtyrpin >0 or t1.qtymvin >0 or t1.qtypa >0)');
              IF r_LocationStatus_Includes1 = '08'
                OR r_LocationStatus_Includes2 = '08'
                OR r_LocationStatus_Includes3 = '08'
                OR r_LocationStatus_Includes4 = '08' THEN
                SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group1 = ''', r_SKUGroup1, '''');
              END IF;
              IF r_LocationStatus_Includes1 = '09'
                OR r_LocationStatus_Includes2 = '09'
                OR r_LocationStatus_Includes3 = '09'
                OR r_LocationStatus_Includes4 = '09' THEN
                SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group2 = ''', r_SKUGroup2, '''');
              END IF;
              IF r_LocationStatus_Includes1 = '10'
                OR r_LocationStatus_Includes2 = '10'
                OR r_LocationStatus_Includes3 = '10'
                OR r_LocationStatus_Includes4 = '10' THEN
                SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group3 = ''', r_SKUGroup3, '''');
              END IF;
              IF r_LocationStatus_Includes1 = '11'
                OR r_LocationStatus_Includes2 = '11'
                OR r_LocationStatus_Includes3 = '11'
                OR r_LocationStatus_Includes4 = '11' THEN
                SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group4 = ''', r_SKUGroup4, '''');
              END IF;
              IF r_LocationStatus_Includes1 = '12'
                OR r_LocationStatus_Includes2 = '12'
                OR r_LocationStatus_Includes3 = '12'
                OR r_LocationStatus_Includes4 = '12' THEN
                SET r_SQL = CONCAT(r_SQL, ' and t2.SKU_Group5 = ''', r_SKUGroup5, '''');
              END IF;
              SET r_SQL = CONCAT(r_SQL, ')');
            END IF;


            IF IFNULL(r_LocationGroup1_Includes2, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup1 = ''', r_LocationGroup1_Includes2, '''');
            END IF;
            IF IFNULL(r_LocationGroup1_Excludes2, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup1 <> ''', r_LocationGroup1_Excludes2, '''');
            END IF;
            IF IFNULL(r_LocationGroup2_Includes2, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup2 = ''', r_LocationGroup2_Includes2, '''');
            END IF;
            IF IFNULL(r_LocationGroup2_Excludes2, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.LocGroup2 <> ''', r_LocationGroup2_Excludes2, '''');
            END IF;


            IF IFNULL(r_LocationDemand_Includes1, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.Demand = ''', r_LocationDemand_Includes1, '''');
            END IF;
            IF IFNULL(r_LocationDemand_Includes2, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.Demand = ''', r_LocationDemand_Includes2, '''');
            END IF;
            IF IFNULL(r_LocationDemand_Includes3, '') <> '' THEN
              SET r_SQL = CONCAT(r_SQL, ' and a.Demand = ''', r_LocationDemand_Includes3, '''');
            END IF;

            DELETE
              FROM TMP_EMPTY_LOC;
            SET @SQL = r_SQL;
            SET v_errormessage = @SQL;
            SET @organizationId = In_organizationId;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT USING @organizationId;
            DEALLOCATE PREPARE STMT;

            CALL SPASN_Putaway_LocationFilter(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_Weight, IN_Cubic, IN_Quantity,
            r_zoneId,
            r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
            r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
            r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5,
            r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5,
            r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4,
            r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4,
            r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4,
            r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4,
            r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4,
            r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4,
            r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3,
            r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3,
            r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
            r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
            r_MaxMixSKU, r_MaxMixLOT, OUT_Return_Code);

            SET v_error = 1;
            FETCH CUR_Locs INTO R_ToLocationID;
          whilefound3:
            WHILE v_error <> 0 DO
              IF R_FOUND <> 'N' THEN
                LEAVE whilefound3;
              END IF;
              CALL SPASN_Putaway_RestrictionCheck(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_PackID, r_ToLocationID, IN_Weight, IN_Cubic, IN_Quantity,
              r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
              r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
              r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5,
              r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5,
              r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4,
              r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4,
              r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4,
              r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4,
              r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4,
              r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4,
              r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3,
              r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3,
              r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
              r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
              r_MaxMixSKU, r_MaxMixLOT,
              r_FOUND);
              IF r_FOUND = 'Y' THEN
                SET out_ToLoc = r_ToLocationID;
              END IF;
              IF r_FOUND = 'T' THEN
                SET out_ToLoc = '******';
              END IF;
              SET v_error = 1;
              FETCH CUR_Locs INTO R_ToLocationID;
            END WHILE;
            CLOSE CUR_Locs;
          END IF;
        END IF;



        SET v_errormessage = '30';
        IF (r_PutawayRule = '30') THEN
          SELECT
            SKU_Group1,
            zoneId
          FROM BAS_SKU
          WHERE organizationId = In_organizationId
          AND CustomerID = IN_CustomerID
          AND SKU = IN_SKU INTO r_SKUGroup1, r_zoneId1;
          IF TRIM(r_SKUGroup1) IS NULL THEN
            SET r_SKUGroup1 = '*****';
          END IF;
          SET r_Locationseeds = NULL;
          IF r_SKUGroup1 <> '*****' THEN
            INSERT INTO TMP_BASE_LOC
              SELECT
                a.locationid
              FROM INV_LOT_LOC_ID a
                INNER JOIN BAS_SKU b
                  ON a.organizationId = b.organizationId
                  AND a.CustomerID = b.CustomerID
                  AND a.SKU = b.SKU
                INNER JOIN BAS_LOCATION c
                  ON a.organizationId = c.organizationId
                  AND a.locationid = c.locationid
              WHERE a.organizationId = In_organizationId
              AND b.SKU_Group1 = r_SKUGroup1
              AND c.LocationAttribute NOT IN ('HD', 'FI')
              AND (a.qty > 0
              OR a.qtyrpin > 0
              OR a.qtymvin > 0
              OR a.qtypa > 0)
              AND c.zoneId = CASE WHEN r_zoneId IS NULL THEN c.zoneId ELSE r_zoneId END;
          ELSE
            INSERT INTO TMP_BASE_LOC
              SELECT
                a.locationid
              FROM INV_LOT_LOC_ID a
                INNER JOIN BAS_LOCATION c
                  ON a.locationid = c.locationid
                  AND a.oragnizationId = c.organizationId
                  AND a.warehouseId = c.warehouseId
              WHERE a.oragnizationId = In_oragnizationId
              AND a.CustomerID = IN_CustomerID
              AND a.SKU = IN_SKU
              AND c.LocationAttribute NOT IN ('HD', 'FI')
              AND (a.qty > 0
              OR a.qtyrpin > 0
              OR a.qtymvin > 0
              OR a.qtypa > 0)
              AND c.zoneId = CASE WHEN r_zoneId IS NULL THEN c.zoneId ELSE r_zoneId END;
          END IF;
          IF IFNULL(TRIM(r_zoneId), '') = '' THEN
            IF IFNULL(r_zoneId1, '') <> '' THEN
              SET r_zoneId = r_zoneId1;
            END IF;
          END IF;
          DELETE
            FROM TMP_EMPTY_LOC;
          IF IFNULL(r_zoneId, '') <> '' THEN
            INSERT INTO TMP_EMPTY_LOC (LOCATIONID, pickLogicalSequence, PLCOUNT, CSCOUNT, CUBICCAPACITY, WEIGHTCAPACITY, eaCount, SEQUENCENO)
              SELECT
                a.locationId,
                a.pickLogicalSequence,
                a.plCount,
                a.csCount,
                a.cubicCapacity,
                a.weightCapacity,
                a.eaCount,
                @N := @N + 1 sequenceNo
              FROM BAS_LOCATION a,
                   (SELECT
                       @N := 0) b
              WHERE a.zoneId = r_zoneId
              AND a.LocationAttribute NOT IN ('HD', 'FI')
              AND a.organizationId = In_organizationId
              ORDER BY a.organizationId, a.warehouseId, a.pickLogicalSequence;

          ELSE
            INSERT INTO TMP_EMPTY_LOC (LOCATIONID, pickLogicalSequence, PLCOUNT, CSCOUNT, CUBICCAPACITY, WEIGHTCAPACITY, eaCount, SEQUENCENO)
              SELECT
                a.locationId,
                a.pickLogicalSequence,
                a.plCount,
                a.csCount,
                a.cubicCapacity,
                a.weightCapacity,
                a.eaCount,
                @N := @N + 1 sequenceNo
              FROM BAS_LOCATION a,
                   (SELECT
                       @N := 0) b
              WHERE a.zoneId IN (SELECT
                  zoneId
                FROM BAS_SKU_zoneId
                WHERE CustomerID = IN_CustomerID
                AND SKU = IN_SKU
                AND organizationId = In_organizationId)
              AND a.LocationAttribute NOT IN ('HD', 'FI')
              AND a.organizationId = In_organizationId
              ORDER BY a.organizationId, a.warehouseId, a.pickLogicalSequence;
          END IF;

          CALL SPASN_Putaway_LocationFilter(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_Weight, IN_Cubic, IN_Quantity,
          NULL,
          r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
          r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
          r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5,
          r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5,
          r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4,
          r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4,
          r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4,
          r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4,
          r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4,
          r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4,
          r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3,
          r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3,
          r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
          r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
          r_MaxMixSKU, r_MaxMixLOT, OUT_Return_Code);

          OPEN cCUR_Locs;
          SET v_error = 1;
          FETCH cCur_Locs INTO r_ToLocationID;
        whileloop4:
          WHILE v_error <> 0 DO
            SET v_errormessage = 'Fetch cCur_Locs';
            IF r_FOUND <> 'N' THEN
              LEAVE whileloop4;
            END IF;
            CALL SPASN_Putaway_RestrictionCheck(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_PackID, r_ToLocationID, IN_Weight, IN_Cubic, IN_Quantity,
            r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
            r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
            r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5,
            r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5,
            r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4,
            r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4,
            r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4,
            r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4,
            r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4,
            r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4,
            r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3,
            r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3,
            r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
            r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
            r_MaxMixSKU, r_MaxMixLOT,
            r_FOUND);
            IF r_FOUND = 'Y' THEN
              SET out_ToLoc = r_ToLocationID;
            END IF;
            IF r_FOUND = 'T' THEN
              SET out_ToLoc = '******';
            END IF;
            SET v_error = 1;
            FETCH cCur_Locs INTO r_ToLocationID;
          END WHILE;
          CLOSE cCUR_locs;
        END IF;


        IF r_PutawayRule = '32' THEN

          SELECT
            plantolocation
          FROM TSK_TASKLISTS
          WHERE tasktype = 'PA'
          AND sku = IN_SKU
          AND taskprocess = '99'
          AND customerid = IN_CustomerID
          AND warehouseid = IN_Warehouse
          AND organizationId = In_organizationId
          ORDER BY CloseTime DESC
          LIMIT 1 INTO r_ToLocationID;
          CALL SPASN_Putaway_RestrictionCheck(In_organizationId, IN_Warehouse, IN_CustomerID, IN_SKU, IN_LotNum, IN_PackID, r_ToLocationID, IN_Weight, IN_Cubic, IN_Quantity,
          r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5,
          r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4,
          '', '', '', '', '', '', '', '', '', '',
          '', '', '', '', '', '', '', '',
          '', '', '', '', '', '', '', '',
          '', '', '', '', '', '', '', '',
          '', '', '', '', '', '',
          r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2,
          r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2,
          r_MaxMixSKU, r_MaxMixLOT,
          r_FOUND);
          IF r_FOUND = 'Y' THEN
            SET OUT_ToLoc = r_ToLocationID;
          END IF;
          IF r_FOUND = 'T' THEN
            SET OUT_ToLoc = '******';
          END IF;
        END IF;



        SET v_errormessage = 'Loop1';
      END;


      IF r_Found = 'Y'
        AND (IFNULL(r_NextStepWhenFound, '') <> ''
        AND r_NextStepWhenFound <> 0) THEN
        SET r_NextStepWhenFound_A = r_NextStepWhenFound;
      while1:
        WHILE r_LineNumber <> r_NextStepWhenFound_A DO
          SET v_error = 1;
          FETCH cCur_Rules
          INTO r_PutawayRule, r_zoneId, r_FMLocationID, r_ToLocationID
          , r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5
          , r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4
          , r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5
          , r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5
          , r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4
          , r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4
          , r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4
          , r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4
          , r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4
          , r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4
          , r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3
          , r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3
          , r_LotAtt01, r_LotAtt02, r_LotAtt03, r_LotAtt04, r_LotAtt05, r_LotAtt06, r_LotAtt07, r_LotAtt08, r_LotAtt09, r_LotAtt10, r_LotAtt11, r_LotAtt12
          , r_ReceiptType_Includes1, r_ReceiptType_Includes2, r_ReceiptType_Includes3, r_ReceiptType_Includes4
          , r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2
          , r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2
          , r_MaxMixSKU, r_MaxMixLot, r_SKUABC_Includes1, r_PackUOM, r_WarehouseID
          , r_MaxLocationCount, r_NextStepWhenFound, r_NextStepWhenFail, r_LineNumber, r_ASNLineFilter;
          IF v_error = 0 THEN
            LEAVE while1;
          END IF;
          SET r_Found = 'N';
        END WHILE;
      ELSEIF r_Found = 'N'
        AND (IFNULL(r_NextStepWhenFail, '') <> ''
        AND r_NextStepWhenFail <> 0) THEN
        SET r_NextStepWhenFail_A = r_NextStepWhenFail;
      while2:
        WHILE r_LineNumber <> r_NextStepWhenFail_A DO
          SET v_error = 1;
          FETCH cCur_Rules
          INTO r_PutawayRule, r_zoneId, r_FMLocationID, r_ToLocationID
          , r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5
          , r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4
          , r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5
          , r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5
          , r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4
          , r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4
          , r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4
          , r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4
          , r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4
          , r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4
          , r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3
          , r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3
          , r_LotAtt01, r_LotAtt02, r_LotAtt03, r_LotAtt04, r_LotAtt05, r_LotAtt06, r_LotAtt07, r_LotAtt08, r_LotAtt09, r_LotAtt10, r_LotAtt11, r_LotAtt12
          , r_ReceiptType_Includes1, r_ReceiptType_Includes2, r_ReceiptType_Includes3, r_ReceiptType_Includes4
          , r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2
          , r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2
          , r_MaxMixSKU, r_MaxMixLot, r_SKUABC_Includes1, r_PackUOM, r_WarehouseID
          , r_MaxLocationCount, r_NextStepWhenFound, r_NextStepWhenFail, r_LineNumber, r_ASNLineFilter;
          IF v_error = 0 THEN
            LEAVE while2;
          END IF;
          SET r_Found = 'N';
        END WHILE;
      ELSE
        SET v_error = 1;
        FETCH cCur_Rules
        INTO r_PutawayRule, r_zoneId, r_FMLocationID, r_ToLocationID
        , r_Dimension_Restrictions1, r_Dimension_Restrictions2, r_Dimension_Restrictions3, r_Dimension_Restrictions4, r_Dimension_Restrictions5
        , r_LocationStatus_Includes1, r_LocationStatus_Includes2, r_LocationStatus_Includes3, r_LocationStatus_Includes4
        , r_LocationUsage_Includes1, r_LocationUsage_Includes2, r_LocationUsage_Includes3, r_LocationUsage_Includes4, r_LocationUsage_Includes5
        , r_LocationUsage_Excludes1, r_LocationUsage_Excludes2, r_LocationUsage_Excludes3, r_LocationUsage_Excludes4, r_LocationUsage_Excludes5
        , r_LocationCategory_Includes1, r_LocationCategory_Includes2, r_LocationCategory_Includes3, r_LocationCategory_Includes4
        , r_LocationCategory_Excludes1, r_LocationCategory_Excludes2, r_LocationCategory_Excludes3, r_LocationCategory_Excludes4
        , r_LocationAttribute_Includes1, r_LocationAttribute_Includes2, r_LocationAttribute_Includes3, r_LocationAttribute_Includes4
        , r_LocationAttribute_Excludes1, r_LocationAttribute_Excludes2, r_LocationAttribute_Excludes3, r_LocationAttribute_Excludes4
        , r_LocationHandling_Includes1, r_LocationHandling_Includes2, r_LocationHandling_Includes3, r_LocationHandling_Includes4
        , r_LocationHandling_Excludes1, r_LocationHandling_Excludes2, r_LocationHandling_Excludes3, r_LocationHandling_Excludes4
        , r_LocationDemand_Includes1, r_LocationDemand_Includes2, r_LocationDemand_Includes3
        , r_LocationDemand_Excludes1, r_LocationDemand_Excludes2, r_LocationDemand_Excludes3
        , r_LotAtt01, r_LotAtt02, r_LotAtt03, r_LotAtt04, r_LotAtt05, r_LotAtt06, r_LotAtt07, r_LotAtt08, r_LotAtt09, r_LotAtt10, r_LotAtt11, r_LotAtt12
        , r_ReceiptType_Includes1, r_ReceiptType_Includes2, r_ReceiptType_Includes3, r_ReceiptType_Includes4
        , r_LocationGroup1_Includes1, r_LocationGroup1_Includes2, r_LocationGroup2_Includes1, r_LocationGroup2_Includes2
        , r_LocationGroup1_Excludes1, r_LocationGroup1_Excludes2, r_LocationGroup2_Excludes1, r_LocationGroup2_Excludes2
        , r_MaxMixSKU, r_MaxMixLot, r_SKUABC_Includes1, r_PackUOM, r_WarehouseID
        , r_MaxLocationCount, r_NextStepWhenFound, r_NextStepWhenFail, r_LineNumber, r_ASNLineFilter;
        IF v_error = 0 THEN
          LEAVE while0;
        END IF;
      END IF;
    END WHILE;
    CLOSE cCUR_Rules;


    IF TRIM(OUT_ToLoc) IS NULL THEN
      SET OUT_Return_Code = '000';
      SET OUT_ToLoc = 'NO-LOC';
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `OJV_CML_SPCOM_SENDBACK_PROCESS`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPCOM_SENDBACK_PROCESS (IN `IN_organizationId` varchar(20),
IN `IN_warehouseId` varchar(20),
IN `IN_DocNo` varchar(40),
IN `IN_fmdb` varchar(40),
IN `IN_todb` varchar(40),
IN `IN_archiveCatagery` varchar(40),
IN `IN_userId` varchar(35),
INOUT `OUT_returnCode` varchar(1000))
ENDPROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(3000);
    DECLARE v_tableName varchar(30);
    DECLARE v_codeId varchar(30);
    DECLARE v_joinFeild varchar(30);
    DECLARE v_columnName varchar(30);
    DECLARE v_wheresql varchar(1000);
    DECLARE v_selectCols varchar(3000);
    DECLARE v_logSeqNo varchar(30);


    DECLARE cur_tab_cols CURSOR FOR
    SELECT
      columnName
    FROM TMP_ARCHIVE_DIC_COLUMN
    WHERE UPPER(tableName) = v_tableName
    ORDER BY ordinal_position;

    DECLARE cur_tab_rule CURSOR FOR
    SELECT
      a.tableName,
      a.joinFeild
    FROM RUL_ARCHIVE_TABLE_INFO a
      INNER JOIN (SELECT
          UPPER(tableName) tableName
        FROM TMP_ARCHIVE_DIC_COLUMN
        GROUP BY UPPER(tableName)) b
        ON a.tableName = b.tableName
    WHERE a.archiveCatagery = IN_archiveCatagery
    AND a.codeId = v_codeId
    ORDER BY a.seqNo, a.tableName;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPCOM_SENDBACK_PROCESS,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
      SELECT
        @SQL;
    END;
    SET v_errormessage = 'Begin call sp FLUX_SPCOM_SENDBACK_PROCESS.';
    SET v_error = 1;
    IF IN_archiveCatagery = 'INBOUND' THEN
      SET v_codeId = 'ASNNO';
      SET v_tableName = 'DOC_ASN_HEADER';
    ELSEIF IN_archiveCatagery = 'OUTBOUND' THEN
      SET v_codeId = 'ORDERNO';
      SET v_tableName = 'DOC_ORDER_HEADER';
    ELSE
      SET OUT_returnCode = '351502';
      LEAVE ENDPROC;
    END IF;

    SET v_errormessage = '???????????????.';
    SET v_wheresql = CONCAT(' where 1 = 1 and organizationId = ''', IN_organizationId, ''' AND warehouseId = ''', IN_warehouseId, ''' ');
    SET @SQL = CONCAT('SELECT COUNT(1) INTO @nrow FROM ', In_fmdb, '.', v_tableName, ' ', v_wheresql, ' and ', v_codeId, ' = ''', IN_DocNo, ''' ');
    PREPARE STMT FROM @SQL;
    EXECUTE STMT;
    DEALLOCATE PREPARE STMT;
    IF @nrow > 0 THEN
      SET OUT_returnCode = CONCAT('999#??', IN_DocNo, '??????.');
      LEAVE ENDPROC;
    END IF;

    SET @SQL = CONCAT('SELECT COUNT(1) INTO @nrow FROM ', In_todb, '.', v_tableName, ' ', v_wheresql, ' and ', v_codeId, ' = ''', IN_DocNo, ''' ');
    PREPARE STMT FROM @SQL;
    EXECUTE STMT;
    DEALLOCATE PREPARE STMT;
    IF @nrow = 0 THEN
      SET OUT_returnCode = CONCAT('999#??', IN_DocNo, '?????.');
      LEAVE ENDPROC;
    END IF;


    SET v_errormessage = '?????????????.';
    DELETE
      FROM TMP_ARCHIVE_DIC_COLUMN;
    INSERT INTO TMP_ARCHIVE_DIC_COLUMN (tableName, columnName, columnType, ordinal_position, primaryKey)
      SELECT
        a.TABLE_NAME,
        b.COLUMN_NAME,
        b.COLUMN_TYPE,
        b.ORDINAL_POSITION,
        CASE WHEN b.COLUMN_KEY = 'PRI' THEN 'Y' ELSE 'N' END
      FROM information_schema.TABLES a
        INNER JOIN information_schema.COLUMNS b
          ON a.TABLE_SCHEMA = b.TABLE_SCHEMA
          AND a.TABLE_NAME = b.TABLE_NAME
        INNER JOIN RUL_ARCHIVE_TABLE_INFO c
          ON UPPER(a.TABLE_NAME) = c.tableName
          AND c.archiveCatagery = IN_archiveCatagery
          AND c.codeId = v_codeId
      WHERE a.TABLE_SCHEMA = IN_fmdb
      AND a.TABLE_TYPE = 'BASE TABLE'
      AND c.activeFlag IN ('C', 'Y')
      GROUP BY b.TABLE_NAME,
               b.COLUMN_NAME,
               b.COLUMN_TYPE,
               b.ORDINAL_POSITION,
               b.COLUMN_KEY;

    SELECT
      COUNT(1),
      GROUP_CONCAT(CONCAT(tableName, ':', cols)) INTO v_nrow, v_errormessage
    FROM (SELECT
        tableName,
        GROUP_CONCAT(columnName) cols
      FROM TMP_ARCHIVE_DIC_COLUMN a
        LEFT JOIN information_schema.COLUMNS b
          ON a.tableName = b.TABLE_NAME
          AND a.columnName = b.COLUMN_NAME
          AND b.TABLE_SCHEMA = IN_todb
      WHERE b.TABLE_NAME IS NULL
      GROUP BY a.tableName) tt;
    IF v_nrow > 0 THEN
      SET OUT_returnCode = CONCAT('999#', v_errormessage);
      LEAVE ENDPROC;
    END IF;


    DELETE
      FROM TMP_ARCHIVE_DIC_COLUMN
    WHERE tableName = 'DOC_ORDER_HEADER'
      AND UPPER(columnName) = 'REF1';


    SET v_errormessage = '???????.';
    OPEN cur_tab_rule;
    SET v_error = 1;
    FETCH cur_tab_rule INTO v_tableName, v_joinFeild;
  ENDTAB:
    WHILE v_error <> 0 DO


      SET v_errormessage = '??????.';
      SET v_selectCols = '';
      OPEN cur_tab_cols;
      SET v_error = 1;
      FETCH cur_tab_cols INTO v_columnName;
      WHILE v_error <> 0 DO
        SET v_selectCols = CONCAT(v_selectCols, ',`', v_columnName, '`');
        SET v_error = 1;
        FETCH cur_tab_cols INTO v_columnName;
      END WHILE;
      CLOSE cur_tab_cols;
      SET v_selectCols = SUBSTRING(v_selectCols, 2, 3000);


      SET v_errormessage = CONCAT('???', IN_fmdb, '.', v_tableName, '??.');
      SET @SQL = CONCAT('insert into ', IN_fmdb, '.', v_tableName, '
     (', v_selectCols, ')
     select a.', REPLACE(v_selectCols, ',', ',a.'), '
       from ', IN_todb, '.', v_tableName, ' a 
     ', v_wheresql, ' and ', v_joinFeild, ' = ''', IN_DocNo, ''' 
    ');
      IF In_UserId = 'DEBUG'
        OR In_UserId = 'DEBUG1' THEN
        INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
          VALUES (IN_organizationId, IN_warehouseId, IN_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
      END IF;
      PREPARE STMT FROM @SQL;
      EXECUTE STMT;
      SET v_nrow = ROW_COUNT();
      DEALLOCATE PREPARE STMT;
      IF In_UserId = 'DEBUG'
        OR In_UserId = 'DEBUG1' THEN
        SELECT
          MAX(seqNo) INTO v_logSeqNo
        FROM TMP_ARCHIVE_DEBUG_LOG;
        UPDATE TMP_ARCHIVE_DEBUG_LOG
        SET nrow = v_nrow
        WHERE seqNo = v_logSeqNo;
      END IF;

      SET v_errormessage = CONCAT('???', IN_todb, '.', v_tableName, '??.');
      SET @SQL = CONCAT('delete from ', IN_todb, '.', v_tableName, v_wheresql, ' and ', v_joinFeild, ' = ''', IN_DocNo, ''' ');
      IF In_UserId = 'DEBUG'
        OR In_UserId = 'DEBUG1' THEN
        INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
          VALUES (IN_organizationId, IN_warehouseId, IN_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
      END IF;
      PREPARE STMT FROM @SQL;
      EXECUTE STMT;
      SET v_nrow = ROW_COUNT();
      DEALLOCATE PREPARE STMT;
      IF In_UserId = 'DEBUG'
        OR In_UserId = 'DEBUG1' THEN
        SELECT
          MAX(seqNo) INTO v_logSeqNo
        FROM TMP_ARCHIVE_DEBUG_LOG;
        UPDATE TMP_ARCHIVE_DEBUG_LOG
        SET nrow = v_nrow
        WHERE seqNo = v_logSeqNo;
      END IF;

      SET v_error = 1;
      FETCH cur_tab_rule INTO v_tableName, v_joinFeild;
    END WHILE;
    CLOSE cur_tab_rule;

    SET v_errormessage = 'End call sp FLUX_SPCOM_SENDBACK_PROCESS.';
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `OJV_CML_SPCOM_SENDBACK`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPCOM_SENDBACK (IN `IN_organizationId` varchar(20),
IN `IN_warehouseId` varchar(20),
IN `IN_DocNoType` varchar(20),
IN `IN_DocNo` varchar(40),
IN `IN_language` varchar(20),
IN `IN_userId` varchar(40),
INOUT `OUT_returnCode` varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_fmdb varchar(20);
    DECLARE v_todb varchar(20);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPCOM_SENDBACK,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));

      SELECT
        v_errormessage AS error;

    END;
    SET v_error = 1;
    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF IN_DocNoType NOT IN ('ASN', 'SO') THEN
      SET OUT_returnCode = '351501';
      LEAVE END_PROC;
    END IF;
    SET v_errormessage = '0.Begin call sp FLUX_SPCOM_SENDBACK.';

    IF In_UserId = 'DEBUG' THEN

      CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_DEBUG_LOG (
        organizationId varchar(20) NOT NULL,
        warehouseId varchar(20) NOT NULL,
        seqNo int NOT NULL AUTO_INCREMENT,
        archiveCatagery varchar(20),
        fmDb varchar(30),
        toDb varchar(30),
        sqlLog text,
        nrow int,
        logMessage text,
        addWho varchar(40),
        ADDTIME timestamp,
        PRIMARY KEY (seqNo),
        KEY (organizationId, warehouseId, archiveCatagery)
      );
    END IF;

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_DIC_COLUMN (
      tableName varchar(50),
      columnName varchar(50),
      columnType varchar(50),
      ordinal_position int,
      primaryKey char(1),
      KEY (tableName, columnName)
    );

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_CACHE_RECORD (
      codeId varchar(30),
      CODE varchar(50),
      warehouseId varchar(20),
      PRIMARY KEY (codeId, CODE, warehouseId)
    );
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_CACHE_RECORD1 (
      codeId varchar(30),
      CODE varchar(50),
      warehouseId varchar(20),
      PRIMARY KEY (codeId, CODE, warehouseId)
    );

    SET v_fmdb = 'fluxwms_archivedb';
    SET v_todb = 'wms_cml';

    IF IN_DocNoType = 'ASN' THEN
      SET v_archiveCatagery = 'INBOUND';
    ELSEIF IN_DocNoType = 'SO' THEN
      SET v_archiveCatagery = 'OUTBOUND';
    END IF;
    SET OUT_returnCode = '*_*';
    CALL OJV_CML_SPCOM_SENDBACK_PROCESS(IN_organizationId, IN_warehouseId, IN_DocNo,
    v_fmdb, v_todb, v_archiveCatagery
    , IN_userId, OUT_returnCode);
    IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
      LEAVE END_PROC;
    END IF;

    SET v_errormessage = 'n.End call sp FLUX_SPCOM_SENDBACK.';

    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `OJV_CML_SPCOM_Archive_ByCatagery`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPCOM_Archive_ByCatagery (IN `IN_organizationId` varchar(20),
IN `IN_warehouseId` varchar(20),
IN `IN_fmdb` varchar(40),
IN `IN_todb` varchar(40),
IN `IN_archiveByWave` varchar(10),
IN `In_standardCondition` varchar(1000),
IN `In_additionalCondition` varchar(1000),
IN `IN_ruleType` varchar(20),
IN `IN_dataDays` int,
IN `IN_batchQty` int,
IN `IN_archiveCatagery` varchar(40),
IN `IN_userId` varchar(40),
INOUT `OUT_returnCode` varchar(1000))
ENDPROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(3000);
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_tableName varchar(30);
    DECLARE v_columnName varchar(30);
    DECLARE v_tableDesc varchar(500);
    DECLARE v_groupFlag char(1);
    DECLARE v_codeId varchar(30);
    DECLARE v_groupCodeId varchar(30);
    DECLARE v_groupCodeId_01 varchar(30);
    DECLARE v_joinFeild varchar(30);
    DECLARE v_whereCondition varchar(500);
    DECLARE v_archiveMode varchar(10);
    DECLARE v_date datetime;
    DECLARE v_selectCols varchar(3000);
    DECLARE v_wheresql_01 varchar(3000);
    DECLARE v_wheresql varchar(3000);
    DECLARE v_primaryCols varchar(1000);
    DECLARE v_tableColumnType varchar(1000);
    DECLARE v_tempTabName varchar(1000);
    DECLARE v_innerJoin varchar(1000);
    DECLARE v_columnType varchar(20);
    DECLARE v_primaryKey varchar(2);
    DECLARE v_seqNo bigint;
    DECLARE v_flag int;
    DECLARE v_warehouseId varchar(20);
    DECLARE v_joinWarehouse varchar(50);
    DECLARE v_logSeqNo bigint;

    DECLARE cur_tab_cols CURSOR FOR
    SELECT
      columnName,
      columnType,
      primaryKey
    FROM TMP_ARCHIVE_DIC_COLUMN
    WHERE UPPER(tableName) = v_tableName
    ORDER BY ordinal_position;

    DECLARE cur_tab_rule CURSOR FOR
    SELECT
      a.seqNo,
      a.tableName,
      a.tableDesc,
      a.groupFlag,
      a.codeId,
      a.groupCodeId,
      a.joinFeild,
      a.whereCondition,
      a.archiveMode
    FROM RUL_ARCHIVE_TABLE_INFO a
      INNER JOIN (SELECT
          UPPER(tableName) tableName
        FROM TMP_ARCHIVE_DIC_COLUMN
        GROUP BY UPPER(tableName)) b
        ON a.tableName = b.tableName
    WHERE a.archiveCatagery = v_archiveCatagery
    AND a.activeFlag IN ('C', 'Y')
    ORDER BY a.seqNo, a.tableName;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#OJV_CML_SPCOM_Archive_ByCatagery,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        CONCAT('FLUX_SPCOM_Archive_ByCatagery:', v_errormessage) AS error;
      SELECT
        @SQL;
    END;
    SET v_errormessage = '0.Begin call sp OJV_CML_SPCOM_Archive_ByCatagery.';
    SET v_error = 1;
    SET v_tableName = '';
    IF IN_dataDays > 0
      AND UPPER(IN_ruleType) = 'TIMELY' THEN
      SET v_date = DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -IN_dataDays DAY), '%Y-%m-%d');
    ELSE
      SET v_date = NULL;
    END IF;
    SET v_errormessage = IN_archiveCatagery;
    SET v_archiveCatagery = IN_archiveCatagery;



    DELETE
      FROM TMP_ARCHIVE_DIC_COLUMN;
    INSERT INTO TMP_ARCHIVE_DIC_COLUMN (tableName, columnName, columnType, ordinal_position, primaryKey)
      SELECT
        a.TABLE_NAME,
        b.COLUMN_NAME,
        b.COLUMN_TYPE,
        b.ORDINAL_POSITION,
        CASE WHEN b.COLUMN_KEY = 'PRI' THEN 'Y' ELSE 'N' END
      FROM information_schema.TABLES a
        INNER JOIN information_schema.COLUMNS b
          ON a.TABLE_SCHEMA = b.TABLE_SCHEMA
          AND a.TABLE_NAME = b.TABLE_NAME
        INNER JOIN RUL_ARCHIVE_TABLE_INFO c
          ON UPPER(a.TABLE_NAME) = c.tableName
          AND c.archiveCatagery = v_archiveCatagery
      WHERE a.TABLE_SCHEMA = IN_fmdb
      AND a.TABLE_TYPE = 'BASE TABLE'
      AND c.activeFlag IN ('C', 'Y')
      GROUP BY b.TABLE_NAME,
               b.COLUMN_NAME,
               b.COLUMN_TYPE,
               b.ORDINAL_POSITION,
               b.COLUMN_KEY;

    SELECT
      COUNT(1),
      GROUP_CONCAT(CONCAT(tableName, ':', cols)) INTO v_nrow, v_errormessage
    FROM (SELECT
        tableName,
        GROUP_CONCAT(columnName) cols
      FROM TMP_ARCHIVE_DIC_COLUMN a
        LEFT JOIN information_schema.COLUMNS b
          ON a.tableName = b.TABLE_NAME
          AND a.columnName = b.COLUMN_NAME
          AND b.TABLE_SCHEMA = IN_todb
      WHERE b.TABLE_NAME IS NULL
      GROUP BY a.tableName) tt;
    IF v_nrow > 0 THEN
      SET OUT_returnCode = CONCAT('999#', v_errormessage);
      LEAVE ENDPROC;
    END IF;


    DELETE
      FROM TMP_ARCHIVE_DIC_COLUMN
    WHERE tableName = 'DOC_ORDER_HEADER'
      AND UPPER(columnName) = 'REF1';

    SET v_errormessage = '1.1';
    SET v_error = 1;
    SET v_wheresql = '';
    SET v_tableName = '';
    IF In_warehouseId = ''
      OR In_warehouseId IS NULL THEN
      SET v_warehouseId = '*';
    ELSE
      SET v_warehouseId = In_warehouseId;
    END IF;
    SET v_error = 1;
    SET v_flag = 1;

  LOOPFLAG:
    WHILE v_flag > 0 DO

      IF v_archiveCatagery <> 'BASE' THEN
        START TRANSACTION;
      END IF;

      SET v_flag = 0;
      OPEN cur_tab_rule;
      FETCH cur_tab_rule
      INTO v_seqNo, v_tableName, v_tableDesc
      , v_groupFlag, v_codeId, v_groupCodeId
      , v_joinFeild, v_whereCondition, v_archiveMode;
    ENDTAB:
      WHILE v_error <> 0 DO

        IF v_archiveCatagery = 'BASE' THEN
          START TRANSACTION;
        END IF;
        SET v_joinWarehouse = '';

        IF v_tableName LIKE 'SSM_%' THEN
          SET v_wheresql = CONCAT(' where 1 = 1 ');
        ELSE
          SET v_wheresql = CONCAT(' where 1 = 1 and a.organizationId = ''', IN_organizationId, '''');
          SELECT
            COUNT(1) INTO v_nrow
          FROM TMP_ARCHIVE_DIC_COLUMN
          WHERE tableName = v_tableName
          AND UPPER(columnName) = UPPER('warehouseId');
          IF v_nrow > 0
            AND v_warehouseId <> '*' THEN
            SET v_wheresql = CONCAT(v_wheresql, ' AND a.warehouseId = ''', v_warehouseId, ''' ');
          END IF;

          IF v_nrow > 0 THEN
            SET v_joinWarehouse = ' and a.warehouseId = b.warehouseId ';
          END IF;
        END IF;
        IF IFNULL(TRIM(v_whereCondition), '') <> '' THEN
          SET v_wheresql = CONCAT(v_wheresql, ' and ', v_whereCondition);
        END IF;
        IF In_UserId = 'DEBUG' THEN
          SET v_wheresql = CONCAT(v_wheresql, ' and 1 = 2 ');
        END IF;


        SET v_selectCols = '';
        SET v_primaryCols = '';
        SET v_tempTabName = '';
        SET v_innerJoin = '';
        SET v_tableColumnType = '';
        OPEN cur_tab_cols;
        SET v_error = 1;
        FETCH cur_tab_cols INTO v_columnName, v_columnType, v_primaryKey;
        WHILE v_error <> 0 DO
          IF v_primaryKey = 'Y' THEN
            SET v_primaryCols = CONCAT(v_primaryCols, v_columnName, ',');
            SET v_tableColumnType = CONCAT(v_tableColumnType, v_columnName, ' ', v_columnType, ' not null,');
            SET v_innerJoin = CONCAT(v_innerJoin, ' and a.', v_columnName, ' = b.', v_columnName);
          END IF;
          SET v_selectCols = CONCAT(v_selectCols, ',`', v_columnName, '`');
          SET v_error = 1;
          FETCH cur_tab_cols INTO v_columnName, v_columnType, v_primaryKey;
        END WHILE;
        CLOSE cur_tab_cols;
        SET v_selectCols = SUBSTRING(v_selectCols, 2, 3000);

        IF v_groupFlag = 'Y' THEN

          IF IFNULL(v_groupCodeId, '') <> IFNULL(v_groupCodeId_01, '') THEN
            SET v_groupCodeId_01 = v_groupCodeId;
          END IF;
          IF v_groupCodeId_01 = '' THEN
            SET v_groupCodeId_01 = NULL;
          END IF;
          IF v_codeId = '' THEN
            SET v_codeId = NULL;
          END IF;
          SET v_wheresql_01 = v_wheresql;
          IF v_groupCodeId_01 = v_codeId THEN

            IF v_date IS NOT NULL THEN
              SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.editTime < ''', v_date, ''' ');
            END IF;

            IF v_tableName IN
              ('DOC_PO_HEADER'
              , 'DOC_ASN_HEADER'
              , 'DOC_SALESORDER_HEADER'
              , 'DOC_ORDER_HEADER'
              , 'DOC_TRANSFER_HEADER'
              , 'DOC_MOVEMENT_HEADER'
              , 'DOC_ADJ_HEADER'
              , 'DOC_HOLD_HEADER'
              , 'DOC_KIT_HEADER')
              AND In_standardCondition = 'B' THEN
              SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.ediSendFlag = ''Y'' ');
            END IF;
            IF IN_archiveByWave = 'Y'
              AND v_tableName = 'DOC_ORDER_HEADER' THEN
              SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
              select ''ORDERNO'', tt.orderNo,tt.warehouseId
                from (
              select a.warehouseId,a.orderNo
                from DOC_ORDER_HEADER a
               inner join DOC_WAVE_HEADER b
                  on a.organizationId = b.organizationId
                 and a.warehouseId = b.warehouseId
                 and a.waveNo = b.waveNo
                 and b.WaveStatus = ''99'' 
            ', v_wheresql_01, '
             union all
              select a.warehouseId,a.orderNo
                from DOC_ORDER_HEADER a
                left join DOC_WAVE_HEADER b
                  on a.organizationId = b.organizationId
                 and a.warehouseId = b.warehouseId
                 and a.waveNo = b.waveNo 
            ', v_wheresql_01
              , ' and b.organizationId is null
                     ) tt
                 group by tt.warehouseId,tt.orderNo ');
            ELSE
              SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
              select ''', v_groupCodeId_01, ''',a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END, '
                from ', IN_fmdb, '.', v_tableName, ' a 
              ', v_wheresql_01, '
               group by a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END);
            END IF;

            IF IN_batchQty > 0 THEN
              SET @SQL = CONCAT(@SQL, ' limit 0,', IN_batchQty);
            END IF;

            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            SET v_flag = v_flag + v_nrow;
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;
          ELSEIF v_codeId IS NOT NULL THEN
            DELETE
              FROM TMP_ARCHIVE_CACHE_RECORD1;
            SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD1(codeId, code, warehouseId)
            select codeId,code, warehouseId
              from TMP_ARCHIVE_CACHE_RECORD
             where codeId = ''', v_codeId, ''' ');
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;

            SET @SQL = CONCAT(' delete from TMP_ARCHIVE_CACHE_RECORD
             where codeId = ''', v_groupCodeId_01, '''
          ');
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;

            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;

            SET @SQL = CONCAT('insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
           select ''', v_groupCodeId_01, ''', a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END, '
             from ', IN_fmdb, '.', v_tableName, ' a
            inner join TMP_ARCHIVE_CACHE_RECORD1 b
               on a.', v_joinFeild, ' = b.code', v_joinWarehouse, '
              and b.codeId = ''', v_codeId, '''
            group by a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END);
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            SET v_flag = v_flag + v_nrow;
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;
            SET v_codeId = v_groupCodeId_01;
            SET v_joinFeild = v_groupCodeId_01;
          ELSEIF v_codeId IS NULL THEN
            IF v_primaryCols <> '' THEN
              SET v_primaryCols = SUBSTRING(v_primaryCols, 1, LENGTH(v_primaryCols) - 1);

              SET v_tempTabName = CONCAT('TMP_', v_seqNo);
              SET @SQL = CONCAT(' create temporary table if not exists ', v_tempTabName, '
              (', v_tableColumnType, 'primary key(', v_primaryCols, '))
            ');
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              DEALLOCATE PREPARE STMT;


              SET @SQL = CONCAT('delete from ', v_tempTabName);
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              DEALLOCATE PREPARE STMT;

              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                SELECT
                  MAX(seqNo) INTO v_logSeqNo
                FROM TMP_ARCHIVE_DEBUG_LOG;
                UPDATE TMP_ARCHIVE_DEBUG_LOG
                SET nrow = v_nrow
                WHERE seqNo = v_logSeqNo;
              END IF;

              SET v_wheresql_01 = v_wheresql;

              IF v_date IS NOT NULL
                AND IFNULL(v_groupCodeId_01, '') <> '' THEN
                SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.', v_groupCodeId_01, ' < ''', v_date, ''' ');
              END IF;

              IF IN_batchQty > 0 THEN
                SET v_wheresql_01 = CONCAT(v_wheresql_01, ' limit 0,', IN_batchQty);
              END IF;

              SET @SQL = CONCAT(' insert into ', v_tempTabName, '
              (', v_primaryCols, ')
              select a.', REPLACE(v_primaryCols, ',', ',a.'), '
                from ', v_tableName, ' a ', v_wheresql_01);
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              SET v_flag = v_flag + v_nrow;
              DEALLOCATE PREPARE STMT;

              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                SELECT
                  MAX(seqNo) INTO v_logSeqNo
                FROM TMP_ARCHIVE_DEBUG_LOG;
                UPDATE TMP_ARCHIVE_DEBUG_LOG
                SET nrow = v_nrow
                WHERE seqNo = v_logSeqNo;
              END IF;
            END IF;
          END IF;
        END IF;

        IF v_archiveCatagery = 'BASE' THEN

          SET @SQL = CONCAT(' DELETE FROM ', IN_todb, '.', v_tableName, ' a ', v_wheresql);
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;

          SET @SQL = CONCAT('insert into ', IN_todb, '.', v_tableName, '
        (', v_selectCols, ')
        select a.', REPLACE(v_selectCols, ',', ',a.'), '
          from ', IN_fmdb, '.', v_tableName, ' a ', v_wheresql);
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;
        ELSE

          IF IFNULL(v_codeId, '') <> '' THEN
            SET v_innerJoin = CONCAT('
          inner join TMP_ARCHIVE_CACHE_RECORD b
               on a.', v_joinFeild, ' = b.code', v_joinWarehouse, '
              and b.codeId = ''', v_codeId, '''
          ');
          ELSEIF v_primaryCols <> ''
            AND v_groupFlag = 'Y' THEN
            SET v_innerJoin = SUBSTRING(v_innerJoin, 5, 1000);
            SET v_innerJoin = CONCAT(' 
          inner join ', v_tempTabName, ' b on ', v_innerJoin, ' ');
          END IF;

          SET @SQL = CONCAT(' insert into ', IN_todb, '.', v_tableName, '
          (', v_selectCols, ')
          select a.', REPLACE(v_selectCols, ',', ',a.'), '
            from ', IN_fmdb, '.', v_tableName, ' a '
          , v_innerJoin, ' ', v_wheresql);
          SELECT
            @SQL;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;

          SET @SQL = CONCAT(' delete a from ', IN_fmdb, '.', v_tableName, ' a ', v_innerJoin, ' ', v_wheresql);
          SELECT
            @SQL;
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;
        END IF;

        IF v_archiveCatagery = 'BASE' THEN
          COMMIT;
        END IF;

        SET v_error = 1;
        FETCH cur_tab_rule
        INTO v_seqNo, v_tableName, v_tableDesc
        , v_groupFlag, v_codeId, v_groupCodeId
        , v_joinFeild, v_whereCondition, v_archiveMode;
      END WHILE;
      CLOSE cur_tab_rule;
      IF v_archiveCatagery <> 'BASE' THEN
        COMMIT;
      END IF;
      IF v_archiveCatagery = 'BASE' THEN
        LEAVE LOOPFLAG;
      END IF;

    END WHILE;
    SET v_errormessage = 'n.End call sp OJV_CML_SPCOM_Archive_ByCatagery.';
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPSYS_GetListByString`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSYS_GetListByString (IN_String varchar(4000), IN_Substr varchar(3), IN_ListName varchar(30))
BEGIN

  CREATE TEMPORARY TABLE IF NOT EXISTS TMP_CODE (
    codeId varchar(30),
    `CODE` varchar(100),
    CODE1 varchar(100),
    CODE2 varchar(100),
    CODE3 varchar(100)
  );
  DELETE
    FROM TMP_CODE;
  SET @i = LENGTH(IN_String) - LENGTH(REPLACE(IN_String, IN_Substr, ''));
  SET @left_str = IN_String;
  WHILE @i > 0
  DO
    SET @sub_str = SUBSTR(@left_str, 1, INSTR(@left_str, IN_Substr) - 1);
    SET @left_str = SUBSTR(@left_str, LENGTH(@sub_str) + LENGTH(IN_Substr) + 1);
    SET @s = TRIM(@sub_str);
    INSERT INTO TMP_CODE (`CODE`, Code1, codeId)
      VALUES (@s, @s, IN_ListName);
    SET @i = @i - 1;
  END WHILE;

  SET @s = TRIM(@left_str);
  INSERT INTO TMP_CODE (`CODE`, Code1, codeId)
    VALUES (@s, @s, IN_ListName);
END
$$

--
-- Create procedure `FLUX_SPUDF_Process6`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPUDF_Process6 (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(20),
IN IN_DocNo varchar(3000),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
BEGIN
  CALL SPSYS_GetListByString(IN_DocNo, ',', 'DOCNO');
  UPDATE DOC_ORDER_HEADER A
  SET A.UDF01 = 'ZXXXXX12'
  WHERE A.organizationId = IN_organizationId
  AND A.warehouseId = IN_warehouseId
  AND EXISTS (SELECT
      1
    FROM TMP_CODE B
    WHERE A.ORDERNO = B.CODE
    AND B.CODEID = 'DOCNO');
  DELETE
    FROM TMP_CODE
  WHERE CODEID = 'DOCNO';
  SET OUT_returnCode := '000#??';
END
$$

--
-- Create procedure `FLUX_SPCOM_SENDBACK_PROCESS`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_SENDBACK_PROCESS (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_DocNo varchar(40),
IN IN_fmdb varchar(40),
IN IN_todb varchar(40),
IN IN_archiveCatagery varchar(40),
IN IN_userId varchar(35),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(3000);
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_tableName varchar(30);
    DECLARE v_column_name varchar(30);
    DECLARE v_tableDesc varchar(500);
    DECLARE v_groupFlag char(1);
    DECLARE v_codeId varchar(30);
    DECLARE v_groupCodeId varchar(30);
    DECLARE v_joinFeild varchar(30);
    DECLARE v_whereCondition varchar(500);
    DECLARE v_archiveMode varchar(10);
    DECLARE v_temp_tableName varchar(30);
    DECLARE v_temp_tableDesc varchar(500);
    DECLARE v_temp_groupFlag char(1);
    DECLARE v_temp_codeId varchar(30);
    DECLARE v_temp_groupCodeId varchar(30);
    DECLARE v_temp_joinFeild varchar(30);
    DECLARE v_temp_whereCondition varchar(500);
    DECLARE v_temp_archiveMode varchar(10);
    DECLARE v_temp_column_name varchar(30);
    DECLARE v_date datetime;
    DECLARE v_deletesql varchar(3000);
    DECLARE v_insertsql varchar(3000);
    DECLARE v_selectsql varchar(3000);
    DECLARE v_wheresql2 varchar(3000);
    DECLARE v_wheresql varchar(3000);
    DECLARE v_seqNo int;
    DECLARE v_ordinal_position int;

    DECLARE cur_tab_cols CURSOR FOR
    SELECT
      a.seqNo,
      a.tableName,
      a.tableDesc,
      a.groupFlag,
      a.codeId,
      a.groupCodeId,
      a.joinFeild,
      a.whereCondition,
      a.archiveMode,
      a.columnName
    FROM TMP_DIC_INFO a
    ORDER BY a.seqNo, a.tableName, a.ordinal_position;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPCOM_SENDBACK_PROCESS,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
      SELECT
        @SQL;
    END;
    SET v_errormessage = '0.Begin call sp FLUX_SPCOM_SENDBACK_PROCESS.';
    SET v_error = 1;
    SET v_tableName = '';
    SET v_temp_tableName = '';
    SET v_errormessage = IN_archiveCatagery;
    SET v_archiveCatagery = IN_archiveCatagery;
    IF v_archiveCatagery NOT IN ('INBOUND', 'OUTBOUND') THEN
      SET OUT_returnCode = '999#????????';
      LEAVE END_PROC;
    END IF;



    DELETE
      FROM TMP_DIC_INFO;
    INSERT INTO TMP_DIC_INFO (seqNo, tableName, tableDesc
    , groupFlag, codeId, groupCodeId
    , joinFeild, whereCondition, archiveMode
    , columnName, ordinal_position)
      SELECT
        c.seqNo,
        c.tableName,
        c.tableDesc,
        c.groupFlag,
        c.codeId,
        c.groupCodeId,
        c.joinFeild,
        c.whereCondition,
        c.archiveMode,
        b.COLUMN_NAME,
        b.ORDINAL_POSITION
      FROM information_schema.TABLES a
        INNER JOIN information_schema.COLUMNS b
          ON a.TABLE_SCHEMA = b.TABLE_SCHEMA
          AND a.TABLE_NAME = b.TABLE_NAME
        INNER JOIN RUL_ARCHIVE_TABLE_INFO c
          ON a.TABLE_NAME = c.tableName
          AND c.archiveCatagery = v_archiveCatagery
      WHERE a.TABLE_SCHEMA = IN_fmdb
      AND a.TABLE_TYPE = 'BASE TABLE'
      AND c.activeFlag = 'Y'
      AND c.codeId = CASE WHEN v_archiveCatagery = 'INBOUND' THEN 'ASNNO' ELSE 'ORDERNO' END
      AND (IFNULL(c.groupCodeId, '') = ''
      OR c.groupCodeId = c.codeId)
      ORDER BY c.seqNo;

    SET v_errormessage = '1.1';
    SET v_error = 1;
    SET v_insertsql = '';
    SET v_selectsql = '';
    SET v_tableName = '';
    SET v_temp_tableName = '';
    SET v_wheresql2 = CONCAT(' where 1 = 1 and organizationId = ''', IN_organizationId, ''' AND warehouseId = ''', IN_warehouseId, ''' ');
    IF v_archiveCatagery = 'INBOUND' THEN
      SET v_wheresql = CONCAT(v_wheresql2, ' and asnNo = ''', IN_DocNo, ''' ');
    ELSE
      SET v_wheresql = CONCAT(v_wheresql2, ' and orderNo = ''', IN_DocNo, ''' ');
    END IF;

    SET @nrow = 0;
    IF v_archiveCatagery = 'INBOUND' THEN
      SET @SQL = CONCAT('SELECT COUNT(1) FROM ', In_fmdb, '.DOC_ASN_HEADER', v_wheresql, ' INTO @nrow ');
    ELSE
      SET @SQL = CONCAT('SELECT COUNT(1) FROM ', In_fmdb, '.DOC_ORDER_HEADER', v_wheresql, ' INTO @nrow  ');
    END IF;
    PREPARE STMT FROM @SQL;
    EXECUTE STMT;
    DEALLOCATE PREPARE STMT;
    IF @nrow = 0 THEN
      SELECT
        @SQL;
      SET OUT_returnCode = '999#???????';
      LEAVE END_PROC;
    END IF;
    SET v_error = 1;
    OPEN cur_tab_cols;
    FETCH cur_tab_cols
    INTO v_seqNo, v_tableName, v_tableDesc
    , v_groupFlag, v_codeId, v_groupCodeId
    , v_joinFeild, v_whereCondition, v_archiveMode
    , v_column_name;
  ENDWHILE:
    WHILE v_error <> 0 DO

      IF v_tableName <> v_temp_tableName THEN
        IF v_temp_tableName <> '' THEN

          SET v_wheresql = CONCAT(v_wheresql2, ' and ', v_temp_joinFeild, ' = ''', IN_DocNo, ''' ');
          SET @SQL = CONCAT(v_insertsql, v_selectsql, ') select ', v_selectsql, ' from ', IN_fmdb, '.', v_temp_tableName, ' ', v_wheresql, ' ');
          IF In_UserId = 'DEBUG' THEN
            SELECT
              1;
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF v_nrow > 0 THEN
            SET @SQL = CONCAT('delete from ', IN_fmdb, '.', v_temp_tableName, ' ', v_wheresql, ' ');
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG' THEN
              SELECT
                1;
            END IF;
          END IF;
        END IF;
        SET v_selectsql = v_column_name;
        SET v_insertsql = CONCAT('INSERT INTO ', IN_todb, '.', v_tableName, '(');
      ELSE
        SET v_selectsql = CONCAT(v_selectsql, ',', v_column_name);
      END IF;

      SET v_temp_tableName = v_tableName;
      SET v_temp_tableDesc = v_tableDesc;
      SET v_temp_groupFlag = v_groupFlag;
      SET v_temp_codeId = v_codeId;
      SET v_temp_groupCodeId = v_groupCodeId;
      SET v_temp_joinFeild = v_joinFeild;
      SET v_temp_whereCondition = v_whereCondition;
      SET v_temp_archiveMode = v_archiveMode;
      SET v_temp_column_name = v_column_name;

      SET v_error = 1;
      FETCH cur_tab_cols
      INTO v_seqNo, v_tableName, v_tableDesc
      , v_groupFlag, v_codeId, v_groupCodeId
      , v_joinFeild, v_whereCondition, v_archiveMode
      , v_column_name;
    END WHILE;
    CLOSE cur_tab_cols;

    IF v_tableName <> '' THEN

      SET v_wheresql = CONCAT(v_wheresql2, ' and ', v_joinFeild, ' = ''', IN_DocNo, ''' ');
      SET @SQL = CONCAT(v_insertsql, v_selectsql, ') select ', v_selectsql, ' from ', IN_fmdb, '.', v_temp_tableName, ' ', v_wheresql, ' ');
      PREPARE STMT FROM @SQL;
      EXECUTE STMT;
      SET v_nrow = ROW_COUNT();
      DEALLOCATE PREPARE STMT;
      IF In_UserId = 'DEBUG' THEN
        SELECT
          1;
      END IF;

      IF v_nrow > 0 THEN
        SET @SQL = CONCAT('delete from ', IN_fmdb, '.', v_temp_tableName, ' ', v_wheresql, ' ');
        PREPARE STMT FROM @SQL;
        EXECUTE STMT;
        SET v_nrow = ROW_COUNT();
        DEALLOCATE PREPARE STMT;
        IF In_UserId = 'DEBUG' THEN
          SELECT
            1;
        END IF;
      END IF;
    END IF;
    SET v_errormessage = 'n.End call sp FLUX_SPCOM_SENDBACK_PROCESS.';
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `FLUX_SPCOM_SENDBACK`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_SENDBACK (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_DocNoType varchar(20),
IN IN_DocNo varchar(40),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_fmdb varchar(20);
    DECLARE v_todb varchar(20);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPCOM_SENDBACK,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));

      SELECT
        v_errormessage AS error;

    END;
    SET v_error = 1;
    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF IN_DocNoType NOT IN ('ASN', 'SO') THEN
      SET OUT_returnCode = '999#???????ASN?SO';
      LEAVE END_PROC;
    END IF;
    SET v_errormessage = '0.Begin call sp FLUX_SPCOM_SENDBACK.';

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_DIC_INFO (
      seqNo int,
      tableName varchar(30),
      tableDesc varchar(500),
      groupFlag char(1),
      codeId varchar(30),
      groupCodeId varchar(30),
      joinFeild varchar(30),
      whereCondition varchar(500),
      archiveMode varchar(10),
      columnName varchar(30),
      ordinal_position int,
      KEY (tableName, columnName)
    );

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_CODE (
      codeId varchar(30),
      CODE varchar(50)
    );
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_CODE1 (
      codeId varchar(30),
      CODE varchar(50)
    );

    SET v_fmdb = 'FLUXwms_hisdb';
    SET v_todb = 'wms_cml';
    IF IN_DocNoType = 'ASN' THEN
      SET v_archiveCatagery = 'INBOUND';
    ELSEIF IN_DocNoType = 'SO' THEN
      SET v_archiveCatagery = 'OUTBOUND';
    END IF;
    CALL FLUX_SPCOM_SENDBACK_PROCESS(IN_organizationId, IN_warehouseId, IN_DocNo,
    v_fmdb, v_todb, v_archiveCatagery
    , IN_userId,
    OUT_returnCode);
    IF SUBSTRING(OUT_returnCode, '000') <> '000' THEN
      LEAVE END_PROC;
    END IF;

    SET v_errormessage = 'n.End call sp FLUX_SPCOM_SENDBACK.';

    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_SPCOM_MAINT_PARTITIONS`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_MAINT_PARTITIONS (IN_SCHEMANAME varchar(64)
, IN_TABLENAME varchar(64)
, IN_NEXTMONTH int
, IN_Days int)
ENDPROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_max_pname varchar(30);
    DECLARE v_this_month date;
    DECLARE v_next_month date;
    DECLARE v_stmt varchar(1000);
    DECLARE v_day date;
    DECLARE v_pvalue int;
    DECLARE v_pname varchar(30);
    DECLARE v_flag int;


    DECLARE c_partitions CURSOR FOR
    SELECT
      CONCAT('ALTER TABLE '
      , table_schema
      , '.'
      , table_name
      , ' DROP PARTITION '
      , PARTITION_NAME) STMT
    FROM information_schema.partitions
    WHERE table_schema = IN_SCHEMANAME
    AND table_name = IN_TABLENAME
    AND PARTITION_NAME < v_pname
    ORDER BY PARTITION_NAME;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;

      SELECT
        CONCAT('999#', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;

      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;

    SELECT
      COUNT(1)
    FROM information_schema.TABLES a
    WHERE UPPER(a.TABLE_NAME) = IN_TABLENAME
    AND a.TABLE_SCHEMA = IN_SCHEMANAME
    AND a.TABLE_TYPE = 'BASE TABLE' INTO v_nrow;
    IF v_nrow = 0 THEN
      LEAVE ENDPROC;
    END IF;

    IF IN_NEXTMONTH IN (0, 1) THEN
      SET v_this_month = DATE_FORMAT(DATE_ADD(CURDATE() - DAY(CURDATE()) + 1, INTERVAL IN_NEXTMONTH MONTH), '%Y-%m-%d');
      SET v_next_month = DATE_ADD(v_this_month, INTERVAL 1 MONTH);
      SET v_day = v_this_month;

      SET v_flag = 0;
      SELECT
        COUNT(PARTITION_NAME)
      FROM information_schema.partitions
      WHERE table_schema = IN_SCHEMANAME
      AND table_name = IN_TABLENAME INTO v_flag;

    ENDLOOP1:
      WHILE v_day < v_next_month DO
        SET v_pname = CONCAT('p', DATE_FORMAT(v_day, '%Y%m%d'));
        SET v_pvalue = TO_DAYS(v_day) + 1;
        SET @SQL = '';


        IF v_flag = 0 THEN
          SET v_day = DATE_FORMAT(NOW(), '%Y-%m-%d');
          SET v_pname = CONCAT('p', DATE_FORMAT(v_day, '%Y%m%d'));
          SET v_pvalue = TO_DAYS(v_day) + 1;

          SET @SQL = CONCAT('alter table ', IN_SCHEMANAME, '.', IN_TABLENAME
          , ' PARTITION by range (TO_DAYS(addTime)) (partition '
          , v_pname
          , ' values less than (', v_pvalue, '))');
          SET v_flag = 1;
        END IF;


        IF @SQL = '' THEN
          SELECT
            COUNT(1)
          FROM information_schema.partitions
          WHERE table_schema = IN_SCHEMANAME
          AND table_name = IN_TABLENAME
          AND partition_name = v_pname INTO v_nrow;
          IF v_nrow > 0 THEN
            LEAVE ENDLOOP1;
          END IF;
          SET @SQL = CONCAT('alter table ', IN_SCHEMANAME, '.', IN_TABLENAME
          , ' add partition (partition '
          , v_pname
          , ' values less than (', v_pvalue, '))');
        END IF;
        SET v_errormessage = @SQL;
        PREPARE STMT FROM @SQL;
        EXECUTE STMT;
        DEALLOCATE PREPARE STMT;
        SET v_day = DATE_ADD(v_day, INTERVAL 1 DAY);
      END WHILE;
    END IF;

    IF IN_DAYS < 0 THEN
      SET v_day = DATE_FORMAT(DATE_ADD(NOW(), INTERVAL IN_DAYS DAY), '%Y-%m-%d');
      SET v_pname = CONCAT('p', DATE_FORMAT(v_day, '%Y%m%d'));


      OPEN c_partitions;
      FETCH c_partitions INTO v_stmt;
      WHILE v_error = 1 DO
        SET @SQL = v_stmt;
        SET v_errormessage = @SQL;
        PREPARE STMT FROM @SQL;
        EXECUTE STMT;
        DEALLOCATE PREPARE STMT;
        FETCH c_partitions INTO v_stmt;
      END WHILE;
      CLOSE c_partitions;
    END IF;
  END
  $$

--
-- Create procedure `FLUX_SPCOM_MAINT_SQLLOG`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_MAINT_SQLLOG ()
ENDPROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);

    DECLARE v_SCHEMANAME varchar(30);
    DECLARE v_TABLENAME varchar(30);
    DECLARE v_NEXTMONTH int;
    DECLARE v_Days int;
    DECLARE c_logtables CURSOR FOR
    SELECT
      CONCAT('BSM_SQL_LOG_', A.codeId) tablename
    FROM BSM_CODE A
    WHERE A.CODETYPE = 'LOGCATEGORY'
    AND A.CODEID <> 'DF'
    AND A.organizationId
    = (SELECT
        A.organizationId
      FROM SSM_ORGANIZATION A
      WHERE A.activeFlag = 'Y' LIMIT 0, 1);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SELECT
        CONCAT('999#', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    SET v_SCHEMANAME = 'wms_cml';
    SET v_TABLENAME = 'BSM_SQL_LOG';
    SET v_NEXTMONTH = 1;
    SET v_Days = -7;
    CALL FLUX_SPCOM_MAINT_PARTITIONS(v_SCHEMANAME, v_TABLENAME, v_NEXTMONTH, v_Days);

    OPEN c_logtables;
    FETCH c_logtables INTO v_TABLENAME;
    WHILE v_error = 1 DO
      CALL FLUX_SPCOM_MAINT_PARTITIONS(v_SCHEMANAME, v_TABLENAME, v_NEXTMONTH, v_Days);
      FETCH c_logtables INTO v_TABLENAME;
    END WHILE;

    SET v_TABLENAME = 'BSM_ACTIVITY_LOG';
    CALL FLUX_SPCOM_MAINT_PARTITIONS(v_SCHEMANAME, v_TABLENAME, v_NEXTMONTH, v_Days);

  END
  $$

--
-- Create procedure `FLUX_SPCOM_Archive_ByCatagery`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_Archive_ByCatagery (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_fmdb varchar(40),
IN IN_todb varchar(40),
IN IN_archiveByWave varchar(10),
IN In_standardCondition varchar(1000),
IN In_additionalCondition varchar(1000),
IN IN_ruleType varchar(20),
IN IN_dataDays int,
IN IN_batchQty int,
IN IN_archiveCatagery varchar(40),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(3000);
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_tableName varchar(30);
    DECLARE v_columnName varchar(30);
    DECLARE v_tableDesc varchar(500);
    DECLARE v_groupFlag char(1);
    DECLARE v_codeId varchar(30);
    DECLARE v_groupCodeId varchar(30);
    DECLARE v_groupCodeId_01 varchar(30);
    DECLARE v_joinFeild varchar(30);
    DECLARE v_whereCondition varchar(500);
    DECLARE v_archiveMode varchar(10);
    DECLARE v_date datetime;
    DECLARE v_selectCols varchar(3000);
    DECLARE v_wheresql_01 varchar(3000);
    DECLARE v_wheresql varchar(3000);
    DECLARE v_primaryCols varchar(1000);
    DECLARE v_tableColumnType varchar(1000);
    DECLARE v_tempTabName varchar(1000);
    DECLARE v_innerJoin varchar(1000);
    DECLARE v_columnType varchar(20);
    DECLARE v_primaryKey varchar(2);
    DECLARE v_seqNo bigint;
    DECLARE v_flag int;
    DECLARE v_warehouseId varchar(20);
    DECLARE v_joinWarehouse varchar(50);
    DECLARE v_logSeqNo bigint;

    DECLARE cur_tab_cols CURSOR FOR
    SELECT
      columnName,
      columnType,
      primaryKey
    FROM TMP_ARCHIVE_DIC_COLUMN
    WHERE UPPER(tableName) = v_tableName
    ORDER BY ordinal_position;

    DECLARE cur_tab_rule CURSOR FOR
    SELECT
      a.seqNo,
      a.tableName,
      a.tableDesc,
      a.groupFlag,
      a.codeId,
      a.groupCodeId,
      a.joinFeild,
      a.whereCondition,
      a.archiveMode
    FROM RUL_ARCHIVE_TABLE_INFO a
      INNER JOIN (SELECT
          UPPER(tableName) tableName
        FROM TMP_ARCHIVE_DIC_COLUMN
        GROUP BY UPPER(tableName)) b
        ON a.tableName = b.tableName
    WHERE a.archiveCatagery = v_archiveCatagery
    AND a.activeFlag IN ('C', 'Y')
    ORDER BY a.seqNo, a.tableName;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPCOM_Archive_ByCatagery,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        CONCAT('FLUX_SPCOM_Archive_ByCatagery:', v_errormessage) AS error;
      SELECT
        @SQL;
    END;
    SET v_errormessage = '0.Begin call sp FLUX_SPCOM_Archive_ByCatagery.';
    SET v_error = 1;
    SET v_tableName = '';
    IF IN_dataDays > 0
      AND UPPER(IN_ruleType) = 'TIMELY' THEN
      SET v_date = DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -IN_dataDays DAY), '%Y-%m-%d');
    ELSE
      SET v_date = NULL;
    END IF;
    SET v_errormessage = IN_archiveCatagery;
    SET v_archiveCatagery = IN_archiveCatagery;



    DELETE
      FROM TMP_ARCHIVE_DIC_COLUMN;
    INSERT INTO TMP_ARCHIVE_DIC_COLUMN (tableName, columnName, columnType, ordinal_position, primaryKey)
      SELECT
        a.TABLE_NAME,
        b.COLUMN_NAME,
        b.COLUMN_TYPE,
        b.ORDINAL_POSITION,
        CASE WHEN b.COLUMN_KEY = 'PRI' THEN 'Y' ELSE 'N' END
      FROM information_schema.TABLES a
        INNER JOIN information_schema.COLUMNS b
          ON a.TABLE_SCHEMA = b.TABLE_SCHEMA
          AND a.TABLE_NAME = b.TABLE_NAME
        INNER JOIN RUL_ARCHIVE_TABLE_INFO c
          ON UPPER(a.TABLE_NAME) = c.tableName
          AND c.archiveCatagery = v_archiveCatagery
      WHERE a.TABLE_SCHEMA = IN_fmdb
      AND a.TABLE_TYPE = 'BASE TABLE'
      AND c.activeFlag IN ('C', 'Y')
      GROUP BY b.TABLE_NAME,
               b.COLUMN_NAME,
               b.COLUMN_TYPE,
               b.ORDINAL_POSITION,
               b.COLUMN_KEY;

    SELECT
      COUNT(1),
      GROUP_CONCAT(CONCAT(tableName, ':', cols)) INTO v_nrow, v_errormessage
    FROM (SELECT
        tableName,
        GROUP_CONCAT(columnName) cols
      FROM TMP_ARCHIVE_DIC_COLUMN a
        LEFT JOIN information_schema.COLUMNS b
          ON a.tableName = b.TABLE_NAME
          AND a.columnName = b.COLUMN_NAME
          AND b.TABLE_SCHEMA = IN_todb
      WHERE b.TABLE_NAME IS NULL
      GROUP BY a.tableName) tt;
    IF v_nrow > 0 THEN
      SET OUT_returnCode = CONCAT('999#', v_errormessage);
      LEAVE ENDPROC;
    END IF;


    DELETE
      FROM TMP_ARCHIVE_DIC_COLUMN
    WHERE tableName = 'DOC_ORDER_HEADER'
      AND UPPER(columnName) = 'REF1';

    SET v_errormessage = '1.1';
    SET v_error = 1;
    SET v_wheresql = '';
    SET v_tableName = '';
    IF In_warehouseId = ''
      OR In_warehouseId IS NULL THEN
      SET v_warehouseId = '*';
    ELSE
      SET v_warehouseId = In_warehouseId;
    END IF;
    SET v_error = 1;
    SET v_flag = 1;

  LOOPFLAG:
    WHILE v_flag > 0 DO

      IF v_archiveCatagery <> 'BASE' THEN
        START TRANSACTION;
      END IF;

      SET v_flag = 0;
      OPEN cur_tab_rule;
      FETCH cur_tab_rule
      INTO v_seqNo, v_tableName, v_tableDesc
      , v_groupFlag, v_codeId, v_groupCodeId
      , v_joinFeild, v_whereCondition, v_archiveMode;
    ENDTAB:
      WHILE v_error <> 0 DO

        IF v_archiveCatagery = 'BASE' THEN
          START TRANSACTION;
        END IF;
        SET v_joinWarehouse = '';

        IF v_tableName LIKE 'SSM_%' THEN
          SET v_wheresql = CONCAT(' where 1 = 1 ');
        ELSE
          SET v_wheresql = CONCAT(' where 1 = 1 and a.organizationId = ''', IN_organizationId, '''');
          SELECT
            COUNT(1) INTO v_nrow
          FROM TMP_ARCHIVE_DIC_COLUMN
          WHERE tableName = v_tableName
          AND UPPER(columnName) = UPPER('warehouseId');
          IF v_nrow > 0
            AND v_warehouseId <> '*' THEN
            SET v_wheresql = CONCAT(v_wheresql, ' AND a.warehouseId = ''', v_warehouseId, ''' ');
          END IF;

          IF v_nrow > 0 THEN
            SET v_joinWarehouse = ' and a.warehouseId = b.warehouseId ';
          END IF;
        END IF;
        IF IFNULL(TRIM(v_whereCondition), '') <> '' THEN
          SET v_wheresql = CONCAT(v_wheresql, ' and ', v_whereCondition);
        END IF;
        IF In_UserId = 'DEBUG' THEN
          SET v_wheresql = CONCAT(v_wheresql, ' and 1 = 2 ');
        END IF;


        SET v_selectCols = '';
        SET v_primaryCols = '';
        SET v_tempTabName = '';
        SET v_innerJoin = '';
        SET v_tableColumnType = '';
        OPEN cur_tab_cols;
        SET v_error = 1;
        FETCH cur_tab_cols INTO v_columnName, v_columnType, v_primaryKey;
        WHILE v_error <> 0 DO
          IF v_primaryKey = 'Y' THEN
            SET v_primaryCols = CONCAT(v_primaryCols, v_columnName, ',');
            SET v_tableColumnType = CONCAT(v_tableColumnType, v_columnName, ' ', v_columnType, ' not null,');
            SET v_innerJoin = CONCAT(v_innerJoin, ' and a.', v_columnName, ' = b.', v_columnName);
          END IF;
          SET v_selectCols = CONCAT(v_selectCols, ',`', v_columnName, '`');
          SET v_error = 1;
          FETCH cur_tab_cols INTO v_columnName, v_columnType, v_primaryKey;
        END WHILE;
        CLOSE cur_tab_cols;
        SET v_selectCols = SUBSTRING(v_selectCols, 2, 3000);

        IF v_groupFlag = 'Y' THEN

          IF IFNULL(v_groupCodeId, '') <> IFNULL(v_groupCodeId_01, '') THEN
            SET v_groupCodeId_01 = v_groupCodeId;
          END IF;
          IF v_groupCodeId_01 = '' THEN
            SET v_groupCodeId_01 = NULL;
          END IF;
          IF v_codeId = '' THEN
            SET v_codeId = NULL;
          END IF;
          SET v_wheresql_01 = v_wheresql;
          IF v_groupCodeId_01 = v_codeId THEN

            IF v_date IS NOT NULL THEN
              SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.editTime < ''', v_date, ''' ');
            END IF;

            IF v_tableName IN
              ('DOC_PO_HEADER'
              , 'DOC_ASN_HEADER'
              , 'DOC_SALESORDER_HEADER'
              , 'DOC_ORDER_HEADER'
              , 'DOC_TRANSFER_HEADER'
              , 'DOC_MOVEMENT_HEADER'
              , 'DOC_ADJ_HEADER'
              , 'DOC_HOLD_HEADER'
              , 'DOC_KIT_HEADER')
              AND In_standardCondition = 'B' THEN
              SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.ediSendFlag = ''Y'' ');
            END IF;
            IF IN_archiveByWave = 'Y'
              AND v_tableName = 'DOC_ORDER_HEADER' THEN
              SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
              select ''ORDERNO'', tt.orderNo,tt.warehouseId
                from (
              select a.warehouseId,a.orderNo
                from DOC_ORDER_HEADER a
               inner join DOC_WAVE_HEADER b
                  on a.organizationId = b.organizationId
                 and a.warehouseId = b.warehouseId
                 and a.waveNo = b.waveNo
                 and b.WaveStatus = ''99'' 
            ', v_wheresql_01, '
             union all
              select a.warehouseId,a.orderNo
                from DOC_ORDER_HEADER a
                left join DOC_WAVE_HEADER b
                  on a.organizationId = b.organizationId
                 and a.warehouseId = b.warehouseId
                 and a.waveNo = b.waveNo 
            ', v_wheresql_01
              , ' and b.organizationId is null
                     ) tt
                 group by tt.warehouseId,tt.orderNo ');
            ELSE
              SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
              select ''', v_groupCodeId_01, ''',a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END, '
                from ', IN_fmdb, '.', v_tableName, ' a 
              ', v_wheresql_01, '
               group by a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END);
            END IF;

            IF IN_batchQty > 0 THEN
              SET @SQL = CONCAT(@SQL, ' limit 0,', IN_batchQty);
            END IF;

            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            SET v_flag = v_flag + v_nrow;
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;
          ELSEIF v_codeId IS NOT NULL THEN
            DELETE
              FROM TMP_ARCHIVE_CACHE_RECORD1;
            SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD1(codeId, code, warehouseId)
            select codeId,code, warehouseId
              from TMP_ARCHIVE_CACHE_RECORD
             where codeId = ''', v_codeId, ''' ');
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;

            SET @SQL = CONCAT(' delete from TMP_ARCHIVE_CACHE_RECORD
             where codeId = ''', v_groupCodeId_01, '''
          ');
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;

            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;

            SET @SQL = CONCAT('insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
           select ''', v_groupCodeId_01, ''', a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END, '
             from ', IN_fmdb, '.', v_tableName, ' a
            inner join TMP_ARCHIVE_CACHE_RECORD1 b
               on a.', v_joinFeild, ' = b.code', v_joinWarehouse, '
              and b.codeId = ''', v_codeId, '''
            group by a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END);
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            SET v_flag = v_flag + v_nrow;
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;
            SET v_codeId = v_groupCodeId_01;
            SET v_joinFeild = v_groupCodeId_01;
          ELSEIF v_codeId IS NULL THEN
            IF v_primaryCols <> '' THEN
              SET v_primaryCols = SUBSTRING(v_primaryCols, 1, LENGTH(v_primaryCols) - 1);

              SET v_tempTabName = CONCAT('TMP_', v_seqNo);
              SET @SQL = CONCAT(' create temporary table if not exists ', v_tempTabName, '
              (', v_tableColumnType, 'primary key(', v_primaryCols, '))
            ');
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              DEALLOCATE PREPARE STMT;


              SET @SQL = CONCAT('delete from ', v_tempTabName);
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              DEALLOCATE PREPARE STMT;

              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                SELECT
                  MAX(seqNo) INTO v_logSeqNo
                FROM TMP_ARCHIVE_DEBUG_LOG;
                UPDATE TMP_ARCHIVE_DEBUG_LOG
                SET nrow = v_nrow
                WHERE seqNo = v_logSeqNo;
              END IF;

              SET v_wheresql_01 = v_wheresql;

              IF v_date IS NOT NULL
                AND IFNULL(v_groupCodeId_01, '') <> '' THEN
                SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.', v_groupCodeId_01, ' < ''', v_date, ''' ');
              END IF;

              IF IN_batchQty > 0 THEN
                SET v_wheresql_01 = CONCAT(v_wheresql_01, ' limit 0,', IN_batchQty);
              END IF;

              SET @SQL = CONCAT(' insert into ', v_tempTabName, '
              (', v_primaryCols, ')
              select a.', REPLACE(v_primaryCols, ',', ',a.'), '
                from ', v_tableName, ' a ', v_wheresql_01);
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              SET v_flag = v_flag + v_nrow;
              DEALLOCATE PREPARE STMT;

              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                SELECT
                  MAX(seqNo) INTO v_logSeqNo
                FROM TMP_ARCHIVE_DEBUG_LOG;
                UPDATE TMP_ARCHIVE_DEBUG_LOG
                SET nrow = v_nrow
                WHERE seqNo = v_logSeqNo;
              END IF;
            END IF;
          END IF;
        END IF;

        IF v_archiveCatagery = 'BASE' THEN

          SET @SQL = CONCAT(' DELETE FROM ', IN_todb, '.', v_tableName, ' a ', v_wheresql);
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;

          SET @SQL = CONCAT('insert into ', IN_todb, '.', v_tableName, '
        (', v_selectCols, ')
        select a.', REPLACE(v_selectCols, ',', ',a.'), '
          from ', IN_fmdb, '.', v_tableName, ' a ', v_wheresql);
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;
        ELSE

          IF IFNULL(v_codeId, '') <> '' THEN
            SET v_innerJoin = CONCAT('
          inner join TMP_ARCHIVE_CACHE_RECORD b
               on a.', v_joinFeild, ' = b.code', v_joinWarehouse, '
              and b.codeId = ''', v_codeId, '''
          ');
          ELSEIF v_primaryCols <> ''
            AND v_groupFlag = 'Y' THEN
            SET v_innerJoin = SUBSTRING(v_innerJoin, 5, 1000);
            SET v_innerJoin = CONCAT(' 
          inner join ', v_tempTabName, ' b on ', v_innerJoin, ' ');
          END IF;

          SET @SQL = CONCAT(' insert into ', IN_todb, '.', v_tableName, '
          (', v_selectCols, ')
          select a.', REPLACE(v_selectCols, ',', ',a.'), '
            from ', IN_fmdb, '.', v_tableName, ' a '
          , v_innerJoin, ' ', v_wheresql);
          SELECT
            @SQL;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;

          SET @SQL = CONCAT(' delete a from ', IN_fmdb, '.', v_tableName, ' a ', v_innerJoin, ' ', v_wheresql);
          SELECT
            @SQL;
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;

          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;
        END IF;

        IF v_archiveCatagery = 'BASE' THEN
          COMMIT;
        END IF;

        SET v_error = 1;
        FETCH cur_tab_rule
        INTO v_seqNo, v_tableName, v_tableDesc
        , v_groupFlag, v_codeId, v_groupCodeId
        , v_joinFeild, v_whereCondition, v_archiveMode;
      END WHILE;
      CLOSE cur_tab_rule;
      IF v_archiveCatagery <> 'BASE' THEN
        COMMIT;
      END IF;
      IF v_archiveCatagery = 'BASE' THEN
        LEAVE LOOPFLAG;
      END IF;

    END WHILE;
    SET v_errormessage = 'n.End call sp FLUX_SPCOM_Archive_ByCatagery.';
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `FLUX_SPUDF_ProcessA`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPUDF_ProcessA (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_Parameter1 varchar(200),
IN IN_Parameter2 varchar(200),
IN IN_Parameter3 varchar(200),
IN IN_Parameter4 varchar(200),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPUDF_ProcessA,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `OJV_CML_SPCOM_Archive_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPCOM_Archive_Process (IN `IN_organizationId` varchar(20),
IN `IN_language` varchar(20),
IN `IN_userId` varchar(40),
INOUT `OUT_returnCode` varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_currentTime timestamp;
    DECLARE v_errormessage varchar(3000);
    DECLARE v_ruleId varchar(50);
    DECLARE v_ruletype varchar(20);
    DECLARE v_warehouseId varchar(50);
    DECLARE v_customerId varchar(50);
    DECLARE v_toDb varchar(50);
    DECLARE v_fmDb varchar(50);
    DECLARE v_standardCondition varchar(20);
    DECLARE v_additionalCondition varchar(1000);
    DECLARE v_dataDays int;
    DECLARE v_inBoundFlag char(1);
    DECLARE v_outBoundFlag char(1);
    DECLARE v_inventoryFlag char(1);
    DECLARE v_archiveByWave char(1);
    DECLARE v_otherFlag char(1);
    DECLARE v_baseFlag char(1);
    DECLARE v_batchQty int;
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_logSeqNo varchar(30);
    DECLARE v_i int;

    DECLARE cur_rule CURSOR FOR
    SELECT
      ruleId,
      ruletype,
      warehouseId,
      customerId,
      todb,
      standardCondition,
      additionalCondition,
      ruletype,
      dataDays,
      inBoundFlag,
      outBoundFlag,
      inventoryFlag,
      archiveByWave,
      otherFlag,
      CASE WHEN IFNULL(batchQty, 0) = 0 THEN 500 ELSE batchQty END batchQty
    FROM RUL_MOVE_ARCHIVE t
    WHERE t.organizationId = IN_organizationId
    AND t.activeflag = 'Y';


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#OJV_CML_SPCOM_Archive_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));

      SELECT
        CONCAT('OJV_CML_SPCOM_Archive_Process:', v_errormessage) AS error;

      SET v_errorMessage = OUT_returnCode;
      CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'en', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
      INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
      , startTime, endTime, successFlag, errorMessage
      , noteText, udf01, udf02, udf03, udf04, udf05
      , currentVersion, oprSeqFlag
      , addWho, ADDTIME, editWho, editTime)
        VALUES (In_organizationId, '*', v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
      COMMIT;
    END;


    IF In_UserId = 'DEBUG' THEN

      CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_DEBUG_LOG (
        organizationId varchar(20) NOT NULL,
        warehouseId varchar(20) NOT NULL,
        seqNo int NOT NULL AUTO_INCREMENT,
        archiveCatagery varchar(20),
        fmDb varchar(30),
        toDb varchar(30),
        sqlLog text,
        nrow int,
        logMessage text,
        addWho varchar(40),
        ADDTIME timestamp,
        PRIMARY KEY (seqNo),
        KEY (organizationId, warehouseId, archiveCatagery)
      );
    END IF;
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_DIC_COLUMN (
      tableName varchar(50),
      columnName varchar(50),
      columnType varchar(50),
      ordinal_position int,
      primaryKey char(1),
      KEY (tableName, columnName)
    );

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_CACHE_RECORD (
      codeId varchar(30),
      CODE varchar(50),
      warehouseId varchar(20),
      PRIMARY KEY (codeId, CODE, warehouseId)
    );
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_CACHE_RECORD1 (
      codeId varchar(30),
      CODE varchar(50),
      warehouseId varchar(20),
      PRIMARY KEY (codeId, CODE, warehouseId)
    );

    SET v_errormessage = '0.Begin call sp OJV_CML_SPCOM_Archive_Process.';
    SET v_error = 1;
    OPEN cur_rule;
    FETCH cur_rule INTO v_ruleId, v_ruletype
    , v_warehouseId, v_customerId, v_todb
    , v_standardCondition, v_additionalCondition, v_ruleType, v_dataDays
    , v_inBoundFlag, v_outBoundFlag, v_inventoryFlag, v_archiveByWave, v_otherFlag
    , v_batchQty;
  ENDWHILE1:
    WHILE v_error <> 0 DO
      SET v_currentTime = NOW();
      CALL FLUX_SPUDF_ProcessA(IN_organizationId, v_warehouseId,
      'ARCHIVE_BEFORE', '', '', '',
      IN_language, IN_userId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        CLOSE cur_rule;
        SET v_errorMessage = OUT_returnCode;
        ROLLBACK;
        CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
        INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
        , startTime, endTime, successFlag, errorMessage
        , noteText, udf01, udf02, udf03, udf04, udf05
        , currentVersion, oprSeqFlag
        , addWho, ADDTIME, editWho, editTime)
          VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
        COMMIT;
        LEAVE END_PROC;
      END IF;

      DELETE
        FROM TMP_ARCHIVE_CACHE_RECORD;
      DELETE
        FROM TMP_ARCHIVE_CACHE_RECORD1;
      DELETE
        FROM TMP_ARCHIVE_DIC_COLUMN;


      IF IN_userId = 'DEBUG'
        AND 1 = 2 THEN
        SET v_todb = 'cmlwms_archivedb';
        SET v_fmdb = 'wms_cml';
        SET v_baseFlag = 'Y';
        SET v_inBoundFlag = 'Y';
        SET v_outBoundFlag = 'Y';
        SET v_inventoryFlag = 'Y';
        SET v_otherFlag = 'Y';
        SET v_ruleType = 'TIMELY';
        SET v_batchQty = 10;
        SET v_dataDays = 60;
        SET v_warehouseId = 'CBT01';
      END IF;

      SET v_fmdb = 'wms_cml';



      SET v_i = 1;
      WHILE v_i <= 5 DO
      NEXTLOOP:
        BEGIN
          IF v_i = 1 THEN
            IF v_inBoundFlag = 'Y' THEN
              SET v_errormessage = '1.??????';
              SET v_archiveCatagery = 'INBOUND';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 2 THEN
            IF v_outBoundFlag = 'Y' THEN
              SET v_errormessage = '2.??????';
              SET v_archiveCatagery = 'OUTBOUND';
            ELSE
              LEAVE NEXTLOOP;
            END IF;

          ELSEIF v_i = 3 THEN
            IF v_inventoryFlag = 'Y' THEN
              SET v_errormessage = '3.??????';
              SET v_archiveCatagery = 'INVENTORY';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 4 THEN
            IF v_otherFlag = 'Y' THEN
              SET v_errormessage = '4.??????';
              SET v_archiveCatagery = 'OTHER';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 5 THEN
            IF v_baseFlag = 'Y' THEN
              SET v_errormessage = '5.????';
              SET v_archiveCatagery = 'BASE';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          END IF;


          CALL OJV_CML_SPCOM_Archive_ByCatagery(IN_organizationId, v_warehouseId, v_fmdb, v_todb
          , v_archiveByWave, v_standardCondition, v_additionalCondition, v_ruleType
          , v_dataDays, v_batchQty, v_archiveCatagery, IN_userId, OUT_returnCode);

          IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN

            ROLLBACK;

            SET v_errorMessage = CONCAT(v_archiveCatagery, ':', OUT_returnCode);
            CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
            INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
            , startTime, endTime, successFlag, errorMessage
            , noteText, udf01, udf02, udf03, udf04, udf05
            , currentVersion, oprSeqFlag
            , addWho, ADDTIME, editWho, editTime)
              VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());

          ELSE

            CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
            INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
            , startTime, endTime, successFlag, errorMessage
            , noteText, udf01, udf02, udf03, udf04, udf05
            , currentVersion, oprSeqFlag
            , addWho, ADDTIME, editWho, editTime)
              VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'Y', CONCAT(v_archiveCatagery, ':Succeed.'), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
          END IF;
          COMMIT;
        END;
        SET v_i = v_i + 1;
      END WHILE;

      CALL FLUX_SPUDF_ProcessA(IN_organizationId, v_warehouseId,
      'ARCHIVE_AFTER', '', '', '',
      IN_language, IN_userId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        CLOSE cur_rule;
        ROLLBACK;
        SET v_errorMessage = OUT_returnCode;
        CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
        INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
        , startTime, endTime, successFlag, errorMessage
        , noteText, udf01, udf02, udf03, udf04, udf05
        , currentVersion, oprSeqFlag
        , addWho, ADDTIME, editWho, editTime)
          VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
        COMMIT;
        LEAVE END_PROC;
      END IF;

      FETCH cur_rule INTO v_ruleId, v_ruletype
      , v_warehouseId, v_customerId, v_todb
      , v_standardCondition, v_additionalCondition, v_ruleType, v_dataDays
      , v_inBoundFlag, v_outBoundFlag, v_inventoryFlag, v_archiveByWave, v_otherFlag
      , v_batchQty;

    END WHILE;
    CLOSE cur_rule;
    SET v_errormessage = 'n.End call sp OJV_CML_SPCOM_Archive_Process.';
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_SPCOM_Archive_Process`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_Archive_Process (IN `IN_organizationId` varchar(20),
IN `IN_language` varchar(20),
IN `IN_userId` varchar(40),
INOUT `OUT_returnCode` varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_currentTime timestamp;
    DECLARE v_errormessage varchar(3000);
    DECLARE v_ruleId varchar(50);
    DECLARE v_ruletype varchar(20);
    DECLARE v_warehouseId varchar(50);
    DECLARE v_customerId varchar(50);
    DECLARE v_toDb varchar(50);
    DECLARE v_fmDb varchar(50);
    DECLARE v_standardCondition varchar(20);
    DECLARE v_additionalCondition varchar(1000);
    DECLARE v_dataDays int;
    DECLARE v_inBoundFlag char(1);
    DECLARE v_outBoundFlag char(1);
    DECLARE v_inventoryFlag char(1);
    DECLARE v_archiveByWave char(1);
    DECLARE v_otherFlag char(1);
    DECLARE v_baseFlag char(1);
    DECLARE v_batchQty int;
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_logSeqNo varchar(30);
    DECLARE v_i int;

    DECLARE cur_rule CURSOR FOR
    SELECT
      ruleId,
      ruletype,
      warehouseId,
      customerId,
      todb,
      standardCondition,
      additionalCondition,
      ruletype,
      dataDays,
      inBoundFlag,
      outBoundFlag,
      inventoryFlag,
      archiveByWave,
      otherFlag,
      CASE WHEN IFNULL(batchQty, 0) = 0 THEN 500 ELSE batchQty END batchQty
    FROM RUL_MOVE_ARCHIVE t
    WHERE t.organizationId = IN_organizationId
    AND t.activeflag = 'Y';


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPCOM_Archive_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));

      SELECT
        CONCAT('FLUX_SPCOM_Archive_Process:', v_errormessage) AS error;

      SET v_errorMessage = OUT_returnCode;
      CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'en', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
      INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
      , startTime, endTime, successFlag, errorMessage
      , noteText, udf01, udf02, udf03, udf04, udf05
      , currentVersion, oprSeqFlag
      , addWho, ADDTIME, editWho, editTime)
        VALUES (In_organizationId, '*', v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
      COMMIT;
    END;


    IF In_UserId = 'DEBUG' THEN

      CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_DEBUG_LOG (
        organizationId varchar(20) NOT NULL,
        warehouseId varchar(20) NOT NULL,
        seqNo int NOT NULL AUTO_INCREMENT,
        archiveCatagery varchar(20),
        fmDb varchar(30),
        toDb varchar(30),
        sqlLog text,
        nrow int,
        logMessage text,
        addWho varchar(40),
        ADDTIME timestamp,
        PRIMARY KEY (seqNo),
        KEY (organizationId, warehouseId, archiveCatagery)
      );
    END IF;
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_DIC_COLUMN (
      tableName varchar(50),
      columnName varchar(50),
      columnType varchar(50),
      ordinal_position int,
      primaryKey char(1),
      KEY (tableName, columnName)
    );

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_CACHE_RECORD (
      codeId varchar(30),
      CODE varchar(50),
      warehouseId varchar(20),
      PRIMARY KEY (codeId, CODE, warehouseId)
    );
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_CACHE_RECORD1 (
      codeId varchar(30),
      CODE varchar(50),
      warehouseId varchar(20),
      PRIMARY KEY (codeId, CODE, warehouseId)
    );

    SET v_errormessage = '0.Begin call sp FLUX_SPCOM_Archive_Process.';
    SET v_error = 1;
    OPEN cur_rule;
    FETCH cur_rule INTO v_ruleId, v_ruletype
    , v_warehouseId, v_customerId, v_todb
    , v_standardCondition, v_additionalCondition, v_ruleType, v_dataDays
    , v_inBoundFlag, v_outBoundFlag, v_inventoryFlag, v_archiveByWave, v_otherFlag
    , v_batchQty;
  ENDWHILE1:
    WHILE v_error <> 0 DO
      SET v_currentTime = NOW();
      CALL FLUX_SPUDF_ProcessA(IN_organizationId, v_warehouseId,
      'ARCHIVE_BEFORE', '', '', '',
      IN_language, IN_userId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        CLOSE cur_rule;
        SET v_errorMessage = OUT_returnCode;
        ROLLBACK;
        CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
        INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
        , startTime, endTime, successFlag, errorMessage
        , noteText, udf01, udf02, udf03, udf04, udf05
        , currentVersion, oprSeqFlag
        , addWho, ADDTIME, editWho, editTime)
          VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
        COMMIT;
        LEAVE END_PROC;
      END IF;

      DELETE
        FROM TMP_ARCHIVE_CACHE_RECORD;
      DELETE
        FROM TMP_ARCHIVE_CACHE_RECORD1;
      DELETE
        FROM TMP_ARCHIVE_DIC_COLUMN;


      IF IN_userId = 'DEBUG'
        AND 1 = 2 THEN
        SET v_todb = 'fluxwms_archivedb';
        SET v_fmdb = 'wms_cml';
        SET v_baseFlag = 'Y';
        SET v_inBoundFlag = 'Y';
        SET v_outBoundFlag = 'Y';
        SET v_inventoryFlag = 'Y';
        SET v_otherFlag = 'Y';
        SET v_ruleType = 'TIMELY';
        SET v_batchQty = 10;
        SET v_dataDays = 60;
        SET v_warehouseId = 'CBT01';
      END IF;

      SET v_fmdb = 'wms_cml';



      SET v_i = 1;
      WHILE v_i <= 5 DO
      NEXTLOOP:
        BEGIN
          IF v_i = 1 THEN
            IF v_inBoundFlag = 'Y' THEN
              SET v_errormessage = '1.??????';
              SET v_archiveCatagery = 'INBOUND';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 2 THEN
            IF v_outBoundFlag = 'Y' THEN
              SET v_errormessage = '2.??????';
              SET v_archiveCatagery = 'OUTBOUND';
            ELSE
              LEAVE NEXTLOOP;
            END IF;

          ELSEIF v_i = 3 THEN
            IF v_inventoryFlag = 'Y' THEN
              SET v_errormessage = '3.??????';
              SET v_archiveCatagery = 'INVENTORY';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 4 THEN
            IF v_otherFlag = 'Y' THEN
              SET v_errormessage = '4.??????';
              SET v_archiveCatagery = 'OTHER';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 5 THEN
            IF v_baseFlag = 'Y' THEN
              SET v_errormessage = '5.????';
              SET v_archiveCatagery = 'BASE';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          END IF;


          CALL FLUX_SPCOM_Archive_ByCatagery(IN_organizationId, v_warehouseId, v_fmdb, v_todb
          , v_archiveByWave, v_standardCondition, v_additionalCondition, v_ruleType
          , v_dataDays, v_batchQty, v_archiveCatagery, IN_userId, OUT_returnCode);

          IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN

            ROLLBACK;

            SET v_errorMessage = CONCAT(v_archiveCatagery, ':', OUT_returnCode);
            CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
            INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
            , startTime, endTime, successFlag, errorMessage
            , noteText, udf01, udf02, udf03, udf04, udf05
            , currentVersion, oprSeqFlag
            , addWho, ADDTIME, editWho, editTime)
              VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());

          ELSE

            CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
            INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
            , startTime, endTime, successFlag, errorMessage
            , noteText, udf01, udf02, udf03, udf04, udf05
            , currentVersion, oprSeqFlag
            , addWho, ADDTIME, editWho, editTime)
              VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'Y', CONCAT(v_archiveCatagery, ':Succeed.'), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
          END IF;
          COMMIT;
        END;
        SET v_i = v_i + 1;
      END WHILE;

      CALL FLUX_SPUDF_ProcessA(IN_organizationId, v_warehouseId,
      'ARCHIVE_AFTER', '', '', '',
      IN_language, IN_userId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        CLOSE cur_rule;
        ROLLBACK;
        SET v_errorMessage = OUT_returnCode;
        CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
        INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
        , startTime, endTime, successFlag, errorMessage
        , noteText, udf01, udf02, udf03, udf04, udf05
        , currentVersion, oprSeqFlag
        , addWho, ADDTIME, editWho, editTime)
          VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
        COMMIT;
        LEAVE END_PROC;
      END IF;

      FETCH cur_rule INTO v_ruleId, v_ruletype
      , v_warehouseId, v_customerId, v_todb
      , v_standardCondition, v_additionalCondition, v_ruleType, v_dataDays
      , v_inBoundFlag, v_outBoundFlag, v_inventoryFlag, v_archiveByWave, v_otherFlag
      , v_batchQty;

    END WHILE;
    CLOSE cur_rule;
    SET v_errormessage = 'n.End call sp FLUX_SPCOM_Archive_Process.';
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `CML_SPCOM_Archive_ByCatagery`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_SPCOM_Archive_ByCatagery (IN IN_organizationId varchar(20), IN IN_warehouseId varchar(20), IN IN_fmdb varchar(40), IN IN_todb varchar(40), IN IN_archiveByWave varchar(10), IN In_standardCondition varchar(1000), IN In_additionalCondition varchar(1000), IN IN_ruleType varchar(20), IN IN_dataDays int, IN IN_batchQty int, IN IN_archiveCatagery varchar(40), IN IN_userId varchar(40), INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(3000);
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_tableName varchar(30);
    DECLARE v_columnName varchar(30);
    DECLARE v_tableDesc varchar(500);
    DECLARE v_groupFlag char(1);
    DECLARE v_codeId varchar(30);
    DECLARE v_groupCodeId varchar(30);
    DECLARE v_groupCodeId_01 varchar(30);
    DECLARE v_joinFeild varchar(30);
    DECLARE v_whereCondition varchar(500);
    DECLARE v_archiveMode varchar(10);
    DECLARE v_date datetime;
    DECLARE v_selectCols varchar(5000);
    DECLARE v_wheresql_01 varchar(3000);
    DECLARE v_wheresql varchar(3000);
    DECLARE v_primaryCols varchar(1000);
    DECLARE v_tableColumnType varchar(1000);
    DECLARE v_tempTabName varchar(1000);
    DECLARE v_innerJoin varchar(1000);
    DECLARE v_columnType varchar(20);
    DECLARE v_primaryKey varchar(2);
    DECLARE v_seqNo bigint;
    DECLARE v_flag int;
    DECLARE v_warehouseId varchar(20);
    DECLARE v_joinWarehouse varchar(50);
    DECLARE v_logSeqNo bigint;
    DECLARE cur_tab_cols CURSOR FOR
    SELECT
      columnName,
      columnType,
      primaryKey
    FROM TMP_ARCHIVE_DIC_COLUMN
    WHERE UPPER(tableName) = UPPER(v_tableName)
    ORDER BY ordinal_position;
    DECLARE cur_tab_rule CURSOR FOR
    SELECT
      a.seqNo,
      a.tableName,
      a.tableDesc,
      a.groupFlag,
      a.codeId,
      a.groupCodeId,
      a.joinFeild,
      a.whereCondition,
      a.archiveMode
    FROM RUL_ARCHIVE_TABLE_INFO a
      INNER JOIN (SELECT
          UPPER(tableName) tableName
        FROM TMP_ARCHIVE_DIC_COLUMN
        GROUP BY UPPER(tableName)) b
        ON UPPER(a.tableName) = UPPER(b.tableName)
    WHERE a.archiveCatagery = v_archiveCatagery
    AND a.activeFlag IN ('C', 'Y')
    ORDER BY a.seqNo, a.tableName;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_SPCOM_Archive_ByCatagery,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        CONCAT('CML_SPCOM_Archive_ByCatagery:', v_errormessage) AS error;
      SELECT
        @SQL;
    END;
    SET v_errormessage = '0.Begin call sp CML_SPCOM_Archive_ByCatagery.';
    SET v_error = 1;
    SET v_tableName = '';
    IF IN_dataDays > 0
      AND UPPER(IN_ruleType) = 'TIMELY' THEN
      SET v_date = DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -IN_dataDays DAY), '%Y-%m-%d');
    ELSE
      SET v_date = NULL;
    END IF;
    SET v_errormessage = IN_archiveCatagery;
    SET v_archiveCatagery = IN_archiveCatagery;
    SET IN_todb = CONCAT(IN_todb, In_additionalCondition);
    DELETE
      FROM TMP_ARCHIVE_DIC_COLUMN;
    INSERT INTO TMP_ARCHIVE_DIC_COLUMN (tableName, columnName, columnType, ordinal_position, primaryKey)
      SELECT
        UPPER(a.TABLE_NAME),
        b.COLUMN_NAME,
        b.COLUMN_TYPE,
        b.ORDINAL_POSITION,
        CASE WHEN b.COLUMN_KEY = 'PRI' THEN 'Y' ELSE 'N' END
      FROM information_schema.TABLES a
        INNER JOIN information_schema.COLUMNS b
          ON a.TABLE_SCHEMA = b.TABLE_SCHEMA
          AND a.TABLE_NAME = b.TABLE_NAME
        INNER JOIN RUL_ARCHIVE_TABLE_INFO c
          ON UPPER(a.TABLE_NAME) = UPPER(c.tableName)
          AND c.archiveCatagery = v_archiveCatagery
      WHERE a.TABLE_SCHEMA = IN_fmdb
      AND a.TABLE_TYPE = 'BASE TABLE'
      AND c.activeFlag IN ('C', 'Y')
      GROUP BY b.TABLE_NAME,
               b.COLUMN_NAME,
               b.COLUMN_TYPE,
               b.ORDINAL_POSITION,
               b.COLUMN_KEY;
    SELECT
      COUNT(1),
      GROUP_CONCAT(CONCAT(tableName, ':', cols)) INTO v_nrow, v_errormessage
    FROM (SELECT
        tableName,
        GROUP_CONCAT(columnName) cols
      FROM TMP_ARCHIVE_DIC_COLUMN a
        LEFT JOIN information_schema.COLUMNS b
          ON a.tableName = UPPER(b.TABLE_NAME)
          AND UPPER(a.columnName) = UPPER(b.COLUMN_NAME)
          AND b.TABLE_SCHEMA = IN_todb
      WHERE b.TABLE_NAME IS NULL
      GROUP BY a.tableName) tt;
    IF v_nrow > 0 THEN
      SET OUT_returnCode = CONCAT('999#', v_errormessage);
      LEAVE ENDPROC;
    END IF;
    DELETE
      FROM TMP_ARCHIVE_DIC_COLUMN
    WHERE tableName = 'DOC_ORDER_HEADER'
      AND UPPER(columnName) = 'REF1';
    SET v_errormessage = '1.1';
    SET v_error = 1;
    SET v_wheresql = '';
    SET v_tableName = '';
    IF In_warehouseId = ''
      OR In_warehouseId IS NULL THEN
      SET v_warehouseId = '*';
    ELSE
      SET v_warehouseId = In_warehouseId;
    END IF;
    SET v_error = 1;
    SET v_flag = 1;
  LOOPFLAG:
    WHILE v_flag > 0 DO
      IF v_archiveCatagery <> 'BASE' THEN
        START TRANSACTION;
      END IF;
      SET v_flag = 0;
      OPEN cur_tab_rule;
      FETCH cur_tab_rule
      INTO v_seqNo, v_tableName, v_tableDesc
      , v_groupFlag, v_codeId, v_groupCodeId
      , v_joinFeild, v_whereCondition, v_archiveMode;
    ENDTAB:
      WHILE v_error <> 0 DO
        IF v_archiveCatagery = 'BASE' THEN
          START TRANSACTION;
        END IF;
        SET v_joinWarehouse = '';
        IF v_tableName LIKE 'SSM_%' THEN
          SET v_wheresql = CONCAT(' where 1 = 1 ');
        ELSE
          SET v_wheresql = CONCAT(' where 1 = 1 and a.organizationId = ''', IN_organizationId, '''');
          SELECT
            COUNT(1) INTO v_nrow
          FROM TMP_ARCHIVE_DIC_COLUMN
          WHERE tableName = UPPER(v_tableName)
          AND UPPER(columnName) = UPPER('warehouseId');
          IF v_nrow > 0
            AND v_warehouseId <> '*' THEN
            SET v_wheresql = CONCAT(v_wheresql, ' AND a.warehouseId = ''', v_warehouseId, ''' ');
          END IF;
          IF v_nrow > 0 THEN
            SET v_joinWarehouse = ' and a.warehouseId = b.warehouseId ';
          END IF;
        END IF;
        IF IFNULL(TRIM(v_whereCondition), '') <> '' THEN
          SET v_wheresql = CONCAT(v_wheresql, ' and ', v_whereCondition);
        END IF;

        IF In_UserId = 'DEBUG' THEN
          SET v_wheresql = CONCAT(v_wheresql, ' and 1 = 2 ');
        END IF;
        SET v_selectCols = '';
        SET v_primaryCols = '';
        SET v_tempTabName = '';
        SET v_innerJoin = '';
        SET v_tableColumnType = '';
        OPEN cur_tab_cols;
        SET v_error = 1;
        FETCH cur_tab_cols INTO v_columnName, v_columnType, v_primaryKey;
        WHILE v_error <> 0 DO
          IF v_primaryKey = 'Y' THEN
            SET v_primaryCols = CONCAT(v_primaryCols, v_columnName, ',');
            SET v_tableColumnType = CONCAT(v_tableColumnType, v_columnName, ' ', v_columnType, ' not null,');
            SET v_innerJoin = CONCAT(v_innerJoin, ' and a.', v_columnName, ' = b.', v_columnName);
          END IF;
          SET v_selectCols = CONCAT(v_selectCols, ',`', v_columnName, '`');
          SET v_error = 1;
          FETCH cur_tab_cols INTO v_columnName, v_columnType, v_primaryKey;
        END WHILE;
        CLOSE cur_tab_cols;
        SET v_selectCols = SUBSTRING(v_selectCols, 2, 5000);
        IF v_groupFlag = 'Y' THEN
          IF IFNULL(v_groupCodeId, '') <> IFNULL(v_groupCodeId_01, '') THEN
            SET v_groupCodeId_01 = v_groupCodeId;
          END IF;
          IF v_groupCodeId_01 = '' THEN
            SET v_groupCodeId_01 = NULL;
          END IF;
          IF v_codeId = '' THEN
            SET v_codeId = NULL;
          END IF;
          SET v_wheresql_01 = v_wheresql;
          IF v_groupCodeId_01 = v_codeId THEN
            IF v_date IS NOT NULL THEN
              IF IFNULL(TRIM(In_additionalCondition), '') <> '' THEN
                SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and year(a.editTime) = ', In_additionalCondition, ' ');
              ELSE
                SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.editTime < ''', v_date, ''' ');
              END IF;
            END IF;
            IF v_tableName IN
              ('DOC_PO_HEADER'
              , 'DOC_ASN_HEADER'
              , 'DOC_SALESORDER_HEADER'
              , 'DOC_ORDER_HEADER'
              , 'DOC_TRANSFER_HEADER'
              , 'DOC_MOVEMENT_HEADER'
              , 'DOC_ADJ_HEADER'
              , 'DOC_HOLD_HEADER'
              , 'DOC_KIT_HEADER')
              AND In_standardCondition = 'B' THEN
              SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.ediSendFlag = ''Y'' ');
            END IF;
            IF IN_archiveByWave = 'Y'
              AND v_tableName = 'DOC_ORDER_HEADER' THEN
              SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
              select ''ORDERNO'', tt.orderNo,tt.warehouseId
                from (
              select a.warehouseId,a.orderNo
                from DOC_ORDER_HEADER a
               inner join DOC_WAVE_HEADER b
                  on a.organizationId = b.organizationId
                 and a.warehouseId = b.warehouseId
                 and a.waveNo = b.waveNo
                 and b.WaveStatus = ''99'' 
            ', v_wheresql_01, '
             union all
              select a.warehouseId,a.orderNo
                from DOC_ORDER_HEADER a
                left join DOC_WAVE_HEADER b
                  on a.organizationId = b.organizationId
                 and a.warehouseId = b.warehouseId
                 and a.waveNo = b.waveNo 
            ', v_wheresql_01
              , ' and b.organizationId is null
                     ) tt
                 group by tt.warehouseId,tt.orderNo ');
            ELSE
              SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
              select ''', v_groupCodeId_01, ''',a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END, '
                from ', IN_fmdb, '.', v_tableName, ' a 
              ', v_wheresql_01, '
               group by a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END);
            --   IF @SQL <> '' THEN
            --     SET OUT_returnCode = @SQL;
            --     LEAVE ENDPROC;
            --   END IF;
            END IF;
            --  IF IN_archiveByWave <> '' THEN
            --     SET OUT_returnCode = IN_archiveByWave;
            --     LEAVE ENDPROC;
            --   END IF;
            IF IN_batchQty > 0 THEN
              SET @SQL = CONCAT(@SQL, ' limit 0,', IN_batchQty);
            END IF;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            SET v_flag = v_flag + v_nrow;
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;
          ELSEIF v_codeId IS NOT NULL THEN
            DELETE
              FROM TMP_ARCHIVE_CACHE_RECORD1;
            SET @SQL = CONCAT(' insert into TMP_ARCHIVE_CACHE_RECORD1(codeId, code, warehouseId)
            select codeId,code, warehouseId
              from TMP_ARCHIVE_CACHE_RECORD
             where codeId = ''', v_codeId, ''' ');
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;
            SET @SQL = CONCAT(' delete from TMP_ARCHIVE_CACHE_RECORD
             where codeId = ''', v_groupCodeId_01, '''
          ');
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;
            SET @SQL = CONCAT('insert into TMP_ARCHIVE_CACHE_RECORD(codeId,code,warehouseId)
           select ''', v_groupCodeId_01, ''', a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END, '
             from ', IN_fmdb, '.', v_tableName, ' a
            inner join TMP_ARCHIVE_CACHE_RECORD1 b
               on a.', v_joinFeild, ' = b.code', v_joinWarehouse, '
              and b.codeId = ''', v_codeId, '''
            group by a.', v_groupCodeId_01, CASE WHEN v_joinWarehouse <> '' THEN ',a.warehouseId' ELSE ',null' END);
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
            END IF;
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET v_nrow = ROW_COUNT();
            SET v_flag = v_flag + v_nrow;
            DEALLOCATE PREPARE STMT;
            IF In_UserId = 'DEBUG'
              OR In_UserId = 'DEBUG1' THEN
              SELECT
                MAX(seqNo) INTO v_logSeqNo
              FROM TMP_ARCHIVE_DEBUG_LOG;
              UPDATE TMP_ARCHIVE_DEBUG_LOG
              SET nrow = v_nrow
              WHERE seqNo = v_logSeqNo;
            END IF;
            SET v_codeId = v_groupCodeId_01;
            SET v_joinFeild = v_groupCodeId_01;
          ELSEIF v_codeId IS NULL THEN
            IF v_primaryCols <> '' THEN
              SET v_primaryCols = SUBSTRING(v_primaryCols, 1, LENGTH(v_primaryCols) - 1);
              SET v_tempTabName = CONCAT('TMP_', v_seqNo);
              SET @SQL = CONCAT(' create temporary table if not exists ', v_tempTabName, '
              (', v_tableColumnType, 'primary key(', v_primaryCols, '))
            ');
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              DEALLOCATE PREPARE STMT;
              SET @SQL = CONCAT('delete from ', v_tempTabName);
              -- INSERT INTO Z_LOGS (cmd) VALUES (@SQL);
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              DEALLOCATE PREPARE STMT;
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                SELECT
                  MAX(seqNo) INTO v_logSeqNo
                FROM TMP_ARCHIVE_DEBUG_LOG;
                UPDATE TMP_ARCHIVE_DEBUG_LOG
                SET nrow = v_nrow
                WHERE seqNo = v_logSeqNo;
              END IF;
              SET v_wheresql_01 = v_wheresql;
              IF v_date IS NOT NULL
                AND IFNULL(v_groupCodeId_01, '') <> '' THEN
                SET v_wheresql_01 = CONCAT(v_wheresql_01, ' and a.', v_groupCodeId_01, ' < ''', v_date, ''' ');
              END IF;
              IF IN_batchQty > 0 THEN
                SET v_wheresql_01 = CONCAT(v_wheresql_01, ' limit 0,', IN_batchQty);
              END IF;
              SET @SQL = CONCAT(' insert into ', v_tempTabName, '
              (', v_primaryCols, ')
              select a.', REPLACE(v_primaryCols, ',', ',a.'), '
                from ', v_tableName, ' a ', v_wheresql_01);
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
                  VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
              END IF;
              PREPARE STMT FROM @SQL;
              EXECUTE STMT;
              SET v_nrow = ROW_COUNT();
              SET v_flag = v_flag + v_nrow;
              DEALLOCATE PREPARE STMT;
              IF In_UserId = 'DEBUG'
                OR In_UserId = 'DEBUG1' THEN
                SELECT
                  MAX(seqNo) INTO v_logSeqNo
                FROM TMP_ARCHIVE_DEBUG_LOG;
                UPDATE TMP_ARCHIVE_DEBUG_LOG
                SET nrow = v_nrow
                WHERE seqNo = v_logSeqNo;
              END IF;
            END IF;
          END IF;
        END IF;
        IF v_archiveCatagery = 'BASE' THEN
          SET @SQL = CONCAT(' DELETE FROM ', IN_todb, '.', v_tableName, ' a ', v_wheresql);
          -- INSERT INTO Z_LOGS (cmd) VALUES (@SQL);
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;
          SET @SQL = CONCAT('insert into ', IN_todb, '.', v_tableName, '
        (', v_selectCols, ')
        select a.', REPLACE(v_selectCols, ',', ',a.'), '
          from ', IN_fmdb, '.', v_tableName, ' a ', v_wheresql);
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;
        ELSE
          IF IFNULL(v_codeId, '') <> '' THEN
            SET v_innerJoin = CONCAT('
          inner join TMP_ARCHIVE_CACHE_RECORD b
               on a.', v_joinFeild, ' = b.code', v_joinWarehouse, '
              and b.codeId = ''', v_codeId, '''
          ');
          ELSEIF v_primaryCols <> ''
            AND v_groupFlag = 'Y' THEN
            SET v_innerJoin = SUBSTRING(v_innerJoin, 5, 1000);
            SET v_innerJoin = CONCAT(' 
          inner join ', v_tempTabName, ' b on ', v_innerJoin, ' ');
          END IF;
          SET @SQL = CONCAT(' insert into ', IN_todb, '.', v_tableName, '
          (', v_selectCols, ')
          select a.', REPLACE(v_selectCols, ',', ',a.'), '
            from ', IN_fmdb, '.', v_tableName, ' a '
          , v_innerJoin, ' ', v_wheresql);
          SELECT
            @SQL;
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;
          SET @SQL = CONCAT(' delete a from ', IN_fmdb, '.', v_tableName, ' a ', v_innerJoin, ' ', v_wheresql);
          -- INSERT INTO Z_LOGS (cmd) VALUES (@SQL);
          SELECT
            @SQL;
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            INSERT INTO TMP_ARCHIVE_DEBUG_LOG (organizationId, warehouseId, archiveCatagery, fmDb, toDb, sqlLog, nrow, ADDTIME, addWho)
              VALUES (IN_organizationId, v_warehouseId, v_archiveCatagery, IN_fmDb, IN_toDb, @SQL, v_nrow, NOW(), IN_userId);
          END IF;
          PREPARE STMT FROM @SQL;
          EXECUTE STMT;
          SET v_nrow = ROW_COUNT();
          DEALLOCATE PREPARE STMT;
          IF In_UserId = 'DEBUG'
            OR In_UserId = 'DEBUG1' THEN
            SELECT
              MAX(seqNo) INTO v_logSeqNo
            FROM TMP_ARCHIVE_DEBUG_LOG;
            UPDATE TMP_ARCHIVE_DEBUG_LOG
            SET nrow = v_nrow
            WHERE seqNo = v_logSeqNo;
          END IF;
        END IF;
        IF v_archiveCatagery = 'BASE' THEN
          COMMIT;
        END IF;
        SET v_error = 1;
        FETCH cur_tab_rule
        INTO v_seqNo, v_tableName, v_tableDesc
        , v_groupFlag, v_codeId, v_groupCodeId
        , v_joinFeild, v_whereCondition, v_archiveMode;
      END WHILE;
      CLOSE cur_tab_rule;
      IF v_archiveCatagery <> 'BASE' THEN
        COMMIT;
      END IF;
      IF v_archiveCatagery = 'BASE' THEN
        LEAVE LOOPFLAG;
      END IF;
    END WHILE;
    SET v_errormessage = 'n.End call sp CML_SPCOM_Archive_ByCatagery.';
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_SPCOM_Archive_Process`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_SPCOM_Archive_Process (IN IN_organizationId varchar(20), IN IN_language varchar(20), IN IN_userId varchar(40), INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_currentTime timestamp;
    DECLARE v_errormessage varchar(3000);
    DECLARE v_ruleId varchar(50);
    DECLARE v_ruletype varchar(20);
    DECLARE v_warehouseId varchar(50);
    DECLARE v_customerId varchar(50);
    DECLARE v_toDb varchar(50);
    DECLARE v_fmDb varchar(50);
    DECLARE v_standardCondition varchar(20);
    DECLARE v_additionalCondition varchar(1000);
    DECLARE v_dataDays int;
    DECLARE v_inBoundFlag char(1);
    DECLARE v_outBoundFlag char(1);
    DECLARE v_inventoryFlag char(1);
    DECLARE v_archiveByWave char(1);
    DECLARE v_otherFlag char(1);
    DECLARE v_baseFlag char(1);
    DECLARE v_batchQty int;
    DECLARE v_archiveCatagery varchar(20);
    DECLARE v_logSeqNo varchar(30);
    DECLARE v_i int;

    DECLARE cur_rule CURSOR FOR
    SELECT
      ruleId,
      ruletype,
      warehouseId,
      customerId,
      todb,
      standardCondition,
      additionalCondition,
      ruletype,
      dataDays,
      inBoundFlag,
      outBoundFlag,
      inventoryFlag,
      archiveByWave,
      otherFlag,
      CASE WHEN IFNULL(batchQty, 0) = 0 THEN 500 ELSE batchQty END batchQty
    FROM RUL_MOVE_ARCHIVE t
    WHERE t.organizationId = IN_organizationId
    AND t.activeflag = 'Y';


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_SPCOM_Archive_Process,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));

      SELECT
        CONCAT('CML_SPCOM_Archive_Process:', v_errormessage) AS error;

      SET v_errorMessage = OUT_returnCode;
      CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'en', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
      INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
      , startTime, endTime, successFlag, errorMessage
      , noteText, udf01, udf02, udf03, udf04, udf05
      , currentVersion, oprSeqFlag
      , addWho, ADDTIME, editWho, editTime)
        VALUES (In_organizationId, '*', v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
      COMMIT;
    END;


    IF In_UserId = 'DEBUG' THEN

      CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_DEBUG_LOG (
        organizationId varchar(20) NOT NULL,
        warehouseId varchar(20) NOT NULL,
        seqNo int NOT NULL AUTO_INCREMENT,
        archiveCatagery varchar(20),
        fmDb varchar(30),
        toDb varchar(30),
        sqlLog text,
        nrow int,
        logMessage text,
        addWho varchar(40),
        ADDTIME timestamp,
        PRIMARY KEY (seqNo),
        KEY (organizationId, warehouseId, archiveCatagery)
      );
    END IF;
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_DIC_COLUMN (
      tableName varchar(50),
      columnName varchar(50),
      columnType varchar(50),
      ordinal_position int,
      primaryKey char(1),
      KEY (tableName, columnName)
    );

    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_CACHE_RECORD (
      codeId varchar(30),
      CODE varchar(50),
      warehouseId varchar(20),
      PRIMARY KEY (codeId, CODE, warehouseId)
    );
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_ARCHIVE_CACHE_RECORD1 (
      codeId varchar(30),
      CODE varchar(50),
      warehouseId varchar(20),
      PRIMARY KEY (codeId, CODE, warehouseId)
    );

    SET v_errormessage = '0.Begin call sp CML_SPCOM_Archive_Process.';
    SET v_error = 1;
    OPEN cur_rule;
    FETCH cur_rule INTO v_ruleId, v_ruletype
    , v_warehouseId, v_customerId, v_todb
    , v_standardCondition, v_additionalCondition, v_ruleType, v_dataDays
    , v_inBoundFlag, v_outBoundFlag, v_inventoryFlag, v_archiveByWave, v_otherFlag
    , v_batchQty;
  ENDWHILE1:
    WHILE v_error <> 0 DO
      SET v_currentTime = NOW();
      CALL CML_SPUDF_ProcessA(IN_organizationId, v_warehouseId,
      'ARCHIVE_BEFORE', '', '', '',
      IN_language, IN_userId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        CLOSE cur_rule;
        SET v_errorMessage = OUT_returnCode;
        ROLLBACK;
        CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
        INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
        , startTime, endTime, successFlag, errorMessage
        , noteText, udf01, udf02, udf03, udf04, udf05
        , currentVersion, oprSeqFlag
        , addWho, ADDTIME, editWho, editTime)
          VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
        COMMIT;
        LEAVE END_PROC;
      END IF;

      DELETE
        FROM TMP_ARCHIVE_CACHE_RECORD;
      DELETE
        FROM TMP_ARCHIVE_CACHE_RECORD1;
      DELETE
        FROM TMP_ARCHIVE_DIC_COLUMN;


      IF IN_userId = 'DEBUG'
        AND 1 = 2 THEN
        SET v_todb = 'wms_ftest_arv';
        SET v_fmdb = 'wms_ftest';
        SET v_baseFlag = 'Y';
        SET v_inBoundFlag = 'Y';
        SET v_outBoundFlag = 'Y';
        SET v_inventoryFlag = 'Y';
        SET v_otherFlag = 'Y';
        SET v_ruleType = 'TIMELY';
        SET v_batchQty = 10;
        SET v_dataDays = 60;
        SET v_warehouseId = 'D002';
      END IF;

      SET v_fmdb = 'wms_cml';


      SET v_i = 1;
      WHILE v_i <= 5 DO
      NEXTLOOP:
        BEGIN
          IF v_i = 1 THEN
            IF v_inBoundFlag = 'Y' THEN
              SET v_errormessage = '1.??????';
              SET v_archiveCatagery = 'INBOUND';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 2 THEN
            IF v_outBoundFlag = 'Y' THEN
              SET v_errormessage = '2.??????';
              SET v_archiveCatagery = 'OUTBOUND';
            ELSE
              LEAVE NEXTLOOP;
            END IF;

          ELSEIF v_i = 3 THEN
            IF v_inventoryFlag = 'Y' THEN
              SET v_errormessage = '3.??????';
              SET v_archiveCatagery = 'INVENTORY';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 4 THEN
            IF v_otherFlag = 'Y' THEN
              SET v_errormessage = '4.??????';
              SET v_archiveCatagery = 'OTHER';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          ELSEIF v_i = 5 THEN
            IF v_baseFlag = 'Y' THEN
              SET v_errormessage = '5.????';
              SET v_archiveCatagery = 'BASE';
            ELSE
              LEAVE NEXTLOOP;
            END IF;
          END IF;


          CALL CML_SPCOM_Archive_ByCatagery(IN_organizationId, v_warehouseId, v_fmdb, v_todb
          , v_archiveByWave, v_standardCondition, v_additionalCondition, v_ruleType
          , v_dataDays, v_batchQty, v_archiveCatagery, IN_userId, OUT_returnCode);

          IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN

            ROLLBACK;

            SET v_errorMessage = CONCAT(v_archiveCatagery, ':', OUT_returnCode);
            CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
            INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
            , startTime, endTime, successFlag, errorMessage
            , noteText, udf01, udf02, udf03, udf04, udf05
            , currentVersion, oprSeqFlag
            , addWho, ADDTIME, editWho, editTime)
              VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());

          ELSE

            CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
            INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
            , startTime, endTime, successFlag, errorMessage
            , noteText, udf01, udf02, udf03, udf04, udf05
            , currentVersion, oprSeqFlag
            , addWho, ADDTIME, editWho, editTime)
              VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'Y', CONCAT(v_archiveCatagery, ':Succeed.'), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
          END IF;
          COMMIT;
        END;
        SET v_i = v_i + 1;
      END WHILE;

      CALL CML_SPUDF_ProcessA(IN_organizationId, v_warehouseId,
      'ARCHIVE_AFTER', '', '', '',
      IN_language, IN_userId, OUT_returnCode);
      IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
        CLOSE cur_rule;
        ROLLBACK;
        SET v_errorMessage = OUT_returnCode;
        CALL SPCOM_GETIDSEQUENCE_NEW(IN_organizationId, v_warehouseId, 'cn', 'LOGSEQNO', v_logSeqNo, OUT_returnCode);
        INSERT INTO RUL_MOVE_ARCHIVE_LOG (organizationId, warehouseId, logSeqNo
        , startTime, endTime, successFlag, errorMessage
        , noteText, udf01, udf02, udf03, udf04, udf05
        , currentVersion, oprSeqFlag
        , addWho, ADDTIME, editWho, editTime)
          VALUES (In_organizationId, v_warehouseId, v_logSeqNo, v_currentTime, NOW(), 'N', CONCAT('Error,', v_errorMessage), NULL, v_ruleId, NULL, NULL, NULL, NULL, 100, '2019', IN_userId, NOW(), IN_userId, NOW());
        COMMIT;
        LEAVE END_PROC;
      END IF;

      FETCH cur_rule INTO v_ruleId, v_ruletype
      , v_warehouseId, v_customerId, v_todb
      , v_standardCondition, v_additionalCondition, v_ruleType, v_dataDays
      , v_inBoundFlag, v_outBoundFlag, v_inventoryFlag, v_archiveByWave, v_otherFlag
      , v_batchQty;

    END WHILE;
    CLOSE cur_rule;
    SET v_errormessage = 'n.End call sp CML_SPCOM_Archive_Process.';
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `CML_ASSIGN_CUSTSORT_STG_LOC`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_ASSIGN_CUSTSORT_STG_LOC (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_waveNo varchar(30),
IN IN_orderNo varchar(30),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_stgLoc,
          v_soOrd,
          v_cust varchar(20);
  DECLARE finished integer DEFAULT 0;
  DECLARE cur_assign_sort_loc CURSOR FOR
  SELECT DISTINCT
    D.ORDERNO,
    H.CUSTOMERID,
    CONCAT('SORTATION', H.WAREHOUSEID) STG_LOC
  FROM DOC_WAVE_HEADER H
    INNER JOIN DOC_WAVE_DETAILS D
      ON H.WAVENO = D.WAVENO
      AND H.ORGANIZATIONID = D.ORGANIZATIONID
      AND H.WAREHOUSEID = D.WAREHOUSEID
  WHERE (H.WAVENO = IFNULL(IN_waveNo, '')
  OR D.ORDERNO = IFNULL(IN_orderNo, ''))
  AND H.ORGANIZATIONID = IN_organizationId
  AND H.WAREHOUSEID = IN_warehouseId;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
  IF IFNULL(IN_waveNo, '') <> ''
    OR IFNULL(IN_orderNo, '') <> '' THEN
    OPEN cur_assign_sort_loc;
  getsortlocRec:
    LOOP
      FETCH cur_assign_sort_loc INTO v_soOrd, v_cust, v_stgLoc;
      IF finished = 1 THEN
        LEAVE getsortlocRec;
      ELSE
      BEGIN
        UPDATE ACT_ALLOCATION_DETAILS
        SET PICKTOLOCATION = v_stgLoc
        WHERE ORDERNO = v_soOrd
        AND CUSTOMERID = v_cust
        AND ORGANIZATIONID = IN_organizationId
        AND WAREHOUSEID = IN_warehouseId;

        UPDATE TSK_TASKLISTS
        SET PLANTOLOCATION = v_stgLoc
        WHERE DOCNO = v_soOrd
        AND CUSTOMERID = v_cust
        AND DOCTYPE = 'SO'
        AND TASKTYPE = 'PK'
        AND ORGANIZATIONID = IN_organizationId
        AND WAREHOUSEID = IN_warehouseId;
      END;
      END IF;
    END LOOP getsortlocRec;
    CLOSE cur_assign_sort_loc;
    SET @OUT_returnCode = '000';
  END IF;
END
$$

--
-- Create procedure `CML_GET_SORTING_STATION`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_GET_SORTING_STATION (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_waveNo varchar(30),
IN IN_orderNo varchar(30),
IN IN_userId varchar(40),
INOUT OUT_assortingStation varchar(20),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_customerId varchar(30);
  DECLARE v_assortingType,
          v_assortingId,
          v_assignedWave,
          v_assignedAssortingId,
          v_availableAssortingId,
          v_availableAssortingType,
          v_lastAssignedStation varchar(20);
  DECLARE v_totalSOCount,
          v_assertingLevels,
          v_assertingLines,
          v_totalPigeonHoles,
          v_availablePigeonHoles integer;
  DECLARE finished_flag integer DEFAULT 0;

  DECLARE cur_assortings CURSOR FOR
  SELECT
    h.assortingId,
    h.assortingType,
    h.levels,
    h.lineCount,
    (h.levels * h.lineCount) AS totalShelves
  FROM BAS_ASSORTING_HEADER h
  WHERE INSTR(h.assortingId, v_customerId) > 0
  AND h.activeFlag = 'Y'
  AND h.organizationId = IN_organizationId
  AND h.warehouseId = IN_warehouseId
  ORDER BY h.assortingId;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished_flag = 1;
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
    SET OUT_returnCode = '1521';
    SET OUT_assortingStation = '1520';
    ROLLBACK;
  END;
  SET v_availableAssortingId = '';
  SET OUT_returnCode = '000';
  SET OUT_assortingStation = '';
  SET v_lastAssignedStation = '';
  IF IFNULL(IN_waveNo, '') <> ''
    OR IFNULL(IN_orderNo, '') <> '' THEN
  BEGIN

    SELECT
      h.customerId,
      COUNT(orderNo) INTO v_customerId,
    v_totalSOCount
    FROM DOC_WAVE_HEADER h
      LEFT JOIN DOC_WAVE_DETAILS d
        ON d.waveNo = h.waveNo
        AND d.organizationId = h.organizationId
        AND d.warehouseId = h.warehouseId
    WHERE d.lineStatus = '00'
    AND (h.waveno = IFNULL(IN_waveNo, '')
    OR d.orderNo = IFNULL(IN_orderNo, ''))
    AND h.organizationId = IN_organizationId
    AND h.warehouseId = IN_warehouseId
    GROUP BY d.waveNo,
             h.customerId,
             h.assortingId,
             h.assortingType;
    IF IFNULL(v_customerId, '') <> '' THEN
    BEGIN

      SELECT
        assignedAssortingId INTO v_lastAssignedStation
      FROM ASSIGN_ASSORTING_STATION
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND customerId = v_customerId
      ORDER BY editTime DESC
      LIMIT 1;
      SET finished_flag = 0;

      OPEN cur_assortings;
    assortRec:
      LOOP
        FETCH cur_assortings
        INTO v_assortingId,
        v_assortingType,
        v_assertingLevels,
        v_assertingLines,
        v_totalPigeonHoles;
        IF finished_flag = 1 THEN
          LEAVE assortRec;
        ELSE


          SELECT
            COUNT(c.assortingId) INTO v_availablePigeonHoles
          FROM BAS_ASSORTING_DETAILS c
          WHERE NOT EXISTS (SELECT
              a.putToLocation
            FROM IDX_PUTTOLIGHT a
            WHERE a.organizationId = c.organizationId
            AND a.warehouseId = c.warehouseId
            AND a.putToLocation = c.assortingLoc
            AND a.taskProcess != '80')
          AND c.assortingId = v_assortingId;
          IF v_availablePigeonHoles = v_totalPigeonHoles THEN


            IF v_assortingId > v_lastAssignedStation
              AND v_availableAssortingId <= v_lastAssignedStation THEN
              SET v_assignedAssortingId = v_assortingId;
              SET v_availableAssortingType = v_assortingType;
            ELSEIF
              v_assortingId < v_lastAssignedStation
              AND v_assignedAssortingId = '' THEN
              SET v_assignedAssortingId = v_assortingId;
              SET v_availableAssortingType = v_assortingType;
            ELSEIF
              v_assortingId = v_lastAssignedStation
              AND (
              v_assignedAssortingId = ''
              OR v_assignedAssortingId > v_lastAssignedStation
              ) THEN
              SET v_assignedAssortingId = v_assortingId;
              SET v_availableAssortingType = v_assortingType;
            END IF;
          END IF;
        END IF;
      END LOOP assortRec;
      CLOSE cur_assortings;
      IF IFNULL(v_assignedAssortingId, '') = '' THEN
        SET v_assignedAssortingId = 'STATION';
      END IF;


      IF (SELECT
            1 = 1
          FROM ASSIGN_ASSORTING_STATION
          WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND customerId = v_customerId) THEN
        UPDATE ASSIGN_ASSORTING_STATION
        SET assignedAssortingId = v_assignedAssortingId,
            editTime = NOW()
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseId
        AND customerId = v_customerId;

      ELSE
        INSERT INTO ASSIGN_ASSORTING_STATION (organizationId,
        warehouseId,
        customerId,
        assignedAssortingId,
        ADDTIME,
        editTime)
          VALUES (IN_organizationId, IN_warehouseId, v_customerId, v_assignedAssortingId, NOW(), NOW());

      END IF;

      IF v_assignedAssortingId != ''
        AND v_assignedAssortingId != 'STATION' THEN
        UPDATE DOC_WAVE_HEADER
        SET assortingId = v_assignedAssortingId,
            assortingType = v_assortingType
        WHERE ORGANIZATIONID = IN_organizationId
        AND WAREHOUSEID = IN_warehouseId
        AND WAVENO IN (SELECT
            WAVENO
          FROM DOC_WAVE_DETAILS
          WHERE (ORDERNO = IN_orderNo
          OR WAVENO = IN_waveNo)
          AND ORGANIZATIONID = IN_organizationId
          AND WAREHOUSEID = IN_warehouseId);

        UPDATE ACT_ALLOCATION_DETAILS
        SET PICKTOLOCATION = v_assignedAssortingId
        WHERE WAVENO IN (SELECT
            WAVENO
          FROM DOC_WAVE_DETAILS
          WHERE (ORDERNO = IN_orderNo
          OR WAVENO = IN_waveNo)
          AND ORGANIZATIONID = IN_organizationId
          AND WAREHOUSEID = IN_warehouseId)
        AND ORGANIZATIONID = IN_organizationId
        AND WAREHOUSEID = IN_warehouseId;
      END IF;
    END;
    END IF;
    IF IFNULL(v_assignedAssortingId, '') != '' THEN
      SET OUT_assortingStation = v_assignedAssortingId;
      SET OUT_returnCode = '000';
    ELSEIF v_assignedAssortingId = 'STATION' THEN
      SET OUT_assortingStation = '1523';
      SET OUT_returnCode = '000';
    END IF;
  END;
  END IF;
END
$$

--
-- Create procedure `CML_ASSIGN_DOCKDOOR_STG_LOC`
--
CREATE 
	DEFINER = 'wms_cml'@'%'
PROCEDURE CML_ASSIGN_DOCKDOOR_STG_LOC(IN IN_organizationId VARCHAR(30), 
	  IN IN_warehouseId VARCHAR(30), 
	  IN IN_waveNo VARCHAR(30), 
	  IN IN_orderNo VARCHAR(30),
	  OUT OUT_stageAlloc_Code VARCHAR(1000),
	  OUT OUT_returnCode VARCHAR(1000))
DockDoor:BEGIN
DECLARE	v_max,v_maxallocated INTEGER;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
 BEGIN
	SET OUT_stageAlloc_Code = '1518';
	SET OUT_returnCode = '1519';
 END;
IF IFNULL(IN_waveNo, '')  <> '' AND IFNULL(IN_orderNo, '')  = '' THEN 
BEGIN
	IF ((SELECT COUNT(orderNo)
			 FROM ACT_ALLOCATION_DETAILS 
			 WHERE waveno=IN_waveNo
			 AND STATUS>40 
			 AND pickToLocation LIKE 'SORTATION%')>0) THEN
			SET OUT_stageAlloc_Code='1152';
			SET OUT_returnCode = '000';
			LEAVE DockDoor;
	ELSE
	/* Release the Staging Location */
	DELETE SL 
	FROM ASSIGN_DOCK_STG_LOC SL
	INNER JOIN DOC_LOADING_HEADER  LH ON SL.WAVENO=LH.WAVENO
	INNER JOIN DOC_ORDER_HEADER OH ON OH.WAVENO=LH.WAVENO
					AND OH.ORGANIZATIONID = LH.ORGANIZATIONID
					AND OH.WAREHOUSEID = LH.WAREHOUSEID
	WHERE LH.LDLSTATUS>=66
	-- AND LH.WAVENO = IN_waveNo
	AND OH.ORGANIZATIONID = IN_organizationId
	AND OH.WAREHOUSEID = IN_warehouseId;
	
	IF (SELECT EXISTS(SELECT waveno FROM ASSIGN_DOCK_STG_LOC WHERE waveNo IN (SELECT waveno FROM DOC_ORDER_HEADER doh  WHERE waveno =IN_waveNo)))!=0 THEN
	BEGIN
		INSERT INTO ASSIGN_DOCK_STG_LOC
			SELECT DISTINCT 
				IN_organizationId,
				IN_warehouseId,
				IN_waveNo,
				LOADNO,
				STGLOCATION,
				DOCKDOOR,
				ZONE,
				CURRENT_TIMESTAMP,
				DOH.orderNo
			FROM DOC_ORDER_HEADER DOH
			INNER JOIN ASSIGN_DOCK_STG_LOC DOCK ON DOH.waveNo = DOCK.waveno
			WHERE DOCK.waveno= IN_waveNo AND DOH.orderno NOT IN (SELECT orderno FROM ASSIGN_DOCK_STG_LOC) ;
	END;
	ELSE
	SET @x=0;
	DROP TEMPORARY TABLE IF EXISTS All_StgLocations;
	CREATE TEMPORARY TABLE All_StgLocations
	SELECT LOCATIONID,
			STGID,
			DOCKNO,
			ZONE,
			STGLOCATION
		FROM (
				SELECT C.* ,
					   @x := @x + 1 AS STGID
				FROM(
				SELECT L.LOCATIONID,
					   D.DOCKNO,
					   D.ZONE 
				FROM 
					BAS_LOCATION L
				INNER JOIN 
					(SELECT * 
						FROM (
						         SELECT ORGANIZATIONID,WAREHOUSEID,DOCKNO,UDF01 AS Zone FROM BAS_DOCK WHERE ACTIVEFLAG='Y' AND OPERATIONTYPE=200
						         UNION
						         SELECT ORGANIZATIONID,WAREHOUSEID,DOCKNO,UDF02 FROM BAS_DOCK WHERE ACTIVEFLAG='Y' AND OPERATIONTYPE=200
						         UNION
						         SELECT ORGANIZATIONID,WAREHOUSEID,DOCKNO,UDF03 FROM BAS_DOCK WHERE ACTIVEFLAG='Y' AND OPERATIONTYPE=200
						         UNION
						         SELECT ORGANIZATIONID,WAREHOUSEID,DOCKNO,UDF04 FROM BAS_DOCK WHERE ACTIVEFLAG='Y' AND OPERATIONTYPE=200
							  )A 
						WHERE Zone!=''
						ORDER BY 1)D ON SUBSTRING(L.LOCATIONID,4,LENGTH(L.LOCATIONID))= D.DOCKNO
									AND L.ORGANIZATIONID = D.ORGANIZATIONID
									AND L.WAREHOUSEID = D.WAREHOUSEID 
				WHERE L.LOCATIONID LIKE 'STG%'
				AND L.ORGANIZATIONID = IN_organizationId
				AND L.WAREHOUSEID = IN_warehouseId
				ORDER BY LOCATIONID)C
				ORDER BY 1 
		)LocDock
	LEFT JOIN
		(SELECT STGLOCATION,
				DOCKDOOR
		 FROM ASSIGN_DOCK_STG_LOC) assigned
				 ON LocDock.LOCATIONID=assigned.stgLocation 
				AND LocDock.dockNo=assigned.dockDoor;
	SELECT MAX(STGID) 
	INTO v_max 
	FROM All_StgLocations;
	
	SELECT IFNULL(MAX(STGID),0) 
	INTO v_maxallocated 
	FROM All_StgLocations
	WHERE STGLOCATION IS NOT NULL;
	
	IF v_max = v_maxallocated OR v_max IS NULL THEN
		SET v_maxallocated=0;
	END IF;
	
	SET @y=0;
	DROP TEMPORARY TABLE IF EXISTS Available_Locations;
	CREATE TEMPORARY TABLE Available_Locations
	SELECT
		LOCATIONID,
		DOCKNO,
		ZONE,
		STGID,
		@y := @y+1 AS ROWNUMBER
	FROM All_StgLocations
	WHERE (STGID > v_maxallocated)
	AND STGLOCATION IS NULL;
	
	IF ((SELECT COUNT(LOCATIONID) FROM Available_Locations)=0) THEN
		SET OUT_stageAlloc_Code='1151';
		LEAVE DockDoor;
	END IF;
	
	SET @z=0;
	DROP TEMPORARY TABLE IF EXISTS WAV_LOADNUMBER;
	CREATE TEMPORARY TABLE WAV_LOADNUMBER
	SELECT WAVENO,
	       LOADNUMBER,
	       ZONE,
               @z:=@z+1 AS ROWNUMBER
        FROM (SELECT  DISTINCT
			H.WAVENO,
			O.SOREFERENCE4 LOADNUMBER,
			A.ZONE
		FROM DOC_WAVE_HEADER H
		INNER JOIN DOC_ORDER_HEADER O ON O.WAVENO=H.WAVENO
								AND H.ORGANIZATIONID = O.ORGANIZATIONID
								AND H.WAREHOUSEID = O.WAREHOUSEID
		LEFT JOIN ASSIGN_DOCK_STG_LOC A ON A.WAVENO=H.WAVENO 
		WHERE O.WAVENO = IN_waveNo
		AND H.ORGANIZATIONID = IN_organizationId
		AND H.WAREHOUSEID = IN_warehouseId
		AND A.WAVENO IS NULL) Wavedetails;
	INSERT INTO ASSIGN_DOCK_STG_LOC
		SELECT 
			IN_organizationId,
			IN_warehouseId,
			W.WAVENO,
			W.LOADNUMBER,
			R.LOCATIONID,
			R.DOCKNO,
			W.ZONE,
			CURRENT_TIMESTAMP,
			DOH.orderNo
		FROM WAV_LOADNUMBER W
		INNER JOIN Available_Locations R ON W.ROWNUMBER=R.ROWNUMBER
		INNER JOIN DOC_ORDER_HEADER DOH ON DOH.waveNo = W.waveno
		WHERE DOH.orderno NOT IN (SELECT orderno FROM ASSIGN_DOCK_STG_LOC);
	END IF;	
	UPDATE ACT_ALLOCATION_DETAILS A
	INNER JOIN ASSIGN_DOCK_STG_LOC D ON D.WAVENO = A.WAVENO
							AND D.ORGANIZATIONID = A.ORGANIZATIONID
							AND D.WAREHOUSEID = A.WAREHOUSEID
	SET A.PICKTOLOCATION = D.STGLOCATION,
	    A.UDF01 = D.ZONE
	WHERE D.ORGANIZATIONID = IN_organizationId
	AND D.WAREHOUSEID = IN_warehouseId;
	
	UPDATE TSK_TASKLISTS A
	INNER JOIN DOC_ORDER_HEADER O ON O.ORDERNO=A.DOCNO 
					AND A.DOCTYPE='SO' 
					AND A.TASKTYPE='PK'
					AND A.ORGANIZATIONID = O.ORGANIZATIONID
					AND A.WAREHOUSEID = O.WAREHOUSEID
	INNER JOIN ASSIGN_DOCK_STG_LOC D ON D.WAVENO = O.WAVENO
					AND D.ORGANIZATIONID = O.ORGANIZATIONID
					AND D.WAREHOUSEID = O.WAREHOUSEID
	SET A.PLANTOLOCATION = D.STGLOCATION,
		A.UDF01 = D.ZONE
	WHERE D.ORGANIZATIONID = IN_organizationId
	AND D.WAREHOUSEID = IN_warehouseId;
END IF;
END;
ELSEIF IFNULL(IN_waveNo, '')  = '' AND IFNULL(IN_orderNo, '')  <> '' THEN
BEGIN
	IF ((SELECT COUNT(orderNo)
			 FROM ACT_ALLOCATION_DETAILS 
			 WHERE waveNo IN (SELECT DISTINCT waveNo FROM ACT_ALLOCATION_DETAILS WHERE orderNo= IN_orderNo)
			 AND STATUS>40 
			 AND pickToLocation LIKE 'SORTATION%')>0) 
			THEN
			SET OUT_stageAlloc_Code='1152';
			SET OUT_returnCode = '000';
			LEAVE DockDoor;
		
	ELSE
	/* Release the Staging Location */
	DELETE SL 
	FROM ASSIGN_DOCK_STG_LOC SL
	INNER JOIN DOC_LOADING_HEADER  LH ON SL.WAVENO=LH.WAVENO
	INNER JOIN DOC_ORDER_HEADER OH ON OH.WAVENO=LH.WAVENO
					AND SL.ORDERNO=OH.ORDERNO
					AND OH.ORGANIZATIONID = LH.ORGANIZATIONID
					AND OH.WAREHOUSEID = LH.WAREHOUSEID
	WHERE LH.LDLSTATUS>=66
	-- AND OH.ORDERNO = IN_orderNo
	AND OH.ORGANIZATIONID = IN_organizationId
	AND OH.WAREHOUSEID = IN_warehouseId;
	
	IF (SELECT EXISTS(SELECT waveno FROM ASSIGN_DOCK_STG_LOC WHERE waveNo IN (SELECT waveno FROM DOC_ORDER_HEADER doh  WHERE orderno=IN_orderNo)))!=0 THEN-- (SELECT EXISTS (SELECT waveno FROM ASSIGN_DOCK_STG_LOC WHERE orderno=IN_orderNo))!=0  THEN
	
	BEGIN	
		INSERT INTO ASSIGN_DOCK_STG_LOC
			SELECT DISTINCT 
				IN_organizationId,
				IN_warehouseId,
				WAVENO,
				LOADNO,
				STGLOCATION,
				DOCKDOOR,
				ZONE,
				CURRENT_TIMESTAMP,
				IN_orderNo
			FROM ASSIGN_DOCK_STG_LOC 
			WHERE waveno= (SELECT DISTINCT waveno FROM DOC_ORDER_HEADER WHERE orderno=IN_orderNo) ;
	END;
	ELSE
	BEGIN
	SET @x=0;
	DROP TEMPORARY TABLE IF EXISTS All_StgLocations;
	CREATE TEMPORARY TABLE All_StgLocations
	SELECT LOCATIONID,
			STGID,
			DOCKNO,
			ZONE,
			STGLOCATION
		FROM (
				SELECT C.* ,
					   @x := @x + 1 AS STGID
				FROM(
				SELECT L.LOCATIONID,
					   D.DOCKNO,
					   D.ZONE 
				FROM 
					BAS_LOCATION L
				INNER JOIN 
					(SELECT * 
						FROM (
							 SELECT ORGANIZATIONID,WAREHOUSEID,DOCKNO,UDF01 AS Zone FROM BAS_DOCK WHERE ACTIVEFLAG='Y' AND OPERATIONTYPE=200
							 UNION
							 SELECT ORGANIZATIONID,WAREHOUSEID,DOCKNO,UDF02 FROM BAS_DOCK WHERE ACTIVEFLAG='Y' AND OPERATIONTYPE=200
							 UNION
							 SELECT ORGANIZATIONID,WAREHOUSEID,DOCKNO,UDF03 FROM BAS_DOCK WHERE ACTIVEFLAG='Y' AND OPERATIONTYPE=200
							 UNION
							 SELECT ORGANIZATIONID,WAREHOUSEID,DOCKNO,UDF04 FROM BAS_DOCK WHERE ACTIVEFLAG='Y' AND OPERATIONTYPE=200
							  )A 
						WHERE Zone!=''
						ORDER BY 1)D ON SUBSTRING(L.LOCATIONID,4,LENGTH(L.LOCATIONID))= D.DOCKNO
									AND L.ORGANIZATIONID = D.ORGANIZATIONID
									AND L.WAREHOUSEID = D.WAREHOUSEID 
				WHERE L.LOCATIONID LIKE 'STG%'
				AND L.ORGANIZATIONID = IN_organizationId
				AND L.WAREHOUSEID = IN_warehouseId
				ORDER BY LOCATIONID)C
				ORDER BY 1 
		)LocDock
	LEFT JOIN
		(SELECT STGLOCATION,
				DOCKDOOR
		 FROM ASSIGN_DOCK_STG_LOC) assigned
				 ON LocDock.LOCATIONID=assigned.stgLocation 
				AND LocDock.dockNo=assigned.dockDoor;
	SELECT MAX(STGID) 
	INTO v_max 
	FROM All_StgLocations;
	
	SELECT IFNULL(MAX(STGID),0) 
	INTO v_maxallocated 
	FROM All_StgLocations
	WHERE STGLOCATION IS NOT NULL;
	
	IF v_max = v_maxallocated OR v_max IS NULL THEN
		SET v_maxallocated=0;
	END IF;
	
	SET @y=0;
	DROP TEMPORARY TABLE IF EXISTS Available_Locations;
	CREATE TEMPORARY TABLE Available_Locations
	SELECT
		LOCATIONID,
		DOCKNO,
		ZONE,
		STGID,
		@y := @y+1 AS ROWNUMBER
	FROM All_StgLocations
	WHERE (STGID > v_maxallocated)
	AND STGLOCATION IS NULL;
	
	IF ((SELECT COUNT(LOCATIONID) FROM Available_Locations)=0) THEN
		SET OUT_stageAlloc_Code='1151';
		LEAVE DockDoor;
	END IF;
	
	SET @z=0;
	DROP TEMPORARY TABLE IF EXISTS WAV_LOADNUMBER;
	CREATE TEMPORARY TABLE WAV_LOADNUMBER
	SELECT WAVENO,
	       ORDERNO,
	       LOADNUMBER,
	       ZONE,
               @z:=@z+1 AS ROWNUMBER
        FROM (SELECT  DISTINCT
			H.WAVENO,
			O.ORDERNO,
			O.SOREFERENCE3 LOADNUMBER,
			A.ZONE
		FROM DOC_WAVE_HEADER H
		INNER JOIN DOC_ORDER_HEADER O ON O.WAVENO=H.WAVENO
						AND H.ORGANIZATIONID = O.ORGANIZATIONID
						AND H.WAREHOUSEID = O.WAREHOUSEID
		LEFT JOIN ASSIGN_DOCK_STG_LOC A ON A.WAVENO=H.WAVENO 
						 AND A.ORDERNO=O.ORDERNO
		WHERE O.ORDERNO = IN_orderNo
		AND H.ORGANIZATIONID = IN_organizationId
		AND H.WAREHOUSEID = IN_warehouseId
		AND A.WAVENO IS NULL) Orddetails;
	INSERT INTO ASSIGN_DOCK_STG_LOC
		SELECT 
			IN_organizationId,
			IN_warehouseId,
			W.WAVENO,
			W.LOADNUMBER,
			R.LOCATIONID,
			R.DOCKNO,
			W.ZONE,
			CURRENT_TIMESTAMP,
			W.ORDERNO
		FROM WAV_LOADNUMBER W
		INNER JOIN Available_Locations R ON W.ROWNUMBER=R.ROWNUMBER;
	
	END;
	END IF;
	UPDATE ACT_ALLOCATION_DETAILS A
	INNER JOIN ASSIGN_DOCK_STG_LOC D ON D.WAVENO = A.WAVENO
									AND D.ORGANIZATIONID = A.ORGANIZATIONID
									AND D.WAREHOUSEID = A.WAREHOUSEID
	  SET A.PICKTOLOCATION = D.STGLOCATION,
	      A.UDF01 = D.ZONE
	  WHERE A.WAVENO IN (SELECT WAVENO 
	  				   FROM DOC_WAVE_DETAILS 
	  				   WHERE ORDERNO = IN_orderNo
	  				   AND ORGANIZATIONID  = IN_organizationId
	   				   AND WAREHOUSEID = IN_warehouseId)	
	  AND A.ORGANIZATIONID  = IN_organizationId
	  AND A.WAREHOUSEID = IN_warehouseId; 
	UPDATE TSK_TASKLISTS	A
	INNER JOIN DOC_ORDER_HEADER B
		ON B.organizationId = A.organizationId
		AND B.warehouseId = A.warehouseId
		AND B.orderNo = A.docNo
	INNER JOIN DOC_WAVE_DETAILS C
		ON C.organizationId = B.organizationId
		AND C.warehouseId = B.warehouseId
		AND C.waveNo = B.waveNo
	INNER JOIN ASSIGN_DOCK_STG_LOC D 
		ON D.waveNo = C.WaveNo 
		AND D.ORGANIZATIONID = C.ORGANIZATIONID
		AND D.WAREHOUSEID = C.WAREHOUSEID
	SET A.PLANTOLOCATION = D.STGLOCATION,
		A.UDF01 = D.ZONE
	WHERE 1=1
	AND A.ORGANIZATIONID  = IN_organizationId
	AND A.WAREHOUSEID = IN_warehouseId
	AND A.DOCTYPE='SO' 
	AND A.TASKTYPE='PK'
	AND C.orderNo = IN_orderNo; 	 
END IF;
END;
END IF;
	SET OUT_stageAlloc_Code = '000';
	SET OUT_returnCode = '000';
END DockDoor
$$

--
-- Create procedure `CML_ASSIGN_STG_LOCATIONS`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_ASSIGN_STG_LOCATIONS (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
IN IN_waveNo varchar(20),
IN IN_orderNo varchar(20),
OUT OUT_assortingStation varchar(1000),
OUT OUT_stageAlloc_Code varchar(1000),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_customerId,
          v_orderType,
          v_orderno varchar(20);
  DECLARE OUT_stageAlloc_Code varchar(20);
  DECLARE finished integer DEFAULT 0;
  /*
  DECLARE cur_orders CURSOR FOR
                 SELECT o.orderNo,
                                   o.orderType,
                                   o.customerId
                 FROM DOC_WAVE_DETAILS w
                 INNER JOIN DOC_ORDER_HEADER o ON w.orderNo = o.OrderNo
                                                                AND w.WAVENO=o.WAVENO
                                                                AND w.organizationId = o.organizationId
                                                                AND w.warehouseId = o.warehouseId
                 WHERE (w.waveno = IFNULL(IN_waveNo,'') OR o.orderNo = IFNULL(IN_orderNo,''))
                 AND w.organizationId = IN_organizationId
                 AND w.warehouseId = IN_warehouseId;
  */
  DECLARE cur_orders CURSOR FOR
  SELECT
    o.orderNo,
    o.orderType,
    o.customerId
  FROM DOC_WAVE_DETAILS w
    INNER JOIN DOC_ORDER_HEADER o
      ON w.orderNo = o.OrderNo
      AND w.WAVENO = o.WAVENO
      AND w.organizationId = o.organizationId
      AND w.warehouseId = o.warehouseId
  WHERE -- (w.waveno = IFNULL(IN_waveNo, '')
  -- OR 
  o.orderNo = IFNULL(IN_orderNo, '')-- )
  AND w.organizationId = IN_organizationId
  AND w.warehouseId = IN_warehouseId -- ; 
  UNION ALL
  SELECT
    o.orderNo,
    o.orderType,
    o.customerId
  FROM DOC_WAVE_DETAILS w
    INNER JOIN DOC_ORDER_HEADER o
      ON w.orderNo = o.OrderNo
      AND w.WAVENO = o.WAVENO
      AND w.organizationId = o.organizationId
      AND w.warehouseId = o.warehouseId
  WHERE -- (
  w.waveno = IFNULL(IN_waveNo, '')
  -- OR o.orderNo = IFNULL(IN_orderNo, ''))
  AND w.organizationId = IN_organizationId
  AND w.warehouseId = IN_warehouseId;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
  IF (IFNULL(IN_waveNo, '') <> ''
    OR IFNULL(IN_orderNo, '') <> '') THEN
    OPEN cur_orders;
  getordRec:
    LOOP
      FETCH cur_orders INTO v_orderno, v_orderType, v_customerId;
      IF finished = 1 THEN
        LEAVE getordRec;
      ELSE
      BEGIN
        IF v_orderType IN ('Inter-warehouse transfer', 'RT') THEN
          SET OUT_assortingStation = '000';
          CALL CML_ASSIGN_DOCKDOOR_STG_LOC(IN_organizationId, IN_warehouseId, IN_waveNo, IN_orderNo, OUT_stageAlloc_Code, OUT_returnCode);
        ELSE
          IF v_customerId IN ('ZAP') THEN
            SET OUT_stageAlloc_Code = '000';
            CALL CML_GET_SORTING_STATION(IN_organizationId, IN_warehouseId, IN_waveNo, IN_orderNo, IN_userId, OUT_assortingStation, OUT_returnCode);
          ELSEIF v_customerId IN ('BCA') THEN
            SET OUT_assortingStation = '000';
            SET OUT_stageAlloc_Code = '000';
            CALL CML_ASSIGN_CUSTSORT_STG_LOC(IN_organizationId, IN_warehouseId, IN_waveNo, IN_orderNo, OUT_returnCode);
          ELSE
            SET OUT_assortingStation = '000';
            CALL CML_ASSIGN_DOCKDOOR_STG_LOC(IN_organizationId, IN_warehouseId, IN_waveNo, IN_orderNo, OUT_stageAlloc_Code, OUT_returnCode);
          END IF;
        END IF;
      END;
      END IF;
    END LOOP getordRec;
    CLOSE cur_orders;
    SET OUT_returnCode = '000';
  END IF;
END
$$

--
-- Create procedure `Z_UPDATESTART_PUTAWAY`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE Z_UPDATESTART_PUTAWAY (IN p_organizationId varchar(20),
IN p_warehouseId varchar(20),
IN p_traceid varchar(20),
IN p_datetimeptw varchar(500),
IN p_tolocation varchar(100),
IN p_sku varchar(100),
OUT return_code varchar(1000))
BEGIN
  UPDATE ACT_TRANSACTION_LOG
  SET udf01 = DATE_FORMAT(p_datetimeptw, '%Y-%m-%d %H:%i:%s'),
      editTime = NOW()
  WHERE organizationId = p_organizationId
  AND warehouseId = p_warehouseId
  AND toId = p_traceid
  AND transactionType = 'PA'
  AND toSku = p_sku
  AND toLocation = p_tolocation;
  SET return_code = '000';
END
$$

--
-- Create procedure `Z_STOCKCOUNTVAL`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE Z_STOCKCOUNTVAL (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_UserId varchar(30),
IN IN_TransNo longtext)
ENDPROC:
  BEGIN
    DECLARE delimiterChar longtext;
    DECLARE inputString longtext;
    DECLARE OUT_returnCode varchar(1000);

    DROP TEMPORARY TABLE IF EXISTS temp_transnoStock;
    CREATE TEMPORARY TABLE temp_transnoStock (
      vals longtext
    );


    SET delimiterChar = ',';
    SET inputString = IN_TransNo;
    WHILE LOCATE(delimiterChar, inputString) > 1 DO

      SELECT
        LOCATE(delimiterChar, inputString);
      INSERT INTO temp_transnoStock
        SELECT
          SUBSTRING_INDEX (inputString, delimiterChar, 1);
      SET inputString = REPLACE(inputString, (SELECT
          LEFT(inputString, LOCATE(delimiterChar, inputString))), '');
    END WHILE;


    INSERT INTO temp_transnoStock (vals)
      VALUES (inputString);





    BEGIN


      DECLARE r_organizationId varchar(20);
      DECLARE r_warehouseId varchar(20);
      DECLARE r_no varchar(30);
      DECLARE stockcount_sm_done,
              attribute_done int DEFAULT 0;





      UPDATE BAS_CYCLE_DETAILS bs
      SET bs.udf01 = 'VALIDATED',
          editTime = NOW(),
          bs.editWho = IN_UserId
      WHERE LTRIM(RTRIM(bs.no)) IN (SELECT
          vals
        FROM temp_transnoStock)
      AND bs.organizationId = IN_organizationId
      AND bs.warehouseId = IN_warehouseId;





      DROP TEMPORARY TABLE IF EXISTS temp_transnoStock;
      COMMIT;
    END;
  END
  $$

--
-- Create procedure `Z_STOCKCOUNTARC`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE Z_STOCKCOUNTARC (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_UserId varchar(30),
IN IN_TransNo longtext)
ENDPROC:
  BEGIN
    DECLARE delimiterChar longtext;
    DECLARE inputString longtext;
    DECLARE OUT_returnCode varchar(1000);

    DROP TEMPORARY TABLE IF EXISTS temp_transnoStock;
    CREATE TEMPORARY TABLE temp_transnoStock (
      vals longtext
    );


    SET delimiterChar = ',';
    SET inputString = IN_TransNo;
    WHILE LOCATE(delimiterChar, inputString) > 1 DO

      SELECT
        LOCATE(delimiterChar, inputString);
      INSERT INTO temp_transnoStock
        SELECT
          SUBSTRING_INDEX (inputString, delimiterChar, 1);
      SET inputString = REPLACE(inputString, (SELECT
          LEFT(inputString, LOCATE(delimiterChar, inputString))), '');
    END WHILE;


    INSERT INTO temp_transnoStock (vals)
      VALUES (inputString);





    BEGIN


      DECLARE r_organizationId varchar(20);
      DECLARE r_warehouseId varchar(20);
      DECLARE r_no varchar(30);
      DECLARE stockcount_sm_done,
              attribute_done int DEFAULT 0;





      UPDATE Z_BAS_CYCLE_DETAILS bs
      SET bs.udf02 = 'archieve',
          editTime = NOW(),
          bs.editWho = IN_UserId
      WHERE LTRIM(RTRIM(bs.no)) IN (SELECT
          vals
        FROM temp_transnoStock)
      AND bs.organizationId = IN_organizationId
      AND bs.warehouseId = IN_warehouseId;





      DROP TEMPORARY TABLE IF EXISTS temp_transnoStock;
      COMMIT;
    END;
  END
  $$

--
-- Create procedure `Z_sp_UpdateCycleCount`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE Z_sp_UpdateCycleCount (IN p_organizationId varchar(50),
IN p_warehouseId varchar(50),
IN p_idDocumentCycle varchar(50),
IN p_idDocumentDetailCycle varchar(50),
IN p_groupIdTask varchar(200),
IN p_counting_qty decimal(23, 8),
OUT p_return_code varchar(3))
BEGIN
  -- Deklarasi variabel untuk menyimpan data existing
  DECLARE v_idDocumentDetailCycle varchar(50);
  DECLARE v_count1 decimal(23, 8);
  DECLARE v_count2 decimal(23, 8);
  DECLARE v_count3 decimal(23, 8);
  DECLARE v_count1Status varchar(1);
  DECLARE v_count2Status varchar(1);
  DECLARE v_count3Status varchar(1);
  DECLARE v_row_count int;

  -- Handler untuk error
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
    -- Rollback jika terjadi error
    ROLLBACK;
    SET p_return_code = '444';
  END;

  -- Mulai transaksi
  START TRANSACTION;

    -- Ambil data existing dari tabel dengan tambahan kondisi groupIdTask
    SELECT
      idDocumentDetailCycle,
      count1,
      count2,
      count3,
      count1Status,
      count2Status,
      count3Status INTO v_idDocumentDetailCycle,
    v_count1,
    v_count2,
    v_count3,
    v_count1Status,
    v_count2Status,
    v_count3Status
    FROM Z_CYCLECOUNT_DETAIL
    WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
    AND idDocumentCycle = p_idDocumentCycle
    AND organizationId = p_organizationId
    AND warehouseId = p_warehouseId
    AND UPPER(groupIdTask) = UPPER(p_groupIdTask);

    -- Cek apakah data ditemukan
    SELECT
      ROW_COUNT() INTO v_row_count;

    IF v_row_count = 0 THEN
      -- Data tidak ditemukan
      SET p_return_code = '444';
      ROLLBACK;
    ELSE
      -- Logic untuk update berdasarkan kondisi

      -- Cycle-1
      IF v_count1Status = 'N' THEN
        UPDATE Z_CYCLECOUNT_DETAIL
        SET count1 = p_counting_qty,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);



        -- ### LOGIC STATUS

        UPDATE Z_CYCLECOUNT_DETAIL
        SET countStatus = CASE WHEN qtyOnHand = IFNULL(count1, 0) THEN 'MATCH' ELSE 'UNMATCH' END,
            udf01 = CASE WHEN qtyOnHand = IFNULL(count1, 0) THEN 'S' ELSE 'TO_C2' END,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);

        -- ## UPDATE QTY countDifferent & countFinal

        UPDATE Z_CYCLECOUNT_DETAIL
        SET countDifferent = CASE WHEN qtyOnHand = IFNULL(count1, 0) THEN 0 ELSE (count1 - IFNULL(qtyOnHand, 0)) END,
            countFinal = CASE WHEN qtyOnHand = IFNULL(count1, 0) THEN IFNULL(count1, 0) ELSE IFNULL(count1, 0) END,
            count2 = CASE WHEN qtyOnHand = IFNULL(count1, 0) THEN 0 ELSE NULL END,
            count3 = CASE WHEN qtyOnHand = IFNULL(count1, 0) THEN 0 ELSE NULL END,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);




        SET p_return_code = '000';
      ELSEIF
        -- Cycle-2
        v_count1Status = 'Y'
        AND v_count2Status = 'N' THEN

        UPDATE Z_CYCLECOUNT_DETAIL
        SET count2 = p_counting_qty,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);
        --  AND udf01 NOT IN ('S');

        -- ### LOGIC STATUS

        UPDATE Z_CYCLECOUNT_DETAIL
        SET countStatus = CASE WHEN qtyOnHand = IFNULL(count2, 0) THEN 'MATCH' WHEN qtyOnHand <> IFNULL(count2, 0) AND
                IFNULL(count1, 0) <> IFNULL(count2, 0) THEN 'UNMATCH' ELSE 'UNMATCH' END,
            udf01 = CASE WHEN (qtyOnHand = IFNULL(count2, 0)) OR
                (IFNULL(count1, 0) = IFNULL(count2, 0)) THEN 'S' WHEN (qtyOnHand <> IFNULL(count2, 0)) AND
                (IFNULL(count1, 0) <> IFNULL(count2, 0)) THEN 'TO_C3' ELSE 'TO_C3' END,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);
        --  AND udf01 NOT IN ('S');

        -- ## UPDATE QTY countDifferent & countFinal

        UPDATE Z_CYCLECOUNT_DETAIL
        SET countDifferent = CASE WHEN qtyOnHand = IFNULL(count2, 0) THEN 0 ELSE (count2 - IFNULL(qtyOnHand, 0)) END,
            countFinal = CASE WHEN qtyOnHand = IFNULL(count2, 0) THEN IFNULL(count2, 0) ELSE IFNULL(count2, 0) END,
            count3 = CASE WHEN (qtyOnHand = IFNULL(count2, 0)) OR
                (IFNULL(count1, 0) = IFNULL(count2, 0)) THEN 0 ELSE NULL END,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);
        --  AND udf01 NOT IN ('S');


        SET p_return_code = '000';

      ELSEIF
        -- Cycle 3
        v_count1Status = 'Y'
        AND v_count2Status = 'Y'
        AND v_count3Status = 'N' THEN

        UPDATE Z_CYCLECOUNT_DETAIL
        SET count3 = p_counting_qty,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);
        -- AND udf01 NOT IN ('S');


        -- ### LOGIC STATUS

        UPDATE Z_CYCLECOUNT_DETAIL
        SET countStatus = CASE WHEN qtyOnHand = IFNULL(count3, 0) THEN 'MATCH' WHEN qtyOnHand <> IFNULL(count3, 0) AND
                IFNULL(count2, 0) <> IFNULL(count3, 0) THEN 'UNMATCH' ELSE 'UNMATCH' END,
            udf01 = CASE WHEN qtyOnHand = IFNULL(count3, 0) OR
                IFNULL(count2, 0) = IFNULL(count3, 0) THEN 'S' WHEN qtyOnHand <> IFNULL(count3, 0) AND
                IFNULL(count2, 0) <> IFNULL(count3, 0) THEN 'S' ELSE 'S' END,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);
        --  AND udf01 NOT IN ('S');

        -- ## UPDATE QTY countDifferent & countFinal

        UPDATE Z_CYCLECOUNT_DETAIL
        SET countDifferent = CASE WHEN qtyOnHand = IFNULL(count3, 0) THEN 0 ELSE (count3 - IFNULL(qtyOnHand, 0)) END,
            countFinal = CASE WHEN qtyOnHand = IFNULL(count3, 0) THEN IFNULL(count3, 0) ELSE IFNULL(count3, 0) END,
            editTime = NOW(),
            editWho = USER()
        WHERE idDocumentDetailCycle = p_idDocumentDetailCycle
        AND idDocumentCycle = p_idDocumentCycle
        AND organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask);
        --   AND udf01 NOT IN ('S');

        SET p_return_code = '000';

      ELSE
        -- Kondisi tidak memenuhi syarat untuk update
        SET p_return_code = '444';
        ROLLBACK;
      END IF;
    END IF;

    -- Commit jika berhasil
    IF p_return_code = '000' THEN
      COMMIT;
    END IF;

END
$$

--
-- Create procedure `Z_sp_send_email`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE Z_sp_send_email (IN p_to_emails text,           -- Multiple emails separated by semicolon
IN p_subject varchar(500),
IN p_body text,
IN p_is_html boolean,
IN p_cc_emails text,
IN p_bcc_emails text,
IN p_attachments text,
IN p_secret_key text,
OUT p_status varchar(20),
OUT p_message text)
endproc:
  BEGIN
    DECLARE v_credential_id int;
    DECLARE v_smtp_host varchar(255);
    DECLARE v_smtp_port int;
    DECLARE v_smtp_username varchar(255);
    DECLARE v_smtp_password varchar(255);
    DECLARE v_smtp_from_email varchar(255);
    DECLARE v_smtp_from_name varchar(100);
    DECLARE v_smtp_url varchar(500);
    DECLARE v_can_send boolean DEFAULT FALSE;
    DECLARE v_remaining_quota int;
    DECLARE v_recipient_count int;
    DECLARE p_log_id int;
    DECLARE v_result varchar(1024);


    --  START TRANSACTION;

    -- Step 1: Get and validate credentials

    SELECT
      id,
      smtp_host,
      smtp_port,
      smtp_username,
      AES_DECRYPT(smtp_password, p_secret_key),
      smtp_from_email,
      smtp_from_name INTO v_credential_id, v_smtp_host, v_smtp_port, v_smtp_username,
    v_smtp_password, v_smtp_from_email, v_smtp_from_name
    FROM Z_smtp_credentials
    WHERE profile_name = 'linc_information'
    AND is_active = 1
    LIMIT 1;



    -- Step 2: Count recipients
    SET v_recipient_count = (
    LENGTH(p_to_emails) - LENGTH(REPLACE(p_to_emails, ';', '')) + 1 +
    IFNULL(LENGTH(p_cc_emails) - LENGTH(REPLACE(p_cc_emails, ';', '')) + 1, 0) +
    IFNULL(LENGTH(p_bcc_emails) - LENGTH(REPLACE(p_bcc_emails, ';', '')) + 1, 0)
    );

    -- Step 5: Build SMTP URL
    SET v_smtp_url = CONCAT('smtp://', v_smtp_host, ':', v_smtp_port);

    -- Step 5: Log email attempt
    INSERT INTO Z_smtp_send_log (credential_id, recipient_emails, subject,
    body_type, attachments_count, status)
      VALUES (v_credential_id, CONCAT_WS(';', p_to_emails, p_cc_emails, p_bcc_emails), p_subject, IF(p_is_html, 'html', 'text'), IF(p_attachments IS NULL, 0, LENGTH(p_attachments) - LENGTH(REPLACE(p_attachments, ';', '')) + 1), 'pending');

    SET p_log_id = LAST_INSERT_ID();

    -- Step 6: Build full recipient list
    SET @full_recipients = p_to_emails;
    IF p_cc_emails IS NOT NULL THEN
      SET @full_recipients = CONCAT(@full_recipients, ';', p_cc_emails);
    END IF;
    IF p_bcc_emails IS NOT NULL THEN
      SET @full_recipients = CONCAT(@full_recipients, ';', p_bcc_emails);
    END IF;

    -- Step 7: Build email body with headers
    SET @email_body = p_body;
    IF p_is_html
      AND LOCATE('<html>', LOWER(p_body)) = 0 THEN
      SET @email_body = CONCAT('<html><body>', p_body, '</body></html>');
    END IF;
    SET v_result = smtp_send(v_smtp_url,
    v_smtp_username,
    v_smtp_password,
    CONCAT(v_smtp_from_email, IF(v_smtp_from_name IS NOT NULL,
    CONCAT(' <', v_smtp_from_name, '>'), '')),
    @full_recipients,
    p_subject,
    @email_body,
    IFNULL(p_attachments, ''));


  --   COMMIT;

  END
  $$

--
-- Create procedure `Z_sp_insert_smtp_credential`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE Z_sp_insert_smtp_credential (IN p_profile_name varchar(50),
IN p_smtp_host varchar(255),
IN p_smtp_port int,
IN p_smtp_username varchar(255),
IN p_smtp_password varchar(255),
IN p_smtp_from_email varchar(255),
IN p_secret_key varchar(32))
BEGIN
  INSERT INTO Z_smtp_credentials (profile_name, smtp_host, smtp_port,
  smtp_username, smtp_password, smtp_from_email)
    VALUES (p_profile_name, p_smtp_host, p_smtp_port, p_smtp_username, AES_ENCRYPT(p_smtp_password, p_secret_key), p_smtp_from_email);
END
$$

--
-- Create procedure `Z_sp_CompletePositionCycle`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE Z_sp_CompletePositionCycle (IN p_organizationId varchar(50),
IN p_warehouseId varchar(50),
IN p_idDocumentCycle varchar(50),
IN p_groupIdTask varchar(200),
OUT p_returnCode varchar(3))
BEGIN
  -- Deklarasi variabel
  DECLARE v_rowCount int DEFAULT 0;
  DECLARE v_cycleType int DEFAULT 0;

  -- Deklarasi handler untuk error
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
    SET p_returnCode = '444';
    ROLLBACK;
  END;

  -- Mulai transaksi
  START TRANSACTION;

    -- Set default return code
    SET p_returnCode = '000';

    -- Tentukan cycle type yang akan diproses
    -- Prioritas: Cycle 1 -> Cycle 2 -> Cycle 3
    SELECT
      CASE WHEN count1Status = 'N' AND
          count2Status = 'N' AND
          count3Status = 'N' THEN 1 WHEN count1Status = 'Y' AND
          count2Status = 'N' AND
          count3Status = 'N' THEN 2 WHEN count1Status = 'Y' AND
          count2Status = 'Y' AND
          count3Status = 'N' THEN 3 ELSE 0 END INTO v_cycleType
    FROM Z_CYCLECOUNT_DETAIL
    WHERE organizationId = p_organizationId
    AND warehouseId = p_warehouseId
    AND idDocumentCycle = p_idDocumentCycle
    AND UPPER(groupIdTask) = UPPER(p_groupIdTask)
    LIMIT 1;

    -- Cek apakah ada data yang perlu diproses
    IF v_cycleType = 0 THEN
      SET p_returnCode = '444';
      ROLLBACK;
    ELSE
      -- Process berdasarkan cycle type
      IF v_cycleType = 1 THEN
        -- CYCLE 1 Processing
        UPDATE Z_CYCLECOUNT_DETAIL
        SET


        -- Update status flags
        count1Status = 'Y',

        -- Update audit fields
        editTime = NOW(),
        editWho = USER()
        WHERE organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND idDocumentCycle = p_idDocumentCycle
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask)
        AND count1Status = 'N'
        AND count2Status = 'N'
        AND count3Status = 'N';

      ELSEIF v_cycleType = 2 THEN
        -- CYCLE 2 Processing
        UPDATE Z_CYCLECOUNT_DETAIL
        SET


        -- Update status flags
        count2Status = 'Y',



        -- Update audit fields
        editTime = NOW(),
        editWho = USER()
        WHERE organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND idDocumentCycle = p_idDocumentCycle
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask)
        AND count1Status = 'Y'
        AND count2Status = 'N'
        AND count3Status = 'N';

      ELSEIF v_cycleType = 3 THEN
        -- CYCLE 3 Processing
        UPDATE Z_CYCLECOUNT_DETAIL
        SET
        -- Update count3 jika NULL
        count3 = IFNULL(count3, 0),

        -- Update status flag
        count3Status = 'Y',



        -- Update audit fields
        editTime = NOW(),
        editWho = USER()
        WHERE organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND idDocumentCycle = p_idDocumentCycle
        AND UPPER(groupIdTask) = UPPER(p_groupIdTask)
        AND count1Status = 'Y'
        AND count2Status = 'Y'
        AND count3Status = 'N';
      END IF;

      -- Get affected rows untuk validasi
      SELECT
        ROW_COUNT() INTO v_rowCount;

      IF v_rowCount > 0 THEN
        -- Commit transaksi jika ada row yang diupdate
        COMMIT;
        SET p_returnCode = '000';
      ELSE
        -- Rollback jika tidak ada row yang diupdate
        ROLLBACK;
        SET p_returnCode = '444';
      END IF;
    END IF;

END
$$

--
-- Create procedure `Z_SPLITOVERTIME`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_SPLITOVERTIME (IN p_customerid varchar(255),
IN p_warehouseid varchar(255),
IN p_userid varchar(255),
IN p_time_in datetime,
IN p_time_out datetime,
IN p_break_time decimal(5, 2))
BEGIN
  DECLARE v_total_minutes int;
  DECLARE v_total_hours decimal(5, 2);
  DECLARE v_day_type varchar(10);
  DECLARE v_day_of_week int;

  DECLARE done int DEFAULT FALSE;
  DECLARE v_label varchar(50);
  DECLARE v_lower decimal(5, 2);
  DECLARE v_upper decimal(5, 2);

  -- Untuk Ngetracking Time
  DECLARE v_start_time datetime;
  DECLARE v_segment_start datetime;
  DECLARE v_segment_end datetime;
  DECLARE v_segment_hours decimal(5, 2);

  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(255);
  DECLARE v_customerId varchar(255);
  DECLARE v_overtimeType varchar(255);
  DECLARE v_totalOt decimal(5, 2);
  DECLARE v_codeType varchar(255);
  DECLARE v_codeId varchar(255);
  DECLARE v_outerCode varchar(255);

  DECLARE cat_cursor CURSOR FOR

  SELECT
    zto.organizationId,
    zto.warehouseId,
    zto.customerId,
    zto.overtimeType,
    zto.totalOt,
    bcm.codeType,
    bcm.codeId,
    bm1.outerCode
  FROM Z_TEMP_OT zto
    LEFT JOIN BSM_CODE_ML bcm
      ON bcm.organizationId = zto.organizationId
      AND bcm.codeDescr = zto.overtimeType
      AND bcm.codeType = 'Z_OT_TYPE'
      AND bcm.languageId = 'en'
    LEFT JOIN BSM_CODE bm1
      ON bm1.organizationId = bcm.organizationId
      AND bm1.codeType = bcm.codeType
      AND bm1.codeId = bcm.codeId
  WHERE zto.organizationId = 'OJV_CML'
  AND zto.customerId = 'PT.ABC'
  AND zto.warehouseId = 'CBT01'
  AND zto.splitFlag = 'N';

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  OPEN cat_cursor;

read_loop:
  LOOP
    FETCH cat_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_overtimeType, v_totalOt,
    v_codeType, v_codeId, v_outerCode;

    IF done THEN
      LEAVE read_loop;
    END IF;

    BEGIN
      DECLARE b_organizationId varchar(255);
      DECLARE b_warehouseId varchar(255);
      DECLARE b_customerId varchar(255);
      DECLARE b_billingdate varchar(255);
      DECLARE b_tarrifid varchar(255);
      DECLARE b_tariffLineNo varchar(255);
      DECLARE b_chargeCategory varchar(255);
      DECLARE b_chargeType varchar(255);
      DECLARE b_descrC varchar(255);
      DECLARE b_ratebase varchar(255);
      DECLARE b_fixAmount varchar(255);
      DECLARE b_minAmount varchar(255);
      DECLARE b_MaterialNo varchar(255);
      DECLARE b_itemChargeCategory varchar(255);
      DECLARE b_UDF05 varchar(255);
      DECLARE b_divisionCode varchar(255);
      DECLARE b_UDF07 varchar(255);
      DECLARE b_UDF08 varchar(255);
      DECLARE b_contractNo varchar(255);
      DECLARE b_tariffMasterId varchar(255);
      DECLARE b_rate varchar(255);
      DECLARE b_udf02 varchar(255);
      DECLARE b_udf03 varchar(255);
      DECLARE b_udf04 varchar(255);
      DECLARE b_rateperunit varchar(255);
      DECLARE split_details CURSOR FOR

      SELECT DISTINCT
        bcm.organizationId,
        bcm.warehouseId,
        bcm.customerId,
        DAY(STR_TO_DATE(CONCAT(YEAR(NOW()), '-', MONTH(NOW()), '-', bth.udf02), '%Y-%m-%d')) billingDate, -- change akbar 27-12-24 , correction fix date
        btd.tariffId,
        btd.tariffLineNo,
        btd.chargeCategory,
        btd.chargeType,
        btd.descrC,
        btd.ratebase,
        IF(btd.UDF03 = '', 0, btd.UDF03) AS fixAmount,
        btd.minAmount,
        btd.UDF01 AS MaterialNo,
        btd.udf02 AS itemChargeCategory,
        btd.UDF05,
        btd.UDF06 AS divisionCode,
        btd.UDF07,
        btd.UDF08,
        bth.contractNo,
        bth.tariffMasterId,
        btr.rate,
        btr.udf02,
        btr.udf03,
        btr.udf04,
        btr.ratePerUnit
      FROM BAS_CUSTOMER_MULTIWAREHOUSE bcm
        INNER JOIN BAS_CUSTOMER bc
          ON bc.customerId = bcm.customerId
          AND bc.organizationId = bcm.organizationId
          AND bc.CustomerType = 'OW'
        INNER JOIN BIL_TARIFF_HEADER bth
          ON bth.organizationId = bcm.organizationId
          AND bth.tariffMasterId = bcm.tariffMasterId
        INNER JOIN BIL_TARIFF_DETAILS btd
          ON btd.organizationId = bth.organizationId
          AND btd.tariffId = bth.tariffId
          AND btd.chargeCategory = 'OV'
          AND btd.chargeType = v_outerCode
        INNER JOIN BIL_TARIFF_RATE btr
          ON btr.organizationId = btd.organizationId
          AND btr.tariffId = btd.tariffId
          AND btr.tariffLineNo = btd.tariffLineNo
      WHERE bcm.organizationId = 'OJV_CML'
      AND bcm.warehouseId = 'CBT01'
      AND bcm.customerId = 'PT.ABC'
      --		      AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      --		      AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
      AND (DATE_FORMAT(p_time_in, '%Y-%m-%d') BETWEEN bth.effectiveFrom AND bth.effectiveTo)
      ORDER BY bcm.organizationId, bcm.customerId, btd.chargeCategory, btd.chargeType;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      SET v_total_minutes = TIMESTAMPDIFF(MINUTE, p_time_in, p_time_out);
      SET v_total_hours = (v_total_minutes / 60) - p_break_time;

      -- Start Time dikurangi Break
      SET v_start_time = p_time_in + INTERVAL p_break_time HOUR;

      OPEN split_details;

    read_loop1:
      LOOP
        FETCH split_details INTO b_organizationId, b_warehouseId, b_customerId, b_billingdate, b_tarrifid,
        b_tariffLineNo, b_chargeCategory, b_chargeType, b_descrC, b_ratebase,
        b_fixAmount, b_minAmount, b_MaterialNo, b_itemChargeCategory, b_UDF05,
        b_divisionCode, b_UDF07, b_UDF08, b_contractNo, b_tariffMasterId,
        b_rate, b_udf02, b_udf03, b_udf04, b_rateperunit;

        IF done THEN
          LEAVE read_loop1;
        END IF;

        IF v_total_hours > b_udf02 THEN

          SET v_segment_hours = IFNULL(LEAST(v_total_hours, b_udf03), v_total_hours) - b_udf02;

          SET v_segment_start = v_start_time;
          SET v_segment_end = v_start_time + INTERVAL ROUND(v_segment_hours * 60) MINUTE;

          INSERT INTO BIL_SUMMARY (organizationId, warehouseId, billingSummaryId, billingFromDate, billingToDate, customerId
          , sku, lotNum, traceId, tariffId, chargeCategory, chargeType, descr, rateBase, chargePerUnits
          , qty, uom, cubic, weight, chargeRate, amount, billingAmount, cost, amountPayable, amountPaid
          , confirmTime, confirmWho, docType, docNo, createTransactionid, notes, ediSendTime
          , billTo, settleTime, settleWho, followUp, invoiceType, paidTo, costConfirmFlag
          , costConfirmTime, costConfirmWho, costSettleFlag, costSettleTime, costSettleWho, incomeTaxRate
          , costTaxRate, incomeTax, cosTax, incomeWithoutTax, cosWithoutTax, costInvoiceType, noteText
          , udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, ADDTIME, editWho, editTime, locationCategory
          , manual, docLineNo, arNo, arLineNo, apNo, apLineNo, ediSendFlag, ediErrorCode, ediErrorMessage, ediSendTime2, ediSendFlag2
          , ediErrorCode2, ediErrorMessage2, billingTranCategory, orderType, containerType, containerSize)
            SELECT
              b_organizationId,
              b_warehouseId,
              CONCAT(R_billsummaryId, '*', LPAD((@linenumber := @linenumber + 1), 3, '0')),
              DATE_FORMAT(b_billingdate, '%Y-%m-%d'),
              DATE_FORMAT(b_billingdate, '%Y-%m-%d'),
              b_customerId,
              '',
              '',
              '',
              b_tarrifid,
              b_chargeCategory,
              b_chargeType,
              b_descrC,
              b_ratebase,
              b_rate,
              v_segment_hours,
              '', -- od_uom
              '0',
              '0',
              b_rate,
              v_segment_hours * b_rate / b_rateperunit,
              0, -- (v_segment_hours * (b_rate / b_rateperunit)) + (b_rate * (b_rate / b_rateperunit)) * R_INCOMETAX,
              0,
              0,
              0,
              NULL confirmTime,
              '' confirmWho,
              '' dockType,
              '' docNo,
              '' createTransactionid,
              b_chargeType notes,
              NULL ediSendTime,
              b_customerId billTo,
              NULL settleTime,
              '' settleWho,
              '' followUp,
              '' invoiceType,
              '' paidTo,
              '' costConfirmFlag,
              NULL costConfirmTime,
              '' costConfirmWho,
              '' costSettleFlag,
              NULL costSettleTime,
              '' costSettleWho,
              NULL incomeTaxRate,
              0 costTaxRate,
              NULL incomeTax,
              0 cosTax,
              NULL incomeWithoutTax,
              NULL cosWithoutTax,
              '' costInvoiceType,
              '' noteText,
              b_materialNo AS udf01,
              b_itemChargeCategory AS udf02,
              b_udf03 udf03,
              b_udf04 udf04,
              NULL udf05,
              0 currentVersion,
              '2020' oprSeqFlag,
              p_userid addWho,
              NOW() ADDTIME,
              p_userid editWho,
              NOW() editTime,
              '' locationCategory,
              '' manual,
              0 lineCount,
              '*' arNo,
              0 arLineNo,
              '*' apNo,
              0 apLineNo,
              'N' ediSendFlag,
              '' ediErrorCode,
              '' ediErrorMessage,
              NULL ediSendTime2,
              'N' ediSendFlag2,
              '' ediErrorCode2,
              '' ediErrorMessage2,
              '' billingTranCategory,
              '' orderType,
              '' containerType,
              '' containerSize;

          SET v_start_time = v_segment_end;
        END IF;

      END LOOP;
      CLOSE split_details;
    END;
  END LOOP;

  SET v_outerCode = v_outerCode;
  CLOSE cat_cursor;

END
$$

--
-- Create procedure `Z_RF_SPCHECKVALOVERPALLET`
--
CREATE
DEFINER = 'root'@'%'
PROCEDURE Z_RF_SPCHECKVALOVERPALLET (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_UserId varchar(30),
IN IN_languageId varchar(20),
IN IN_locId varchar(30),
OUT r_returnVal varchar(40),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE countTrace int(100);
    DECLARE countPLcount int(100);
    DECLARE countROW int(100);
    DECLARE var_mixLotFlag varchar(1);
    DECLARE var_mixFlag varchar(1);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#Z_RF_SPCHECKVALOVERPALLET', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
    END;


    SET countPLcount := 0;
    SET countTrace := 0;
    SET countROW := 0;

    SELECT
      COUNT(1) INTO countROW
    FROM INV_LOT_LOC_ID li
    WHERE li.organizationId = 'OJV_CML'
    AND li.warehouseId = IN_warehouseId
    AND locationId = IN_locId;

    IF (countROW = 0) THEN
      SET r_returnVal = 'Y';
      SET OUT_returnCode = '000';
    END IF;

    SELECT
      COUNT(illi.traceId),
      IFNULL(bl.plCount, 0),
      bl.mix_lotFlag,
      bl.mix_flag INTO countTrace, countPLcount, var_mixLotFlag, var_mixFlag
    FROM INV_LOT_LOC_ID illi
      INNER JOIN BAS_LOCATION bl
        ON illi.organizationId = bl.organizationId
        AND illi.warehouseId = bl.warehouseId
        AND illi.locationId = bl.locationId
        AND bl.mix_lotFlag = 'N'
        AND bl.mix_flag = 'N'
    WHERE illi.organizationId = 'OJV_CML'
    AND illi.warehouseId = IN_warehouseId
    AND bl.locationId = IN_locId
    AND illi.qty > 0
    AND bl.locationCategory IN ('SD', 'DD');


    IF (var_mixFlag = 'N'
      AND var_mixLotFlag = 'N') THEN
      IF countTrace >= countPLcount
        AND countPLcount <> 0 THEN
        SET r_returnVal = 'N';
        SET OUT_returnCode = '000';
      ELSE
        SET r_returnVal = 'Y';
        SET OUT_returnCode = '000';

      END IF;
    ELSE
      SET r_returnVal = 'Y';
      SET OUT_returnCode = '000';

    END IF;
  END
  $$

--
-- Create procedure `Z_QRY_CUSTBILLSP`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE Z_QRY_CUSTBILLSP (IN IN_organizationId varchar(20))
END_PROC:
  BEGIN
    SELECT
      organizationId,
      warehouseId,
      customerId,
      seqNo,
      lotatt01,
      lotatt02,
      lotatt03,
      active,
      addTime
    FROM Z_BAS_CUSTOMER_CUSTBILLING
    WHERE organizationId = IN_organizationId
    AND 1 = 2;
  END
  $$

--
-- Create procedure `Z_PENDING_HO_INTERNAL`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE Z_PENDING_HO_INTERNAL (IN InwarehouseId varchar(30), IN IncustomerId varchar(30))
BEGIN

  SELECT
    doh.orderNo AS trans_no
  FROM DOC_ORDER_HEADER doh
  WHERE doh.organizationId = 'OJV_CML'
  AND doh.warehouseId = InwarehouseId
  AND doh.customerId = IncustomerId

  AND doh.orderType IN (SELECT DISTINCT
      btd.docType
    FROM BAS_SKU_MULTIWAREHOUSE bsm
      INNER JOIN BAS_CUSTOMER bc
        ON bc.customerId = bsm.customerId
        AND bc.organizationId = bsm.organizationId
        AND bc.CustomerType = 'OW'
      INNER JOIN BIL_TARIFF_HEADER bth
        ON bth.organizationId = bsm.organizationId
        AND bth.tariffMasterId = bsm.tariffMasterId
      INNER JOIN BIL_TARIFF_DETAILS btd
        ON btd.organizationId = bth.organizationId
        AND btd.tariffId = bth.tariffId
    WHERE bsm.organizationId = doh.organizationId
    AND bc.customerId = doh.customerId
    AND bsm.warehouseId = doh.warehouseId
    AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
    AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
    AND btd.chargeCategory = 'OB')
  AND doh.soStatus IN ('99')
  AND DATE_FORMAT(doh.addTime, '%Y-%m-%d') >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y-%m-%d')
  AND doh.orderNo NOT IN (SELECT DISTINCT
      (bs.docNo)
    FROM BIL_SUMMARY bs
    WHERE bs.organizationId = 'OJV_CML'
    AND bs.customerId = IncustomerId
    AND bs.warehouseId = InwarehouseId
    AND bs.chargeCategory = 'OB'
    AND DATE_FORMAT(bs.addTime, '%Y-%m-%d') >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 2 MONTH), '%Y-%m-%d'));


END
$$

--
-- Create procedure `Z_PENDING_HI_INTERNAL`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE Z_PENDING_HI_INTERNAL (IN InwarehouseId varchar(30), IN IncustomerId varchar(30))
BEGIN

  SELECT
    dah.asnNo AS trans_no
  FROM DOC_ASN_HEADER dah
  WHERE dah.organizationId = 'OJV_CML'
  AND dah.warehouseId = InwarehouseId
  AND dah.customerId = IncustomerId
  AND dah.asnType IN (SELECT DISTINCT
      btd.docType
    FROM BAS_SKU_MULTIWAREHOUSE bsm
      INNER JOIN BAS_CUSTOMER bc
        ON bc.customerId = bsm.customerId
        AND bc.organizationId = bsm.organizationId
        AND bc.CustomerType = 'OW'
      INNER JOIN BIL_TARIFF_HEADER bth
        ON bth.organizationId = bsm.organizationId
        AND bth.tariffMasterId = bsm.tariffMasterId
      INNER JOIN BIL_TARIFF_DETAILS btd
        ON btd.organizationId = bth.organizationId
        AND btd.tariffId = bth.tariffId
    WHERE bsm.organizationId = dah.organizationId
    AND bc.customerId = dah.customerId
    AND bsm.warehouseId = dah.warehouseId
    AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
    AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
    AND btd.chargeCategory = 'IB')
  AND dah.asnStatus IN ('99')
  AND DATE_FORMAT(dah.addTime, '%Y-%m-%d') >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 2 MONTH), '%Y-%m-%d')
  AND dah.asnNo NOT IN (SELECT DISTINCT
      (docNo)
    FROM BIL_SUMMARY
    WHERE customerId = IncustomerId
    AND organizationId = 'OJV_CML'
    AND warehouseId = InwarehouseId
    AND chargeCategory = 'IB'
  -- AND DATE_FORMAT(addTime, '%Y-%m-%d') >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 2 MONTH), '%Y-%m-%d')
  );



END
$$

--
-- Create procedure `Z_DOUBLEBILLINGINTERNAL_HO`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE Z_DOUBLEBILLINGINTERNAL_HO (IN InwarehouseId varchar(30), IN IncustomerId varchar(30))
BEGIN

  SELECT
    T1.organizationId,
    T2.warehouseId,
    T2.customerId,
    T1.orderNo,
    T1.lineTransaksi AS VCOUNTORDER,
    T2.lineTransaksi AS VCOUNTBILL,
    CONCAT('DELETE FROM BIL_SUMMARY WHERE organizationId=', '\'OJV_CML\'', 'AND warehouseId=\'', T2.warehouseId, '\' AND customerId=\'', T2.customerId, '\' AND docNo=\'', T1.orderNo, '\';') AS 'Script Delete'
  FROM (SELECT
      aad.organizationId,
      aad.warehouseId,
      aad.customerId,
      aad.orderNo,
      COUNT(aad.allocationDetailsId) AS lineTransaksi
    FROM ACT_ALLOCATION_DETAILS aad
      INNER JOIN DOC_ORDER_HEADER_UDF dohu
        ON aad.organizationId = dohu.organizationId
        AND aad.warehouseId = dohu.warehouseId
        AND aad.orderNo = dohu.orderNo
      INNER JOIN DOC_ORDER_HEADER doh
        ON aad.organizationId = doh.organizationId
        AND aad.warehouseId = doh.warehouseId
        AND aad.orderNo = doh.orderNo
    WHERE aad.organizationId = 'OJV_CML'
    AND (DATE_FORMAT(dohu.closeTime, '%Y-%m-%d') >= getBillFMDate(26)
    AND DATE_FORMAT(dohu.closeTime, '%Y-%m-%d') <= getBillTODate(26))
    AND aad.customerId IN (IncustomerId)
    AND aad.warehouseId IN (InwarehouseId)
    AND doh.soStatus = '99'
    GROUP BY aad.organizationId,
             aad.warehouseId,
             aad.customerId,
             aad.orderNo) T1
    RIGHT JOIN (SELECT
        bs.organizationId,
        bs.warehouseId,
        bs.customerId,
        bs.docNo,
        COUNT(bs.billingSummaryId) AS lineTransaksi
      FROM BIL_SUMMARY bs
      WHERE bs.organizationId = 'OJV_CML'
      AND bs.warehouseId = InwarehouseId
      AND bs.customerId = IncustomerId
      AND bs.chargeCategory = 'OB'
      AND DATE_FORMAT(billingFromDate, '%Y-%m-%d') >= getBillFMDate(26)
      AND DATE_FORMAT(billingFromDate, '%Y-%m-%d') <= getBillTODate(26)
      GROUP BY bs.organizationId,
               bs.warehouseId,
               bs.customerId,
               bs.docNo) T2
      ON (T1.organizationId = T2.organizationId
      AND T1.warehouseId = T2.warehouseId
      AND T1.customerId = T2.customerId
      AND T1.orderNo = T2.docNo)
  WHERE T1.lineTransaksi <> T2.lineTransaksi;


END
$$

--
-- Create procedure `Z_DOUBLEBILLINGINTERNAL_HI`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE Z_DOUBLEBILLINGINTERNAL_HI (IN InwarehouseId varchar(30), IN IncustomerId varchar(30))
BEGIN

  SELECT
    T1.organizationId,
    T2.warehouseId,
    T2.customerId,
    T1.docNo,
    T1.lineTransaksi AS VCOUNTORDER,
    T2.lineTransaksi AS VCOUNTBILL,
    CONCAT('DELETE FROM BIL_SUMMARY WHERE organizationId=', '\'OJV_CML\'', 'AND warehouseId=\'', T1.warehouseId, '\' AND customerId=\'', T2.customerId, '\' AND docNo=\'', T2.docNo, '\';') AS 'Script Delete'
  FROM (SELECT
      aad.organizationId,
      aad.warehouseId,
      aad.fmCustomerId,
      aad.docNo,
      COUNT(aad.transactionId) AS lineTransaksi
    FROM ACT_TRANSACTION_LOG aad
      INNER JOIN DOC_ASN_HEADER_UDF dohu
        ON aad.organizationId = dohu.organizationId
        AND aad.warehouseId = dohu.warehouseId
        AND aad.docNo = dohu.asnNo
      INNER JOIN DOC_ASN_HEADER doh
        ON aad.organizationId = doh.organizationId
        AND aad.warehouseId = doh.warehouseId
        AND aad.docNo = doh.asnNo
    WHERE aad.organizationId = 'OJV_CML'
    AND (DATE_FORMAT(dohu.closeTime, '%Y-%m-%d') >= getBillFMDate(26)
    AND DATE_FORMAT(dohu.closeTime, '%Y-%m-%d') <= getBillTODate(26))
    AND aad.fmCustomerId IN (IncustomerId)
    AND aad.warehouseId IN (InwarehouseId)
    AND aad.transactionType = 'IN'
    AND doh.asnStatus = '99'
    AND aad.status = '99'
    GROUP BY aad.organizationId,
             aad.warehouseId,
             aad.fmCustomerId,
             aad.docNo) T1
    RIGHT JOIN (SELECT
        bs.organizationId,
        bs.warehouseId,
        bs.customerId,
        bs.docNo,
        COUNT(bs.billingSummaryId) AS lineTransaksi
      FROM BIL_SUMMARY bs
      WHERE bs.organizationId = 'OJV_CML'
      AND bs.warehouseId = InwarehouseId
      AND bs.customerId = IncustomerId
      AND bs.chargeCategory = 'IB'
      AND DATE_FORMAT(billingFromDate, '%Y-%m-%d') >= getBillFMDate(26)
      AND DATE_FORMAT(billingFromDate, '%Y-%m-%d') <= getBillTODate(26)
      GROUP BY bs.organizationId,
               bs.warehouseId,
               bs.customerId,
               bs.docNo) T2
      ON (T1.organizationId = T2.organizationId
      AND T1.warehouseId = T2.warehouseId
      AND T1.fmCustomerId = T2.customerId
      AND T1.docNo = T2.docNo)
  WHERE T1.lineTransaksi <> T2.lineTransaksi;


END
$$

--
-- Create procedure `Z_DBIDLE_KILL`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_DBIDLE_KILL ()
BEGIN

  DECLARE _counter int DEFAULT 1;
  -- DECLARE dt DATE DEFAULT startDate;
  SELECT
    COUNT(*) INTO _counter
  FROM information_schema.processlist
  WHERE Command = 'Sleep'
  AND time > 50
  AND USER = 'wms_cml';
  WHILE _counter >= 5 DO
    -- CALL InsertCalendar(dt);
    -- SET _counter = _counter + 1;
    -- SET dt = DATE_ADD(dt,INTERVAL 1 day);
    -- select id;
    SET @c := (SELECT
        CONCAT('KILL ', id, ';') AS c
      FROM information_schema.processlist
      WHERE Command = 'Sleep'
      AND time > 50
      AND USER = 'wms_cml' LIMIT 1);
    -- if (@c is not null) then
    SELECT
      @c;
    PREPARE stmt FROM @c;
    EXECUTE stmt;
  -- end if;
  END WHILE;
  SHOW FULL PROCESSLIST;
END
$$

--
-- Create procedure `Z_CYCLEHEADERSTATUS_UPDATE`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_CYCLEHEADERSTATUS_UPDATE (IN IN_organizationId varchar(50),
IN IN_warehouseId varchar(50),
IN IN_idDocumentCycle varchar(50),
IN IN_userCount int,
OUT returncode varchar(1009))
ENDPROC:
  BEGIN

    -- Declare variables to store data from each row
    DECLARE done int DEFAULT FALSE;
    DECLARE v_organizationId varchar(30);
    DECLARE v_warehouseId varchar(30);
    DECLARE v_idDocumentCycle varchar(255);
    DECLARE v_userCount int;
    DECLARE v_location varchar(30);
    DECLARE v_groupInfo varchar(30);
    DECLARE v_udf01 varchar(30);
    DECLARE errorMessage varchar(255);
    -- SET returncode:='000';

    DECLARE cyc_details CURSOR FOR

    SELECT
      COUNT(*) AS check_udf01
    FROM Z_CYCLECOUNT_DETAIL
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle
    AND udf01 LIKE 'TO%';

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    OPEN cyc_details;

    SELECT
      IN_organizationId,
      IN_warehouseId,
      IN_idDocumentCycle,
      IN_userCount,
      check_udf01;

  read_loop:
    LOOP
      FETCH cyc_details INTO v_udf01;

      IF v_udf01 > 0 THEN
        SET returncode = CONCAT('Please Check, there is still need count!');
        LEAVE ENDPROC;
      ELSE
        SET returncode = '000';
      END IF;

      IF done THEN
        LEAVE read_loop;
      END IF;

      UPDATE Z_CYCLECOUNT_HEADER
      SET status = '99'
      WHERE organizationId = v_organizationId
      AND warehouseId = v_warehouseId
      AND idDocumentCycle = v_idDocumentCycle;

    END LOOP;

    SET returncode = '000';

    CLOSE cyc_details;

  END
  $$

--
-- Create procedure `Z_CYCLEDETAIL_INSERT`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE Z_CYCLEDETAIL_INSERT (IN IN_organizationId varchar(50),
IN IN_warehouseId varchar(50),
IN IN_userId varchar(50),
IN IN_customerId varchar(50),
IN IN_idDocumentCycle varchar(50),
IN IN_methodCycle varchar(50),
IN IN_sku varchar(1000),
IN IN_chamber varchar(50),
IN IN_aisle varchar(50),
IN IN_level varchar(50),
IN IN_userCount int,
-- IN IN_dateFrom DateTime,
-- IN IN_dateTo DateTime,
IN IN_dateFrom varchar(50),
IN IN_dateTo varchar(50),
OUT OUT_returnCode varchar(1009))
ENDPROC:
  BEGIN

    -- Declare variables to store data from each row
    DECLARE done int DEFAULT FALSE;
    DECLARE v_organizationId varchar(50);
    DECLARE v_warehouseId varchar(50);
    DECLARE v_customerId varchar(50);
    DECLARE v_idDocumentCycle varchar(255);
    DECLARE v_idDocumentDetailCycle varchar(255);
    DECLARE v_methodCycle varchar(50);
    DECLARE v_sku varchar(100);
    DECLARE v_chamber varchar(50);
    DECLARE v_aisle varchar(50);
    DECLARE v_level varchar(50);
    DECLARE v_userCount int;
    --    DECLARE v_dateFrom DateTime;
    --    DECLARE v_dateTo DateTime;
    DECLARE v_dateFrom varchar(50);
    DECLARE v_dateTo varchar(50);
    DECLARE v_location varchar(50);
    DECLARE v_groupInfo varchar(50);
    DECLARE errorMessage varchar(255);
    DECLARE count_cycdtl int(100);
    DECLARE v_hitungRow int;
    DECLARE v_skuDescr varchar(1000);
    DECLARE v_qtyOnHand varchar(50);
    DECLARE v_uom varchar(50);
    DECLARE v_status varchar(50);
    DECLARE v_lotnum varchar(50);
    DECLARE v_batch varchar(50);
    DECLARE v_expDate varchar(50);
    DECLARE v_traceid varchar(50);

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#Z_CHECK_LDLEXISTAPPDOC', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
    END;

    SET count_cycdtl := 0;
    SET v_hitungRow := 0;

    SELECT
      COUNT(1) INTO count_cycdtl
    FROM Z_CYCLECOUNT_DETAIL
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND idDocumentCycle = IN_idDocumentCycle;

    IF count_cycdtl > 0 THEN
      SET OUT_returnCode = CONCAT('You Already Generated Data Details!');
      LEAVE ENDPROC;
    ELSE
      SET OUT_returnCode = '000';
    END IF;


    IF IN_methodCycle = 'TPIC' THEN
    BEGIN
      DECLARE cyc_details CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        a.qty AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        a.lotnum AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        a.traceid AS Traceid -- ,0,0,0,0,0,'UNMATCH',NOW(),'TEST',NOW(),'TEST','N'
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT DISTINCT
          fmlocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PK')
      AND a.sku IN (SELECT DISTINCT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PK')
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details;
    END;
    ELSEIF IN_methodCycle = 'TPUT' THEN
    BEGIN
      DECLARE cyc_details_tput CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        a.qty AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        a.lotnum AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        a.traceid AS Traceid -- ,0,0,0,0,0,'UNMATCH',NOW(),'TEST',NOW(),'TEST','N'
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT
          tolocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PA')
      AND a.sku IN (SELECT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'PA')
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_tput;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_tput INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_tput;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Transaksi Putaway) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'MV' THEN
    BEGIN
      DECLARE cyc_details_mv CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        a.qty AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        a.lotnum AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        a.traceid AS Traceid -- ,0,0,0,0,0,'UNMATCH',NOW(),'TEST',NOW(),'TEST','N'
      FROM INV_LOT_LOC_ID a
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a.organizationid = IN_organizationId
      AND a.warehouseid = IN_warehouseId
      AND a.customerid IN (IN_customerId)
      AND a.qty > 0
      AND a.locationid IN (SELECT
          tolocation
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'MV')
      AND a.sku IN (SELECT
          fmsku
        FROM ACT_TRANSACTION_LOG
        WHERE organizationid = IN_organizationId
        AND warehouseid = IN_warehouseId
        AND tocustomerid IN (IN_customerId)
        AND status = '99'
        AND edittime >= DATE_FORMAT(IN_dateFrom, "%Y-%m-%d")
        AND edittime < DATE_FORMAT(DATE_ADD(IN_dateTo, INTERVAL 1 DAY), "%Y-%m-%d")
        AND transactiontype = 'MV')
      ORDER BY a.locationid;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_mv;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_mv INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_mv;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Transaksi Movement) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'SKU' THEN
    BEGIN
      DECLARE delimiterChar longtext;
      DECLARE inputString longtext;
      DECLARE EXIT HANDLER FOR SQLEXCEPTION
      BEGIN
        GET DIAGNOSTICS CONDITION 1
        @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
        ROLLBACK;
        SET OUT_returnCode = CONCAT('999#Z_CYCLEDETAIL_INSERT', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      END;

      DROP TEMPORARY TABLE IF EXISTS temp_skucycledtl;
      CREATE TEMPORARY TABLE temp_skucycledtl (
        vals longtext
      );

      SET delimiterChar = ',';
      SET inputString = IN_sku;
      WHILE LOCATE(delimiterChar, inputString) > 1 DO
        INSERT INTO temp_skucycledtl
          SELECT
            SUBSTRING_INDEX (inputString, delimiterChar, 1);
        SET inputString = REPLACE(inputString, (SELECT
            LEFT(inputString, LOCATE(delimiterChar, inputString))), '');
      END WHILE;
      INSERT INTO temp_skucycledtl (vals)
        VALUES (inputString);

      BEGIN

        DECLARE r_organizationId varchar(20);
        DECLARE r_warehouseId varchar(20);
        DECLARE r_billingSummaryId varchar(30);
        DECLARE r_billingFromDate varchar(30);
        DECLARE r_billingToDate varchar(30);
        DECLARE r_customerId varchar(30);
        DECLARE r_chargeCategory varchar(20);
        DECLARE r_chargeType varchar(20);
        DECLARE r_amount decimal(24, 8);
        DECLARE r_billingAmount decimal(24, 8);
        DECLARE inventory_done int DEFAULT 0;
        DECLARE tariff_done int DEFAULT 0;
        DECLARE billing_sm_done,
                attribute_done int DEFAULT 0;

        DECLARE cyc_details_sku CURSOR FOR

        SELECT
          IN_idDocumentCycle AS idDocumentCycle,
          CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
          a.organizationId,
          a.warehouseId,
          a.customerId,
          a.locationid AS Location,
          a.sku AS SKU,
          b.skudescr1 AS skuDescr,
          a.qty AS QtyOnHand,
          d.uomdescr AS uom,
          c.lotatt08 AS status,
          a.lotnum AS LotNum,
          c.lotatt04 AS Batch,
          c.lotatt02 AS ExpDate,
          a.traceid AS Traceid -- ,0,0,0,0,0,'UNMATCH',NOW(),'TEST',NOW(),'TEST','N'
        FROM BAS_LOCATION a1
          LEFT OUTER JOIN INV_LOT_LOC_ID a
            ON a1.organizationid = a.organizationid
            AND a1.warehouseid = a.warehouseid
            AND a1.locationid = a.locationid
            AND a.qty > 0
          LEFT OUTER JOIN BAS_SKU b
            ON a.organizationid = b.organizationid
            AND a.customerid = b.customerid
            AND a.sku = b.sku
          LEFT OUTER JOIN INV_LOT_ATT c
            ON a.organizationid = c.organizationid
            AND a.customerid = c.customerid
            AND a.lotnum = c.lotnum
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
            ON b.organizationid = d.organizationid
            AND b.customerid = d.customerid
            AND b.packid = d.packid
            AND d.packuom = 'EA'
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
            ON b.organizationid = d1.organizationid
            AND b.customerid = d1.customerid
            AND b.packid = d1.packid
            AND d1.packuom = 'IP'
          LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
            ON b.organizationid = d2.organizationid
            AND b.customerid = d2.customerid
            AND b.packid = d2.packid
            AND d2.packuom = 'CS'
          LEFT OUTER JOIN BSM_CODE_ML e
            ON c.organizationid = e.organizationid
            AND c.lotatt08 = e.codeid
            AND e.codetype = 'DMG_FLG'
            AND e.languageid = 'en'
        WHERE a1.organizationid = IN_organizationId
        AND a1.warehouseid = IN_warehouseId
        -- and a1.locGroup2 in (IN_chamber)
        -- and a1.aisleNo in (IN_aisle)
        -- and a1.locLevel in (IN_level)
        AND a.sku IN (SELECT
            vals
          FROM temp_skucycledtl)
        -- and a.qty >0
        AND a.locationId NOT LIKE 'SORTATION%'
        ORDER BY a1.locationId;

        DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

        OPEN cyc_details_sku;

        SELECT
          IN_organizationId,
          IN_warehouseId,
          IN_idDocumentCycle,
          IN_userCount,
          IN_dateFrom,
          IN_dateTo;

      read_loop:
        LOOP
          FETCH cyc_details_sku INTO v_idDocumentCycle, v_idDocumentDetailCycle,
          v_organizationId, v_warehouseId,
          v_customerId, v_location, v_sku, v_skuDescr,
          v_qtyOnHand, v_uom, v_status, v_lotnum,
          v_batch, v_expDate, v_traceid;

          SET v_hitungRow = v_hitungRow + 1;

          IF done THEN
            LEAVE read_loop;
          END IF;

          INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
          location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
          countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag)
            SELECT
              v_idDocumentCycle,
              v_idDocumentDetailCycle,
              v_organizationId,
              v_warehouseId,
              v_customerId,
              v_location,
              v_sku,
              v_skuDescr,
              v_qtyOnHand,
              v_uom,
              v_status,
              v_lotnum,
              v_batch,
              v_expDate,
              v_traceid,
              NULL count1,
              NULL count2,
              NULL count3,
              NULL countFinal,
              NULL countDifferent,
              'UNMATCH' countStatus,
              NOW() addTime,
              IN_userId addWho,
              NOW() editTime,
              IN_userId editWho,
              'N' findingFlag,
              v_idDocumentDetailCycle;

        END LOOP;
        SELECT
          v_hitungRow;
        CLOSE cyc_details_sku;

        DROP TEMPORARY TABLE IF EXISTS temp_skucycledtl;
        COMMIT;
      END;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (SKU) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LL' THEN
    BEGIN
      DECLARE cyc_details_ll CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        a.qty AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        a.lotnum AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        a.traceid AS Traceid -- ,0,0,0,0,0,'UNMATCH',NOW(),'TEST',NOW(),'TEST','N'
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      -- and a.sku is null
      -- and a.qty >0
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_ll;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_ll INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_ll;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location All) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LE' THEN
    BEGIN
      DECLARE cyc_details_le CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        a.qty AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        a.lotnum AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        a.traceid AS Traceid -- ,0,0,0,0,0,'UNMATCH',NOW(),'TEST',NOW(),'TEST','N'
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      AND a.sku IS NULL
      -- and a.qty >0
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_le;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_le INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_le;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location Empty) belum ada!!');
    		LEAVE ENDPROC;
    		*/
    ELSEIF IN_methodCycle = 'LA' THEN
    BEGIN
      DECLARE cyc_details_la CURSOR FOR

      SELECT
        IN_idDocumentCycle AS idDocumentCycle,
        CONCAT(IN_idDocumentCycle, '-', auto_sequence()) AS idDocumentDetailCycle,
        a.organizationId,
        a.warehouseId,
        a.customerId,
        a.locationid AS Location,
        a.sku AS SKU,
        b.skudescr1 AS skuDescr,
        a.qty AS QtyOnHand,
        d.uomdescr AS uom,
        c.lotatt08 AS status,
        a.lotnum AS LotNum,
        c.lotatt04 AS Batch,
        c.lotatt02 AS ExpDate,
        a.traceid AS Traceid -- ,0,0,0,0,0,'UNMATCH',NOW(),'TEST',NOW(),'TEST','N'
      FROM BAS_LOCATION a1
        LEFT OUTER JOIN INV_LOT_LOC_ID a
          ON a1.organizationid = a.organizationid
          AND a1.warehouseid = a.warehouseid
          AND a1.locationid = a.locationid
          AND a.qty > 0
        LEFT OUTER JOIN BAS_SKU b
          ON a.organizationid = b.organizationid
          AND a.customerid = b.customerid
          AND a.sku = b.sku
        LEFT OUTER JOIN INV_LOT_ATT c
          ON a.organizationid = c.organizationid
          AND a.customerid = c.customerid
          AND a.lotnum = c.lotnum
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d
          ON b.organizationid = d.organizationid
          AND b.customerid = d.customerid
          AND b.packid = d.packid
          AND d.packuom = 'EA'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d1
          ON b.organizationid = d1.organizationid
          AND b.customerid = d1.customerid
          AND b.packid = d1.packid
          AND d1.packuom = 'IP'
        LEFT OUTER JOIN BAS_PACKAGE_DETAILS d2
          ON b.organizationid = d2.organizationid
          AND b.customerid = d2.customerid
          AND b.packid = d2.packid
          AND d2.packuom = 'CS'
        LEFT OUTER JOIN BSM_CODE_ML e
          ON c.organizationid = e.organizationid
          AND c.lotatt08 = e.codeid
          AND e.codetype = 'DMG_FLG'
          AND e.languageid = 'en'
      WHERE a1.organizationid = IN_organizationId
      AND a1.warehouseid = IN_warehouseId
      AND a1.locGroup2 IN (IN_chamber)
      AND a1.aisleNo IN (IN_aisle)
      AND a1.locLevel IN (IN_level)
      -- and a.sku is null
      AND a.qty > 0
      ORDER BY a1.locationId;

      DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

      OPEN cyc_details_la;

      SELECT
        IN_organizationId,
        IN_warehouseId,
        IN_idDocumentCycle,
        IN_userCount,
        IN_dateFrom,
        IN_dateTo;

    read_loop:
      LOOP
        FETCH cyc_details_la INTO v_idDocumentCycle, v_idDocumentDetailCycle,
        v_organizationId, v_warehouseId,
        v_customerId, v_location, v_sku, v_skuDescr,
        v_qtyOnHand, v_uom, v_status, v_lotnum,
        v_batch, v_expDate, v_traceid;

        SET v_hitungRow = v_hitungRow + 1;

        IF done THEN
          LEAVE read_loop;
        END IF;

        INSERT INTO Z_CYCLECOUNT_DETAIL (idDocumentCycle, idDocumentDetailCycle, organizationId, warehouseId, customerId,
        location, sku, skuDescr, qtyOnHand, uom, status, lotnum, batch, expDate, traceId, count1, count2, count3,
        countFinal, countDifferent, countStatus, addTime, addWho, editTime, editWho, findingFlag, oprSeqFlag)
          SELECT
            v_idDocumentCycle,
            v_idDocumentDetailCycle,
            v_organizationId,
            v_warehouseId,
            v_customerId,
            v_location,
            v_sku,
            v_skuDescr,
            v_qtyOnHand,
            v_uom,
            v_status,
            v_lotnum,
            v_batch,
            v_expDate,
            v_traceid,
            NULL count1,
            NULL count2,
            NULL count3,
            NULL countFinal,
            NULL countDifferent,
            'UNMATCH' countStatus,
            NOW() addTime,
            IN_userId addWho,
            NOW() editTime,
            IN_userId editWho,
            'N' findingFlag,
            v_idDocumentDetailCycle;

      END LOOP;
      SELECT
        v_hitungRow;
      CLOSE cyc_details_la;
    END;
    /*		SET OUT_returnCode = CONCAT('Method Cycle ',IN_methodCycle,' (Location with SOH) belum ada!!');
    		LEAVE ENDPROC;	
    		*/
    END IF;
  END
  $$

--
-- Create procedure `Z_CML_UPD_SO_PLT_CDN`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE Z_CML_UPD_SO_PLT_CDN (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_ContainerID varchar(30),
IN IN_LDLNo varchar(30),
IN IN_PLTCDN varchar(30),
IN IN_CUSTOMERID varchar(50),
IN IN_ORDERNO varchar(50),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE od_allocationId varchar(10);
    DECLARE od_orderNo varchar(10);
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE OD_CURSORDONE int DEFAULT 0;

    UPDATE ACT_ALLOCATION_DETAILS
    SET udf05 = IN_PLTCDN,
        editTime = NOW()
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND customerId = IN_CUSTOMERID
    AND waveNo IN (SELECT DISTINCT
        dlh.waveNo
      FROM DOC_LOADING_HEADER dlh
      WHERE dlh.organizationId = IN_organizationId
      AND dlh.ldlNo = IN_LDLNo
      AND dlh.warehouseId = IN_warehouseId)
    AND pickToTraceId = IN_ContainerID;

    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `Z_CML_UPDATEFLAGLOADTOTRUCK`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE Z_CML_UPDATEFLAGLOADTOTRUCK (IN IN_ORGANIZATIONID varchar(50),
IN IN_WAREHOUSEID varchar(50),
IN IN_DROPID varchar(40),
IN IN_CUSTOMERID varchar(40),
IN IN_USERID varchar(100),
INOUT OUT_RETURNCODE varchar(1000))
BEGIN

  GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
  @p2 = MESSAGE_TEXT,
  @p3 = MYSQL_ERRNO,
  @p4 = TABLE_NAME,
  @p5 = COLUMN_NAME;
  ROLLBACK;
  SET OUT_RETURNCODE = CONCAT('999#Z_CML_UPDATEFLAGLOADTOTRUCK,',
  IFNULL(@p1, ''),
  ',',
  IFNULL(@p2, ''),
  ',',
  IFNULL(@p3, ''),
  ',',
  IFNULL(@p4, ''),
  ',',
  IFNULL(@p5, ''));
  BEGIN
    UPDATE ACT_ALLOCATION_DETAILS
    SET udf05 = 'Y',
        udf04 = NOW(),
        editTime = NOW(),
        editWho = IN_USERID
    WHERE organizationId = IN_ORGANIZATIONID
    AND warehouseId = IN_WAREHOUSEID
    AND pickToTraceId = IN_DROPID
    AND customerId = IN_CUSTOMERID;

    SET OUT_RETURNCODE = '000';
  END;
END
$$

--
-- Create procedure `Z_CHECK_LDLEXISTAPPDOC`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE Z_CHECK_LDLEXISTAPPDOC (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_UserId varchar(30),
IN IN_languageId varchar(20),
IN IN_LDLNO varchar(30),
OUT r_returnVal varchar(40),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE countldl int(100);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#Z_CHECK_LDLEXISTAPPDOC', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
    END;


    SET countldl := 0;


    SELECT
      COUNT(1) INTO countldl
    FROM DOC_APPOINTMENT_DETAILS
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND docType = 'LOAD'
    AND docNo = IN_LDLNO;

    IF countldl > 0 THEN
      SET r_returnVal = 'N';
      SET OUT_returnCode = 'Loading List Number already created on appointment!';
    ELSE
      SET r_returnVal = 'Y';
      SET OUT_returnCode = '000';
    END IF;

  END
  $$

--
-- Create procedure `sp_Z_CreateCsvInventoryBalance`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE sp_Z_CreateCsvInventoryBalance ()
BEGIN
  -- SET @Date = DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 DAY),'%Y-%m-%d');
  -- SET @Date = DATE_FORMAT(NOW(), '%Y-%m-%d');
  SET @FOLDER = '/var/lib/mysql-files/';
  SET @PREFIX = 'ib';
  SET @EXT = '.csv';

  -- SET @CMD = CONCAT("SELECT customerId, fulfillment_center_id, sku, qtyonHand, qtyallocated, qtyonHold, qtyavailable FROM `Z_InventoryBalance` WHERE StockDate = '",@Date,"' INTO OUTFILE '",@FOLDER,@PREFIX,@EXT,
  SET @CMD = CONCAT("SELECT customer, fulfillment_center_id, sku, SUM(qtyonHand) AS qtyonHand, SUM(qtyallocated) AS qtyallocated, SUM(qtyonHold) AS qtyonHold, SUM(qtyavailable) AS qtyavailable
FROM
(
	SELECT customer, fulfillment_center_id, replace(sku, '\n', '') AS sku, qtyonHand, qtyallocated, qtyonHold, qtyavailable FROM 
	(
		SELECT 	e.customerId  AS customer, 
						CASE WHEN e.customerId NOT IN ('RBIZ_TEST', 'ECBRIGHT') AND sm.warehouseId IS NULL THEN 'WHCPT01' ELSE sm.warehouseId END AS fulfillment_center_id,
						replace(e.sku, '\r\n', '') AS sku, 
						-- CONVERT(IFNULL(SUM(a.qty), 0),SIGNED) AS qtyonHand, 
						-- CONVERT(IFNULL(SUM(a.qtyallocated), 0),SIGNED) AS qtyallocated, 
						CASE WHEN a.locationId = 'SORTATIONWHCPT01' THEN 0 ELSE CONVERT(IFNULL(SUM(a.qty), 0),SIGNED) END AS qtyonHand, 
						CASE WHEN a.locationId = 'SORTATIONWHCPT01' THEN 0 ELSE CONVERT(IFNULL(SUM(a.qtyallocated), 0),SIGNED) END AS qtyallocated, 
						CONVERT(IFNULL(SUM(a.qtyOnHold), 0),SIGNED) AS qtyonHold,
						CONVERT(IFNULL(SUM(a.qty - a.qtyallocated - a.qtyOnHold - a.qtyRpOut - a.qtyMvOut), 0),SIGNED) AS qtyavailable
		FROM 	BAS_SKU e
		LEFT JOIN BAS_CUSTOMER cus ON e.customerId = cus.customerId AND e.organizationId = cus.organizationId
		LEFT JOIN BAS_SKU_MULTIWAREHOUSE sm ON sm.organizationId = e.organizationId AND sm.customerId = e.customerId AND sm.sku = e.sku
		LEFT JOIN INV_LOT_LOC_ID a ON a.organizationId = e.organizationId AND a.customerId = e.customerId AND a.sku = e.sku AND a.warehouseId = sm.warehouseId 
		LEFT JOIN BAS_PACKAGE_DETAILS d ON a.organizationId = d.organizationId AND a.customerId = d.customerId AND e.packId = d.packId AND d.packUom = 'EA'		
		WHERE e.activeFlag='Y' AND ((e.sku != 'NOSKU' ) AND e.sku not in('SKUTESTECMAMA01','SKUTESTECMAMA04','SKUTESTECMAMA03','SKUTESTECMAMA05','SKUTESTECMAMA02','SKUTESTECMAMA') OR a.locationId IS NULL) AND cus.activeFlag='Y' 
      AND a.warehouseId='CBT02-B2C'
      -- AND a.locationId != 'SORTATIONWHCPT01' AND
		and cus.customerType = 'OW'
		GROUP BY e.organizationId, sm.warehouseId, e.customerId, e.sku, a.locationId
	) s
)s
GROUP BY customer, fulfillment_center_id, sku
ORDER BY qtyavailable desc  INTO OUTFILE '", @FOLDER, @PREFIX, @EXT,
  "' FIELDS ENCLOSED BY '\"' TERMINATED BY ';' ESCAPED BY '\"'",
  "  LINES TERMINATED BY '\r\n';");
  -- select @CMD ;
  PREPARE statement FROM @CMD;

  EXECUTE statement;

  DEALLOCATE PREPARE statement;

END
$$

--
-- Create procedure `SP_STOCK_TEST`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE SP_STOCK_TEST (IN IN_storer varchar(20))
BEGIN




  SELECT
    *
  FROM INV_LOT_LOC_ID
  WHERE qty > 0
  AND customerId = IN_storer;

END
$$

--
-- Create procedure `SP_SKU_LABEL_TEST`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SP_SKU_LABEL_TEST (IN IN_AsnNO varchar(20))
BEGIN

  DECLARE done boolean DEFAULT 0;
  DECLARE inner_done boolean DEFAULT 0;
  DECLARE c_sku varchar(100);
  DECLARE c_sku2 int;
  DECLARE c_orderqty varchar(100);
  DECLARE c_qtyreceived int;
  DECLARE c_in_ponumber varchar(100);
  DECLARE c_in_sku varchar(100);
  DECLARE strquery text;

  DECLARE cursor_var CURSOR FOR
  SELECT
    a.asnno AS RECEIPTKEY,
    a.SKU,
    (FLOOR((a.receivedQty))) AS QTYRECEIVED
  FROM DOC_ASN_DETAILS a
    LEFT OUTER JOIN DOC_ASN_HEADER b
      ON a.asnNo = b.asnNo
    LEFT OUTER JOIN BAS_SKU c
      ON a.SKU = c.SKU
      AND a.customerId = c.customerId
  WHERE a.receivedQty > 0
  AND a.asnNo = IN_AsnNO
  ORDER BY a.receivedQty
  ;


  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  SET strquery = '';

  DROP TEMPORARY TABLE IF EXISTS tbl_label_print;
  CREATE TEMPORARY TABLE tbl_label_print (
    RECEIPTKEY varchar(255),
    SKU varchar(255),
    QTYRECEIVED int
  );


  OPEN cursor_var;
cursor_var_loop:
  LOOP

    FETCH cursor_var INTO c_orderqty, c_sku, c_qtyreceived;
    IF done = 1 THEN
      LEAVE cursor_var_loop;
    END IF;
  INNER_BLOCK:
    BEGIN

      DECLARE x int;
      DECLARE y int;


      SET x = 1;
      SET y = c_qtyreceived;

    loop_label:
      LOOP
        IF x > y THEN
          LEAVE loop_label;
        END IF;
        SET x = x + 1;

        INSERT INTO tbl_label_print (RECEIPTKEY, SKU, QTYRECEIVED)
          SELECT
            IN_AsnNO,
            c_sku,
            c_qtyreceived;

      END LOOP;

    END INNER_BLOCK;

    IF done THEN
      LEAVE cursor_var_loop;
    END IF;
  END LOOP;

  CLOSE cursor_var;

  SELECT
    RECEIPTKEY,
    SKU,
    QTYRECEIVED
  FROM tbl_label_print;



END
$$

--
-- Create procedure `sp_restore_routines`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE sp_restore_routines (IN p_csv_file varchar(255),
IN p_database varchar(64),
IN p_drop_existing boolean)
BEGIN
  DECLARE v_done int DEFAULT 0;
  DECLARE v_name varchar(64);
  DECLARE v_type varchar(20);
  DECLARE v_definer varchar(93);
  DECLARE v_returns varchar(64);
  DECLARE v_deterministic varchar(3);
  DECLARE v_security varchar(7);
  DECLARE v_sql_mode text;
  DECLARE v_charset varchar(32);
  DECLARE v_collation varchar(32);
  DECLARE v_comment text;
  DECLARE v_body longtext;
  DECLARE v_count int DEFAULT 0;
  DECLARE v_sql text;

  -- Cursor untuk restore
  DECLARE cur_restore CURSOR FOR
  SELECT
    routine_name,
    routine_type,
    definer,
    returns,
    is_deterministic,
    security,
    sql_mode,
    charset_v,
    collation_v,
    comment_v,
    definition
  FROM tmp_routines_backup;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_done = 1;

  -- Temporary table untuk data CSV
  DROP TEMPORARY TABLE IF EXISTS tmp_routines_backup;
  CREATE TEMPORARY TABLE tmp_routines_backup (
    routine_name varchar(64),
    routine_type varchar(20),
    definer varchar(93),
    created datetime,
    modified datetime,
    returns varchar(64),
    is_deterministic varchar(3),
    security varchar(7),
    sql_mode text,
    charset_v varchar(32),
    collation_v varchar(32),
    comment_v text,
    definition longtext
  );

  -- Load CSV data
  SET @load_sql = CONCAT('LOAD DATA INFILE \'', p_csv_file, '\' ',
  'INTO TABLE tmp_routines_backup ',
  'FIELDS TERMINATED BY \',\' ',
  'ENCLOSED BY \'"\' ',
  'LINES TERMINATED BY \'\\n\' ',
  'IGNORE 1 ROWS');

  PREPARE stmt FROM @load_sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;


  OPEN cur_restore;

restore_loop:
  LOOP
    FETCH cur_restore INTO v_name, v_type, v_definer, v_returns,
    v_deterministic, v_security, v_sql_mode, v_charset,
    v_collation, v_comment, v_body;

    IF v_done THEN
      LEAVE restore_loop;
    END IF;

    -- Drop existing jika diminta
    IF p_drop_existing THEN
      SET @drop_sql = CONCAT('DROP ', v_type, ' IF EXISTS ', p_database, '.', v_name);
      PREPARE stmt FROM @drop_sql;
      EXECUTE stmt;
      DEALLOCATE PREPARE stmt;
    END IF;

    -- Build CREATE statement
    SET @create_sql = CONCAT('CREATE DEFINER=', v_definer, ' ');

    IF v_type = 'FUNCTION' THEN
      SET @create_sql = CONCAT(@create_sql, 'FUNCTION ', p_database, '.', v_name, '() ',
      'RETURNS ', v_returns, ' ');
    ELSE
      SET @create_sql = CONCAT(@create_sql, 'PROCEDURE ', p_database, '.', v_name, '() ');
    END IF;

    IF v_deterministic = 'YES' THEN
      SET @create_sql = CONCAT(@create_sql, 'DETERMINISTIC ');
    END IF;

    SET @create_sql = CONCAT(@create_sql, 'SQL SECURITY ', v_security, ' ');

    IF v_comment IS NOT NULL
      AND v_comment != '' THEN
      SET @create_sql = CONCAT(@create_sql, 'COMMENT \'', v_comment, '\' ');
    END IF;

    SET @create_sql = CONCAT(@create_sql, v_body);

    -- Execute restore
    SET @old_sql_mode = @@sql_mode;
    SET sql_mode = v_sql_mode;

    PREPARE stmt FROM @create_sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

    SET sql_mode = @old_sql_mode;

    SET v_count = v_count + 1;
  END LOOP;

  CLOSE cur_restore;

  DROP TEMPORARY TABLE tmp_routines_backup;

  SELECT
    CONCAT('Restore selesai: ', v_count, ' routines berhasil di-restore') AS message;
END
$$

--
-- Create procedure `sp_list_backups`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE sp_list_backups (IN p_directory varchar(255))
BEGIN
  -- Menggunakan sistem table untuk list files
  SELECT
    FILE_NAME,
    FILE_SIZE,
    CREATE_TIME,
    MODIFY_TIME
  FROM information_schema.FILES
  WHERE FILE_NAME LIKE CONCAT(p_directory, '%.xlsx')
  OR FILE_NAME LIKE CONCAT(p_directory, '%.csv')
  ORDER BY MODIFY_TIME DESC;
END
$$

--
-- Create procedure `SP_INSERT_Z_INVENTORYBALANCE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SP_INSERT_Z_INVENTORYBALANCE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE r_alertID varchar(20);
  DECLARE r_receipientAdd varchar(600);
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
    GET DIAGNOSTICS CONDITION 1
    @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
    ROLLBACK;
    --
    INSERT INTO SYS_ALERT_LOG (organizationId,
    warehouseId,
    alertMessageId,
    alertId,
    alertDate,
    alertAddress,
    subjectText,
    readFlag,
    messageLevel,
    sendAlertFlag,
    field02,
    noteText,
    addWho,
    ADDTIME,
    editWho,
    editTime)
      VALUES ('OJV_CML', 'CBT01', REPLACE(UUID(), '-', ''), r_alertid, CURRENT_TIMESTAMP, r_receipientAdd, 'Daily Inventory Alert', 'N', 1, 'N', LEFT(CONCAT("ERROR ", @errno, " (", @sqlstate, "): ", @text), 100), CONCAT("ERROR ", @errno, " (", @sqlstate, "): ", @text), 'UDFTIMER', CURRENT_TIMESTAMP, 'UDFTIMER', CURRENT_TIMESTAMP);
    COMMIT;
    -- SET OUT_returnCode = CONCAT('999#BILL_STORAGE_DETAIL,',IFNULL(@p1,''),',',IFNULL(@p2,''),',',IFNULL(@p3,''),',',IFNULL(@p4,''),',',IFNULL(@p5,''));
    SET OUT_returnCode = '000';
    SELECT
      OUT_returnCode;
  END;

  SET r_alertID = 'INV_ALERT';
  SET r_receipientAdd = '';
  BEGIN
    ##
    INSERT INTO Z_InventoryBalance (organizationId,
    customerId,
    warehouseid,
    locationId,
    traceId,
    muid,
    lotNum,
    sku,
    qtyonHand,
    packkey,
    UOM,
    qtyallocated,
    qtyonHold,
    qtyavailable,
    qtyPicked,
    SKUDesc,
    StockDate,
    `cube`,
    totalCube,
    grossWeight,
    netWeight,
    freightClass,
    locationcategory,
    locGroup1,
    locGroup2,
    addWho,
    ADDTIME,
    editwho,
    edittime)
      SELECT
        a.organizationId,
        a.customerId AS customer,
        a.warehouseId,
        a.locationId,
        a.traceId,
        a.muid,
        a.lotNum,
        a.sku AS sku,
        a.qty AS qtyonHand,
        d.packId AS packkey,
        d.uomdescr AS UOM,
        a.qtyallocated AS qtyallocated,
        a.qtyOnHold AS qtyonHold,
        (a.qty - a.qtyallocated - a.qtyOnHold - a.qtyRpOut - a.qtyMvOut) AS qtyavailable,
        (CASE WHEN c.locationusage = 'SS' THEN a.qtyallocated ELSE 0 END) AS qtyPicked,
        e.skuDescr1 AS SKUDesc,
        CAST(DATE_ADD(NOW(), INTERVAL -1 DAY) AS date) AS StockDate,
        e.cube /*AS CUBE*/,
        CAST((a.qty * e.cube) AS decimal(24, 8)) AS TotalCube,
        e.grossWeight,
        e.netWeight,
        e.freightClass,
        c.locationCategory,
        c.locGroup1,
        c.locGroup2,
        'UDFSYSTEM' AS addWho,
        NOW() AS ADDTIME,
        'UDFSYSTEM' AS editwho,
        NOW() AS edittime
      FROM INV_LOT_LOC_ID a
        LEFT JOIN BAS_LOCATION c
          ON c.organizationId = a.organizationId
          AND c.warehouseId = a.warehouseId
          AND c.locationid = a.locationid
        LEFT JOIN BAS_LOCGROUP1 bl1
          ON bl1.warehouseId = c.warehouseId
          AND bl1.organizationId = c.organizationId
          AND bl1.locGroup1 = c.locGroup1
        LEFT JOIN BAS_SKU e
          ON a.organizationId = e.organizationId
          AND a.customerId = e.customerId
          AND a.sku = e.sku
        LEFT JOIN BAS_PACKAGE_DETAILS d
          ON d.organizationId = e.organizationId
          AND d.customerId = e.customerId
          AND d.packId = e.packId
          AND d.packUom = 'EA'
      WHERE a.qty + a.qtyPa + a.qtyRpIn + a.qtyMvIn > 0;

    #3
    INSERT INTO Z_InventoryBalance_Real (organizationId,
    customerId,
    warehouseid,
    locationId,
    traceId,
    muid,
    lotNum,
    sku,
    qtyonHand,
    packkey,
    UOM,
    qtyallocated,
    qtyonHold,
    qtyavailable,
    qtyPicked,
    SKUDesc,
    StockDate,
    `cube`,
    totalCube,
    grossWeight,
    netWeight,
    freightClass,
    locationcategory,
    locGroup1,
    locGroup2,
    addWho,
    ADDTIME,
    editwho,
    edittime)
      SELECT
        a.organizationId,
        a.customerId AS customer,
        a.warehouseId,
        a.locationId,
        a.traceId,
        a.muid,
        a.lotNum,
        a.sku AS sku,
        a.qty AS qtyonHand,
        d.packId AS packkey,
        d.uomdescr AS UOM,
        a.qtyallocated AS qtyallocated,
        a.qtyOnHold AS qtyonHold,
        (a.qty - a.qtyallocated - a.qtyOnHold - a.qtyRpOut - a.qtyMvOut) AS qtyavailable,
        (CASE WHEN c.locationusage = 'SS' THEN a.qtyallocated ELSE 0 END) AS qtyPicked,
        e.skuDescr1 AS SKUDesc,
        CAST(DATE_ADD(NOW(), INTERVAL -1 DAY) AS date) AS StockDate,
        e.cube /*AS CUBE*/,
        CAST((a.qty * e.cube) AS decimal(24, 8)) AS TotalCube,
        -- (a.qty * e.cube) AS TotalCube,
        e.grossWeight,
        e.netWeight,
        e.freightClass,
        c.locationCategory,
        c.locGroup1,
        c.locGroup2,
        'UDFSYSTEM' AS addWho,
        NOW() AS ADDTIME,
        'UDFSYSTEM' AS editwho,
        NOW() AS edittime
      FROM INV_LOT_LOC_ID a
        LEFT JOIN BAS_LOCATION c
          ON c.organizationId = a.organizationId
          AND c.warehouseId = a.warehouseId
          AND c.locationid = a.locationid
        LEFT JOIN BAS_LOCGROUP1 bl1
          ON bl1.warehouseId = c.warehouseId
          AND bl1.organizationId = c.organizationId
          AND bl1.locGroup1 = c.locGroup1
        LEFT JOIN BAS_SKU e
          ON a.organizationId = e.organizationId
          AND a.customerId = e.customerId
          AND a.sku = e.sku
        LEFT JOIN BAS_PACKAGE_DETAILS d
          ON d.organizationId = e.organizationId
          AND d.customerId = e.customerId
          AND d.packId = e.packId
          AND d.packUom = 'EA'
      WHERE a.qty + a.qtyPa + a.qtyRpIn + a.qtyMvIn > 0;

    ##3
    DELETE
      FROM Z_InventoryBalance_Real
    WHERE ADDTIME <= DATE_ADD(NOW(), INTERVAL -3 MONTH);
  END;
  SET OUT_returnCode = '000';
  COMMIT;
END
$$

--
-- Create procedure `sp_backup_schema`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE sp_backup_schema (IN p_database varchar(64),
IN p_filename varchar(255),
IN p_include_indexes boolean,
IN p_include_triggers boolean)
BEGIN
  DECLARE v_done int DEFAULT 0;
  DECLARE v_row int DEFAULT 1;
  DECLARE v_table varchar(64);
  DECLARE v_create_stmt text;
  DECLARE v_engine varchar(64);
  DECLARE v_charset varchar(32);
  DECLARE v_collation varchar(64);
  DECLARE v_comment text;
  DECLARE v_rows bigint;
  DECLARE v_size_mb decimal(10, 2);

  -- Cursor untuk tabel
  DECLARE cur_tables CURSOR FOR
  SELECT
    t.TABLE_NAME,
    t.ENGINE,
    t.TABLE_COLLATION,
    t.TABLE_COMMENT,
    t.TABLE_ROWS,
    ROUND(((t.DATA_LENGTH + t.INDEX_LENGTH) / 1024 / 1024), 2) AS SIZE_MB
  FROM information_schema.TABLES t
  WHERE t.TABLE_SCHEMA = p_database
  AND t.TABLE_TYPE = 'BASE TABLE'
  ORDER BY t.TABLE_NAME;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_done = 1;

  -- Buat Excel file
  SELECT
    create_excel(p_filename, '#FF6600', 'Database Schema') AS result;

  -- Header
  SELECT
    write_excel_data(0, 0, 'TABLE_NAME', 'string') AS r;
  SELECT
    write_excel_data(0, 1, 'ENGINE', 'string') AS r;
  SELECT
    write_excel_data(0, 2, 'COLLATION', 'string') AS r;
  SELECT
    write_excel_data(0, 3, 'ROWS', 'string') AS r;
  SELECT
    write_excel_data(0, 4, 'SIZE_MB', 'string') AS r;
  SELECT
    write_excel_data(0, 5, 'COMMENT', 'string') AS r;
  SELECT
    write_excel_data(0, 6, 'CREATE_STATEMENT', 'string') AS r;

  OPEN cur_tables;

table_loop:
  LOOP
    FETCH cur_tables INTO v_table, v_engine, v_collation, v_comment, v_rows, v_size_mb;

    IF v_done THEN
      LEAVE table_loop;
    END IF;

    -- Get CREATE TABLE statement
    SET @show_sql = CONCAT('SHOW CREATE TABLE ', p_database, '.', v_table);
    PREPARE stmt FROM @show_sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

    -- Ambil hasil SHOW CREATE TABLE (perlu temporary table)
    DROP TEMPORARY TABLE IF EXISTS tmp_create;
    CREATE TEMPORARY TABLE tmp_create AS
    SELECT
      CONCAT('SHOW CREATE TABLE ', p_database, '.', v_table) AS tbl,
      '' AS create_stmt;

    SET @get_create = CONCAT('INSERT INTO tmp_create SELECT * FROM (',
    'SHOW CREATE TABLE ', p_database, '.', v_table, ') t');

    -- Workaround: gunakan SELECT INTO variable
    SET v_create_stmt = '';
    SET @sel_sql = CONCAT('SELECT `Create Table` INTO @v_create FROM (',
    'SHOW CREATE TABLE ', p_database, '.`', v_table, '`) t');
    PREPARE stmt FROM @sel_sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    SET v_create_stmt = @v_create;

    -- Tulis data
    SELECT
      write_excel_data(v_row, 0, v_table, 'string') AS r;
    SELECT
      write_excel_data(v_row, 1, IFNULL(v_engine, ''), 'string') AS r;
    SELECT
      write_excel_data(v_row, 2, IFNULL(v_collation, ''), 'string') AS r;
    SELECT
      write_excel_data(v_row, 3, IFNULL(v_rows, 0), 'integer') AS r;
    SELECT
      write_excel_data(v_row, 4, IFNULL(v_size_mb, 0), 'decimal') AS r;
    SELECT
      write_excel_data(v_row, 5, IFNULL(v_comment, ''), 'string') AS r;
    SELECT
      write_excel_data(v_row, 6, v_create_stmt, 'string') AS r;

    SET v_row = v_row + 1;
  END LOOP;

  CLOSE cur_tables;

  -- Sheet 2: Columns detail
  IF p_include_indexes THEN
    -- Tambah worksheet untuk columns
    SELECT
      workbook_add_worksheet(NULL, 'Columns') AS ws;

    -- Header columns
    SELECT
      write_excel_data(0, 0, 'TABLE', 'string') AS r;
    SELECT
      write_excel_data(0, 1, 'COLUMN', 'string') AS r;
    SELECT
      write_excel_data(0, 2, 'TYPE', 'string') AS r;
    SELECT
      write_excel_data(0, 3, 'NULL', 'string') AS r;
    SELECT
      write_excel_data(0, 4, 'KEY', 'string') AS r;
    SELECT
      write_excel_data(0, 5, 'DEFAULT', 'string') AS r;
    SELECT
      write_excel_data(0, 6, 'EXTRA', 'string') AS r;
    SELECT
      write_excel_data(0, 7, 'COMMENT', 'string') AS r;

    SET v_row = 1;

    -- Export semua kolom
    SET @col_sql = CONCAT('SELECT write_excel_data(@r:=@r+1, 0, TABLE_NAME, ''string''), ',
    'write_excel_data(@r, 1, COLUMN_NAME, ''string''), ',
    'write_excel_data(@r, 2, COLUMN_TYPE, ''string''), ',
    'write_excel_data(@r, 3, IS_NULLABLE, ''string''), ',
    'write_excel_data(@r, 4, COLUMN_KEY, ''string''), ',
    'write_excel_data(@r, 5, IFNULL(COLUMN_DEFAULT,''''), ''string''), ',
    'write_excel_data(@r, 6, EXTRA, ''string''), ',
    'write_excel_data(@r, 7, IFNULL(COLUMN_COMMENT,''''), ''string'') ',
    'FROM (SELECT @r:=0) r, information_schema.COLUMNS ',
    'WHERE TABLE_SCHEMA = ''', p_database, ''' ',
    'ORDER BY TABLE_NAME, ORDINAL_POSITION');

    PREPARE stmt FROM @col_sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
  END IF;

  -- Finalize
  SELECT
    finalize_excel() AS result;

  SELECT
    CONCAT('Schema backup selesai: ', v_row - 1, ' tables di-export ke ', p_filename) AS message;
END
$$

--
-- Create procedure `sp_backup_routines`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE sp_backup_routines (IN p_database varchar(64),
IN p_filename varchar(255),
IN p_type varchar(20) -- 'ALL', 'PROCEDURE', 'FUNCTION'
)
BEGIN
  DECLARE v_done int DEFAULT 0;
  DECLARE v_row int DEFAULT 0;
  DECLARE v_name varchar(64);
  DECLARE v_type varchar(20);
  DECLARE v_params text;
  DECLARE v_returns varchar(64);
  DECLARE v_body longtext;
  DECLARE v_definer varchar(93);
  DECLARE v_created datetime;
  DECLARE v_modified datetime;
  DECLARE v_comment text;
  DECLARE v_charset varchar(32);
  DECLARE v_collation varchar(32);
  DECLARE v_deterministic varchar(3);
  DECLARE v_security varchar(7);
  DECLARE v_sql_mode text;

  -- Cursor untuk routines
  DECLARE cur_routines CURSOR FOR
  SELECT
    ROUTINE_NAME,
    ROUTINE_TYPE,
    ROUTINE_DEFINITION,
    DEFINER,
    CREATED,
    LAST_ALTERED,
    ROUTINE_COMMENT,
    CHARACTER_SET_CLIENT,
    COLLATION_CONNECTION,
    IS_DETERMINISTIC,
    SECURITY_TYPE,
    SQL_MODE,
    DTD_IDENTIFIER
  FROM information_schema.ROUTINES
  WHERE ROUTINE_SCHEMA = p_database
  AND (p_type = 'ALL'
  OR ROUTINE_TYPE = p_type);

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_done = 1;

  -- Buat file Excel
  SELECT
    create_excel(p_filename, '#4472C4', 'Routines Backup') AS result;

  -- Tulis header
  SELECT
    write_excel_data(0, 0, 'ROUTINE_NAME', 'string') AS r;
  SELECT
    write_excel_data(0, 1, 'ROUTINE_TYPE', 'string') AS r;
  SELECT
    write_excel_data(0, 2, 'DEFINER', 'string') AS r;
  SELECT
    write_excel_data(0, 3, 'CREATED', 'string') AS r;
  SELECT
    write_excel_data(0, 4, 'MODIFIED', 'string') AS r;
  SELECT
    write_excel_data(0, 5, 'RETURNS', 'string') AS r;
  SELECT
    write_excel_data(0, 6, 'DETERMINISTIC', 'string') AS r;
  SELECT
    write_excel_data(0, 7, 'SECURITY', 'string') AS r;
  SELECT
    write_excel_data(0, 8, 'SQL_MODE', 'string') AS r;
  SELECT
    write_excel_data(0, 9, 'CHARSET', 'string') AS r;
  SELECT
    write_excel_data(0, 10, 'COLLATION', 'string') AS r;
  SELECT
    write_excel_data(0, 11, 'COMMENT', 'string') AS r;
  SELECT
    write_excel_data(0, 12, 'DEFINITION', 'string') AS r;

  SET v_row = 1;

  OPEN cur_routines;

read_loop:
  LOOP
    FETCH cur_routines INTO v_name, v_type, v_body, v_definer, v_created,
    v_modified, v_comment, v_charset, v_collation, v_deterministic,
    v_security, v_sql_mode, v_returns;

    IF v_done THEN
      LEAVE read_loop;
    END IF;

    -- Tulis data
    SELECT
      write_excel_data(v_row, 0, v_name, 'string') AS r;
    SELECT
      write_excel_data(v_row, 1, v_type, 'string') AS r;
    SELECT
      write_excel_data(v_row, 2, v_definer, 'string') AS r;
    SELECT
      write_excel_data(v_row, 3, DATE_FORMAT(v_created, '%Y-%m-%d %H:%i:%s'), 'datetime') AS r;
    SELECT
      write_excel_data(v_row, 4, DATE_FORMAT(IFNULL(v_modified, v_created), '%Y-%m-%d %H:%i:%s'), 'datetime') AS r;
    SELECT
      write_excel_data(v_row, 5, IFNULL(v_returns, ''), 'string') AS r;
    SELECT
      write_excel_data(v_row, 6, v_deterministic, 'string') AS r;
    SELECT
      write_excel_data(v_row, 7, v_security, 'string') AS r;
    SELECT
      write_excel_data(v_row, 8, v_sql_mode, 'string') AS r;
    SELECT
      write_excel_data(v_row, 9, v_charset, 'string') AS r;
    SELECT
      write_excel_data(v_row, 10, v_collation, 'string') AS r;
    SELECT
      write_excel_data(v_row, 11, IFNULL(v_comment, ''), 'string') AS r;
    SELECT
      write_excel_data(v_row, 12, v_body, 'string') AS r;

    SET v_row = v_row + 1;
  END LOOP;

  CLOSE cur_routines;

  -- Finalisasi file
  SELECT
    finalize_excel() AS result;

  SELECT
    CONCAT('Backup selesai: ', v_row - 1, ' routines di-export ke ', p_filename) AS message;
END
$$

--
-- Create procedure `sp_backup_data`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE sp_backup_data (IN p_table varchar(64),
IN p_filename varchar(255),
IN p_where_clause text,
IN p_limit int)
BEGIN
  DECLARE v_query text;
  DECLARE v_col_count int;
  DECLARE v_col_name varchar(64);
  DECLARE v_col_type varchar(64);
  DECLARE v_i int DEFAULT 0;
  DECLARE v_done int DEFAULT 0;

  -- Cursor untuk kolom
  DECLARE cur_cols CURSOR FOR
  SELECT
    COLUMN_NAME,
    DATA_TYPE
  FROM information_schema.COLUMNS
  WHERE TABLE_SCHEMA = DATABASE()
  AND TABLE_NAME = p_table
  ORDER BY ORDINAL_POSITION;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_done = 1;

  -- Buat file Excel
  SELECT
    create_excel(p_filename, '#70AD47', p_table) AS result;

  -- Tulis header dari metadata kolom
  OPEN cur_cols;
  SET v_i = 0;

header_loop:
  LOOP
    FETCH cur_cols INTO v_col_name, v_col_type;
    IF v_done THEN
      LEAVE header_loop;
    END IF;

    SELECT
      write_excel_data(0, v_i, v_col_name, 'string') AS r;
    SET v_i = v_i + 1;
  END LOOP;

  CLOSE cur_cols;

  -- Buat query dinamis untuk export data
  SET @v_select = 'SELECT ';
  SET @v_cols = '';
  SET v_done = 0;
  SET v_i = 0;

  OPEN cur_cols;

col_loop:
  LOOP
    FETCH cur_cols INTO v_col_name, v_col_type;
    IF v_done THEN
      LEAVE col_loop;
    END IF;

    IF v_i > 0 THEN
      SET @v_cols = CONCAT(@v_cols, ', ');
    END IF;

    -- Tentukan tipe data Excel berdasarkan MySQL type
    SET @v_excel_type = CASE WHEN v_col_type IN ('int', 'bigint', 'smallint', 'tinyint') THEN 'integer' WHEN v_col_type IN ('decimal', 'float', 'double') THEN 'decimal' WHEN v_col_type = 'date' THEN 'date' WHEN v_col_type IN ('datetime', 'timestamp') THEN 'datetime' ELSE 'string' END;

    SET @v_cols = CONCAT(@v_cols,
    'write_excel_data(@row_num, ', v_i, ', ',
    'IFNULL(', v_col_name, ',\'\'), \'', @v_excel_type, '\') AS c', v_i);

    SET v_i = v_i + 1;
  END LOOP;

  CLOSE cur_cols;

  -- Build complete query
  SET @v_query = CONCAT('SELECT @row_num:=@row_num+1 AS row_num, ', @v_cols,
  ' FROM (SELECT @row_num:=0) r, ', p_table);

  IF p_where_clause IS NOT NULL
    AND p_where_clause != '' THEN
    SET @v_query = CONCAT(@v_query, ' WHERE ', p_where_clause);
  END IF;

  IF p_limit IS NOT NULL
    AND p_limit > 0 THEN
    SET @v_query = CONCAT(@v_query, ' LIMIT ', p_limit);
  END IF;

  -- Execute export
  PREPARE stmt FROM @v_query;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

  -- Finalisasi
  SELECT
    finalize_excel() AS result;

  SELECT
    CONCAT('Export data selesai: ', p_table, ' -> ', p_filename) AS message;
END
$$

--
-- Create procedure `SPSO_UP_TRACEID_PUTOLIGHT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_UP_TRACEID_PUTOLIGHT (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_waveNo varchar(100),
IN IN_orderNo varchar(100),
IN IN_Language varchar(10),
IN IN_UserID varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#SPSO_UP_TRACEID_PUTOLIGHT', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_returnCode;
    END;

    SET OUT_returnCode = '000';
    SELECT
      COUNT(1) INTO v_nrow
    FROM DOC_WAVE_DETAILS dwd
      LEFT JOIN DOC_WAVE_HEADER dwh
        ON dwd.organizationId = dwh.organizationId
        AND dwd.warehouseId = dwh.warehouseId
        AND dwd.waveNo = dwh.waveNo
      LEFT JOIN IDX_PUTTOLIGHT ip
        ON dwd.organizationId = ip.organizationId
        AND dwd.warehouseId = ip.warehouseId
        AND dwd.waveNo = ip.waveNo
        AND dwd.orderNo = ip.docNo
      LEFT JOIN ACT_ALLOCATION_DETAILS aad
        ON ip.organizationId = aad.organizationId
        AND ip.warehouseId = aad.warehouseId
        AND ip.waveNo = aad.waveNo
        AND ip.docNo = aad.orderNo
        AND ip.sku = aad.sku
    WHERE dwd.organizationId = IN_organizationId
    AND dwd.warehouseId = IN_warehouseId
    AND dwd.waveNo = IN_waveNo
    AND dwd.orderNo = IN_orderNo;

    IF v_nrow > 0 THEN

      UPDATE IDX_PUTTOLIGHT dest, (SELECT
          organizationId,
          warehouseId,
          waveNo,
          orderNo,
          pickToTraceId,
          sku
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseId
        AND waveNo = IN_waveNo
        AND orderNo = IN_orderNo) src
      SET dest.fmTraceId = src.pickToTraceId,
          dest.editWho = IN_UserID,
          dest.editTime = NOW()
      WHERE dest.organizationId = src.organizationId
      AND dest.warehouseId = src.warehouseId
      AND dest.waveNo = src.waveNo
      AND dest.docNo = src.OrderNo
      AND dest.sku = src.sku;
    END IF;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPSO_Shipment_Process_bak0911`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_Shipment_Process_bak0911 (IN IN_organizationId varchar(20),
IN IN_WarehouseID varchar(20),
IN IN_Action varchar(30),
IN IN_ProcessBy varchar(30),







IN IN_WaveNO varchar(20),
IN IN_OrderNO varchar(20),
IN IN_OrderLineNO varchar(20),
IN IN_AllocationDetailsID varchar(20),
IN IN_OutboundTime_CC varchar(20),
IN IN_Language varchar(2),
IN IN_UserID varchar(35),
INOUT OUT_Return_Code varchar(200))
ENDPROC:
  BEGIN

    DECLARE r_NO_COMMIT varchar(1);
    DECLARE r_SHP_CTL varchar(1);
    DECLARE V_S varchar(10);
    DECLARE r_UDF2 varchar(1);
    DECLARE r_DEL_NO_CHK varchar(1);
    DECLARE r_BillNo varchar(35);
    DECLARE r_CustomerID_R varchar(30);
    DECLARE r_OrderType varchar(10);
    DECLARE r_HoldCheck varchar(1);
    DECLARE r_ReleaseStatus varchar(1);
    DECLARE r_nRow int;
    DECLARE r_OrderNo varchar(30);
    DECLARE r_CancelOrderNO varchar(3000);
    DECLARE r_LOADING_LIST_MODE varchar(20);
    DECLARE r_OrderNoes varchar(2000);
    DECLARE r_LDLNo varchar(15);
    DECLARE r_ShippmentCount int;
    DECLARE r_SN_CTL varchar(1);
    DECLARE r_Qtyallocated_Each decimal(18, 8);
    DECLARE r_Status varchar(2);
    DECLARE r_TransactionID varchar(10);
    DECLARE r_QtyOrdered_Each_O decimal(18, 8);
    DECLARE r_QtyShipped_Each_O decimal(18, 8);
    DECLARE r_QtyShipped_O decimal(18, 8);
    DECLARE r_LineStatus varchar(2);
    DECLARE r_PackFlag varchar(1);
    DECLARE r_QTY1_P decimal(18, 8);
    DECLARE r_QTY2_P decimal(18, 8);
    DECLARE r_QTY3_P decimal(18, 8);
    DECLARE r_QTY4_P decimal(18, 8);
    DECLARE r_QTY5_P decimal(18, 8);
    DECLARE r_CurrentTime datetime;
    DECLARE r_UOMQty decimal(18, 8);
    DECLARE r_UOM_O varchar(10);
    DECLARE r_PACKID_O varchar(40);
    DECLARE r_AllocationDetailsID_R varchar(30);
    DECLARE r_OrderNO_R varchar(30);
    DECLARE r_OrderLineNO_R int;
    DECLARE r_Sku_R varchar(50);
    DECLARE r_LotNUM_R varchar(10);
    DECLARE r_Location_R varchar(50);
    DECLARE r_TraceID_R varchar(50);
    DECLARE r_Qty_R decimal(18, 8);
    DECLARE r_Qty_Each_R decimal(18, 8);
    DECLARE r_PackID_R varchar(40);
    DECLARE r_UOM_R varchar(10);
    DECLARE r_WaveNO_R varchar(50);
    DECLARE r_Status_R varchar(2);
    DECLARE r_QtyPicked_Each_R decimal(18, 8);
    DECLARE r_QtyShipped_Each_R decimal(18, 8);
    DECLARE r_PickToLocation_R varchar(50);
    DECLARE r_PickToTraceID_R varchar(50);
    DECLARE r_PickedTime_R datetime;
    DECLARE r_PickedWho_R varchar(35);
    DECLARE r_ShipmentTime_R datetime;
    DECLARE r_ShipmentWho_R varchar(35);
    DECLARE r_ReasonCode_R varchar(100);
    DECLARE r_Notes_R varchar(100);
    DECLARE r_Cubic_R decimal(18, 8);
    DECLARE r_GrossWeight_R decimal(18, 8);
    DECLARE r_NetWeight_R decimal(18, 8);
    DECLARE r_Price_R decimal(18, 8);
    DECLARE r_OutboundTime datetime;
    DECLARE r_CTL_Status varchar(2);
    DECLARE SP_SQL_r varchar(1000);
    DECLARE r_WarehouseID varchar(30);
    DECLARE r_Wavestatus varchar(2);
    DECLARE r_PickToTraceID varchar(50);

    DECLARE r_OVR_ALC varchar(1);

    DECLARE r_SALESORDERNO varchar(30);
    DECLARE r_SALESORDERLINENO int;
    DECLARE v_strsql varchar(10000);
    DECLARE r_erpcancelflag varchar(1);
    DECLARE r_DoubleConfirmBy varchar(20);
    DECLARE r_CheckTime datetime;
    DECLARE C_ACT CURSOR FOR
    SELECT
      A.AllocationDetailsID,
      A.OrderNo,
      A.OrderLineNo,
      A.WaveNo,
      A.CustomerID,
      A.SKU,
      A.Lotnum,
      A.UOM,
      A.Location,
      A.TraceID,
      A.Qty,
      A.Qty_Each,
      A.PackID,
      A.Status,
      PickToLocation,
      A.PickTOTraceID,
      A.QtyPicked_Each,
      A.PickedTime,
      A.PickedWho,
      A.QtyShipped_Each,
      A.ShipmentTime,
      A.ShipmentWho,
      A.ReasonCode,
      A.Notes,
      A.Cubic,
      A.Grossweight,
      A.Netweight,
      A.Price,
      A.PackFlag,
      B.SALESORDERNO,
      B.SALESORDERLINENO,
      B.erpcancelflag,
      A.DoubleConfirmBy,
      A.CHECKTIME
    FROM TMP_SHIPMENT_LIST A
      INNER JOIN DOC_ORDER_DETAILS B
        ON A.organizationId = B.organizationId
        AND A.warehouseId = B.warehouseId
        AND A.ORDERNO = B.ORDERNO
        AND A.ORDERLINENO = B.ORDERLINENO
    WHERE A.organizationId = IN_OrganizationId
    AND A.warehouseId = IN_WarehouseID
    AND A.Userid = IN_UserID;

    DECLARE C_ODR CURSOR FOR
    SELECT
      h.orderno
    FROM DOC_ORDER_HEADER h
    WHERE h.organizationId = IN_OrganizationId
    AND h.warehouseId = IN_WarehouseID
    AND h.sostatus = '80'
    AND EXISTS (SELECT
        1
      FROM TMP_SHIPMENT_LIST t
      WHERE t.organizationId = h.organizationId
      AND t.warehouseId = h.warehouseId
      AND t.orderno = h.orderno
      AND t.Userid = IN_UserID);
    DECLARE C_ship CURSOR FOR
    SELECT
      h.orderno
    FROM DOC_ORDER_HEADER h
    WHERE h.organizationId = IN_OrganizationId
    AND h.warehouseId = IN_WarehouseID
    AND h.AllowShipment = 'N'
    AND EXISTS (SELECT
        t.orderno
      FROM TMP_SHIPMENT_LIST t
      WHERE t.organizationId = h.organizationId
      AND t.warehouseId = h.warehouseId
      AND t.orderno = h.orderno
      AND t.Userid = IN_UserID);
    DECLARE CUR_FULLCarton CURSOR FOR
    SELECT DISTINCT
      PicktoTraceID,
      PickToLocation
    FROM ACT_ALLOCATION_DETAILS
    WHERE organizationId = IN_OrganizationId
    AND warehouseId = IN_WarehouseID
    AND OrderNo = IN_OrderNo;

    SET r_LDLNo = '*';
    SET r_ShippmentCount = 0;
    IF Out_return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET r_NO_COMMIT = 'N';
    ELSE
      SET r_NO_COMMIT = 'Y';
    END IF;
    IF NOT (UPPER(IN_Action) IN ('SHIP', 'TRANSFORM')) THEN
      SET OUT_Return_Code = '887';
      LEAVE ENDPROC;
    END IF;
    IF UPPER(IN_ProcessBy) = 'WAVENO'
      OR UPPER(IN_ProcessBy) = 'LOADLIST' THEN
      SET R_BillNo = IN_WaveNO;
    ELSEIF UPPER(IN_ProcessBy) = 'ORDERNO'
      OR UPPER(IN_ProcessBy) = 'ORDERNO + ORDERLINENO' THEN
      SET R_BillNo = IN_OrderNo;
    ELSEIF UPPER(IN_ProcessBy) = 'ALLOCATIONDETAILSID'
      OR UPPER(IN_ProcessBy) = 'DROPID'
      OR UPPER(IN_ProcessBy) = 'PICKTOTRACEID' THEN
      SET R_BillNo = IN_AllocationDetailsID;
    END IF;





    SET r_HoldCheck = 'N';
    IF UPPER(IN_ProcessBy) = 'WAVENO' THEN
      SELECT
        a.OrderType,
        a.CustomerID,
        c.ReleaseStatus,
        a.orderno
      FROM DOC_ORDER_HEADER a
        INNER JOIN DOC_WAVE_DETAILS b
          ON a.organizationId = b.organizationId
          AND a.warehouseId = b.warehouseId
          AND a.OrderNo = b.OrderNo
        INNER JOIN DOC_WAVE_HEADER c
          ON b.organizationId = c.organizationId
          AND b.warehouseId = c.warehouseId
          AND b.WaveNo = c.WaveNo
      WHERE a.organizationId = IN_OrganizationId
      AND a.warehouseId = IN_WarehouseID
      AND b.WaveNo = IN_WaveNO LIMIT 1 INTO r_OrderType, r_CustomerID_R, r_ReleaseStatus, r_OrderNo;

      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '402';
        LEAVE ENDPROC;
      END IF;

      SELECT
        COUNT(*),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          a.OrderNO
        FROM DOC_ORDER_HEADER a
          INNER JOIN DOC_WAVE_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNo = b.OrderNo
        WHERE a.organizationId = IN_OrganizationId
        AND a.warehouseId = IN_WarehouseID
        AND b.WaveNo = IN_WaveNO
        AND (a.ReleaseStatus IN ('N', 'H')
        OR a.ERPCancelFlag = 'Y')
        GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;

      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;
    ELSEIF UPPER(IN_ProcessBy) = 'LOADLIST' THEN
      SET r_LOADING_LIST_MODE = getsys_configuration_D(IN_OrganizationId, IN_WarehouseID, '*', '*', 'LOADING_LIST_MODE', 'N');
      IF r_LOADING_LIST_MODE = 'BYORDER' THEN
        SELECT
          a.OrderType,
          a.CustomerID,
          a.ReleaseStatus,
          a.orderno
        FROM DOC_ORDER_HEADER a
          INNER JOIN DOC_LOADING_DETAILS c
            ON a.organizationId = c.organizationId
            AND a.warehouseId = c.warehouseId
            AND a.OrderNo = c.OrderNo
        WHERE a.organizationId = IN_OrganizationId
        AND a.warehouseId = IN_WarehouseID
        AND c.LDLNo = IN_WaveNo
        LIMIT 1 INTO r_OrderType, r_CustomerID_R, r_ReleaseStatus, r_OrderNo;

        IF FOUND_ROWS() = 0 THEN
          SET OUT_Return_Code = '402';
          LEAVE ENDPROC;
        END IF;

        SELECT
          COUNT(*),
          GROUP_CONCAT(orderno)
        FROM (SELECT
            a.OrderNO
          FROM DOC_ORDER_HEADER a
            INNER JOIN DOC_LOADING_DETAILS c
              ON a.organizationId = c.organizationId
              AND a.warehouseId = c.warehouseId
              AND a.OrderNo = c.OrderNo
          WHERE a.organizationId = IN_OrganizationId
          AND a.warehouseId = IN_WarehouseID
          AND c.LDLNo = IN_WaveNo
          AND (a.ReleaseStatus IN ('N', 'H')
          OR a.ERPCancelFlag = 'Y')
          GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;
      ELSE
        SELECT
          a.OrderType,
          a.CustomerID,
          a.ReleaseStatus,
          a.orderno
        FROM DOC_ORDER_HEADER a
          INNER JOIN ACT_ALLOCATION_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNo = b.OrderNo
          INNER JOIN DOC_LOADING_DETAILS c
            ON b.organizationId = c.organizationId
            AND b.warehouseId = c.warehouseId
            AND b.AllocationDetailsid = c.AllocationDetailsID
        WHERE a.organizationId = IN_OrganizationId
        AND a.warehouseId = IN_WarehouseID
        AND c.LDLNo = IN_WaveNo
        LIMIT 1 INTO r_OrderType, r_CustomerID_R, r_ReleaseStatus, r_OrderNo;

        IF FOUND_ROWS() = 0 THEN
          SET OUT_Return_Code = '402';
          LEAVE ENDPROC;
        END IF;

        SELECT
          COUNT(*),
          GROUP_CONCAT(orderno)
        FROM (SELECT
            a.OrderNO
          FROM DOC_ORDER_HEADER a
            INNER JOIN ACT_ALLOCATION_DETAILS b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.OrderNo = b.OrderNo
            INNER JOIN DOC_LOADING_DETAILS c
              ON b.organizationId = c.organizationId
              AND b.warehouseId = c.warehouseId
              AND b.AllocationDetailsid = c.AllocationDetailsID
          WHERE a.organizationId = IN_OrganizationId
          AND a.warehouseId = IN_WarehouseID
          AND c.LDLNo = IN_WaveNo
          AND (a.ReleaseStatus IN ('N', 'H')
          OR a.ERPCancelFlag = 'Y')
          GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;
      END IF;

      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;

    ELSEIF UPPER(IN_ProcessBy) = 'PICKTOTRACEID' THEN
      SELECT
        a.OrderType,
        a.CustomerID,
        a.ReleaseStatus,
        a.orderno
      FROM DOC_ORDER_HEADER a
        INNER JOIN ACT_ALLOCATION_DETAILS b
          ON a.organizationId = b.organizationId
          AND a.warehouseId = b.warehouseId
          AND a.OrderNo = b.OrderNo
      WHERE a.organizationId = IN_OrganizationId
      AND a.warehouseId = IN_WarehouseID
      AND b.PickToTraceID = IN_AllocationDetailsID
      LIMIT 1 INTO r_OrderType, r_CustomerID_R, r_ReleaseStatus, r_OrderNo;

      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '402';
        LEAVE ENDPROC;
      END IF;

      SELECT
        COUNT(*),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          a.OrderNO
        FROM DOC_ORDER_HEADER a
          INNER JOIN ACT_ALLOCATION_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNo = b.OrderNo
        WHERE a.organizationId = IN_OrganizationId
        AND a.warehouseId = IN_WarehouseID
        AND b.PickToTraceID = IN_AllocationDetailsID
        AND (a.ReleaseStatus IN ('N', 'H')
        OR ERPCancelFlag = 'Y')
        GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;

      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;

    ELSEIF UPPER(IN_ProcessBy) = 'DROPID' THEN
      SELECT
        a.OrderType,
        a.CustomerID,
        a.ReleaseStatus,
        a.orderno
      FROM DOC_ORDER_HEADER a
        INNER JOIN ACT_Allocation_Details b
          ON a.organizationId = b.organizationId
          AND a.warehouseId = b.warehouseId
          AND a.OrderNo = b.OrderNo
      WHERE a.organizationId = IN_OrganizationId
      AND a.warehouseId = IN_WarehouseID
      AND b.dropID = IN_AllocationDetailsID
      LIMIT 1 INTO r_OrderType, r_CustomerID_R, r_ReleaseStatus, r_OrderNo;

      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '402';
        LEAVE ENDPROC;
      END IF;

      SELECT
        COUNT(*),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          a.OrderNO
        FROM DOC_ORDER_HEADER a
          INNER JOIN ACT_Allocation_Details b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNo = b.OrderNo
        WHERE a.organizationId = IN_OrganizationId
        AND a.warehouseId = IN_WarehouseID
        AND b.dropID = IN_AllocationDetailsID
        AND (a.ReleaseStatus IN ('N', 'H')
        OR ERPCancelFlag = 'Y')
        GROUP BY a.Orderno) AA INTO r_nRow, r_CancelOrderNO;

      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;

    ELSE
      SELECT
        OrderType,
        CustomerID,
        ReleaseStatus,
        orderno
      FROM DOC_ORDER_HEADER
      WHERE organizationId = IN_OrganizationId
      AND warehouseId = IN_WarehouseID
      AND OrderNo = IN_OrderNO
      LIMIT 1 INTO r_OrderType, r_CustomerID_R, r_ReleaseStatus, r_OrderNo;
      IF FOUND_ROWS() = 0 THEN
        SET OUT_Return_Code = '402';
        LEAVE ENDPROC;
      END IF;
      SELECT
        COUNT(*),
        GROUP_CONCAT(orderno)
      FROM (SELECT
          OrderNO
        FROM DOC_ORDER_HEADER
        WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND OrderNo = IN_OrderNO
        AND (ReleaseStatus IN ('N', 'H')
        OR ERPCancelFlag = 'Y')
        GROUP BY Orderno) AA INTO r_nRow, r_CancelOrderNO;

      IF r_nRow > 0 THEN
        SET r_HoldCheck = 'Y';
      END IF;

    END IF;
    IF r_HoldCheck = 'Y' THEN
      SET OUT_Return_Code = '432';
      LEAVE ENDPROC;
    END IF;


    SET r_SHP_CTL = getsys_configuration_D(IN_OrganizationId, IN_WarehouseID, r_CustomerID_R, r_OrderType, 'SHP_CTL', 'N');

    SET V_S = getsys_configuration_D(IN_OrganizationId, IN_WarehouseID, r_CustomerID_R, r_OrderType, 'TRN_TYP', 'N');

    SET r_DEL_NO_CHK = getsys_configuration_D(IN_OrganizationId, IN_WarehouseID, r_CustomerID_R, r_OrderType, 'DEL_NO_CHK', 'N');
    SET r_SN_CTL = getsys_configuration_D(IN_OrganizationId, IN_WarehouseID, r_CustomerID_R, r_OrderType, 'SN#_CTL', '0');
    IF r_DEL_NO_CHK = 'Y' THEN
      SELECT
        COUNT(*) INTO r_nRow
      FROM DOC_Order_Packing_Summary
      WHERE OrderNo = R_OrderNo
      AND IFNULL(DeliveryNo, '') = '';
      IF r_nRow > 0 THEN
        SET OUT_Return_Code = '447';
        LEAVE ENDPROC;
      END IF;
    END IF;
    IF INSTR(V_S, 'SO') > 0 THEN
      SET r_UDF2 = 'N';
    ELSE
      SET r_UDF2 = 'O';
    END IF;

    DROP TABLE IF EXISTS TMP_SHIPMENT_LIST;
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_SHIPMENT_LIST (
      organizationId varchar(30),
      warehouseId varchar(30),
      allocationdetailsid varchar(10),
      orderno varchar(20),
      orderlineno int,
      waveno varchar(30),
      customerid varchar(30),
      sku varchar(50),
      lotnum varchar(10),
      uom varchar(10),
      location varchar(30),
      traceid varchar(30),
      qty decimal(18, 8),
      qty_each decimal(18, 8),
      packid varchar(40),
      STATUS char(2),
      picktolocation varchar(30),
      picktotraceid varchar(30),
      qtypicked_each decimal(18, 8),
      pickedtime datetime,
      pickedwho varchar(30),
      qtyshipped_each decimal(18, 8),
      shipmenttime datetime,
      shipmentwho varchar(30),
      reasoncode char(2),
      notes varchar(100),
      cubic decimal(18, 8),
      grossweight decimal(18, 8),
      netweight decimal(18, 8),
      price decimal(18, 8),
      packflag char(1),
      userid varchar(30),
      doubleconfirmby varchar(30),
      checktime datetime
    );
    IF UPPER(IN_ProcessBy) = 'WAVENO' THEN
      INSERT INTO TMP_SHIPMENT_LIST (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          organizationId,
          warehouseId,
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME - -V432G
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND WaveNo = IN_WaveNO
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('OrderNo') THEN
      INSERT INTO TMP_SHIPMENT_LIST (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          organizationId,
          warehouseId,
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND OrderNO = IN_OrderNO
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('OrderNo + OrderLineNo') THEN
      INSERT INTO TMP_SHIPMENT_LIST (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          organizationId,
          warehouseId,
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND OrderNO = IN_OrderNO
        AND OrderLineNo = IN_OrderLineNo
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('AllocationDetailsID') THEN
      INSERT INTO TMP_SHIPMENT_LIST (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          organizationId,
          warehouseId,
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND AllocationDetailsID = IN_AllocationDetailsID
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('PickToTraceID') THEN
      INSERT INTO TMP_SHIPMENT_LIST (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          organizationId,
          warehouseId,
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND PickToTraceID = IN_AllocationDetailsID
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('DropID') THEN
      INSERT INTO TMP_SHIPMENT_LIST (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
      , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
      , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
      , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
      , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
        SELECT
          organizationId,
          warehouseId,
          AllocationDetailsID,
          OrderNo,
          OrderLineNO,
          WaveNo,
          CustomerID,
          SKU,
          LotNUM,
          UOM,
          Location,
          TraceID,
          Qty,
          Qty_Each,
          PackID,
          STATUS,
          PickToLocation,
          PickToTraceID,
          QtyPicked_Each,
          PickedTime,
          PickedWho,
          QtyShipped_Each,
          ShipmentTime,
          ShipmentWho,
          ReasonCode,
          Notes,
          Cubic,
          GrossWeight,
          NetWeight,
          Price,
          PackFlag,
          IN_UserID,
          doublecheckby,
          CHECKTIME
        FROM ACT_ALLOCATION_DETAILS
        WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND DropID = IN_AllocationDetailsID
        AND STATUS < '80';
    ELSEIF UPPER(IN_ProcessBy) = UPPER('LoadList') THEN
      IF r_LOADING_LIST_MODE = 'BYORDER' THEN
        INSERT INTO TMP_SHIPMENT_LIST (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
        , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
        , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
        , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
        , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
          SELECT
            a.organizationId,
            a.warehouseId,
            a.AllocationDetailsID,
            a.OrderNo,
            a.OrderLineNO,
            a.WaveNo,
            a.CustomerID,
            a.SKU,
            a.LotNUM,
            a.UOM,
            a.Location,
            a.TraceID,
            a.Qty,
            a.Qty_Each,
            a.PackID,
            a.STATUS,
            a.PickToLocation,
            a.PickToTraceID,
            a.QtyPicked_Each,
            a.PickedTime,
            a.PickedWho,
            a.QtyShipped_Each,
            a.ShipmentTime,
            a.ShipmentWho,
            a.ReasonCode,
            a.Notes,
            a.Cubic,
            a.GrossWeight,
            a.NetWeight,
            a.Price,
            a.PackFlag,
            IN_UserID,
            a.doublecheckby,
            a.CHECKTIME
          FROM ACT_ALLOCATION_DETAILS a
            INNER JOIN DOC_LOADING_DETAILS b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.OrderNo = b.OrderNo
          WHERE a.organizationId = IN_OrganizationId
          AND a.warehouseId = IN_WarehouseID
          AND b.LDLNo = IN_WaveNO
          AND a.Status < '80';
      ELSE
        INSERT INTO TMP_SHIPMENT_LIST (organizationId, warehouseId, AllocationDetailsID, OrderNo, OrderLineNo, WaveNo
        , CustomerID, SKU, Lotnum, UOM, Location, TraceID, Qty, Qty_Each, PackID, STATUS
        , PickToLocation, PickTOTraceID, QtyPicked_Each, PickedTime, PickedWho
        , QtyShipped_Each, ShipmentTime, ShipmentWho, ReasonCode, Notes
        , Cubic, Grossweight, Netweight, Price, PackFlag, userid, DoubleConfirmBy, CHECKTIME)
          SELECT
            a.organizationId,
            a.warehouseId,
            a.AllocationDetailsID,
            a.OrderNo,
            a.OrderLineNO,
            a.WaveNo,
            a.CustomerID,
            a.SKU,
            a.LotNUM,
            a.UOM,
            a.Location,
            a.TraceID,
            a.Qty,
            a.Qty_Each,
            a.PackID,
            a.STATUS,
            a.PickToLocation,
            a.PickToTraceID,
            a.QtyPicked_Each,
            a.PickedTime,
            a.PickedWho,
            a.QtyShipped_Each,
            a.ShipmentTime,
            a.ShipmentWho,
            a.ReasonCode,
            a.Notes,
            a.Cubic,
            a.GrossWeight,
            a.NetWeight,
            a.Price,
            a.PackFlag,
            IN_UserID,
            a.doublecheckby,
            a.CHECKTIME
          FROM ACT_ALLOCATION_DETAILS a
            INNER JOIN DOC_LOADING_DETAILS b
              ON a.organizationId = b.organizationId
              AND a.warehouseId = b.warehouseId
              AND a.AllocationDetailsID = b.AllocationDetailsID
          WHERE a.organizationId = IN_OrganizationId
          AND a.warehouseId = IN_WarehouseID
          AND b.LDLNo = IN_WaveNO
          AND a.Status < '80';
      END IF;
    END IF;
    SELECT
      COUNT(1)
    FROM TMP_SHIPMENT_LIST
    WHERE organizationId = IN_OrganizationId
    AND warehouseId = IN_WarehouseID
    AND userid = IN_UserID INTO r_nRow;
    IF r_nRow = 0 THEN
      SET OUT_Return_Code = '413';
      LEAVE ENDPROC;
    END IF;
    SELECT
      GROUP_CONCAT(h.OrderNo)
    FROM DOC_ORDER_HEADER h
    WHERE h.organizationId = IN_OrganizationId
    AND h.warehouseId = IN_WarehouseID
    AND EXISTS (SELECT
        t.orderno
      FROM TMP_SHIPMENT_LIST t
      WHERE t.organizationId = h.organizationId
      AND t.warehouseId = h.warehouseId
      AND t.OrderNo = h.OrderNo
      AND t.userid = IN_UserID)
    AND h.allowPartialShip = 'N'
    AND EXISTS (SELECT
        1
      FROM DOC_ORDER_DETAILS t
      WHERE t.organizationId = h.organizationId
      AND t.warehouseId = h.warehouseId
      AND t.OrderNo = h.OrderNo
      AND t.qtyallocated_each < t.qtyordered_each) INTO r_OrderNoes;
    IF IFNULL(r_OrderNoes, '') <> '' THEN
      SET OUT_Return_Code = CONCAT('999#??', r_OrderNoes, '?????????');
      LEAVE ENDPROC;
    END IF;

    IF UPPER(IN_ProcessBy) = UPPER('DropID') THEN
      DELETE
        FROM DOC_Order_Packing
      WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND TraceID = r_PickToTraceID_R;
    ELSEIF UPPER(IN_ProcessBy) = UPPER('OrderNo') THEN
      DELETE
        FROM DOC_Order_Packing
      WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND OrderNo = r_OrderNO_R;
    END IF;
    IF r_ShippmentCount < 1 THEN
      SET OUT_Return_Code = '413';
      LEAVE ENDPROC;
    END IF;

    IF UPPER(IN_ProcessBy) = 'ALLOCATIONDETAILSID' THEN
      UPDATE DOC_LOADING_DETAILS
      SET STATUS = '80'
      WHERE organizationId = IN_OrganizationId
      AND warehouseId = IN_WarehouseID
      AND AllocationDetailsID = IN_AllocationDetailsID;

      SELECT
        LDLNo
      FROM DOC_LOADING_DETAILS
      WHERE organizationId = IN_OrganizationId
      AND warehouseId = IN_WarehouseID
      AND AllocationDetailsID = IN_AllocationDetailsID INTO r_LDLNo;
    END IF;
    IF UPPER(IN_ProcessBy) = 'DROPID'
      OR UPPER(IN_ProcessBy) = 'PICKTOTRACEID' THEN
      UPDATE DOC_LOADING_DETAILS
      SET STATUS = '80'
      WHERE organizationId = IN_OrganizationId
      AND warehouseId = IN_WarehouseID
      AND TraceID = IN_AllocationDetailsID;

      SELECT
        LDLNo
      FROM DOC_LOADING_DETAILS
      WHERE organizationId = IN_OrganizationId
      AND warehouseId = IN_WarehouseID
      AND TraceID = IN_AllocationDetailsID
      LIMIT 1 INTO r_LDLNo;
    END IF;
    IF UPPER(IN_ProcessBy) = 'LOADLIST' THEN
      SET r_LDLNo = IN_WaveNo;
    END IF;
    IF IFNULL(r_LDLNO, '*') <> '*' THEN
      IF r_LOADING_LIST_MODE = 'BYORDER' THEN
        SELECT
          COUNT(*)
        FROM DOC_LOADING_DETAILS a
          INNER JOIN DOC_ORDER_HEADER b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.OrderNO = b.OrderNO
        WHERE a.organizationId = IN_OrganizationId
        AND a.warehouseId = IN_WarehouseID
        AND a.LDLNo = r_LDLNO
        AND b.SOStatus < '80' INTO r_nRow;
      ELSE
        SELECT
          COUNT(*)
        FROM DOC_LOADING_DETAILS a
          INNER JOIN ACT_ALLOCATION_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.AllocationDetailsID = b.AllocationDetailsID
        WHERE a.organizationId = IN_OrganizationId
        AND a.warehouseId = IN_WarehouseID
        AND a.LDLNo = r_LDLNO
        AND b.Status < '80' INTO r_nRow;
      END IF;
      IF r_nRow = 0 THEN
        UPDATE DOC_LOADING_HEADER
        SET STATUS = '80'
        WHERE organizationId = IN_OrganizationId
        AND warehouseId = IN_WarehouseID
        AND LDLNO = r_LDLNO;
      END IF;
    END IF;


    SET OUT_Return_Code = '*_*';
    CALL SPSO_StatusLog_Process(IN_OrganizationId, IN_WarehouseID, IN_ProcessBy, IN_WaveNO, IN_OrderNO, IN_AllocationDetailsID, '*', IN_Language, IN_UserID, OUT_Return_Code);
    IF SUBSTRING(OUT_Return_Code, 1, 3) <> '000' THEN
      ROLLBACK;
      LEAVE ENDPROC;
    END IF;

    IF r_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code = '000';
  END
  $$

--
-- Create procedure `SPSO_AllowShipment_Update`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPSO_AllowShipment_Update (IN IN_organizationId varchar(20),
IN IN_WarehouseID varchar(20),
IN IN_OrderNo varchar(20),
IN IN_Language varchar(20),
IN IN_UserID varchar(20),
INOUT OUT_Return_Code varchar(1000))
ENDPROC:
  BEGIN

    DECLARE r_customerid varchar(30);
    DECLARE r_carrierid varchar(30);
    DECLARE r_ordertype varchar(30);
    DECLARE r_sostatus varchar(30);
    DECLARE r_ALLOW_PARTIAL_SHIP varchar(30);
    DECLARE r_allowshipment char(1);
    DECLARE r_Deliveryno varchar(30);
    DECLARE r_picked char(1) DEFAULT 'N';
    DECLARE r_weighted char(1) DEFAULT 'N';
    DECLARE r_checked char(1) DEFAULT 'N';
    DECLARE r_pack char(1) DEFAULT 'N';
    DECLARE r_deliverconfirm char(1) DEFAULT 'N';
    DECLARE r_nrow int;
    DECLARE r_nrow_2 int;
    DECLARE r_nrow_3 int;
    DECLARE r_CurrentTime timestamp;
    DECLARE r_Trans_Control char(1);
    DECLARE r_CHK_TYP varchar(30);
    DECLARE r_loading char(1) DEFAULT 'N';

    DECLARE v_done char(2);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SET OUT_Return_Code = CONCAT('999#SPSO_AllowShipment_Update,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_Return_Code AS error;
    END;

    IF OUT_Return_Code = '*_*' THEN
      SET r_Trans_Control := 'N';
    ELSE
      SET r_Trans_Control := 'Y';
    END IF;
    SET r_CurrentTime := NOW();
    SET OUT_Return_Code := '000';

    SELECT
      h.customerid,
      h.carrierid,
      h.ordertype,
      h.sostatus,
      h.allowshipment,
      h.Deliveryno,
      h.allowpartialship
    FROM DOC_ORDER_HEADER h
    WHERE h.organizationId = IN_organizationId
    AND h.WarehouseID = IN_WarehouseID
    AND h.orderno = IN_OrderNo INTO r_customerid, r_carrierid, r_ordertype, r_sostatus,
    r_allowshipment, r_Deliveryno, r_ALLOW_PARTIAL_SHIP;

    IF v_done = 0 THEN
      SET OUT_Return_Code := CONCAT('104??', IN_OrderNo);
      LEAVE endproc;
    END IF;

    IF r_allowshipment = 'Y' THEN
      SET OUT_Return_Code := '000';
      LEAVE endproc;
    END IF;

    SELECT
      r.picked,
      r.weighted,
      r.checked,
      r.pack,
      r.deliverconfirm,
      r.loading
    FROM RUL_AUTOSHIP r
    WHERE r.organizationId = IN_organizationId
    AND r.warehouseid = IN_WarehouseID
    AND r.customerid = r_customerid
    AND r.carrierid = r_carrierid
    AND r.ordertype = r_ordertype INTO r_picked, r_weighted, r_checked, r_pack, r_deliverconfirm, r_loading;
    IF v_done = 0 THEN

      SELECT
        r.picked,
        r.weighted,
        r.checked,
        r.pack,
        r.deliverconfirm,
        r.loading
      FROM RUL_AUTOSHIP r
      WHERE r.warehouseid = IN_WarehouseID
      AND r.customerid = r_customerid
      AND r.carrierid = r_carrierid
      AND r.ordertype = '*' INTO r_picked, r_weighted, r_checked, r_pack, r_deliverconfirm, r_loading;
      IF v_done = 0 THEN

        SELECT
          r.picked,
          r.weighted,
          r.checked,
          r.pack,
          r.deliverconfirm,
          r.loading
        FROM RUL_AUTOSHIP r
        WHERE r.organizationId = IN_organizationId
        AND r.warehouseid = IN_WarehouseID
        AND r.customerid = r_customerid
        AND r.carrierid = '*'
        AND r.ordertype = r_ordertype INTO r_picked, r_weighted, r_checked, r_pack, r_deliverconfirm, r_loading;
        IF v_done = 0 THEN

          SELECT
            r.picked,
            r.weighted,
            r.checked,
            r.pack,
            r.deliverconfirm,
            r.loading
          FROM RUL_AUTOSHIP r
          WHERE r.organizationId = IN_organizationId
          AND r.warehouseid = IN_WarehouseID
          AND r.customerid = r_customerid
          AND r.carrierid = '*'
          AND r.ordertype = '*' INTO r_picked, r_weighted, r_checked, r_pack, r_deliverconfirm, r_loading;
          IF v_done = 0 THEN

            SELECT
              r.picked,
              r.weighted,
              r.checked,
              r.pack,
              r.deliverconfirm,
              r.loading
            FROM RUL_AUTOSHIP r
            WHERE r.organizationId = IN_organizationId
            AND r.warehouseid = IN_WarehouseID
            AND r.customerid = '*'
            AND r.carrierid = '*'
            AND r.ordertype = '*' INTO r_picked, r_weighted, r_checked, r_pack, r_deliverconfirm, r_loading;
            IF v_done = 0 THEN

              SELECT
                r.picked,
                r.weighted,
                r.checked,
                r.pack,
                r.deliverconfirm,
                r.loading
              FROM RUL_AUTOSHIP r
              WHERE r.organizationId = IN_organizationId
              AND r.warehouseid = IN_WarehouseID
              AND r.warehouseid = '*'
              AND r.customerid = '*'
              AND r.carrierid = '*'
              AND r.ordertype = '*' INTO r_picked, r_weighted, r_checked, r_pack, r_deliverconfirm, r_loading;
              IF v_done = 0 THEN
                SET OUT_Return_Code := '000';
                LEAVE endproc;
              END IF;
            END IF;
          END IF;
        END IF;
      END IF;
    END IF;






    IF r_picked = 'N'
      AND r_checked = 'N'
      AND r_pack = 'N'
      AND r_weighted = 'N'
      AND r_deliverconfirm = 'N' THEN
      SET OUT_Return_Code := '000';
      LEAVE endproc;
    END IF;

    IF r_picked = 'Y'
      AND (r_sostatus < '60'
      AND r_ALLOW_PARTIAL_SHIP = 'N'
      OR r_sostatus <= '40') THEN
      SET OUT_Return_Code := '474';
      LEAVE endproc;
    END IF;

    IF r_checked = 'Y'
      OR r_pack = 'Y' THEN
      SELECT
        COUNT(a.allocationdetailsid),
        SUM(CASE WHEN a.checkwho > ' ' THEN 1 ELSE 0 END),
        SUM(CASE WHEN a.packflag = 'Y' THEN 1 ELSE 0 END)
      FROM ACT_ALLOCATION_DETAILS a
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseid = IN_WarehouseID
      AND a.orderno = IN_OrderNo INTO r_nrow, r_nrow_2, r_nrow_3;
      IF r_nrow <= 0 THEN
        SET OUT_Return_Code := '104????';
        LEAVE endproc;
      END IF;
      IF r_checked = 'Y'
        AND r_nrow_2 <> r_nrow THEN
        SET OUT_Return_Code := '999?????';
        LEAVE endproc;
      END IF;
      IF r_pack = 'Y'
        AND r_nrow_3 <> r_nrow THEN
        SET OUT_Return_Code := '472';
        LEAVE endproc;
      END IF;
    END IF;

    IF r_weighted = 'Y' THEN
      SELECT
        COUNT(a.allocationdetailsid)
      FROM ACT_ALLOCATION_DETAILS a
      WHERE a.orderno = IN_OrderNo
      AND NOT EXISTS (SELECT
          s.traceid
        FROM doc_order_packing_summary s
        WHERE s.organizationId = a.organizationId
        AND s.warehouseid = a.WarehouseID
        AND s.traceid = a.picktotraceid
        AND s.orderno = IN_OrderNo) INTO r_nrow;
      IF r_nrow > 0 THEN
        SET OUT_Return_Code := '999???';
        LEAVE endproc;
      END IF;
    END IF;

    IF r_deliverconfirm = 'Y' THEN

      SET r_CHK_TYP := getsys_configuration(IN_WarehouseID, '*', '*', 'CHK_TYP');
      IF r_CHK_TYP = 'NO' THEN
        SELECT
          COUNT(1)
        FROM DOC_DELIVERYCONFIRM_DETAILS h
        WHERE h.organizationId = IN_organizationId
        AND h.warehouseid = IN_WarehouseID
        AND h.deliveryno = r_Deliveryno INTO r_nrow;
        IF r_nrow <= 0 THEN
          SET OUT_Return_Code := '104?????';
          LEAVE endproc;
        END IF;
      ELSE

        SELECT
          COUNT(DISTINCT a.picktotraceid),
          COUNT(DISTINCT b.deliveryno)
        FROM ACT_ALLOCATION_DETAILS a
          LEFT JOIN DOC_DELIVERYCONFIRM_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseid = b.WarehouseID
            AND a.picktotraceid = b.deliveryno
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseid = IN_WarehouseID
        AND a.orderno = IN_OrderNo INTO r_nrow, r_nrow_2;
        IF r_nrow > r_nrow_2 THEN
          SET OUT_Return_Code := '000#??,??????';
          LEAVE endproc;
        END IF;
      END IF;

    END IF;


    IF r_loading = 'Y' THEN
      SELECT
        COUNT(1)
      FROM ACT_ALLOCATION_DETAILS a
        LEFT JOIN DOC_LOADING_DETAILS b
          ON a.organizationId = b.organizationID
          AND a.warehouseid = b.WarehouseID
          AND a.AllocationDetailsID = b.AllocationDetailsID
      WHERE a.organizationId = IN_organizationId
      AND a.warehouseid = IN_WarehouseID
      AND a.orderno = IN_OrderNO
      AND b.LDLNo IS NULL INTO r_nrow;
      IF r_nrow > 0 THEN
        SET Out_Return_Code := '471';
        LEAVE endproc;
      END IF;
    END IF;


    UPDATE DOC_ORDER_HEADER h
    SET h.ALLOWSHIP = 'Y',
        h.edittime = r_CurrentTime,
        h.editwho = IN_UserID
    WHERE h.organizationId = IN_organizationId
    AND h.warehouseid = IN_WarehouseID
    AND h.orderno = IN_OrderNo;
    IF r_Trans_Control = 'Y' THEN
      COMMIT;
    END IF;
    SET OUT_Return_Code := '000';

  END
  $$

--
-- Create procedure `SPCUS_UNPICK_UPDATE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_UNPICK_UPDATE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_allocationDetailsId varchar(90),
IN In_language varchar(90),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE r_CurrentTime timestamp;
    DECLARE v_done int;


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#SPCUS_UNPICK_UPDATE,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;

    SET R_CurrentTime = NOW();

    SELECT
      COUNT(1) INTO v_nrow
    FROM DOC_ORDER_SUBSERIALNO A
    WHERE A.organizationId = IN_organizationId
    AND A.warehouseId = IN_warehouseId
    AND A.allocationDetailsId = IN_allocationDetailsId;

    IF v_nrow > 0 THEN
      UPDATE DOC_ORDER_SUBSERIALNO
      SET UDF01 = 'A'
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND allocationDetailsId = IN_allocationDetailsId;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';


  END
  $$

--
-- Create procedure `SPCUS_SO_DEALLOCATION_AFTER_1`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_SO_DEALLOCATION_AFTER_1 (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN In_Process_By varchar(100),
IN In_Waveno varchar(100),
IN In_Orderno varchar(100),
IN In_Orderlineno varchar(5),
IN IN_allocationDetailsId varchar(40),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE v_qty_allocation int;
    DECLARE v_allocationDetailsId varchar(40);
    DECLARE v_traceid varchar(40);
    DECLARE v_locationid varchar(40);
    DECLARE v_orderno varchar(50);
    DECLARE v_sku varchar(40);
    DECLARE v_lotnum varchar(40);
    DECLARE v_sn_begin varchar(40);
    DECLARE v_sn_end varchar(40);
    DECLARE v_orderlineno varchar(5);
    DECLARE v_errormessage varchar(1000);
    DECLARE v_customerid varchar(40);

    IF In_Process_By = 'By WaveNO' THEN
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.waveNo = In_Waveno
      LIMIT 0, 1 INTO v_customerid;
    ELSE
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.orderno = In_Orderno
      LIMIT 0, 1 INTO v_customerid;
    END IF;

    IF v_customerid = 'BCA' THEN

      IF In_Process_By = 'By WaveNO' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno IN (SELECT
              b.orderno
            FROM DOC_WAVE_DETAILS b
            WHERE a.organizationId = IN_organizationId
            AND a.warehouseId = IN_warehouseId
            AND b.waveno = In_Waveno));

        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND orderno IN (SELECT
              b.orderno
            FROM DOC_WAVE_DETAILS b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.waveno = In_Waveno);

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND orderno IN (SELECT
              b.orderno
            FROM DOC_WAVE_DETAILS b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.waveno = In_Waveno);

      ELSEIF In_Process_By = 'By OrderNo' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno = In_Orderno);

        UPDATE DOC_ASN_SERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.serialno IN (SELECT
            a.serialno
          FROM DOC_ORDER_SERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno = In_Orderno);

        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND orderno = In_Orderno;

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND orderno = In_Orderno;

      ELSEIF In_Process_By = 'By OrderNO + OrderLineNO' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.allocationDetailsId IN (SELECT
              b.allocationDetailsId
            FROM ACT_CANCEL_ALLOCATION_LOG b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.orderno = In_Orderno
            AND b.orderlineno = In_Orderlineno));

        UPDATE DOC_ASN_SERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.serialno IN (SELECT
            a.serialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.allocationDetailsId IN (SELECT
              b.allocationDetailsId
            FROM ACT_CANCEL_ALLOCATION_LOG b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.orderno = In_Orderno
            AND b.orderlineno = In_Orderlineno)
          AND NOT EXISTS (SELECT
              1
            FROM DOC_ORDER_SERIALNO aa
            WHERE aa.serialno = a.serialno));

        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND subserialno IN (SELECT
              AA.subserialno
            FROM (SELECT
                a.subserialno
              FROM DOC_ORDER_SUBSERIALNO a
              WHERE a.organizationId = IN_organizationId
              AND a.warehouseId = IN_warehouseId
              AND a.allocationDetailsId IN (SELECT
                  b.allocationDetailsId
                FROM ACT_CANCEL_ALLOCATION_LOG b
                WHERE b.organizationId = IN_organizationId
                AND b.warehouseId = IN_warehouseId
                AND b.orderno = In_Orderno
                AND b.orderlineno = In_Orderlineno)) AS AA);

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND serialno IN (SELECT
              AA.serialno
            FROM (SELECT
                a.serialno
              FROM DOC_ORDER_SUBSERIALNO a
              WHERE a.organizationId = IN_organizationId
              AND a.warehouseId = IN_warehouseId
              AND a.allocationDetailsId IN (SELECT
                  b.allocationDetailsId
                FROM ACT_ALLOCATION_DETAILS b
                WHERE b.organizationId = ACT_CANCEL_ALLOCATION_LOG
                AND b.warehouseId = IN_warehouseId
                AND b.orderno = In_Orderno
                AND b.orderlineno = In_Orderlineno)
              AND NOT EXISTS (SELECT
                  1
                FROM DOC_ORDER_SERIALNO aa
                WHERE aa.serialno = a.serialno)) AS AA);
      ELSE
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.allocationDetailsId = IN_allocationDetailsId);

        UPDATE DOC_ASN_SERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.serialno IN (SELECT
            a.serialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.allocationDetailsId = IN_allocationDetailsId);

        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND allocationDetailsId = IN_allocationDetailsId;

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND allocationDetailsId = IN_allocationDetailsId;
      END IF;
    END IF;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPCUS_SO_DEALLOCATION_AFTER`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_SO_DEALLOCATION_AFTER (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN In_Process_By varchar(100),
IN In_Waveno varchar(100),
IN In_Orderno varchar(100),
IN In_Orderlineno varchar(5),
IN IN_allocationDetailsId varchar(40),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE v_qty_allocation int;
    DECLARE v_allocationDetailsId varchar(40);
    DECLARE v_traceid varchar(40);
    DECLARE v_locationid varchar(40);
    DECLARE v_orderno varchar(50);
    DECLARE v_sku varchar(40);
    DECLARE v_lotnum varchar(40);
    DECLARE v_sn_begin varchar(40);
    DECLARE v_sn_end varchar(40);
    DECLARE v_orderlineno varchar(5);
    DECLARE v_errormessage varchar(1000);
    DECLARE v_customerid varchar(40);

    IF In_Process_By = 'By WaveNO' THEN
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.waveNo = In_Waveno
      LIMIT 0, 1 INTO v_customerid;
    ELSE
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.orderno = In_Orderno
      LIMIT 0, 1 INTO v_customerid;
    END IF;

    IF v_customerid = 'BCA' THEN

      IF In_Process_By = 'By WaveNO' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno IN (SELECT
              b.orderno
            FROM DOC_WAVE_DETAILS b
            WHERE a.organizationId = IN_organizationId
            AND a.warehouseId = IN_warehouseId
            AND b.waveno = In_Waveno));

        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND orderno IN (SELECT
              b.orderno
            FROM DOC_WAVE_DETAILS b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.waveno = In_Waveno);

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND orderno IN (SELECT
              b.orderno
            FROM DOC_WAVE_DETAILS b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.waveno = In_Waveno);

      ELSEIF In_Process_By = 'By OrderNo' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno = In_Orderno);

        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND orderno = In_Orderno;

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND orderno = In_Orderno;

      ELSEIF In_Process_By = 'By OrderNO + OrderLineNO' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.allocationDetailsId IN (SELECT
              b.allocationDetailsId
            FROM ACT_CANCEL_ALLOCATION_LOG b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.orderno = In_Orderno
            AND b.orderlineno = In_Orderlineno));

        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND subserialno IN (SELECT
              AA.subserialno
            FROM (SELECT
                a.subserialno
              FROM DOC_ORDER_SUBSERIALNO a
              WHERE a.organizationId = IN_organizationId
              AND a.warehouseId = IN_warehouseId
              AND a.allocationDetailsId IN (SELECT
                  b.allocationDetailsId
                FROM ACT_CANCEL_ALLOCATION_LOG b
                WHERE b.organizationId = IN_organizationId
                AND b.warehouseId = IN_warehouseId
                AND b.orderno = In_Orderno
                AND b.orderlineno = In_Orderlineno)) AS AA);

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND serialno IN (SELECT
              AA.serialno
            FROM (SELECT
                a.serialno
              FROM DOC_ORDER_SUBSERIALNO a
              WHERE a.organizationId = IN_organizationId
              AND a.warehouseId = IN_warehouseId
              AND a.allocationDetailsId IN (SELECT
                  b.allocationDetailsId
                FROM ACT_CANCEL_ALLOCATION_LOG b
                WHERE b.organizationId = IN_organizationId
                AND b.warehouseId = IN_warehouseId
                AND b.orderno = In_Orderno
                AND b.orderlineno = In_Orderlineno)
              AND NOT EXISTS (SELECT
                  1
                FROM DOC_ORDER_SERIALNO tt
                WHERE tt.serialno = a.serialno
                AND tt.organizationId = a.organizationId
                AND tt.warehouseId = a.warehouseId)) AA);
      ELSE
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.udf01 = 'A'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.allocationDetailsId = IN_allocationDetailsId);

        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND allocationDetailsId = IN_allocationDetailsId;

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND allocationDetailsId = IN_allocationDetailsId;
      END IF;

      UPDATE DOC_ASN_SERIALNO t
      SET t.udf01 = 'N'
      WHERE t.organizationId = IN_organizationId
      AND t.warehouseId = IN_warehouseId
      AND t.stockflag = 'Y'
      AND NOT EXISTS (SELECT
          1
        FROM DOC_ASN_SUBSERIALNO a
        WHERE a.organizationId = t.organizationId
        AND a.warehouseId = t.warehouseId
        AND a.asnno = t.asnno
        AND a.serialno = t.serialno
        AND a.stockflag = 'Y'
        AND a.udf01 = 'A');


    END IF;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPCUS_SO_ALLOCATION_BEFORE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_SO_ALLOCATION_BEFORE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN In_Process_Action varchar(90),
IN In_Process_By varchar(100),
IN In_Waveno varchar(100),
IN In_Orderno varchar(100),
IN In_Orderlineno varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE v_qty_allocation int;
    DECLARE v_allocationDetailsId varchar(40);
    DECLARE v_traceid varchar(40);
    DECLARE v_locationid varchar(40);
    DECLARE v_orderno varchar(50);
    DECLARE v_sku varchar(40);
    DECLARE v_lotnum varchar(40);
    DECLARE v_sn_begin varchar(40);
    DECLARE v_sn_end varchar(40);
    DECLARE v_orderlineno varchar(5);
    DECLARE v_errormessage varchar(1000);
    DECLARE v_customerid varchar(30);
    DECLARE v_subserialno_max varchar(50);
    DECLARE v_subserialno_min varchar(50);
    DECLARE done int DEFAULT FALSE;

    DECLARE CUR_ALLCOTION CURSOR FOR
    SELECT
      T.ORDERNO,
      T.ORDERLINENO,
      T.UDF01,
      T.UDF02,
      T.SKU
    FROM DOC_ORDER_DETAILS T
      LEFT JOIN DOC_ORDER_HEADER A
        ON T.organizationId = A.organizationId
        AND T.warehouseId = A.warehouseId
        AND T.orderno = A.orderno
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND A.WAVENO = In_Waveno
    AND IFNULL(T.UDF01, '*') <> '*'
    AND In_Process_By = 'By WaveNO'
    UNION ALL
    SELECT
      T.ORDERNO,
      T.ORDERLINENO,
      T.UDF01,
      T.UDF02,
      T.SKU
    FROM DOC_ORDER_DETAILS T
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND T.ORDERNO = In_Orderno
    AND IFNULL(T.UDF01, '*') <> '*'
    AND In_Process_By = 'By OrderNO'
    UNION ALL
    SELECT
      T.ORDERNO,
      T.ORDERLINENO,
      T.UDF01,
      T.UDF02,
      T.SKU
    FROM DOC_ORDER_DETAILS T
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND T.ORDERNO = In_Orderno
    AND T.orderLineNo = In_Orderlineno
    AND IFNULL(T.UDF01, '*') <> '*'
    AND In_Process_By = 'By OrderNO + OrderLineNO';

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    IF In_Process_By = 'By WaveNO' THEN
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.waveNo = In_Waveno
      LIMIT 0, 1 INTO v_customerid;
    ELSE
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.orderno = In_Orderno
      LIMIT 0, 1 INTO v_customerid;
    END IF;

    IF v_customerid = 'BCA' THEN

      OPEN CUR_ALLCOTION;
    read_loop:
      LOOP
        FETCH CUR_ALLCOTION INTO v_orderno, v_orderlineno, v_sn_begin, v_sn_end, v_sku;
        IF done THEN
          LEAVE read_loop;
        END IF;
        IF IFNULL(v_sn_begin, ' ') <> ' '
          OR IFNULL(v_sn_begin, ' ') <> ' ' THEN
          SELECT
            T.lotNum,
            T.traceId,
            T.locationId
          FROM DOC_ASN_SUBSERIALNO T
          WHERE T.organizationId = IN_organizationId
          AND T.warehouseId = IN_warehouseId
          AND T.SKU = v_sku
          AND T.subSerialNo = v_sn_begin
          AND T.stockFlag = 'Y'
          LIMIT 0, 1 INTO v_lotnum, v_traceid, v_locationid;

          SELECT
            MIN(T.subSerialNo)
          FROM DOC_ASN_SUBSERIALNO T
          WHERE T.organizationId = IN_organizationId
          AND T.warehouseId = IN_warehouseId
          AND T.SKU = v_sku
          AND T.lotNum = v_lotnum
          AND T.traceId = v_traceid
          AND T.locationId = v_locationid
          AND T.stockFlag = 'Y'
          AND T.udf01 = 'N' -- added by Kristine to only allocate non-allocated serial
          LIMIT 0, 1 INTO v_subserialno_min;

          SELECT
            T.lotNum,
            T.traceId,
            T.locationId
          FROM DOC_ASN_SUBSERIALNO T
          WHERE T.organizationId = IN_organizationId
          AND T.warehouseId = IN_warehouseId
          AND T.SKU = v_sku
          AND T.subSerialNo = v_sn_end
          AND T.stockFlag = 'Y'
          LIMIT 0, 1 INTO v_lotnum, v_traceid, v_locationid;

          SELECT
            MAX(T.subSerialNo)
          FROM DOC_ASN_SUBSERIALNO T
          WHERE T.organizationId = IN_organizationId
          AND T.warehouseId = IN_warehouseId
          AND T.SKU = v_sku
          AND T.lotNum = v_lotnum
          AND T.traceId = v_traceid
          AND T.locationId = v_locationid
          AND T.stockFlag = 'Y'
          AND T.udf01 = 'N' -- added by Kristine to only allocate non-allocated serial
          LIMIT 0, 1 INTO v_subserialno_max;
        END IF;


        UPDATE DOC_ORDER_DETAILS T
        SET T.LOTATT05 = v_subserialno_min,
            T.LOTATT06 = v_subserialno_max
        WHERE T.organizationId = IN_organizationId
        AND T.warehouseId = IN_warehouseId
        AND T.orderNo = v_orderno
        AND T.orderLineNo = v_orderlineno;

      END LOOP;
      CLOSE CUR_ALLCOTION;
    END IF;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPCUS_SO_ALLOCATION_AFTER`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_SO_ALLOCATION_AFTER (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN In_Process_Action varchar(90),
IN In_Process_By varchar(100),
IN In_Waveno varchar(100),
IN In_Orderno varchar(100),
IN In_Orderlineno varchar(100),
IN IN_Language varchar(10),
IN IN_UserID varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE v_qty_allocation int;
    DECLARE v_allocationDetailsId varchar(40);
    DECLARE v_traceid varchar(40);
    DECLARE v_locationid varchar(40);
    DECLARE v_orderno varchar(50);
    DECLARE v_sku varchar(40);
    DECLARE v_lotnum varchar(40);
    DECLARE v_sn_begin varchar(40);
    DECLARE v_sn_end varchar(40);
    DECLARE v_orderlineno varchar(5);
    DECLARE v_errormessage varchar(1000);
    DECLARE v_customerid varchar(30);
    DECLARE done int DEFAULT FALSE;
    DECLARE CUR_ALLCOTION CURSOR FOR
    SELECT
      T.allocationDetailsId,
      T.lotNum,
      T.location,
      T.qty_each,
      T.traceId,
      T.SKU,
      T.ORDERNO,
      T.orderLineNo
    FROM ACT_ALLOCATION_DETAILS T
      LEFT JOIN INV_LOT_ATT A
        ON A.lotNum = T.lotNum
        AND A.organizationId = T.organizationId
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND T.WAVENO = In_Waveno
    AND In_Process_By = 'By WaveNO'
    UNION ALL
    SELECT
      T.allocationDetailsId,
      T.lotNum,
      T.location,
      T.qty_each,
      T.traceId,
      T.SKU,
      T.ORDERNO,
      T.orderLineNo
    FROM ACT_ALLOCATION_DETAILS T
      LEFT JOIN INV_LOT_ATT A
        ON A.lotNum = T.lotNum
        AND A.organizationId = T.organizationId
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND T.ORDERNO = In_Orderno
    AND In_Process_By = 'By OrderNO'
    UNION ALL
    SELECT
      T.allocationDetailsId,
      T.lotNum,
      T.location,
      T.qty_each,
      T.traceId,
      T.SKU,
      T.ORDERNO,
      T.orderLineNo
    FROM ACT_ALLOCATION_DETAILS T
      LEFT JOIN INV_LOT_ATT A
        ON A.lotNum = T.lotNum
        AND A.organizationId = T.organizationId
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND T.ORDERNO = In_Orderno
    AND T.orderLineNo = In_Orderlineno
    AND In_Process_By = 'By OrderNO + OrderLineNO'
    ;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    IF In_Process_By = 'By WaveNO' THEN
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.waveNo = In_Waveno
      LIMIT 0, 1 INTO v_customerid;
    ELSE
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.orderno = In_Orderno
      LIMIT 0, 1 INTO v_customerid;
    END IF;

    IF v_customerid = 'BCA' THEN

      OPEN CUR_ALLCOTION;
    read_loop:
      LOOP
        FETCH CUR_ALLCOTION INTO v_allocationDetailsId, v_lotnum, v_locationid, v_qty_allocation,
        v_traceid, v_sku, v_orderno, v_orderlineno;
        IF done THEN
          LEAVE read_loop;
        END IF;
        SET v_qty_allocation := v_qty_allocation;

        SELECT
          IFNULL(t.udf01, ' '),
          IFNULL(t.udf02, ' ')
        FROM DOC_ORDER_DETAILS t
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.orderno = v_orderno
        AND t.orderlineno = v_orderlineno
        LIMIT 0, 1 INTO v_sn_begin, v_sn_end;

        IF v_sn_begin = ' ' THEN
          SELECT
            IFNULL(t.lotatt05, ' '),
            IFNULL(t.lotatt06, ' ')
          FROM INV_LOT_ATT t
          WHERE t.organizationId = IN_organizationId
          AND t.lotNum = v_lotnum
          LIMIT 0, 1 INTO v_sn_begin, v_sn_end;
        END IF;

        SELECT
          COUNT(*)
        FROM DOC_ORDER_SUBSERIALNO t
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.allocationdetailsid = v_allocationDetailsId
        LIMIT 0, 1 INTO v_nrow;

        IF v_nrow = 0 THEN

          INSERT INTO DOC_ORDER_SUBSERIALNO (organizationId, warehouseId, orderno, serialno, subserialno, customerid,
          sku, scantime, ADDTIME, addwho, edittime, editwho, packingflag,
          allocationdetailsid, udf01, udf02, udf03)
            SELECT
              IN_organizationId,
              IN_warehouseId,
              v_orderno,
              t.serialno,
              t.subserialno,
              t.customerid,
              t.sku,
              NOW(),
              NOW(),
              IN_userId,
              NOW(),
              IN_userId,
              'N',
              v_allocationDetailsId,
              'A',
              '',
              ''
            FROM DOC_ASN_SUBSERIALNO t
            WHERE t.organizationId = IN_organizationId
            AND t.warehouseId = IN_warehouseId
            AND t.SKU = v_sku
            --  AND t.lotnum = v_lotnum
            --  AND t.locationid = v_locationid
            AND t.traceid = v_traceid
            AND t.subserialno >= v_sn_begin
            AND t.subserialno <= v_sn_end
            AND t.stockflag = 'Y'
            AND NOT EXISTS (SELECT
                1
              FROM DOC_ORDER_SUBSERIALNO tt
                LEFT JOIN ACT_ALLOCATION_DETAILS mm
                  ON tt.organizationId = mm.organizationId
                  AND tt.warehouseId = mm.warehouseId
                  AND tt.allocationDetailsId = mm.allocationDetailsId
              WHERE tt.organizationId = t.organizationId
              AND tt.warehouseId = t.warehouseId
              AND tt.subserialno = t.subserialno
              AND mm.status < '80')
            ORDER BY t.serialno, t.subserialno
            LIMIT 0, v_qty_allocation;


          INSERT INTO DOC_ORDER_SERIALNO (organizationId, warehouseId, orderno, serialno, sku, scantime,
          udf01, udf02, udf03, ADDTIME, addwho, edittime, editwho,
          customerid, secondserialno, lotnum, partialflag, traceid,
          packingflag, allocationdetailsid)
            SELECT DISTINCT
              IN_organizationId,
              IN_warehouseId,
              v_orderno,
              t.serialno,
              t.sku,
              NOW(),
              'A',
              '',
              '',
              NOW(),
              IN_userId,
              NOW(),
              IN_userId,
              t.customerid,
              '',
              v_lotnum,
              'N',
              v_traceid,
              'N',
              v_allocationDetailsId
            FROM DOC_ORDER_SUBSERIALNO t
            WHERE t.organizationId = IN_organizationId
            AND t.warehouseId = IN_warehouseId
            AND t.orderno = v_orderno
            AND t.SKU = v_sku
            AND t.allocationDetailsId = v_allocationDetailsId
            AND NOT EXISTS (SELECT
                1
              FROM DOC_ORDER_SERIALNO tt
              WHERE tt.organizationId = t.organizationId
              AND tt.warehouseId = t.warehouseId
              AND tt.serialno = t.serialno
              AND tt.orderno = v_orderno);
        END IF;
      END LOOP;
      CLOSE CUR_ALLCOTION;

      IF In_Process_By = 'By WaveNO' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'A'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno IN (SELECT
              b.orderno
            FROM DOC_WAVE_DETAILS b
            WHERE a.organizationId = IN_organizationId
            AND a.warehouseId = IN_warehouseId
            AND b.waveno = In_Waveno));

        UPDATE DOC_ASN_SERIALNO t
        SET t.udf01 = 'A'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.serialno IN (SELECT
            a.serialno
          FROM DOC_ORDER_SERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno IN (SELECT
              b.orderno
            FROM DOC_WAVE_DETAILS b
            WHERE a.organizationId = IN_organizationId
            AND a.warehouseId = IN_warehouseId
            AND b.waveno = In_Waveno)
          AND NOT EXISTS (SELECT
              1
            FROM DOC_ASN_SUBSERIALNO c
            WHERE c.organizationId = IN_organizationId
            AND c.warehouseId = IN_warehouseId
            AND c.serialno = a.serialno
            AND IFNULL(c.udf01, 'N') = 'N'));

      ELSE
        --      UPDATE DOC_ASN_SUBSERIALNO t SET t.udf01 = 'A'
        --       WHERE t.organizationId = IN_organizationId
        --         AND t.warehouseId = IN_warehouseId
        --         AND t.stockflag = 'Y'
        --         AND t.subserialno IN 
        --       (SELECT a.subserialno FROM DOC_ORDER_SUBSERIALNO a
        --         WHERE a.organizationId = IN_organizationId
        --           AND a.warehouseId = IN_warehouseId
        --           AND a.orderno = In_Orderno);
        /* 20211207 Commented off for optimization purpose
        UPDATE DOC_ASN_SUBSERIALNO t
        INNER JOIN DOC_ORDER_SUBSERIALNO a
          ON t.subSerialNo = a.subSerialNo
        SET t.udf01 = 'A'
        WHERE t.organizationId = a.organizationId
        AND t.warehouseId = a.warehouseId
        AND a.orderNo = In_Orderno;
        */

        UPDATE DOC_ASN_SUBSERIALNO t
        INNER JOIN DOC_ORDER_SUBSERIALNO a
          ON t.organizationId = a.organizationId
          AND t.warehouseId = a.warehouseId
          AND t.subSerialNo = a.subSerialNo
        SET t.udf01 = 'A'
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseId = IN_warehouseId
        AND a.orderNo = In_Orderno;

        UPDATE DOC_ASN_SERIALNO t
        SET t.udf01 = 'A'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockflag = 'Y'
        AND t.serialno IN (SELECT
            a.serialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno = In_Orderno
          AND NOT EXISTS (SELECT
              1
            FROM DOC_ASN_SUBSERIALNO c
            WHERE c.organizationId = IN_organizationId
            AND c.warehouseId = IN_warehouseId
            AND c.serialno = a.serialno
            AND IFNULL(c.udf01, 'N') = 'N'));
      END IF;
    END IF;

    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPCUS_SHIPMENT_UPDATE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_SHIPMENT_UPDATE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN In_Process_By varchar(100),
IN In_Waveno varchar(100),
IN In_Orderno varchar(100),
IN In_Orderlineno varchar(5),
IN IN_allocationDetailsId varchar(40),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE v_qty_allocation int;
    DECLARE v_allocationDetailsId varchar(40);
    DECLARE v_traceid varchar(40);
    DECLARE v_locationid varchar(40);
    DECLARE v_orderno varchar(50);
    DECLARE v_sku varchar(40);
    DECLARE v_lotnum varchar(40);
    DECLARE v_sn_begin varchar(40);
    DECLARE v_sn_end varchar(40);
    DECLARE v_orderlineno varchar(5);
    DECLARE v_errormessage varchar(1000);
    DECLARE v_customerid varchar(40);


    IF In_Process_By = 'By WaveNO' THEN
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.waveNo = In_Waveno
      LIMIT 0, 1 INTO v_customerid;
    ELSEIF In_Process_By = 'LoadList' THEN
      SELECT
        B.`customerId`
      FROM DOC_LOADING_DETAILS A
        LEFT JOIN DOC_ORDER_HEADER B
          ON A.`organizationId` = B.`organizationId`
          AND A.`warehouseId` = B.`warehouseId`
          AND A.`orderNo` = B.`orderNo`
      WHERE A.organizationId = IN_organizationId
      AND A.warehouseId = IN_warehouseId
      AND A.ldlNo = In_Waveno
      LIMIT 0, 1 INTO v_customerid;
    ELSE
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.orderNo = In_Orderno
      LIMIT 0, 1 INTO v_customerid;
    END IF;

    IF v_customerid = 'BCA' THEN

      IF In_Process_By = 'WaveNO' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.stockFlag = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockFlag = 'Y'
        AND t.subSerialNo IN (SELECT
            a.subSerialNo
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderNo IN (SELECT
              b.orderNo
            FROM DOC_WAVE_DETAILS b
            WHERE a.organizationId = IN_organizationId
            AND a.warehouseId = IN_warehouseId
            AND b.waveNo = In_Waveno));
      ELSEIF In_Process_By = 'OrderNo' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.stockFlag = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockFlag = 'Y'
        AND t.subSerialNo IN (SELECT
            a.subSerialNo
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderNo = In_Orderno);

      ELSEIF In_Process_By = 'OrderNo + OrderLineNo' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.stockFlag = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockFlag = 'Y'
        AND t.subSerialNo IN (SELECT
            a.subSerialNo
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.allocationDetailsId IN (SELECT
              b.allocationDetailsId
            FROM ACT_ALLOCATION_DETAILS b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.orderNo = In_Orderno
            AND b.orderLineNo = In_Orderlineno));
      ELSEIF In_Process_By = 'LoadList' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.stockFlag = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockFlag = 'Y'
        AND t.subSerialNo IN (SELECT
            a.subSerialNo
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.allocationDetailsId IN (SELECT
              b.allocationDetailsId
            FROM DOC_LOADING_DETAILS b
            WHERE b.organizationId = IN_organizationId
            AND b.warehouseId = IN_warehouseId
            AND b.ldlNo = In_Waveno));
      ELSE
        /*UPDATE DOC_ASN_SUBSERIALNO t SET t.stockflag = 'N'
           WHERE t.organizationId = IN_organizationId
             AND t.warehouseId = IN_warehouseId
             AND t.stockflag='Y'        
             AND t.subserialno IN
            (SELECT a.subserialno FROM DOC_ORDER_SUBSERIALNO a
              WHERE a.organizationId = IN_organizationId
                AND a.warehouseId = IN_warehouseId
                AND a.allocationDetailsId = IN_allocationDetailsId);*/
        UPDATE DOC_ASN_SUBSERIALNO t
        INNER JOIN DOC_ORDER_SUBSERIALNO a
          ON a.organizationId = t.organizationId
          AND a.warehouseId = t.warehouseId
          AND a.subSerialNo = t.subSerialNo
          AND a.allocationDetailsId = IN_allocationDetailsId
        SET t.stockFlag = 'N'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.stockFlag = 'Y';
      END IF;

      UPDATE DOC_ASN_SERIALNO t
      SET t.stockFlag = 'N'
      WHERE t.organizationId = IN_organizationId
      AND t.warehouseId = IN_warehouseId
      AND t.stockFlag = 'Y'
      AND NOT EXISTS (SELECT
          1
        FROM DOC_ASN_SUBSERIALNO a
        WHERE a.organizationId = t.organizationId
        AND a.warehouseId = t.warehouseId
        AND a.ASNNO = t.ASNNO
        AND a.serialNo = t.serialNo
        AND a.stockFlag = 'Y');

    END IF;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPCUS_REVERSEPICK_AFTER`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_REVERSEPICK_AFTER (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_allocationDetailsId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE v_qty_allocation int;
    DECLARE v_allocationDetailsId varchar(40);
    DECLARE v_traceid varchar(40);
    DECLARE v_locationid varchar(40);
    DECLARE v_orderno varchar(50);
    DECLARE v_sku varchar(40);
    DECLARE v_lotnum varchar(40);
    DECLARE v_sn_begin varchar(40);
    DECLARE v_sn_end varchar(40);
    DECLARE v_orderlineno varchar(5);
    DECLARE v_errormessage varchar(1000);
    DECLARE v_customerid varchar(40);

    SELECT
      a.customerId
    FROM ACT_CANCEL_ALLOCATION_LOG a
    WHERE a.organizationId = IN_organizationId
    AND a.warehouseId = IN_warehouseId
    AND a.allocationDetailsId = IN_allocationDetailsId INTO v_customerid;

    IF v_customerid = 'BCA' THEN
      UPDATE DOC_ASN_SUBSERIALNO t
      SET t.udf01 = 'N'
      WHERE t.organizationId = IN_organizationId
      AND t.warehouseId = IN_warehouseId
      AND t.stockflag = 'Y'
      AND t.udf01 = 'A'
      AND t.subserialno IN (SELECT
          a.subserialno
        FROM DOC_ORDER_SUBSERIALNO a
        WHERE a.organizationId = IN_organizationId
        AND a.warehouseId = IN_warehouseId
        AND a.allocationDetailsId = IN_allocationDetailsId);

      DELETE
        FROM DOC_ORDER_SUBSERIALNO
      WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseId
        AND allocationDetailsId = IN_allocationDetailsId;

      DELETE
        FROM DOC_ORDER_SERIALNO
      WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseId
        AND allocationDetailsId = IN_allocationDetailsId;

      UPDATE DOC_ASN_SERIALNO t
      SET t.udf01 = 'N'
      WHERE t.organizationId = IN_organizationId
      AND t.warehouseId = IN_warehouseId
      AND t.stockflag = 'Y'
      AND NOT EXISTS (SELECT
          1
        FROM DOC_ASN_SUBSERIALNO a
        WHERE a.organizationId = t.organizationId
        AND a.warehouseId = t.warehouseId
        AND a.asnno = t.asnno
        AND a.serialno = t.serialno
        AND a.stockflag = 'Y'
        AND a.udf01 = 'A');
    END IF;

    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPCUS_POTOASN`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_POTOASN (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_PONO varchar(20),
IN IN_ASNNO varchar(20),
IN IN_userid varchar(40),
INOUT OUT_Return_Code varchar(1000))
END_PROC:
  BEGIN
    DECLARE IN_organizationId varchar(100) DEFAULT 'OJV_CML';
    DECLARE R_COUNTDOC varchar(100);
    DECLARE R_DOCTYPE varchar(100);
    DECLARE IN_Language varchar(100);
    DECLARE R_BILLINGSUMMARYID varchar(100);
    DECLARE r_customerId varchar(100);
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SELECT
        CONCAT('999#SPCUS_POTOASN,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;
    IF OUT_Return_Code = 'NO_COMMIT'
      OR OUT_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    UPDATE DOC_ASN_HEADER A
    SET A.serialNoCatch = 'N'
    WHERE A.organizationId = IN_organizationId
    AND A.warehouseId = IN_warehouseId
    AND A.asnNo = IN_ASNNO;
    SET OUT_Return_Code := '000';
  END
  $$

--
-- Create procedure `SPCUS_PICK_UPDATE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_PICK_UPDATE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_allocationDetailsId varchar(90),
IN In_language varchar(90),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE r_CurrentTime timestamp;
    DECLARE v_done int;


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#SPCUS_PICK_UPDATE,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;

    SET R_CurrentTime = NOW();

    SELECT
      COUNT(1) INTO v_nrow
    FROM DOC_ORDER_SUBSERIALNO A
    WHERE A.organizationId = IN_organizationId
    AND A.warehouseId = IN_warehouseId
    AND A.allocationDetailsId = IN_allocationDetailsId;

    IF v_nrow > 0 THEN
      UPDATE DOC_ORDER_SUBSERIALNO
      SET UDF01 = 'P',
          -- serialNo=(SELECT CONCAT(T.`pickToTraceId`,'#SN') FROM ACT_ALLOCATION_DETAILS T WHERE   T.organizationId=IN_organizationId
          serialNo = (SELECT
              CONCAT(T.`pickToTraceId`, '#', serialNo)
            FROM ACT_ALLOCATION_DETAILS T
            WHERE T.organizationId = IN_organizationId
            AND T.warehouseId = IN_warehouseId
            AND T.allocationDetailsId = IN_allocationDetailsId)
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND allocationDetailsId = IN_allocationDetailsId;

      UPDATE DOC_ORDER_SERIALNO
      -- SET serialNo=(SELECT CONCAT(T.`pickToTraceId`,'#SN') FROM ACT_ALLOCATION_DETAILS T WHERE   T.organizationId=IN_organizationId
      SET serialNo = (SELECT
          CONCAT(T.`pickToTraceId`, '#', serialNo)
        FROM ACT_ALLOCATION_DETAILS T
        WHERE T.organizationId = IN_organizationId
        AND T.warehouseId = IN_warehouseId
        AND T.allocationDetailsId = IN_allocationDetailsId)
      WHERE organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND allocationDetailsId = IN_allocationDetailsId;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';


  END
  $$

--
-- Create procedure `SPCUS_DEALLOCATION_AF`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_DEALLOCATION_AF (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN In_Process_By varchar(100),
IN In_Waveno varchar(100),
IN In_Orderno varchar(100),
IN In_Orderlineno varchar(100),
IN In_allocationDetailsId varchar(100),
IN IN_Language varchar(10),
IN IN_UserID varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE v_qty_allocation int;
    DECLARE v_allocationDetailsId varchar(40);
    DECLARE v_traceid varchar(40);
    DECLARE v_locationid varchar(40);
    DECLARE v_orderno varchar(50);
    DECLARE v_sku varchar(40);
    DECLARE v_lotnum varchar(40);
    DECLARE v_sn_begin varchar(40);
    DECLARE v_sn_end varchar(40);
    DECLARE v_orderlineno varchar(5);
    DECLARE v_errormessage varchar(1000);
    DECLARE v_customerid varchar(30);
    DECLARE done int DEFAULT FALSE;
    DECLARE CUR_ALLCOTION CURSOR FOR
    SELECT
      T.allocationDetailsId,
      T.lotNum,
      T.location,
      T.qty_each,
      T.traceId,
      T.SKU,
      T.ORDERNO,
      T.orderLineNo
    FROM ACT_CANCEL_ALLOCATION_LOG T
      LEFT JOIN INV_LOT_ATT A
        ON A.lotNum = T.lotNum
        AND A.organizationId = T.organizationId
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND T.WAVENO = In_Waveno
    AND In_Process_By = 'By WaveNO'
    UNION ALL
    SELECT
      T.allocationDetailsId,
      T.lotNum,
      T.location,
      T.qty_each,
      T.traceId,
      T.SKU,
      T.ORDERNO,
      T.orderLineNo
    FROM ACT_CANCEL_ALLOCATION_LOG T
      LEFT JOIN INV_LOT_ATT A
        ON A.lotNum = T.lotNum
        AND A.organizationId = T.organizationId
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND T.ORDERNO = In_Orderno
    AND In_Process_By = 'By OrderNO'
    UNION ALL
    SELECT
      T.allocationDetailsId,
      T.lotNum,
      T.location,
      T.qty_each,
      T.traceId,
      T.SKU,
      T.ORDERNO,
      T.orderLineNo
    FROM ACT_CANCEL_ALLOCATION_LOG T
      LEFT JOIN INV_LOT_ATT A
        ON A.lotNum = T.lotNum
        AND A.organizationId = T.organizationId
    WHERE T.organizationId = IN_organizationId
    AND T.warehouseId = IN_warehouseId
    AND T.ORDERNO = In_Orderno
    AND T.orderLineNo = In_Orderlineno
    AND In_Process_By = 'By OrderNO + OrderLineNO'
    ;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    IF In_Process_By = 'By WaveNO' THEN
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.waveNo = In_Waveno
      LIMIT 0, 1 INTO v_customerid;
    ELSE
      SELECT
        T.customerId
      FROM DOC_ORDER_HEADER T
      WHERE T.organizationId = IN_organizationId
      AND T.warehouseId = IN_warehouseId
      AND T.orderno = In_Orderno
      LIMIT 0, 1 INTO v_customerid;
    END IF;

    IF v_customerid = 'BCA' THEN

      OPEN CUR_ALLCOTION;
    read_loop:
      LOOP
        FETCH CUR_ALLCOTION INTO v_allocationDetailsId, v_lotnum, v_locationid, v_qty_allocation,
        v_traceid, v_sku, v_orderno, v_orderlineno;
        IF done THEN
          LEAVE read_loop;
        END IF;
        DELETE
          FROM DOC_ORDER_SUBSERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND allocationDetailsId = v_allocationDetailsId;

        DELETE
          FROM DOC_ORDER_SERIALNO
        WHERE organizationId = IN_organizationId
          AND warehouseId = IN_warehouseId
          AND allocationDetailsId = v_allocationDetailsId;
      END LOOP;
      CLOSE CUR_ALLCOTION;

      IF In_Process_By = 'By WaveNO' THEN
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'A'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno = In_Orderno);

        UPDATE DOC_ASN_SERIALNO t
        SET t.udf01 = 'A'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.serialno IN (SELECT
            a.serialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno = In_Orderno
          AND NOT EXISTS (SELECT
              1
            FROM DOC_ASN_SUBSERIALNO c
            WHERE c.organizationId = IN_organizationId
            AND c.warehouseId = IN_warehouseId
            AND c.serialno = a.serialno
            AND IFNULL(c.udf01, 'N') = 'N'));
      ELSE
        UPDATE DOC_ASN_SUBSERIALNO t
        SET t.udf01 = 'A'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.subserialno IN (SELECT
            a.subserialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno = In_Orderno);

        UPDATE DOC_ASN_SERIALNO t
        SET t.udf01 = 'A'
        WHERE t.organizationId = IN_organizationId
        AND t.warehouseId = IN_warehouseId
        AND t.serialno IN (SELECT
            a.serialno
          FROM DOC_ORDER_SUBSERIALNO a
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND a.orderno = In_Orderno
          AND NOT EXISTS (SELECT
              1
            FROM DOC_ASN_SUBSERIALNO c
            WHERE c.organizationId = IN_organizationId
            AND c.warehouseId = IN_warehouseId
            AND c.serialno = a.serialno
            AND IFNULL(c.udf01, 'N') = 'N'));
      END IF;
    END IF;

    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPCUS_BILSUMMARY_EDT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BILSUMMARY_EDT (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(20),
IN IN_BILLINGSUMMARYID varchar(30),
IN IN_Language varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE r_rate varchar(30);
  DECLARE r_nrow int;
  SELECT
    COUNT(1) INTO r_nrow
  FROM BIL_SUMMARY A
  WHERE A.ORGANIZATIONID = IN_organizationId
  AND A.WAREHOUSEID = IN_warehouseId
  AND A.BILLINGSUMMARYID = IN_BILLINGSUMMARYID;


  IF r_nrow > 0 THEN
    UPDATE BIL_SUMMARY A
    SET A.BILLINGAMOUNT = A.chargePerUnits * A.chargeRate * A.qty,
        A.AMOUNT = A.chargePerUnits * A.chargeRate * A.qty
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.BILLINGSUMMARYID = IN_BILLINGSUMMARYID;
  END IF;
  SET OUT_returnCode := '000';
END
$$

--
-- Create procedure `SPCUS_BILSUMMARY_ARNO`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_BILSUMMARY_ARNO (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(20),
IN IN_BILLINGSUMMARYID varchar(30),
IN IN_Language varchar(30),
IN IN_userId varchar(20),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_rate varchar(30);
    DECLARE IN_ARNO varchar(30);
    DECLARE r_nrow int;
    SELECT
      A.arNo INTO IN_ARNO
    FROM BIL_SUMMARY A
    WHERE A.ORGANIZATIONID = IN_organizationId
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.BILLINGSUMMARYID = IN_BILLINGSUMMARYID;

    IF IN_ARNO NOT IN ('*', ' ') THEN
      SET OUT_returnCode = 'BI001';
      LEAVE ENDPROC;

    END IF;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `SPCUS_ASN_RECEIVING_AFTER`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCUS_ASN_RECEIVING_AFTER (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_customerId varchar(90),
IN In_asnNo varchar(100),
IN In_asnLineNo varchar(100),
IN In_FMLocation varchar(100),
IN In_Return_LotNum varchar(100),
IN In_sku varchar(100),
IN In_LPN_C varchar(100),
IN In_New_TraceID_C varchar(100),
IN In_TransactionID varchar(100),
IN In_ReceivedQty varchar(100),
IN In_UOM varchar(100),
IN In_lotAtt05 varchar(100),
IN In_lotAtt06 varchar(100),
IN IN_Language varchar(10),
IN IN_UserID varchar(40),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_nrow int;
    DECLARE v_PACKID varchar(40);
    DECLARE v_xn_begin varchar(40);
    DECLARE v_xn_end varchar(40);
    DECLARE v_xn_pre varchar(40);
    DECLARE v_xn_af varchar(40);
    DECLARE v_length varchar(40);
    DECLARE v_xn_count int;
    DECLARE v_serialNoCatch char(1);
    DECLARE v_scanWhenReceive char(1);
    DECLARE V_xn_str varchar(40);
    DECLARE done int DEFAULT FALSE;
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE r_QTY1_P decimal(18, 8);
    DECLARE r_QTY2_P decimal(18, 8);
    DECLARE r_QTY3_P decimal(18, 8);
    DECLARE r_QTY4_P decimal(18, 8);
    DECLARE r_QTY5_P decimal(18, 8);
    DECLARE v_toId varchar(20);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SELECT
        CONCAT('999#SPCUS_ASN_RECEIVING_AFTER,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, '')) AS outcode;
      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;
    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF IN_customerId = 'BCA' THEN
      SELECT
        T.serialNoCatch,
        T.scanWhenReceive,
        T.PACKID
      FROM BAS_SKU T
      WHERE T.organizationId = IN_organizationId
      AND T.customerId = IN_customerId
      AND T.SKU = In_sku
      LIMIT 0, 1 INTO v_serialNoCatch, v_scanWhenReceive, v_PACKID;

      IF v_serialNoCatch IN ('Y', 'M')
        AND v_scanWhenReceive = 'Y' THEN
        SELECT
          MAX(CASE WHEN packUom = 'EA' THEN qty ELSE NULL END),
          MAX(CASE WHEN packUom = 'IP' THEN qty ELSE NULL END),
          MAX(CASE WHEN packUom = 'CS' THEN qty ELSE NULL END),
          MAX(CASE WHEN packUom = 'PL' THEN qty ELSE NULL END),
          MAX(CASE WHEN packUom = 'OT' THEN qty ELSE NULL END)
        FROM BAS_PACKAGE_DETAILS
        WHERE organizationId = In_organizationId
        AND customerId = IN_customerId
        AND PackID = v_PACKID INTO R_QTY1_P, R_QTY2_P, R_QTY3_P, R_QTY4_P, R_QTY5_P;

        IF v_error = 0 THEN
          SET OUT_returnCode = '888BAS_PACKAGE,OPEN';
          ROLLBACK;
          LEAVE END_PROC;
        END IF;
        IF In_UOM = 'EA' THEN
          SET In_ReceivedQty = In_ReceivedQty;
        ELSEIF In_UOM = 'IP' THEN
          SET In_ReceivedQty = R_QTY2_P * In_ReceivedQty;
        ELSEIF In_UOM = 'CS' THEN
          SET In_ReceivedQty = R_QTY3_P * In_ReceivedQty;
        ELSEIF In_UOM = 'PL' THEN
          SET In_ReceivedQty = R_QTY4_P * In_ReceivedQty;
        ELSEIF In_UOM = 'OT' THEN
          SET In_ReceivedQty = R_QTY5_P * In_ReceivedQty;
        END IF;

        SET v_xn_pre = '';

        SELECT
          COUNT(1) INTO v_nrow
        FROM DOC_ASN_SUBSERIALNO A
        WHERE A.organizationId = In_organizationId
        AND A.warehouseId = IN_warehouseId
        AND A.subSerialNo = In_lotAtt05
        AND A.sku = In_sku
        AND A.STOCKFLAG = 'Y';
        IF v_nrow > 0 THEN
          SET OUT_returnCode := CONCAT('999#SerialNo:', In_lotAtt05, ' already exists');
          LEAVE END_PROC;
        END IF;

        SELECT
          COUNT(1) INTO v_nrow
        FROM DOC_ASN_SUBSERIALNO A
        WHERE A.organizationId = In_organizationId
        AND A.warehouseId = IN_warehouseId
        AND A.subSerialNo = In_lotAtt06
        AND A.sku = In_sku
        AND A.STOCKFLAG = 'Y';
        IF v_nrow > 0 THEN
          SET OUT_returnCode := CONCAT('999#SerialNo:', In_lotAtt06, ' already exists');
          LEAVE END_PROC;
        END IF;

        SELECT
          In_lotAtt05 LIKE '%-%' INTO v_nrow;
        IF v_nrow > 0 THEN
          SET v_xn_pre = CONCAT(get_udfa_parameter(In_lotAtt05, '-', '1'), '-');
          SET v_xn_af = CONCAT(get_udfa_parameter(In_lotAtt06, '-', '1'), '-');
          IF v_xn_pre <> v_xn_af THEN
            SET OUT_returnCode := '999#SerialNo ERROR';
            LEAVE END_PROC;
          END IF;
          SET v_xn_begin = get_udfa_parameter(In_lotAtt05, '-', '2');
          SET v_xn_end = get_udfa_parameter(In_lotAtt06, '-', '2');
        END IF;

        IF v_nrow = 0 THEN
          SET v_xn_begin = In_lotAtt05;
          SET v_xn_end = In_lotAtt06;
        END IF;

        SET v_length = LENGTH(v_xn_begin);
        SET v_xn_count = v_xn_end - v_xn_begin + 1;
        SET @x = v_xn_begin - 1;

        IF v_xn_count <> In_ReceivedQty THEN
          SET OUT_returnCode := '999#ReceivedQty ERROR';
          LEAVE END_PROC;
        END IF;

        SELECT
          toId
        FROM ACT_TRANSACTION_LOG ATL
        WHERE ATL.organizationId = IN_organizationId
        AND ATL.warehouseId = IN_warehouseId
        AND ATL.fmcustomerId = IN_customerId
        AND ATL.fmSku = In_sku
        AND ATL.transactionId = In_TransactionID
        LIMIT 0, 1 INTO v_toId;

        INSERT INTO DOC_ASN_SUBSERIALNO (organizationId,
        warehouseId,
        asnNo,
        serialNo,
        subSerialNo,
        scanTime,
        stockFlag,
        customerId,
        sku,
        locationId,
        traceId,
        lotNum,
        transactionId,
        qty,
        noteText,
        udf01,
        udf02,
        udf03,
        udf04,
        udf05,
        addWho,
        ADDTIME,
        editWho,
        editTime)
          SELECT
            IN_organizationId,
            IN_warehouseId,
            In_asnNo,

            v_toId,
            CONCAT(v_xn_pre, LPAD(@x := @x + 1, v_length, '0')),
            SYSDATE(),
            'Y',
            IN_customerId,
            In_sku,
            In_FMLocation,

            v_toId,
            In_Return_LotNum,
            In_TransactionID,
            1,
            '',
            'N',
            '',
            '',
            '',
            '',
            IN_UserID,
            SYSDATE(),
            IN_UserID,
            SYSDATE()
          FROM SYS_LABELMATRIX
          LIMIT 0, v_xn_count;

        INSERT INTO DOC_ASN_SERIALNO (organizationId,
        warehouseId,
        asnNo,
        serialNo,
        scanTime,
        stockFlag,
        customerId,
        sku,
        locationId,
        traceId,
        lotNum,
        transactionId,
        qty,
        noteText,
        udf01,
        udf02,
        udf03,
        udf04,
        udf05,
        addWho,
        ADDTIME,
        editWho,
        editTime)
          VALUES (IN_organizationId, IN_warehouseId, In_asnNo, v_toId, SYSDATE(), 'Y', IN_customerId, In_sku, In_FMLocation, v_toId, In_Return_LotNum, In_TransactionID, In_ReceivedQty, '', 'N', '', '', '', '', IN_UserID, SYSDATE(), IN_UserID, SYSDATE());
      END IF;
    END IF;

    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `SPCOM_WeightCheck`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCOM_WeightCheck (IN IN_bizOrgId varchar(20),
IN IN_bizWarehouseId varchar(20),
IN IN_type varchar(90),
IN IN_para varchar(90),
IN IN_cartonId varchar(30),
IN IN_weight decimal(18, 8),
IN IN_moduleId varchar(20),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_nrow int;

  SET OUT_returnCode = '000';

END
$$

--
-- Create procedure `SPCOM_SO_MV_BEFORE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCOM_SO_MV_BEFORE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_orderNo varchar(90),
IN IN_userId varchar(40),
IN IN_language varchar(90),
OUT OUT_returnCode varchar(1000))
BEGIN





  IF IN_userId = 'LIAOQL' THEN

    SET OUT_returnCode := '098';

  ELSE

    SET OUT_returnCode := '000';



  END IF;
END
$$

--
-- Create procedure `SPCOM_SO_MV_AFTER`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE SPCOM_SO_MV_AFTER (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_orderNo varchar(90),
IN IN_userId varchar(40),
IN IN_language varchar(90),
OUT OUT_returnCode varchar(1000))
BEGIN

  SET OUT_returnCode := '000';

  IF IN_userId = 'LIAOQL' THEN

    UPDATE DOC_ORDER_HEADER
    SET UDF01 = '?????????????????'
    WHERE organizationid = IN_organizationId
    AND warehouseid = IN_warehouseId
    AND orderno = IN_orderNo;







  END IF;
END
$$

--
-- Create procedure `SPAPP_DOCK_ALLOCATION`
--
CREATE 
	DEFINER = 'sa'@'localhost'
PROCEDURE SPAPP_DOCK_ALLOCATION( IN `IN_ORGANIZATIONID` VARCHAR(30),
 IN `IN_WAREHOUSEID`			VARCHAR(30),
 IN `IN_OPERATIONMODE`		VARCHAR(30),  
 IN `IN_DOCNO`						VARCHAR(30),	
 IN `IN_LANGUAGE`					VARCHAR(30),
 IN `IN_USERID`						VARCHAR(30),
 INOUT `OUT_RETURN_CODE`	VARCHAR(200)
)
THISPROC:BEGIN

	
  
  DECLARE  R_CURRENTTIME          DATETIME;
	DECLARE  R_Date01								DATE;
	DECLARE  R_Date02								DATE;
	DECLARE  R_TIMEEXP							DATETIME;
  DECLARE  R_TRAN_CTL             CHAR(1) DEFAULT 'Y';
  DECLARE  R_NROW                 INT;
  DECLARE  R_DOCNO                VARCHAR(30);
  DECLARE  R_SQL                  VARCHAR(4000);
	
  DECLARE  R_ARRIVALNO            VARCHAR(20);
  DECLARE  R_ARRIVALTYPE          VARCHAR(10);
  DECLARE  R_VEHICLETYPE          VARCHAR(10);
  DECLARE  R_FREIGHTCLASS         VARCHAR(30);
  DECLARE  R_CARRIERID            VARCHAR(30);
  DECLARE  R_SUPPLIERID           VARCHAR(30);
  DECLARE  R_CUSTOMERID           VARCHAR(30);
  DECLARE  R_ARRIVALSTATUS        VARCHAR(2);
  DECLARE  R_ARRIVALSTATUSDESC    VARCHAR(100);
  DECLARE  R_ARRIVETIME           DATE;
  DECLARE  R_DOCKNO               VARCHAR(10);
  DECLARE  R_DOCKNOLST            VARCHAR(50);
  DECLARE  R_QUEUENO              CHAR(1);
  DECLARE  R_QUEUENOQNO           INT;
  DECLARE  R_PUTAWAYLOCATION			VARCHAR(30);
  DECLARE  R_SORTIONLOCATION			VARCHAR(30);
	
  DECLARE  R_TIMEOUTCONTROL       CHAR(1);
  DECLARE  R_DURATION             INT;
  DECLARE  R_TIMEOUTRULE          VARCHAR(10);
	
  DECLARE  R_ARRIVALTYPE_RUL			VARCHAR(200);
  DECLARE  R_FREIGHTCLASS_RUL			VARCHAR(200);
  DECLARE  R_VEHICLETYPE_RUL			VARCHAR(200);
  DECLARE  R_OPERATIONTYPE        VARCHAR(10);
  DECLARE  R_FACILITYID           VARCHAR(20);
  DECLARE  R_DOCKSEQUENCE         CHAR(1);
	DECLARE  R_DocksOccupied				INT;
  DECLARE  R_CUSTOMERCLASSBASE		VARCHAR(10);
  DECLARE  R_CUSTOMERCLASS 				VARCHAR(10);
  DECLARE  R_ALLOCATIONRULE       CHAR(2);
  DECLARE  R_X0            				INT;
  DECLARE  R_Y0										INT;

  DECLARE DONE                   	INT DEFAULT 0 ;
	
  DECLARE CURTIMEOUT CURSOR FOR
  SELECT H.ARRIVALNO,H.QUEUENO,H.QUEUESEQNO 
    FROM DOC_ARRIVAL_HEADER H WHERE H.ORGANIZATIONID=IN_ORGANIZATIONID AND H.WAREHOUSEID=IN_WAREHOUSEID
     AND H.ARRIVALSTATUS='00' AND H.DOCKALLOCATIONTIME < R_TIMEEXP AND H.DOCKNO >' ';
  
	
  DECLARE CURARR CURSOR FOR
  SELECT ARRIVALNO, ARRIVALTYPE, ARRIVALSTATUS, VEHICLETYPE, IFNULL(DOCKNO,'') AS DOCKNO, ARRIVETIME
				,CARRIERID, SUPPLIERID, CUSTOMERID, FREIGHTCLASS, PUTAWAYLOCATION
    FROM TMP_DOC_ARRIVAL_HEADER H 
    ORDER BY H.QUEUENO,H.QUEUESEQNO;
    
	
  DECLARE CURRUL CURSOR FOR
  SELECT D.ARRIVALTYPE,D.FREIGHTCLASS,D.VEHICLETYPE
        ,D.OPERATIONTYPE,D.FACILITYID,IFNULL(D.PRIORITYBASE,'CA')AS PRIORITYBASE,IFNULL(D.DOCKSEQUENCE,'A')AS DOCKSEQUENCE
        ,IFNULL(D.ALLOCATIONRULE,'01') AS ALLOCATIONRULE,IFNULL(D.DocksOccupied,1) AS DocksOccupied
        
   FROM RUL_DOCKALLOCATION_DETAILS D
  INNER JOIN RUL_DOCKALLOCATION_HEADER H ON H.ORGANIZATIONID=D.ORGANIZATIONID AND H.WAREHOUSEID=D.WAREHOUSEID AND H.RULEID=D.RULEID
  WHERE D.ORGANIZATIONID=IN_ORGANIZATIONID AND D.WAREHOUSEID=IN_WAREHOUSEID AND D.ACTIVEFLAG='Y'
  ORDER BY D.ORGANIZATIONID,D.WAREHOUSEID,D.RULEID,D.LINENUMBER;
  
	
  DECLARE CURDOCK CURSOR FOR
  SELECT * FROM BAS_DOCK D WHERE D.ORGANIZATIONID=IN_ORGANIZATIONID AND D.WAREHOUSEID=IN_WAREHOUSEID AND D.ACTIVEFLAG='Y';
	
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = 1 ;
	
	
	BEGIN
		
		
		drop temporary table if exists TMP_DOC_ARRIVAL_HEADER;
		create temporary table TMP_DOC_ARRIVAL_HEADER  (
			ARRIVALNO varchar(20) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			DOCNO	varchar(20) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			ARRIVALTYPE varchar(10) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			ARRIVALSTATUS varchar(2) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			VEHICLETYPE varchar(10) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			DOCKNO varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			ARRIVETIME datetime(0) DEFAULT NULL,
			QUEUENO char(1) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			QUEUESEQNO int(11) DEFAULT NULL,
			CARRIERID  varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			SUPPLIERID varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL, 
			CUSTOMERID varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL, 
			FREIGHTCLASS varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL, 
			PUTAWAYLOCATION varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL
		) ;
		
		create index IDX_TMP_DOC_ARRIVAL_HEADER on TMP_DOC_ARRIVAL_HEADER (queueNo, queueSeqNo);
		
		
		
		drop temporary table if exists TMP_DOC_ARRIVAL_DETAILS;
		create temporary table TMP_DOC_ARRIVAL_DETAILS  (
			ARRIVALNO varchar(20) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			DOCNO varchar(20) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			SUPPLIERID varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL, 
			CUSTOMERID varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL, 
			SKU varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL, 
			FREIGHTCLASS varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL, 
			PUTAWAYLOCATION varchar(30) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			QTY_EACH DECIMAL(20,8)
		) ;
		
		create index IDX_TMP_DOC_ARRIVAL_DETAILS on TMP_DOC_ARRIVAL_HEADER (ARRIVALNO);
		
		
		
		drop temporary table if exists TMP_BAS_DOCK;
		create temporary table TMP_BAS_DOCK  (
			DOCKNO varchar(10) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
			XCOORD INT, 
			YCOORD INT
		) ;
	END;
	
PROC01:BEGIN
  IF OUT_RETURN_CODE='*_*' THEN
    SET R_TRAN_CTL='N';
  ELSE
    SET R_TRAN_CTL='Y';
  END IF;
  SET R_CURRENTTIME		=NOW();
	SET R_Date01				=curdate();
	SET R_Date02				=date_add(curdate(), interval 1 day);
  SET OUT_RETURN_CODE	='000';
	
END PROC01;

PROC02:BEGIN
  IF IN_OPERATIONMODE NOT IN('ARRIVAL' ,'TIME') THEN
         SET OUT_RETURN_CODE ='999#Invalid parameter.';
         LEAVE THISPROC;
	END IF;
	
	IF IN_OPERATIONMODE ='ARRIVAL' THEN
	BEGIN
		SET R_ARRIVALNO =IN_DOCNO;
		SELECT H.ARRIVALTYPE,H.ARRIVALSTATUS,H.ARRIVETIME,IFNULL(H.DOCKNO,''),IFNULL(C.CODEDESCR,H.ARRIVALSTATUS)
		  INTO R_ARRIVALTYPE,R_ARRIVALSTATUS,R_ARRIVETIME,R_DOCKNO,R_ARRIVALSTATUSDESC
			FROM DOC_ARRIVAL_HEADER H 
			LEFT JOIN BSM_CODE_ML C ON C.ORGANIZATIONID =H.ORGANIZATIONID AND C.CODETYPE ='ARR_STS' AND C.CODEID=H.ARRIVALSTATUS AND C.LANGUAGEID=IN_LANGUAGE
		WHERE H.ORGANIZATIONID =IN_ORGANIZATIONID 
			AND H.WAREHOUSEID =IN_WAREHOUSEID
			AND H.ARRIVALNO =R_ARRIVALNO;
		 IF FOUND_ROWS() = 0 THEN
         SET OUT_RETURN_CODE ='999#Invalid Arrivalno.';
         LEAVE THISPROC;
		 END IF;
		 
     If r_Arrivaltype in('20','VISITING')  Then
         SET OUT_RETURN_CODE ='999#No allocate for visiting.';
         LEAVE THISPROC;
     END IF;
     IF R_ARRIVALSTATUS >='40' THEN
         SET OUT_RETURN_CODE ='999#Status:'||R_ARRIVALSTATUSDESC||',No Allocate.';
         LEAVE THISPROC;
     End If;
     If r_Dockno <>'' Then
         SET OUT_RETURN_CODE ='999#Allocated.';
         LEAVE THISPROC;
     END IF;
     
     BEGIN
       INSERT INTO TMP_DOC_ARRIVAL_HEADER
				 (ARRIVALNO, ARRIVALTYPE, ARRIVALSTATUS, VEHICLETYPE, DOCKNO, ARRIVETIME, QUEUENO, QUEUESEQNO, CARRIERID, SUPPLIERID, CUSTOMERID, FREIGHTCLASS, PUTAWAYLOCATION)
       SELECT
          ARRIVALNO, ARRIVALTYPE, ARRIVALSTATUS, VEHICLETYPE, DOCKNO, ARRIVETIME, QUEUENO, QUEUESEQNO, CARRIERID, '','','',''
       FROM DOC_ARRIVAL_HEADER H
       WHERE H.ORGANIZATIONID =IN_ORGANIZATIONID AND H.WAREHOUSEID =IN_WAREHOUSEID
         AND H.ARRIVALNO =R_ARRIVALNO;
     END;
  END;
  ELSE 
	BEGIN
    BEGIN
      SELECT IFNULL(H.TIMEOUTCONTROL,'N'),IFNULL(H.DURATION,10),IFNULL(H.TIMEOUTRULE,'1') 
				INTO R_TIMEOUTCONTROL,R_DURATION,R_TIMEOUTRULE  
        FROM RUL_DOCKALLOCATION_HEADER H
       WHERE H.ORGANIZATIONID =IN_ORGANIZATIONID AND H.WAREHOUSEID =IN_WAREHOUSEID LIMIT 1;
			IF FOUND_ROWS() = 0 THEN
         SET OUT_RETURN_CODE ='999#AllocationRule does not exist.';
         LEAVE THISPROC;
			END IF;
			
      IF R_TIMEOUTCONTROL ='Y' THEN
				SET R_TIMEEXP =date_sub(NOW(), interval R_DURATION minute);
				SET DONE =0;
				OPEN CURTIMEOUT;
				FETCH CURTIMEOUT INTO R_ARRIVALNO,R_QUEUENO,R_QUEUENOQNO;
				WHILE DONE=0 DO
					
					LEAVE THISPROC;
          IF R_TIMEOUTRULE='1' THEN
            SELECT H.QUEUENO,H.QUEUESEQNO+1 INTO R_QUEUENO,R_QUEUENOQNO
              FROM DOC_ARRIVAL_HEADER H WHERE H.ORGANIZATIONID=IN_ORGANIZATIONID AND H.WAREHOUSEID=IN_WAREHOUSEID
               AND H.ARRIVETIME >= R_Date01
               AND H.ARRIVETIME <  R_Date02
               AND H.QUEUENO =R_QUEUENO
               ORDER BY H.QUEUESEQNO DESC
							 LIMIT 1;
          ELSE 
            SELECT H.QUEUENO,H.QUEUESEQNO+1 INTO R_QUEUENO,R_QUEUENOQNO
              FROM DOC_ARRIVAL_HEADER H WHERE H.ORGANIZATIONID=IN_ORGANIZATIONID AND H.WAREHOUSEID=IN_WAREHOUSEID
               AND H.ARRIVETIME >= R_Date01
               AND H.ARRIVETIME <  R_Date02
               ORDER BY H.QUEUESEQNO DESC
							 LIMIT 1;
          END IF;
					
          UPDATE DOC_ARRIVAL_HEADER H 
             SET H.DOCKNO =NULL,H.QUEUENO=R_QUEUENO ,H.QUEUESEQNO=R_QUEUENOQNO
                ,H.DOCKALLOCATIONTIME=R_CURRENTTIME
                ,H.REASON='Time out, wait for dock allocation again.'
                ,H.EDITTIME=R_CURRENTTIME ,H.EDITWHO=IN_USERID
           WHERE H.ORGANIZATIONID =IN_ORGANIZATIONID AND H.WAREHOUSEID =IN_WAREHOUSEID
						 AND H.ARRIVALNO =R_ARRIVALNO;
					
				FETCH CURTIMEOUT INTO R_ARRIVALNO,R_QUEUENO,R_QUEUENOQNO;
				END WHILE;
				CLOSE CURTIMEOUT;
				
      END IF;
    END;
		
    Begin
			INSERT INTO TMP_DOC_ARRIVAL_HEADER
				(ARRIVALNO, ARRIVALTYPE, ARRIVALSTATUS, VEHICLETYPE, DOCKNO, ARRIVETIME, QUEUENO, QUEUESEQNO, CARRIERID, SUPPLIERID, CUSTOMERID, FREIGHTCLASS, PUTAWAYLOCATION)
			SELECT
				 ARRIVALNO, ARRIVALTYPE, ARRIVALSTATUS, VEHICLETYPE, DOCKNO, ARRIVETIME, QUEUENO, QUEUESEQNO, CARRIERID, '','','',''
      FROM DOC_ARRIVAL_HEADER H
      WHERE H.ORGANIZATIONID =IN_ORGANIZATIONID 
				AND H.WAREHOUSEID =IN_WAREHOUSEID 
				AND H.ARRIVALSTATUS ='00'
         ;
    End;
	END;
	END IF;
  
END PROC02;

PROC03:BEGIN
	OPEN CURARR;
	CURARR:LOOP
		SET DONE =0;
		FETCH CURARR INTO R_ARRIVALNO, R_ARRIVALTYPE, R_ARRIVALSTATUS, R_VEHICLETYPE, R_DOCKNO, R_ARRIVETIME
										, R_CARRIERID, R_SUPPLIERID, R_CUSTOMERID, R_FREIGHTCLASS, R_PUTAWAYLOCATION;
										
		IF DONE THEN
			LEAVE CURARR;
		END IF;
		
			IF R_ARRIVALTYPE in('20','VISITING') THEN
				
				ITERATE CURARR;
			END IF;
			IF R_DOCKNO <>'' THEN
				
				ITERATE CURARR;
			END IF;
			IF R_ARRIVETIME < R_Date01 OR R_ARRIVETIME >=R_Date02 THEN
				
				ITERATE CURARR;
			END IF;
			SET R_DOCKNOLST =NULL;
			START TRANSACTION;
			
			DELETE FROM TMP_DOC_ARRIVAL_DETAILS;
			IF R_ARRIVALTYPE ='PO' THEN
				INSERT INTO TMP_DOC_ARRIVAL_DETAILS(ARRIVALNO,DOCNO,SUPPLIERID,CUSTOMERID,SKU,QTY_EACH,FREIGHTCLASS,PUTAWAYLOCATION)
				SELECT ARR.ARRIVALNO,PH.poNo,PH.SUPPLIERID,PD.CUSTOMERID,PD.SKU,PD.ORDEREDQTY_EACH,S.FREIGHTCLASS,M.PUTAWAYLOCATION
					FROM DOC_ARRIVAL_DETAILS ARR
				 INNER JOIN DOC_APPOINTMENT_DETAILS APP ON APP.ORGANIZATIONID=ARR.ORGANIZATIONID AND APP.WAREHOUSEID=ARR.WAREHOUSEID AND APP.APPOINTMENTNO=ARR.APPOINTMENTNO
					LEFT JOIN DOC_PO_HEADER PH ON PH.ORGANIZATIONID=APP.ORGANIZATIONID AND PH.WAREHOUSEID=APP.WAREHOUSEID AND PH.PONO=APP.DOCNO AND APP.DOCTYPE='PO'
					LEFT JOIN DOC_PO_DETAILS PD ON PD.ORGANIZATIONID=PH.ORGANIZATIONID AND PD.WAREHOUSEID=PH.WAREHOUSEID AND PD.PONO=PH.PONO
					LEFT JOIN BAS_SKU S ON S.ORGANIZATIONID=PD.ORGANIZATIONID AND S.CUSTOMERID=PD.CUSTOMERID AND S.SKU=PD.SKU
					LEFT JOIN BAS_SKU_MULTIWAREHOUSE M ON M.ORGANIZATIONID=S.ORGANIZATIONID AND M.CUSTOMERID=S.CUSTOMERID AND M.SKU=S.SKU AND M.WAREHOUSEID=IN_WAREHOUSEID
				 WHERE ARR.ORGANIZATIONID =IN_ORGANIZATIONID AND ARR.WAREHOUSEID =IN_WAREHOUSEID AND ARR.ARRIVALNO =R_ARRIVALNO;
			END IF;
			IF R_ARRIVALTYPE ='INBOUND' THEN
				INSERT INTO TMP_DOC_ARRIVAL_DETAILS(ARRIVALNO,DOCNO,SUPPLIERID,CUSTOMERID,SKU,QTY_EACH,FREIGHTCLASS,PUTAWAYLOCATION)
				SELECT ARR.ARRIVALNO,AH.asnNo,AH.SUPPLIERID,AD.CUSTOMERID,AD.SKU,AD.EXPECTEDQTY_EACH,S.FREIGHTCLASS,M.PUTAWAYLOCATION 
					FROM DOC_ARRIVAL_DETAILS ARR
				 INNER JOIN DOC_APPOINTMENT_DETAILS APP ON APP.ORGANIZATIONID=ARR.ORGANIZATIONID AND APP.WAREHOUSEID=ARR.WAREHOUSEID AND APP.APPOINTMENTNO=ARR.APPOINTMENTNO
					LEFT JOIN DOC_ASN_HEADER AH ON AH.ORGANIZATIONID=APP.ORGANIZATIONID AND AH.WAREHOUSEID=APP.WAREHOUSEID AND AH.ASNNO=APP.DOCNO AND APP.DOCTYPE='ASN'
					LEFT JOIN DOC_ASN_DETAILS AD ON AD.ORGANIZATIONID=AH.ORGANIZATIONID AND AD.WAREHOUSEID=AH.WAREHOUSEID AND AD.ASNNO=AH.ASNNO
					LEFT JOIN BAS_SKU S ON S.ORGANIZATIONID=AD.ORGANIZATIONID AND S.CUSTOMERID=AD.CUSTOMERID AND S.SKU=AD.SKU
					LEFT JOIN BAS_SKU_MULTIWAREHOUSE M ON M.ORGANIZATIONID=S.ORGANIZATIONID AND M.CUSTOMERID=S.CUSTOMERID AND M.SKU=S.SKU AND M.WAREHOUSEID=IN_WAREHOUSEID
					WHERE ARR.ORGANIZATIONID =IN_ORGANIZATIONID AND ARR.WAREHOUSEID =IN_WAREHOUSEID AND ARR.ARRIVALNO =R_ARRIVALNO;
			END IF;
			IF R_ARRIVALTYPE ='OUTBOUND' THEN
				INSERT INTO TMP_DOC_ARRIVAL_DETAILS(ARRIVALNO,DOCNO,SUPPLIERID,CUSTOMERID,SKU,QTY_EACH,FREIGHTCLASS,PUTAWAYLOCATION)
				SELECT ARR.ARRIVALNO,OH.orderNo,OH.CARRIERID,OD.CUSTOMERID,OD.SKU,OD.QTYSHIPPED_EACH,S.FREIGHTCLASS,M.PUTAWAYLOCATION 
					FROM DOC_ARRIVAL_DETAILS ARR
				 INNER JOIN DOC_APPOINTMENT_DETAILS APP ON APP.ORGANIZATIONID=ARR.ORGANIZATIONID AND APP.WAREHOUSEID=ARR.WAREHOUSEID AND APP.APPOINTMENTNO=ARR.APPOINTMENTNO
					LEFT JOIN DOC_ORDER_HEADER OH ON OH.ORGANIZATIONID=APP.ORGANIZATIONID AND OH.WAREHOUSEID=APP.WAREHOUSEID AND OH.ORDERNO=APP.DOCNO AND APP.DOCTYPE='SO'
					LEFT JOIN DOC_ORDER_DETAILS OD ON OD.ORGANIZATIONID=OH.ORGANIZATIONID AND OD.WAREHOUSEID=OH.WAREHOUSEID AND OD.ORDERNO=OH.ORDERNO
					LEFT JOIN BAS_SKU S ON S.ORGANIZATIONID=OD.ORGANIZATIONID AND S.CUSTOMERID=OD.CUSTOMERID AND S.SKU=OD.SKU
					LEFT JOIN BAS_SKU_MULTIWAREHOUSE M ON M.ORGANIZATIONID=S.ORGANIZATIONID AND M.CUSTOMERID=S.CUSTOMERID AND M.SKU=S.SKU AND M.WAREHOUSEID=IN_WAREHOUSEID
					WHERE ARR.ORGANIZATIONID =IN_ORGANIZATIONID AND ARR.WAREHOUSEID =IN_WAREHOUSEID AND ARR.ARRIVALNO =R_ARRIVALNO;
			END IF;
			
			BEGIN
				SELECT T.FREIGHTCLASS INTO R_FREIGHTCLASS
				FROM TMP_DOC_ARRIVAL_DETAILS T WHERE T.ARRIVALNO =R_ARRIVALNO GROUP BY T.FREIGHTCLASS ORDER BY SUM(T.QTY_EACH) DESC LIMIT 1;
				SELECT T.SUPPLIERID INTO R_SUPPLIERID
				FROM TMP_DOC_ARRIVAL_DETAILS T WHERE T.ARRIVALNO =R_ARRIVALNO GROUP BY T.SUPPLIERID ORDER BY SUM(T.QTY_EACH) DESC LIMIT 1;
				SELECT T.CUSTOMERID INTO R_CUSTOMERID
				FROM TMP_DOC_ARRIVAL_DETAILS T WHERE T.ARRIVALNO =R_ARRIVALNO GROUP BY T.CUSTOMERID ORDER BY SUM(T.QTY_EACH) DESC LIMIT 1;
				SELECT T.PUTAWAYLOCATION INTO R_PUTAWAYLOCATION
				FROM TMP_DOC_ARRIVAL_DETAILS T WHERE T.ARRIVALNO =R_ARRIVALNO GROUP BY T.PUTAWAYLOCATION ORDER BY SUM(T.QTY_EACH) DESC LIMIT 1;
			END;
			
			BEGIN
				OPEN CURRUL;
				CURRUL:LOOP
					SET DONE =0;
					FETCH CURRUL INTO R_ARRIVALTYPE_RUL,R_FREIGHTCLASS_RUL,R_VEHICLETYPE_RUL
													, R_OPERATIONTYPE,R_FACILITYID,R_CUSTOMERCLASSBASE,R_DOCKSEQUENCE,R_ALLOCATIONRULE,R_DocksOccupied;
					IF DONE THEN
						LEAVE CURRUL;
					END IF;
					
					IF INSTR(R_ARRIVALTYPE_RUL,R_ARRIVALTYPE)=0 THEN
						
						ITERATE CURRUL;
					END IF;
					IF INSTR(R_VEHICLETYPE_RUL,R_VEHICLETYPE)=0 THEN
						
						ITERATE CURRUL;
					END IF;
					IF INSTR(R_FREIGHTCLASS_RUL,R_FREIGHTCLASS)=0 THEN
						
						ITERATE CURRUL;
					END IF;
					
					BEGIN
						SET R_CUSTOMERID =CASE R_CUSTOMERCLASSBASE WHEN 'CA' THEN R_CARRIERID WHEN 'VE' THEN R_SUPPLIERID WHEN 'OW' THEN R_CUSTOMERID ELSE R_SUPPLIERID END;
						
						SET R_CUSTOMERCLASS =NULL;
						SELECT C.CUSTOMERCLASS INTO R_CUSTOMERCLASS
							FROM BAS_CUSTOMER C WHERE C.ORGANIZATIONID =IN_ORGANIZATIONID AND C.CUSTOMERID =R_CUSTOMERID AND C.CUSTOMERTYPE =R_CUSTOMERCLASSBASE;
						SET R_CUSTOMERCLASS =IFNULL(R_CUSTOMERCLASS,'CM');
					END;
					
					BEGIN
						DELETE FROM TMP_BAS_DOCK;
						INSERT INTO TMP_BAS_DOCK(DOCKNO, XCOORD, YCOORD)
						SELECT DOCKNO, XCOORD, YCOORD
						FROM BAS_DOCK D 
						WHERE D.ORGANIZATIONID =IN_ORGANIZATIONID AND D.WAREHOUSEID =IN_WAREHOUSEID
							AND D.ACTIVEFLAG ='Y'
							AND IFNULL(D.VEHICLETYPE,R_VEHICLETYPE) =R_VEHICLETYPE   
							AND IFNULL(D.FREIGHTCLASS,R_FREIGHTCLASS)=R_FREIGHTCLASS 
							AND (D.FACILITYID =R_FACILITYID OR R_FACILITYID IS NULL) 
							AND D.CUSTOMERCLASS =R_CUSTOMERCLASS
							AND D.OPERATIONTYPE =R_OPERATIONTYPE 
							AND NOT EXISTS(SELECT 1
						FROM DOC_ARRIVAL_HEADER H WHERE H.ORGANIZATIONID =D.ORGANIZATIONID AND H.WAREHOUSEID =D.WAREHOUSEID AND instr(H.DOCKNO,D.DOCKNO) >0
						AND H.ARRIVALSTATUS <'60');
					END;
					
					BEGIN
						IF R_ALLOCATIONRULE ='01' THEN
							IF R_DOCKSEQUENCE ='A' THEN
								SELECT T.DOCKNO INTO R_DOCKNO FROM TMP_BAS_DOCK T ORDER BY T.DOCKNO ASC LIMIT 1;
							ELSE
								SELECT T.DOCKNO INTO R_DOCKNO FROM TMP_BAS_DOCK T ORDER BY T.DOCKNO DESC LIMIT 1;
							END IF;
						ELSE 
							IF R_ALLOCATIONRULE ='03' THEN
								
								SELECT T.DOCNO INTO R_DOCNO
								FROM TMP_DOC_ARRIVAL_DETAILS T GROUP BY T.DOCNO ORDER BY SUM(T.QTY_EACH) DESC LIMIT 1;
								
								SELECT TS.locationId INTO R_PUTAWAYLOCATION FROM TSK_SORTATION_STATION TS 
								WHERE TS.ORGANIZATIONID =IN_ORGANIZATIONID AND TS.WAREHOUSEID =IN_WAREHOUSEID 
									AND TS.orderNo =R_DOCNO ORDER BY TS.locationId LIMIT 1;
							END IF;
							
							BEGIN
								
								SELECT B.xDistance ,B.yDistance INTO R_X0 ,R_Y0 FROM BAS_LOCATION B 
								 WHERE B.ORGANIZATIONID =IN_ORGANIZATIONID AND B.WAREHOUSEID =IN_WAREHOUSEID 
									AND B.LOCATIONID =R_PUTAWAYLOCATION;
								
								SELECT T.DOCKNO INTO R_DOCKNO FROM TMP_BAS_DOCK T ORDER BY POWER(T.XCOORD-R_X0,2) + POWER(T.YCOORD-R_Y0,2)  LIMIT 1;
							END;
						END IF;
				
						
						SET R_DOCKNOLST =NULL;
						IF IFNULL(R_DOCKNO,'') <>'' THEN
						BEGIN
							SET R_DOCKNOLST =R_DOCKNO;
							WHILE R_DocksOccupied > 1 DO
								IF R_DOCKSEQUENCE ='A' THEN
									SET R_DOCKNO =NULL;
									select DOCKNO INTO R_DOCKNO from BAS_DOCK D 
									 WHERE D.ORGANIZATIONID =IN_ORGANIZATIONID AND D.WAREHOUSEID =IN_WAREHOUSEID AND D.DOCKNO >R_DOCKNO 
									 ORDER BY D.DOCKNO ASC LIMIT 1;
								ELSE
									SET R_DOCKNO =NULL;
									select DOCKNO INTO R_DOCKNO from BAS_DOCK D 
									 WHERE D.ORGANIZATIONID =IN_ORGANIZATIONID AND D.WAREHOUSEID =IN_WAREHOUSEID AND D.DOCKNO <R_DOCKNO
									 ORDER BY D.DOCKNO DESC LIMIT 1;
								END IF;
								SELECT DOCKNO INTO R_DOCKNO
								FROM BAS_DOCK D 
								WHERE D.ORGANIZATIONID =IN_ORGANIZATIONID AND D.WAREHOUSEID =IN_WAREHOUSEID AND D.DOCKNO=R_DOCKNO
									AND D.ACTIVEFLAG ='Y'
									AND IFNULL(D.VEHICLETYPE,R_VEHICLETYPE) =R_VEHICLETYPE   
									AND IFNULL(D.FREIGHTCLASS,R_FREIGHTCLASS)=R_FREIGHTCLASS 
									AND (D.FACILITYID =R_FACILITYID OR R_FACILITYID IS NULL) 
									AND D.CUSTOMERCLASS =R_CUSTOMERCLASS
									AND D.OPERATIONTYPE =R_OPERATIONTYPE
									AND NOT EXISTS(SELECT 1
								FROM DOC_ARRIVAL_HEADER H WHERE H.ORGANIZATIONID=D.ORGANIZATIONID AND H.WAREHOUSEID=D.WAREHOUSEID AND instr(H.DOCKNO,D.DOCKNO) >0
								AND H.ARRIVALSTATUS <'60');
								
								IF FOUND_ROWS() =1 THEN
									SET R_DOCKNOLST =CONCAT(R_DOCKNOLST,',',R_DOCKNO);
									SET R_DocksOccupied =R_DocksOccupied -1;
								ELSE
									SET R_DocksOccupied =0;
								END IF;
							END WHILE;
							
							LEAVE CURRUL;
						END;
						END IF;
					END;
					
				END LOOP CURRUL;
				CLOSE CURRUL;
			END ;
			
			IF R_DOCKNOLST  IS NULL THEN
				SET @REASON ='No available dock.';
			ELSE
				SET @REASON ='Allocation Succeeded.';
			END IF;
			
			UPDATE DOC_ARRIVAL_HEADER H 
				 SET H.DOCKNO =R_DOCKNOLST
						,H.DOCKALLOCATIONTIME=R_CURRENTTIME
						,H.REASON=@REASON
						,H.EDITTIME=R_CURRENTTIME ,H.EDITWHO=IN_USERID
			 WHERE H.ORGANIZATIONID =IN_ORGANIZATIONID AND H.WAREHOUSEID =IN_WAREHOUSEID AND H.ARRIVALNO =R_ARRIVALNO;
		
		IF R_TRAN_CTL ='Y' THEN
			 COMMIT;
		END IF;
		
	END LOOP CURARR;
	CLOSE CURARR;
END PROC03;

PROC04:BEGIN
  SET OUT_RETURN_CODE ='000#Allocation Succeeded.';
  IF IN_OPERATIONMODE ='ARRIVAL' THEN
    IF R_DOCKNOLST IS NULL THEN
         SET OUT_RETURN_CODE ='999#No available dock.';
    End If;
  End If;
END PROC04;


END THISPROC
$$

--
-- Create procedure `printlabel_sku_byasn`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE printlabel_sku_byasn (IN IN_organizationId varchar(255),
IN IN_warehouseId varchar(255),
IN IN_asnNo varchar(255))
BEGIN
  DECLARE done boolean DEFAULT 0;
  DECLARE inner_done boolean DEFAULT 0;
  DECLARE c_sku varchar(100);
  DECLARE c_expectedQty varchar(100);
  DECLARE c_in_asnNo varchar(100);
  DECLARE c_in_sku varchar(100);
  DECLARE strquery text;

  DECLARE cursor_var CURSOR FOR
  SELECT
    sku,
    expectedQty
  FROM DOC_ASN_DETAILS dad
  WHERE organizationId = IN_organizationId
  AND warehouseId = IN_warehouseId
  AND asnNo IN (IN_asnNo)
  GROUP BY sku,
           expectedQty;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  SET strquery = '';

  DROP TEMPORARY TABLE IF EXISTS tbl_label_print;
  CREATE TEMPORARY TABLE tbl_label_print (
    asnNo varchar(255),
    sku varchar(255)
  );

  OPEN cursor_var;

cursor_var_loop:
  LOOP
    FETCH cursor_var INTO c_sku, c_expectedQty;
    IF done = 1 THEN
      LEAVE cursor_var_loop;
    END IF;

  INNER_BLOCK:
    BEGIN

      DECLARE x int;
      DECLARE y int;

      SET x = 1;
      SET y = c_expectedQty;

    loop_label:
      LOOP
        IF x > y THEN
          LEAVE loop_label;
        END IF;
        SET x = x + 1;

        INSERT INTO tbl_label_print (asnNo, sku)
          SELECT
            IN_asnNo,
            c_sku;

      END LOOP;

    END INNER_BLOCK;


  END LOOP;

  CLOSE cursor_var;

  SELECT
    asnNo,
    sku
  FROM tbl_label_print;


END
$$

--
-- Create procedure `OJV_CML_TEST`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_TEST (OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE r_appointmentDate timestamp;
    DECLARE r_arriveTime timestamp;
    DECLARE r_rest1 timestamp;
    DECLARE r_latehour varchar(200);
    DECLARE r_ttlrest int;
    SELECT DISTINCT
      A.arriveTime,
      CAST(CONCAT(DATE(C.appointmentDate), ' ', C.startTime) AS datetime),
      CAST(CONCAT(DATE(NOW()), ' ', '12:00') AS datetime) INTO r_arriveTime, r_appointmentDate, r_rest1
    FROM DOC_ARRIVAL_HEADER A
      LEFT JOIN DOC_ARRIVAL_DETAILS B
        ON A.organizationId = B.organizationId
        AND A.arrivalNo = B.arrivalno
      LEFT JOIN DOC_APPOINTMENT_HEADER C
        ON B.organizationId = C.organizationId
        AND B.appointmentno = C.appointmentNo
    WHERE A.arrivalNo = '200819013';
    SET r_ttlrest = 0;

    IF (CAST('12:00:00' AS time) BETWEEN TIME(r_appointmentDate) AND TIME(r_arriveTime))
      AND (CAST('18:00:00' AS time) BETWEEN TIME(r_appointmentDate) AND TIME(r_arriveTime)) THEN
      SET r_ttlrest = 2;
    ELSE

      IF (CAST('12:00:00' AS time) BETWEEN TIME(r_appointmentDate) AND TIME(r_arriveTime))
        OR (CAST('18:00:00' AS time) BETWEEN TIME(r_appointmentDate) AND TIME(r_arriveTime)) THEN
        SET r_ttlrest = 1;
      ELSE
        SET r_ttlrest = 0;
      END IF;
    END IF;

    SELECT
      TIMESTAMPDIFF(HOUR, r_appointmentDate, r_arriveTime) + 1 - r_ttlrest INTO r_latehour;
    SELECT
      r_latehour;
    SET OUT_returnCode = r_latehour;
  END
  $$

--
-- Create procedure `OJV_CML_SPUDF_OPERATION_PROCE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPUDF_OPERATION_PROCE (IN `IN_organizationId` varchar(20),
IN `IN_warehouseId` varchar(20),
IN `IN_operationType` varchar(50),
IN `IN_para1` varchar(50),
IN `IN_para2` varchar(50),
IN `IN_para3` varchar(50),
IN `IN_para4` varchar(50),
IN `IN_para5` varchar(50),
IN `IN_userId` varchar(50),
IN `IN_language` varchar(50),
OUT `OUT_returnCode` varchar(100))
BEGIN
  SET OUT_returnCode := '000';

  IF IN_operationType = 'C0104_APRINT_S_LABEL' THEN

    DELETE
      FROM TMP_UDFFUNCTION_PRINT
    WHERE Organizationid = IN_organizationId
      AND Warehouseid = IN_warehouseId
      AND Addwho = IN_userId;

    INSERT INTO TMP_UDFFUNCTION_PRINT (Organizationid, Warehouseid, Functionid, Parameter1, Parameter2,
    Parameter3, Field1, Field2, Field3, Field4, Field5, Addwho, Seqno)
      SELECT
        A.Organizationid,
        IN_warehouseId,
        'C0104_APRINT_S_LABEL',
        A.Sku,
        A.Skudescr1,
        A.Skudescr2,
        '',
        '',
        '',
        '',
        '',
        IN_userId,
        NEXTVAL('seq_C0104_APRINT')
      FROM BAS_SKU A
      WHERE A.Organizationid = IN_organizationId
      AND A.Sku = IN_para1;

    SET OUT_returnCode := '000';
  END IF;
END
$$

--
-- Create procedure `OJV_CML_SPBCD_TraceId`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPBCD_TraceId (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_barcode varchar(100),
IN IN_customerId varchar(30),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_TraceId varchar(50),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_TraceId,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';
    SET OUT_traceId := IN_barcode;

  END
  $$

--
-- Create procedure `OJV_CML_SPBCD_TaskId`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPBCD_TaskId (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_traceId varchar(90),
IN IN_barcode varchar(90),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_taskId varchar(50),
INOUT OUT_taskIdSequence varchar(50),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_TaskId,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `OJV_CML_SPBCD_DocNo`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_SPBCD_DocNo (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_docNo varchar(50),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_DocNo,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_docNo = IN_barcode;
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `OJV_CML_INV_LOG_REV`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_INV_LOG_REV (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_billingNo varchar(50),
IN IN_userId varchar(100),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_Language varchar(100);
    DECLARE R_USERNAME varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#OJV_CML_SPUDF_Process1',
      IFNULL(@p1, ''),
      IFNULL(@p2, ''),
      IFNULL(@p3, ''),
      IFNULL(@p4, ''),
      IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_warehouseId;
    END;
    INSERT INTO BIL_INV_LOG (ORGANIZATIONID,
    WAREHOUSEID,
    BILLINGNO,
    INVOICENO,
    ACTION,
    EDITWHO,
    EDITTIME,
    REASONCODE)
      SELECT
        A.ORGANIZATIONID,
        A.WAREHOUSEID,
        A.BILLINGNO,
        A.UDF01,
        'CANCEL REVIEW',
        B.USERNAME,
        NOW(),
        A.UDF02
      FROM BIL_BILLING_HEADER A
        LEFT JOIN BSM_USER B
          ON A.ORGANIZATIONID = B.ORGANIZATIONID
          AND B.USERID = IN_userId
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.BILLINGNO = IN_billingNo;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `OJV_CML_INV_LOG`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_INV_LOG (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_billingNo varchar(50),
IN IN_userId varchar(100),
OUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE IN_Language varchar(100);
    DECLARE R_USERNAME varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#OJV_CML_SPUDF_Process1',
      IFNULL(@p1, ''),
      IFNULL(@p2, ''),
      IFNULL(@p3, ''),
      IFNULL(@p4, ''),
      IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_warehouseId;
    END;
    INSERT INTO BIL_INV_LOG (ORGANIZATIONID,
    WAREHOUSEID,
    BILLINGNO,
    INVOICENO,
    ACTION,
    EDITWHO,
    EDITTIME,
    REASONCODE)
      SELECT
        A.ORGANIZATIONID,
        A.WAREHOUSEID,
        A.BILLINGNO,
        A.UDF01,
        'REVIEW',
        B.USERNAME,
        NOW(),
        A.UDF02
      FROM BIL_BILLING_HEADER A
        LEFT JOIN BSM_USER B
          ON A.ORGANIZATIONID = B.ORGANIZATIONID
          AND B.USERID = IN_userId
      WHERE A.ORGANIZATIONID = IN_organizationId
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.BILLINGNO = IN_billingNo
    ;
    SET OUT_returnCode := '000';
  END
  $$

--
-- Create procedure `OJV_CML_BILLINGLISTAPI`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE OJV_CML_BILLINGLISTAPI (p_organizationId varchar(20),
p_warehouseId varchar(20),
p_docNo varchar(50),
p_masterTariffId varchar(10),
p_sku varchar(50),
p_staff varchar(20),
OUT p_Return_Code varchar(1000))
ENDPROC:
  BEGIN

    DECLARE v_staffValication varchar(1);
    DECLARE v_masterTariffIdValidation varchar(1);
    DECLARE v_tariffId varchar(10);
    DECLARE v_olddocNo varchar(50);
    DECLARE v_NO_COMMIT char(1);
    DECLARE v_error int;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;

      SET p_Return_Code = CONCAT('999#OJV_CML_BILLINGLISTAPI,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        p_Return_Code AS error;
    END;

    SET v_error = 1;
    IF p_Return_Code = 'NO_COMMIT'
      OR p_Return_Code = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    SET p_Return_Code = '000';

    /*staffId Validation*/
    IF p_staff <> '' THEN
      SELECT
        COUNT(*) INTO v_staffValication
      FROM BAS_STAFF
      WHERE organizationId = p_organizationId
      AND warehouseId = p_warehouseId
      AND staffId = p_staff;

      IF v_staffValication = '0' THEN
        SET p_Return_Code = '999#staffId Not Valid';
        DELETE
          FROM BIL_SUMMARY
        WHERE organizationId = p_organizationId
          AND warehouseId = p_warehouseId
          AND billingSummaryId = p_docNo;
        LEAVE ENDPROC;
      END IF;
    END IF;
    /* masterTariffId Valication*/
    /*IF SKU EMPTY*/
    IF p_sku = '' THEN
      SELECT DISTINCT
        B.tariffId INTO v_tariffId
      FROM BAS_SKU_MULTIWAREHOUSE A
        LEFT JOIN BIL_TARIFF_HEADER B
          ON B.organizationId = A.organizationId
          AND B.tariffMasterId = A.tariffMasterId
        LEFT JOIN BIL_TARIFF_DETAILS C
          ON C.organizationId = B.organizationId
          AND C.tariffId = B.tariffId
      WHERE A.organizationId = p_organizationId
      AND A.warehouseId = p_warehouseId
      AND A.tariffMasterId = p_masterTariffId
      AND TIMESTAMPDIFF(SECOND, B.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
      AND TIMESTAMPDIFF(SECOND, B.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    ELSE
      /*IF SKU NOT EMPTY*/
      SELECT DISTINCT
        B.tariffId INTO v_tariffId
      FROM BAS_CUSTOMER_MULTIWAREHOUSE A
        LEFT JOIN BIL_TARIFF_HEADER B
          ON B.organizationId = A.organizationId
          AND B.tariffMasterId = A.tariffMasterId
        LEFT JOIN BIL_TARIFF_DETAILS C
          ON C.organizationId = B.organizationId
          AND C.tariffId = B.tariffId
      WHERE A.organizationId = p_organizationId
      AND A.warehouseId = p_warehouseId
      AND A.tariffMasterId = p_masterTariffId
      AND TIMESTAMPDIFF(SECOND, B.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
      AND TIMESTAMPDIFF(SECOND, B.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;

      IF v_tariffId IS NULL THEN
        SET p_Return_Code = '999#masterTariffId Not Valid';
        DELETE
          FROM BIL_SUMMARY
        WHERE organizationId = p_organizationId
          AND warehouseId = p_warehouseId
          AND billingSummaryId = p_docNo;
        LEAVE ENDPROC;
      ELSE
        UPDATE BIL_SUMMARY
        SET tariffId = v_tariffId
        WHERE organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND billingSummaryId = p_docNo;
      END IF;
    END IF;


    -- ADD BY AKBAR 28.10.2024 FOR REPLACE FUNCTION OLD BILLING SUMMARY ID

    SELECT DISTINCT
      ta.lot04 INTO v_olddocNo
    FROM TEMP_API ta
    WHERE ta.lot01 = p_organizationId
    AND ta.lot02 = p_warehouseId
    AND ta.lot03 = p_docNo;
    IF (LENGTH(v_olddocNo) > 0) THEN
    BEGIN
      DELETE
        FROM BIL_SUMMARY
      WHERE organizationId = p_organizationId
        AND warehouseId = p_warehouseId
        AND billingSummaryId IN (SELECT DISTINCT
            ta.lot04
          FROM TEMP_API ta
          WHERE ta.lot01 = p_organizationId
          AND ta.lot02 = p_warehouseId
          AND ta.lot03 = p_docNo);

      UPDATE BIL_SUMMARY bs
      SET bs.billingSummaryId = v_olddocNo
      WHERE organizationId = p_organizationId
      AND warehouseId = p_warehouseId
      AND billingSummaryId = p_docNo;
    END;
    END IF;



    IF v_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;
    SET p_Return_Code = '000';
  END
  $$

--
-- Create procedure `LoadCalendars`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE LoadCalendars (startDate date,
day int)
BEGIN

  DECLARE counter int DEFAULT 1;
  DECLARE dt date DEFAULT startDate;
  WHILE counter <= day DO
    CALL InsertCalendar(dt);
    SET counter = counter + 1;
    SET dt = DATE_ADD(dt, INTERVAL 1 day);
  END WHILE;
END
$$

--
-- Create procedure `GetInventoryData`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE GetInventoryData (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_trans_no varchar(30),
IN IN_tariffMaster varchar(30))
BEGIN
  DECLARE done int DEFAULT FALSE;
  DECLARE out_stockDate date;
  DECLARE out_warehouseId varchar(20);
  DECLARE out_tariffMasterId varchar(20);
  DECLARE out_tariffId varchar(20);
  DECLARE out_customerId varchar(50);
  DECLARE out_locationId varchar(20);
  DECLARE out_locationCategory varchar(20);
  DECLARE out_locationCategoryDescr varchar(50);
  DECLARE out_traceId varchar(50);
  DECLARE out_skugroup1 varchar(20);
  DECLARE out_muid varchar(20);
  DECLARE out_lotNum varchar(50);
  DECLARE out_packId varchar(20);
  DECLARE out_UOM varchar(10);
  DECLARE out_sku varchar(50);
  DECLARE out_skuDesc varchar(100);
  DECLARE out_poNum varchar(50);
  DECLARE out_typePallet varchar(50);
  DECLARE out_qtyonHand decimal(18, 2);
  DECLARE out_qtyPerPallet decimal(18, 2);
  DECLARE out_cbmsku decimal(18, 6);
  DECLARE out_qtycbm decimal(18, 2);
  DECLARE out_chamber varchar(10);
  DECLARE out_putawayRule varchar(50);
  DECLARE out_batchNo varchar(50);
  DECLARE out_Expiredate date;
  DECLARE out_WHdate date;
  DECLARE out_Area varchar(10);
  DECLARE out_ExternalPo varchar(50);
  DECLARE out_Whether_damaged varchar(50);
  DECLARE out_Pallet_Used int;
  DECLARE out_NETWEIGHT decimal(18, 2);

  DECLARE cur CURSOR FOR
  SELECT
    DATE_FORMAT(StockDate, '%Y-%m-%d') AS stockDate,
    zib.warehouseId AS warehouseId,
    sm.tariffMasterId,
    CASE WHEN zib.customerid = 'LTL' THEN la1.codedescr ELSE sm.tariffId END AS tariffId,
    CASE WHEN zib.customerId = 'MAP' THEN 'SAMSONITE' ELSE zib.customerId END AS customerId,
    zib.locationId,
    zib.locationCategory,
    lc.codeDescr AS locationCategoryDescr,
    zib.traceId,
    s.sku_group1 AS skugroup1,
    zib.muid AS muid,
    zib.lotNum,
    s.packId,
    CASE WHEN zib.customerId = 'MDS' THEN 'KG' ELSE zib.UOM END AS UOM,
    zib.sku,
    SKUDesc AS skuDesc,
    la.lotAtt09 AS poNum,
    lc1.codedescr AS typePallet,
    CASE WHEN zib.customerId = 'MDS' THEN (CASE WHEN pd2.uomdescr = 'KG' THEN zib.qtyonHand ELSE zib.qtyonHand * s.sku_group6 END) ELSE zib.qtyonHand END AS qtyonHand,
    pd.qty AS qtyPerPallet,
    CASE zib.customerid WHEN 'ASP' THEN zib.cube WHEN 'MAP' THEN (s.cube) WHEN 'ONDULINE' THEN (s.cube) WHEN 'SST_JKT' THEN (s.cube) WHEN 'CPI_JKT' THEN (s.cube) ELSE (s.cube / 1000000) END AS cbmsku,
    CASE zib.customerid WHEN 'MAP' THEN (CASE WHEN la.lotAtt04 = 'SET' THEN 0 ELSE (s.cube * qtyonHand) END) WHEN 'ONDULINE' THEN s.cube * qtyonHand ELSE totalCube END AS qtycbm,
    CASE WHEN LENGTH(zib.locationId) = 7 THEN SUBSTRING(zib.locationId, 1, 1) WHEN LENGTH(zib.locationId) = 8 THEN SUBSTRING(zib.locationId, 1, 1) WHEN SUBSTRING(zib.locationId, 1, 3) = 'TML' AND
        zib.customerid <> 'LTL' THEN SUBSTRING(zib.locationId, 4, 1) WHEN sm.putawayRule = 'LTL09' THEN 'E' WHEN zib.sku IN ('000000001100012851', '000000001100010211', '000000001100000616', '000000001100013296', '000000001100008797', '000000001100012070', '000000001100012068', '000000001100012478', '000000001100012898', '000000001100014515') THEN 'G' WHEN sm.putawayRule IN ('LTL03', 'GMPA-NONDG', 'ICHIKOH-NONDG', 'ITOCHU-NONDG', 'PMM-NONDG', 'LTL06', 'LTL07') THEN 'G' WHEN sm.putawayRule IN ('LTL08', 'ITOCHU-DG', 'PMM-DG', 'LTL01', 'LTL02', 'SMT') THEN 'B' WHEN sm.putawayRule = 'LTL-BULK' THEN 'D' WHEN sm.putawayRule IN ('BAJ', 'PLB-LTL', 'ADF', 'CCDI', 'CTI') THEN 'A' WHEN sm.putawayRule IN ('GYI', 'DKJ') THEN 'J' WHEN sm.putawayRule = 'LTL04' THEN 'B' WHEN sm.putawayRule IN ('DNN', 'PMM', 'ITOCHU') THEN 'C' ELSE l.udf03 END AS chamber,
    sm.putawayRule,
    la.lotAtt04 AS batchNo,
    la.lotAtt02 AS Expiredate,
    la.lotAtt03 AS WHdate,
    CASE WHEN zib.customerId = 'ECCOSBY' THEN (CASE WHEN SUBSTRING(zib.locationId, 3, 1) = 'I' THEN 'ECCO2' ELSE 'ECCO' END) ELSE SUBSTRING(zib.locationId, 1, 1) END AS Area,
    CASE WHEN zib.customerId = 'PLB-LTL' THEN la.lotAtt10 ELSE la.lotAtt09 END AS ExternalPo,
    lc2.codedescr AS Whether_damaged,
    CEILING(qtyonHand / pd.qty) AS Pallet_Used,
    CASE WHEN zib.customerid = 'RBFOOD' THEN pd1.qty ELSE s.netweight END AS NETWEIGHT
  FROM Z_InventoryBalance zib
    LEFT JOIN INV_LOT_ATT la
      ON la.organizationId = zib.organizationId
      AND la.customerId = zib.customerId
      AND la.sku = zib.sku
      AND la.lotNum = zib.lotNum
    LEFT OUTER JOIN (SELECT
        *
      FROM BSM_CODE_ML
      WHERE codetype = 'OWNER_LTL'
      AND languageid = 'en') la1
      ON la.organizationId = la1.organizationId
      AND la.lotatt11 = la1.codeid
    LEFT JOIN BAS_LOCATION l
      ON l.organizationId = zib.organizationId
      AND l.locationId = zib.locationId
      AND l.warehouseId = zib.warehouseId
    LEFT JOIN BAS_SKU s
      ON s.organizationId = zib.organizationId
      AND s.customerId = zib.customerId
      AND s.sku = zib.sku
    LEFT JOIN BAS_SKU_MULTIWAREHOUSE sm
      ON sm.organizationId = zib.organizationId
      AND sm.customerId = zib.customerId
      AND sm.sku = zib.sku
      AND sm.warehouseId = zib.warehouseId
    LEFT JOIN BAS_PACKAGE_DETAILS pd
      ON sm.organizationId = pd.organizationId
      AND sm.customerId = pd.customerId
      AND sm.packId = pd.packId
      AND pd.packUom = 'PL'
    LEFT JOIN BAS_PACKAGE_DETAILS pd1
      ON sm.organizationId = pd1.organizationId
      AND sm.customerId = pd1.customerId
      AND sm.packId = pd1.packId
      AND pd1.packUom = 'CS'
    LEFT JOIN BAS_PACKAGE_DETAILS pd2
      ON sm.organizationId = pd2.organizationId
      AND sm.customerId = pd2.customerId
      AND sm.packId = pd2.packId
      AND pd2.packUom = 'EA'
    LEFT JOIN BSM_CODE_ML lc
      ON lc.organizationId = zib.organizationId
      AND zib.locationCategory = lc.codeid
      AND lc.codeType = 'LOC_CAT'
      AND lc.languageId = 'en'
    LEFT JOIN BSM_CODE_ML lc1
      ON lc1.organizationId = la.organizationId
      AND la.lotAtt07 = lc1.codeid
      AND lc1.codeType = 'PLT_TYP'
      AND lc1.languageId = 'en'
    LEFT JOIN BSM_CODE_ML lc2
      ON lc2.organizationId = la.organizationId
      AND la.lotAtt08 = lc2.codeid
      AND lc2.codeType = 'DMG_FLG'
      AND lc2.languageId = 'en'
  WHERE zib.organizationId = IN_organizationId
  AND zib.warehouseId = IN_warehouseId
  AND zib.customerId = IN_CustomerId
  AND qtyonHand > 0
  AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATIONCBT02', 'SORTATIONCBT03', 'SORTATION', 'SORTATIONMRD02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA', 'B04A065', 'B04A066', 'B04B065', 'B04B065')
  AND zib.sku NOT IN (SELECT
      sku
    FROM BAS_SKU bs2
    WHERE organizationId = IN_organizationId
    AND customerId = 'LTL'
    AND sku LIKE '13%'
    UNION ALL
    SELECT
      sku
    FROM BAS_SKU bs2
    WHERE organizationid = IN_organizationId
    AND customerid = 'SMARTSBY'
    AND sku = 'PALLET'
    UNION ALL
    SELECT
      sku
    FROM BAS_SKU
    WHERE organizationid = IN_organizationId
    AND customerid IN ('ECMAMA', 'ECMAMAB2C')
    AND sku LIKE '%TEST%'
    UNION ALL
    SELECT
      sku
    FROM BAS_SKU
    WHERE organizationid = IN_organizationId
    AND customerid IN ('MAP')
    AND sku IN ('DEMO TABLE AT', 'DEMO TABLE SAM', 'HOT STAMP'))
  AND DATE(zib.StockDate) > '2024-09-30'
  AND DATE(zib.StockDate) < '2024-11-01'
  ORDER BY StockDate DESC,
  zib.customerId;

  OPEN cur;

-- Determine output file name
-- SET output_file = CONCAT('/tmp/inventory_data_', DATE_FORMAT(NOW(), '%Y%m%d%H%i%s'), '.txt');

-- Create and open the output file
--     SELECT INTO OUTFILE output_file
--         FIELDS TERMINATED BY ',' ENCLOSED BY '"' LINES TERMINATED BY '\n'
--         'stockDate,warehouseId,tariffMasterId,tariffId,customerId,locationId,locationCategory,locationCategoryDescr,traceId,skugroup1,muid,lotNum,packId,UOM,sku,skuDesc,poNum,typePallet,qtyonHand,qtyPerPallet,cbmsku,qtycbm,chamber,putawayRule,batchNo,Expiredate,WHdate,Area,ExternalPo,Whether_damaged,Pallet_Used,NETWEIGHT';

read_loop:
  LOOP
    FETCH cur INTO out_stockDate, out_warehouseId, out_tariffMasterId, out_tariffId, out_customerId, out_locationId, out_locationCategory, out_locationCategoryDescr, out_traceId, out_skugroup1, out_muid, out_lotNum, out_packId, out_UOM, out_sku, out_skuDesc, out_poNum, out_typePallet, out_qtyonHand, out_qtyPerPallet, out_cbmsku, out_qtycbm, out_chamber, out_putawayRule, out_batchNo, out_Expiredate, out_WHdate, out_Area, out_ExternalPo, out_Whether_damaged, out_Pallet_Used, out_NETWEIGHT;
    IF done THEN
      LEAVE read_loop;
    END IF;

  -- Write data to the output file
  END LOOP;

  CLOSE cur;

END
$$

--
-- Create procedure `GenerateJSON`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE GenerateJSON ()
BEGIN
  DECLARE done int DEFAULT FALSE;
  DECLARE json_object text;
  DECLARE json_array text DEFAULT '[';
  DECLARE first_record boolean DEFAULT TRUE;

  DECLARE cur CURSOR FOR
  SELECT
    JSON_OBJECT('TABLE_NAME', t.TABLE_NAME,
    'COLUMN_NAME', c.COLUMN_NAME,
    'DATA_TYPE', c.DATA_TYPE,
    'IS_UNIQUE', MAX(IF(c.COLUMN_KEY = 'UNI', 'UNIQUE', '')),
    'IS_PRIMARY_KEY', MAX(IF(c.COLUMN_KEY = 'PRI', 'PRIMARY KEY', '')),
    'CONSTRAINTS', GROUP_CONCAT(DISTINCT kcu.CONSTRAINT_NAME),
    'REFERENCED_TABLES', GROUP_CONCAT(DISTINCT kcu.REFERENCED_TABLE_NAME),
    'REFERENCED_COLUMNS', GROUP_CONCAT(DISTINCT kcu.REFERENCED_COLUMN_NAME),
    'COLUMN_DEFAULT', c.COLUMN_DEFAULT,
    'IS_NULLABLE', c.IS_NULLABLE,
    'CHARACTER_MAXIMUM_LENGTH', c.CHARACTER_MAXIMUM_LENGTH,
    'UPDATE_RULE', rc.UPDATE_RULE)
  FROM INFORMATION_SCHEMA.TABLES t
    JOIN INFORMATION_SCHEMA.COLUMNS c
      ON t.TABLE_SCHEMA = c.TABLE_SCHEMA
      AND t.TABLE_NAME = c.TABLE_NAME
    LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE kcu
      ON t.TABLE_SCHEMA = kcu.TABLE_SCHEMA
      AND t.TABLE_NAME = kcu.TABLE_NAME
      AND c.COLUMN_NAME = kcu.COLUMN_NAME
    LEFT JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS rc
      ON rc.CONSTRAINT_SCHEMA = kcu.CONSTRAINT_SCHEMA
      AND rc.CONSTRAINT_NAME = kcu.CONSTRAINT_NAME
  WHERE t.TABLE_SCHEMA = 'wms_cml'  -- replace 'test' with your database name
  GROUP BY t.TABLE_NAME,
           c.COLUMN_NAME,
           c.DATA_TYPE,
           c.COLUMN_DEFAULT,
           c.IS_NULLABLE,
           c.CHARACTER_MAXIMUM_LENGTH,
           rc.UPDATE_RULE;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  OPEN cur;

read_loop:
  LOOP
    FETCH cur INTO json_object;
    IF done THEN
      LEAVE read_loop;
    END IF;

    IF NOT first_record THEN
      SET json_array = CONCAT(json_array, ',');
    ELSE
      SET first_record = FALSE;
    END IF;

    SET json_array = CONCAT(json_array, json_object);
  END LOOP;

  CLOSE cur;

  SET json_array = CONCAT(json_array, ']');

  SELECT
    json_array AS result;
END
$$

--
-- Create procedure `FLUX_SPUDF_Process5`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPUDF_Process5 (IN IN_orgid varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
IN IN_operator varchar(40),
IN IN_docNo varchar(40),
OUT OUT_returnCode varchar(1000),
OUT OUT_returnMessage varchar(1000))
BEGIN
  IF
    IN_operator = 'ASN' THEN
    UPDATE DOC_ASN_HEADER h
    SET h.noteText = '????'
    WHERE h.asnNo = IN_docNo
    AND h.warehouseid = IN_warehouseId
    AND h.organizationId = IN_orgid;


  END IF;

  SET OUT_returnCode := '400';
  SET OUT_returnMessage := '999#11111111111%32133';
END
$$

--
-- Create procedure `FLUX_SPUDF_Process4`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPUDF_Process4 (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_customerId varchar(30),
IN IN_supplierId varchar(30),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_sku varchar(50),
OUT OUT_qty varchar(50),
OUT OUT_orderNo varchar(50),
OUT OUT_orderLineNo varchar(50),
OUT OUT_lotAtt12 varchar(50),
OUT OUT_lotAtt24 varchar(50),
OUT OUT_serialNo varchar(50),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_str varchar(4000);
  SET OUT_sku := IN_barcode;
  SET OUT_returnCode := '000';
  IF IN_operation = 'SCANRCV' THEN
    SET OUT_sku := LEFT(IN_Barcode, LENGTH(IN_Barcode) - 4);
    SET OUT_serialNo := IN_Barcode;
    SET OUT_lotAtt12 := '12';
    SET OUT_lotAtt24 := '24';
    SET OUT_returnCode := '000';
  END IF;
  IF IN_operation = 'CHK' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SET OUT_serialNo := SUBSTRING_INDEX (IN_Barcode, '%', -1);
    SET OUT_returnCode := '000';
  END IF;
  IF IN_operation = 'MIX_PO_SCANRCV' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SET OUT_serialNo := SUBSTRING_INDEX (IN_Barcode, '%', -1);
    SET OUT_orderNo := 'PO20180623000001';
    SET OUT_orderLineNo := '1';
    SET OUT_returnCode := '000';
  END IF;
  IF IN_operation = 'MIX_ASN_SCANRCV' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SET OUT_serialNo := SUBSTRING_INDEX (IN_Barcode, '%', -1);
    SELECT
      a.ASNNO,
      a.ASNLINENO
    FROM DOC_ASN_DETAILS a
    WHERE 1 = 1
    AND a.LINESTATUS <= '30'
    AND a.sku = OUT_sku
    AND a.organizationId = IN_organizationId
    AND a.warehouseId = IN_warehouseId
    LIMIT 0, 1 INTO OUT_orderNo, OUT_orderLineNo;
  END IF;

  IF IN_operation = 'ASNGROUP_SCANRCV' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SELECT DISTINCT
      a.ASNNO,
      a.ASNLINENO
    FROM DOC_ASN_DETAILS a
      INNER JOIN DOC_ASNGROUP_DETAILS b
        ON b.organizationId = a.organizationId
        AND b.warehouseId = a.warehouseId
        AND b.asnNo = a.asnNo
    WHERE 1 = 1
    AND a.LINESTATUS <= '30'
    AND a.sku = OUT_sku
    AND a.organizationId = IN_organizationId
    AND a.warehouseId = IN_warehouseId
    AND b.asnGroupNo = IN_para1
    LIMIT 0, 1 INTO OUT_orderNo, OUT_orderLineNo;
    SET OUT_returnCode := '000';
  END IF;
  IF IN_barcode = '1000' THEN
    SET OUT_returnCode := '999#SKU??????!';

  END IF;
  IF IN_barcode = '001' THEN
    SET OUT_sku := 'P-0040';
    SET OUT_returnCode := '000';

  END IF;
  IF IN_barcode = '002' THEN
    SET OUT_sku := 'COKE';
    SET OUT_returnCode := '000';

  END IF;
  IF IN_barcode = '908' THEN
    SET OUT_sku := 'WANYAO005';
    SET OUT_returnCode := '000';
  END IF;
END
$$

--
-- Create procedure `FLUX_SPUDF_Process3`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPUDF_Process3 (IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    UPDATE BSM_USER
    SET udf01 = '??process2'
    WHERE userId = 'WANGLT'
    AND organizationId = 'FLUX';

    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_SPUDF_IMPORT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPUDF_IMPORT (IN IN_tableName varchar(50),
IN IN_fileds varchar(3000),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));

      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;


    SET @SQL = CONCAT('drop table if exists ', IN_tableName);
    PREPARE STMT FROM @SQL;
    EXECUTE STMT;
    DEALLOCATE PREPARE STMT;


    SET @SQL = CONCAT('create table ', IN_tableName, '(');
    SET @i = LENGTH(IN_fileds) - LENGTH(REPLACE(IN_fileds, ',', ''));
    SET @left_str = IN_fileds;
    WHILE @i > 0
    DO
      SET @sub_str = SUBSTR(@left_str, 1, INSTR(@left_str, ',') - 1);
      SET @left_str = SUBSTR(@left_str, LENGTH(@sub_str) + LENGTH(',') + 1);
      SET @s = TRIM(@sub_str);
      SET @SQL = CONCAT(@SQL, @s, ' varchar(2000),');
      SET @i = @i - 1;
    END WHILE;
    SET @s = TRIM(@left_str);
    SET @SQL = CONCAT(@SQL, @s, ' varchar(2000))');

    PREPARE STMT FROM @SQL;
    EXECUTE STMT;
    DEALLOCATE PREPARE STMT;

    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_SPCOM_TraceIdBarcodeAnalyzer`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_TraceIdBarcodeAnalyzer (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_barcode varchar(100),
IN IN_customerId varchar(100),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_traceId varchar(50),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE V_A varchar(50);
  DECLARE V_NO varchar(50);
  DECLARE V_NO2 varchar(50);
  SET OUT_traceId := IN_barcode;
  SET OUT_returnCode := '000';

  IF IN_operation = 'CHK_TOID'
    AND IN_warehouseId = 'DHS_SZ02' THEN


    IF IN_barcode < '5' THEN
      SET V_NO2 := CONCAT(IN_barcode, IN_para2);
      SET OUT_traceId := V_NO2;
    ELSE
      SET OUT_traceId := REPLACE(IN_barcode, '#0', '');
    END IF;


    SET OUT_traceId := OUT_traceId;
    SET OUT_returnCode := '000';
  END IF;
  IF IN_barcode = '1000' THEN
    SET OUT_traceId := '180609002946';
    SET OUT_returnCode := '999#??';

  END IF;
END
$$

--
-- Create procedure `FLUX_SPCOM_Template`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_Template (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_docNo varchar(50),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);

    DECLARE cur_Rec CURSOR FOR
    SELECT
      1 AS COL
    FROM DOC_ORDER_HEADER A
    WHERE 1 = 2;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));

      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;

    SET v_errormessage = '0.Begin call sp FLUX_SPCOM_Template.';

    IF 1 = 1 THEN
      SET v_errormessage = 'test';
    ELSEIF 1 = 2 THEN
      SET v_errormessage = 'test';
    ELSE
      SET v_errormessage = 'test';
    END IF;



    SET v_errormessage = '1.Loop Doing somethings.';

  ENDLOOP1:
    WHILE 1 = 2 DO
      IF 1 > 0 THEN
        LEAVE ENDLOOP1;
      END IF;
    END WHILE;

    SET v_errormessage = '2.Open $ Fetch Cursor Doing somethings.';

    SET v_error = 1;
    OPEN cur_Rec;
    FETCH cur_Rec INTO v_nrow;
    WHILE v_error <> 0 DO
      FETCH cur_Rec INTO v_nrow;

    END WHILE;
    CLOSE cur_Rec;

    UPDATE BSM_SQL_LOG
    SET ADDWHO = 'TEST'
    WHERE 1 = 2;
    SET v_nrow = ROW_COUNT();

    IF v_NO_COMMIT = 'Y' THEN
      COMMIT;
    END IF;

    CALL FLUX_SPSYS_GetListByString('1,2,3', ',', 'XXXX');
    SELECT
      COUNT(1)
    FROM TMP_CODE
    WHERE CODEID = 'XXXX' INTO v_nrow;
    SELECT
      v_nrow AS aa;

    SET v_errormessage = 'n.End call sp FLUX_SPCOM_Template.';
    SET OUT_docNo = IN_barcode;
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_SPCOM_TaskIdBarcodeAnalyzer`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_TaskIdBarcodeAnalyzer (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_traceId varchar(90),
IN IN_barcode varchar(90),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_taskId varchar(50),
OUT OUT_taskIdSequence varchar(50),
OUT OUT_returnCode varchar(1000))
BEGIN
  SET OUT_returnCode := "000";
  SET OUT_taskIdSequence := '1';
  SET OUT_taskId := IN_traceId;
END
$$

--
-- Create procedure `FLUX_SPCOM_SkuBarcodeAnalyzer`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_SkuBarcodeAnalyzer (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_customerId varchar(30),
IN IN_supplierId varchar(30),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_SKU varchar(50),
OUT OUT_returnCode varchar(1000))
TRACELEAVE:
  BEGIN
    DECLARE v_str varchar(4000);
    DECLARE R_ASNNO varchar(4000);
    DECLARE R_SKU varchar(100);
    DECLARE R_LINENO int;
    DECLARE v_i int;
    SET OUT_returnCode := '000';
    IF IN_operation = 'UDF_RCV' THEN
      SELECT
        SPLIT_STR(IN_barcode, '*', 2) INTO R_LINENO;
      IF R_LINENO IS NULL THEN
        SET OUT_returnCode := '999#????';
        LEAVE TRACELEAVE;
      END IF;

    END IF;
    IF IN_barcode = '1011' THEN
      SET OUT_sku := IN_barcode;
      SET OUT_returnCode := '999#sku????,????????!';
    END IF;
    IF IN_barcode = '1' THEN
      SET OUT_sku := '999';
      SET OUT_returnCode := '000';
    END IF;
    IF IN_barcode = '908' THEN
      SET OUT_sku := 'WANYAO001';
      SET OUT_returnCode := '000';
    END IF;
    IF IN_barcode = '909' THEN
      SET OUT_sku := 'WNAYAO099';
      SET OUT_returnCode := '000';
    END IF;
    IF IN_barcode = '111' THEN
      SET OUT_sku := 'GuoZY';


      SET OUT_returnCode := '000test';
    END IF;
    IF IN_operation = 'CHK' THEN
      SET OUT_sku := get_udfa_parameter(IN_Barcode, '%', 1);
    END IF;
    IF IN_operation = 'SCANRCV' THEN
      SET OUT_sku := get_udfa_parameter(IN_Barcode, '%', 1);
    END IF;
    IF IN_operation = 'CHK' THEN
      SELECT
        COUNT(*)
      FROM DOC_ASN_SERIALNO
      WHERE SERIALNO = IN_barcode
      AND stockFlag = 'Y'
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId INTO v_i;
      IF v_i = 0 THEN


        LEAVE TRACELEAVE;
      END IF;
    END IF;
  END
  $$

--
-- Create procedure `FLUX_SPCOM_RecipientCheck`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_RecipientCheck (IN IN_bizOrgId varchar(20),
IN IN_bizWarehouseId varchar(20),
IN IN_asnNo varchar(90),
IN IN_asnLineNo varchar(30),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE V_lotAtt10 varchar(20);

  SET OUT_returnCode := '000';

  SET V_lotAtt10 = (SELECT
      A.lotAtt10
    FROM INV_LOT_ATT A
    WHERE A.organizationId = IN_bizOrgId
    AND A.LOTNUM = IN_Return_LotNum LIMIT 0, 1);

  IF V_lotAtt10 IS NULL THEN

    UPDATE INV_LOT_ATT
    SET lotAtt10 = IN_Return_LotNum
    WHERE organizationId = IN_bizOrgId
    AND LOTNUM = IN_Return_LotNum;
  END IF;



  UPDATE DOC_ASN_HEADER
  SET noteText = '??'
  WHERE 1 = 1
  AND asnNo = 'ASN201810240002';

  SET OUT_returnCode := '000';

END
$$

--
-- Create procedure `FLUX_SPCOM_DocNoBarcodeAnalyzer`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_DocNoBarcodeAnalyzer (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_docNo varchar(50),
OUT OUT_returnCode varchar(1000))
BEGIN

  SET OUT_returnCode := "000";


  IF IN_barcode = '1000' THEN
    SET OUT_returnCode := '999#SKU??????,??1?test100!';
  END IF;

  SET OUT_docNo := IN_barcode;

  IF IN_warehouseId = 'FLUXWH01'
    AND IN_operation = 'PUT_TO_ORDER' THEN
    SELECT
      orderNo
    FROM DOC_ORDER_HEADER
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND soReference5 = IN_barcode LIMIT 1 INTO OUT_docNo;

    SET OUT_returnCode := "000";
  END IF;
  IF IN_barcode = '201805191314' THEN
    SELECT
      orderNo
    FROM DOC_ORDER_HEADER
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND soReference1 = IN_barcode LIMIT 1 INTO OUT_docNo;
    SET OUT_returnCode := "999#TEST1,??SP??????";
  END IF;

END
$$

--
-- Create procedure `FLUX_SPCOM_DocNo`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_DocNo (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_docNo varchar(50),
OUT OUT_returnCode varchar(1000))
BEGIN
  SET OUT_returnCode := "000";
  SET OUT_docNo := IN_barcode;
  IF IN_warehouseId = 'WH_AUTOMATIC'
    AND IN_operation = 'PUT_TO_ORDER' THEN
    SELECT
      orderNo
    FROM DOC_ORDER_HEADER
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND soReference5 = IN_barcode LIMIT 1 INTO OUT_docNo;

    SET OUT_returnCode := "000";
  END IF;
  IF IN_barcode = '201805191314' THEN
    SELECT
      orderNo
    FROM DOC_ORDER_HEADER
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND soReference1 = IN_barcode LIMIT 1 INTO OUT_docNo;
    SET OUT_returnCode := "999#????";
  END IF;

END
$$

--
-- Create procedure `FLUX_SPCOM_DELETE_WH`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_DELETE_WH (IN IN_organizationId varchar(20),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE v_table varchar(50);
    DECLARE v_WH varchar(50);
    DECLARE cur_WH CURSOR FOR
    SELECT
      WH
    FROM TMP_WH
    ORDER BY WH;

    DECLARE cur_tabs CURSOR FOR
    SELECT
      a.`TABLE_NAME`
    FROM information_schema.`COLUMNS` a
    WHERE a.`TABLE_SCHEMA` = 'wms_cml'
    AND a.`COLUMN_NAME` = 'warehouseId';

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));

      SELECT
        v_errormessage AS error;
    END;

    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;
    CREATE TEMPORARY TABLE IF NOT EXISTS TMP_WH (
      WH varchar(20)
    );
    DELETE
      FROM TMP_WH;

    INSERT INTO TMP_WH (WH)
      VALUES ('TESTWH01');


    OPEN cur_WH;
    SET v_error = 1;
    FETCH cur_WH INTO v_wh;
    WHILE v_error <> 0 DO
      OPEN cur_tabs;
      SET v_error = 1;
      FETCH cur_tabs INTO v_table;
      WHILE v_error <> 0 DO
        SET @nrow = 0;
        SET @SQL = CONCAT('SELECT 1 INTO @nrow from ', v_table, ' where organizationId = ''TESTORG01'' and warehouseId = ''', v_wh, ''' limit 1 ');
        PREPARE STMT FROM @SQL;
        EXECUTE STMT;
        DEALLOCATE PREPARE STMT;
        WHILE @nrow > 0 DO
          START TRANSACTION;
            SET @SQL = CONCAT('delete from ', v_table, ' where organizationId = ''TESTORG01'' and warehouseId = ''', v_wh, ''' limit 2000 ');
            PREPARE STMT FROM @SQL;
            EXECUTE STMT;
            SET @nrow = ROW_COUNT();
            DEALLOCATE PREPARE STMT;
          COMMIT;
        END WHILE;
        SET v_error = 1;
        FETCH cur_tabs INTO v_table;
      END WHILE;
      CLOSE cur_tabs;
      SET v_error = 1;
      FETCH cur_WH INTO v_wh;
    END WHILE;
    CLOSE cur_WH;
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_SPCOM_ASN_RCV`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_ASN_RCV (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_asnNo varchar(90),
IN IN_customerId varchar(100),
IN IN_sku varchar(40),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
BEGIN
  SET OUT_returnCode := '000';

  SELECT
    sku = IN_sku
  FROM DOC_ASN_DETAILS
  WHERE organizationId = IN_organizationId
  AND warehouseId = IN_warehouseId
  AND asnNo = IN_asnNo;


  IF IN_sku = 'Z01' THEN
    SET OUT_returnCode := 'Z002';

  END IF;

END
$$

--
-- Create procedure `FLUX_SPCOM_ASNCLOSETEST`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPCOM_ASNCLOSETEST (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_asnNo varchar(30),
IN IN_operation varchar(90),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT IN_Parameter varchar(1000),
OUT OUT_returnCode varchar(1000))
ENDPRO:
  BEGIN

    DECLARE v_error int;
    DECLARE v_NO_COMMIT char(1);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
    END;

    SET v_error = 1;


    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;
    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;










    SELECT
      OUT_returnCode;



    SET OUT_returnCode = '999????1';








  END
  $$

--
-- Create procedure `FLUX_SPBCD_TraceId`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPBCD_TraceId (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_barcode varchar(100),
IN IN_customerId varchar(30),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_TraceId varchar(50),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_TraceId,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';
    SET OUT_traceId := IN_barcode;

  END
  $$

--
-- Create procedure `FLUX_SPBCD_TaskId`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPBCD_TaskId (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_traceId varchar(90),
IN IN_barcode varchar(90),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_taskId varchar(50),
INOUT OUT_taskIdSequence varchar(50),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_TaskId,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_SPBCD_SN`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPBCD_SN (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_customerId varchar(30),
IN IN_supplierId varchar(30),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
INOUT OUT_SerialNo varchar(50),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_SN,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_SPBCD_Sku_TEST001`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPBCD_Sku_TEST001 (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_customerId varchar(30),
IN IN_supplierId varchar(30),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_sku varchar(50),
OUT OUT_qty varchar(50),
OUT OUT_orderNo varchar(50),
OUT OUT_orderLineNo varchar(50),
OUT OUT_serialNo varchar(50),
OUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_str varchar(4000);
  SET OUT_returnCode := '000';
  IF IN_barcode = '1011' THEN
    SET OUT_returnCode := '999#SKU??????!';
  END IF;
  IF IN_operation = 'CHK' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
  END IF;
  IF IN_operation = 'SCANRCV' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
  END IF;

  IF IN_operation = 'MIX_PO_SCANRCV' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SET OUT_serialNo := SUBSTRING_INDEX (IN_Barcode, '%', -1);
    SELECT
      a.poNo,
      a.poLineNo
    FROM DOC_PO_DETAILS a
    WHERE 1 = 1
    AND a.poLineStatus <= '30'
    AND a.sku = OUT_sku
    AND a.customerId = IN_customerId
    AND a.organizationId = IN_organizationId
    AND a.warehouseId = IN_warehouseId
    LIMIT 0, 1 INTO OUT_orderNo, OUT_orderLineNo;
    SET OUT_returnCode := '000';
  END IF;

  IF IN_operation = 'MIX_ASN_SCANRCV' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SET OUT_serialNo := SUBSTRING_INDEX (IN_Barcode, '%', -1);
    SELECT
      a.ASNNO,
      a.ASNLINENO
    FROM DOC_ASN_DETAILS a
      INNER JOIN DOC_ASN_HEADER b
        ON b.asnNo = a.asnNo
        AND a.organizationId = b.organizationId
        AND a.warehouseId = b.warehouseId
    WHERE 1 = 1
    AND a.LINESTATUS <= '30'
    AND a.sku = OUT_sku
    AND a.organizationId = IN_organizationId
    AND a.warehouseId = IN_warehouseId
    AND a.lineStatus <> '10'
    LIMIT 0, 1 INTO OUT_orderNo, OUT_orderLineNo;
    SET OUT_returnCode := '000';
  END IF;

  IF IN_operation = 'SCANRCV' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SET OUT_serialNo := SUBSTRING_INDEX (IN_Barcode, '%', -1);
    SET OUT_orderNo := '';
    SET OUT_orderLineNo := '';
    SET OUT_returnCode := '000';
  END IF;
  IF IN_operation = 'CHK' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SET OUT_serialNo := SUBSTRING_INDEX (IN_Barcode, '%', -1);
    SET OUT_orderNo := '';
    SET OUT_orderLineNo := '';
    SET OUT_returnCode := '000';

  END IF;

  IF IN_operation = 'ASNGROUP_SCANRCV' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SELECT DISTINCT
      a.ASNNO,
      a.ASNLINENO
    FROM DOC_ASN_DETAILS a
      INNER JOIN DOC_ASNGROUP_DETAILS b
        ON b.organizationId = a.organizationId
        AND b.warehouseId = a.warehouseId
        AND b.asnNo = a.asnNo
    WHERE 1 = 1
    AND a.LINESTATUS <= '30'
    AND a.sku = OUT_sku
    AND a.organizationId = IN_organizationId
    AND a.warehouseId = IN_warehouseId
    AND b.asnGroupNo = IN_para1
    LIMIT 0, 1 INTO OUT_orderNo, OUT_orderLineNo;
    SET OUT_returnCode := '000';
  END IF;

  IF IN_operation = 'INVSCAN' THEN
    SET OUT_sku := SUBSTRING_INDEX (IN_Barcode, '%', 1);
    SET OUT_serialNo := SUBSTRING_INDEX (IN_Barcode, '%', -1);
    SET OUT_orderNo := '';
    SET OUT_orderLineNo := '';
    SET OUT_returnCode := '000';
  END IF;
END
$$

--
-- Create procedure `FLUX_SPBCD_Sku`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPBCD_Sku (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_para1 varchar(90),
IN IN_para2 varchar(90),
IN IN_customerId varchar(30),
IN IN_supplierId varchar(30),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_SKU varchar(50),


OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SELECT
        A.SKU INTO OUT_sku
      FROM BAS_SKU A
      WHERE A.organizationId = IN_organizationId
      AND A.CUSTOMERID = IN_customerId
      AND (A.ALTERNATE_SKU1 = IN_barcode
      OR A.SKU = IN_barcode)
      LIMIT 1;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_Sku,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_returnCode = '000';








  END
  $$

--
-- Create procedure `FLUX_SPBCD_DocNo`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_SPBCD_DocNo (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_operation varchar(90),
IN IN_barcode varchar(100),
IN IN_language varchar(20),
IN IN_userId varchar(40),
OUT OUT_docNo varchar(50),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#FLUX_SPBCD_DocNo,', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        v_errormessage AS error;
    END;
    SET v_error = 1;

    IF OUT_returnCode = 'NO_COMMIT'
      OR OUT_returnCode = '*_*' THEN
      SET v_NO_COMMIT = 'N';
    ELSE
      SET v_NO_COMMIT = 'Y';
    END IF;

    IF v_NO_COMMIT = 'Y' THEN
      START TRANSACTION;
    END IF;
    SET v_errormessage = '0.Begin';

    SET v_errormessage = 'n.End ';
    SET OUT_docNo = IN_barcode;
    SET OUT_returnCode = '000';

  END
  $$

--
-- Create procedure `FLUX_ALERT_INTERFACE_ERR`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE FLUX_ALERT_INTERFACE_ERR (IN IN_bizOrgId varchar(20),
IN IN_bizWarehouseId varchar(20),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_emailAddress text;
    DECLARE v_addtime timestamp;
    DECLARE v_minAddTime timestamp;
    DECLARE v_datahubCustomerId varchar(100);
    DECLARE v_messageGroupSysId varchar(50);
    DECLARE v_headerLineNo int;
    DECLARE v_messageId varchar(50);
    DECLARE v_keyValue1 varchar(50);
    DECLARE v_keyValue2 varchar(50);
    DECLARE v_keyValue4 varchar(50);
    DECLARE v_keyValue5 varchar(50);
    DECLARE v_MessageCreatetime varchar(50);
    DECLARE v_MessageErrorcode varchar(50);
    DECLARE v_MessageErrorDescr varchar(500);
    DECLARE v_warehouse varchar(50);
    DECLARE v_count int;

    DECLARE v_error int;
    DECLARE v_nrow int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);

    DECLARE c_monitor_info_cursor CURSOR FOR
    SELECT
      A.messageGroupSysId,
      A.headerLineNo,
      IFNULL(A.customerId, ''),
      A.messageId,
      DATE_FORMAT(A.MessageCreatetime, '%Y-%m-%d %H:%i:%s') AS MessageCreatetime,
      A.MessageErrorcode,
      A.MessageErrorDescr,
      A.warehouseId,
      IFNULL(A.keyValue1, ''),
      IFNULL(A.keyValue2, ''),
      IFNULL(A.keyValue4, ''),
      IFNULL(A.keyValue5, '')
    FROM TC_MESSAGE_MONITOR_INFO A
      LEFT JOIN TM_BAS_CUSTOMER B
        ON B.ORGANIZATIONID = A.ORGANIZATIONID
        AND B.DATAHUBCUSTOMERID = A.DATAHUBCUSTOMERID
      LEFT JOIN TM_MESSAGELIST_CUSTOMER C
        ON C.ORGANIZATIONID = A.ORGANIZATIONID
        AND C.DATAHUBCUSTOMERID = A.DATAHUBCUSTOMERID
        AND C.MESSAGEID = A.MESSAGEID
    WHERE A.ORGANIZATIONID = IN_bizOrgId
    AND Alertflag = 'N'
    AND A.Addtime > DATE_ADD(NOW(), INTERVAL -10 DAY)
    AND A.messageId NOT IN ('SOTS', 'SOCBM', 'TRCF')
    AND IFNULL(A.messageErrorcode, '') <> '0000'
    LIMIT 1, 2000;    -- add BY luhui 20191130
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#', IFNULL(@p1, ''), ',', IFNULL(@p2, ''), ',', IFNULL(@p3, ''), ',', IFNULL(@p4, ''), ',', IFNULL(@p5, ''));
      SELECT
        OUT_returnCode AS error;
    END;

    -- Retrieve records 5 minutes ago 
    SET v_addtime = DATE_ADD(NOW(), INTERVAL -1 DAY);
    SELECT
      recipientsList
    FROM BSM_EMAIL_TEMPLATE
    WHERE ORGANIZATIONID = IN_bizOrgId
    AND templateid = 'INTERFACE_ERROR' /* Get only the first message set at a time */
    INTO v_emailAddress;

    --   SET v_datahubCustomerId = '';
    --   SELECT datahubCustomerId
    --     FROM TC_MESSAGE_MONITOR_INFO
    --    WHERE ORGANIZATIONID = IN_bizOrgId
    --      AND alertflag = 'N'
    --    /*  AND ADDTIME = v_minAddTime */
    --    LIMIT 1 INTO v_datahubCustomerId;
    OPEN c_monitor_info_cursor;
    SET v_error = 1;
    FETCH c_monitor_info_cursor
    INTO v_messageGroupSysId, v_headerLineNo, v_datahubCustomerId, v_messageId,
    v_MessageCreatetime, v_MessageErrorcode, v_MessageErrorDescr, v_warehouse,
    v_KeyValue1, v_KeyValue2, v_KeyValue4, v_KeyValue5;
    WHILE v_error = 1 DO
      SELECT
        COUNT(1)
      FROM SYS_ALERT_LOG
      WHERE organizationId = IN_bizOrgId
      AND warehouseId = IN_bizWarehouseId
      AND alertMessageId = CONCAT(v_messageGroupSysId, '-', v_headerLineNo)
      AND alertId = 'INTERFACE_ERROR' INTO v_count;

      IF v_count > 0 THEN
        UPDATE TC_MESSAGE_MONITOR_INFO
        SET Alertflag = 'Y'
        WHERE ORGANIZATIONID = IN_bizOrgId
        AND messageGroupSysid = v_messageGroupSysId
        AND headerLineNo = v_headerLineNo;
      ELSE
        IF (v_messageId = 'CUSTOMER'
          OR v_messageId = 'SO'
          OR v_messageId = 'PO') THEN
          INSERT INTO SYS_ALERT_LOG (organizationId,
          warehouseId,
          alertMessageId,
          alertId,
          alertDate,
          field01,
          field02,
          field03,
          field04,
          field05,
          field06,
          field07,
          field08,
          field11,
          alertAdress,
          alertAddress,
          subjectText,
          readFlag,
          messageLevel,
          sendAlertFlag)
            VALUES (IN_bizOrgId, IN_bizWarehouseId, CONCAT(v_messageGroupSysId, '-', v_headerLineNo), 'INTERFACE_ERROR', NOW(), v_datahubCustomerId, v_messageId, '', v_keyValue1, v_MessageCreatetime, v_MessageErrorcode, SUBSTRING(v_MessageErrorDescr, 1, 50), v_warehouse, v_messageGroupSysId, v_emailAddress, v_emailAddress, 'Interface abnormal alarm', 'N', 2, 'N');
        ELSE
          INSERT INTO SYS_ALERT_LOG (organizationId,
          warehouseId,
          alertMessageId,
          alertId,
          alertDate,
          field01,
          field02,
          field03,
          field04,
          field05,
          field06,
          field07,
          field08,
          field11,
          alertAdress,
          alertAddress,
          subjectText,
          readFlag,
          messageLevel,
          sendAlertFlag)
            VALUES (IN_bizOrgId, IN_bizWarehouseId, CONCAT(v_messageGroupSysId, '-', v_headerLineNo), 'INTERFACE_ERROR', NOW(), v_keyValue4, v_messageId, v_keyValue2, v_keyValue5, v_MessageCreatetime, v_MessageErrorcode, SUBSTRING(v_MessageErrorDescr, 1, 50), v_warehouse, v_messageGroupSysId, v_emailAddress, v_emailAddress, 'Interface Error Alert', 'N', 2, 'N');
        END IF;
        UPDATE TC_MESSAGE_MONITOR_INFO
        SET Alertflag = 'Y'
        WHERE ORGANIZATIONID = IN_bizOrgId
        AND messageGroupSysid = v_messageGroupSysId
        AND headerLineNo = v_headerLineNo;
      END IF;
      SET v_error = 1;
      FETCH c_monitor_info_cursor
      INTO v_messageGroupSysId, v_headerLineNo, v_datahubCustomerId, v_messageId,
      v_MessageCreatetime, v_MessageErrorcode, v_MessageErrorDescr, v_warehouse,
      v_KeyValue1, v_KeyValue2, v_KeyValue4, v_KeyValue5;
    END WHILE;
    CLOSE c_monitor_info_cursor;
    SET OUT_returnCode = '000';
    COMMIT;
  END
  $$

--
-- Create procedure `drop_procedure`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE drop_procedure (IN p_procedure_name varchar(255))
BEGIN
  IF p_procedure_name IN ('CML_COUNT_STORAGE_DAYS', 'CML_COUNT_RENT_PALLET_DAYS', 'CML_BILLSTORAGE_R_BILL_MODE') THEN
    SET @sql = CONCAT('DROP PROCEDURE IF EXISTS `wms_cml`.`', p_procedure_name, '`');
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    SELECT
      CONCAT('Procedure ', p_procedure_name, ' dropped successfully.') AS message;
  ELSE
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'You are not allowed to drop this specific procedure.';
  END IF;
END
$$

--
-- Create procedure `doWhile`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE doWhile ()
BEGIN
  DECLARE i int DEFAULT 3001;
  WHILE (i <= 500000) DO
    INSERT INTO `SYS_LABELMATRIX` (organizationId, sequenceNo, currentVersion)
      VALUES ('OJV_CML', i, '100');
    SET i = i + 1;
  END WHILE;
END
$$

--
-- Create procedure `CreateDailyEstimationStorageFlux`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CreateDailyEstimationStorageFlux (OUT txtmessage varchar(4000))
BEGIN
  DECLARE finished integer DEFAULT 0;
  DECLARE OutCUSTOMERID varchar(100) DEFAULT "";
  DECLARE OutCURRENT_FM_BILLINGDATE date DEFAULT NOW();
  DECLARE OutCURRENT_TO_BILLINGDATE date DEFAULT NOW();
  -- declare cursor for employee email
  DECLARE estimasteStorage CURSOR FOR
  SELECT
    bc.customerId,
    -- DATE_FORMAT(bth.billingDate,"%Y-%m-%d") AS FIRSTBILLINGDATE,
    DATE_ADD(DATE_FORMAT(CONCAT(YEAR(NOW()), '-', MONTH(NOW()), '-', CASE WHEN DAY(bth.billingDate) = 31 THEN 30 ELSE DAY(bth.billingDate) END), "%Y-%m-%d"), INTERVAL -1 MONTH) AS CURRENT_FM_BILLINGDATE,
    DATE_ADD(DATE_FORMAT(CONCAT(YEAR(NOW()), '-', MONTH(NOW()), '-', CASE WHEN DAY(bth.billingDate) = 31 THEN 30 ELSE DAY(bth.billingDate) END), "%Y-%m-%d"), INTERVAL -1 DAY) AS CURRENT_TO_BILLINGDATE
  --  DATE_FORMAT(bth.effectiveFrom,"%Y-%m-%d") AS EFECTIVE_FMDATE,
  --  DATE_FORMAT(bth.effectiveTo,"%Y-%m-%d") AS EFECTIVE_TODATE
  FROM BIL_TARIFF_MASTER btm
    INNER JOIN BAS_CUSTOMER bc
      ON bc.customerId = btm.customerId
      AND bc.organizationId = btm.organizationId
      AND bc.CustomerType = 'OW'
    INNER JOIN BIL_TARIFF_HEADER bth
      ON bth.organizationId = btm.organizationId
      AND bth.tariffMasterId = btm.tariffMasterId
    INNER JOIN BIL_TARIFF_DETAILS btd
      ON btd.organizationId = bth.organizationId
      AND btd.tariffId = bth.tariffId
    INNER JOIN BIL_TARIFF_RATE btr
      ON btr.organizationId = btd.organizationId
      AND btr.tariffId = btd.tariffId
      AND btr.tariffLineNo = btd.tariffLineNo
  WHERE bc.organizationId = 'OJV_CML'
  AND bc.customerType = 'OW'
  AND bc.activeFlag = 'Y'
  --  AND bc.customerId IN ('ITOCHU')   -- SELECT bc.customerId FROM BAS_CUSTOMER bc WHERE bc.activeFlag='Y' AND bc.customerType='OW')
  --  AND DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 7 HOUR)- interval 1 DAY,"%Y-%m-%d") between DATE_FORMAT(DATE(bth.effectiveFrom),"%Y-%m-%d") and DATE_FORMAT(DATE(bth.effectiveTo),"%Y-%m-%d")
  AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND btd.chargeCategory = 'IV'
  AND btd.chargeType = 'ST'
  AND btr.rate > 0
  GROUP BY bc.customerId,
           bth.billingDate,
           bth.effectiveFrom,
           bth.effectiveto;


  -- declare NOT FOUND handler
  DECLARE CONTINUE HANDLER
  FOR NOT FOUND SET finished = 1;

  OPEN estimasteStorage;

getEstimasi:
  LOOP
    FETCH estimasteStorage INTO OutCUSTOMERID, OutCURRENT_FM_BILLINGDATE, OutCURRENT_TO_BILLINGDATE;
    IF finished = 1 THEN
      LEAVE getEstimasi;
    END IF;
    -- build email list

    SELECT
      OutCUSTOMERID,
      DATE_FORMAT(OutCURRENT_FM_BILLINGDATE, "%Y-%m-%d"),
      DATE_FORMAT(OutCURRENT_TO_BILLINGDATE, "%Y-%m-%d");

    INSERT INTO wms_cml.bt_estimasi_storage (organtizationId
    , warehouseId
    , customerId
    , salesOffice
    , divisionNo
    , totalQty
    , rate
    , totalAmount
    , addDate
    , editTime
    , addWho)
      SELECT
        'OJV_CML' AS organtizationId,
        HT.warehouseId,
        HT.CustomerID,
        HT.salesoffice,
        HT.divisionNo,
        MAX(HT.qtyTrace) AS TotalPallet,
        HT.R_rate,
        (MAX(HT.qtyTrace)) * HT.R_rate AS TotalAmount,
        NOW() AS addDate,
        NOW() AS editTime,
        'TIMER' AS addWho
      FROM (SELECT
          zib.organizationId,
          zib.warehouseId,
          zib.StockDate,
          zib.customerId,
          COUNT(DISTINCT zib.locationId) qtyloc,
          COUNT(DISTINCT zib.traceId) AS qtyTrace,
          COUNT(DISTINCT zib.muid) qtyMuid,
          SUM(zib.totalCube) qtyCube,
          btr.tariffId AS R_TARIFFID,
          btd.ratebase AS R_ratebase,
          -- btr.ratePerUnit AS R_ratePerUnit,
          btr.rate AS R_rate,
          btd.minAmount AS R_minAmount,
          btd.maxAmount AS R_maxAmount,
          -- CASE WHEN btd.UDF03 = '' THEN '0' ELSE btd.UDF03 END R_minQty,
          -- btr.tariffClassNo AS R_TARIFFCLASSNO,
          -- btd.chargeCategory,
          --  btd.chargeType,
          -- CASE WHEN chargeType = 'ES' THEN IFNULL(btr.classfrom, 0) - 1 ELSE IFNULL(btr.classfrom, 0) END as R_CLASSFROM,
          -- IFNULL(btr.classTo, 0) AS R_CLASSTO,
          bw.udf02 AS salesoffice,
          btd.udf06 AS divisionNo,
          DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -DAY(bth.billingDate) DAY), "%Y-%m-%d") AS CURRENT_FIRST_BILLINGDATE,
          DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -DAY(bth.billingDate) DAY), "%Y-%m-%d") AS R_FMDATE,
          DATE_ADD(DATE_ADD(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -DAY(bth.billingDate) DAY), "%Y-%m-%d"), INTERVAL 1 MONTH), INTERVAL -1 DAY) AS R_TODATE
        FROM Z_InventoryBalance zib
          INNER JOIN INV_LOT_ATT ila
            ON ila.organizationId = zib.organizationId
            AND ila.lotNum = zib.LotNum
          INNER JOIN BAS_LOCATION bl
            ON bl.organizationId = zib.organizationId
            AND bl.warehouseId = zib.warehouseId
            AND bl.locationId = zib.locationId
          INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
            ON bsm.organizationId = zib.organizationId
            AND bsm.warehouseId = zib.warehouseId
            AND bsm.customerId = zib.customerId
            AND bsm.SKU = zib.sku
          INNER JOIN BAS_CUSTOMER bc
            ON bc.customerId = bsm.customerId
            AND bc.organizationId = bsm.organizationId
            AND bc.CustomerType = 'OW'
          INNER JOIN BSM_WAREHOUSE bw
            ON zib.organizationId = bw.organizationId
            AND zib.warehouseId = bw.warehouseId
          INNER JOIN BIL_TARIFF_HEADER bth
            ON bth.organizationId = bsm.organizationId
            AND bth.tariffMasterId = bsm.tariffMasterId
          INNER JOIN BIL_TARIFF_DETAILS btd
            ON btd.organizationId = bth.organizationId
            AND btd.tariffId = bth.tariffId
          INNER JOIN BIL_TARIFF_RATE btr
            ON btr.organizationId = btd.organizationId
            AND btr.tariffId = btd.tariffId
            AND btr.tariffLineNo = btd.tariffLineNo
        WHERE zib.organizationId = 'OJV_CML'
        -- AND zib.warehouseId = 'CBT01'
        AND DATE_FORMAT(zib.StockDate, "%Y-%m-%d") >= DATE_FORMAT(OutCURRENT_FM_BILLINGDATE, "%Y-%m-%d")
        AND DATE_FORMAT(zib.StockDate, "%Y-%m-%d") <= DATE_FORMAT(OutCURRENT_TO_BILLINGDATE, "%Y-%m-%d")
        AND zib.customerId IN (OutCUSTOMERID)
        AND (ila.lotAtt07 = 'R'
        OR 'ST' <> 'PL')
        AND DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 7 HOUR) - INTERVAL 1 DAY, "%Y-%m-%d") BETWEEN DATE_FORMAT(DATE(bth.effectiveFrom), "%Y-%m-%d") AND DATE_FORMAT(DATE(bth.effectiveTo), "%Y-%m-%d")
        AND btd.chargeCategory = 'IV'
        AND btd.chargeType = 'ST'
        AND btr.rate > 0
        GROUP BY zib.organizationId,
                 zib.warehouseId,
                 zib.StockDate,
                 zib.customerId,
                 btr.tariffId,
                 btd.ratebase,
                 btr.rate,
                 btd.minAmount,
                 btd.maxAmount,
                 btr.tariffClassNo,
                 btd.chargeCategory,
                 btd.chargeType,
                 bth.billingdate,
                 bw.udf02,
                 btd.udf06) HT
      GROUP BY HT.warehouseId,
               HT.CustomerID,
               HT.R_rate,
               HT.salesoffice,
               HT.divisionNo;


  END LOOP getEstimasi;
  CLOSE estimasteStorage;

END
$$

--
-- Create procedure `CML_VAS_CHG`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_VAS_CHG (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_CUSTOMERID varchar(100),
IN IN_VASNO varchar(100),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE R_DOCNO varchar(100);
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;

    UPDATE BIL_SUMMARY A
    LEFT JOIN BIL_TARIFF_DETAILS D
      ON A.ORGANIZATIONID = D.ORGANIZATIONID
      AND A.TARIFFID = D.TARIFFID
      AND D.CHARGECATEGORY = A.`chargeCategory`
      AND D.`chargeType` = A.`chargeType`
      AND D.RATEBASE = A.RATEBASE
    SET A.UDF01 = D.UDF01,
        A.UDF02 = D.UDF02,
        A.UDF04 = D.UDF06
    WHERE A.ORGANIZATIONID = 'OJV_CML'
    AND A.WAREHOUSEID = IN_warehouseId
    AND A.CUSTOMERID = IN_CUSTOMERID
    AND A.DOCNO = IN_VASNO;

    COMMIT;
    SET @countRow = ROW_COUNT();
    SELECT
      @countRow;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_VAL_ALERT_STOCKCOUNT`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_VAL_ALERT_STOCKCOUNT (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_No varchar(20),
IN IN_Input1 varchar(20),
IN IN_Input2 varchar(20),
IN IN_Input3 varchar(20),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE v_no varchar(10);
    DECLARE v_qtycounted decimal(18, 2);
    DECLARE errorMessage varchar(255);
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_REOPENLDL', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));

    END;



    IF IN_Input1 <> ''
      AND IN_userId NOT IN ('WM_ASUDJANA') THEN
    BEGIN
      SELECT
        IFNULL(zbcd.count01, 0) INTO v_qtycounted
      FROM Z_BAS_CYCLE_DETAILS zbcd
      WHERE zbcd.no = IN_No;
      IF v_qtycounted > 0.0 THEN
        SET errorMessage = CONCAT('ALERT: cannot edit qty already submit ! ');
        SET OUT_returnCode = errorMessage;
        LEAVE ENDPROC;
      ELSE
        SET OUT_returnCode = '000';
        LEAVE ENDPROC;
      END IF;
    END;
    ELSEIF IN_Input2 <> ''
      AND IN_userId NOT IN ('WM_ASUDJANA') THEN
    BEGIN
      SELECT
        IFNULL(zbcd.count02, 0) INTO v_qtycounted
      FROM Z_BAS_CYCLE_DETAILS zbcd
      WHERE zbcd.no = IN_No;
      IF v_qtycounted > 0.0 THEN
        SET errorMessage = CONCAT('ALERT: cannot edit qty already submit ! ');
        SET OUT_returnCode = errorMessage;
        LEAVE ENDPROC;
      ELSE
        SET OUT_returnCode = '000';
        LEAVE ENDPROC;
      END IF;
    END;
    ELSEIF IN_Input3 <> ''
      AND IN_userId NOT IN ('WM_ASUDJANA') THEN
    BEGIN
      SELECT
        IFNULL(zbcd.count03, 0) INTO v_qtycounted
      FROM Z_BAS_CYCLE_DETAILS zbcd
      WHERE zbcd.no = IN_No;
      IF v_qtycounted > 0.0 THEN
        SET errorMessage = CONCAT('ALERT: cannot edit qty already submit ! ');
        SET OUT_returnCode = errorMessage;
        LEAVE ENDPROC;
      ELSE
        SET OUT_returnCode = '000';
        LEAVE ENDPROC;
      END IF;
    END;
    ELSE
      SET OUT_returnCode = '000';
      LEAVE ENDPROC;
    END IF;

  END
  $$

--
-- Create procedure `CML_VAL_ALERT_ARRIVAL`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_VAL_ALERT_ARRIVAL (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_Input1 varchar(20),
IN IN_Input2 varchar(20),
IN IN_Input3 varchar(20),
IN IN_Input4 varchar(20),
IN IN_Input5 varchar(20),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE v_Dock varchar(10);
    DECLARE v_loc varchar(20);
    DECLARE v_row_pass int;
    DECLARE v_row_data int;
    DECLARE v_vehicleNo varchar(30);
    DECLARE v_driver varchar(30);
    DECLARE errorMessage varchar(255);
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_REOPENLDL', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_ldlNo;
    END;


    IF IN_warehouseId = 'CBT01'
      AND IN_Input1 NOT IN ('CDE', 'CDD', 'CON-20',
      'CON-40', 'DUMPTRUCK', 'FORKLIFT', 'FUSO', 'TRONTON', 'WINGBOX', 'VAN', 'PICKUP', 'MOTOR', 'PRIVATECAR') THEN
    BEGIN

      SET errorMessage = CONCAT('ALERT: This Vehicle not allowed in this warehouse!');
      --       SIGNAL SQLSTATE '45000'
      --       SET MESSAGE_TEXT = errorMessage;
      SET OUT_returnCode = errorMessage;
      LEAVE ENDPROC;
    END;
    ELSE
      SET OUT_returnCode = '000';
    END IF;

  END
  $$

--
-- Create procedure `CML_UPD_SO_PLT_CDN_BAK`
--
CREATE
DEFINER = 'wms_cml'@'localhost'
PROCEDURE CML_UPD_SO_PLT_CDN_BAK (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_ContainerID varchar(30),
IN IN_LDLNo varchar(30),
IN IN_PLTCDN varchar(30),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE od_allocationId varchar(10);
    DECLARE od_orderNo varchar(10);
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE OD_CURSORDONE int DEFAULT 0;

    DECLARE _GETLINEORDER CURSOR FOR
    SELECT
      ACT_ALLOCATION_DETAILS.allocationDetailsId
    FROM ACT_ALLOCATION_DETAILS
      LEFT JOIN DOC_ORDER_HEADER
        ON ACT_ALLOCATION_DETAILS.ORDERNO = DOC_ORDER_HEADER.ORDERNO
    WHERE ACT_ALLOCATION_DETAILS.organizationId = IN_organizationId
    AND ACT_ALLOCATION_DETAILS.warehouseId = IN_warehouseId
    --  AND ACT_ALLOCATION_DETAILS.STATUS > '40'
    --  AND ACT_ALLOCATION_DETAILS.STATUS <= '63'
    AND ACT_ALLOCATION_DETAILS.pickToTraceId = IN_ContainerID
    AND ACT_ALLOCATION_DETAILS.customerId = 'PPG'
    AND DOC_ORDER_HEADER.orderNo IN (SELECT
        dld.orderNo
      FROM DOC_LOADING_DETAILS dld
      WHERE dld.organizationId = IN_organizationId
      AND dld.warehouseId = IN_warehouseId
      AND dld.ldlNo = IN_LDLNo);

    --  AND DOC_ORDER_HEADER.RELEASESTATUS = 'Y';


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET OD_CURSORDONE = 1;
    OPEN _GETLINEORDER;
  GETLINEORDERLOOP:
    LOOP FETCH FROM _GETLINEORDER INTO od_allocationId;


      IF OD_CURSORDONE = 1 THEN
        SET OD_CURSORDONE = FALSE;
        LEAVE GETLINEORDERLOOP;
      END IF;

      BEGIN
        UPDATE ACT_ALLOCATION_DETAILS aad
        SET aad.udf05 = IN_PLTCDN,
            aad.editTime = NOW()
        WHERE aad.organizationId = IN_organizationId
        AND aad.allocationDetailsId = od_allocationId
        AND aad.warehouseId = IN_warehouseId
        AND aad.customerId = 'PPG';

        IF ROW_COUNT() = 0 THEN
          SET OUT_returnCode = 'Loose/Palletize status not updated!';
        END IF;

      END;
    END LOOP GETLINEORDERLOOP;
    CLOSE _GETLINEORDER;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_UPD_SO_PLT_CDN`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE CML_UPD_SO_PLT_CDN (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_ContainerID varchar(30),
IN IN_LDLNo varchar(30),
IN IN_PLTCDN varchar(30),
IN IN_CUSTOMERID varchar(50),
IN IN_ORDERNO varchar(50),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE od_allocationId varchar(10);
    DECLARE od_orderNo varchar(10);
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE OD_CURSORDONE int DEFAULT 0;

    UPDATE ACT_ALLOCATION_DETAILS
    SET udf05 = IN_PLTCDN,
        editTime = NOW()
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND customerId = IN_CUSTOMERID
    AND customerId = IN_CUSTOMERID
    AND orderNo = IN_ORDERNO
    AND pickToTraceId = IN_ContainerID;

    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_UPD_SO`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_UPD_SO (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_soNo varchar(30),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE finished integer DEFAULT 0;
  DECLARE U_cntTraceId integer;
  DECLARE U_soNo varchar(30);

  DECLARE UPD_SO CURSOR FOR
  SELECT
    COUNT(DISTINCT toId),
    docNo
  FROM ACT_TRANSACTION_LOG atl
  WHERE docType = 'SO'
  AND organizationId = IN_organizationId
  AND warehouseId = IN_warehouseId
  AND docNo = IN_soNo
  AND transactionType = 'SO'
  GROUP BY docNo;

  DECLARE CONTINUE HANDLER
  FOR NOT FOUND SET finished = 1;

  OPEN UPD_SO;
Upd_rec:
  LOOP
    FETCH UPD_SO INTO U_cntTraceId, U_soNo;
    IF finished = 1 THEN
      LEAVE Upd_rec;
    ELSE
      UPDATE DOC_ORDER_HEADER
      SET udf01 = U_cntTraceId
      WHERE orderNo = U_soNo
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId;
    END IF;
  END LOOP Upd_rec;
  CLOSE UPD_SO;

  SET OUT_returnCode := '000';
END
$$

--
-- Create procedure `CML_UPD_PACKAGE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_UPD_PACKAGE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(30),
IN IN_alternateSku1 varchar(100),
IN IN_alternateSku2 varchar(100),
IN IN_alternateSku3 varchar(100),
IN IN_asnLineNo int,
IN IN_asnNo varchar(20),
IN IN_cartonType varchar(30),
IN IN_cartonType1 varchar(30),
IN IN_cisid varchar(30),
IN IN_csQty decimal(18, 8),
IN IN_cube decimal(18, 8),
IN IN_cube1 varchar(20),
IN IN_customerId varchar(30),
IN IN_grossWeight decimal(18, 8),
IN IN_grossWeight1 varchar(20),
IN IN_ipQty decimal(18, 8),
IN IN_method varchar(30),
IN IN_plQty decimal(18, 8),
IN IN_pubFunctionModuleId varchar(30),
IN IN_sku varchar(50),
IN IN_skuHigh decimal(18, 4),
IN IN_skuHigh1 varchar(20),
IN IN_skuLength decimal(18, 4),
IN IN_skuLength1 varchar(20),
IN IN_skuWidth decimal(18, 4),
IN IN_skuWidth1 varchar(20),
IN IN_Userid varchar(100),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN

    DECLARE v_packId varchar(50);
    DECLARE v_skuHigh1 decimal(18, 4) DEFAULT 0;
    DECLARE v_skuLength1 decimal(18, 4) DEFAULT 0;
    DECLARE v_skuWidth1 decimal(18, 4) DEFAULT 0;
    DECLARE v_cube1 decimal(18, 4) DEFAULT 0;
    DECLARE v_grossWeight1 decimal(18, 4) DEFAULT 0;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_UPD_PACKAGE,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;

    SET OUT_returnCode := '000';
    START TRANSACTION;

      SELECT
        h1.packId INTO v_packId
      FROM BAS_SKU h1
      WHERE h1.organizationId = IN_organizationId
      AND h1.customerId = IN_customerId
      AND h1.sku = IN_sku;

      IF v_packId = 'STANDARD' THEN
        SET OUT_returnCode := '000';
      ELSE

        UPDATE BAS_PACKAGE_DETAILS
        SET qty = IN_ipQty,
            editWho = IN_Userid,
            edittime = NOW()
        WHERE organizationid = IN_organizationId
        AND packid = v_packId
        AND packuom = 'IP'
        AND customerid = IN_customerId;

        UPDATE BAS_PACKAGE_DETAILS
        SET qty = IN_csQty,
            editWho = IN_Userid,
            edittime = NOW()
        WHERE organizationid = IN_organizationId
        AND packid = v_packId
        AND packuom = 'CS'
        AND customerid = IN_customerId;

        UPDATE BAS_PACKAGE_DETAILS
        SET qty = IN_plQty,
            editWho = IN_Userid,
            edittime = NOW()
        WHERE organizationid = IN_organizationId
        AND packid = v_packId
        AND packuom = 'PL'
        AND customerid = IN_customerId;

        UPDATE BAS_SKU
        SET grossweight = IN_grossWeight,
            `cube` = IN_cube,
            skulength = IN_skuLength,
            skuwidth = IN_skuWidth,
            skuhigh = IN_skuHigh,
            alternate_sku1 = IN_alternateSku1,
            alternate_sku2 = IN_alternateSku2,
            alternate_sku3 = IN_alternateSku3,
            firstinbounddate = NOW(),
            editwho = IN_Userid,
            edittime = NOW()
        WHERE organizationid = IN_organizationId
        AND customerid = IN_customerId
        AND sku = IN_sku;

        UPDATE BAS_SKU_UDF
        SET edisendflag = 'N',
            edisendflag2 = 'N',
            edisendflag3 = 'N'
        WHERE organizationid = IN_organizationId
        AND customerid = IN_customerId
        AND sku = IN_sku;

        IF IFNULL(IN_skuLength1, '') <> '' THEN
          SET v_skuLength1 = CAST(IN_skuLength1 AS decimal(18, 4));
        END IF;

        IF IFNULL(IN_skuHigh1, '') <> '' THEN
          SET v_skuHigh1 = CAST(IN_skuHigh1 AS decimal(18, 4));
        END IF;

        IF IFNULL(IN_skuWidth1, '') <> '' THEN
          SET v_skuWidth1 = CAST(IN_skuWidth1 AS decimal(18, 4));
        END IF;

        IF IFNULL(IN_cube1, '') <> '' THEN
          SET v_cube1 = CAST(IN_cube1 AS decimal(18, 8));
        END IF;

        IF IFNULL(IN_grossWeight1, '') <> '' THEN
          SET v_grossWeight1 := CAST(IN_grossWeight1 AS decimal(18, 8));
        END IF;

        UPDATE BAS_PACKAGE_DETAILS
        SET `length` = v_skuLength1,
            width = v_skuWidth1,
            height = v_skuHigh1,
            `cube` = v_cube1,
            weight = v_grossWeight1,
            editwho = IN_Userid,
            edittime = NOW()
        WHERE organizationid = IN_organizationId
        AND packid = v_packId
        AND packuom = 'CS'
        AND customerid = IN_customerId;

        SET OUT_returnCode := '00S';
      END IF;
    COMMIT;
  END
  $$

--
-- Create procedure `CML_UPD_ASN_PLT_CDN`
--
CREATE
DEFINER = 'wms_cml'@'localhost'
PROCEDURE CML_UPD_ASN_PLT_CDN (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_customerId varchar(30),
IN IN_asnNo varchar(30),
IN IN_asnLineNo varchar(30),
IN IN_asnPLTCDN varchar(20),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE finished integer DEFAULT 0;
  DECLARE od_idtransaction varchar(30);
  SELECT
    atl.transactionId INTO od_idtransaction
  FROM ACT_TRANSACTION_LOG atl
  WHERE atl.organizationId = IN_organizationId
  AND atl.docType = 'ASN'
  AND atl.transactionType = 'IN'
  AND atl.fmCustomerId = IN_customerId
  AND atl.docNo = IN_asnNo
  AND atl.warehouseId = IN_warehouseId
  ORDER BY atl.transactionId DESC LIMIT 1;

  UPDATE ACT_TRANSACTION_LOG
  SET udf05 = IN_asnPLTCDN,
      editTime = NOW()
  WHERE docType = 'ASN'
  AND transactionType = 'IN'
  AND organizationId = IN_organizationId
  AND warehouseId = IN_warehouseId
  AND docNo = IN_asnNo
  AND fmCustomerId = IN_customerId
  AND docLineNo = IN_asnLineNo
  AND transactionType = 'IN'
  AND transactionId = od_idtransaction;

  SET OUT_returnCode := '000';
END
$$

--
-- Create procedure `CML_UPD_ASN`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_UPD_ASN (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_asnNo varchar(30),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE finished integer DEFAULT 0;
  DECLARE U_cntTraceId integer;
  DECLARE U_asnNo varchar(30);

  DECLARE UPD_ASN CURSOR FOR
  SELECT
    COUNT(DISTINCT toId),
    docNo
  FROM ACT_TRANSACTION_LOG atl
  WHERE docType = 'ASN'
  AND organizationId = IN_organizationId
  AND warehouseId = IN_warehouseId
  AND docNo = IN_asnNo
  AND transactionType = 'IN'
  GROUP BY docNo;

  DECLARE CONTINUE HANDLER
  FOR NOT FOUND SET finished = 1;

  OPEN UPD_ASN;
Upd_rec:
  LOOP
    FETCH UPD_ASN INTO U_cntTraceId, U_asnNo;
    IF finished = 1 THEN
      LEAVE Upd_rec;
    ELSE
      UPDATE DOC_ASN_HEADER
      SET udf01 = U_cntTraceId
      WHERE asnNo = U_asnNo
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId;
    END IF;
  END LOOP Upd_rec;
  CLOSE UPD_ASN;

  SET OUT_returnCode := '000';
END
$$

--
-- Create procedure `CML_SP_LOAD_VERIFICATION`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SP_LOAD_VERIFICATION (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_ldlNo varchar(90),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_error int;
    DECLARE v_row int;
    DECLARE v_traceId varchar(200);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
    END;

    SET OUT_returnCode = '000';
    SELECT
      COUNT(1) INTO v_row
    FROM ACT_ALLOCATION_DETAILS z
    WHERE z.warehouseId = IN_warehouseId
    AND z.organizationId = IN_organizationId
    AND z.picktoTraceId NOT IN (SELECT
        traceId
      FROM DOC_LOADING_DETAILS
      WHERE warehouseId = IN_warehouseId
      AND organizationId = IN_organizationId
      AND ldlNo = IN_ldlNo)
    AND z.waveNo IN (SELECT
        waveNo
      FROM DOC_LOADING_HEADER
      WHERE warehouseId = IN_warehouseId
      AND organizationId = IN_organizationId
      AND ldlNo = IN_ldlNo);

    IF v_row > 0 THEN
      SET v_traceId = (SELECT
          GROUP_CONCAT(tt.picktoTraceId)
        FROM (SELECT DISTINCT
            T2.picktoTraceId
          FROM ACT_ALLOCATION_DETAILS T2
            LEFT JOIN DOC_LOADING_HEADER T1
              ON T1.organizationId = T2.organizationId
              AND T1.warehouseId = T2.warehouseId
              AND T1.waveNo = T2.waveNo
          WHERE T2.picktoTraceId NOT IN (SELECT
              m.picktoTraceId
            FROM ACT_ALLOCATION_DETAILS m
              INNER JOIN DOC_LOADING_DETAILS n
                ON m.picktotraceId = n.traceId
                AND m.organizationId = n.organizationId
                AND m.warehouseId = n.warehouseId
            WHERE n.warehouseId = IN_warehouseId
            AND n.organizationId = IN_organizationId
            AND n.ldlNo = IN_ldlNo)
          AND T1.warehouseId = IN_warehouseId
          AND T1.organizationId = IN_organizationId
          AND T1.ldlNo = IN_ldlNo) tt
        ORDER BY tt.pickToTraceId);
      SET OUT_returnCode = CONCAT('Trace ID: ', v_traceId, ' is not loaded yet');
      LEAVE END_PROC;
    ELSE
      SET OUT_returnCode = '000';
      LEAVE END_PROC;
    END IF;
  END
  $$

--
-- Create procedure `CML_SP_CHECK_OVER_TYPEPALLET`
--
CREATE
DEFINER = 'mysql.sys'@'%'
PROCEDURE CML_SP_CHECK_OVER_TYPEPALLET (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_locId varchar(60),
IN IN_qtyEA decimal(18, 8),
IN IN_sku varchar(50),
IN IN_customerId varchar(30),
IN IN_lotNum varchar(30),
OUT OUT_returnCode varchar(3))
BEGIN
  -- Deklarasi variabel
  DECLARE v_count_pallet_type int DEFAULT 0;
  DECLARE v_existing_pallet_type varchar(100);
  DECLARE v_new_pallet_type varchar(100);
  DECLARE v_location_exists int DEFAULT 0;

  -- Set default return code
  SET OUT_returnCode = '000';

  -- Cek apakah lokasi yang diinput memiliki stock
  SELECT
    COUNT(DISTINCT illi.locationId) INTO v_location_exists
  FROM INV_LOT_LOC_ID illi
    INNER JOIN BAS_LOCATION bl
      ON (illi.organizationId = bl.organizationId
      AND illi.warehouseId = bl.warehouseId
      AND illi.locationId = bl.locationId)
  WHERE illi.organizationId = IN_organizationId
  AND illi.warehouseId = IN_warehouseId
  AND illi.locationId = IN_locId
  AND bl.locationCategory IN ('SD', 'DD')
  AND illi.qty > 0;

  -- Jika lokasi tidak memiliki stock, return 000 (lokasi kosong, bisa digunakan)
  IF v_location_exists = 0 THEN
    SET OUT_returnCode = '000';
  ELSE
    -- Ambil tipe pallet dari lotNum yang akan masuk
    SELECT
      ila.lotAtt07 INTO v_new_pallet_type
    FROM INV_LOT_ATT ila
    WHERE ila.organizationId = IN_organizationId
    AND ila.lotNum = IN_lotNum
    AND ila.customerId = IN_customerId
    AND ila.sku = IN_sku
    LIMIT 1;

    -- Cek jumlah tipe pallet yang berbeda di lokasi tersebut
    SELECT
      COUNT(DISTINCT ila.lotAtt07) INTO v_count_pallet_type
    FROM INV_LOT_LOC_ID illi
      INNER JOIN INV_LOT_ATT ila
        ON (illi.organizationId = ila.organizationId
        AND illi.lotNum = ila.lotNum
        AND illi.customerId = ila.customerId
        AND illi.sku = ila.sku)
    WHERE illi.organizationId = IN_organizationId
    AND illi.warehouseId = IN_warehouseId
    AND illi.locationId = IN_locId
    AND illi.qty > 0
    AND ila.lotAtt07 IS NOT NULL;

    -- Jika sudah ada lebih dari 1 tipe pallet, return 444
    IF v_count_pallet_type > 1 THEN
      SET OUT_returnCode = '444';
    ELSEIF v_count_pallet_type = 1 THEN
      -- Ambil tipe pallet yang sudah ada di lokasi
      SELECT DISTINCT
        ila.lotAtt07 INTO v_existing_pallet_type
      FROM INV_LOT_LOC_ID illi
        INNER JOIN INV_LOT_ATT ila
          ON (illi.organizationId = ila.organizationId
          AND illi.lotNum = ila.lotNum
          AND illi.customerId = ila.customerId
          AND illi.sku = ila.sku)
      WHERE illi.organizationId = IN_organizationId
      AND illi.warehouseId = IN_warehouseId
      AND illi.locationId = IN_locId
      AND illi.qty > 0
      AND ila.lotAtt07 IS NOT NULL
      LIMIT 1;

      -- SOLUSI SEMENTARA

      IF (v_existing_pallet_type IN ('PP', 'R', 'RP', 'WP')) THEN
        SET v_existing_pallet_type = 'R';
      END IF;

      IF (v_new_pallet_type IN ('PP', 'R', 'RP', 'WP')) THEN
        SET v_new_pallet_type = 'R';
      END IF;

      IF (v_existing_pallet_type NOT IN ('O', 'OL', 'OP', 'OPC')) THEN
        SET v_existing_pallet_type = 'O';
      END IF;

      IF (v_new_pallet_type NOT IN ('O', 'OL', 'OP', 'OPC')) THEN
        SET v_new_pallet_type = 'O';
      END IF;



      -- Cek apakah tipe pallet yang akan masuk sama dengan yang sudah ada
      IF v_existing_pallet_type = v_new_pallet_type
        OR v_new_pallet_type IS NULL THEN
        SET OUT_returnCode = '000';
      ELSE
        -- Tipe pallet berbeda, return 444
        SET OUT_returnCode = '444';
      END IF;
    ELSE
      -- Belum ada tipe pallet di lokasi atau semua NULL, return 000
      SET OUT_returnCode = '000';
    END IF;
  END IF;

END
$$

--
-- Create procedure `CML_SP_CHECK_OVER_PALLET`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_SP_CHECK_OVER_PALLET (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_locId varchar(60),
IN IN_qtyEA decimal(18, 8),
IN IN_sku varchar(50),
IN IN_customerId varchar(30),
OUT OUT_returnCode varchar(3),
OUT OUT_message varchar(500),
OUT OUT_currentPalletUsage decimal(18, 8),
OUT OUT_incomingPallet decimal(18, 8),
OUT OUT_totalPalletAfter decimal(18, 8),
OUT OUT_maxPalletCapacity decimal(18, 8),
OUT OUT_percentageAfter decimal(18, 8))
ENPROC:
  BEGIN
    DECLARE v_locationExists int DEFAULT 0;
    DECLARE v_currentQtyEA decimal(18, 8) DEFAULT 0;
    DECLARE v_currentPalletPercentage decimal(18, 8) DEFAULT 0;
    DECLARE v_maxPalletCapacity decimal(18, 8) DEFAULT 0;
    DECLARE v_incomingPallet decimal(18, 8) DEFAULT 0;
    DECLARE v_totalQtyEA decimal(18, 8) DEFAULT 0;
    DECLARE v_totalPallet decimal(18, 8) DEFAULT 0;
    DECLARE v_packId varchar(50);
    DECLARE v_qtyPerPallet decimal(18, 8) DEFAULT 0;
    DECLARE v_configExists int;
    DECLARE v_isReceivingLoc int DEFAULT 0;

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      SET OUT_returnCode = '999';
      SET OUT_message = 'Error dalam pengecekan over pallet';
    END;

    -- Inisialisasi output
    SET OUT_returnCode = '000';
    SET OUT_message = '';
    SET OUT_currentPalletUsage = 0;
    SET OUT_incomingPallet = 0;
    SET OUT_totalPalletAfter = 0;
    SET OUT_maxPalletCapacity = 0;
    SET OUT_percentageAfter = 0;


    -- Cek jika PLCount Null

    SELECT
      plCount INTO v_maxPalletCapacity
    FROM BAS_LOCATION
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND locationId = IN_locId
    AND locationCategory IN ('SD', 'DD')
    AND locationId NOT LIKE '%RCV%';

    IF v_maxPalletCapacity IS NULL THEN
      SET OUT_returnCode = '000';
      SET OUT_message = 'Lokasi receiving tidak perlu cek over pallet';
      LEAVE ENPROC;
    END IF;



    -- Cek apakah lokasi exists dan valid
    SELECT
      COUNT(1),
      IFNULL(MAX(plCount), 0) INTO v_locationExists, v_maxPalletCapacity
    FROM BAS_LOCATION
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND locationId = IN_locId
    AND locationCategory IN ('SD', 'DD')
    AND locationId NOT LIKE '%RCV%';

    -- Kode 333: Location tidak ada atau tidak valid
    IF v_locationExists = 0 THEN
      SET OUT_returnCode = '333';
      SET OUT_message = CONCAT('Lokasi ', IN_locId, ' tidak ditemukan atau bukan lokasi storage yang valid');
      SET OUT_maxPalletCapacity = 0;
    END IF;

    -- Set max pallet capacity
    SET OUT_maxPalletCapacity = v_maxPalletCapacity;

    -- Kode 000: Jika pallet count 0 atau tidak diisi
    IF v_maxPalletCapacity = 0
      OR v_maxPalletCapacity IS NULL THEN
      SET OUT_returnCode = '000';
      SET OUT_message = 'Lokasi tidak memiliki batasan pallet (plCount = 0)';
    END IF;

    -- Cek apakah lokasi adalah receiving location (excluded)
    SELECT
      COUNT(1) INTO v_isReceivingLoc
    FROM BSM_CONFIG_RULES
    WHERE organizationId = IN_organizationId
    AND configId = 'DFT_RCV_LOC'
    AND activeFlag = 'Y'
    AND configValue = IN_locId;

    IF v_isReceivingLoc > 0 THEN
      SET OUT_returnCode = '000';
      SET OUT_message = 'Lokasi receiving tidak perlu cek over pallet';
      LEAVE ENPROC;
    END IF;

    -- Cek apakah config STOCK_OVPALLET aktif
    SELECT
      COUNT(1) INTO v_configExists
    FROM BSM_CONFIG_RULES
    WHERE organizationId = IN_organizationId
    AND configId = 'STOCK_OVPALLET'
    AND activeFlag = 'Y'
    AND (warehouseId = IN_warehouseId
    OR customerId = IN_customerId);

    IF v_configExists = 0 THEN
      SET OUT_returnCode = '000';
      SET OUT_message = 'Config STOCK_OVPALLET tidak aktif';
      LEAVE ENPROC;
    END IF;

    -- Cari packId dan qty per pallet untuk SKU yang akan masuk
    SELECT
      packId INTO v_packId
    FROM BAS_SKU_MULTIWAREHOUSE
    WHERE organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND customerId = IN_customerId
    AND sku = IN_sku
    LIMIT 1;

    IF v_packId IS NOT NULL THEN
      SELECT
        IFNULL(qty, 0) INTO v_qtyPerPallet
      FROM BAS_PACKAGE_DETAILS
      WHERE organizationId = IN_organizationId
      AND packId = v_packId
      AND customerId = IN_customerId
      AND packUom = 'PL'
      LIMIT 1;
    END IF;

    -- Kode 222: Pallet package null atau 0
    IF v_packId IS NULL
      OR v_qtyPerPallet = 0 THEN
      SET OUT_returnCode = '222';
      SET OUT_message = CONCAT('SKU ', IN_sku, ' tidak memiliki konfigurasi pallet yang valid');
      LEAVE ENPROC;
    END IF;

    -- Hitung pallet yang akan masuk menggunakan function
    SET v_incomingPallet = FN_CALCULATE_PALLET_DECIMAL(IN_organizationId, IN_warehouseId, IN_customerId, IN_sku, IN_qtyEA);
    SET OUT_incomingPallet = v_incomingPallet;

    -- Hitung current stock di lokasi tersebut
    SELECT
      IFNULL(SUM(a.qty), 0) AS totalQtyEA,
      IFNULL(SUM(a.qtypercentage), 0) AS currentPalletPercentage INTO v_totalQtyEA, v_currentPalletPercentage
    FROM (SELECT
        i.qty,
        i.sku,
        IFNULL((i.qty / pd.qty * 100), 0) AS qtypercentage
      FROM INV_LOT_LOC_ID i
        INNER JOIN BAS_SKU_MULTIWAREHOUSE sm
          ON i.organizationId = sm.organizationId
          AND i.customerId = sm.customerId
          AND i.sku = sm.sku
          AND i.warehouseId = sm.warehouseId
        INNER JOIN BAS_PACKAGE p
          ON sm.organizationId = p.organizationId
          AND sm.packId = p.packId
          AND sm.customerId = p.customerId
        INNER JOIN BAS_PACKAGE_DETAILS pd
          ON p.organizationId = pd.organizationId
          AND p.packId = pd.packId
          AND p.customerId = pd.customerId
          AND pd.packUom = 'PL'
      WHERE i.organizationId = IN_organizationId
      AND i.warehouseId = IN_warehouseId
      AND i.locationId = IN_locId
      AND i.qty > 0) a;

    SET OUT_currentPalletUsage = v_currentPalletPercentage / 100;

    -- Hitung total setelah penambahan
    SET v_totalPallet = (v_currentPalletPercentage / 100) + v_incomingPallet;
    SET OUT_totalPalletAfter = v_totalPallet;
    SET OUT_percentageAfter = (v_totalPallet / v_maxPalletCapacity) * 100;

    -- Cek apakah over pallet
    IF v_totalPallet > v_maxPalletCapacity THEN
      -- Kode 111: Over pallet
      SET OUT_returnCode = '111';
      SET OUT_message = CONCAT('Over Pallet! Total pallet setelah penambahan: ',
      ROUND(v_totalPallet, 2),
      ' melebihi kapasitas maksimum: ',
      v_maxPalletCapacity,
      ' (', ROUND(OUT_percentageAfter, 2), '%)');
      LEAVE ENPROC;
    ELSE
      -- Kode 000: Normal, masih memenuhi
      SET OUT_returnCode = '000';
      SET OUT_message = CONCAT('OK. Total pallet setelah penambahan: ',
      ROUND(v_totalPallet, 2),
      ' dari maksimum: ',
      v_maxPalletCapacity,
      ' (', ROUND(OUT_percentageAfter, 2), '%)');
    END IF;

  END
  $$

--
-- Create procedure `CML_SP_ALERT_NEW_PACKAGE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SP_ALERT_NEW_PACKAGE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
NewSku:
  BEGIN
    DECLARE r_packId varchar(50) DEFAULT "";
    DECLARE r_packdescr varchar(100) DEFAULT "";
    DECLARE r_customer varchar(50) DEFAULT "";
    DECLARE r_AddTime varchar(20);
    DECLARE r_alertID varchar(20);
    DECLARE r_receipientAdd varchar(600);
    DECLARE finished integer DEFAULT 0;


    DECLARE cur_Package CURSOR FOR
    SELECT
      a.customerId,
      a.packId,
      SUBSTRING(a.packDescr, 1, 100),
      DATE_FORMAT(a.addTime, '%Y/%m/%d %T')
    FROM BAS_PACKAGE a
    WHERE a.organizationId = IN_organizationId
    AND IFNULL(a.udf05, '') = ''
    AND DATE_FORMAT(a.addTime, '%Y/%m/%d') <= DATE_FORMAT(NOW(), '%Y/%m/%d')
    AND DATE_FORMAT(a.addTime, '%Y/%m/%d') > DATE_FORMAT(NOW() - INTERVAL 1 DAY, '%Y/%m/%d');

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_SP_ALERT_NEW_PACKAGE,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    SET r_alertid = 'PACKAGE';
    SELECT
      template.recipientsList INTO r_receipientAdd
    FROM RUL_ALERT rul
      LEFT JOIN BSM_EMAIL_TEMPLATE template
        ON rul.organizationId = template.organizationId
        AND rul.emailtemplateId = template.templateId
    WHERE rul.organizationId = IN_organizationId
    AND rul.warehouseid = IN_warehouseId
    AND rul.alertId = r_alertid;
    OPEN cur_Package;
  getPackage:
    LOOP
      FETCH cur_Package INTO r_customer, r_PackId, r_packdescr, r_AddTime;
      IF finished = 1 THEN
        LEAVE getPackage;
      END IF;
      START TRANSACTION;
        INSERT INTO SYS_ALERT_LOG (organizationId,
        warehouseId,
        alertMessageId,
        alertId,
        alertDate,
        field01,
        field02,
        field03,
        field04,
        alertAddress,
        subjectText,
        readFlag,
        messageLevel,
        sendAlertFlag,
        addWho,
        addTime,
        editWho,
        editTime)
          VALUES (IN_organizationId, IN_warehouseId, REPLACE(UUID(), '-', ''), r_alertid, CURRENT_TIMESTAMP, r_customer, r_PackId, r_packdescr, r_AddTime, r_receipientAdd, 'New Package Alert', 'N', 1, 'N', IN_userId, CURRENT_TIMESTAMP, IN_userId, CURRENT_TIMESTAMP);
        UPDATE BAS_PACKAGE
        SET UDF05 = 'Y'
        WHERE organizationId = IN_organizationId
        AND packId = r_PackId
        AND customerId = r_customer;
      COMMIT;
    END LOOP getPackage;
    CLOSE cur_Package;

    SET out_returnCode := '000';
  END
  $$

--
-- Create procedure `CML_SP_ALERT_NEW_ITEM_SYSTEM`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SP_ALERT_NEW_ITEM_SYSTEM (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE r_sku varchar(50) DEFAULT "";
  DECLARE r_skudescr varchar(100) DEFAULT "";
  DECLARE r_AddTime varchar(20);
  DECLARE r_alertID varchar(20);
  DECLARE r_receipientAdd varchar(600);
  DECLARE finished integer DEFAULT 0;


  DECLARE cur_Sku CURSOR FOR
  SELECT
    a.SKU,
    SUBSTRING(a.skuDescr1, 1, 100),
    DATE_FORMAT(a.addTime, '%Y/%m/%d %T')
  FROM BAS_SKU a
  WHERE a.organizationId = IN_organizationId
  AND IFNULL(a.udf05, '') = ''
  AND DATE_FORMAT(a.addTime, '%Y/%m/%d') <= DATE_FORMAT(NOW(), '%Y/%m/%d')
  AND DATE_FORMAT(a.addTime, '%Y/%m/%d') > DATE_FORMAT(NOW() - INTERVAL 1 DAY, '%Y/%m/%d');

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
    GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
    @p2 = MESSAGE_TEXT,
    @p3 = MYSQL_ERRNO,
    @p4 = TABLE_NAME,
    @p5 = COLUMN_NAME;
    ROLLBACK;
    SET OUT_ReturnCode = CONCAT('999#CML_SP_ALERT_NEW_ITEM_SYSTEM,',
    IFNULL(@p1, ''),
    ',',
    IFNULL(@p2, ''),
    ',',
    IFNULL(@p3, ''),
    ',',
    IFNULL(@p4, ''),
    ',',
    IFNULL(@p5, ''));
    SELECT
      OUT_ReturnCode AS error;
  END;

  SET r_alertid = 'NEW_SKU_SYSTEM';
  SELECT
    rul.alertAddress INTO r_receipientAdd
  FROM RUL_ALERT rul
  WHERE rul.organizationId = IN_organizationId
  AND rul.warehouseid = IN_warehouseId
  AND rul.alertId = r_alertid;

  OPEN cur_Sku;
getSku:
  LOOP
    FETCH cur_Sku INTO r_sku, r_skudescr, r_AddTime;
    IF finished = 1 THEN
      LEAVE getSku;
    END IF;
    START TRANSACTION;
      INSERT INTO SYS_ALERT_LOG (organizationId,
      warehouseId,
      alertMessageId,
      alertId,
      alertDate,
      field01,
      alertAddress,
      subjectText,
      readFlag,
      messageLevel,
      sendAlertFlag)
        VALUES (IN_organizationId, IN_warehouseId, REPLACE(UUID(), '-', ''), r_alertid, CURRENT_TIMESTAMP, CONCAT("New Item: ", r_sku, " ", SUBSTRING(r_skudescr, 1, 50)), r_receipientAdd, 'New SKU Alert', 'N', 3, 'N');

      UPDATE BAS_SKU
      SET UDF05 = 'Y'
      WHERE organizationId = IN_organizationId
      AND sku = r_sku;
    COMMIT;

  END LOOP getSku;
  CLOSE cur_Sku;

  SET out_returnCode := '000';
END
$$

--
-- Create procedure `CML_SP_ALERT_NEW_ITEM`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SP_ALERT_NEW_ITEM (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
NewSku:
  BEGIN
    DECLARE r_sku varchar(50) DEFAULT "";
    DECLARE r_skudescr varchar(100) DEFAULT "";
    DECLARE r_AddTime varchar(20);
    DECLARE r_alertID varchar(20);
    DECLARE r_receipientAdd varchar(600);
    DECLARE finished integer DEFAULT 0;


    DECLARE cur_Sku CURSOR FOR
    SELECT
      a.SKU,
      SUBSTRING(a.skuDescr1, 1, 100),
      DATE_FORMAT(a.addTime, '%Y/%m/%d %T')
    FROM BAS_SKU a
    WHERE a.organizationId = IN_organizationId
    AND IFNULL(a.udf05, '') = ''
    AND DATE_FORMAT(a.addTime, '%Y/%m/%d') <= DATE_FORMAT(NOW(), '%Y/%m/%d')
    AND DATE_FORMAT(a.addTime, '%Y/%m/%d') > DATE_FORMAT(NOW() - INTERVAL 1 DAY, '%Y/%m/%d');

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_SP_ALERT_NEW_ITEM,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    SET r_alertid = 'SKU';
    SELECT
      template.recipientsList INTO r_receipientAdd
    FROM RUL_ALERT rul
      LEFT JOIN BSM_EMAIL_TEMPLATE template
        ON rul.organizationId = template.organizationId
        AND rul.emailtemplateId = template.templateId
    WHERE rul.organizationId = IN_organizationId
    AND rul.warehouseid = IN_warehouseId
    AND rul.alertId = r_alertid;
    OPEN cur_Sku;
  getSku:
    LOOP
      FETCH cur_Sku INTO r_sku, r_skudescr, r_AddTime;
      IF finished = 1 THEN
        LEAVE getSku;
      END IF;
      START TRANSACTION;
        INSERT INTO SYS_ALERT_LOG (organizationId,
        warehouseId,
        alertMessageId,
        alertId,
        alertDate,
        field01,
        field02,
        field03,
        alertAddress,
        subjectText,
        readFlag,
        messageLevel,
        sendAlertFlag,
        addWho,
        addTime,
        editWho,
        editTime)
          VALUES (IN_organizationId, IN_warehouseId, REPLACE(UUID(), '-', ''), r_alertid, CURRENT_TIMESTAMP, r_sku, r_skudescr, r_AddTime, r_receipientAdd, 'New SKU Alert', 'N', 1, 'N', IN_userId, CURRENT_TIMESTAMP, IN_userId, CURRENT_TIMESTAMP);
        UPDATE BAS_SKU
        SET UDF05 = 'Y'
        WHERE organizationId = IN_organizationId
        AND sku = r_sku;
      COMMIT;
    END LOOP getSku;
    CLOSE cur_Sku;

    SET out_returnCode := '000';
  END
  $$

--
-- Create procedure `CML_SPSO_CLOSE_CONT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SPSO_CLOSE_CONT (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_orderNo varchar(100),
IN IN_OrderSplit varchar(120),
IN IN_Userid varchar(100),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE R_NROW integer;
    DECLARE R_NROW2 integer;
    DECLARE V_udf02 varchar(100);
    DECLARE R_ASNSTATUS varchar(20);
    DECLARE R_CURRENTDATE timestamp;
    DECLARE R_FMDATE varchar(10);
    DECLARE R_TODATE varchar(10);
    DECLARE R_FMDATE_D date;
    DECLARE R_TODATE_D date;
    DECLARE R_BILLINGDATE integer;
    DECLARE R_BILLINGMONTH varchar(10);
    DECLARE R_CUSTOMER varchar(30);
    DECLARE R_tariffId varchar(10);
    DECLARE R_tariffLineNo integer;
    DECLARE R_docType varchar(15);
    DECLARE R_minAmount decimal(24, 8);
    DECLARE R_maxAmount decimal(24, 8);
    DECLARE R_chargeCategory varchar(20);
    DECLARE R_chargeType varchar(20);

    DECLARE R_tariffClassNo varchar(15);
    DECLARE R_classFrom decimal(24, 8);
    DECLARE R_classTo decimal(24, 8);
    DECLARE R_rate decimal(24, 8);

    DECLARE R_cusAmount decimal(24, 8);
    DECLARE R_BILLINGSUMMARYID varchar(30);
    DECLARE R_QTY integer;

    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_SPSO_CLOSE_CONT,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    SET R_CURRENTDATE = CURDATE();
    SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_CURRENTDATE, INTERVAL -1 MONTH),
    '%Y-%m-%d');
    SET R_TODATE = DATE_FORMAT(DATE_ADD(R_CURRENTDATE, INTERVAL -1 DAY),
    '%Y-%m-%d');
    SET R_FMDATE_D = DATE_ADD(R_CURRENTDATE, INTERVAL -1 MONTH);
    SET R_TODATE_D = DATE_ADD(R_CURRENTDATE, INTERVAL 1 DAY);
    SET R_BILLINGDATE = DAY(R_CURRENTDATE);
    SET R_BILLINGMONTH = DATE_FORMAT(R_CURRENTDATE, '%Y-%m');

    BEGIN
      UPDATE BIL_SUMMARY A
      LEFT JOIN DOC_ORDER_CONTAINER H1
        ON H1.ORGANIZATIONID = A.ORGANIZATIONID
        AND H1.WAREHOUSEID = A.WAREHOUSEID
        AND H1.ASNNO = A.DOCNO
        AND H1.CTNTYPE = A.containerType
        AND H1.CTNSIZE = A.containerSize
        AND A.docType = 'SO'
      LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
        ON A.ORGANIZATIONID = B.ORGANIZATIONID
        AND A.CUSTOMERID = B.CUSTOMERID
        AND A.WAREHOUSEID = B.WAREHOUSEID
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFMASTERID = C.TARIFFMASTERID
      LEFT JOIN BIL_TARIFF_CONTAINER D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = A.`chargeCategory`
        AND D.`chargeType` = A.`chargeType`
        AND D.containerType = A.containerType
        AND D.containerSize = A.containerSize
      SET A.udf01 = D.udf01,
          A.udf02 = D.udf02,
          A.udf04 = D.udf04
      WHERE A.`organizationId` = IN_organizationId
      AND A.`warehouseId` = IN_Warehouse
      AND A.docNo = IN_ORDERNO
      AND A.chargeType = 'OBCO'
      AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
      AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
      SET OUT_returnCode = '000';
      COMMIT;
    END;
  END
  $$

--
-- Create procedure `CML_SPASN_CLOSE_PALLET`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SPASN_CLOSE_PALLET (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_ASNNO varchar(100),
IN IN_ASNSplit varchar(120),
IN IN_Userid varchar(100),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE r_lotAtt07 varchar(10);
    DECLARE r_lotnum varchar(10);
    DECLARE r_transactionId varchar(100);
    DECLARE done int DEFAULT FALSE;
    DECLARE pallet_done integer DEFAULT 0;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_SPASN_CLOSE_PALLET',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    SET IN_organizationId = 'OJV_CML';
    BEGIN
      DECLARE CUR_PALLET CURSOR FOR
      SELECT
        a.tolotnum,
        c.lotAtt07,
        a.transactionid
      FROM ACT_TRANSACTION_LOG a
        INNER JOIN INV_LOT_ATT c
          ON a.organizationId = c.organizationId
          AND a.toLotNum = c.lotnum
          AND a.tocustomerId = c.customerId
          AND a.tosku = c.sku
      WHERE a.organizationId = IN_ORGANIZATIONID
      AND a.warehouseId = IN_Warehouse
      AND a.docNo = IN_ASNNO
      AND a.transactionType = 'IN'
      AND a.docType = 'ASN';
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET pallet_done = TRUE;
      OPEN CUR_PALLET;
    getPALLET:
      LOOP
        FETCH CUR_PALLET INTO r_lotnum,
        r_lotAtt07, r_transactionId;
        IF pallet_done = TRUE THEN
          LEAVE getPALLET;
        END IF;
        --  CLOSE CUR_PALLET ;


        IF r_lotAtt07 = 'O' THEN
          UPDATE ACT_TRANSACTION_LOG a
          SET a.billingTranCategory = 'OP'
          WHERE a.organizationId = IN_ORGANIZATIONID
          AND a.warehouseId = IN_WAREHOUSE
          AND a.docNo = IN_ASNNO
          AND a.tolotnum = r_lotnum
          AND a.transactionId = r_transactionId
          AND a.transactionType IN ('IN', 'KT', '99')
          AND a.status = '99';
        END IF;
        IF r_lotAtt07 = 'R' THEN
          UPDATE ACT_TRANSACTION_LOG a
          SET a.billingTranCategory = 'RP'
          WHERE a.organizationId = IN_ORGANIZATIONID
          AND a.warehouseId = IN_WAREHOUSE
          AND a.docNo = IN_ASNNO
          AND a.tolotnum = r_lotnum
          AND a.transactionId = r_transactionId
          --   AND a.tocustomerId <> 'SAMSONITE' 
          AND a.transactionType IN ('IN', 'KT', '99')
          AND a.status = '99';
        END IF;
      END LOOP getPALLET;
      CLOSE CUR_PALLET;
      SET OUT_ReturnCode = '000';
      COMMIT;
    END;
  END
  $$

--
-- Create procedure `CML_SPASN_CLOSE_CONT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SPASN_CLOSE_CONT (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_ASNNO varchar(100),
IN IN_ASNSplit varchar(120),
IN IN_Userid varchar(100),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE R_NROW integer;
    DECLARE R_NROW2 integer;
    DECLARE V_udf02 varchar(100);
    DECLARE R_ASNSTATUS varchar(20);
    DECLARE R_CURRENTDATE timestamp;
    DECLARE R_FMDATE varchar(10);
    DECLARE R_TODATE varchar(10);
    DECLARE R_FMDATE_D date;
    DECLARE R_TODATE_D date;
    DECLARE R_BILLINGDATE integer;
    DECLARE R_BILLINGMONTH varchar(10);
    DECLARE R_CUSTOMER varchar(30);
    DECLARE R_tariffId varchar(10);
    DECLARE R_tariffLineNo integer;
    DECLARE R_docType varchar(15);
    DECLARE R_minAmount decimal(24, 8);
    DECLARE R_maxAmount decimal(24, 8);
    DECLARE R_chargeCategory varchar(20);
    DECLARE R_chargeType varchar(20);

    DECLARE R_tariffClassNo varchar(15);
    DECLARE R_classFrom decimal(24, 8);
    DECLARE R_classTo decimal(24, 8);
    DECLARE R_rate decimal(24, 8);

    DECLARE R_cusAmount decimal(24, 8);
    DECLARE R_BILLINGSUMMARYID varchar(30);
    DECLARE R_QTY integer;

    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_SPASN_CLOSE_AF,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    SET R_CURRENTDATE = CURDATE();
    SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_CURRENTDATE, INTERVAL -1 MONTH),
    '%Y-%m-%d');
    SET R_TODATE = DATE_FORMAT(DATE_ADD(R_CURRENTDATE, INTERVAL -1 DAY),
    '%Y-%m-%d');
    SET R_FMDATE_D = DATE_ADD(R_CURRENTDATE, INTERVAL -1 MONTH);
    SET R_TODATE_D = DATE_ADD(R_CURRENTDATE, INTERVAL 1 DAY);
    SET R_BILLINGDATE = DAY(R_CURRENTDATE);
    SET R_BILLINGMONTH = DATE_FORMAT(R_CURRENTDATE, '%Y-%m');

    BEGIN
      UPDATE BIL_SUMMARY A
      LEFT JOIN DOC_ASN_CONTAINER H1
        ON H1.ORGANIZATIONID = A.ORGANIZATIONID
        AND H1.WAREHOUSEID = A.WAREHOUSEID
        AND H1.ASNNO = A.DOCNO
        AND H1.CTNTYPE = A.containerType
        AND H1.CTNSIZE = A.containerSize
        AND A.docType = 'ASN'
      LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
        ON A.ORGANIZATIONID = B.ORGANIZATIONID
        AND A.CUSTOMERID = B.CUSTOMERID
        AND A.WAREHOUSEID = B.WAREHOUSEID
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFMASTERID = C.TARIFFMASTERID
      LEFT JOIN BIL_TARIFF_CONTAINER D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = A.`chargeCategory`
        AND D.`chargeType` = A.`chargeType`
        AND D.containerType = A.containerType
        AND D.containerSize = A.containerSize
      SET A.udf01 = D.udf01,
          A.udf02 = D.udf02,
          A.udf04 = D.udf04
      WHERE A.`organizationId` = IN_organizationId
      AND A.`warehouseId` = IN_Warehouse
      AND A.docNo = IN_ASNNO
      AND A.chargeType = 'IBCO'
      AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
      AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
      SET OUT_returnCode = '000';
      COMMIT;
    END;
  END
  $$

--
-- Create procedure `CML_SPASN_CLOSE_BILL`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SPASN_CLOSE_BILL (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_ASNNO varchar(100),
IN IN_ASNSplit varchar(120),
IN IN_Userid varchar(100),
OUT OUT_ReturnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE r_lotAtt11 varchar(10);
    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    SET IN_organizationId = 'OJV_CML';
    BEGIN

      SELECT
        a.asnNo INTO IN_ASNNO
      FROM DOC_ASN_HEADER a
      WHERE a.organizationId = IN_ORGANIZATIONID
      AND a.warehouseId = IN_Warehouse
      AND a.asnNo = IN_ASNNO;
      UPDATE ACT_TRANSACTION_LOG a
      INNER JOIN INV_LOT_ATT c
        ON a.organizationId = c.organizationId
        AND a.toLotNum = c.lotnum
        AND a.tocustomerId = c.customerId
        AND a.tosku = c.sku
      SET a.BillingTranCategory = CASE WHEN c.lotAtt11 = 'Y' THEN 'C1' WHEN c.lotAtt11 = 'N' THEN 'IB01' ELSE BillingTranCategory END
      WHERE a.organizationId = IN_ORGANIZATIONID
      AND a.warehouseId = IN_WAREHOUSE
      AND a.docNo = IN_ASNNO
      AND a.transactionType IN ('PA', 'IN', 'KT', '99')
      AND a.status = '99';

      SET OUT_ReturnCode = '000';
      COMMIT;
    END;
  END
  $$

--
-- Create procedure `CML_SPASN_CLOSE_AF`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_SPASN_CLOSE_AF (IN IN_organizationId varchar(20),
IN IN_Warehouse varchar(20),
IN IN_ASNNO varchar(100),
IN IN_ASNSplit varchar(120),
IN IN_Userid varchar(100),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE R_NROW integer;
    DECLARE R_NROW2 integer;
    DECLARE V_udf02 varchar(100);
    DECLARE R_ASNSTATUS varchar(20);
    DECLARE R_CURRENTDATE timestamp;
    DECLARE R_FMDATE varchar(10);
    DECLARE R_TODATE varchar(10);
    DECLARE R_FMDATE_D date;
    DECLARE R_TODATE_D date;
    DECLARE R_BILLINGDATE integer;
    DECLARE R_BILLINGMONTH varchar(10);
    DECLARE R_CUSTOMER varchar(30);
    DECLARE R_tariffId varchar(10);
    DECLARE R_tariffLineNo integer;
    DECLARE R_docType varchar(15);
    DECLARE R_minAmount decimal(24, 8);
    DECLARE R_maxAmount decimal(24, 8);
    DECLARE R_chargeCategory varchar(20);
    DECLARE R_chargeType varchar(20);

    DECLARE R_tariffClassNo varchar(15);
    DECLARE R_classFrom decimal(24, 8);
    DECLARE R_classTo decimal(24, 8);
    DECLARE R_rate decimal(24, 8);

    DECLARE R_cusAmount decimal(24, 8);
    DECLARE R_BILLINGSUMMARYID varchar(30);
    DECLARE R_QTY integer;

    DECLARE done int DEFAULT FALSE;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_SPASN_CLOSE_AF,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    SET R_CURRENTDATE = CURDATE();
    SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_CURRENTDATE, INTERVAL -1 MONTH),
    '%Y-%m-%d');
    SET R_TODATE = DATE_FORMAT(DATE_ADD(R_CURRENTDATE, INTERVAL -1 DAY),
    '%Y-%m-%d');
    SET R_FMDATE_D = DATE_ADD(R_CURRENTDATE, INTERVAL -1 MONTH);
    SET R_TODATE_D = DATE_ADD(R_CURRENTDATE, INTERVAL 1 DAY);
    SET R_BILLINGDATE = DAY(R_CURRENTDATE);
    SET R_BILLINGMONTH = DATE_FORMAT(R_CURRENTDATE, '%Y-%m');

    BEGIN
      UPDATE BIL_SUMMARY A
      LEFT JOIN DOC_ASN_DETAILS A1
        ON A.`organizationId` = A1.`organizationId`
        AND A.`warehouseId` = A1.`warehouseId`
        AND A.docNo = A1.asnNo
      LEFT JOIN BAS_SKU_MULTIWAREHOUSE B
        ON A.ORGANIZATIONID = B.ORGANIZATIONID
        AND A.CUSTOMERID = B.CUSTOMERID
        AND A.WAREHOUSEID = B.WAREHOUSEID
        AND A.SKU = B.SKU
      LEFT JOIN BIL_TARIFF_HEADER C
        ON B.ORGANIZATIONID = C.ORGANIZATIONID
        AND B.TARIFFMASTERID = C.TARIFFMASTERID
      LEFT JOIN BIL_TARIFF_DETAILS D
        ON C.ORGANIZATIONID = D.ORGANIZATIONID
        AND C.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = A.`chargeCategory`
        AND D.`chargeType` = A.`chargeType`
      SET A.udf01 = D.udf01,
          A.udf02 = D.udf02,
          A.udf04 = D.udf06
      WHERE A.`organizationId` = IN_organizationId
      AND A.`warehouseId` = IN_Warehouse
      AND A.docNo = IN_ASNNO
      AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
      AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
      SET OUT_returnCode = '000';
      COMMIT;
    END;
  END
  $$

--
-- Create procedure `CML_SO_UPDATE_TYPE`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_SO_UPDATE_TYPE (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_soNo varchar(30),
IN IN_type varchar(4),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE OUT_ReturnNo varchar(40);
    DECLARE R_CurrentTime timestamp;
    DECLARE r_Count int;
    DECLARE r_CountExist int;
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_SO_UPDATE_TYPE', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_soNo;
    END;
    IF IFNULL(IN_soNo, '') != '' THEN
      SET OUT_returnCode = '000';


      -- check order cancel or close
      SELECT
        COUNT(1)
      FROM DOC_ORDER_HEADER doh
      WHERE doh.orderNo = IN_soNo
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND doh.soStatus IN ('00', '90', '99') INTO r_Count;


      IF r_Count > 0 THEN
        SET OUT_returnCode = 'SO type cannot change when status create,cancelled,closed!';
        LEAVE ENDPROC;
      END IF;


      -- check order cancel or close
      SELECT
        COUNT(1)
      FROM DOC_ORDER_HEADER doh
      WHERE doh.orderNo = IN_soNo
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND doh.orderType = IN_type INTO r_CountExist;

      IF r_CountExist > 0 THEN
        SET OUT_returnCode = 'SO number already changed type';
        LEAVE ENDPROC;
      END IF;

      START TRANSACTION;
        SET OUT_Return_Code = '*_*';
        SET R_CurrentTime = NOW();

        -- update SO
        UPDATE DOC_ORDER_HEADER
        SET orderType = IN_type,
            editTime = NOW()
        WHERE organizationId = 'OJV_CML'
        AND warehouseId = IN_warehouseId
        AND orderNo = IN_soNo;



        -- insert to log

        INSERT INTO Z_LogUdfTran (docType
        , docNo
        , userId
        , lottable01
        , lottable02
        , addDate
        , addWho
        , editDate
        , editWho)
          VALUES ('SO' -- docType - VARCHAR(255)
          , IN_soNo -- docNo - VARCHAR(255)
          , IN_userId -- userId - VARCHAR(255)
          , CONCAT('Update SO Type ', IN_type), 'CML_SO_UPDATE_TYPE', NOW() -- addDate - DATETIME
          , 'EDI' -- addWho - VARCHAR(255)
          , NOW() -- editDate - DATETIME
          , 'EDI' -- editWho - VARCHAR(255)
          );



      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `CML_REOPENLDL`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_REOPENLDL (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_ldlNo varchar(30),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE OUT_ReturnNo varchar(40);
    DECLARE R_CurrentTime timestamp;
    DECLARE r_Count int;
    DECLARE r_CountExist int;
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_REOPENLDL', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_ldlNo;
    END;
    IF IFNULL(IN_ldlNo, '') != '' THEN
      SET OUT_returnCode = '000';


      -- check order cancel or close
      SELECT
        COUNT(1)
      FROM DOC_LOADING_HEADER doh
      WHERE doh.ldlNo = IN_ldlNo
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND doh.ldlStatus NOT IN ('99') INTO r_Count;


      IF r_Count > 0 THEN
        SET OUT_returnCode = 'Loading list cannot change!';
        LEAVE ENDPROC;
      END IF;



      START TRANSACTION;
        SET OUT_Return_Code = '*_*';
        SET R_CurrentTime = NOW();

        -- update SO
        UPDATE DOC_LOADING_HEADER
        SET ldlStatus = '00',
            editTime = NOW()
        WHERE organizationId = 'OJV_CML'
        AND warehouseId = IN_warehouseId
        AND ldlNo = IN_ldlNo;



        -- insert to log

        INSERT INTO Z_LogUdfTran (docType
        , docNo
        , userId
        , lottable01
        , lottable02
        , addDate
        , addWho
        , editDate
        , editWho)
          VALUES ('LDL' -- docType - VARCHAR(255)
          , IN_ldlNo -- docNo - VARCHAR(255)
          , IN_userId -- userId - VARCHAR(255)
          , CONCAT('Reopen loading list '), 'CML_REOPENLDL', NOW() -- addDate - DATETIME
          , 'EDI' -- addWho - VARCHAR(255)
          , NOW() -- editDate - DATETIME
          , 'EDI' -- editWho - VARCHAR(255)
          );



      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `CML_INB_DOCK_TRUCKREG`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_INB_DOCK_TRUCKREG (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_arrivalNo varchar(30),
INOUT OUT_availDockDoor varchar(1000),
INOUT OUT_returnCode varchar(1000))
BEGIN
  DECLARE v_customername varchar(20);

  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
    SET OUT_returnCode = '1516';
    SET OUT_availDockDoor = '000';
  END;

  IF IFNULL(IN_arrivalNo, '') != '' THEN
    DROP TEMPORARY TABLE IF EXISTS CML_DOCKDOOR;
    CREATE TEMPORARY TABLE CML_DOCKDOOR
    SELECT
      *
    FROM (SELECT
        ORGANIZATIONID,
        WAREHOUSEID,
        DOCKNO,
        UDF01 CustomerName
      FROM BAS_DOCK
      WHERE ACTIVEFLAG = 'Y'
      AND IN_FLAG = 'Y'
      UNION
      SELECT
        ORGANIZATIONID,
        WAREHOUSEID,
        DOCKNO,
        UDF02
      FROM BAS_DOCK
      WHERE ACTIVEFLAG = 'Y'
      AND IN_FLAG = 'Y'
      UNION
      SELECT
        ORGANIZATIONID,
        WAREHOUSEID,
        DOCKNO,
        UDF03
      FROM BAS_DOCK
      WHERE ACTIVEFLAG = 'Y'
      AND IN_FLAG = 'Y'
      UNION
      SELECT
        ORGANIZATIONID,
        WAREHOUSEID,
        DOCKNO,
        UDF04
      FROM BAS_DOCK
      WHERE ACTIVEFLAG = 'Y'
      AND IN_FLAG = 'Y') Dock
    WHERE ORGANIZATIONID = IN_organizationId
    AND WAREHOUSEID = IN_warehouseId
    AND CustomerName != '';

    SELECT
      dah.customerId INTO v_customername
    FROM DOC_APPOINTMENT_DETAILS dad
      INNER JOIN DOC_ASN_HEADER dah
        ON dad.ORGANIZATIONID = dah.organizationId
        AND dad.warehouseId = dah.warehouseId
        AND dad.docno = dah.asnno
        AND dad.doctype = 'ASN'
      INNER JOIN DOC_ARRIVAL_DETAILS dad2
        ON dad2.organizationId = dad.organizationId
        AND dad2.warehouseId = dad.warehouseId
        AND dad2.appointmentno = dad.appointmentNo
    WHERE dad2.arrivalno = IN_arrivalNo
    AND dad.ORGANIZATIONID = IN_organizationId
    AND dad.warehouseId = IN_warehouseId;

    IF v_customername LIKE 'LTL%' THEN
      SELECT
        GROUP_CONCAT(dockNo SEPARATOR ',') INTO OUT_availDockDoor
      FROM CML_DOCKDOOR
      WHERE CustomerName IN (SELECT
          CustomerName
        FROM (SELECT
            bsm.putawayRule CustomerName,
            MAX(dad2.expectedQty)
          FROM DOC_APPOINTMENT_DETAILS dad
            INNER JOIN DOC_ASN_DETAILS dad2
              ON dad.organizationId = dad2.organizationId
              AND dad.warehouseId = dad2.warehouseId
              AND dad.docno = dad2.asnno
              AND dad.doctype = 'ASN'
            INNER JOIN BAS_SKU_MULTIWAREHOUSE bsm
              ON bsm.organizationId = dad2.organizationId
              AND bsm.warehouseId = dad2.warehouseId
              AND bsm.sku = dad2.sku
            INNER JOIN DOC_ARRIVAL_DETAILS dad3
              ON dad3.organizationId = dad.organizationId
              AND dad3.warehouseId = dad.warehouseId
              AND dad3.appointmentno = dad.appointmentNo
          WHERE dad2.customerId LIKE 'LTL'
          AND dad2.packUom = 'EA'
          AND dad3.arrivalno = IN_arrivalNo
          GROUP BY bsm.putawayRule) A);
    ELSE
      SELECT
        GROUP_CONCAT(dockNo SEPARATOR ',') INTO OUT_availDockDoor
      FROM CML_DOCKDOOR
      WHERE CustomerName = v_customername;
    END IF;
    SET OUT_returnCode = '1517';
  END IF;
END
$$

--
-- Create procedure `CML_COUNT_STORAGE_DAYS_backup2`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_STORAGE_DAYS_backup2 (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    zib4.StockDate,
    SUM(zib4.qtyCharge_TraceId) AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    SUM(zib4.qty) AS qty,
    SUM(zib4.qtycbm) AS qtycbm,
    zib4.Storage_Type,
    'STRG' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(zib1.locationId) AS qtyCharge_TraceId,
      CASE zib1.muid WHEN "*" THEN COUNT(zib1.traceId) ELSE COUNT(zib1.muid) END AS qtyCharge_MUID,
      SUM(zib1.qty) AS qty,
      SUM(zib1.qty_cbm) AS qtycbm,
      zib1.Storage_Type
    FROM (SELECT
      DISTINCT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.sku AS SKU,
        zib.SKUDesc AS SKUDesc,
        zib.UOM AS UOM,
        SUM(zib.qtyonHand) AS qtyonHand,
        CASE zib.muid WHEN "*" THEN zib.traceId ELSE zib.muid END AS muid,
        zib.traceId AS traceId,
        zib.lotNum AS lotNum,
        zib.packkey AS packkey,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        zib.locationCategory AS locationCategory,
        ila.lotAtt04 AS batch,
        ila.lotAtt11 AS owner,
        ila.lotAtt07 AS lotAtt07,
        CASE WHEN zib.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd.uomdescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomdescr = 'LT' THEN zib.qtyOnHand ELSE (
                  zib.qtyOnHand * bs.netweight) END) WHEN zib.customerId IN ('MDS') THEN (CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand ELSE (zib.qtyOnHand) * bs.sku_group6 END) WHEN zib.customerId IN ('PACIFICPAINT') THEN (zib.qtyOnHand * bs.grossweight) WHEN zib.customerId IN ('GCM') THEN (CASE WHEN bpd.uomDescr = 'ZK' THEN zib.qtyOnHand * bs.grossweight WHEN bpd.uomDescr = 'EA' THEN zib.qtyOnHand * bs.grossweight ELSE (zib.qtyOnHand) END) WHEN zib.customerId IN ('TUMI') THEN (zib.qtyOnHand) WHEN zib.customerId IN ('BMM_JKT') THEN (zib.qtyOnHand / 1000) WHEN zib.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'LT' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'L' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'G' THEN zib.qtyOnHand / 1000 WHEN
                  bpd.uomDescr = 'MT' THEN zib.qtyOnHand * 1000 ELSE (
                  zib.qtyOnHand * bs.grossweight) END) WHEN
            zib.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'PC' THEN (zib.qtyOnHand * (CAST((
                    CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN bs.sku_group6 IS NULL THEN 0 ELSE bs.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'EA' THEN (zib.qtyOnHand * (CAST((CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN
                        bs.sku_group6 IS
                        NULL THEN 0 ELSE bs.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib.qtyOnHand END) WHEN zib.customerId = 'TMB_SMG' THEN (zib.qtyOnHand) WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib.qtyOnHand) ELSE (zib.qtyOnHand) END AS qty,
        -- case when zib.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm.packId LIKE '1/%' THEN ROUND(zib.qtyonHand * bs.`cube`, 6) ELSE ROUND(zib.qtyonHand * (bs.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E08%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E09%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib.customerId = 'MAPCLUB' THEN (CASE WHEN zib.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --				AND CONVERT(zib.StockDate, DATE) between '2025-04-26' and '2025-06-03'
      AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      -- and zib.locationId not like 'K%'
      -- and ila.lotAtt11 is not null
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.SKU,
               zib.SKUDesc,
               zib.qtyonHand,
               zib.UOM,
               zib.muid,
               zib.traceId,
               zib.lotNum,
               zib.packkey,
               zib.StockDate,
               ila.lotAtt04,
               ila.lotAtt11,
               ila.lotAtt07,
               zib.locationId,
               zib.locationCategory,
               bsm.tariffMasterId,
               bs.sku_group6
      ORDER BY StockDate,
      locationId ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseId = IN_WarehouseId
    AND DATE(zib1.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --		    and CONVERT(zib1.StockDate, DATE) between '2025-04-26' and '2025-06-03'
    AND zib1.locationCategory IN ('SD', 'DD', 'GR')
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.traceId,
             zib1.muid,
             zib1.Storage_Type
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(zib3.traceId) AS qtyCharge_TraceId,
      CASE WHEN COUNT(zib3.traceId) >= 1 THEN 1 ELSE COUNT(zib3.muid) END AS qtyCharge_MUID,
      SUM(zib3.qty) AS qty,
      SUM(zib3.qty_cbm) AS qtycbm,
      zib3.Storage_Type
    FROM (SELECT
      DISTINCT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.sku AS SKU,
        zib2.SKUDesc AS SKUDesc,
        zib2.UOM AS UOM,
        SUM(zib2.qtyonHand) AS qtyonHand,
        zib2.muid AS muid,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'FMI_JKT') THEN '' ELSE zib2.traceId END AS traceId,
        zib2.lotNum AS lotNum,
        zib2.packkey AS packkey,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.locationId AS locationId,
        zib2.locationCategory AS locationCategory,
        ila1.lotAtt04 AS batch,
        ila1.lotAtt11 AS owner,
        ila1.lotAtt07 AS lotAtt07,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd1.uomdescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomdescr = 'LT' THEN zib2.qtyOnHand ELSE (
                  zib2.qtyOnHand * bs1.netweight) END) WHEN zib2.customerId IN ('MDS') THEN (CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand ELSE (zib2.qtyOnHand) * bs1.sku_group6 END) WHEN zib2.customerId IN ('PACIFICPAINT') THEN (zib2.qtyOnHand * bs1.grossweight) WHEN zib2.customerId IN ('GCM') THEN (CASE WHEN bpd1.uomDescr = 'ZK' THEN zib2.qtyOnHand * bs1.grossweight WHEN bpd1.uomDescr = 'EA' THEN zib2.qtyOnHand * bs1.grossweight ELSE (zib2.qtyOnHand) END) WHEN zib2.customerId IN ('TUMI') THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('BMM_JKT') THEN (zib2.qtyOnHand / 1000) WHEN zib2.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'LT' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'L' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'G' THEN zib2.qtyOnHand / 1000 WHEN
                  bpd1.uomDescr = 'MT' THEN zib2.qtyOnHand * 1000 ELSE (
                  zib2.qtyOnHand * bs1.grossweight) END) WHEN
            zib2.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'PC' THEN (zib2.qtyOnHand * (CAST((
                    CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN bs1.sku_group6 IS NULL THEN 0 ELSE bs1.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'EA' THEN (zib2.qtyOnHand * (CAST((CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN
                        bs1.sku_group6 IS
                        NULL THEN 0 ELSE bs1.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib2.qtyOnHand END) WHEN zib2.customerId = 'TMB_SMG' THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib2.qtyOnHand) ELSE (zib2.qtyOnHand) END AS qty,
        -- case when zib2.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm1.packId LIKE '1/%' THEN ROUND(zib2.qtyonHand * bs1.`cube`, 6) ELSE ROUND(zib2.qtyonHand * (bs1.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E08%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E09%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib2.customerId = 'MAPCLUB' THEN (CASE WHEN zib2.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila1.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      AND DATE(zib2.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --					AND CONVERT(zib2.StockDate, DATE) between '2025-04-26' and '2025-06-03'
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      -- and ila1.lotAtt11 is not null
      -- and zib2.locationId not like 'K%'
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.SKU,
               zib2.SKUDesc,
               zib2.qtyonHand,
               zib2.UOM,
               zib2.muid,
               zib2.traceId,
               zib2.lotNum,
               zib2.packkey,
               zib2.StockDate,
               ila1.lotAtt04,
               ila1.lotAtt11,
               ila1.lotAtt07,
               zib2.locationId,
               zib2.locationCategory,
               bsm1.tariffMasterId,
               bs1.sku_group6
      ORDER BY StockDate,
      traceId ASC) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    AND DATE(zib3.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --		    and CONVERT(zib3.StockDate, DATE) between '2025-04-26' and '2025-06-03'
    AND CASE WHEN zib3.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'VT') ELSE zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK') END
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.traceId,
             zib3.muid,
             zib3.Storage_Type) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate,
           zib4.Storage_Type;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_qty_cbm, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_qty_cbm,
      v_chargeType;


    /*IF NOT EXISTS (SELECT
              1
            FROM Z_BIL_AKUM_DAYS_STORAGE zads1
            WHERE zads1.organizationId = v_organizationId
            AND zads1.warehouseId = v_warehouseId
            AND zads1.customerId = v_customerId
            -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
             AND DATE(zads1.StockDate) = v_stockDate) THEN
    /*    BLOCK2:
          BEGIN
            DECLARE cur_days CURSOR FOR
            SELECT DISTINCT 
    zads.organizationId,
    zads.warehouseId,
    zads.customerId,
    zads.StockDate,
    zads.qty_traceId,
    zads.qty_MUID,
    zads.chargeType,
    zads.addWHo,
    zads.addTime,
    zads.editWho,
    zads.editTime,
    zads.UDF01,
    zads.UDF02,
    zads.UDF03,
    zads.UDF04,
    zads.UDF05,
    zads.lotAtt01,
    zads.lotAtt02,
    zads.lotAtt03,
    zads.lotAtt05
            FROM Z_BIL_AKUM_DAYS_STORAGE zads
    		where 
    		zads.organizationId = v_organizationId
    		and zads.customerId = v_customerId
    		and zads.warehouseId = v_warehouseId
    		and CONVERT(zads.StockDate,DATE) between '2024-12-26' and '2025-01-25';
            DECLARE CONTINUE HANDLER FOR NOT FOUND SET days_done = 1;
    /*        SELECT
              'look->',
               days_done;
            SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd*/

    #
    /*        OPEN cur_days;testing insert
     */
    /*getDays:
      LOOP
        FETCH cur_days INTO R_organizationId,R_warehouseId,R_customerId,R_StockDate,R_qty_traceId,R_qty_MUID,R_chargeType,R_addWHo,R_addTime,R_editWho,R_editTime,
        R_UDF01,R_UDF02,R_UDF03,R_UDF04,R_UDF05,R_lotAtt01,R_lotAtt02,R_lotAtt03,R_lotAtt05;


        --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
        IF days_done THEN
          SET days_done = FALSE;
          LEAVE getDays;
        END IF;

          --           SELECT 'check 2=>',R_RESULTQTYCHARGE;*/

    /*W             IF EXISTS (SELECT
                      1
                    FROM Z_BIL_AKUM_DAYS_STORAGE zi6
                    WHERE zi6.organzationId = v_organizationId 
                    AND zi6.warehouseId = v_warehouseId
                    AND zi6.customerId = v_customerId
                    AND zi6.StockDate = v_StockDate) then
                  DELETE
                    FROM Z_BIL_AKUM_DAYS_STORAGE
                    WHERE organizationId = v_organizationId
                    AND warehouseId = v_warehouseId
                    AND customerId = v_customerId
                    AND StockDate = v_StockDate;
                END IF; -- EXISTstorage akum days 
                #
                  IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                    SET OUT_returnCode = '999#????????';
                    LEAVE read_loop;
                  END IF;
               /* SELECT
                  'DEBUG=>',
                  v_customerId,
                  R_CUSTOMERID,
                  R_WAREHOUSEID,
                  days_done,
                  v_warehouseId;*/

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_qty_cbm,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COUNT_STORAGE_DAYS_backup`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_COUNT_STORAGE_DAYS_backup (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    zib4.StockDate,
    SUM(zib4.qtyCharge_TraceId) AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    SUM(zib4.qty) AS qty,
    'STRG' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(zib1.locationId) AS qtyCharge_TraceId,
      CASE zib1.muid WHEN "*" THEN COUNT(zib1.traceId) ELSE COUNT(zib1.muid) END AS qtyCharge_MUID,
      SUM(zib1.qty) AS qty
    FROM (SELECT
      DISTINCT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.sku AS SKU,
        zib.SKUDesc AS SKUDesc,
        zib.UOM AS UOM,
        SUM(zib.qtyonHand) AS qtyonHand,
        CASE zib.muid WHEN "*" THEN zib.traceId ELSE zib.muid END AS muid,
        zib.traceId AS traceId,
        zib.lotNum AS lotNum,
        zib.packkey AS packkey,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        zib.locationCategory AS locationCategory,
        ila.lotAtt04 AS batch,
        ila.lotAtt11 AS owner,
        ila.lotAtt07 AS lotAtt07,
        CASE WHEN zib.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd.uomdescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomdescr = 'LT' THEN zib.qtyOnHand ELSE (
                  zib.qtyOnHand * bs.netweight) END) WHEN zib.customerId IN ('MDS') THEN (CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand ELSE (zib.qtyOnHand) * bs.sku_group6 END) WHEN zib.customerId IN ('PACIFICPAINT') THEN (zib.qtyOnHand * bs.grossweight) WHEN zib.customerId IN ('GCM') THEN (CASE WHEN bpd.uomDescr = 'ZK' THEN zib.qtyOnHand * bs.grossweight WHEN bpd.uomDescr = 'EA' THEN zib.qtyOnHand * bs.grossweight ELSE (zib.qtyOnHand) END) WHEN zib.customerId IN ('TUMI') THEN (zib.qtyOnHand) WHEN zib.customerId IN ('BMM_JKT') THEN (zib.qtyOnHand / 1000) WHEN zib.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'LT' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'L' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'G' THEN zib.qtyOnHand / 1000 WHEN
                  bpd.uomDescr = 'MT' THEN zib.qtyOnHand * 1000 ELSE (
                  zib.qtyOnHand * bs.grossweight) END) WHEN
            zib.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'PC' THEN (zib.qtyOnHand * (CAST((
                    CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN bs.sku_group6 IS NULL THEN 0 ELSE bs.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'EA' THEN (zib.qtyOnHand * (CAST((CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN
                        bs.sku_group6 IS
                        NULL THEN 0 ELSE bs.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib.qtyOnHand END) WHEN zib.customerId = 'TMB_SMG' THEN (zib.qtyOnHand) WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib.qtyOnHand) ELSE (zib.qtyOnHand) END AS qty,
        CASE ila.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --				AND CONVERT(zib.StockDate, DATE) between '2025-04-26' and '2025-05-13'
      AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      -- and zib.locationId not like 'K%'
      -- and ila.lotAtt11 is not null
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.SKU,
               zib.SKUDesc,
               zib.qtyonHand,
               zib.UOM,
               zib.muid,
               zib.traceId,
               zib.lotNum,
               zib.packkey,
               zib.StockDate,
               ila.lotAtt04,
               ila.lotAtt11,
               ila.lotAtt07,
               zib.locationId,
               zib.locationCategory,
               bsm.tariffMasterId,
               bs.sku_group6
      ORDER BY StockDate,
      locationId ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseId = IN_WarehouseId
    AND DATE(zib1.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    -- and CONVERT(zib1.StockDate, DATE) between '2025-04-26' and '2025-05-13'
    AND zib1.locationCategory IN ('SD', 'DD', 'GR')
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.traceId,
             zib1.muid
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(zib3.traceId) AS qtyCharge_TraceId,
      CASE zib3.muid WHEN "*" THEN COUNT(zib3.traceId) ELSE COUNT(zib3.muid) END AS qtyCharge_MUID,
      SUM(zib3.qty) AS qty
    FROM (SELECT
      DISTINCT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.sku AS SKU,
        zib2.SKUDesc AS SKUDesc,
        zib2.UOM AS UOM,
        SUM(zib2.qtyonHand) AS qtyonHand,
        CASE zib2.muid WHEN "*" THEN zib2.traceId ELSE zib2.muid END AS muid,
        zib2.traceId AS traceId,
        zib2.lotNum AS lotNum,
        zib2.packkey AS packkey,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.locationId AS locationId,
        zib2.locationCategory AS locationCategory,
        ila1.lotAtt04 AS batch,
        ila1.lotAtt11 AS owner,
        ila1.lotAtt07 AS lotAtt07,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd1.uomdescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomdescr = 'LT' THEN zib2.qtyOnHand ELSE (
                  zib2.qtyOnHand * bs1.netweight) END) WHEN zib2.customerId IN ('MDS') THEN (CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand ELSE (zib2.qtyOnHand) * bs1.sku_group6 END) WHEN zib2.customerId IN ('PACIFICPAINT') THEN (zib2.qtyOnHand * bs1.grossweight) WHEN zib2.customerId IN ('GCM') THEN (CASE WHEN bpd1.uomDescr = 'ZK' THEN zib2.qtyOnHand * bs1.grossweight WHEN bpd1.uomDescr = 'EA' THEN zib2.qtyOnHand * bs1.grossweight ELSE (zib2.qtyOnHand) END) WHEN zib2.customerId IN ('TUMI') THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('BMM_JKT') THEN (zib2.qtyOnHand / 1000) WHEN zib2.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'LT' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'L' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'G' THEN zib2.qtyOnHand / 1000 WHEN
                  bpd1.uomDescr = 'MT' THEN zib2.qtyOnHand * 1000 ELSE (
                  zib2.qtyOnHand * bs1.grossweight) END) WHEN
            zib2.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'PC' THEN (zib2.qtyOnHand * (CAST((
                    CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN bs1.sku_group6 IS NULL THEN 0 ELSE bs1.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'EA' THEN (zib2.qtyOnHand * (CAST((CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN
                        bs1.sku_group6 IS
                        NULL THEN 0 ELSE bs1.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib2.qtyOnHand END) WHEN zib2.customerId = 'TMB_SMG' THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib2.qtyOnHand) ELSE (zib2.qtyOnHand) END AS qty,
        CASE ila1.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      AND DATE(zib2.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      -- AND CONVERT(zib2.StockDate, DATE) between '2025-04-26' and '2025-05-13'
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      -- and ila1.lotAtt11 is not null
      -- and zib2.locationId not like 'K%'
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.SKU,
               zib2.SKUDesc,
               zib2.qtyonHand,
               zib2.UOM,
               zib2.muid,
               zib2.traceId,
               zib2.lotNum,
               zib2.packkey,
               zib2.StockDate,
               ila1.lotAtt04,
               ila1.lotAtt11,
               ila1.lotAtt07,
               zib2.locationId,
               zib2.locationCategory,
               bsm1.tariffMasterId,
               bs1.sku_group6
      ORDER BY StockDate,
      traceId ASC) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    -- and CONVERT(zib3.StockDate, DATE) between '2025-04-26' and '2025-05-13'
    AND DATE(zib3.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK')
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.traceId,
             zib3.muid) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      R_CUSTOMERID,
      R_WAREHOUSEID,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_chargeType;


    /*IF NOT EXISTS (SELECT
              1
            FROM Z_BIL_AKUM_DAYS_STORAGE zads1
            WHERE zads1.organizationId = v_organizationId
            AND zads1.warehouseId = v_warehouseId
            AND zads1.customerId = v_customerId
            -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
             AND DATE(zads1.StockDate) = v_stockDate) THEN
    /*    BLOCK2:
          BEGIN
            DECLARE cur_days CURSOR FOR
            SELECT DISTINCT 
    zads.organizationId,
    zads.warehouseId,
    zads.customerId,
    zads.StockDate,
    zads.qty_traceId,
    zads.qty_MUID,
    zads.chargeType,
    zads.addWHo,
    zads.addTime,
    zads.editWho,
    zads.editTime,
    zads.UDF01,
    zads.UDF02,
    zads.UDF03,
    zads.UDF04,
    zads.UDF05,
    zads.lotAtt01,
    zads.lotAtt02,
    zads.lotAtt03,
    zads.lotAtt05
            FROM Z_BIL_AKUM_DAYS_STORAGE zads
    		where 
    		zads.organizationId = v_organizationId
    		and zads.customerId = v_customerId
    		and zads.warehouseId = v_warehouseId
    		and CONVERT(zads.StockDate,DATE) between '2024-12-26' and '2025-01-25';
            DECLARE CONTINUE HANDLER FOR NOT FOUND SET days_done = 1;
    /*        SELECT
              'look->',
               days_done;
            SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd*/

    #
    /*        OPEN cur_days;testing insert
     */
    /*getDays:
      LOOP
        FETCH cur_days INTO R_organizationId,R_warehouseId,R_customerId,R_StockDate,R_qty_traceId,R_qty_MUID,R_chargeType,R_addWHo,R_addTime,R_editWho,R_editTime,
        R_UDF01,R_UDF02,R_UDF03,R_UDF04,R_UDF05,R_lotAtt01,R_lotAtt02,R_lotAtt03,R_lotAtt05;


        --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
        IF days_done THEN
          SET days_done = FALSE;
          LEAVE getDays;
        END IF;

          --           SELECT 'check 2=>',R_RESULTQTYCHARGE;*/

    /*W             IF EXISTS (SELECT
                      1
                    FROM Z_BIL_AKUM_DAYS_STORAGE zi6
                    WHERE zi6.organzationId = v_organizationId 
                    AND zi6.warehouseId = v_warehouseId
                    AND zi6.customerId = v_customerId
                    AND zi6.StockDate = v_StockDate) then
                  DELETE
                    FROM Z_BIL_AKUM_DAYS_STORAGE
                    WHERE organizationId = v_organizationId
                    AND warehouseId = v_warehouseId
                    AND customerId = v_customerId
                    AND StockDate = v_StockDate;
                END IF; -- EXISTstorage akum days 
                #
                  IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                    SET OUT_returnCode = '999#????????';
                    LEAVE read_loop;
                  END IF;
               /* SELECT
                  'DEBUG=>',
                  v_customerId,
                  R_CUSTOMERID,
                  R_WAREHOUSEID,
                  days_done,
                  v_warehouseId;*/

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_chargeType,
        IN_USERID addWHo,
        NOW() addTime,
        IN_USERID editWho,
        NOW() editTime,
        '' UDF01,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COUNT_RENT_PALLET_DAYS_backup`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_COUNT_RENT_PALLET_DAYS_backup (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_USERID varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    zib4.StockDate,
    SUM(zib4.qtyCharge_TraceId) AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    SUM(zib4.qty) AS qty,
    'RP' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(zib1.locationId) AS qtyCharge_TraceId,
      CASE zib1.muid WHEN "*" THEN COUNT(zib1.traceId) ELSE COUNT(zib1.muid) END AS qtyCharge_MUID,
      SUM(zib1.qty) AS qty
    FROM (SELECT
      DISTINCT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.sku AS SKU,
        zib.SKUDesc AS SKUDesc,
        zib.UOM AS UOM,
        SUM(zib.qtyonHand) AS qtyonHand,
        CASE zib.muid WHEN "*" THEN zib.traceId ELSE zib.muid END AS muid,
        zib.traceId AS traceId,
        zib.lotNum AS lotNum,
        zib.packkey AS packkey,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        zib.locationCategory AS locationCategory,
        ila.lotAtt04 AS batch,
        ila.lotAtt11 AS owner,
        ila.lotAtt07 AS lotAtt07,
        CASE WHEN zib.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd.uomdescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomdescr = 'LT' THEN zib.qtyOnHand ELSE (
                  zib.qtyOnHand * bs.netweight) END) WHEN zib.customerId IN ('MDS') THEN (CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand ELSE (zib.qtyOnHand) * bs.sku_group6 END) WHEN zib.customerId IN ('PACIFICPAINT') THEN (zib.qtyOnHand * bs.grossweight) WHEN zib.customerId IN ('GCM') THEN (CASE WHEN bpd.uomDescr = 'ZK' THEN zib.qtyOnHand * bs.grossweight WHEN bpd.uomDescr = 'EA' THEN zib.qtyOnHand * bs.grossweight ELSE (zib.qtyOnHand) END) WHEN zib.customerId IN ('TUMI') THEN (zib.qtyOnHand) WHEN zib.customerId IN ('BMM_JKT') THEN (zib.qtyOnHand / 1000) WHEN zib.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'LT' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'L' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'G' THEN zib.qtyOnHand / 1000 WHEN
                  bpd.uomDescr = 'MT' THEN zib.qtyOnHand * 1000 ELSE (
                  zib.qtyOnHand * bs.grossweight) END) WHEN
            zib.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'PC' THEN (zib.qtyOnHand * (CAST((
                    CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN bs.sku_group6 IS NULL THEN 0 ELSE bs.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'EA' THEN (zib.qtyOnHand * (CAST((CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN
                        bs.sku_group6 IS
                        NULL THEN 0 ELSE bs.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib.qtyOnHand END) WHEN zib.customerId = 'TMB_SMG' THEN (zib.qtyOnHand) WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib.qtyOnHand) ELSE (zib.qtyOnHand) END AS qty,
        CASE ila.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      AND ila.lotAtt07 NOT IN ('O', 'OP', 'OL', 'OPC')
      --				AND CONVERT(zib.StockDate, DATE) between '2025-04-26' and '2025-05-15'
      AND zib.locationId NOT IN ('CONSWOR',
      'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20',
      'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02',
      'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03',
      'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25',
      'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      -- and zib.locationId not like 'K%'
      -- and ila.lotAtt11 is not null
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.SKU,
               zib.SKUDesc,
               zib.qtyonHand,
               zib.UOM,
               zib.muid,
               zib.traceId,
               zib.lotNum,
               zib.packkey,
               zib.StockDate,
               ila.lotAtt04,
               ila.lotAtt11,
               ila.lotAtt07,
               zib.locationId,
               zib.locationCategory,
               bsm.tariffMasterId,
               bs.sku_group6
      ORDER BY StockDate,
      locationId ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseId = IN_WarehouseId
    AND DATE(zib1.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --			and CONVERT(zib1.StockDate, DATE) between '2025-04-26' and '2025-05-15'
    AND zib1.locationCategory IN ('SD', 'DD', 'GR')
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.traceId,
             zib1.muid
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(zib3.traceId) AS qtyCharge_TraceId,
      CASE zib3.muid WHEN "*" THEN COUNT(zib3.traceId) ELSE COUNT(zib3.muid) END AS qtyCharge_MUID,
      SUM(zib3.qty) AS qty
    FROM (SELECT
      DISTINCT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.sku AS SKU,
        zib2.SKUDesc AS SKUDesc,
        zib2.UOM AS UOM,
        SUM(zib2.qtyonHand) AS qtyonHand,
        CASE zib2.muid WHEN "*" THEN zib2.traceId ELSE zib2.muid END AS muid,
        zib2.traceId AS traceId,
        zib2.lotNum AS lotNum,
        zib2.packkey AS packkey,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.locationId AS locationId,
        zib2.locationCategory AS locationCategory,
        ila1.lotAtt04 AS batch,
        ila1.lotAtt11 AS owner,
        ila1.lotAtt07 AS lotAtt07,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd1.uomdescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomdescr = 'LT' THEN zib2.qtyOnHand ELSE (
                  zib2.qtyOnHand * bs1.netweight) END) WHEN zib2.customerId IN ('MDS') THEN (CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand ELSE (zib2.qtyOnHand) * bs1.sku_group6 END) WHEN zib2.customerId IN ('PACIFICPAINT') THEN (zib2.qtyOnHand * bs1.grossweight) WHEN zib2.customerId IN ('GCM') THEN (CASE WHEN bpd1.uomDescr = 'ZK' THEN zib2.qtyOnHand * bs1.grossweight WHEN bpd1.uomDescr = 'EA' THEN zib2.qtyOnHand * bs1.grossweight ELSE (zib2.qtyOnHand) END) WHEN zib2.customerId IN ('TUMI') THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('BMM_JKT') THEN (zib2.qtyOnHand / 1000) WHEN zib2.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'LT' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'L' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'G' THEN zib2.qtyOnHand / 1000 WHEN
                  bpd1.uomDescr = 'MT' THEN zib2.qtyOnHand * 1000 ELSE (
                  zib2.qtyOnHand * bs1.grossweight) END) WHEN
            zib2.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'PC' THEN (zib2.qtyOnHand * (CAST((
                    CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN bs1.sku_group6 IS NULL THEN 0 ELSE bs1.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'EA' THEN (zib2.qtyOnHand * (CAST((CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN
                        bs1.sku_group6 IS
                        NULL THEN 0 ELSE bs1.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib2.qtyOnHand END) WHEN zib2.customerId = 'TMB_SMG' THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib2.qtyOnHand) ELSE (zib2.qtyOnHand) END AS qty,
        CASE ila1.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      AND DATE(zib2.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      AND ila1.lotAtt07 NOT IN ('O', 'OP', 'OL', 'OPC')
      --				AND CONVERT(zib2.StockDate, DATE) between '2025-04-26' and '2025-05-15'
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      -- and ila1.lotAtt11 is not null
      -- and zib2.locationId not like 'K%'
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.SKU,
               zib2.SKUDesc,
               zib2.qtyonHand,
               zib2.UOM,
               zib2.muid,
               zib2.traceId,
               zib2.lotNum,
               zib2.packkey,
               zib2.StockDate,
               ila1.lotAtt04,
               ila1.lotAtt11,
               ila1.lotAtt07,
               zib2.locationId,
               zib2.locationCategory,
               bsm1.tariffMasterId,
               bs1.sku_group6
      ORDER BY StockDate,
      traceId ASC) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    --			and CONVERT(zib3.StockDate, DATE) between '2025-04-26' and '2025-05-15'
    AND DATE(zib3.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK')
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.traceId,
             zib3.muid) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      R_CUSTOMERID,
      R_WAREHOUSEID,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_chargeType;


    /*IF NOT EXISTS (SELECT
              1
            FROM Z_BIL_AKUM_DAYS_STORAGE zads1
            WHERE zads1.organizationId = v_organizationId
            AND zads1.warehouseId = v_warehouseId
            AND zads1.customerId = v_customerId
            -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
             AND DATE(zads1.StockDate) = v_stockDate) THEN
    /*    BLOCK2:
          BEGIN
            DECLARE cur_days CURSOR FOR
            SELECT DISTINCT 
    zads.organizationId,
    zads.warehouseId,
    zads.customerId,
    zads.StockDate,
    zads.qty_traceId,
    zads.qty_MUID,
    zads.chargeType,
    zads.addWHo,
    zads.addTime,
    zads.editWho,
    zads.editTime,
    zads.UDF01,
    zads.UDF02,
    zads.UDF03,
    zads.UDF04,
    zads.UDF05,
    zads.lotAtt01,
    zads.lotAtt02,
    zads.lotAtt03,
    zads.lotAtt05
            FROM Z_BIL_AKUM_DAYS_STORAGE zads
    		where 
    		zads.organizationId = v_organizationId
    		and zads.customerId = v_customerId
    		and zads.warehouseId = v_warehouseId
    		and CONVERT(zads.StockDate,DATE) between '2024-12-26' and '2025-01-25';
            DECLARE CONTINUE HANDLER FOR NOT FOUND SET days_done = 1;
    /*        SELECT
              'look->',
               days_done;
            SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd*/

    #
    /*        OPEN cur_days;testing insert
     */
    /*getDays:
      LOOP
        FETCH cur_days INTO R_organizationId,R_warehouseId,R_customerId,R_StockDate,R_qty_traceId,R_qty_MUID,R_chargeType,R_addWHo,R_addTime,R_editWho,R_editTime,
        R_UDF01,R_UDF02,R_UDF03,R_UDF04,R_UDF05,R_lotAtt01,R_lotAtt02,R_lotAtt03,R_lotAtt05;


        --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
        IF days_done THEN
          SET days_done = FALSE;
          LEAVE getDays;
        END IF;

          --           SELECT 'check 2=>',R_RESULTQTYCHARGE;*/

    /*W             IF EXISTS (SELECT
                      1
                    FROM Z_BIL_AKUM_DAYS_STORAGE zi6
                    WHERE zi6.organzationId = v_organizationId 
                    AND zi6.warehouseId = v_warehouseId
                    AND zi6.customerId = v_customerId
                    AND zi6.StockDate = v_StockDate) then
                  DELETE
                    FROM Z_BIL_AKUM_DAYS_STORAGE
                    WHERE organizationId = v_organizationId
                    AND warehouseId = v_warehouseId
                    AND customerId = v_customerId
                    AND StockDate = v_StockDate;
                END IF; -- EXISTstorage akum days 
                #
                  IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                    SET OUT_returnCode = '999#????????';
                    LEAVE read_loop;
                  END IF;
               /* SELECT
                  'DEBUG=>',
                  v_customerId,
                  R_CUSTOMERID,
                  R_WAREHOUSEID,
                  days_done,
                  v_warehouseId;*/

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_chargeType,
        IN_USERID addWHo,
        NOW() addTime,
        IN_USERID editWho,
        NOW() editTime,
        '' UDF01,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COUNT_RENT_PALLET_BEBGBAL_STORAGE_IN`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_RENT_PALLET_BEBGBAL_STORAGE_IN (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib.organizationId,
    zib.warehouseId,
    zib.customerId,
    DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
    COUNT(DISTINCT zib.traceId) AS qtyCharge_TraceId,
    COUNT(DISTINCT zib.muid) AS qtyCharge_MUID,
    SUM(zib.qty) AS qty,
    zib.Storage_Type,
    'RP' AS chargeType
  FROM (SELECT DISTINCT
      IFNULL(CAST(atl.organizationId AS char(255)), '') AS organizationId,
      IFNULL(CAST(atl.warehouseId AS char(255)), '') AS warehouseId,
      IFNULL(CAST(atl.tocustomerId AS char(255)), '') AS customerId,
      IFNULL(CAST(atl.toSku AS char(255)), '') AS sku,
      IFNULL(CAST(atl.toQty AS char(255)), 0) AS qtyReceived,
      IFNULL(CAST(atl.toUom AS char(255)), '') AS uom,
      IFNULL(CAST(atl.toQty_Each AS char(255)), 0) AS qty,
      CAST(DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') AS char(255)) AS stockDate,
      IFNULL(CAST(atl.toId AS char(255)), '') AS traceId,
      IFNULL(CAST(atl.tomuid AS char(255)), '') AS muid,
      IFNULL(CAST(atl.toLocation AS char(255)), '') AS locationId,
      IFNULL(CAST(ila.lotAtt07 AS char(255)), '') AS palletType,
      'DRY' AS Storage_Type
    FROM ACT_TRANSACTION_LOG atl
      LEFT JOIN INV_LOT_ATT ila
        ON ila.organizationId = atl.organizationId
        AND ila.lotNum = atl.toLotNum
        AND ila.customerId = atl.toCustomerId
    WHERE atl.organizationId = 'OJV_CML'
    AND atl.tocustomerId = 'ITOCHU'
    AND atl.warehouseId = 'CBT01'
    --			AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') BETWEEN '2025-06-26' AND '2025-07-25'
    AND atl.transactionType = 'IN'
    AND atl.STATUS IN ('80', '99')
    AND ila.lotAtt07 NOT IN ('O', 'OP', 'OL', 'OPC')) zib
  WHERE zib.organizationId = 'OJV_CML'
  AND zib.customerId = 'ITOCHU'
  AND zib.warehouseid = 'CBT01'
  AND zib.SKU NOT IN ('FULLCARTON')
  AND zib.SKU NOT LIKE '13%'
  AND zib.qty > 0
  --				AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
  AND CONVERT(zib.StockDate, date) BETWEEN '2025-06-26' AND '2025-07-25'
  AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01',
  'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
  -- AND bl.workingArea not in ('LTL-BULK')
  GROUP BY zib.organizationId,
           zib.StockDate,
           zib.warehouseId,
           zib.customerId,
           zib.Storage_Type;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_chargeType;

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        0.0,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  END LOOP;
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COUNT_DATE_STORAGE_DAYS`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_DATE_STORAGE_DAYS (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_DateFrom varchar(30),
IN IN_DateTo varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    zib4.StockDate,
    CASE WHEN zib4.customerId = 'GMC' AND
        zib4.warehouseId = 'CBT01' THEN SUM(zib4.qtyCharge_TraceId) - 100 ELSE SUM(zib4.qtyCharge_TraceId) END AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    SUM(zib4.qty) AS qty,
    SUM(zib4.qtycbm) AS qtycbm,
    zib4.Storage_Type,
    'STRG' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib1.locationId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib1.muid) AS qtyCharge_MUID,
      SUM(zib1.qty) AS qty,
      SUM(zib1.qty_cbm) AS qtycbm,
      zib1.Storage_Type
    FROM (SELECT
      DISTINCT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.sku AS SKU,
        zib.SKUDesc AS SKUDesc,
        zib.UOM AS UOM,
        SUM(zib.qtyonHand) AS qtyonHand,
        zib.muid AS muid,
        zib.traceId AS traceId,
        zib.lotNum AS lotNum,
        zib.packkey AS packkey,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        zib.locationCategory AS locationCategory,
        ila.lotAtt04 AS batch,
        ila.lotAtt11 AS owner,
        ila.lotAtt07 AS lotAtt07,
        CASE WHEN zib.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd.uomdescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomdescr = 'LT' THEN zib.qtyOnHand ELSE (
                  zib.qtyOnHand * bs.netweight) END) WHEN zib.customerId IN ('MDS') THEN (CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand ELSE (zib.qtyOnHand) * bs.sku_group6 END) WHEN zib.customerId IN ('PACIFICPAINT') THEN (zib.qtyOnHand * bs.grossweight) WHEN zib.customerId IN ('GCM') THEN (CASE WHEN bpd.uomDescr = 'ZK' THEN zib.qtyOnHand * bs.grossweight WHEN bpd.uomDescr = 'EA' THEN zib.qtyOnHand * bs.grossweight ELSE (zib.qtyOnHand) END) WHEN zib.customerId IN ('TUMI') THEN (zib.qtyOnHand) WHEN zib.customerId IN ('BMM_JKT') THEN (zib.qtyOnHand / 1000) WHEN zib.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'LT' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'L' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'G' THEN zib.qtyOnHand / 1000 WHEN
                  bpd.uomDescr = 'MT' THEN zib.qtyOnHand * 1000 ELSE (
                  zib.qtyOnHand * bs.grossweight) END) WHEN
            zib.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'PC' THEN (zib.qtyOnHand * (CAST((
                    CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN bs.sku_group6 IS NULL THEN 0 ELSE bs.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'EA' THEN (zib.qtyOnHand * (CAST((CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN
                        bs.sku_group6 IS
                        NULL THEN 0 ELSE bs.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib.qtyOnHand END) WHEN zib.customerId = 'TMB_SMG' THEN (zib.qtyOnHand) WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib.qtyOnHand) ELSE (zib.qtyOnHand) END AS qty,
        -- case when zib.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm.packId LIKE '1/%' THEN ROUND(zib.qtyonHand * bs.`cube`, 6) ELSE ROUND(zib.qtyonHand * (bs.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E08%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E09%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib.customerId = 'MAPCLUB' THEN (CASE WHEN zib.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) WHEN zib.customerid = 'PPG' THEN (CASE WHEN zib.locationId LIKE 'C%' THEN 'WH-C' ELSE 'NON WH-C' END) WHEN zib.customerId IN ('DNN_MDN') THEN (CASE WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10215338' THEN 'PREFORM 1500' WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10215336' THEN 'PREFORM 600' WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10425007' THEN 'CAPSHIELD' ELSE 'RESIN' END) WHEN zib.customerId = 'MAP' THEN (CASE WHEN bsm.tariffMasterId = 'BIL00062PT' THEN 'PT' ELSE 'GENRERAL' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      --				AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --				AND CONVERT(zib.StockDate, DATE) between '2025-05-01' and '2025-06-30'
      AND DATE(zib.StockDate) >= IN_DateFrom
      AND DATE(zib.StockDate) <= IN_DateTo
      AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND bl.workingArea NOT IN ('LTL-BULK')
      AND bsm.tariffMasterId NOT IN ('BIL00062', 'BIL0006201', 'BIL0006202', 'BIL0006203', 'BIL0006204', 'BIL00062PIECES', 'BIL0006201PIECES', 'BIL0006202PIECES', 'BIL0006203PIECES', 'BIL0006204PIECES')
      -- and zib.locationId not like 'K%'
      -- and ila.lotAtt11 is not null
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.SKU,
               zib.SKUDesc,
               zib.qtyonHand,
               zib.UOM,
               zib.muid,
               zib.traceId,
               zib.lotNum,
               zib.packkey,
               zib.StockDate,
               ila.lotAtt04,
               ila.lotAtt11,
               ila.lotAtt07,
               zib.locationId,
               zib.locationCategory,
               bsm.tariffMasterId,
               bs.sku_group6
      ORDER BY StockDate,
      locationId ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseId = IN_WarehouseId
    --			AND DATE(zib1.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --		    and CONVERT(zib1.StockDate, DATE) between '2025-05-01' and '2025-06-30'
    AND DATE(zib1.StockDate) >= IN_DateFrom
    AND DATE(zib1.StockDate) <= IN_DateTo
    AND zib1.locationCategory IN ('SD', 'DD', 'GR')
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.Storage_Type
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib3.traceId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib3.muid) AS qtyCharge_MUID,
      SUM(zib3.qty) AS qty,
      SUM(zib3.qty_cbm) AS qtycbm,
      zib3.Storage_Type
    FROM (SELECT
      DISTINCT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.sku AS SKU,
        zib2.SKUDesc AS SKUDesc,
        zib2.UOM AS UOM,
        SUM(zib2.qtyonHand) AS qtyonHand,
        zib2.muid AS muid,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'FMI_JKT') THEN '' ELSE zib2.traceId END AS traceId,
        zib2.lotNum AS lotNum,
        zib2.packkey AS packkey,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.locationId AS locationId,
        zib2.locationCategory AS locationCategory,
        ila1.lotAtt04 AS batch,
        ila1.lotAtt11 AS owner,
        ila1.lotAtt07 AS lotAtt07,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd1.uomdescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomdescr = 'LT' THEN zib2.qtyOnHand ELSE (
                  zib2.qtyOnHand * bs1.netweight) END) WHEN zib2.customerId IN ('MDS') THEN (CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand ELSE (zib2.qtyOnHand) * bs1.sku_group6 END) WHEN zib2.customerId IN ('PACIFICPAINT') THEN (zib2.qtyOnHand * bs1.grossweight) WHEN zib2.customerId IN ('GCM') THEN (CASE WHEN bpd1.uomDescr = 'ZK' THEN zib2.qtyOnHand * bs1.grossweight WHEN bpd1.uomDescr = 'EA' THEN zib2.qtyOnHand * bs1.grossweight ELSE (zib2.qtyOnHand) END) WHEN zib2.customerId IN ('TUMI') THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('BMM_JKT') THEN (zib2.qtyOnHand / 1000) WHEN zib2.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'LT' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'L' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'G' THEN zib2.qtyOnHand / 1000 WHEN
                  bpd1.uomDescr = 'MT' THEN zib2.qtyOnHand * 1000 ELSE (
                  zib2.qtyOnHand * bs1.grossweight) END) WHEN
            zib2.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'PC' THEN (zib2.qtyOnHand * (CAST((
                    CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN bs1.sku_group6 IS NULL THEN 0 ELSE bs1.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'EA' THEN (zib2.qtyOnHand * (CAST((CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN
                        bs1.sku_group6 IS
                        NULL THEN 0 ELSE bs1.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib2.qtyOnHand END) WHEN zib2.customerId = 'TMB_SMG' THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib2.qtyOnHand) ELSE (zib2.qtyOnHand) END AS qty,
        -- case when zib2.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm1.packId LIKE '1/%' THEN ROUND(zib2.qtyonHand * bs1.`cube`, 6) ELSE ROUND(zib2.qtyonHand * (bs1.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E08%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E09%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib2.customerId = 'MAPCLUB' THEN (CASE WHEN zib2.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) WHEN zib2.customerid = 'PPG' THEN (CASE WHEN zib2.locationId LIKE 'C%' THEN 'WH-C' ELSE 'NON WH-C' END) WHEN zib2.customerId IN ('DNN_MDN') THEN (CASE WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10215338' THEN 'PREFORM 1500' WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10215336' THEN 'PREFORM 600' WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10425007' THEN 'CAPSHIELD' ELSE 'RESIN' END) WHEN zib2.customerId = 'MAP' THEN (CASE WHEN bsm1.tariffMasterId = 'BIL00062PT' THEN 'PT' ELSE 'GENRERAL' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila1.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      --				AND DATE(zib2.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --				AND CONVERT(zib2.StockDate, DATE) between '2025-05-01' and '2025-06-30'
      AND DATE(zib2.StockDate) >= IN_DateFrom
      AND DATE(zib2.StockDate) <= IN_DateTo
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND bl.workingArea NOT IN ('LTL-BULK')
      AND bsm1.tariffMasterId NOT IN ('BIL00062', 'BIL0006201', 'BIL0006202', 'BIL0006203', 'BIL0006204', 'BIL00062PIECES', 'BIL0006201PIECES', 'BIL0006202PIECES', 'BIL0006203PIECES', 'BIL0006204PIECES')
      -- and zib2.locationId not like 'K%'
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.SKU,
               zib2.SKUDesc,
               zib2.qtyonHand,
               zib2.UOM,
               zib2.muid,
               zib2.traceId,
               zib2.lotNum,
               zib2.packkey,
               zib2.StockDate,
               ila1.lotAtt04,
               ila1.lotAtt11,
               ila1.lotAtt07,
               zib2.locationId,
               zib2.locationCategory,
               bsm1.tariffMasterId,
               bs1.sku_group6
      ORDER BY StockDate,
      traceId ASC) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    --			AND DATE(zib3.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --		    and CONVERT(zib3.StockDate, DATE) between '2025-05-01' and '2025-06-30'
    AND DATE(zib3.StockDate) >= IN_DateFrom
    AND DATE(zib3.StockDate) <= IN_DateTo
    AND CASE WHEN zib3.customerId IN ('ECMAMA', 'ECMAMAB2C', 'MAPCLUB', 'PANDA') THEN zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'VT', 'CSG') ELSE zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'CSG') END
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.Storage_Type) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate,
           zib4.Storage_Type;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_qty_cbm, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_qty_cbm,
      v_chargeType;


    /*IF NOT EXISTS (SELECT
              1
            FROM Z_BIL_AKUM_DAYS_STORAGE zads1
            WHERE zads1.organizationId = v_organizationId
            AND zads1.warehouseId = v_warehouseId
            AND zads1.customerId = v_customerId
            -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
             AND DATE(zads1.StockDate) = v_stockDate) THEN
    /*    BLOCK2:
          BEGIN
            DECLARE cur_days CURSOR FOR
            SELECT DISTINCT 
    zads.organizationId,
    zads.warehouseId,
    zads.customerId,
    zads.StockDate,
    zads.qty_traceId,
    zads.qty_MUID,
    zads.chargeType,
    zads.addWHo,
    zads.addTime,
    zads.editWho,
    zads.editTime,
    zads.UDF01,
    zads.UDF02,
    zads.UDF03,
    zads.UDF04,
    zads.UDF05,
    zads.lotAtt01,
    zads.lotAtt02,
    zads.lotAtt03,
    zads.lotAtt05
            FROM Z_BIL_AKUM_DAYS_STORAGE zads
    		where 
    		zads.organizationId = v_organizationId
    		and zads.customerId = v_customerId
    		and zads.warehouseId = v_warehouseId
    		and CONVERT(zads.StockDate,DATE) between '2024-12-26' and '2025-01-25';
            DECLARE CONTINUE HANDLER FOR NOT FOUND SET days_done = 1;
    /*        SELECT
              'look->',
               days_done;
            SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd*/

    #
    /*        OPEN cur_days;testing insert
     */
    /*getDays:
      LOOP
        FETCH cur_days INTO R_organizationId,R_warehouseId,R_customerId,R_StockDate,R_qty_traceId,R_qty_MUID,R_chargeType,R_addWHo,R_addTime,R_editWho,R_editTime,
        R_UDF01,R_UDF02,R_UDF03,R_UDF04,R_UDF05,R_lotAtt01,R_lotAtt02,R_lotAtt03,R_lotAtt05;


        --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
        IF days_done THEN
          SET days_done = FALSE;
          LEAVE getDays;
        END IF;

          --           SELECT 'check 2=>',R_RESULTQTYCHARGE;*/

    /*W             IF EXISTS (SELECT
                      1
                    FROM Z_BIL_AKUM_DAYS_STORAGE zi6
                    WHERE zi6.organzationId = v_organizationId 
                    AND zi6.warehouseId = v_warehouseId
                    AND zi6.customerId = v_customerId
                    AND zi6.StockDate = v_StockDate) then
                  DELETE
                    FROM Z_BIL_AKUM_DAYS_STORAGE
                    WHERE organizationId = v_organizationId
                    AND warehouseId = v_warehouseId
                    AND customerId = v_customerId
                    AND StockDate = v_StockDate;
                END IF; -- EXISTstorage akum days 
                #
                  IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                    SET OUT_returnCode = '999#????????';
                    LEAVE read_loop;
                  END IF;
               /* SELECT
                  'DEBUG=>',
                  v_customerId,
                  R_CUSTOMERID,
                  R_WAREHOUSEID,
                  days_done,
                  v_warehouseId;*/

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_qty_cbm,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COUNT_DATE_RENT_PALLET_DAYS`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_DATE_RENT_PALLET_DAYS (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_DateFrom varchar(30),
IN IN_DateTo varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_chargeType varchar(255);
  DECLARE v_locType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    zib4.StockDate,
    CASE WHEN zib4.customerId = 'GMC' THEN SUM(zib4.qtyCharge_TraceId) - 100 ELSE SUM(zib4.qtyCharge_TraceId) END AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    zib4.locType,
    'RP' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib1.locationId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib1.muid) AS qtyCharge_MUID,
      zib1.locType
    FROM (SELECT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.muid AS muid,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        CASE WHEN zib.customerId = 'LTL' THEN (CASE WHEN zib.warehouseId = 'CBT01' AND
                  zib.locationId LIKE 'K%' THEN 'WH-K' ELSE 'NOT WH-K' END) ELSE 'GENERAL' END AS locType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      AND DATE(zib.StockDate) >= IN_DateFrom
      AND DATE(zib.StockDate) <= IN_DateTo
      --				AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --     			AND CONVERT(zib.StockDate, DATE) between '2025-05-26' and '2025-06-30'
      AND ila.lotAtt07 NOT IN ('O', 'OP', 'OL', 'OPC')
      AND zib.locationId NOT IN ('CONSWOR',
      'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20',
      'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02',
      'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03',
      'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25',
      'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND zib.locationCategory IN ('SD', 'DD', 'GR')
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.muid,
               zib.StockDate,
               zib.locationId
      ORDER BY StockDate ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseid = IN_WarehouseId
    AND DATE(zib1.StockDate) >= IN_DateFrom
    AND DATE(zib1.StockDate) <= IN_DateTo

    --			AND DATE(zib1.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --			and CONVERT(zib1.StockDate, DATE) between '2025-05-26' and '2025-06-30'
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.locType
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib3.traceId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib3.muid) AS qtyCharge_MUID,
      zib3.locType
    FROM (SELECT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.muid AS muid,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.traceId AS traceId,
        CASE WHEN zib2.customerId = 'LTL' THEN (CASE WHEN zib2.warehouseId = 'CBT01' AND
                  zib2.locationId LIKE 'K%' THEN 'WH-K' ELSE 'NOT WH-K' END) ELSE 'GENERAL' END AS locType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      AND ila1.lotAtt07 NOT IN ('O', 'OP', 'OL', 'OPC')
      AND DATE(zib2.StockDate) >= IN_DateFrom
      AND DATE(zib2.StockDate) <= IN_DateTo
      --				AND DATE(zib2.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      --				AND CONVERT(zib2.StockDate, DATE) between '2025-05-26' and '2025-06-30'
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      -- and ila1.lotAtt11 is not null
      -- and zib2.locationId not like 'K%'
      AND CASE WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C', 'MAPCLUB', 'PANDA') THEN zib2.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'VT') ELSE zib2.locationCategory IN ('BS', 'FS', 'DR', 'PK') END
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.muid,
               zib2.traceId,
               zib2.StockDate,
               zib2.locationId
      ORDER BY StockDate) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    AND DATE(zib3.StockDate) >= IN_DateFrom
    AND DATE(zib3.StockDate) <= IN_DateTo
    --			AND DATE(zib3.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --			and CONVERT(zib3.StockDate, DATE) between '2025-05-26' and '2025-06-30'
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.locType) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate,
           zib4.locType;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_locType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      R_CUSTOMERID,
      R_WAREHOUSEID,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_chargeType,
      v_locType;


    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_locType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COUNT_DATE_RENT_PALLET_BEBGBAL_STORAGE_IN`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_DATE_RENT_PALLET_BEBGBAL_STORAGE_IN (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_Date_From varchar(30),
IN IN_Date_To varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib.organizationId,
    zib.warehouseId,
    zib.customerId,
    DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
    COUNT(DISTINCT zib.traceId) AS qtyCharge_TraceId,
    COUNT(DISTINCT zib.muid) AS qtyCharge_MUID,
    SUM(zib.qty) AS qty,
    zib.Storage_Type,
    'RP' AS chargeType
  FROM (SELECT DISTINCT
      IFNULL(CAST(atl.organizationId AS char(255)), '') AS organizationId,
      IFNULL(CAST(atl.warehouseId AS char(255)), '') AS warehouseId,
      IFNULL(CAST(atl.tocustomerId AS char(255)), '') AS customerId,
      IFNULL(CAST(atl.toSku AS char(255)), '') AS sku,
      IFNULL(CAST(atl.toQty AS char(255)), 0) AS qtyReceived,
      IFNULL(CAST(atl.toUom AS char(255)), '') AS uom,
      IFNULL(CAST(atl.toQty_Each AS char(255)), 0) AS qty,
      CAST(DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') AS char(255)) AS stockDate,
      IFNULL(CAST(atl.toId AS char(255)), '') AS traceId,
      IFNULL(CAST(atl.tomuid AS char(255)), '') AS muid,
      IFNULL(CAST(atl.toLocation AS char(255)), '') AS locationId,
      IFNULL(CAST(ila.lotAtt07 AS char(255)), '') AS palletType,
      'DRY' AS Storage_Type
    FROM ACT_TRANSACTION_LOG atl
      LEFT JOIN INV_LOT_ATT ila
        ON ila.organizationId = atl.organizationId
        AND ila.lotNum = atl.toLotNum
        AND ila.customerId = atl.toCustomerId
    WHERE atl.organizationId = 'OJV_CML'
    AND atl.tocustomerId = 'ITOCHU'
    AND atl.warehouseId = 'CBT01'
    --			AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') BETWEEN '2025-06-26' AND '2025-07-25'
    AND atl.transactionType = 'IN'
    AND atl.STATUS IN ('80', '99')
    AND ila.lotAtt07 NOT IN ('O', 'OP', 'OL', 'OPC')) zib
  WHERE zib.organizationId = 'OJV_CML'
  AND zib.customerId = 'ITOCHU'
  AND zib.warehouseid = 'CBT01'
  AND zib.SKU NOT IN ('FULLCARTON')
  AND zib.SKU NOT LIKE '13%'
  AND zib.qty > 0
  --				AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
  --				AND CONVERT(zib.StockDate, DATE) between '2025-06-26' and '2025-07-25'
  AND CONVERT(zib.StockDate, date) >= IN_Date_From
  AND CONVERT(zib.StockDate, date) <= IN_Date_To
  AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01',
  'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
  -- AND bl.workingArea not in ('LTL-BULK')
  GROUP BY zib.organizationId,
           zib.StockDate,
           zib.warehouseId,
           zib.customerId,
           zib.Storage_Type;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_chargeType;

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        0.0,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  END LOOP;
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COUNT_DATE_BEBGBAL_STORAGE_IN`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_DATE_BEBGBAL_STORAGE_IN (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30),
IN IN_Date_From varchar(30),
IN IN_Date_To varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib.organizationId,
    zib.warehouseId,
    zib.customerId,
    DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
    COUNT(DISTINCT zib.traceId) AS qtyCharge_TraceId,
    COUNT(DISTINCT zib.muid) AS qtyCharge_MUID,
    SUM(zib.qty) AS qty,
    zib.Storage_Type,
    'STRG' AS chargeType
  FROM (SELECT DISTINCT
      IFNULL(CAST(atl.organizationId AS char(255)), '') AS organizationId,
      IFNULL(CAST(atl.warehouseId AS char(255)), '') AS warehouseId,
      IFNULL(CAST(atl.tocustomerId AS char(255)), '') AS customerId,
      IFNULL(CAST(atl.toSku AS char(255)), '') AS sku,
      IFNULL(CAST(atl.toQty AS char(255)), 0) AS qtyReceived,
      IFNULL(CAST(atl.toUom AS char(255)), '') AS uom,
      IFNULL(CAST(atl.toQty_Each AS char(255)), 0) AS qty,
      CAST(DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') AS char(255)) AS stockDate,
      IFNULL(CAST(atl.toId AS char(255)), '') AS traceId,
      IFNULL(CAST(atl.tomuid AS char(255)), '') AS muid,
      IFNULL(CAST(atl.toLocation AS char(255)), '') AS locationId,
      'DRY' AS Storage_Type
    FROM ACT_TRANSACTION_LOG atl
    WHERE atl.organizationId = IN_organizationId
    AND atl.tocustomerId = IN_CustomerId
    AND atl.warehouseId = IN_WarehouseId
    --			AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    --		    and DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') between '2025-06-26' and '2025-07-25'
    AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') >= IN_Date_From
    AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') <= IN_Date_To

    AND atl.transactionType = 'IN'
    AND atl.STATUS IN ('80', '99')) zib
  WHERE zib.organizationId = IN_organizationId
  AND zib.customerId = IN_CustomerId
  AND zib.warehouseid = IN_WarehouseId
  AND zib.SKU NOT IN ('FULLCARTON')
  AND zib.SKU NOT LIKE '13%'
  AND zib.qty > 0
  --				AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
  --				AND CONVERT(zib.StockDate, DATE) between '2025-06-26' and '2025-07-25'
  AND CONVERT(zib.StockDate, date) >= IN_Date_From
  AND CONVERT(zib.StockDate, date) <= IN_Date_To
  AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
  -- AND bl.workingArea not in ('LTL-BULK')
  GROUP BY zib.organizationId,
           zib.StockDate,
           zib.warehouseId,
           zib.customerId,
           zib.Storage_Type;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_chargeType;

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        0.0,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  END LOOP;
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COUNT_BEBGBAL_STORAGE_IN`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_COUNT_BEBGBAL_STORAGE_IN (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib.organizationId,
    zib.warehouseId,
    zib.customerId,
    DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
    COUNT(DISTINCT zib.traceId) AS qtyCharge_TraceId,
    COUNT(DISTINCT zib.muid) AS qtyCharge_MUID,
    SUM(zib.qty) AS qty,
    zib.Storage_Type,
    'STRG' AS chargeType
  FROM (SELECT DISTINCT
      IFNULL(CAST(atl.organizationId AS char(255)), '') AS organizationId,
      IFNULL(CAST(atl.warehouseId AS char(255)), '') AS warehouseId,
      IFNULL(CAST(atl.tocustomerId AS char(255)), '') AS customerId,
      IFNULL(CAST(atl.toSku AS char(255)), '') AS sku,
      IFNULL(CAST(atl.toQty AS char(255)), 0) AS qtyReceived,
      IFNULL(CAST(atl.toUom AS char(255)), '') AS uom,
      IFNULL(CAST(atl.toQty_Each AS char(255)), 0) AS qty,
      CAST(DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') AS char(255)) AS stockDate,
      IFNULL(CAST(atl.toId AS char(255)), '') AS traceId,
      IFNULL(CAST(atl.tomuid AS char(255)), '') AS muid,
      IFNULL(CAST(atl.toLocation AS char(255)), '') AS locationId,
      'DRY' AS Storage_Type
    FROM ACT_TRANSACTION_LOG atl
    WHERE atl.organizationId = 'OJV_CML'
    AND atl.tocustomerId = 'ITOCHU'
    AND atl.warehouseId = 'CBT01'
    --			AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND DATE_FORMAT(atl.transactionTime, '%Y-%m-%d') BETWEEN '2025-06-26' AND '2025-07-25'
    AND atl.transactionType = 'IN'
    AND atl.STATUS IN ('80', '99')) zib
  WHERE zib.organizationId = 'OJV_CML'
  AND zib.customerId = 'ITOCHU'
  AND zib.warehouseid = 'CBT01'
  AND zib.SKU NOT IN ('FULLCARTON')
  AND zib.SKU NOT LIKE '13%'
  AND zib.qty > 0
  --				AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
  AND CONVERT(zib.StockDate, date) BETWEEN '2025-06-26' AND '2025-07-25'
  AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
  -- AND bl.workingArea not in ('LTL-BULK')
  GROUP BY zib.organizationId,
           zib.StockDate,
           zib.warehouseId,
           zib.customerId,
           zib.Storage_Type;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_chargeType;

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        0.0,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  END LOOP;
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_COPY_ASNLINE`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_COPY_ASNLINE (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_asnNo varchar(20),
IN IN_sku varchar(50),
INOUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE v_po varchar(20);
    DECLARE v_poLine varchar(20);

    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#SPSO_CML_COPY_ASNLINE', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_returnCode;
    END;

    SET OUT_returnCode = '000';

    SELECT
      MIN(poNo),
      MIN(poLineNo)
    FROM DOC_ASN_DETAILS
    WHERE 1 = 1
    AND organizationId = IN_organizationId
    AND warehouseId = IN_warehouseId
    AND asnNo = IN_asnNo
    AND sku = IN_sku
    AND IFNULL(poNo, '') <> ''
    AND IFNULL(poLineNo, 0) <> 0 INTO v_po, v_poLine;

    IF IFNULL(v_po, '') <> ''
      AND IFNULL(v_poLine, 0) <> 0 THEN
      UPDATE DOC_ASN_DETAILS
      SET poNo = v_po,
          poLineNo = v_poLine
      WHERE 1 = 1
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND asnNo = IN_asnNo
      AND sku = IN_sku
      AND IFNULL(poNo, '') = ''
      AND IFNULL(poLineNo, 0) = 0;
    END IF;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_CANCEL_APPOINTMENT_DETAIL`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_CANCEL_APPOINTMENT_DETAIL (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_appointmentNo varchar(30),
IN IN_docNo varchar(30),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE OUT_ReturnNo varchar(40);
    DECLARE R_CurrentTime timestamp;
    DECLARE r_Count int;
    DECLARE r_CountExist int;
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_CANCEL_APPOINTMENT_DETAIL', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_docNo;
    END;
    IF IFNULL(IN_docNo, '') != '' THEN
      SET OUT_returnCode = '000';


      -- check order cancel or close
      SELECT
        COUNT(1)
      FROM DOC_ORDER_HEADER doh
      WHERE doh.orderNo = IN_docNo
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND doh.soStatus NOT IN ('05') INTO r_Count;


      IF r_Count <> 0 THEN
        SET OUT_returnCode = 'Cannot cancel detail appointment!';
        LEAVE ENDPROC;
      END IF;




      START TRANSACTION;
        SET OUT_Return_Code = '*_*';
        SET R_CurrentTime = NOW();

        -- delete appointment detail
        DELETE
          FROM DOC_APPOINTMENT_DETAILS
        WHERE appointmentNo = IN_appointmentNo
          AND docNo = IN_docNo
          AND warehouseId = IN_warehouseId;

        -- delete appointment detail

        DELETE
          FROM DOC_APPOINTMENT_SUBDETAILS
        WHERE appointmentNo = IN_appointmentNo
          AND poNo = IN_docNo
          AND warehouseId = IN_warehouseId;


        -- update ASN type

        UPDATE DOC_ASN_HEADER
        SET asnStatus = '00',
            editTime = NOW()
        WHERE organizationId = 'OJV_CML'
        AND warehouseId = IN_warehouseId
        AND asnNo = IN_docNo;

        -- insert to log

        INSERT INTO Z_LogUdfTran (docType
        , docNo
        , userId
        , lottable01
        , lottable02
        , addDate
        , addWho
        , editDate
        , editWho)
          VALUES ('ASN' -- docType - VARCHAR(255)
          , IN_docNo -- docNo - VARCHAR(255)
          , IN_userId -- userId - VARCHAR(255)
          , 'Cancel appointment document detail', 'CML_CANCEL_APPOINTMENT_DETAIL', NOW() -- addDate - DATETIME
          , 'EDI' -- addWho - VARCHAR(255)
          , NOW() -- editDate - DATETIME
          , 'EDI' -- editWho - VARCHAR(255)
          );



      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `CML_BIL_CHG_CONT`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_BIL_CHG_CONT (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_DOCNO varchar(100),
IN IN_DOCTYPE varchar(100),
IN IN_CUSTOMERID varchar(100),
IN IN_userid varchar(40),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE R_DOCNO varchar(100);
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;

    UPDATE BIL_SUMMARY A
    LEFT JOIN DOC_ASN_CONTAINER H1
      ON H1.ORGANIZATIONID = A.ORGANIZATIONID
      AND H1.WAREHOUSEID = A.WAREHOUSEID
      AND H1.ASNNO = A.DOCNO
      AND H1.CTNTYPE = A.containerType
      AND H1.CTNSIZE = A.containerSize
      AND A.docType = 'ASN'
    LEFT JOIN DOC_ORDER_CONTAINER H2
      ON H2.ORGANIZATIONID = A.ORGANIZATIONID
      AND H2.WAREHOUSEID = A.WAREHOUSEID
      AND H2.ORDERNO = A.DOCNO
      AND H2.CTNTYPE = A.containerType
      AND H2.CTNSIZE = A.containerSize
      AND A.docType = 'SO'
    LEFT JOIN BAS_CUSTOMER_MULTIWAREHOUSE B
      ON A.ORGANIZATIONID = B.ORGANIZATIONID
      AND A.CUSTOMERID = B.CUSTOMERID
      AND A.WAREHOUSEID = B.WAREHOUSEID
    LEFT JOIN BIL_TARIFF_HEADER C
      ON B.ORGANIZATIONID = C.ORGANIZATIONID
      AND B.TARIFFMASTERID = C.TARIFFMASTERID
    LEFT JOIN BIL_TARIFF_CONTAINER D
      ON C.ORGANIZATIONID = D.ORGANIZATIONID
      AND C.TARIFFID = D.TARIFFID
      AND D.CHARGECATEGORY = A.`chargeCategory`
      AND D.`chargeType` = A.`chargeType`
      AND D.containerType = A.containerType
      AND D.containerSize = A.containerSize
    SET A.udf01 = D.udf01,
        A.udf02 = D.udf02,
        A.udf04 = D.udf04
    WHERE A.`organizationId` = IN_organizationId
    AND A.`warehouseId` = IN_warehouseId
    AND A.docNo = IN_DOCNO
    AND A.chargeType IN ('IBCO', 'OBCO')
    AND TIMESTAMPDIFF(SECOND, C.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0
    AND TIMESTAMPDIFF(SECOND, C.effectiveTo, NOW()) / (60 * 60 * 24) <= 0;
    COMMIT;
    SET @countRow = ROW_COUNT();
    SELECT
      @countRow;
    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_BIL_CHG`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_BIL_CHG (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_DOCNO varchar(100),
IN IN_DOCTYPE varchar(100),
IN IN_CUSTOMERID varchar(100),
IN IN_userid varchar(40),
OUT OUT_returnCode varchar(1000))
END_PROC:
  BEGIN
    DECLARE R_DOCNO varchar(100);
    DECLARE v_error int;
    DECLARE v_errormessage varchar(1000);
    DECLARE v_NO_COMMIT char(1);

    -- -- MOVE FROM AF_CLOSE
    --   DECLARE R_STATUS VARCHAR (20) ;
    --   DECLARE r_SoStatus VARCHAR (20) ;
    --   DECLARE R_NROW INTEGER ;
    --   DECLARE R_NROW2 INTEGER ;
    --   DECLARE V_udf01 VARCHAR (100) ;
    --   DECLARE V_udf02 VARCHAR (100) ;
    --   DECLARE R_CURRENTDATE TIMESTAMP ;
    --   DECLARE R_BILLINGSUMMARYID2 VARCHAR (100) ;
    --   DECLARE R_FMDATE VARCHAR (10) ;
    --   DECLARE R_TODATE VARCHAR (10) ;
    --   DECLARE r_lotAtt07 VARCHAR (10) ;
    --   DECLARE r_lotnum VARCHAR (10) ;
    --   DECLARE r_transactionId VARCHAR (100) ;
    --   DECLARE R_FMDATE_D DATE ;
    --   DECLARE R_TODATE_D DATE ;
    --   DECLARE R_BILLINGDATE INTEGER ;
    --   DECLARE R_BILLINGMONTH VARCHAR (10) ;
    --   DECLARE R_CUSTOMER VARCHAR (30) ;
    --   DECLARE R_tariffId VARCHAR (10) ;
    --   DECLARE R_tariffLineNo INTEGER ;
    --   DECLARE R_docType VARCHAR (15) ;
    --   DECLARE R_minAmount DECIMAL (24, 8) ;
    --   DECLARE R_maxAmount DECIMAL (24, 8) ;
    --   DECLARE R_chargeCategory VARCHAR (20) ;
    --   DECLARE R_chargeType VARCHAR (20) ;
    --   DECLARE IN_language VARCHAR (20) DEFAULT 'en' ;
    --   DECLARE R_tariffClassNo VARCHAR (15) ;
    --   DECLARE R_classFrom DECIMAL (24, 8) ;
    --   DECLARE R_classTo DECIMAL (24, 8) ;
    --   DECLARE R_rate DECIMAL (24, 8) ;
    --   DECLARE R_cusAmount DECIMAL (24, 8) ;
    --   DECLARE R_QTY INTEGER ;
    --   DECLARE pallet_done INT DEFAULT FALSE ;
    --   -- DECLARE done INT DEFAULT FALSE ;
    --   -- MOVE FROM AF_CLOSE


    DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_error = 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_BIL_CHG',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_returnCode AS error;
    END;

    /*-- START: MOVE FROM AF_CLOSE
    BEGIN
  	DECLARE CUR_PALLET CURSOR FOR 
      SELECT 
        a.tolotnum,
        c.lotAtt07,
        a.transactionid 
      FROM
        ACT_TRANSACTION_LOG a 
        INNER JOIN INV_LOT_ATT c 
          ON a.organizationId = c.organizationId 
          AND a.toLotNum = c.lotnum 
          AND a.tocustomerId = c.customerId 
          AND a.tosku = c.sku 
      WHERE a.organizationId = IN_organizationId 
        AND a.warehouseId = IN_warehouseId 
        AND a.docNo = IN_DOCNO 
        AND a.transactionType = 'SO' 
        AND a.docType = 'SO' ;
      DECLARE CONTINUE HANDLER FOR NOT FOUND SET pallet_done = TRUE ;
      OPEN CUR_PALLET ;
      getPALLET :
      LOOP
        FETCH CUR_PALLET INTO r_lotnum,
        r_lotAtt07,
        r_transactionId ;
        IF pallet_done = TRUE 
        THEN LEAVE getPALLET ;
        END IF ;
        
        IF r_lotAtt07 = 'O' 
        THEN 
        UPDATE 
          ACT_TRANSACTION_LOG a 
        SET
          a.billingTranCategory = 'OP' 
        WHERE a.organizationId = IN_organizationId 
          AND a.warehouseId = IN_warehouseId 
          AND a.docNo = IN_DOCNO 
          AND a.tolotnum = r_lotnum 
          AND a.transactionId = r_transactionId 
          AND a.transactionType IN ('SO', 'KT', '99') 
          AND a.docType = 'SO' 
          AND a.status = '99' ;
        END IF ;
        IF r_lotAtt07 = 'R' 
        THEN 
        UPDATE 
          ACT_TRANSACTION_LOG a 
        SET
          a.billingTranCategory = 'RP' 
        WHERE a.organizationId = IN_organizationId 
          AND a.warehouseId = IN_warehouseId 
          AND a.docNo = IN_DOCNO 
          AND a.tolotnum = r_lotnum 
          AND a.docType = 'SO' 
          AND a.transactionId = r_transactionId 
          AND a.transactionType IN ('SO', 'KT', '99') 
          AND a.status = '99' ;
        END IF ;
      END LOOP getPALLET ;
      CLOSE CUR_PALLET ;
      COMMIT ;
    END;
    
    BEGIN
    SELECT 
      a.customerId INTO R_customer 
    FROM
      DOC_ORDER_DETAILS a 
    WHERE a.organizationId = 'OJV_CML' 
      AND a.warehouseId = IN_warehouseId 
      AND a.orderNo = IN_DOCNO 
    LIMIT 1 ;
    SELECT 
      IFNULL(b.tariffId, '*') tariffId INTO R_tariffId 
    FROM
      BAS_CUSTOMER_MULTIWAREHOUSE a 
      LEFT JOIN BIL_TARIFF_HEADER b 
        ON a.organizationId = b.organizationId 
        AND a.tariffMasterId = b.tariffMasterId 
    WHERE IFNULL(b.tariffId, '*') <> '*' 
      AND a.organizationId = 'OJV_CML' 
      AND a.warehouseId = IN_warehouseId 
      AND a.customerId = R_customer 
      AND TIMESTAMPDIFF(SECOND, b.effectiveFrom, NOW()) / (60 * 60 * 24) >= 0 
      AND TIMESTAMPDIFF(SECOND, b.effectiveTo, NOW()) / (60 * 60 * 24) <= 0 
    LIMIT 1 ;
    CALL SPCOM_GetIDSequence (
      IN_organizationId,
      IN_warehouseId,
      IN_language,
      'BILLINGSUMMARYID',
      R_BILLINGSUMMARYID2,
      OUT_returnCode
    ) ;
    IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' 
    THEN ROLLBACK ;
    LEAVE END_PROC ;
    END IF ;
    INSERT INTO BIL_SUMMARY (
      ORGANIZATIONID,
      WAREHOUSEID,
      BILLINGSUMMARYID,
      BILLINGFROMDATE,
      BILLINGTODATE,
      CUSTOMERID,
      TARIFFID,
      CHARGECATEGORY,
      CHARGETYPE,
      DESCR,
      DOCNO,
      DOCTYPE,
      RATEBASE,
      QTY,
      chargePerUnits,
      chargeRate,
      AMOUNT,
      BILLINGAMOUNT,
      ARNO,
      APNO,
      UDF01,
      UDF02,
      UDF04,
      COST,
      BILLTO,
      ADDWHO,
      EDITWHO,
      ADDTIME,
      EDITTIME
    ) 
    SELECT 
      H1.ORGANIZATIONID,
      H1.WAREHOUSEID,
      R_BILLINGSUMMARYID2,
      CURDATE(),
      CURDATE(),
      H1.CUSTOMERID,
      R_tariffid,
      D.CHARGECATEGORY,
      D.CHARGETYPE,
      D.DESCRC,
      H1.orderNo,
      'SO',
      'DO',
      '1',
      E.ratePerUnit,
      E.RATE,
      1 * E.RATE,
      1 * E.RATE,
      '*',
      '*',
      D.UDF01,
      D.UDF02,
      D.udf06,
      0,
      B.CUSTOMERID,
      'UDFTIMER',
      'UDFTIMER',
      NOW(),
      NOW() 
    FROM
      ACT_ALLOCATION_DETAILS H1 
      JOIN DOC_ORDER_HEADER H2 
        ON H1.ORGANIZATIONID = H2.ORGANIZATIONID 
        AND H1.WAREHOUSEID = H2.WAREHOUSEID 
        AND H1.CUSTOMERID = H2.CUSTOMERID 
        AND H1.ORDERNO = H2.ORDERNO 
      JOIN BAS_SKU_MULTIWAREHOUSE B 
        ON H1.ORGANIZATIONID = B.ORGANIZATIONID 
        AND H1.WAREHOUSEID = B.WAREHOUSEID 
        AND H1.CUSTOMERID = B.CUSTOMERID 
        AND H1.SKU = B.SKU 
      LEFT JOIN BIL_TARIFF_DETAILS D 
        ON B.ORGANIZATIONID = D.ORGANIZATIONID 
        AND D.CHARGECATEGORY = 'OB' 
        AND D.docType = H2.orderType 
        AND D.RATEBASE = 'DO' 
      LEFT JOIN BIL_TARIFF_RATE E 
        ON E.ORGANIZATIONID = D.ORGANIZATIONID 
        AND E.TARIFFID = D.TARIFFID 
        AND E.TARIFFLINENO = D.TARIFFLINENO 
    WHERE H1.ORGANIZATIONID = 'OJV_CML' 
      AND H1.warehouseId = IN_warehouseId 
      AND H1.orderNo = IN_DOCNO 
      AND D.tariffid = R_tariffId 
      AND D.rateBase = 'DO' 
    GROUP BY H1.orderNo,
      B.customerId,
      D.chargeType,
      D.descrC,
      E.rate,
      D.udf01,
      D.udf02,
      D.udf06,
      E.ratePerUnit;  
    END;
    -- END: MOVE FROM AF_CLOSE */


    BEGIN
      UPDATE BIL_SUMMARY A
      LEFT JOIN BIL_TARIFF_DETAILS D
        ON A.ORGANIZATIONID = D.ORGANIZATIONID
        AND A.TARIFFID = D.TARIFFID
        AND D.CHARGECATEGORY = A.`chargeCategory`
        AND D.`chargeType` = A.`chargeType`
        AND D.RATEBASE = A.RATEBASE
      SET A.UDF01 = D.UDF01,
          A.UDF02 = D.UDF02,
          A.UDF04 = D.UDF06
      WHERE A.ORGANIZATIONID = 'OJV_CML'
      AND A.WAREHOUSEID = IN_warehouseId
      AND A.CUSTOMERID = IN_CUSTOMERID
      AND A.DOCNO = IN_DOCNO
      AND A.DOCTYPE = IN_DOCTYPE;

      COMMIT;
      SET @countRow = ROW_COUNT();
      SELECT
        @countRow;
    END;

    SET OUT_returnCode = '000';
  END
  $$

--
-- Create procedure `CML_BILLSTORAGE_SAVEDAILY_STORAGEPCS`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLSTORAGE_SAVEDAILY_STORAGEPCS (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(30),
IN IN_language varchar(30),
IN IN_customerId varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE v_stockDate date;
  DECLARE v_customerId varchar(20);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_skuGroup1 varchar(255);
  DECLARE v_qtyCharge decimal(18, 4);
  DECLARE v_storagetype varchar(100);
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR

  SELECT
    DATE_FORMAT(ls_storage.stockdate, '%Y-%m-%d') AS stockDate,
    ls_storage.warehouseid,
    ls_storage.customerid,
    ls_storage.storage_type,
    SUM(ls_storage.qtyonhand)
  FROM (SELECT
      DATE_FORMAT(stockDate, '%Y-%m-%d') AS stockdate,
      zib.customerId,
      zib.warehouseId AS warehouseid,
      CASE zib.customerId WHEN 'MAP' THEN (
            CASE WHEN la.lotatt04 = 'SET' THEN 0 ELSE (s.cube * zib.qtyonHand) END
            ) WHEN 'ONDULINE' THEN s.cube * zib.qtyonHand ELSE totalcube END AS qtycbm,
      zib.qtyonHand AS qtyonhand,

      CASE WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
            CASE WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-01' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-03' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-05' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-07' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E08%' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E09%' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) ELSE 'DRY' END AS storage_type
    FROM Z_InventoryBalance zib
      LEFT JOIN INV_LOT_ATT la
        ON la.organizationId = zib.organizationId
        AND la.customerId = zib.customerId
        AND la.sku = zib.sku
        AND la.lotNum = zib.lotNum
      LEFT JOIN BAS_LOCATION l
        ON l.organizationId = zib.organizationId
        AND l.locationId = zib.locationId
        AND l.warehouseId = zib.warehouseId
      LEFT JOIN BAS_SKU s
        ON s.organizationId = zib.organizationId
        AND s.customerId = zib.customerId
        AND s.sku = zib.sku
    WHERE zib.organizationId = 'OJV_CML'
    --       AND DATE(zib.StockDate) >= '2025-04-26'
    --       AND DATE(zib.StockDate) <= '2025-05-20'
    -- AND zib.warehouseId IN ('LADC01')
    --  AND zib.warehouseId IN ('CBT02', 'CBT03', 'LADC01','CBT02-B2C')
    AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND zib.customerId = IN_customerId
    AND qtyonHand > 0
    AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATIONCBT02', 'SORTATIONCBT03', 'SORTATION', 'SORTATIONMRD02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA', 'B04A065', 'B04A066', 'B04B065', 'B04B065')
    AND zib.sku NOT IN (SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationId = zib.organizationId
      AND customerId = 'LTL'
      AND sku LIKE '13%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationid = zib.organizationId
      AND customerid = 'SMARTSBY'
      AND sku = 'PALLET'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('ECMAMA', 'ECMAMAB2C')
      AND sku LIKE '%TEST%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('MAP')
      AND sku IN ('DEMO TABLE AT', 'DEMO TABLE SAM', 'HOT STAMP'))
    ORDER BY zib.customerId) ls_storage
  GROUP BY ls_storage.warehouseId,
           ls_storage.customerId,
           ls_storage.StockDate,
           ls_storage.storage_type
  ORDER BY ls_storage.warehouseId, ls_storage.customerId, stockDate, ls_storage.storage_type;
  -- Declare a handler for NOT FOUND condition
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_stockDate, v_warehouseId, v_customerId, v_storagetype, v_qtyCharge;



    IF done = 1 THEN
      LEAVE read_loop;
    END IF;


    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId
    , warehouseId
    , customerId
    , StockDate
    , qty
    , chargeType
    , addWho
    , addTime
    , editWho
    , editTime
    , UDF01)
      VALUES ('OJV_CML', v_warehouseId, v_customerId, v_stockDate -- StockDate - DATE
      , v_qtyCharge -- qty_cbm - DECIMAL(18, 8)
      , 'STRG' -- chargeType - VARCHAR(10) NOT NULL
      , 'CUSTOMBILL' -- addWho - VARCHAR(100)
      , NOW() -- addTime - DATETIME
      , 'CUSTOMBILL' -- editWho - VARCHAR(100)
      , NOW() -- editTime - DATETIME
      , v_storagetype -- UDF01 - VARCHAR(100)
      );


  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BILLSTORAGE_SAVEDAILY_STORAGECBM`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_BILLSTORAGE_SAVEDAILY_STORAGECBM (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(30),
IN IN_language varchar(30),
IN IN_customerId varchar(30))
BEGIN
  -- Declare variables to hold cursor data
  DECLARE done int DEFAULT 0;
  DECLARE tariff_done int DEFAULT 0;
  DECLARE v_stockDate date;
  DECLARE v_customerId varchar(20);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_skuGroup1 varchar(255);
  DECLARE v_qtyCharge decimal(18, 4);
  DECLARE v_storagetype varchar(100);
  DECLARE OUT_returnCode varchar(1000);


  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR

  SELECT
    DATE_FORMAT(ls_storage.stockdate, '%Y-%m-%d') AS stockDate,
    ls_storage.warehouseid,
    ls_storage.customerid,
    ls_storage.storage_type,
    SUM(ls_storage.qtycbm) AS qtycbm
  FROM (SELECT
      DATE_FORMAT(stockDate, '%Y-%m-%d') AS stockdate,
      zib.customerId,
      zib.warehouseId AS warehouseid,
      CASE zib.customerId WHEN 'MAP' THEN (
            CASE WHEN la.lotatt04 = 'SET' THEN 0 ELSE (s.cube * zib.qtyonHand) END
            ) WHEN 'ONDULINE' THEN s.cube * zib.qtyonHand ELSE totalcube END AS qtycbm,
      CASE WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
            CASE WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-01' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-03' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-05' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-07' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E08%' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E09%' AND
                s.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) ELSE 'DRY' END AS storage_type
    FROM Z_InventoryBalance zib
      LEFT JOIN INV_LOT_ATT la
        ON la.organizationId = zib.organizationId
        AND la.customerId = zib.customerId
        AND la.sku = zib.sku
        AND la.lotNum = zib.lotNum
      LEFT JOIN BAS_LOCATION l
        ON l.organizationId = zib.organizationId
        AND l.locationId = zib.locationId
        AND l.warehouseId = zib.warehouseId
      LEFT JOIN BAS_SKU s
        ON s.organizationId = zib.organizationId
        AND s.customerId = zib.customerId
        AND s.sku = zib.sku
    WHERE zib.organizationId = IN_organizationId
    --   AND DATE(zib.StockDate) >= '2025-04-26'
    --   AND DATE(zib.StockDate) <= '2025-05-18'
    -- AND zib.warehouseId IN ('LADC01')
    --  AND zib.warehouseId IN ('CBT02', 'CBT03', 'LADC01','CBT02-B2C')
    AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND zib.customerId = IN_CustomerId
    AND qtyonHand > 0
    AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATIONCBT02', 'SORTATIONCBT03', 'SORTATION', 'SORTATIONMRD02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA', 'B04A065', 'B04A066', 'B04B065', 'B04B065')
    AND zib.sku NOT IN (SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationId = zib.organizationId
      AND customerId = 'LTL'
      AND sku LIKE '13%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU bs2
      WHERE organizationid = zib.organizationId
      AND customerid = 'SMARTSBY'
      AND sku = 'PALLET'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('ECMAMA', 'ECMAMAB2C')
      AND sku LIKE '%TEST%'
      UNION ALL
      SELECT
        sku
      FROM BAS_SKU
      WHERE organizationid = zib.organizationId
      AND customerid IN ('MAP')
      AND sku IN ('DEMO TABLE AT', 'DEMO TABLE SAM', 'HOT STAMP'))
    ORDER BY zib.customerId) ls_storage
  GROUP BY ls_storage.warehouseId,
           ls_storage.customerId,
           ls_storage.StockDate,
           ls_storage.storage_type
  ORDER BY ls_storage.warehouseId, ls_storage.customerId, stockDate, ls_storage.storage_type;
  -- Declare a handler for NOT FOUND condition
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_stockDate, v_warehouseId, v_customerId, v_storagetype, v_qtyCharge;



    IF done = 1 THEN
      LEAVE read_loop;
    END IF;


    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId
    , warehouseId
    , customerId
    , StockDate
    , qty_cbm
    , chargeType
    , addWho
    , addTime
    , editWho
    , editTime
    , UDF01)
      VALUES ('OJV_CML', v_warehouseId, v_customerId, v_stockDate -- StockDate - DATE
      , v_qtyCharge -- qty_cbm - DECIMAL(18, 8)
      , 'STRG' -- chargeType - VARCHAR(10) NOT NULL
      , 'CUSTOMBILL' -- addWho - VARCHAR(100)
      , NOW() -- addTime - DATETIME
      , 'CUSTOMBILL' -- editWho - VARCHAR(100)
      , NOW() -- editTime - DATETIME
      , v_storagetype -- UDF01 - VARCHAR(100)
      );


  END LOOP;

  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BEGBAL_STORAGE_250725`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_BEGBAL_STORAGE_250725 (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    zib4.StockDate,
    CASE WHEN zib4.customerId = 'GMC' AND
        zib4.warehouseId = 'CBT01' THEN SUM(zib4.qtyCharge_TraceId) - 100 ELSE SUM(zib4.qtyCharge_TraceId) END AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    SUM(zib4.qty) AS qty,
    SUM(zib4.qtycbm) AS qtycbm,
    zib4.Storage_Type,
    'STRG' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib1.locationId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib1.muid) AS qtyCharge_MUID,
      SUM(zib1.qty) AS qty,
      SUM(zib1.qty_cbm) AS qtycbm,
      zib1.Storage_Type
    FROM (SELECT
      DISTINCT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.sku AS SKU,
        zib.SKUDesc AS SKUDesc,
        zib.UOM AS UOM,
        SUM(zib.qtyonHand) AS qtyonHand,
        zib.muid AS muid,
        zib.traceId AS traceId,
        zib.lotNum AS lotNum,
        zib.packkey AS packkey,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        zib.locationCategory AS locationCategory,
        ila.lotAtt04 AS batch,
        ila.lotAtt11 AS owner,
        ila.lotAtt07 AS lotAtt07,
        CASE WHEN zib.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd.uomdescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomdescr = 'LT' THEN zib.qtyOnHand ELSE (
                  zib.qtyOnHand * bs.netweight) END) WHEN zib.customerId IN ('MDS') THEN (CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand ELSE (zib.qtyOnHand) * bs.sku_group6 END) WHEN zib.customerId IN ('PACIFICPAINT') THEN (zib.qtyOnHand * bs.grossweight) WHEN zib.customerId IN ('GCM') THEN (CASE WHEN bpd.uomDescr = 'ZK' THEN zib.qtyOnHand * bs.grossweight WHEN bpd.uomDescr = 'EA' THEN zib.qtyOnHand * bs.grossweight ELSE (zib.qtyOnHand) END) WHEN zib.customerId IN ('TUMI') THEN (zib.qtyOnHand) WHEN zib.customerId IN ('BMM_JKT') THEN (zib.qtyOnHand / 1000) WHEN zib.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'LT' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'L' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'G' THEN zib.qtyOnHand / 1000 WHEN
                  bpd.uomDescr = 'MT' THEN zib.qtyOnHand * 1000 ELSE (
                  zib.qtyOnHand * bs.grossweight) END) WHEN
            zib.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'PC' THEN (zib.qtyOnHand * (CAST((
                    CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN bs.sku_group6 IS NULL THEN 0 ELSE bs.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'EA' THEN (zib.qtyOnHand * (CAST((CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN
                        bs.sku_group6 IS
                        NULL THEN 0 ELSE bs.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib.qtyOnHand END) WHEN zib.customerId = 'TMB_SMG' THEN (zib.qtyOnHand) WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib.qtyOnHand) ELSE (zib.qtyOnHand) END AS qty,
        -- case when zib.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm.packId LIKE '1/%' THEN ROUND(zib.qtyonHand * bs.`cube`, 6) ELSE ROUND(zib.qtyonHand * (bs.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E08%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E09%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib.customerId = 'MAPCLUB' THEN (CASE WHEN zib.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) WHEN zib.customerid = 'PPG' THEN (CASE WHEN zib.locationId LIKE 'C%' THEN 'WH-C' ELSE 'NON WH-C' END) WHEN zib.customerId IN ('DNN_MDN') THEN (CASE WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10215338' THEN 'PREFORM 1500' WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10215336' THEN 'PREFORM 600' WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10425007' THEN 'CAPSHIELD' ELSE 'RESIN' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      --				AND DATE(zib.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      AND CONVERT(zib.StockDate, date) BETWEEN '2025-05-25' AND '2025-05-25'
      AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND bl.workingArea NOT IN ('LTL-BULK')
      -- and zib.locationId not like 'K%'
      -- and ila.lotAtt11 is not null
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.SKU,
               zib.SKUDesc,
               zib.qtyonHand,
               zib.UOM,
               zib.muid,
               zib.traceId,
               zib.lotNum,
               zib.packkey,
               zib.StockDate,
               ila.lotAtt04,
               ila.lotAtt11,
               ila.lotAtt07,
               zib.locationId,
               zib.locationCategory,
               bsm.tariffMasterId,
               bs.sku_group6
      ORDER BY StockDate,
      locationId ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseId = IN_WarehouseId
    --			AND DATE(zib1.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND CONVERT(zib1.StockDate, date) BETWEEN '2025-05-25' AND '2025-05-25'
    AND zib1.locationCategory IN ('SD', 'DD', 'GR')
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.Storage_Type
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib3.traceId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib3.muid) AS qtyCharge_MUID,
      SUM(zib3.qty) AS qty,
      SUM(zib3.qty_cbm) AS qtycbm,
      zib3.Storage_Type
    FROM (SELECT
      DISTINCT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.sku AS SKU,
        zib2.SKUDesc AS SKUDesc,
        zib2.UOM AS UOM,
        SUM(zib2.qtyonHand) AS qtyonHand,
        zib2.muid AS muid,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'FMI_JKT') THEN '' ELSE zib2.traceId END AS traceId,
        zib2.lotNum AS lotNum,
        zib2.packkey AS packkey,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.locationId AS locationId,
        zib2.locationCategory AS locationCategory,
        ila1.lotAtt04 AS batch,
        ila1.lotAtt11 AS owner,
        ila1.lotAtt07 AS lotAtt07,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd1.uomdescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomdescr = 'LT' THEN zib2.qtyOnHand ELSE (
                  zib2.qtyOnHand * bs1.netweight) END) WHEN zib2.customerId IN ('MDS') THEN (CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand ELSE (zib2.qtyOnHand) * bs1.sku_group6 END) WHEN zib2.customerId IN ('PACIFICPAINT') THEN (zib2.qtyOnHand * bs1.grossweight) WHEN zib2.customerId IN ('GCM') THEN (CASE WHEN bpd1.uomDescr = 'ZK' THEN zib2.qtyOnHand * bs1.grossweight WHEN bpd1.uomDescr = 'EA' THEN zib2.qtyOnHand * bs1.grossweight ELSE (zib2.qtyOnHand) END) WHEN zib2.customerId IN ('TUMI') THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('BMM_JKT') THEN (zib2.qtyOnHand / 1000) WHEN zib2.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'LT' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'L' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'G' THEN zib2.qtyOnHand / 1000 WHEN
                  bpd1.uomDescr = 'MT' THEN zib2.qtyOnHand * 1000 ELSE (
                  zib2.qtyOnHand * bs1.grossweight) END) WHEN
            zib2.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'PC' THEN (zib2.qtyOnHand * (CAST((
                    CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN bs1.sku_group6 IS NULL THEN 0 ELSE bs1.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'EA' THEN (zib2.qtyOnHand * (CAST((CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN
                        bs1.sku_group6 IS
                        NULL THEN 0 ELSE bs1.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib2.qtyOnHand END) WHEN zib2.customerId = 'TMB_SMG' THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib2.qtyOnHand) ELSE (zib2.qtyOnHand) END AS qty,
        -- case when zib2.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm1.packId LIKE '1/%' THEN ROUND(zib2.qtyonHand * bs1.`cube`, 6) ELSE ROUND(zib2.qtyonHand * (bs1.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E08%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E09%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib2.customerId = 'MAPCLUB' THEN (CASE WHEN zib2.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) WHEN zib2.customerid = 'PPG' THEN (CASE WHEN zib2.locationId LIKE 'C%' THEN 'WH-C' ELSE 'NON WH-C' END) WHEN zib2.customerId IN ('DNN_MDN') THEN (CASE WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10215338' THEN 'PREFORM 1500' WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10215336' THEN 'PREFORM 600' WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10425007' THEN 'CAPSHIELD' ELSE 'RESIN' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila1.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      --					AND DATE(zib2.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
      AND CONVERT(zib2.StockDate, date) BETWEEN '2025-05-25' AND '2025-05-25'
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND bl.workingArea NOT IN ('LTL-BULK')
      -- and zib2.locationId not like 'K%'
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.SKU,
               zib2.SKUDesc,
               zib2.qtyonHand,
               zib2.UOM,
               zib2.muid,
               zib2.traceId,
               zib2.lotNum,
               zib2.packkey,
               zib2.StockDate,
               ila1.lotAtt04,
               ila1.lotAtt11,
               ila1.lotAtt07,
               zib2.locationId,
               zib2.locationCategory,
               bsm1.tariffMasterId,
               bs1.sku_group6
      ORDER BY StockDate,
      traceId ASC) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    --			AND DATE(zib3.StockDate) = DATE(DATE_ADD(NOW(), INTERVAL -1 DAY))
    AND CONVERT(zib3.StockDate, date) BETWEEN '2025-05-25' AND '2025-05-25'
    AND CASE WHEN zib3.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'VT', 'CSG') ELSE zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'CSG') END
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.Storage_Type) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate,
           zib4.Storage_Type;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_qty_cbm, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_qty_cbm,
      v_chargeType;


    /*IF NOT EXISTS (SELECT
              1
            FROM Z_BIL_AKUM_DAYS_STORAGE zads1
            WHERE zads1.organizationId = v_organizationId
            AND zads1.warehouseId = v_warehouseId
            AND zads1.customerId = v_customerId
            -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
             AND DATE(zads1.StockDate) = v_stockDate) THEN
    /*    BLOCK2:
          BEGIN
            DECLARE cur_days CURSOR FOR
            SELECT DISTINCT 
    zads.organizationId,
    zads.warehouseId,
    zads.customerId,
    zads.StockDate,
    zads.qty_traceId,
    zads.qty_MUID,
    zads.chargeType,
    zads.addWHo,
    zads.addTime,
    zads.editWho,
    zads.editTime,
    zads.UDF01,
    zads.UDF02,
    zads.UDF03,
    zads.UDF04,
    zads.UDF05,
    zads.lotAtt01,
    zads.lotAtt02,
    zads.lotAtt03,
    zads.lotAtt05
            FROM Z_BIL_AKUM_DAYS_STORAGE zads
    		where 
    		zads.organizationId = v_organizationId
    		and zads.customerId = v_customerId
    		and zads.warehouseId = v_warehouseId
    		and CONVERT(zads.StockDate,DATE) between '2024-12-26' and '2025-01-25';
            DECLARE CONTINUE HANDLER FOR NOT FOUND SET days_done = 1;
    /*        SELECT
              'look->',
               days_done;
            SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd*/

    #
    /*        OPEN cur_days;testing insert
     */
    /*getDays:
      LOOP
        FETCH cur_days INTO R_organizationId,R_warehouseId,R_customerId,R_StockDate,R_qty_traceId,R_qty_MUID,R_chargeType,R_addWHo,R_addTime,R_editWho,R_editTime,
        R_UDF01,R_UDF02,R_UDF03,R_UDF04,R_UDF05,R_lotAtt01,R_lotAtt02,R_lotAtt03,R_lotAtt05;


        --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
        IF days_done THEN
          SET days_done = FALSE;
          LEAVE getDays;
        END IF;

          --           SELECT 'check 2=>',R_RESULTQTYCHARGE;*/

    /*W             IF EXISTS (SELECT
                      1
                    FROM Z_BIL_AKUM_DAYS_STORAGE zi6
                    WHERE zi6.organzationId = v_organizationId 
                    AND zi6.warehouseId = v_warehouseId
                    AND zi6.customerId = v_customerId
                    AND zi6.StockDate = v_StockDate) then
                  DELETE
                    FROM Z_BIL_AKUM_DAYS_STORAGE
                    WHERE organizationId = v_organizationId
                    AND warehouseId = v_warehouseId
                    AND customerId = v_customerId
                    AND StockDate = v_StockDate;
                END IF; -- EXISTstorage akum days 
                #
                  IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                    SET OUT_returnCode = '999#????????';
                    LEAVE read_loop;
                  END IF;
               /* SELECT
                  'DEBUG=>',
                  v_customerId,
                  R_CUSTOMERID,
                  R_WAREHOUSEID,
                  days_done,
                  v_warehouseId;*/

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_qty_cbm,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_BEGBAL_STORAGE`
--
CREATE
DEFINER = 'it.ari'@'%'
PROCEDURE CML_BEGBAL_STORAGE (IN IN_organizationId varchar(30),
IN IN_WarehouseId varchar(30),
IN IN_Language varchar(30),
IN IN_CustomerId varchar(30))
BEGIN
  DECLARE done int DEFAULT 0;
  DECLARE days_done int DEFAULT 0;
  DECLARE v_organizationId varchar(255);
  DECLARE v_warehouseId varchar(20);
  DECLARE v_customerId varchar(20);
  DECLARE v_stockDate date;
  DECLARE v_qty_TraceId varchar(255);
  DECLARE v_qty_MUID varchar(255);
  DECLARE v_qty varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_qty_cbm varchar(255); /*additional for maxqty AB 25/05/14*/
  DECLARE v_storageType varchar(255); /*additional storage type for identification cold,ambient,dry AB 25/05/16*/
  DECLARE v_chargeType varchar(255);

  /*Creator AB 25/01/18*/
  -- Declare for Billing
  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_CURRENTDATE date;
  DECLARE R_qty_traceId int(11);
  DECLARE R_qty_MUID int(11);
  DECLARE R_qty double(11, 6);
  DECLARE R_chargeType varchar(20);
  DECLARE R_addWHo varchar(50);
  DECLARE R_addTime timestamp;
  DECLARE R_editWho varchar(50);
  DECLARE R_editTime timestamp;
  DECLARE R_UDF01 varchar(50);
  DECLARE R_UDF02 varchar(50);
  DECLARE R_UDF03 varchar(50);
  DECLARE R_UDF04 varchar(50);
  DECLARE R_UDF05 varchar(50);
  DECLARE R_lotAtt01 varchar(50);
  DECLARE R_lotAtt02 varchar(50);
  DECLARE R_lotAtt03 varchar(50);
  DECLARE R_lotAtt05 varchar(50);
  DECLARE R_NROW integer;
  DECLARE OUT_returnCode varchar(1000);

  -- Declare the cursor
  DECLARE my_cursor CURSOR FOR
  SELECT
    zib4.organizationId,
    zib4.warehouseId,
    zib4.customerId,
    DATE_FORMAT(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), '%Y-%m-%d') AS stockDate,
    CASE WHEN zib4.customerId = 'GMC' AND
        zib4.warehouseId = 'CBT01' THEN SUM(zib4.qtyCharge_TraceId) - 100 ELSE SUM(zib4.qtyCharge_TraceId) END AS qty_TraceId,
    SUM(zib4.qtyCharge_MUID) AS qty_MUID,
    SUM(zib4.qty) AS qty,
    SUM(zib4.qtycbm) AS qtycbm,
    zib4.Storage_Type,
    'STRG' AS chargeType
  FROM (SELECT
      zib1.organizationId,
      zib1.warehouseId,
      zib1.customerId,
      DATE_FORMAT(zib1.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib1.locationId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib1.muid) AS qtyCharge_MUID,
      SUM(zib1.qty) AS qty,
      SUM(zib1.qty_cbm) AS qtycbm,
      zib1.Storage_Type
    FROM (SELECT
      DISTINCT
        zib.customerId AS customerId,
        zib.warehouseId AS warehouseId,
        zib.organizationId AS organizationId,
        zib.sku AS SKU,
        zib.SKUDesc AS SKUDesc,
        zib.UOM AS UOM,
        SUM(zib.qtyonHand) AS qtyonHand,
        zib.muid AS muid,
        zib.traceId AS traceId,
        zib.lotNum AS lotNum,
        zib.packkey AS packkey,
        DATE_FORMAT(zib.StockDate, '%Y-%m-%d') AS StockDate,
        zib.locationId AS locationId,
        zib.locationCategory AS locationCategory,
        ila.lotAtt04 AS batch,
        ila.lotAtt11 AS owner,
        ila.lotAtt07 AS lotAtt07,
        CASE WHEN zib.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd.uomdescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomdescr = 'LT' THEN zib.qtyOnHand ELSE (
                  zib.qtyOnHand * bs.netweight) END) WHEN zib.customerId IN ('MDS') THEN (CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand ELSE (zib.qtyOnHand) * bs.sku_group6 END) WHEN zib.customerId IN ('PACIFICPAINT') THEN (zib.qtyOnHand * bs.grossweight) WHEN zib.customerId IN ('GCM') THEN (CASE WHEN bpd.uomDescr = 'ZK' THEN zib.qtyOnHand * bs.grossweight WHEN bpd.uomDescr = 'EA' THEN zib.qtyOnHand * bs.grossweight ELSE (zib.qtyOnHand) END) WHEN zib.customerId IN ('TUMI') THEN (zib.qtyOnHand) WHEN zib.customerId IN ('BMM_JKT') THEN (zib.qtyOnHand / 1000) WHEN zib.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd.uomDescr = 'KG' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'LT' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'L' THEN zib.qtyOnHand WHEN
                  bpd.uomDescr = 'G' THEN zib.qtyOnHand / 1000 WHEN
                  bpd.uomDescr = 'MT' THEN zib.qtyOnHand * 1000 ELSE (
                  zib.qtyOnHand * bs.grossweight) END) WHEN
            zib.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'PC' THEN (zib.qtyOnHand * (CAST((
                    CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN bs.sku_group6 IS NULL THEN 0 ELSE bs.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd.uomDescr, 1, 2) = 'EA' THEN (zib.qtyOnHand * (CAST((CASE WHEN bs.sku_group6 = ' ' THEN 0 WHEN bs.sku_group6 = '' THEN 0 WHEN
                        bs.sku_group6 IS
                        NULL THEN 0 ELSE bs.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib.qtyOnHand END) WHEN zib.customerId = 'TMB_SMG' THEN (zib.qtyOnHand) WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib.qtyOnHand) ELSE (zib.qtyOnHand) END AS qty,
        -- case when zib.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm.packId LIKE '1/%' THEN ROUND(zib.qtyonHand * bs.`cube`, 6) ELSE ROUND(zib.qtyonHand * (bs.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E08%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib.locationId LIKE 'E09%' AND
                  bs.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib.customerId = 'MAPCLUB' THEN (CASE WHEN zib.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) WHEN zib.customerid = 'PPG' THEN (CASE WHEN zib.locationId LIKE 'C%' THEN 'WH-C' ELSE 'NON WH-C' END) WHEN zib.customerId IN ('DNN_MDN') THEN (CASE WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10215338' THEN 'PREFORM 1500' WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10215336' THEN 'PREFORM 600' WHEN zib.warehouseId = 'KIMSTR' AND
                  bsm.tariffMasterId = 'BIL00085SFG' AND
                  bs.sku = '10425007' THEN 'CAPSHIELD' ELSE 'RESIN' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib
        LEFT JOIN BAS_SKU AS bs
          ON bs.organizationId = zib.organizationId
          AND bs.sku = zib.sku
          AND bs.customerId = zib.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm
          ON bsm.organizationId = zib.organizationId
          AND bsm.sku = zib.sku
          AND bsm.customerId = zib.customerId
          AND bsm.warehouseId = zib.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd
          ON bpd.organizationId = bsm.organizationId
          AND bpd.packId = bsm.packId
          AND bpd.customerId = bsm.customerId
          AND bpd.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila
          ON ila.organizationId = zib.organizationId
          AND ila.SKU = zib.SKU
          AND ila.lotnum = zib.lotnum
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib.organizationId
          AND bl.warehouseId = zib.warehouseId
          AND bl.locationId = zib.locationId
      WHERE zib.organizationId = IN_organizationId
      AND zib.customerId = IN_CustomerId
      AND zib.warehouseid = IN_WarehouseId
      AND zib.SKU NOT IN ('FULLCARTON')
      AND zib.SKU NOT LIKE '13%'
      AND zib.qtyOnHand > 0
      AND zib.StockDate = DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d')

      -- AND DATE(zib.StockDate) = DATE(DATE_ADD(DATE_ADD(NOW(), INTERVAL -1 MONTH,interval - 1 day, '%Y-%m-%d'))
      -- AND CONVERT(zib.StockDate, DATE) between '2025-05-25' and '2025-05-25'
      AND zib.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND bl.workingArea NOT IN ('LTL-BULK')
      -- and zib.locationId not like 'K%'
      -- and ila.lotAtt11 is not null
      GROUP BY zib.customerId,
               zib.warehouseId,
               zib.organizationId,
               zib.SKU,
               zib.SKUDesc,
               zib.qtyonHand,
               zib.UOM,
               zib.muid,
               zib.traceId,
               zib.lotNum,
               zib.packkey,
               zib.StockDate,
               ila.lotAtt04,
               ila.lotAtt11,
               ila.lotAtt07,
               zib.locationId,
               zib.locationCategory,
               bsm.tariffMasterId,
               bs.sku_group6
      ORDER BY StockDate,
      locationId ASC) zib1
    WHERE zib1.organizationId = IN_organizationId
    AND zib1.customerId = IN_CustomerId
    AND zib1.warehouseId = IN_WarehouseId
    AND zib1.StockDate = DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d')
    -- and CONVERT(zib1.StockDate, DATE) between '2025-05-25' and '2025-05-25'
    AND zib1.locationCategory IN ('SD', 'DD', 'GR')
    GROUP BY zib1.organizationId,
             zib1.warehouseId,
             zib1.customerId,
             zib1.StockDate,
             zib1.Storage_Type
    UNION ALL
    SELECT
      zib3.organizationId,
      zib3.warehouseId,
      zib3.customerId,
      DATE_FORMAT(zib3.StockDate, '%Y-%m-%d') AS StockDate,
      COUNT(DISTINCT zib3.traceId) AS qtyCharge_TraceId,
      COUNT(DISTINCT zib3.muid) AS qtyCharge_MUID,
      SUM(zib3.qty) AS qty,
      SUM(zib3.qty_cbm) AS qtycbm,
      zib3.Storage_Type
    FROM (SELECT
      DISTINCT
        zib2.customerId AS customerId,
        zib2.warehouseId AS warehouseId,
        zib2.organizationId AS organizationId,
        zib2.sku AS SKU,
        zib2.SKUDesc AS SKUDesc,
        zib2.UOM AS UOM,
        SUM(zib2.qtyonHand) AS qtyonHand,
        zib2.muid AS muid,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'FMI_JKT') THEN '' ELSE zib2.traceId END AS traceId,
        zib2.lotNum AS lotNum,
        zib2.packkey AS packkey,
        DATE_FORMAT(zib2.StockDate, '%Y-%m-%d') AS StockDate,
        zib2.locationId AS locationId,
        zib2.locationCategory AS locationCategory,
        ila1.lotAtt04 AS batch,
        ila1.lotAtt11 AS owner,
        ila1.lotAtt07 AS lotAtt07,
        CASE WHEN zib2.customerId IN ('API', 'ADS', 'GYVTL') THEN (
              CASE WHEN bpd1.uomdescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomdescr = 'LT' THEN zib2.qtyOnHand ELSE (
                  zib2.qtyOnHand * bs1.netweight) END) WHEN zib2.customerId IN ('MDS') THEN (CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand ELSE (zib2.qtyOnHand) * bs1.sku_group6 END) WHEN zib2.customerId IN ('PACIFICPAINT') THEN (zib2.qtyOnHand * bs1.grossweight) WHEN zib2.customerId IN ('GCM') THEN (CASE WHEN bpd1.uomDescr = 'ZK' THEN zib2.qtyOnHand * bs1.grossweight WHEN bpd1.uomDescr = 'EA' THEN zib2.qtyOnHand * bs1.grossweight ELSE (zib2.qtyOnHand) END) WHEN zib2.customerId IN ('TUMI') THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('BMM_JKT') THEN (zib2.qtyOnHand / 1000) WHEN zib2.customerId IN ('LTL', 'LTL MDN', 'LTL_CUST', 'LTL SMG', 'LTL SBY', 'LTL BDG') THEN (
              CASE WHEN bpd1.uomDescr = 'KG' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'LT' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'L' THEN zib2.qtyOnHand WHEN
                  bpd1.uomDescr = 'G' THEN zib2.qtyOnHand / 1000 WHEN
                  bpd1.uomDescr = 'MT' THEN zib2.qtyOnHand * 1000 ELSE (
                  zib2.qtyOnHand * bs1.grossweight) END) WHEN
            zib2.customerId IN ('PPG') THEN (
              CASE WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'PC' THEN (zib2.qtyOnHand * (CAST((
                    CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN bs1.sku_group6 IS NULL THEN 0 ELSE bs1.sku_group6 END) AS decimal(18, 4)))) WHEN SUBSTRING(bpd1.uomDescr, 1, 2) = 'EA' THEN (zib2.qtyOnHand * (CAST((CASE WHEN bs1.sku_group6 = ' ' THEN 0 WHEN bs1.sku_group6 = '' THEN 0 WHEN
                        bs1.sku_group6 IS
                        NULL THEN 0 ELSE bs1.sku_group6 END)
                    AS decimal(18, 4)))) ELSE zib2.qtyOnHand END) WHEN zib2.customerId = 'TMB_SMG' THEN (zib2.qtyOnHand) WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (zib2.qtyOnHand) ELSE (zib2.qtyOnHand) END AS qty,
        -- case when zib2.customerId in ('ECMAMA', 'ECMAMAB2C') THEN (
        CASE WHEN bsm1.packId LIKE '1/%' THEN ROUND(zib2.qtyonHand * bs1.`cube`, 6) ELSE ROUND(zib2.qtyonHand * (bs1.`cube` / 1000000), 6) END AS qty_cbm,
        CASE WHEN zib2.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN (
              CASE WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-01' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-03' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-05' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN SUBSTRING(zib2.locationId, 1, 10) = 'STAGEAC-07' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E08%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' WHEN zib2.locationId LIKE 'E09%' AND
                  bs1.freightClass = 'COOL-NON-FOOD' THEN 'AC' ELSE 'AMBIENT' END) WHEN zib2.customerId = 'MAPCLUB' THEN (CASE WHEN zib2.sku IN ('0000000000001482321041', '0000000000001482321879', '0000000000001482322245') THEN 'NON REGULER' ELSE 'REGULER' END) WHEN zib2.customerid = 'PPG' THEN (CASE WHEN zib2.locationId LIKE 'C%' THEN 'WH-C' ELSE 'NON WH-C' END) WHEN zib2.customerId IN ('DNN_MDN') THEN (CASE WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10215338' THEN 'PREFORM 1500' WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10215336' THEN 'PREFORM 600' WHEN zib2.warehouseId = 'KIMSTR' AND
                  bsm1.tariffMasterId = 'BIL00085SFG' AND
                  bs1.sku = '10425007' THEN 'CAPSHIELD' ELSE 'RESIN' END) ELSE 'DRY' END AS Storage_Type,
        CASE ila1.lotAtt07 WHEN 'O' THEN 'Owner Pallet' WHEN 'R' THEN 'Rental Pallet' WHEN 'PP' THEN 'Rental Plastic Pallet' WHEN 'WP' THEN 'Rental Wooden Pallet' END AS RecType
      FROM Z_InventoryBalance zib2
        LEFT JOIN BAS_SKU AS bs1
          ON bs1.organizationId = zib2.organizationId
          AND bs1.sku = zib2.sku
          AND bs1.customerId = zib2.customerId
        LEFT JOIN BAS_SKU_MULTIWAREHOUSE AS bsm1
          ON bsm1.organizationId = zib2.organizationId
          AND bsm1.sku = zib2.sku
          AND bsm1.customerId = zib2.customerId
          AND bsm1.warehouseId = zib2.warehouseId
        LEFT JOIN BAS_PACKAGE_DETAILS AS bpd1
          ON bpd1.organizationId = bsm1.organizationId
          AND bpd1.packId = bsm1.packId
          AND bpd1.customerId = bsm1.customerId
          AND bpd1.packUom = 'EA'
        LEFT JOIN INV_LOT_ATT ila1
          ON ila1.organizationId = zib2.organizationId
          AND ila1.SKU = zib2.SKU
          AND ila1.lotnum = zib2.lotnum
        /*
          left join BAS_SKU as bs on bs.sku = zib2.sku and bs.customerId = zib2.customerId
          left join BAS_SKU_MULTIWAREHOUSE as bsm on bsm.sku = zib2.sku and bsm.customerId = zib2.customerId
          left join INV_LOT_ATT ila1 on ila1.SKU = zib2.SKU and ila1.lotnum = zib2.lotnum*/
        LEFT JOIN BAS_LOCATION bl
          ON bl.organizationId = zib2.organizationId
          AND bl.warehouseId = zib2.warehouseId
          AND bl.locationId = zib2.locationId
      WHERE zib2.organizationId = IN_organizationId
      AND zib2.customerId = IN_CustomerId
      AND zib2.warehouseid = IN_WarehouseId
      AND zib2.SKU NOT IN ('FULLCARTON')
      AND zib2.SKU NOT LIKE '13%'
      AND zib2.qtyOnHand > 0
      AND zib2.StockDate = DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d')
      -- AND CONVERT(zib2.StockDate, DATE) between '2025-05-25' and '2025-05-25'
      AND zib2.locationId NOT IN ('CONSWOR', 'LOST_CBT01', 'STG01', 'STG02', 'STG03', 'STG04', 'STG05', 'STG11', 'STG12', 'STG13', 'STG14', 'STG15', 'STG06', 'STG07', 'STG08', 'STG09', 'STG10', 'STG16', 'STG17', 'STG18', 'STG19', 'STG20', 'SORTATIONCBT01', 'CROSSDOCK_01', 'CROSSDOCK_02', 'SORTATIONLADC01', 'SORTATIONBASF01', 'SORTATION', 'SORTATIONCBT02', 'SORTATIONSMG-SO', 'SORTATION1', 'CYCLE-01S', 'LOST_CBT01', 'STO-01', 'STO-02', 'STO-03', 'STO-04', 'STO-05', 'WHAQC', 'WHCQC', 'WHCQC01', 'WHCQC03', 'WHCQC05', 'WHCQC09', 'WHCQC11', 'WHCQC13', 'WHCQC15', 'WHCQC17', 'WHCQC19', 'WHCQC21', 'WHCQC23', 'WHCQC25', 'WHCQC27', 'WHCQC29', 'WHCQC31', 'WHCQC33', 'WHCQC35', 'WHIQC', 'WORK_AREA')
      AND bl.workingArea NOT IN ('LTL-BULK')
      -- and zib2.locationId not like 'K%'
      GROUP BY zib2.customerId,
               zib2.warehouseId,
               zib2.organizationId,
               zib2.SKU,
               zib2.SKUDesc,
               zib2.qtyonHand,
               zib2.UOM,
               zib2.muid,
               zib2.traceId,
               zib2.lotNum,
               zib2.packkey,
               zib2.StockDate,
               ila1.lotAtt04,
               ila1.lotAtt11,
               ila1.lotAtt07,
               zib2.locationId,
               zib2.locationCategory,
               bsm1.tariffMasterId,
               bs1.sku_group6
      ORDER BY StockDate,
      traceId ASC) zib3
    WHERE zib3.organizationId = IN_organizationId
    AND zib3.customerId = IN_CustomerId
    AND zib3.warehouseId = IN_WarehouseId
    AND zib3.StockDate = DATE_FORMAT(DATE_ADD(DATE_ADD(CURRENT_DATE(), INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d')
    -- and CONVERT(zib3.StockDate, DATE) between '2025-05-25' and '2025-05-25'
    AND CASE WHEN zib3.customerId IN ('ECMAMA', 'ECMAMAB2C') THEN zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'VT', 'CSG') ELSE zib3.locationCategory IN ('BS', 'FS', 'DR', 'PK', 'CSG') END
    GROUP BY zib3.organizationId,
             zib3.warehouseId,
             zib3.customerId,
             zib3.StockDate,
             zib3.Storage_Type) zib4
  GROUP BY zib4.organizationId,
           zib4.warehouseId,
           zib4.customerId,
           zib4.StockDate,
           zib4.Storage_Type;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

  -- Open the cursor
  OPEN my_cursor;

-- Loop through the results
read_loop:
  LOOP
    -- Fetch the values into variables
    FETCH my_cursor INTO v_organizationId, v_warehouseId, v_customerId, v_stockDate, v_qty_TraceId, v_qty_MUID, v_qty, v_qty_cbm, v_storageType, v_chargeType;


    -- SELECT 'debug =>',v_workingArea;


    -- Exit the loop if no more rows
    IF done = 1 THEN
      LEAVE read_loop;
    END IF;
    SELECT
      'DEBUG=>',
      v_customerId,
      days_done,
      v_warehouseId,
      v_stockDate,
      v_qty_TraceId,
      v_qty_MUID,
      v_qty,
      v_qty_cbm,
      v_chargeType;


    /*IF NOT EXISTS (SELECT
              1
            FROM Z_BIL_AKUM_DAYS_STORAGE zads1
            WHERE zads1.organizationId = v_organizationId
            AND zads1.warehouseId = v_warehouseId
            AND zads1.customerId = v_customerId
            -- AND DATE(bs.billingFromDate) = DATE(DATE_ADD(CURDATE(), INTERVAL -1 DAY))
             AND DATE(zads1.StockDate) = v_stockDate) THEN
    /*    BLOCK2:
          BEGIN
            DECLARE cur_days CURSOR FOR
            SELECT DISTINCT 
    zads.organizationId,
    zads.warehouseId,
    zads.customerId,
    zads.StockDate,
    zads.qty_traceId,
    zads.qty_MUID,
    zads.chargeType,
    zads.addWHo,
    zads.addTime,
    zads.editWho,
    zads.editTime,
    zads.UDF01,
    zads.UDF02,
    zads.UDF03,
    zads.UDF04,
    zads.UDF05,
    zads.lotAtt01,
    zads.lotAtt02,
    zads.lotAtt03,
    zads.lotAtt05
            FROM Z_BIL_AKUM_DAYS_STORAGE zads
    		where 
    		zads.organizationId = v_organizationId
    		and zads.customerId = v_customerId
    		and zads.warehouseId = v_warehouseId
    		and CONVERT(zads.StockDate,DATE) between '2024-12-26' and '2025-01-25';
            DECLARE CONTINUE HANDLER FOR NOT FOUND SET days_done = 1;
    /*        SELECT
              'look->',
               days_done;
            SET R_CURRENTDATE = CURDATE();##yyyy-mm-dd*/

    #
    /*        OPEN cur_days;testing insert
     */
    /*getDays:
      LOOP
        FETCH cur_days INTO R_organizationId,R_warehouseId,R_customerId,R_StockDate,R_qty_traceId,R_qty_MUID,R_chargeType,R_addWHo,R_addTime,R_editWho,R_editTime,
        R_UDF01,R_UDF02,R_UDF03,R_UDF04,R_UDF05,R_lotAtt01,R_lotAtt02,R_lotAtt03,R_lotAtt05;


        --  SELECT 'DEBUG->',R_CUSTOMERID,v_warehouseId,v_customerId;
        IF days_done THEN
          SET days_done = FALSE;
          LEAVE getDays;
        END IF;

          --           SELECT 'check 2=>',R_RESULTQTYCHARGE;*/

    /*W             IF EXISTS (SELECT
                      1
                    FROM Z_BIL_AKUM_DAYS_STORAGE zi6
                    WHERE zi6.organzationId = v_organizationId 
                    AND zi6.warehouseId = v_warehouseId
                    AND zi6.customerId = v_customerId
                    AND zi6.StockDate = v_StockDate) then
                  DELETE
                    FROM Z_BIL_AKUM_DAYS_STORAGE
                    WHERE organizationId = v_organizationId
                    AND warehouseId = v_warehouseId
                    AND customerId = v_customerId
                    AND StockDate = v_StockDate;
                END IF; -- EXISTstorage akum days 
                #
                  IF SUBSTRING(OUT_returnCode, 1, 3) <> '000' THEN
                    SET OUT_returnCode = '999#????????';
                    LEAVE read_loop;
                  END IF;
               /* SELECT
                  'DEBUG=>',
                  v_customerId,
                  R_CUSTOMERID,
                  R_WAREHOUSEID,
                  days_done,
                  v_warehouseId;*/

    INSERT INTO Z_BIL_AKUM_DAYS_STORAGE (organizationId, warehouseId, customerId, StockDate, qty_traceId, qty_MUID, qty, qty_cbm, chargeType, addWHo, addTime, editWho, editTime,
    UDF01, UDF02, UDF03, UDF04, UDF05, lotAtt01, lotAtt02, lotAtt03, lotAtt05)
      SELECT
        v_organizationId,
        v_warehouseId,
        v_customerId,
        v_stockDate,
        v_qty_TraceId,
        v_qty_MUID,
        v_qty,
        v_qty_cbm,
        v_chargeType,
        'CUSTOMBILL' addWHo,
        NOW() addTime,
        'CUSTOMBILL' editWho,
        NOW() editTime,
        v_storageType,
        '' UDF02,
        '' UDF03,
        '' UDF04,
        '' UDF05,
        '' lotAtt01,
        '' lotAtt02,
        '' lotAtt03,
        '' lotAtt05;

  --          END IF; -- END IF docType

  /*        END LOOP getDays;
          CLOSE cur_days;
        END;
      ELSE
        ITERATE read_loop;*/

  END LOOP;
  -- Close the cursor
  CLOSE my_cursor;

END
$$

--
-- Create procedure `CML_ARRIVAL_UPDATE_DOCNO`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_ARRIVAL_UPDATE_DOCNO (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_appdocno varchar(30),
IN IN_dockno varchar(10),
IN IN_type varchar(10),
INOUT OUT_returnCode varchar(1000))
ENDPROC:
  BEGIN
    DECLARE OUT_ReturnNo varchar(40);
    DECLARE R_CurrentTime timestamp;
    DECLARE r_Count int;
    DECLARE r_CountExist int;
    DECLARE OUT_Return_Code varchar(1000);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1
      @p1 = RETURNED_SQLSTATE, @p2 = MESSAGE_TEXT, @p3 = MYSQL_ERRNO, @p4 = TABLE_NAME, @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_returnCode = CONCAT('999#CML_ARRIVAL_UPDATE_DOCKNO', IFNULL(@p1, ''), IFNULL(@p2, ''), IFNULL(@p3, ''), IFNULL(@p4, ''), IFNULL(@p5, ''));
      SELECT
        OUT_returnCode,
        IN_soNo;
    END;

    SET r_Count = 0;
    IF IFNULL(IN_appdocno, '') != '' THEN
      SET OUT_returnCode = '000';


      -- check order cancel or close
      SELECT
        COUNT(1)
      FROM DOC_APPOINTMENT_HEADER doh
      WHERE doh.appointmentNo = IN_dockno
      AND organizationId = IN_organizationId
      AND warehouseId = IN_warehouseId
      AND doh.appStatus IN ('99') INTO r_Count;


      IF r_Count > 0 THEN
        SET OUT_returnCode = 'Appointment doc  cannot change when status closed!';
        LEAVE ENDPROC;
      END IF;





      START TRANSACTION;
        SET OUT_Return_Code = '*_*';
        SET R_CurrentTime = NOW();

        -- update SO
        IF EXISTS (SELECT
              1
            FROM DOC_ARRIVAL_HEADER AH
            WHERE AH.arrivalNo IN (SELECT DISTINCT
                arrivalNo
              FROM DOC_ARRIVAL_DETAILS
              WHERE appointmentNo = IN_appdocno
              AND warehouseId = IN_warehouseId)) THEN

          UPDATE DOC_ARRIVAL_HEADER dh
          LEFT JOIN DOC_ARRIVAL_DETAILS dad
            ON dh.organizationId = dad.organizationId
            AND dh.warehouseId = dad.warehouseId
            AND dh.arrivalNo = dad.arrivalno
          LEFT JOIN DOC_APPOINTMENT_HEADER dah
            ON dad.organizationId = dah.organizationId
            AND dad.warehouseId = dah.warehouseId
            AND dad.appointmentno = dah.appointmentNo
          SET dh.dockNo = dah.dockNo,
              dh.editTime = NOW()
          WHERE dah.appointmentNo = IN_appdocno
          AND dah.warehouseId = IN_warehouseId;




        END IF;



        -- insert to log

        INSERT INTO Z_LogUdfTran (docType
        , docNo
        , userId
        , lottable01
        , lottable02
        , addDate
        , addWho
        , editDate
        , editWho)
          VALUES ('SO' -- docType - VARCHAR(255)
          , IN_appdocno -- docNo - VARCHAR(255)
          , IN_userId -- userId - VARCHAR(255)
          , CONCAT('Update  Dockno Arrival ', IN_type), 'CML_SO_UPDATE_TYPE', NOW() -- addDate - DATETIME
          , 'EDI' -- addWho - VARCHAR(255)
          , NOW() -- editDate - DATETIME
          , 'EDI' -- editWho - VARCHAR(255)
          );



      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `CML_APPT_GET_DOCK`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_APPT_GET_DOCK (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_arrivalNo varchar(30))
ENDPROC:
  BEGIN
    DECLARE v_Dock varchar(10);
    DECLARE v_loc varchar(20);
    DECLARE v_row int;
    -- DECLARE EXIT HANDLER FOR SQLEXCEPTION
    -- BEGIN
    --     GET DIAGNOSTICS CONDITION 1
    --     @p1=RETURNED_SQLSTATE, @p2=MESSAGE_TEXT, @p3=MYSQL_ERRNO, @p4=TABLE_NAME, @p5=COLUMN_NAME;
    --     ROLLBACK;
    --     set OUT_returnCode = concat('999#CML_APPT_GET_DOCK',IFNULL(@p1,''),IFNULL(@p2,''),IFNULL(@p3,''),IFNULL(@p4,''),IFNULL(@p5,''));
    --     SELECT OUT_returnCode, IN_arrivalNo;
    -- END;
    IF IFNULL(IN_arrivalNo, '') != '' THEN
      SELECT
        IFNULL(dah.dockNo, '')
      FROM DOC_ARRIVAL_DETAILS dad
        JOIN DOC_APPOINTMENT_HEADER dah
          ON dad.organizationId = dah.organizationId
          AND dad.warehouseId = dah.warehouseId
          AND dad.appointmentno = dah.appointmentNo
      WHERE dad.organizationId = IN_organizationId
      AND dad.warehouseId = IN_warehouseId
      AND dad.arrivalNo = IN_arrivalNo
      AND dah.dockNo <> ''
      LIMIT 0, 1 INTO v_Dock;

      IF v_Dock = '' THEN
        -- 		SET OUT_returnCode = '000';
        LEAVE ENDPROC;
      END IF;

      START TRANSACTION;

        UPDATE DOC_ARRIVAL_HEADER
        SET dockNo = v_Dock
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseId
        AND arrivalNo = IN_arrivalNo;


        SET v_loc = CONCAT('RCV', TRIM(LEADING '0' FROM v_Dock));
        SET v_row = 0;
        SELECT
          COUNT(1)
        FROM BAS_LOCATION
        WHERE organizationId = IN_organizationId
        AND warehouseId = IN_warehouseId
        AND locationId = v_loc INTO v_row;

        IF v_row > 0 THEN
          UPDATE DOC_ASN_DETAILS a
          JOIN DOC_APPOINTMENT_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.asnNo = b.docNo
          JOIN DOC_ARRIVAL_DETAILS ah
            ON ah.organizationId = b.organizationId
            AND ah.warehouseId = b.warehouseId
            AND ah.appointmentno = b.appointmentNo
          SET a.receivingLocation = v_loc
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND ah.arrivalNo = IN_arrivalNo
          AND a.lineStatus <= '10';

          UPDATE DOC_TRACE_DETAILS a
          JOIN DOC_APPOINTMENT_DETAILS b
            ON a.organizationId = b.organizationId
            AND a.warehouseId = b.warehouseId
            AND a.asnNo = b.docNo
          JOIN DOC_ARRIVAL_DETAILS ah
            ON ah.organizationId = b.organizationId
            AND ah.warehouseId = b.warehouseId
            AND ah.appointmentno = b.appointmentNo
          SET a.receivingLocation = v_loc
          WHERE a.organizationId = IN_organizationId
          AND a.warehouseId = IN_warehouseId
          AND ah.arrivalNo = IN_arrivalNo
          AND a.lineStatus <= '10';
        END IF;

      COMMIT;
    END IF;
  END
  $$

--
-- Create procedure `CML_ALERT_STOCK2`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_ALERT_STOCK2 (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
NewSku:
  BEGIN
    DECLARE r_packId varchar(50) DEFAULT "";
    DECLARE r_packdescr varchar(100) DEFAULT "";
    DECLARE r_customer varchar(50) DEFAULT "";
    DECLARE r_AddTime varchar(20);
    DECLARE r_alertID varchar(20);
    DECLARE r_receipientAdd varchar(600);
    DECLARE finished integer DEFAULT 0;


    DECLARE cur_Package CURSOR FOR
    SELECT
      a.customerId,
      a.packId,
      SUBSTRING(a.packDescr, 1, 100),
      DATE_FORMAT(a.addTime, '%Y/%m/%d %T')
    FROM BAS_PACKAGE a
    WHERE a.organizationId = IN_organizationId
    AND IFNULL(a.udf05, '') = ''
    AND DATE_FORMAT(a.addTime, '%Y/%m/%d') <= DATE_FORMAT(NOW(), '%Y/%m/%d')
    AND DATE_FORMAT(a.addTime, '%Y/%m/%d') > DATE_FORMAT(NOW() - INTERVAL 1 DAY, '%Y/%m/%d');

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_SP_ALERT_NEW_PACKAGE,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    SET r_alertid = 'NEW_SKU';
    SELECT
      template.recipientsList INTO r_receipientAdd
    FROM RUL_ALERT rul
      LEFT JOIN BSM_EMAIL_TEMPLATE template
        ON rul.organizationId = template.organizationId
        AND rul.emailtemplateId = template.templateId
    WHERE rul.organizationId = IN_organizationId
    AND rul.warehouseid = IN_warehouseId
    AND rul.alertId = r_alertid;
    OPEN cur_Package;
  getPackage:
    LOOP
      FETCH cur_Package INTO r_customer, r_PackId, r_packdescr, r_AddTime;
      IF finished = 1 THEN
        LEAVE getPackage;
      END IF;
      START TRANSACTION;
        INSERT INTO SYS_ALERT_LOG (organizationId,
        warehouseId,
        alertMessageId,
        alertId,
        alertDate,
        field01,
        field02,
        field03,
        field04,
        alertAddress,
        subjectText,
        readFlag,
        messageLevel,
        sendAlertFlag,
        addWho,
        addTime,
        editWho,
        editTime)
          VALUES (IN_organizationId, IN_warehouseId, REPLACE(UUID(), '-', ''), r_alertid, CURRENT_TIMESTAMP, r_customer, r_PackId, r_packdescr, r_AddTime, r_receipientAdd, 'New Package Alert', 'N', 1, 'N', IN_userId, CURRENT_TIMESTAMP, IN_userId, CURRENT_TIMESTAMP);
        UPDATE BAS_PACKAGE
        SET UDF05 = 'Y'
        WHERE organizationId = IN_organizationId
        AND packId = r_PackId
        AND customerId = r_customer;
      COMMIT;
    END LOOP getPackage;
    CLOSE cur_Package;

    SET out_returnCode := '000';
  END
  $$

--
-- Create procedure `CML_ALERT_STOCK`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CML_ALERT_STOCK (IN IN_organizationId varchar(20),
IN IN_warehouseId varchar(20),
IN IN_userId varchar(40),
OUT OUT_returnCode varchar(1000))
NewStock:
  BEGIN
    DECLARE r_customerId varchar(100) DEFAULT "";
    DECLARE r_locationId varchar(100) DEFAULT "";
    DECLARE r_sku varchar(100) DEFAULT "";
    DECLARE r_AddTime varchar(100);
    DECLARE r_alertID varchar(20);
    DECLARE r_receipientAdd varchar(600);
    DECLARE finished integer DEFAULT 0;

    DECLARE cur_Stock CURSOR FOR
    SELECT
      illi.customerId,
      illi.locationId,
      illi.sku,
      bs.skuDescr1,
      bs.sku_group1,
      bs.sku_group2,
      illi.lotNum,
      ila.lotAtt04,
      ila.lotAtt01,
      ila.lotAtt02,
      illi.traceId,
      illi.qty,
      illi.qtyAllocated,
      0 AS QTYPICKED,
      bpd.uomDescr AS UOM,
      CASE ila.lotAtt08 WHEN 'N' THEN 'OK' WHEN 'Y' THEN 'HOLD' ELSE '' END AS STATUS,
      CURDATE(),
      ila.lotAtt03,
      ila.lotAtt05,
      DATEDIFF(CURDATE(), ila.lotAtt03) AS AGING
    FROM INV_LOT_LOC_ID illi
      LEFT OUTER JOIN BAS_SKU bs
        ON illi.`organizationId` = bs.organizationId
        AND illi.customerId = bs.customerId
        AND illi.sku = bs.sku
      LEFT OUTER JOIN INV_LOT_ATT ila
        ON illi.`organizationId` = ila.organizationId
        AND illi.lotNum = ila.lotNum
      LEFT OUTER JOIN BAS_PACKAGE_DETAILS bpd
        ON illi.`organizationId` = bpd.organizationId
        AND bs.packId = bpd.packId
        AND illi.customerId = bpd.customerid
        AND bpd.packUom = 'EA'
    WHERE illi.customerId = 'ZAP';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET finished = 1;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
      GET DIAGNOSTICS CONDITION 1 @p1 = RETURNED_SQLSTATE,
      @p2 = MESSAGE_TEXT,
      @p3 = MYSQL_ERRNO,
      @p4 = TABLE_NAME,
      @p5 = COLUMN_NAME;
      ROLLBACK;
      SET OUT_ReturnCode = CONCAT('999#CML_ALERT_STOCK,',
      IFNULL(@p1, ''),
      ',',
      IFNULL(@p2, ''),
      ',',
      IFNULL(@p3, ''),
      ',',
      IFNULL(@p4, ''),
      ',',
      IFNULL(@p5, ''));
      SELECT
        OUT_ReturnCode AS error;
    END;
    SET r_alertid = 'NEW_SKU';
    SELECT
      template.recipientsList INTO r_receipientAdd
    FROM RUL_ALERT rul
      LEFT JOIN BSM_EMAIL_TEMPLATE template
        ON rul.organizationId = template.organizationId
        AND rul.emailtemplateId = template.templateId
    WHERE rul.organizationId = IN_organizationId
    AND rul.warehouseid = IN_warehouseId
    AND rul.alertId = r_alertid;
    OPEN cur_Stock;
  getStock:
    LOOP
      FETCH cur_Stock INTO r_customerId, r_locationId, r_sku, r_AddTime;
      IF finished = 1 THEN
        LEAVE getStock;
      END IF;
      START TRANSACTION;
        INSERT INTO SYS_ALERT_LOG (organizationId,
        warehouseId,
        alertMessageId,
        alertId,
        alertDate,
        field01,
        field02,
        field03,
        field04,
        alertAddress,
        subjectText,
        readFlag,
        messageLevel,
        sendAlertFlag,
        addWho,
        addTime,
        editWho,
        editTime)
          VALUES (IN_organizationId, IN_warehouseId, REPLACE(UUID(), '-', ''), r_alertid, CURRENT_TIMESTAMP, r_customerId, r_locationId, r_sku, r_AddTime, r_receipientAdd, 'New Balancestock Alert', 'N', 1, 'N', IN_userId, CURRENT_TIMESTAMP, IN_userId, CURRENT_TIMESTAMP);
      COMMIT;
    END LOOP getStock;
    CLOSE cur_Stock;
    SET out_returnCode := '000';
  END
  $$

--
-- Create procedure `CML_ALERT_EDT_ARRIVAL`
--
CREATE
DEFINER = 'sa'@'%'
PROCEDURE CML_ALERT_EDT_ARRIVAL (IN IN_organizationId varchar(30),
IN IN_warehouseId varchar(30),
IN IN_userId varchar(20),
IN IN_languageId varchar(20),
IN IN_arrivalNo varchar(30),
IN IN_vehicleNo varchar(30),
IN IN_driver varchar(30))
ENDPROC:
  BEGIN
    DECLARE v_Dock varchar(10);
    DECLARE v_loc varchar(20);
    DECLARE v_row_pass int;
    DECLARE v_row_data int;
    DECLARE v_vehicleNo varchar(30);
    DECLARE v_driver varchar(30);
    DECLARE errorMessage varchar(255);

    SELECT
      COUNT(1) INTO v_row_pass
    FROM DOC_ARRIVAL_PASSID dap
    WHERE dap.organizationId = IN_organizationId
    AND dap.warehouseId = IN_warehouseId
    AND dap.arrivalNo = IN_arrivalNo;
    IF (v_row_pass > 0) THEN

      SELECT
        dap.vehicleNo,
        dap.driver INTO v_vehicleNo, v_driver
      FROM DOC_ARRIVAL_HEADER dap
      WHERE dap.organizationId = IN_organizationId
      AND dap.warehouseId = IN_warehouseId
      AND dap.arrivalNo = IN_arrivalNo;


      SELECT
        COUNT(1) INTO v_row_data
      FROM DOC_ARRIVAL_HEADER dap
      WHERE dap.organizationId = IN_organizationId
      AND dap.warehouseId = IN_warehouseId
      AND dap.arrivalNo = IN_arrivalNo
      AND (LTRIM(RTRIM(UPPER(dap.vehicleNo))) = LTRIM(RTRIM(UPPER(IN_vehicleNo)))
      AND LTRIM(RTRIM(UPPER(dap.driver))) = LTRIM(RTRIM(UPPER(IN_driver))));

      IF (v_row_data = 0) THEN
        SET errorMessage = CONCAT('Cannot edit vehicle and driver name after print ticket ');
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = errorMessage;
      END IF;


    END IF;





  END
  $$

--
-- Create procedure `CML_3701_SAVE`
--
CREATE
DEFINER = 'root'@'localhost'
PROCEDURE CML_3701_SAVE (IN IN_ORGANIZATIONID varchar(50),
IN IN_WAREHOUSEID varchar(50),
IN IN_TARIFFID varchar(50),
IN IN_TARIFFLINENO varchar(50),
IN IN_LANGUAGEID varchar(10),
IN IN_USERID varchar(100),
INOUT OUT_RETURNCODE varchar(1000))
BEGIN

  ####################################################################
  ##????
  DECLARE R_UDF09 varchar(500);

  ####################################################################
  ##????
  BEGIN
    SELECT
      T.UDF05 INTO R_UDF09
    FROM BIL_TARIFF_DETAILS T
    WHERE T.organizationId = IN_ORGANIZATIONID
    AND T.tariffId = IN_TARIFFID
    AND T.tariffLineNo = IN_TARIFFLINENO
    ;
    UPDATE BIL_TARIFF_DETAILS
    SET rateBase = R_UDF09
    WHERE organizationId = IN_ORGANIZATIONID
    AND tariffId = IN_TARIFFID
    AND tariffLineNo = IN_TARIFFLINENO
    ;
    SET OUT_RETURNCODE = '000';
  END;
END
$$

--
-- Create procedure `CHK_BILL_STORAGE_DETAIL`
--
CREATE
DEFINER = 'wms_cml'@'%'
PROCEDURE CHK_BILL_STORAGE_DETAIL (IN `IN_organizationId` varchar(30),
IN `IN_warehouseId` varchar(30),
IN `IN_USERID` varchar(30),
IN `IN_Language` varchar(30),
IN `IN_CustomerId` varchar(30),
INOUT `OUT_returnCode` varchar(1000))
BEGIN

  DECLARE R_CURRENTDATE timestamp;
  DECLARE R_OPDATE varchar(10);
  DECLARE R_FMDATE varchar(10);
  DECLARE R_TODATE varchar(10);
  DECLARE R_BILLINGDAY integer;
  DECLARE R_BILLINGDATE varchar(10);
  DECLARE R_TARGETDATE varchar(10);
  DECLARE R_DAYOFMONTH int;

  DECLARE R_ORGANIZATIONID varchar(30);
  DECLARE R_WAREHOUSEID varchar(30);
  DECLARE R_CUSTOMERID varchar(30);
  DECLARE R_STOCKDATE varchar(10);
  DECLARE R_TARIFFID varchar(10);
  DECLARE R_TARIFFMASTERID varchar(10);
  DECLARE R_TARIFFLINENO int(11);
  DECLARE R_TARIFFCLASSNO int(11);

  DECLARE R_CHARGECATEGORY varchar(20);
  DECLARE R_CHARGETYPE varchar(20);
  DECLARE R_descrC varchar(50);

  DECLARE R_ratebase varchar(20);
  DECLARE R_rateperunit decimal(24, 8);
  DECLARE R_rate decimal(24, 8);
  DECLARE R_minQty varchar(500);
  DECLARE R_minAmount decimal(24, 8);
  DECLARE R_maxAmount decimal(24, 8);
  DECLARE R_billQty decimal(24, 8);
  DECLARE R_Cost decimal(24, 8);

  DECLARE R_materialNo varchar(500);
  DECLARE R_itemChargeCategory varchar(500);
  DECLARE R_billMode varchar(500);
  DECLARE R_UDF06 varchar(500);
  DECLARE R_FINALAMOUNT decimal(24, 8);

  DECLARE R_billsummaryId varchar(30) DEFAULT '';
  DECLARE R_billsummaryNo varchar(30) DEFAULT '';
  DECLARE R_LOCATIONCAT char(2);
  DECLARE R_LOCATIONGROUP varchar(500);
  DECLARE R_INCOMETAX decimal(24, 8);
  DECLARE R_CLASSFROM decimal(24, 8);
  DECLARE R_CLASSTO decimal(24, 8);
  DECLARE R_CONTRACTNO varchar(100);
  DECLARE R_BILLINGMONTH varchar(10);
  DECLARE R_BILLINGPARTY varchar(10);
  DECLARE R_BILLTO varchar(30);
  DECLARE R_NROW integer;


  DECLARE c_WAREHOUSEID varchar(30);
  DECLARE c_CUSTOMERID varchar(30);
  DECLARE c_chargecategory varchar(30);
  DECLARE c_charegetype varchar(30);
  DECLARE c_locationId varchar(60);
  DECLARE c_sku varchar(255);
  DECLARE c_qtyonHand int(11) DEFAULT NULL;
  DECLARE c_packkey varchar(255) binary DEFAULT NULL;
  DECLARE c_UOM varchar(255) binary DEFAULT NULL;
  DECLARE c_qtyallocated int(11) DEFAULT NULL;
  DECLARE c_qtyonHold int(11) DEFAULT NULL;
  DECLARE c_qtyavailable int(11) DEFAULT NULL;
  DECLARE c_qtyPicked int(11) DEFAULT NULL;
  DECLARE c_SKUDesc varchar(550) binary DEFAULT NULL;
  DECLARE c_stockDate date DEFAULT NULL;
  DECLARE c_cube decimal(24, 8) DEFAULT NULL;
  DECLARE c_totalCube decimal(24, 8) DEFAULT NULL;
  DECLARE c_grossWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_netWeight decimal(18, 8) DEFAULT NULL;
  DECLARE c_freightClass varchar(255) binary DEFAULT NULL;
  DECLARE c_locationCategory varchar(10) DEFAULT '';

  DECLARE tariff_done int DEFAULT FALSE;
  DECLARE inventory_done int DEFAULT FALSE;



  DECLARE cur_Tariff CURSOR FOR
  SELECT DISTINCT
    bsm.organizationId,
    bsm.warehouseId,
    bsm.CUSTOMERID,
    DAY(bth.billingdate) billingDate,
    btd.tariffId,
    btd.tariffLineNo,
    btr.tariffClassNo,
    btd.chargeCategory,
    btd.chargeType,
    btd.descrC,
    btd.ratebase,
    btr.ratePerUnit,
    btr.rate,
    btd.minAmount,
    btd.maxAmount,
    IF(btd.UDF03 = '', 0, btd.UDF03) minQty,
    btd.UDF01 AS MaterialNo,
    btd.udf02 AS itemChargeCategory,
    btd.udf04 billMode,
    locationCategory,
    btd.UDF05 R_LOCATIONGROUP,
    btd.UDF06,
    IFNULL(btd.incomeTaxRate, 0) IncomeTaxRate,
    CASE WHEN chargeType = 'ES' THEN btr.classfrom - 1 ELSE btr.classfrom END,
    classTo,
    bth.contractNo,
    bth.tariffMasterId,
    btr.cost,
    btd.billingParty
  FROM BAS_SKU_MULTIWAREHOUSE bsm
    LEFT JOIN BAS_CUSTOMER bc
      ON bc.customerId = bsm.customerId
      AND bc.organizationId = bsm.organizationId
    LEFT JOIN BIL_TARIFF_HEADER bth
      ON bth.organizationId = bsm.organizationId
      AND bth.tariffMasterId = bsm.tariffMasterId
    LEFT JOIN BIL_TARIFF_DETAILS btd
      ON btd.organizationId = bth.organizationId
      AND btd.tariffId = bth.tariffId
    LEFT JOIN BIL_TARIFF_RATE btr
      ON btr.organizationId = btd.organizationId
      AND btr.tariffId = btd.tariffId
      AND btr.tariffLineNo = btd.tariffLineNo
  WHERE bsm.tariffMasterId != ''
  AND bth.tariffId IS NOT NULL
  AND bc.customerType = 'OW'
  AND btd.chargeCategory = 'IV'
  AND btr.rate IS NOT NULL
  AND bsm.customerId LIKE IN_CustomerId
  AND bth.effectiveFrom <= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND bth.effectiveTo >= DATE_FORMAT(CURDATE(), '%Y-%m-%d')
  AND IFNULL(DAY(bth.billingdate), 0) != 0
  ORDER BY bsm.organizationId, bsm.customerId, btd.tariffId, btd.tariffId, btd.tariffLineNo, btr.tariffClassNo;

  DECLARE CONTINUE HANDLER FOR NOT FOUND SET tariff_done = 1;

  BEGIN
    SET R_CURRENTDATE = '2021-05-26';
    OPEN cur_Tariff;
  getTariff:
    LOOP
      FETCH cur_Tariff INTO R_ORGANIZATIONID, R_WAREHOUSEID, R_CUSTOMERID, R_BILLINGDAY, R_TARIFFID, R_TARIFFLINENO, R_TARIFFCLASSNO, R_CHARGECATEGORY, R_CHARGETYPE, R_descrC,
      R_ratebase, R_ratePerUnit, R_rate, R_minAmount, R_maxAmount, R_minQty, R_materialNo, R_itemChargeCategory, R_billMode, R_LOCATIONCAT, R_LOCATIONGROUP, R_UDF06,
      R_INCOMETAX, R_CLASSFROM, R_CLASSTO, R_CONTRACTNO, R_TARIFFMASTERID, R_Cost, R_BILLINGPARTY;

      IF tariff_done THEN
        SET tariff_done = FALSE;
        LEAVE getTariff;
      END IF;

      SET R_BILLINGDATE = STR_TO_DATE(CONCAT(YEAR(R_CURRENTDATE), '-', MONTH(R_CURRENTDATE), '-', R_BILLINGDAY), '%Y-%m-%d');

      SET R_OPDATE = DATE_FORMAT(DATE_ADD(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), INTERVAL -1 DAY), '%Y-%m-%d');
      SET R_FMDATE = DATE_FORMAT(DATE_ADD(R_BILLINGDATE, INTERVAL -1 MONTH), '%Y-%m-%d');
      SET R_TODATE = DATE_ADD(R_BILLINGDATE, INTERVAL -1 DAY);
      SET R_billsummaryId = '';
      IF R_BILLINGPARTY = 'BI' THEN
        SET R_BILLTO = R_CustomerId;
        SELECT
          CUSTOMERID INTO R_BILLTO
        FROM BAS_CUSTOMER
        WHERE refOwner = R_CustomerId
        AND CustomerType = 'BI'
        LIMIT 1;
      ELSE
        SET R_BILLTO = R_CustomerId;
      END IF;

      IF (R_BILLINGDATE = R_CURRENTDATE) THEN
      BEGIN

        DROP TABLE IF EXISTS TMP_BIL_SUMMARY_INFORMATION;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY_INFORMATION (
          organizationId varchar(20),
          warehouseId varchar(20),
          customerId varchar(30),
          billsummaryId varchar(30),
          LineNo int(11),
          tariffId varchar(10),
          tariffLineNo int(11),
          descrC varchar(60),
          chargeCategory varchar(20),
          chargeType varchar(20),
          ratebase varchar(20),
          minQty varchar(500),
          billingMode varchar(500),
          ratePerUnit decimal(24, 8) DEFAULT NULL,
          rate decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          tariffClassNo int(11) NOT NULL,
          classFrom decimal(24, 8) NOT NULL,
          classTo decimal(24, 8) NOT NULL,
          StockDate date DEFAULT NULL,
          locationId varchar(60) binary DEFAULT NULL,
          locationCategory varchar(10) binary NOT NULL,
          zoneId varchar(20) DEFAULT NULL,
          traceId varchar(30) binary NOT NULL,
          muid varchar(30) binary NOT NULL DEFAULT '*',
          lotNum varchar(10) binary NOT NULL,
          sku varchar(255) binary NOT NULL DEFAULT '',
          qtyonHand int(11) DEFAULT NULL,
          packkey varchar(255) binary DEFAULT NULL,
          UOM varchar(255) binary DEFAULT NULL,
          qtyallocated int(11) DEFAULT NULL,
          qtyonHold int(11) DEFAULT NULL,
          qtyavailable int(11) DEFAULT NULL,
          qtyPicked int(11) DEFAULT NULL,
          palletUsed int(11) DEFAULT NULL,
          SKUDesc varchar(550) binary DEFAULT NULL,
          `CUBE` decimal(24, 8) DEFAULT NULL,
          totalCube decimal(24, 8) DEFAULT NULL,
          grossWeight decimal(18, 8) DEFAULT NULL,
          netWeight decimal(18, 8) DEFAULT NULL,
          freightClass varchar(255) binary DEFAULT NULL,
          addWho varchar(255) binary NOT NULL DEFAULT '',
          addTime datetime DEFAULT NULL,
          editWho varchar(255) binary DEFAULT NULL,
          editTime datetime DEFAULT NULL
        );
        SET @linenumber = 0;
        IF (R_CHARGECATEGORY = 'IV'
          AND R_CHARGETYPE = 'PL') THEN
          CASE
            WHEN R_billMode = 'INTRACE' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.lotNum = zib.LotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.traceId NOT IN ('*', ' ')
                  -- AND zib.muid IN ('*','',' ') 
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = atl.organizationId
                      AND ila.customerId = atl.toCustomerId
                      AND ila.sku = atl.toSku
                      AND ila.lotNum = atl.tolotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toId NOT IN ('*', '', ' ')
                  -- AND atl.toMuid IN ('*','',' ') 
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXTRACE', 'DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    zib.StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    '*' muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INPL' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN WITH  MUID
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON i(ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku AND ila.lotNum = zib.lotNum)
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.muid NOT IN ('*', '', ' ')
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS LocationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.lotNum = zib.LotNumLEFT
                    JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toMuid NOT IN ('*', '', ' ')
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXPL', 'MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    '' traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  AND zib.muid NOT IN ('*', '', ' ')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INLOC' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN WITH LOCATION
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  AND zib.StockDate = R_OPDATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.customerId,
                           zib.StockDate,
                           zib.sku,
                           zib.skuDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS LocationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    ila.lotNum,
                    atl.toSku,
                    SUM(atl.toQty_Each),
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 AS SKUDesc,
                    SUM(`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(grossWeight),
                    SUM(netWeight),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON (
                      ila.organizationId = atl.organizationId
                      AND ila.customerId = atl.toCustomerId
                      AND ila.sku = atl.toSku
                      AND ila.lotNum = atl.tolotNum
                      )
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = bl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = bs.customerId
                      AND bs.sku = atl.fmSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXLOC', 'MONTHLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, ''),
                    IFNULL(bl.zoneId, '') AS zoneId,
                    '' traceId,
                    '' muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    'PL' UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = zib.organizationId
                      AND ila.customerId = zib.customerId
                      AND ila.sku = zib.sku
                      AND ila.lotNum = zib.lotNum
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND ila.lotAtt07 = 'R'
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'DAILYCBM' THEN -- Daily accumulated CBM
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                  WHERE zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass,
                           bl.locationCategory;
              END;
            ELSE SELECT
                'BILLING METHOD FOR PALLET RENTAL NOT FOUND' AS MESSAGE;
          END CASE;
        ELSE
        ## GET STORAGE FROM INVENTORY
        BEGIN
          CASE
            WHEN R_billMode = 'INTRACE' THEN  -- GET STORAGE FROM OPENING INVENTORY with HANDLING IN
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    zib.SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID addWho,
                    CURDATE() addTime,
                    IN_USERID editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND TRACEID NOT IN ('*')
                  -- AND MUID IN ('*')                                         
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toId NOT IN ('*')
                  -- AND atl.toMuid IN ('*') 
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXTRACE', 'DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    zib.StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND TRACEID NOT IN ('*')
                  -- AND MUID IN ('*')
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           bsm.tariffMasterId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INPL' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    zib.SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND MUID NOT IN ('*')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    atl.toMuid muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.toMuid NOT IN ('*')
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId,
                           atl.toMuid;
              END;
            WHEN R_billMode IN ('MAXPL', 'MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND MUID NOT IN ('*')
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           bsm.tariffMasterId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'INLOC' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    zib.packkey,
                    zib.UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND zib.StockDate = R_OPDATE
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass
                  UNION ALL
                  SELECT
                    atl.organizationId,
                    atl.warehouseId,
                    atl.toCustomerId CustomerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    ila.lotAtt03 AS StockDate,
                    atl.toLocation AS locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    atl.toId traceId,
                    '' muid,
                    atl.toLotNum lotNum,
                    atl.toSku sku,
                    SUM(atl.toQty) qtyOnHand,
                    atl.toPackId packkey,
                    atl.toUom UOM,
                    0 qtyallocated,
                    0 qtyonHold,
                    0 qtyavailable,
                    0 qtyPicked,
                    1 palletUsed,
                    bs.skuDescr1 SKUDesc,
                    SUM(bs.`CUBE`),
                    SUM(atl.totalCubic),
                    SUM(bs.grossWeight * atl.toQty_Each),
                    SUM(bs.netWeight * atl.toQty_Each),
                    '' freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM ACT_TRANSACTION_LOG atl
                    LEFT JOIN INV_LOT_ATT ila
                      ON ila.organizationId = atl.organizationId
                      AND ila.lotNum = atl.toLotNum
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = atl.organizationId
                      AND bl.warehouseId = atl.toWarehouse
                      AND bl.locationId = atl.toLocation
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU bs
                      ON bs.organizationId = atl.organizationId
                      AND bs.customerId = atl.toCustomerId
                      AND bs.sku = atl.toSku
                  WHERE ila.lotAtt03 >= R_FMDATE
                  AND ila.lotAtt03 <= R_TODATE
                  AND ila.lotAtt03 IS NOT NULL
                  AND atl.toCustomerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND atl.status = '99'
                  AND atl.transactionType = 'IN'
                  GROUP BY atl.organizationId,
                           atl.warehouseId,
                           atl.toCustomerId,
                           atl.toLocation,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           atl.toSku,
                           bs.skuDescr1,
                           atl.toUom,
                           ila.lotAtt03,
                           atl.toPackId,
                           atl.toLotNum,
                           atl.toId;
              END;
            WHEN R_billMode IN ('MAXLOC', 'MONTHLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                    LEFT JOIN BAS_SKU_MULTIWAREHOUSE bsm
                      ON (
                      bsm.organizationId = zib.organizationId
                      AND bsm.warehouseId = zib.warehouseId
                      AND bsm.customerId = zib.customerId
                      AND bsm.SKU = zib.sku
                      AND bsm.tariffMasterId = R_TARIFFMASTERID
                      )
                  WHERE zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND bsm.tariffMasterId = R_TARIFFMASTERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  AND zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            WHEN R_billMode = 'DAILYCBM' THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY_INFORMATION
                  SELECT
                    zib.organizationId,
                    zib.warehouseId,
                    zib.customerId,
                    '' billingSummaryId,
                    (@linenumber := @linenumber + 1) billingSummryLineNo,
                    R_tariffId,
                    R_TARIFFLINENO,
                    R_descrC,
                    r_chargeCategory,
                    R_CHARGETYPE,
                    R_ratebase,
                    R_minQty,
                    R_billMode,
                    R_rateperunit,
                    R_rate,
                    R_TARIFFCLASSNO,
                    R_CLASSFROM,
                    R_CLASSTO,
                    StockDate,
                    zib.locationId,
                    IFNULL(bl.locationCategory, '') LocationCategory,
                    IFNULL(bl.zoneId, '') AS zoneId,
                    zib.traceId,
                    zib.muid,
                    zib.lotNum,
                    zib.sku,
                    SUM(qtyonHand),
                    packkey,
                    UOM,
                    SUM(qtyallocated),
                    SUM(qtyonHold),
                    SUM(qtyavailable),
                    SUM(qtyPicked),
                    1 palletUsed,
                    SKUDesc,
                    SUM(`CUBE`),
                    SUM(totalCube),
                    SUM(grossWeight),
                    SUM(netWeight),
                    freightClass,
                    IN_USERID AS addWho,
                    CURDATE() addTime,
                    IN_USERID AS editWho,
                    CURDATE() editTime
                  FROM Z_InventoryBalance zib
                    LEFT JOIN BAS_LOCATION bl
                      ON bl.organizationId = zib.organizationId
                      AND bl.warehouseId = zib.warehouseId
                      AND bl.locationId = zib.locationId
                    LEFT JOIN BAS_LOCGROUP1 bl1
                      ON bl1.organizationId = bl.organizationId
                      AND bl1.warehouseId = bl.warehouseId
                      AND bl1.locGroup1 = bl.locGroup1
                  WHERE zib.StockDate >= R_FMDATE
                  AND zib.StockDate <= R_TODATE
                  AND zib.organizationId = R_ORGANIZATIONID
                  AND zib.warehouseId = R_WAREHOUSEID
                  AND zib.customerId = R_CUSTOMERID
                  AND (ISNULL(R_LOCATIONCAT)
                  OR R_LOCATIONCAT = ''
                  OR bl.locationCategory = R_LOCATIONCAT)
                  AND (ISNULL(R_LOCATIONGROUP)
                  OR R_LOCATIONGROUP = ''
                  OR bl.udf05 = R_LOCATIONGROUP)
                  GROUP BY zib.organizationId,
                           zib.warehouseId,
                           zib.customerId,
                           zib.locationId,
                           bl.locationCategory,
                           bl.udf05,
                           bl.zoneId,
                           zib.StockDate,
                           zib.sku,
                           zib.SKUDesc,
                           zib.UOM,
                           zib.lotNum,
                           zib.packkey,
                           zib.traceId,
                           zib.muid,
                           zib.freightClass;
              END;
            ELSE SELECT
                'BILLING METHOD FOR NORMAL STORAGE NOT FOUND' AS MESSAGE;
          END CASE;
        END;
        END IF;


        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY;
        CREATE TEMPORARY TABLE TMP_BIL_SUMMARY (
          organizationId varchar(20),
          warehouseId varchar(20),
          billingSummaryId varchar(30),
          customerId varchar(30),
          sku varchar(50),
          lotNum varchar(10),
          traceId varchar(30),
          tariffId varchar(10),
          chargeCategory varchar(20),
          chargeType varchar(20),
          descr varchar(60),
          rateBase varchar(20),
          chargePerUnits decimal(18, 3),
          qty decimal(18, 8),
          uom varchar(10),
          cubic decimal(24, 8),
          weight decimal(18, 8),
          chargeRate decimal(24, 8),
          locationCategory varchar(10),
          amount decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          billingAmount decimal(24, 8) NOT NULL DEFAULT 0.00000000,
          udf01 varchar(500),
          udf02 varchar(500) binary DEFAULT NULL,
          udf03 varchar(500),
          udf04 varchar(500),
          udf05 varchar(500)
        );
        IF EXISTS (SELECT
              *
            FROM TMP_BIL_SUMMARY_INFORMATION) THEN

          -- SELECT * FROM TMP_BIL_SUMMARY_INFORMATION;
          /* select stockdate,sum(PalletUsed) from (
     		SELECT stockdate,traceId,1 PalletUsed FROM TMP_BIL_SUMMARY_INFORMATION
             group by stockdate,traceId
             )plt group by stockdate;
           */
          SET IN_Language = 'en';
          SET @line_number = 0;
          SET @row_number = 0;
          SET R_billsummaryId = '';



          CASE
            WHEN R_billMode IN ('INTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(DailyTrace.`CUBE`) TotalCube,
                    SUM(DailyTrace.Weight) TotalWeight,
                    R_rate,
                    DailyTrace.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      tb.traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.traceId NOT IN ('*', '', ' ')
                    --  AND tb.muid IN ('*','',' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             traceId) DailyTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('MAXTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    MaxTrace.uom,
                    SUM(MaxTrace.`CUBE`) TotalCube,
                    SUM(MaxTrace.Weight) TotalWeight,
                    R_rate,
                    MaxTrace.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxTrace.UDF03,
                    MaxTrace.UDF04,
                    MaxTrace.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      tb.Stockdate,
                      '' SKU,
                      '' lotNum,
                      tb.traceId traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.traceId NOT IN ('*', ' ')
                    -- AND tb.muid IN ('*',' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             traceId) MaxTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId,
                           MaxTrace.StockDate
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('DAILYTRACE', 'MONTHTRACE') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthTrace.`CUBE`) TotalCube,
                    SUM(MonthTrace.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      traceid,
                      1 PalletQty,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        tb.traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        '' locationCategory,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        '' UDF05
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId
                      AND TRACEID NOT IN ('*')
                    -- AND MUID IN ('*')
                    ) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             traceid) MonthTrace
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM;
              END;
            WHEN R_billMode IN ('INPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(InMuid.`CUBE`) TotalCube,
                    SUM(InMuid.Weight) TotalWeight,
                    R_rate,
                    InMuid.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*', '', ' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             Muid) InMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('MAXPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    MaxMuid.lotNum,
                    MaxMuid.traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MaxTrace.`CUBE`) TotalCube,
                    SUM(MaxTrace.Weight) TotalWeight,
                    R_rate,
                    MaxMuid.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxMuid.UDF03,
                    MaxMuid.UDF04,
                    MaxMuid.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             muid) MaxMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('MONTHPL') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthMuid.`CUBE`) TotalCube,
                    SUM(MonthMuid.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      '' traceid,
                      1 PalletQty,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        '' traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        '' locationCategory,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        tb.muid muid
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId
                      AND MUID NOT IN ('*')) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             muid) MonthMuid
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('INLOC') THEN BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(InLoc.`CUBE`) TotalCube,
                    SUM(InLoc.Weight) TotalWeight,
                    R_rate,
                    InLoc.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate Amount,
                      1 * R_rateperunit * R_rate BillAmount,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      '' UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*', '', ' ')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             tb.locationId) InLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;

            WHEN R_billMode IN ('MAXLOC') THEN  -- Highest location count
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    SKU,
                    MaxLoc.lotNum,
                    MaxLoc.traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MaxLoc.`CUBE`) TotalCube,
                    SUM(MaxLoc.Weight) TotalWeight,
                    R_rate,
                    MaxLoc.locationCategory,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(PalletQty) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(PalletQty) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    MaxLoc.UDF03,
                    MaxLoc.UDF04,
                    MaxLoc.UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      '' SKU,
                      '' lotNum,
                      '' traceId,
                      R_TARIFFID,
                      R_CHARGECATEGORY,
                      R_CHARGETYPE,
                      R_descrC,
                      R_ratebase,
                      R_rateperunit,
                      1 PalletQty,
                      'PL' uom,
                      SUM(`CUBE`) `CUBE`,
                      SUM(netWeight) Weight,
                      R_rate chargeRate,
                      '' locationCategory,
                      1 * R_rateperunit * R_rate,
                      1 * R_rateperunit * R_rate,
                      '' UDF01,
                      '' UDF02,
                      '' UDF03,
                      '' UDF04,
                      tb.locationId UDF05
                    FROM TMP_BIL_SUMMARY_INFORMATION tb
                    WHERE organizationId = R_ORGANIZATIONID
                    AND warehouseId = R_WAREHOUSEID
                    AND customerId = R_customerId
                    AND tb.muid NOT IN ('*')
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             tariffId,
                             tariffLineNo,
                             StockDate,
                             tb.locationId) MaxLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM
                  ORDER BY SUM(PalletQty) DESC LIMIT 1;
              END;
            WHEN R_billMode IN ('MONTHLOC') THEN -- Daily accumulated total location
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) Qty,
                    'PL' uom,
                    SUM(MonthLoc.`CUBE`) TotalCube,
                    SUM(MonthLoc.Weight) TotalWeight,
                    R_rate,
                    '' locationCategory,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((COUNT(*) - R_CLASSFROM) <= R_minQty, R_minQty, COUNT(*) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM (SELECT
                      organizationId,
                      warehouseId,
                      R_billsummaryId,
                      customerId,
                      stockdate,
                      1 PalletQty,
                      '' traceid,
                      SUM(`CUBE`) `CUBE`,
                      SUM(Weight) Weight
                    FROM (SELECT
                        organizationId,
                        warehouseId,
                        R_billsummaryId,
                        customerId,
                        stockdate,
                        '' SKU,
                        '' lotNum,
                        '' traceId,
                        R_TARIFFID,
                        R_CHARGECATEGORY,
                        R_CHARGETYPE,
                        R_descrC,
                        R_ratebase,
                        R_rateperunit,
                        1 PalletQty,
                        'PL' uom,
                        `CUBE`,
                        netWeight Weight,
                        R_rate chargeRate,
                        tb.locationId,
                        1 * R_rateperunit * R_rate Amount,
                        1 * R_rateperunit * R_rate BillAmount,
                        '' UDF01,
                        '' UDF02,
                        '' UDF03,
                        '' UDF04,
                        '' UDF05
                      FROM TMP_BIL_SUMMARY_INFORMATION tb
                      WHERE organizationId = R_ORGANIZATIONID
                      AND warehouseId = R_WAREHOUSEID
                      AND customerId = R_customerId) inventoryPlt
                    GROUP BY organizationId,
                             warehouseId,
                             customerId,
                             stockdate,
                             locationId) MonthLoc
                  GROUP BY organizationId,
                           warehouseId,
                           customerId
                  HAVING SUM(PalletQty) > R_CLASSFROM LIMIT 1;
              END;
            WHEN R_billMode IN ('DAILYCBM') THEN -- Daily accumulated total cbm
              BEGIN
                INSERT INTO TMP_BIL_SUMMARY
                  SELECT
                    organizationId,
                    warehouseId,
                    R_billsummaryId,
                    customerId,
                    '' SKU,
                    '' lotNum,
                    '' traceId,
                    R_TARIFFID,
                    R_CHARGECATEGORY,
                    R_CHARGETYPE,
                    R_descrC,
                    R_ratebase,
                    R_rateperunit,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) Qty,
                    'm3' uom,
                    SUM(tb.totalCube) `CUBE`,
                    SUM(netWeight) Weight,
                    R_rate AS chargerate,
                    '' locationCategory,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) * R_rateperunit * R_rate Amount,
                    IF((SUM(tb.totalCube) - R_CLASSFROM) <= R_minQty, R_minQty, SUM(tb.totalCube) - R_CLASSFROM) * R_rateperunit * R_rate BillAmount,
                    R_materialNo AS UDF01,
                    R_itemChargeCategory AS UDF02,
                    '' UDF03,
                    '' UDF04,
                    '' UDF05
                  FROM TMP_BIL_SUMMARY_INFORMATION tb
                  WHERE organizationId = R_ORGANIZATIONID
                  AND warehouseId = R_WAREHOUSEID
                  AND customerId = R_customerId
                  GROUP BY organizationId,
                           warehouseId,
                           customerId,
                           tariffId,
                           tariffLineNo
                  HAVING SUM(tb.totalCube) >= R_CLASSFROM LIMIT 1;
              END;
            ELSE BEGIN
              SELECT
                CONCAT('Bill Mode : ', R_billMode, ' not found.') AS Message;
            END;
          END CASE;

          IF EXISTS (SELECT
                *
              FROM TMP_BIL_SUMMARY) THEN


            IF (R_billsummaryId = '') THEN
              -- CALL SPCOM_GetIDSequence(R_ORGANIZATIONID,R_WAREHOUSEID,IN_Language,'BILLINGSUMMARYID',R_billsummaryId,OUT_returnCode);  
              SET R_billsummaryId = 'TEST';
            END IF;


            SELECT
              bil.organizationId,
              bil.warehouseId,
              CONCAT(R_billsummaryId, '*', LPAD((@row_number := @row_number + 1), 3, '0')),
              DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingFromDate,
              DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingToDate,
              bil.customerId,
              bil.SKU,
              bil.LotNum LotNum,
              bil.traceId traceId,
              bil.tariffId,
              R_CHARGECATEGORY chargeCategory,
              R_chargetype ChargeType,
              R_descrC descr,
              R_rateBase ratebase,
              R_rateperunit AS chargePerUnit,
              SUM(qty) qty,
              bil.uom uom,
              SUM(bil.cubic) cubic,
              SUM(bil.weight) weight,
              R_rate chargeRate,
              R_rateperunit * R_rate * SUM(qty) Amount,
              R_rateperunit * R_rate * SUM(qty) + (R_rateperunit * R_rate * SUM(qty) * R_INCOMETAX) BillingAmount,
              0 cost,
              R_cost * SUM(qty) amountPayable,
              0 amountPaid,
              NOW() confirmTime,
              '' confirmWho,
              '' docType,
              '' docNo,
              '' createTransactionid,
              '' notes,
              NOW() ediSendTime,
              R_BILLTO billTo,
              NOW() settleTime,
              '' settleWho,
              '' followUp,
              '' invoiceType,
              '' paidTo,
              '' costConfirmFlag,
              NOW() costConfirmTime,
              '' costConfirmWho,
              '' costSettleFlag,
              NOW() costSettleTime,
              '' costSettleWho,
              0 incomeTaxRate,
              0 costTaxRate,
              R_INCOMETAX incomeTax,
              0 cosTax,
              R_rateperunit * R_rate * SUM(qty) incomeWithoutTax,
              0 cosWithoutTax,
              '' costInvoiceType,
              '' noteText,
              R_materialNo AS udf01,
              R_itemChargeCategory AS udf02,
              bil.UDF03 udf03,
              R_UDF06 udf04,
              bil.UDF05 udf05,
              0 currentVersion,
              '2020' oprSeqFlag,
              IN_USERID addWho,
              NOW() addTime,
              IN_USERID editWho,
              NOW() editTime,
              R_LOCATIONCAT locationCategory,
              '' manual,
              0 lineCount,
              '*' arNo,
              0 arLineNo,
              '*' apNo,
              0 apLineNo,
              'N' ediSendFlag,
              '' ediErrorCode,
              '' ediErrorMessage,
              NOW() ediSendTime2,
              'N' ediSendFlag2,
              '' ediErrorCode2,
              '' ediErrorMessage2,
              '' billingTranCategory,
              '' orderType,
              '' containerType,
              '' containerSize
            FROM TMP_BIL_SUMMARY bil
            GROUP BY bil.organizationId,
                     bil.warehouseid,
                     bil.customerId,
                     bil.locationCategory,
                     bil.SKU,
                     bil.LotNum,
                     bil.uom,
                     bil.traceId,
                     bil.tariffId,
                     bil.UDF01,
                     bil.UDF02,
                     bil.UDF03,
                     bil.UDF04,
                     bil.UDF05;

            SET @countRow = ROW_COUNT();



          ELSE
            SELECT
              CONCAT('NO BILING SUMMARY GENERATED FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS MESSAGE,
              R_ORGANIZATIONID,
              R_WAREHOUSEID,
              R_CUSTOMERID,
              R_chargecategory,
              R_CHARGETYPE,
              R_ratebase,
              R_billMode,
              R_minQty,
              R_CLASSFROM,
              R_CLASSTO;
          END IF;
        ELSE
          SELECT
            CONCAT('BIL SUMMARY DETAIL/INFORMATION NOT FOUND FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS Msg;
          IF (R_MinQty > 0) THEN
          BEGIN
            SELECT
              CONCAT('MIN CHARGE APPLIED FOR ', R_CUSTOMERID, ' ON CHARGE:', R_CHARGECATEGORY, ',', R_CHARGETYPE) AS Msg;

            IF (R_billsummaryId = '') THEN
              -- CALL SPCOM_GetIDSequence(R_ORGANIZATIONID,R_WAREHOUSEID,IN_Language,'BILLINGSUMMARYID',R_billsummaryId,OUT_returnCode);  
              SET R_billsummaryId = 'TEST';
            END IF;


            SELECT
              R_ORGANIZATIONID,
              R_WAREHOUSEID,
              R_billsummaryId,
              DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingFromDate,
              DATE_FORMAT(R_TODATE, '%Y-%m-%d') billingToDate,
              R_CUSTOMERID,
              '' SKU,
              '' lotNum,
              '' traceId,
              R_TARIFFID,
              R_CHARGECATEGORY,
              R_CHARGETYPE,
              R_descrC,
              R_ratebase,
              R_rateperunit,
              R_MinQty BillQty,
              'PL' uom,
              0 `CUBE`,
              0 Weight,
              R_rate chargeRate,
              R_MinQty * R_rateperunit * R_rate Amount,
              R_rateperunit * R_rate * R_MinQty + (R_rateperunit * R_rate * R_MinQty * R_INCOMETAX) BillAmount,
              0 AS COST,
              (R_MinQty * R_Cost) amountPayable,
              0 amountPaid,
              NOW() confirmTime,
              '' confirmWho,
              '' docType,
              '' docNo,
              '' createTransactionid,
              '' notes,
              NOW() ediSendTime,
              R_BILLTO billTo,
              NOW() settleTime,
              '' settleWho,
              '' followUp,
              '' invoiceType,
              '' paidTo,
              '' costConfirmFlag,
              NOW() costConfirmTime,
              '' costConfirmWho,
              '' costSettleFlag,
              NOW() costSettleTime,
              '' costSettleWho,
              0 incomeTaxRate,
              0 costTaxRate,
              R_INCOMETAX incomeTax,
              0 cosTax,
              R_rateperunit * R_rate * R_MinQty incomeWithoutTax,
              0 cosWithoutTax,
              '' costInvoiceType,
              '' noteText,
              R_materialNo AS udf01,
              R_itemChargeCategory AS udf02,
              '' udf03,
              R_UDF06 udf04,
              '' udf05,
              0 currentVersion,
              '2020' oprSeqFlag,
              IN_USERID addWho,
              NOW() addTime,
              IN_USERID editWho,
              NOW() editTime,
              R_LOCATIONCAT locationCategory,
              '' manual,
              0 lineCount,
              '*' arNo,
              0 arLineNo,
              '*' apNo,
              0 apLineNo,
              'N' ediSendFlag,
              '' ediErrorCode,
              '' ediErrorMessage,
              NOW() ediSendTime2,
              'N' ediSendFlag2,
              '' ediErrorCode2,
              '' ediErrorMessage2,
              '' billingTranCategory,
              '' orderType,
              '' containerType,
              '' containerSize;
          END;
          END IF;
        END IF;


        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY;
        DROP TEMPORARY TABLE IF EXISTS TMP_BIL_SUMMARY_INFORMATION;

      END;
      END IF;

    END LOOP getTariff;
    CLOSE cur_Tariff;

    SET OUT_returnCode = '000';
  END;
END
$$

--
-- Create procedure `BulkMultiwarehouseSKU`
--
CREATE
DEFINER = 'sa'@'localhost'
PROCEDURE BulkMultiwarehouseSKU ()
BEGIN
  DECLARE finished integer DEFAULT 0;
  DECLARE SKUNAME varchar(100);

  -- declare cursor for employee email
  DECLARE curEmail CURSOR FOR
  SELECT DISTINCT
    (sku) AS sku
  FROM BAS_SKU
  WHERE customerId = 'API'
  AND SKU NOT IN ('', 'NOSKU');

  -- declare NOT FOUND handler
  DECLARE CONTINUE HANDLER
  FOR NOT FOUND SET finished = 1;

  OPEN curEmail;

getEmail:
  LOOP
    FETCH curEmail INTO SKUNAME;

    INSERT INTO BAS_SKU_MULTIWAREHOUSE (organizationId, customerId, sku, warehouseId, tariffId, invChgWithShipment, laborRateBase, laborRate, putawayRule, qtyMin, qtyMax, replenishRule, cycleGroup, csCycleClass, eaCycleClass, lastCycleCount, noteText, udf01, udf02, udf03, udf04, udf05, currentVersion, oprSeqFlag, addWho, addTime, editWho, editTime, packId, defaultSupplierId, billingRate, putawayLocation, reportUom, reserveCode, templateName, tariffMasterId)
      VALUES ('OJV_CML', 'API', SKUNAME, 'CBT02', '', 'N', NULL, NULL, 'API', 0.000, 99999999.000, '', NULL, '', '', NULL, x'', '', '', '', '', '', 102, '20211104160602000588RA172031009091[A1035]', 'WM_MARDIANSAH', '2021-11-04 13:44:09', 'WM_MARDIANSAH', '2021-11-04 16:06:02', '', '', 0.00000000, '', 'EA', 'IN', NULL, 'BIL00055');
  END LOOP getEmail;
  CLOSE curEmail;

END
$$

DELIMITER ;